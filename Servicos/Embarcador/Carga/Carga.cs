using AdminMultisoftware.Dominio.Enumeradores;
using Confluent.Kafka;
using Dominio.Entidades.Embarcador.Configuracao;
using Dominio.Enumeradores;
using Dominio.Excecoes.Embarcador;
using Dominio.ObjetosDeValor.Embarcador.Auditoria;
using Dominio.ObjetosDeValor.Embarcador.Carga.OcultarInformacoesCarga;
using Dominio.ObjetosDeValor.Embarcador.Enumeradores;
using Dominio.ObjetosDeValor.Embarcador.Pedido;
using Dominio.ObjetosDeValor.Enumerador;
using Dominio.ObjetosDeValor.Relatorios;
using ICSharpCode.SharpZipLib.Zip;
using Infrastructure.Services.Cache;
using MongoDB.Driver.Linq;
using Newtonsoft.Json;
using Repositorio;
using Servicos.Extensions;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading;
using System.Threading.Tasks;

namespace Servicos.Embarcador.Carga
{
    public class Carga : ServicoBase
    {
        #region Construtores

        public Carga(Repositorio.UnitOfWork unitOfWork, CancellationToken cancelationToken = default) : base(unitOfWork, cancelationToken) { }

        public Carga(Repositorio.UnitOfWork unitOfWork, TipoServicoMultisoftware tipoServicoMultisoftware, CancellationToken cancelationToken) : base(unitOfWork, tipoServicoMultisoftware, cancelationToken) { }

        #endregion

        #region Métodos Públicos

        public void ValidarEnvioNotas(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao repPedidoCTeParaSubContratacao = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao(unitOfWork);

            bool enviouTodas = true;

            List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedidoNotaFiscal> cargaPedidoNotaFiscals = repPedidoXMLNotaFiscal.BuscarPedidoXMLNotaFiscal(carga.Codigo);
            List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedidoCteSubContratacao> pedidoCteSubContratacaos = repPedidoCTeParaSubContratacao.BuscarPedidoCTeParaSubContratacao(carga.Codigo);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPedido.Entrega);
            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cp in cargaPedidos)
            {
                if (cp.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Normal)
                {
                    if ((from obj in pedidoCteSubContratacaos where obj.CargaPedido == cp.Codigo select obj).Count() <= 0)
                        enviouTodas = false;
                }
                else
                {
                    if ((from obj in cargaPedidoNotaFiscals where obj.CargaPedido == cp.Codigo select obj).Count() <= 0)
                        enviouTodas = false;
                }

                if (enviouTodas)
                {
                    cp.SituacaoEmissao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoNF.NFEnviada;
                    repCargaPedido.Atualizar(cp);
                }
            }
            if (enviouTodas)
            {
                carga.DataEnvioUltimaNFe = DateTime.Now;
                carga.DataRecebimentoUltimaNFe = DateTime.Now;
                //carga.DataInicioEmissaoDocumentos = DateTime.Now;
            }
        }

        public Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento AdicionarCargaJanelaCarregamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {
            return AdicionarCargaJanelaCarregamento(carga, configuracaoEmbarcador, tipoServicoMultisoftware, unitOfWork, auditado: null, propriedades: null);
        }

        public Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento AdicionarCargaJanelaCarregamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Carga.PropriedadesGeracaoCarga propriedades)
        {
            return AdicionarCargaJanelaCarregamento(carga, configuracaoEmbarcador, tipoServicoMultisoftware, unitOfWork, auditado: null, propriedades: propriedades);
        }

        public Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento AdicionarCargaJanelaCarregamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, Dominio.ObjetosDeValor.Embarcador.Carga.PropriedadesGeracaoCarga propriedades)
        {
            bool janelaCarregamentoPorCargaAgrupada = carga.CargaAgrupada && configuracaoEmbarcador.GerarFluxoPatioPorCargaAgrupada;
            Dominio.ObjetosDeValor.Embarcador.JanelaCarregamento.ConfiguracaoCarregamento configuracaoCarregamento = new Dominio.ObjetosDeValor.Embarcador.JanelaCarregamento.ConfiguracaoCarregamento()
            {
                PermitirCapacidadeCarregamentoExcedida = janelaCarregamentoPorCargaAgrupada,
                PermitirHorarioCarregamentoComLimiteAtingido = propriedades?.PermitirHorarioCarregamentoComLimiteAtingido ?? false,
                PermitirHorarioCarregamentoInferiorAoAtual = propriedades?.PermitirHorarioCarregamentoInferiorAoAtual ?? false,
                DiasLimiteParaDefinicaoHorarioCarregamento = propriedades?.DiasLimiteParaDefinicaoHorarioCarregamento ?? 0
            };

            Servicos.Embarcador.Logistica.CargaJanelaCarregamento servicoCargaJanelaCarregamento = new Servicos.Embarcador.Logistica.CargaJanelaCarregamento(unitOfWork, configuracaoEmbarcador, configuracaoCarregamento);

            if (!servicoCargaJanelaCarregamento.IsPermitirAdicionar(carga, tipoServicoMultisoftware))
                return null;

            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            bool utilizarDadosTransporteCargaCancelada = configuracaoEmbarcador.UtilizarDadosTransporteCargaCancelada && (carga.TipoOperacao != null) && (carga.Filial != null) && !string.IsNullOrWhiteSpace(carga.CodigoCargaEmbarcador);

            if (utilizarDadosTransporteCargaCancelada)
            {
                Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga = repositorioCarga.BuscarPorCargaCanceladaComFretePorOperador(carga.CodigoCargaEmbarcador, carga.Filial.Codigo, carga.TipoOperacao.Codigo);

                if ((cargaAntiga != null) && (cargaAntiga.Operador != null))
                {
                    TransferirDadosCargaAntiga(carga, cargaAntiga, tipoServicoMultisoftware, unitOfWork);
                    return null;
                }
            }

            Repositorio.Embarcador.Cargas.CargaJanelaCarregamento repositorioCargaJanelaCarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamento(unitOfWork);
            Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento = repositorioCargaJanelaCarregamento.BuscarPorCarga(carga.Codigo);
            bool adicionarCargaJanelaCarregamento = cargaJanelaCarregamento == null;

            if (adicionarCargaJanelaCarregamento)
                cargaJanelaCarregamento = servicoCargaJanelaCarregamento.AdicionarPorCarga(carga.Codigo, tipoServicoMultisoftware);
            else
                servicoCargaJanelaCarregamento.AtualizarPorCarga(cargaJanelaCarregamento, tipoServicoMultisoftware);

            if (cargaJanelaCarregamento == null)
                return null;

            if (janelaCarregamentoPorCargaAgrupada)
            {
                List<Dominio.Entidades.Embarcador.Cargas.Carga> cargasAgrupadas = repositorioCarga.BuscarCargasOriginais(carga.Codigo);
                List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento> listaCargaJanelaCarregamentoAtualizar = new List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento>();

                listaCargaJanelaCarregamentoAtualizar.Add(cargaJanelaCarregamento);

                foreach (Dominio.Entidades.Embarcador.Cargas.Carga cargaFilha in cargasAgrupadas)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamentoFilha = repositorioCargaJanelaCarregamento.BuscarPorCarga(cargaFilha.Codigo);

                    if (cargaFilha.Filial.Codigo != carga.Filial.Codigo)
                    {
                        if (cargaJanelaCarregamentoFilha == null)
                        {
                            if (servicoCargaJanelaCarregamento.IsPermitirAdicionar(cargaFilha, tipoServicoMultisoftware))
                                cargaJanelaCarregamentoFilha = servicoCargaJanelaCarregamento.AdicionarPorCarga(cargaFilha.Codigo, tipoServicoMultisoftware);
                        }
                        else
                            servicoCargaJanelaCarregamento.AtualizarPorCarga(cargaJanelaCarregamentoFilha, tipoServicoMultisoftware);

                        if (cargaJanelaCarregamentoFilha == null)
                            continue;

                        cargaJanelaCarregamentoFilha.CargaJanelaCarregamentoAgrupador = cargaJanelaCarregamento;
                        cargaJanelaCarregamentoFilha.ObservacaoTransportador = cargaJanelaCarregamento.ObservacaoTransportador;
                        cargaJanelaCarregamentoFilha.ObservacaoTransportadorInformadaManualmente = cargaJanelaCarregamento.ObservacaoTransportadorInformadaManualmente;

                        cargaJanelaCarregamento.Peso -= cargaJanelaCarregamentoFilha.Peso;
                        cargaJanelaCarregamento.Volume -= cargaJanelaCarregamentoFilha.Volume;

                        listaCargaJanelaCarregamentoAtualizar.Add(cargaJanelaCarregamentoFilha);
                    }
                    else
                    {
                        if (cargaJanelaCarregamentoFilha == null)
                            continue;

                        cargaJanelaCarregamentoFilha.Carga = null;
                        cargaJanelaCarregamentoFilha.CentroCarregamento = null;

                        repositorioCargaJanelaCarregamento.Atualizar(cargaJanelaCarregamentoFilha);
                    }
                }

                Dominio.ObjetosDeValor.Embarcador.JanelaCarregamento.ConfiguracaoDisponibilidadeCarregamento configuracaoDisponibilidadeCarregamento = new Dominio.ObjetosDeValor.Embarcador.JanelaCarregamento.ConfiguracaoDisponibilidadeCarregamento()
                {
                    BloquearJanelaCarregamentoExcedente = configuracaoEmbarcador.BloquearGeracaoCargaComJanelaCarregamentoExcedente
                };
                Servicos.Embarcador.Logistica.CargaJanelaCarregamentoDisponibilidade servicoDisponibilidadeCarregamento = new Servicos.Embarcador.Logistica.CargaJanelaCarregamentoDisponibilidade(unitOfWork, configuracaoDisponibilidadeCarregamento);

                foreach (Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamentoAtualizar in listaCargaJanelaCarregamentoAtualizar)
                {
                    servicoDisponibilidadeCarregamento.AtualizarDefinicaoHorarioCarregamento(cargaJanelaCarregamentoAtualizar);
                    repositorioCargaJanelaCarregamento.Atualizar(cargaJanelaCarregamentoAtualizar);
                }
            }

            if (adicionarCargaJanelaCarregamento && !cargaJanelaCarregamento.Excedente)
                Auditoria.Auditoria.Auditar(auditado, cargaJanelaCarregamento, $"Adicionada na janela de carregamento ({cargaJanelaCarregamento.CentroCarregamento?.Descricao ?? ""}) do dia {cargaJanelaCarregamento.InicioCarregamento.ToDateString()} as {cargaJanelaCarregamento.InicioCarregamento.ToTimeString()}", unitOfWork);

            return cargaJanelaCarregamento;
        }

        public void AdicionarCargaJanelaDescarregamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, UnitOfWork unitOfWork, TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            AdicionarCargaJanelaDescarregamento(carga, cargaJanelaCarregamento, configuracaoEmbarcador, unitOfWork, tipoServicoMultisoftware, configuracoesDescarregamento: null);
        }

        public void AdicionarCargaJanelaDescarregamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, UnitOfWork unitOfWork, TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.ObjetosDeValor.Embarcador.JanelaCarregamento.ConfiguracaoDescarregamento configuracoesDescarregamento)
        {
            Logistica.CargaJanelaDescarregamento servicoJanelaDescarregamento = new Logistica.CargaJanelaDescarregamento(unitOfWork, configuracaoEmbarcador, configuracoesDescarregamento);

            servicoJanelaDescarregamento.Adicionar(carga, cargaJanelaCarregamento, tipoServicoMultisoftware);
        }

        public void AdicionarFluxoGestaoPatio(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento, Repositorio.UnitOfWork unitOfWork, TipoServicoMultisoftware tipoServicoMultisoftware, bool validarDadosTransporteInformados)
        {
            if (validarDadosTransporteInformados && !IsDadosTransporteinformados(carga, unitOfWork))
                return;

            GestaoPatio.FluxoGestaoPatio servicoFluxoGestaoPatio = new GestaoPatio.FluxoGestaoPatio(unitOfWork);

            servicoFluxoGestaoPatio.Adicionar(carga, tipoServicoMultisoftware, cargaJanelaCarregamento);
        }

        public void AtualizarCargaJanelaCarregamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, Repositorio.UnitOfWork unitOfWork)
        {
            if (cargaJanelaCarregamento == null)
                return;

            Repositorio.Embarcador.Cargas.CargaJanelaCarregamento repositorioCargaJanelaCarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamento(unitOfWork);

            cargaJanelaCarregamento.Peso = carga.DadosSumarizados?.PesoTotal ?? 0m;
            cargaJanelaCarregamento.Volume = carga.DadosSumarizados?.VolumesTotal ?? 0m;

            if (carga.TipoOperacao?.BloquearLiberacaoCargasComPedidosDatasAgendadasDivergentes ?? false)
            {
                Logistica.AgendamentoEntregaPedido servicoAgendamentoEntregaPedido = new Logistica.AgendamentoEntregaPedido(unitOfWork, configuracaoEmbarcador, TipoServicoMultisoftware.MultiEmbarcador, null, null);
                servicoAgendamentoEntregaPedido.AjustarStatusCargaJanelaCarregamento(cargaJanelaCarregamento);
            }

            if (carga.CargaAgrupada && configuracaoEmbarcador.GerarFluxoPatioPorCargaAgrupada)
            {
                Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
                List<Dominio.Entidades.Embarcador.Cargas.Carga> cargasAgrupadas = repositorioCarga.BuscarCargasOriginais(carga.Codigo);

                foreach (Dominio.Entidades.Embarcador.Cargas.Carga cargaFilha in cargasAgrupadas)
                {
                    if (cargaFilha.Filial.Codigo == carga.Filial.Codigo)
                        continue;

                    Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamentoFilha = repositorioCargaJanelaCarregamento.BuscarPorCarga(cargaFilha.Codigo);

                    if (cargaJanelaCarregamentoFilha == null)
                        continue;

                    cargaJanelaCarregamentoFilha.Peso = cargaFilha.DadosSumarizados?.PesoTotal ?? 0m;
                    cargaJanelaCarregamento.Peso -= cargaJanelaCarregamentoFilha.Peso;

                    cargaJanelaCarregamentoFilha.Volume = cargaFilha.DadosSumarizados?.VolumesTotal ?? 0m;
                    cargaJanelaCarregamento.Volume -= cargaJanelaCarregamentoFilha.Volume;

                    repositorioCargaJanelaCarregamento.Atualizar(cargaJanelaCarregamentoFilha);
                }
            }

            Dominio.ObjetosDeValor.Embarcador.JanelaCarregamento.ConfiguracaoDisponibilidadeCarregamento configuracaoDisponibilidadeCarregamento = new Dominio.ObjetosDeValor.Embarcador.JanelaCarregamento.ConfiguracaoDisponibilidadeCarregamento()
            {
                BloquearJanelaCarregamentoExcedente = configuracaoEmbarcador.BloquearGeracaoCargaComJanelaCarregamentoExcedente
            };
            Servicos.Embarcador.Logistica.CargaJanelaCarregamentoDisponibilidade servicoDisponibilidadeCarregamento = new Servicos.Embarcador.Logistica.CargaJanelaCarregamentoDisponibilidade(unitOfWork, configuracaoDisponibilidadeCarregamento);

            servicoDisponibilidadeCarregamento.AtualizarDefinicaoHorarioCarregamento(cargaJanelaCarregamento);
            repositorioCargaJanelaCarregamento.Atualizar(cargaJanelaCarregamento);
        }

        public void AtualizarCargaJanelaDescarregamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, Repositorio.UnitOfWork unitOfWork, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosAdicionados, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosRemovidos)
        {
            Repositorio.Embarcador.Cargas.CargaJanelaDescarregamento repositorioCargaJanelaDescarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaDescarregamento(unitOfWork);
            List<Dominio.Entidades.Cliente> destinatariosAdicionados;
            List<Dominio.Entidades.Cliente> destinatariosRemovidos;
            bool atualizarDefinicaoHorarioDescarregamento = false;

            if (cargaPedidosAdicionados?.Count > 0)
                destinatariosAdicionados = (
                    from o in cargaPedidosAdicionados where o.Recebedor == null && o.Pedido.Destinatario != null && o.Pedido.TipoPedido != TipoPedido.Coleta && o.TipoCarregamentoPedido != TipoCarregamentoPedido.TrocaNota select o.Pedido.Destinatario).ToList().Concat((
                    from o in cargaPedidosAdicionados where o.Recebedor != null && o.Pedido.TipoPedido != TipoPedido.Coleta && o.TipoCarregamentoPedido != TipoCarregamentoPedido.TrocaNota select o.Recebedor).ToList()
                ).Distinct().ToList();
            else
                destinatariosAdicionados = new List<Dominio.Entidades.Cliente>();

            if (cargaPedidosRemovidos?.Count > 0)
                destinatariosRemovidos = (
                    from o in cargaPedidosRemovidos where o.Recebedor == null && o.Pedido.Destinatario != null && o.Pedido.TipoPedido != TipoPedido.Coleta && o.TipoCarregamentoPedido != TipoCarregamentoPedido.TrocaNota select o.Pedido.Destinatario).ToList().Concat((
                    from o in cargaPedidosRemovidos where o.Recebedor != null && o.Pedido.TipoPedido != TipoPedido.Coleta && o.TipoCarregamentoPedido != TipoCarregamentoPedido.TrocaNota select o.Recebedor).ToList()
                ).Distinct().ToList();
            else
                destinatariosRemovidos = new List<Dominio.Entidades.Cliente>();

            if ((destinatariosAdicionados.Count == 0) && (destinatariosRemovidos.Count == 0))
            {
                List<Dominio.Entidades.Cliente> destinatariosAdicionadosComoTrocaNota = (
                    from o in cargaPedidosAdicionados where o.Recebedor == null && o.Pedido.Destinatario != null && o.Pedido.TipoPedido != TipoPedido.Coleta && o.TipoCarregamentoPedido == TipoCarregamentoPedido.TrocaNota select o.Pedido.Destinatario).ToList().Concat((
                    from o in cargaPedidosAdicionados where o.Recebedor != null && o.Pedido.TipoPedido != TipoPedido.Coleta && o.TipoCarregamentoPedido == TipoCarregamentoPedido.TrocaNota select o.Recebedor).ToList()
                ).Distinct().ToList();

                bool removerCargaJanelaDescarregamento = (destinatariosAdicionadosComoTrocaNota.Count == 1) && !(cargaPedidosRemovidos?.Count > 0);

                if (removerCargaJanelaDescarregamento)
                {
                    Dominio.Entidades.Cliente destinatario = destinatariosAdicionadosComoTrocaNota.FirstOrDefault();
                    Dominio.Entidades.Embarcador.Cargas.CargaJanelaDescarregamento cargaJanelaDescarregamento = repositorioCargaJanelaDescarregamento.BuscarAtivaPorCargaEDestinatario(carga.Codigo, destinatario.CPF_CNPJ);

                    if (cargaJanelaDescarregamento != null)
                        repositorioCargaJanelaDescarregamento.DeletarPorCodigo(cargaJanelaDescarregamento.Codigo);
                }

                return;
            }
            else if ((destinatariosAdicionados.Count == 1) && (destinatariosRemovidos.Count == 1))
                atualizarDefinicaoHorarioDescarregamento = destinatariosAdicionados.FirstOrDefault().CPF_CNPJ == destinatariosRemovidos.FirstOrDefault().CPF_CNPJ;
            else
                atualizarDefinicaoHorarioDescarregamento = destinatariosAdicionados.Count == 1;

            if (atualizarDefinicaoHorarioDescarregamento)
            {
                Dominio.Entidades.Cliente destinatario = destinatariosAdicionados.FirstOrDefault();
                Dominio.Entidades.Embarcador.Cargas.CargaJanelaDescarregamento cargaJanelaDescarregamento = repositorioCargaJanelaDescarregamento.BuscarAtivaPorCargaEDestinatario(carga.Codigo, destinatario.CPF_CNPJ);

                if (cargaJanelaDescarregamento != null)
                {
                    Logistica.CargaJanelaDescarregamentoDisponibilidade servicoJanelaDescarregamentoDisponibilidade = new Logistica.CargaJanelaDescarregamentoDisponibilidade(unitOfWork, configuracaoEmbarcador);
                    servicoJanelaDescarregamentoDisponibilidade.AtualizarDefinicaoHorarioDescarregamento(cargaJanelaDescarregamento);
                    return;
                }
            }

            Logistica.CargaJanelaDescarregamento servicoJanelaDescarregamento = new Logistica.CargaJanelaDescarregamento(unitOfWork, configuracaoEmbarcador);

            servicoJanelaDescarregamento.Atualizar(carga, cargaJanelaCarregamento);
        }

        public dynamic ObterDetalhesCargaParaCarregamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            decimal numeroPallets = repCargaPedido.BuscarQuantidadePalletsPorCarga(carga.Codigo);

            var dynCarga = new
            {
                carga.Codigo,
                DataCarregamentoCarga = carga.DataCriacaoCarga.ToString("dd/MM/yyyy"),
                Filial = "",// carga.Filial?.Descricao ?? "",
                CodigoCargaEmbarcador = carga.CodigoCargaEmbarcador,
                Origem = carga.DadosSumarizados?.Origens ?? "",
                Remetente = carga.DadosSumarizados?.Remetentes ?? "",
                Destino = carga.DadosSumarizados?.Destinos ?? "",
                Destinatario = carga.DadosSumarizados?.Destinatarios ?? "",
                Peso = carga.DadosSumarizados?.PesoTotal.ToString("n2") ?? "0,00",
                Empresa = carga.Empresa?.Descricao ?? "",
                TipoOperacao = carga.TipoOperacao?.Descricao ?? "",
                TotalPallets = numeroPallets.ToString("n3") ?? "0,000",
                EmCarregamento = carga.Carregamento != null ? true : false,
                Cubagem = "0,00",
                RaizCNPJEmpresa = carga.Empresa != null ? Utilidades.String.OnlyNumbers(carga.Empresa.CNPJ).Remove(8, 6) : "",
                EntidadeEmpresa = new { Descricao = carga.Empresa?.Descricao ?? "", Codigo = carga.Empresa?.Codigo ?? 0 },
                EntidadeModeloVeicular = new
                {
                    Descricao = carga.ModeloVeicularCarga?.Descricao ?? "",
                    Codigo = carga.ModeloVeicularCarga?.Codigo ?? 0
                },
                Veiculo = new { Descricao = carga.PlacasVeiculos ?? "", Codigo = carga.Veiculo?.Codigo ?? 0 },
                Motoristas = carga.Motoristas != null ? (
                    from obj in carga.Motoristas
                    orderby obj.Nome
                    select new
                    {
                        obj.Codigo,
                        CPF = obj.CPF_Formatado,
                        obj.Nome
                    }
                ).ToList() : null,
            };

            return dynCarga;
        }

        public void CriarVinculosEntreCargas(List<Dominio.Entidades.Embarcador.Cargas.Carga> cargas, UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaVinculada repCargaVinculada = new Repositorio.Embarcador.Cargas.CargaVinculada(unitOfWork);

            for (int i = 0, si = cargas.Count; i < si; i++)
            {
                Dominio.Entidades.Embarcador.Cargas.Carga carga = cargas[i];

                for (int j = 0; j < si; j++)
                {
                    if (j != i)
                    {
                        Dominio.Entidades.Embarcador.Cargas.Carga vinculo = cargas[j];
                        Dominio.Entidades.Embarcador.Cargas.CargaVinculada cargaVinculo = repCargaVinculada.BuscarPorCargaEVinculo(carga.Codigo, vinculo.Codigo);

                        if (cargaVinculo == null)
                        {
                            cargaVinculo = new Dominio.Entidades.Embarcador.Cargas.CargaVinculada()
                            {
                                Carga = carga,
                                Vinculo = vinculo
                            };
                            repCargaVinculada.Inserir(cargaVinculo);
                        }
                    }
                }
            }
        }

        public void AtualizarCargaPorPedido(Dominio.Entidades.Embarcador.Pedidos.Pedido pedido, TipoServicoMultisoftware tipoServicoMultisoftware, UnitOfWork unitOfWork, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao, AdminMultisoftware.Dominio.Entidades.Pessoas.Cliente ClienteMultisoftware, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, bool cadastroPedido)
        {
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao();

            if (!configuracaoEmbarcador.UtilizarIntegracaoPedido && !pedido.ColetaEmProdutorRural && !pedido.Cotacao)
            {
                Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargasPedido = repositorioCargaPedido.BuscarPorPedido(pedido.Codigo);
                Dominio.Entidades.Embarcador.Cargas.Carga carga = cargasPedido.FirstOrDefault()?.Carga;

                if (carga != null)
                    AtualizarCargaPorPedido(pedido, carga, recriarRota: false, tipoServicoMultisoftware: tipoServicoMultisoftware, ClienteMultisoftware: ClienteMultisoftware, unitOfWork: unitOfWork, configuracao: configuracao, auditado: auditado, cadastroPedido: cadastroPedido);
            }
        }

        public void AtualizarCargaPorPedido(Dominio.Entidades.Embarcador.Pedidos.Pedido pedido, Dominio.Entidades.Embarcador.Cargas.Carga carga, bool recriarRota, TipoServicoMultisoftware tipoServicoMultisoftware, AdminMultisoftware.Dominio.Entidades.Pessoas.Cliente ClienteMultisoftware, UnitOfWork unitOfWork, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, bool cadastroPedido = false)
        {
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCarcaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoVeiculo repConfiguracaoVeiculo = new Repositorio.Embarcador.Configuracoes.ConfiguracaoVeiculo(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoVeiculo configuracaoVeiculo = repConfiguracaoVeiculo.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork).BuscarPrimeiroRegistro();

            if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
            {
                Servicos.Embarcador.Frota.OrdemServicoVeiculoManutencao ordemServicoVeiculoManutencao = new Servicos.Embarcador.Frota.OrdemServicoVeiculoManutencao(unitOfWork);
                ordemServicoVeiculoManutencao.VeiculoIndisponivelParaTransporte(pedido);

                if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova || carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe)
                    AtualizarCargaPorPedido(pedido, carga, tipoServicoMultisoftware, unitOfWork, configuracao, configuracaoGeralCarga);
                else
                    throw new ServicoException($"Não é possível atualizar o pedido na atual situação da carga ({carga.DescricaoSituacaoCarga})");
            }
            else
                AtualizarCargaPorPedido(pedido, carga, tipoServicoMultisoftware, unitOfWork, configuracao, configuracaoGeralCarga);

            if (pedido.Filial != null)
            {
                new GestaoPatio.FluxoGestaoPatio(unitOfWork, auditado, configuracao).TrocarFilial(carga, filialAntiga: carga.Filial, filialNova: pedido.Filial);

                carga.Filial = pedido.Filial;
            }

            if (pedido.Empresa != null)
                carga.Empresa = pedido.Empresa;

            carga.CodigoCargaEmbarcador = !string.IsNullOrWhiteSpace(carga.CodigoCargaEmbarcador) ? carga.CodigoCargaEmbarcador : pedido.CodigoCargaEmbarcador;

            if (pedido.TipoOperacao != null)
                carga.TipoOperacao = pedido.TipoOperacao;

            if (pedido.TipoDeCarga != null)
                carga.TipoDeCarga = pedido.TipoDeCarga;

            if (pedido.ModeloVeicularCarga != null)
                carga.ModeloVeicularCarga = pedido.ModeloVeicularCarga;

            if (pedido.PedidoViagemNavio != null)
                carga.PedidoViagemNavio = pedido.PedidoViagemNavio;

            if (carga.TipoOperacao != null)
            {
                carga.ExigeNotaFiscalParaCalcularFrete = carga.TipoOperacao.ExigeNotaFiscalParaCalcularFrete;
                carga.NaoExigeVeiculoParaEmissao = carga.TipoOperacao.NaoExigeVeiculoParaEmissao;
            }
            else
            {
                carga.ExigeNotaFiscalParaCalcularFrete = configuracao.ExigirNotaFiscalParaCalcularFreteCarga;
                carga.NaoExigeVeiculoParaEmissao = false;
            }

            if (configuracao.UtilizaEmissaoMultimodal)
                carga.NaoExigeVeiculoParaEmissao = true;

            if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
                carga.ExigeNotaFiscalParaCalcularFrete = true;

            carga.CargaTakeOrPay = pedido.PedidoTakeOrPay;
            carga.CargaDemurrage = pedido.PedidoDemurrage;
            carga.CargaDetention = pedido.PedidoDetention;
            carga.CargaTransbordo = pedido.PedidoTransbordo;
            carga.CargaSVMTerceiro = pedido.PedidoDeSVMTerceiro;
            carga.CargaDestinadaCTeComplementar = pedido?.TipoOperacao?.OperacaoDestinadaCTeComplementar ?? false;
            if (carga.CargaSVMTerceiro)
                carga.CargaSVM = false;

            if (carga.CargaDestinadaCTeComplementar)
            {
                string numeroOSMae = repPedido.BuscarNumeroOSMae(pedido.Codigo);
                if (!string.IsNullOrWhiteSpace(numeroOSMae))
                    this.VincularMotoristaVeiculosOSMae(carga, pedido, numeroOSMae, unitOfWork, tipoServicoMultisoftware, configuracao);
            }

            if (pedido.Motoristas?.Count > 0)
                new CargaMotorista(unitOfWork).AtualizarMotoristas(carga, pedido.Motoristas.ToList());

            if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
            {
                List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos = repCarcaPedido.BuscarPedidosPorCarga(carga.Codigo);
                foreach (Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoAtualizar in pedidos)
                {
                    if (pedidoAtualizar.Codigo != pedido.Codigo)
                    {
                        if (pedidoAtualizar.Motoristas == null)
                            pedidoAtualizar.Motoristas = new List<Dominio.Entidades.Usuario>();
                        else
                            pedidoAtualizar.Motoristas.Clear();
                        if (pedido.Motoristas != null)
                        {
                            foreach (Dominio.Entidades.Usuario motorista in pedido.Motoristas)
                                pedidoAtualizar.Motoristas.Add(motorista);
                        }
                        repPedido.Atualizar(pedidoAtualizar);
                    }
                }
            }

            if (cadastroPedido && configuracao.PermitirSelecionarReboquePedido)
            {
                carga.Veiculo = pedido.VeiculoTracao;

                if (carga.ModeloVeicularCarga == null && carga.Veiculo?.ModeloVeicularCarga != null && carga.Veiculo.ModeloVeicularCarga.Tipo != TipoModeloVeicularCarga.Tracao)
                    carga.ModeloVeicularCarga = carga.Veiculo.ModeloVeicularCarga;

                if (carga.VeiculosVinculados != null)
                    carga.VeiculosVinculados.Clear();
                else
                    carga.VeiculosVinculados = new List<Dominio.Entidades.Veiculo>();

                foreach (Dominio.Entidades.Veiculo reboque in pedido.Veiculos)
                {
                    if (carga.ModeloVeicularCarga == null && reboque.ModeloVeicularCarga != null && reboque.ModeloVeicularCarga.Tipo != TipoModeloVeicularCarga.Tracao)
                        carga.ModeloVeicularCarga = reboque.ModeloVeicularCarga;

                    carga.VeiculosVinculados.Add(reboque);
                }
            }
            else
            {
                foreach (Dominio.Entidades.Veiculo veiculo in pedido.Veiculos)
                {
                    if (veiculo.TipoVeiculo == "0")
                        carga.Veiculo = veiculo;
                    else
                    {
                        if (veiculo.VeiculosTracao != null && veiculo.VeiculosTracao.Count > 0)
                            carga.Veiculo = veiculo.VeiculosTracao.FirstOrDefault();
                        else
                            carga.Veiculo = veiculo;
                    }

                    if (carga.ModeloVeicularCarga == null && carga.Veiculo?.ModeloVeicularCarga != null && carga.Veiculo.ModeloVeicularCarga.Tipo != TipoModeloVeicularCarga.Tracao)
                        carga.ModeloVeicularCarga = carga.Veiculo.ModeloVeicularCarga;

                    if (carga.Veiculo?.VeiculosVinculados != null)
                    {
                        if (carga.VeiculosVinculados != null)
                            carga.VeiculosVinculados.Clear();
                        else
                            carga.VeiculosVinculados = new List<Dominio.Entidades.Veiculo>();

                        foreach (Dominio.Entidades.Veiculo reboque in carga.Veiculo.VeiculosVinculados)
                        {
                            if (carga.ModeloVeicularCarga == null && reboque.ModeloVeicularCarga != null && reboque.ModeloVeicularCarga.Tipo != TipoModeloVeicularCarga.Tracao)
                                carga.ModeloVeicularCarga = reboque.ModeloVeicularCarga;

                            carga.VeiculosVinculados.Add(reboque);
                        }
                    }
                }

                if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
                {
                    List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos = repCarcaPedido.BuscarPedidosPorCarga(carga.Codigo);

                    foreach (Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoAtualizar in pedidos)
                    {
                        if (pedidoAtualizar.Codigo != pedido.Codigo)
                        {
                            pedidoAtualizar.VeiculoTracao = pedido.VeiculoTracao;
                            if (pedidoAtualizar.Veiculos == null)
                                pedidoAtualizar.Veiculos = new List<Dominio.Entidades.Veiculo>();
                            else
                                pedidoAtualizar.Veiculos.Clear();
                            foreach (Dominio.Entidades.Veiculo veiculo in pedido.Veiculos)
                            {
                                if (veiculo.TipoVeiculo == "1")
                                    pedidoAtualizar.Veiculos.Add(veiculo);
                                else
                                {
                                    pedidoAtualizar.VeiculoTracao = veiculo;
                                    foreach (Dominio.Entidades.Veiculo reboque in veiculo.VeiculosVinculados)
                                    {
                                        pedidoAtualizar.Veiculos.Add(reboque);
                                    }
                                }
                            }
                            repPedido.Atualizar(pedidoAtualizar);
                        }
                    }
                }
            }

            if (configuracaoVeiculo?.CriarVinculoFrotaCargaForaDoPlanejamentoFrota ?? false)
                AplicarAlteracaoCargaAoPlanejamentoFrota(carga, tipoServicoMultisoftware, ClienteMultisoftware, "", unitOfWork);

            FecharCarga(carga, unitOfWork, tipoServicoMultisoftware, ClienteMultisoftware, recriarRota, true, true, true);

            if (!carga.CargaDePreCarga || !repositorioCarga.ExisteCargaFechadaPorPreCarga(carga.Codigo))
                carga.CargaFechada = true;

            Servicos.Log.TratarErro("5 - Fechou Carga (" + carga.Codigo + ") " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "FechamentoCarga");

            repositorioCarga.Atualizar(carga);

            Repositorio.Embarcador.Cargas.CargaJanelaCarregamento repCargaJanelaCarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamento(unitOfWork);
            Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento = repCargaJanelaCarregamento.BuscarPorCarga(carga.Codigo);

            if (cargaJanelaCarregamento != null)
                new Hubs.JanelaCarregamento().InformarJanelaCarregamentoAtualizada(cargaJanelaCarregamento);
        }

        public void VincularMotoristaVeiculosOSMae(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Pedidos.Pedido pedido, string numeroOSMae, Repositorio.UnitOfWork unitOfWork, TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao)
        {
            Servicos.Embarcador.Carga.CargaDadosSumarizados serCargaDadosSumarizados = new Servicos.Embarcador.Carga.CargaDadosSumarizados(unitOfWork);

            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);

            Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoOSMae = repPedido.BuscarPorNumeroOS(numeroOSMae);
            if (pedidoOSMae == null || pedido == null)
                return;

            if (pedidoOSMae.Motoristas.Count > 0)
            {
                if (pedido.Motoristas == null)
                    pedido.Motoristas = new List<Dominio.Entidades.Usuario>();
                else
                    pedido.Motoristas.Clear();

                foreach (Dominio.Entidades.Usuario motorista in pedidoOSMae.Motoristas)
                    pedido.Motoristas.Add(motorista);
            }

            if (pedidoOSMae.VeiculoTracao != null)
                pedido.VeiculoTracao = pedidoOSMae.VeiculoTracao;

            if (pedidoOSMae.Veiculos.Count > 0)
            {
                if (pedido.Veiculos == null)
                    pedido.Veiculos = new List<Dominio.Entidades.Veiculo>();
                else
                    pedido.Veiculos.Clear();

                foreach (Dominio.Entidades.Veiculo veiculo in pedidoOSMae.Veiculos)
                {
                    if (veiculo.TipoVeiculo == "1")
                        pedido.Veiculos.Add(veiculo);
                    else
                    {
                        pedido.Veiculos.Add(veiculo);
                        pedido.VeiculoTracao = veiculo;
                        foreach (Dominio.Entidades.Veiculo reboque in veiculo.VeiculosVinculados)
                        {
                            pedido.Veiculos.Add(reboque);
                        }
                    }
                }
            }
            repPedido.Atualizar(pedido);

            if (pedidoOSMae.Veiculos.Count > 0)
            {
                foreach (Dominio.Entidades.Veiculo veiculo in pedidoOSMae.Veiculos)
                {
                    if (veiculo.TipoVeiculo == "0")
                        carga.Veiculo = veiculo;
                    else
                    {
                        if (veiculo.VeiculosTracao != null && veiculo.VeiculosTracao.Count > 0)
                            carga.Veiculo = veiculo.VeiculosTracao.FirstOrDefault();
                        else
                            carga.Veiculo = veiculo;
                    }

                    if (carga.ModeloVeicularCarga == null && carga.Veiculo?.ModeloVeicularCarga != null && carga.Veiculo.ModeloVeicularCarga.Tipo != TipoModeloVeicularCarga.Tracao)
                        carga.ModeloVeicularCarga = carga.Veiculo.ModeloVeicularCarga;

                    if (carga.Veiculo?.VeiculosVinculados != null)
                    {
                        if (carga.VeiculosVinculados != null)
                            carga.VeiculosVinculados.Clear();
                        else
                            carga.VeiculosVinculados = new List<Dominio.Entidades.Veiculo>();

                        foreach (Dominio.Entidades.Veiculo reboque in carga.Veiculo.VeiculosVinculados)
                        {
                            if (carga.ModeloVeicularCarga == null && reboque.ModeloVeicularCarga != null && reboque.ModeloVeicularCarga.Tipo != TipoModeloVeicularCarga.Tracao)
                                carga.ModeloVeicularCarga = reboque.ModeloVeicularCarga;

                            carga.VeiculosVinculados.Add(reboque);
                        }
                    }
                }
            }
            carga.NaoExigeVeiculoParaEmissao = false;
            if (pedido.Motoristas != null && pedido.Motoristas.Count > 0)
            {
                new CargaMotorista(unitOfWork).AtualizarMotoristas(carga, pedido.Motoristas.ToList());
                serCargaDadosSumarizados.AlterarDadosSumarizadosCarga(ref carga, configuracao, unitOfWork, tipoServicoMultisoftware);
            }


            repCarga.Atualizar(carga);
        }

        public async Task VincularMotoristaVeiculosOSMaeAsync(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Pedidos.Pedido pedido, string numeroOSMae, Repositorio.UnitOfWork unitOfWork, TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao)
        {
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repositorioPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);

            Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoOSMae = await repositorioPedido.BuscarPorNumeroOSAsync(numeroOSMae);

            if (pedidoOSMae == null || pedido == null)
                return;

            if (pedidoOSMae.Motoristas.Count > 0)
            {
                if (pedido.Motoristas == null)
                    pedido.Motoristas = new List<Dominio.Entidades.Usuario>();
                else
                    pedido.Motoristas.Clear();

                foreach (Dominio.Entidades.Usuario motorista in pedidoOSMae.Motoristas)
                    pedido.Motoristas.Add(motorista);
            }

            if (pedidoOSMae.VeiculoTracao != null)
                pedido.VeiculoTracao = pedidoOSMae.VeiculoTracao;

            if (pedidoOSMae.Veiculos.Count > 0)
            {
                if (pedido.Veiculos == null)
                    pedido.Veiculos = new List<Dominio.Entidades.Veiculo>();
                else
                    pedido.Veiculos.Clear();

                foreach (Dominio.Entidades.Veiculo veiculo in pedidoOSMae.Veiculos)
                {
                    if (veiculo.TipoVeiculo == "1")
                        pedido.Veiculos.Add(veiculo);
                    else
                    {
                        pedido.Veiculos.Add(veiculo);
                        pedido.VeiculoTracao = veiculo;
                        foreach (Dominio.Entidades.Veiculo reboque in veiculo.VeiculosVinculados)
                        {
                            pedido.Veiculos.Add(reboque);
                        }
                    }
                }
            }

            if (pedidoOSMae.Veiculos.Count > 0)
            {
                foreach (Dominio.Entidades.Veiculo veiculo in pedidoOSMae.Veiculos)
                {
                    if (veiculo.TipoVeiculo == "0")
                        carga.Veiculo = veiculo;
                    else
                    {
                        if (veiculo.VeiculosTracao != null && veiculo.VeiculosTracao.Count > 0)
                            carga.Veiculo = veiculo.VeiculosTracao.FirstOrDefault();
                        else
                            carga.Veiculo = veiculo;
                    }

                    if (carga.ModeloVeicularCarga == null && carga.Veiculo?.ModeloVeicularCarga != null && carga.Veiculo.ModeloVeicularCarga.Tipo != TipoModeloVeicularCarga.Tracao)
                        carga.ModeloVeicularCarga = carga.Veiculo.ModeloVeicularCarga;

                    if (carga.Veiculo?.VeiculosVinculados != null)
                    {
                        if (carga.VeiculosVinculados != null)
                            carga.VeiculosVinculados.Clear();
                        else
                            carga.VeiculosVinculados = new List<Dominio.Entidades.Veiculo>();

                        foreach (Dominio.Entidades.Veiculo reboque in carga.Veiculo.VeiculosVinculados)
                        {
                            if (carga.ModeloVeicularCarga == null && reboque.ModeloVeicularCarga != null && reboque.ModeloVeicularCarga.Tipo != TipoModeloVeicularCarga.Tracao)
                                carga.ModeloVeicularCarga = reboque.ModeloVeicularCarga;

                            carga.VeiculosVinculados.Add(reboque);
                        }
                    }
                }
            }

            carga.NaoExigeVeiculoParaEmissao = false;

            if (pedido.Motoristas != null && pedido.Motoristas.Count > 0)
                new CargaMotorista(unitOfWork).AtualizarMotoristas(carga, pedido.Motoristas.ToList());

        }

        public void SetarRotaCarregamentoNaCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacao cargaRoteirizacao, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            Repositorio.Embarcador.Cargas.CargaRotaFrete repCargaRotaFrete = new Repositorio.Embarcador.Cargas.CargaRotaFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaRotaFretePontosPassagem repCargaRotaFretePontosPassagem = new Repositorio.Embarcador.Cargas.CargaRotaFretePontosPassagem(unitOfWork);
            Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacaoPontosPassagem repCarregamentoRoteirizacaoPontosPassagem = new Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacaoPontosPassagem(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.CargaRotaFrete cargaRotaFrete = repCargaRotaFrete.BuscarPorCarga(carga.Codigo);

            if (cargaRotaFrete == null)
            {
                cargaRotaFrete = new Dominio.Entidades.Embarcador.Cargas.CargaRotaFrete();
                cargaRotaFrete.Carga = carga;
            }

            cargaRotaFrete.PolilinhaRota = cargaRoteirizacao.PolilinhaRota;
            cargaRotaFrete.TempoDeViagemEmMinutos = cargaRoteirizacao.TempoDeViagemEmMinutos;
            cargaRotaFrete.TipoUltimoPontoRoteirizacao = cargaRoteirizacao.TipoUltimoPontoRoteirizacao;

            if (cargaRotaFrete.Codigo > 0)
                repCargaRotaFrete.Atualizar(cargaRotaFrete);
            else
                repCargaRotaFrete.Inserir(cargaRotaFrete);

            carga.OrdemRoteirizacaoDefinida = true;
            carga.SituacaoRoteirizacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoRoteirizacao.Concluido;

            repCargaRotaFretePontosPassagem.DeletarPorCargaRotaFrete(cargaRotaFrete.Codigo);

            List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacaoPontosPassagem> carregamentoRoteirizacaoPontosPassagem = repCarregamentoRoteirizacaoPontosPassagem.BuscarPorCarregamentoRoteirizacao(cargaRoteirizacao.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaRotaFretePontosPassagem> pontosPassagemCarga = new List<Dominio.Entidades.Embarcador.Cargas.CargaRotaFretePontosPassagem>();
            for (int i = 0; i < carregamentoRoteirizacaoPontosPassagem.Count; i++)
            {
                Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacaoPontosPassagem carregamentoRoteirizacaoPontoPassagem = carregamentoRoteirizacaoPontosPassagem[i];
                Dominio.Entidades.Embarcador.Cargas.CargaRotaFretePontosPassagem cargaRotaFretePontoPassagem = new Dominio.Entidades.Embarcador.Cargas.CargaRotaFretePontosPassagem();
                cargaRotaFretePontoPassagem.CargaRotaFrete = cargaRotaFrete;
                cargaRotaFretePontoPassagem.Cliente = carregamentoRoteirizacaoPontoPassagem.Cliente;
                cargaRotaFretePontoPassagem.ClienteOutroEndereco = carregamentoRoteirizacaoPontoPassagem.ClienteOutroEndereco;
                cargaRotaFretePontoPassagem.Distancia = carregamentoRoteirizacaoPontoPassagem.Distancia;
                cargaRotaFretePontoPassagem.DistanciaDireta = carregamentoRoteirizacaoPontoPassagem.DistanciaDireta;
                cargaRotaFretePontoPassagem.Latitude = carregamentoRoteirizacaoPontoPassagem.Latitude;
                cargaRotaFretePontoPassagem.Longitude = carregamentoRoteirizacaoPontoPassagem.Longitude;
                cargaRotaFretePontoPassagem.Ordem = carregamentoRoteirizacaoPontoPassagem.Ordem;
                cargaRotaFretePontoPassagem.PracaPedagio = carregamentoRoteirizacaoPontoPassagem.PracaPedagio;
                cargaRotaFretePontoPassagem.Tempo = carregamentoRoteirizacaoPontoPassagem.Tempo;
                cargaRotaFretePontoPassagem.TipoPontoPassagem = carregamentoRoteirizacaoPontoPassagem.TipoPontoPassagem;
                repCargaRotaFretePontosPassagem.Inserir(cargaRotaFretePontoPassagem);
                pontosPassagemCarga.Add(cargaRotaFretePontoPassagem);

                if (carregamentoRoteirizacaoPontoPassagem.TipoPontoPassagem == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPontoPassagem.Coleta)
                    repCargaPedido.SetarOrdemColeta(carga.Codigo, carregamentoRoteirizacaoPontoPassagem.Ordem, carregamentoRoteirizacaoPontoPassagem.Cliente?.CPF_CNPJ ?? 0);
                else if (carregamentoRoteirizacaoPontoPassagem.TipoPontoPassagem == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPontoPassagem.Entrega)
                {
                    if (cargaRotaFretePontoPassagem.ClienteOutroEndereco != null)
                        repCargaPedido.SetarOrdemEntregaOutroEndereco(carga.Codigo, carregamentoRoteirizacaoPontoPassagem.Ordem, carregamentoRoteirizacaoPontoPassagem.ClienteOutroEndereco.Codigo);
                    else
                        repCargaPedido.SetarOrdemEntrega(carga.Codigo, carregamentoRoteirizacaoPontoPassagem.Ordem, carregamentoRoteirizacaoPontoPassagem.Cliente?.CPF_CNPJ ?? 0);
                }
            }

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> pedidoXMLNotaFiscals = repPedidoXMLNotaFiscal.BuscarPorCarga(carga.Codigo);
            Servicos.Embarcador.Carga.ControleEntrega.ControleEntrega.GerarCargaEntrega(carga, cargaPedidos, pedidoXMLNotaFiscals, cargaRotaFrete, pontosPassagemCarga, true, configuracao, unitOfWork, tipoServicoMultisoftware);
            Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota.CriarCargaValePedagioPorRotaFrete(carga, cargaPedidos, configuracao, unitOfWork, tipoServicoMultisoftware);
            //setar a flag carga.IntegrandoValePedagio para true caso exista consultas valor pedagio
            Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota.SetarCargaIntegrandoConsultaValePedagio(carga, unitOfWork);

            //carga.PracasPedagio = rotaFrete.PracasPedagio.ToList();
            //Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota.CriarCargaValePedagioPorRotaFrete(carga, unitOfWork);
        }

        public Dominio.ObjetosDeValor.Embarcador.Carga.RetornoCargaPossuiOperacao VerificarSeCargaPossuiOperacao(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Dominio.ObjetosDeValor.Embarcador.Carga.RetornoCargaPossuiOperacao retorno = new Dominio.ObjetosDeValor.Embarcador.Carga.RetornoCargaPossuiOperacao();

            Repositorio.Embarcador.Frete.TabelaFreteCliente repTabelaFreteCliente = new Repositorio.Embarcador.Frete.TabelaFreteCliente(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao();

            if (configuracaoTMS.TipoOperacaoObrigatorioMontagemCarga)
            {
                retorno.TabelaQuePossuiOperacao = true;

                return retorno;
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in (from cp in cargaPedidos where cp.Pedido.GrupoPessoas != null select cp))
            {
                int quantidadeTabelasComOperacao = repTabelaFreteCliente.QuantidadeDeTabelasComOperacao(cargaPedido.Pedido.Remetente, cargaPedido.Pedido.GrupoPessoas, DateTime.Now);
                if (quantidadeTabelasComOperacao > 0)
                {
                    retorno.TabelaQuePossuiOperacao = true;
                    break;
                }

                int quantidadeTabelasSemOperacao = repTabelaFreteCliente.QuantidadeDeTabelasSemOperacao(cargaPedido.Pedido.Remetente, cargaPedido.Pedido.GrupoPessoas, DateTime.Now);
                if (quantidadeTabelasSemOperacao > 0)
                {
                    retorno.TabelaQueNaoPossuiOperacao = true;
                }
            }

            return retorno;
        }

        public string CriarCargaPedidosPorPedidos(ref Dominio.Entidades.Embarcador.Cargas.Carga carga,
            List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos,
            AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware,
            List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro> apolicesSeguro,
            Repositorio.UnitOfWork unitOfWork,
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao,
            Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado = null,
            bool montagemCargaPorPedidoProduto = false,
            NumeroReboque numeroReboque = NumeroReboque.SemReboque,
            TipoCarregamentoPedido tipoCarregamentoPedido = TipoCarregamentoPedido.Normal,
            List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedido> carregamentoPedidos = null,
            bool pedidosDevolucao = false, List<Dominio.Entidades.Embarcador.Pedidos.PedidoStage> pedidosStage = null,
            Dominio.ObjetosDeValor.Embarcador.Carga.CarregamentoRoterizacaoValoresFrete carregamentoRoterizacaoValoresFrete = null)
        {
            string retorno = "";
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoQuantidades repCargaPedidoQuantidade = new Repositorio.Embarcador.Cargas.CargaPedidoQuantidades(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoProduto repPedidoProduto = new Repositorio.Embarcador.Pedidos.PedidoProduto(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoComponenteFrete repPedidoComponenteFrete = new Repositorio.Embarcador.Pedidos.PedidoComponenteFrete(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repApoliceSeguroAverbacao = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new ModeloDocumentoFiscal(unitOfWork);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoFronteira repositorioPedidoFronteira = new Repositorio.Embarcador.Pedidos.PedidoFronteira(unitOfWork);
            Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoProduto repCarregamentoPedidoProduto = new Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoProduto(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoRecolhimentoTroca repPedidoRecolhimentoTroca = new Repositorio.Embarcador.Pedidos.PedidoRecolhimentoTroca(unitOfWork);
            Repositorio.CFOP repCFOP = new CFOP(unitOfWork);
            Repositorio.Embarcador.ICMS.PedagioEstadoBaseCalculo repPedagioEstadoBaseCalculo = new Repositorio.Embarcador.ICMS.PedagioEstadoBaseCalculo(unitOfWork);
            Repositorio.Embarcador.Pessoas.ClienteDescarga repClienteDescarga = new Repositorio.Embarcador.Pessoas.ClienteDescarga(unitOfWork);
            Repositorio.Embarcador.Pedidos.RegraTomador repRegraTomador = new Repositorio.Embarcador.Pedidos.RegraTomador(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaMotorista repCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCTeParcial repositorioPedidoCTeParcial = new Repositorio.Embarcador.Pedidos.PedidoCTeParcial(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoNotaParcial repPedidoNotaParcial = new Repositorio.Embarcador.Pedidos.PedidoNotaParcial(unitOfWork);
            Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal repositorioCarregamentoPedidoNotaFiscal = new Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoPedido repCarregamentoPedido = new Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoPedido(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoPedido configuracaoPedido = new Repositorio.Embarcador.Configuracoes.ConfiguracaoPedido(unitOfWork).BuscarPrimeiroRegistro();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoMontagemCarga configuracaoMontagemCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoMontagemCarga(unitOfWork).BuscarPrimeiroRegistro();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork).BuscarPrimeiroRegistro();

            Servicos.Embarcador.Carga.CargaPedido serCargaPedido = new Servicos.Embarcador.Carga.CargaPedido(unitOfWork);
            Servicos.Embarcador.Carga.ICMS serRegraICMS = new Embarcador.Carga.ICMS(unitOfWork);
            Servicos.Embarcador.Carga.Carga serCarga = new Embarcador.Carga.Carga(unitOfWork);
            Servicos.Embarcador.Carga.ComponetesFrete serComponenteFrete = new ComponetesFrete(unitOfWork);
            Servicos.Embarcador.Carga.RateioFrete serRateioFrete = new RateioFrete(unitOfWork);

            DateTime? dataPrevistaChegadaCliente = null;

            if (configuracaoMontagemCarga.UtilizarDataPrevisaoSaidaVeiculo)
            {
                dataPrevistaChegadaCliente = carga.Carregamento?.DataInicioViagemPrevista ?? carga.Carregamento?.DataCarregamentoCarga;

                if (dataPrevistaChegadaCliente.HasValue)
                {
                    Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacao repositorioCarregamentoRoteirizacao = new Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacao(unitOfWork);
                    Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacao carregamentoRoteirizacao = repositorioCarregamentoRoteirizacao.BuscarPorCarregamento(carga.Carregamento?.Codigo ?? 0);

                    if (carregamentoRoteirizacao != null)
                        dataPrevistaChegadaCliente = dataPrevistaChegadaCliente.Value.AddMinutes(carregamentoRoteirizacao.TempoDeViagemEmMinutos);
                }
            }

            if (carga.TipoOperacao?.ManterOrdemAoRoteirizarAgendaEntrega ?? false)
                pedidos = pedidos.OrderBy(x => x.PrevisaoEntrega).ToList();

            List<int> codigosPedidos = pedidos.Select(o => o.Codigo).ToList();
            List<Dominio.Entidades.Cliente> listaFronteirasPedido = new List<Dominio.Entidades.Cliente>();

            DateTime dataInicialPrevisaoCarregamento = new DateTime();
            DateTime dataFinalPrevisaoCarregamento = new DateTime();
            DateTime dataCarregamento = new DateTime();

            List<Dominio.Entidades.Embarcador.ICMS.PedagioEstadoBaseCalculo> pedagioEstadosBaseCalculo = repPedagioEstadoBaseCalculo.BuscarPorEstados(pedidos.Select(o => o.Origem?.Estado.Sigla).Distinct().ToList());
            List<Dominio.ObjetosDeValor.Embarcador.ICMS.TabelaAliquota> tabelaAliquotas = new List<Dominio.ObjetosDeValor.Embarcador.ICMS.TabelaAliquota>();
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete> cargaPedidosComponentesCarga = new List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete>();

            List<Dominio.Entidades.Cliente> tomadoresFilialEmissora = new List<Dominio.Entidades.Cliente>();
            if (carga.EmpresaFilialEmissora != null)
            {
                double.TryParse(carga.EmpresaFilialEmissora.CNPJ_SemFormato, out double cnpjTomadorFilialEmissora);

                tomadoresFilialEmissora.Add(repCliente.BuscarPorCPFCNPJ(cnpjTomadorFilialEmissora));
            }

            int codigoCarregamento = carga.Carregamento?.Codigo ?? 0;

            //listas que sao usadas dentro do for
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoNotaParcial> notasParciais = repPedidoNotaParcial.BuscarPorPedidos(codigosPedidos);
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParcial> ctesParciais = repositorioPedidoCTeParcial.BuscarPorPedidos(codigosPedidos);
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoProduto> listaTodosPedidoProduto = repPedidoProduto.BuscarPorPedidos(codigosPedidos);
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete> listaTodosPedidosComponenteFrete = repPedidoComponenteFrete.BuscarPorPedidos(codigosPedidos);
            List<Dominio.ObjetosDeValor.Embarcador.Carga.TotalizadorModeloDocumento> notasPedidos = repPedido.BuscarNotasPorPedidos(codigosPedidos);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> redespachosProximoTrecho = repCargaPedido.BuscarCargaPedidosProximoTrecho(codigosPedidos);
            List<Dominio.Entidades.Embarcador.Cargas.Carga> cargaOrigemPedidos = repCargaPedido.BuscarCargaComComTipoOperacaoDisponivelParaCarrementoDiferenteDaAtual(codigosPedidos, carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoQuantidades> cargaPedidoQuantidades = repCargaPedidoQuantidade.BuscarPorCargaPedidosQuantidades(codigosPedidos);

            List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoProduto> listaTodosPedidoProdutoCarregamento = new List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoProduto>();
            List<Dominio.ObjetosDeValor.Embarcador.Carga.MontagemCarga.SaldoPedidoProduto> produtosPedidosNaoAtendido = new List<Dominio.ObjetosDeValor.Embarcador.Carga.MontagemCarga.SaldoPedidoProduto>();

            // Pesquisa todos os pedidos/produtos contidos em um ou mais carregamento.
            if (montagemCargaPorPedidoProduto && codigoCarregamento > 0)
            {
                listaTodosPedidoProdutoCarregamento = repCarregamentoPedidoProduto.BuscarPorCarregamentoEPedidos(codigoCarregamento, codigosPedidos);
                List<Dominio.ObjetosDeValor.Embarcador.Carga.MontagemCarga.SaldoPedidoProduto> produtos = Servicos.Embarcador.Carga.MontagemCarga.SaldoPedidoProduto.ObterSaldoPedidoProdutos(codigosPedidos, unitOfWork);
                produtosPedidosNaoAtendido = (from prod in produtos where prod.SaldoQtde > 0 select prod).ToList();
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = new List<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            bool possuiFilialEmissora = false;

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosPreCarga = new List<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
            if (carga.CargaPreCarga != null && !string.IsNullOrEmpty(carga.CargaPreCarga.NumeroCargaVincularPreCarga))
                cargaPedidosPreCarga = repCargaPedido.BuscarPorCarga(carga.CargaPreCarga.Codigo);

            List<double> cnpjDestinatarios = (from ped in pedidos where ped.Destinatario != null select ped.Destinatario.CPF_CNPJ).Distinct().ToList();

            IList<Dominio.ObjetosDeValor.Embarcador.Pedido.PedidoRecolhimentoDestinatario> recolhimentosDestinatarios = new List<Dominio.ObjetosDeValor.Embarcador.Pedido.PedidoRecolhimentoDestinatario>();
            if (cnpjDestinatarios?.Count > 0)
                recolhimentosDestinatarios = repPedido.BuscarPedidoParaRecolhimento(cnpjDestinatarios);

            List<int> notas = notasPedidos.Select(obj => obj.Total).Distinct().ToList();

            List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> listaCarregamentoPedidoNotaFiscal = repositorioCarregamentoPedidoNotaFiscal.BuscarPorCarregamento(codigoCarregamento);

            List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> xMLNotaFiscals = notas.Any() ? repXMLNotaFiscal.BuscarPorCodigos(notas) : new List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal>();

            List<Dominio.Entidades.Embarcador.Pessoas.ClienteDescarga> clientesDescarga = cnpjDestinatarios.Any() ? repClienteDescarga.BuscarPorPessoas(cnpjDestinatarios) : new List<Dominio.Entidades.Embarcador.Pessoas.ClienteDescarga>();

            bool possuiRegraTomador = repRegraTomador.PossuiRegras();

            List<int> notasUtilizadas = new List<int>();

            int count = 1;

            List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> listaNotasJaEnviadasDosPedidos = repositorioCarregamentoPedidoNotaFiscal.BuscarJaUtilizadasPorCarregamentoEPedidos(codigosPedidos, codigoCarregamento);
            List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> listaTotalNotasJaEnviadas = new List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal>();
            listaTotalNotasJaEnviadas.AddRange(listaNotasJaEnviadasDosPedidos);
            listaTotalNotasJaEnviadas.AddRange(listaCarregamentoPedidoNotaFiscal);

            List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedido> pedidosCarregamento = carregamentoPedidos;

            if (carga != null && carga.Carregamento != null && pedidosCarregamento == null)
                pedidosCarregamento = repCarregamentoPedido.BuscarPorCarregamento(carga.Carregamento.Codigo);

            Dominio.ObjetosDeValor.Embarcador.Carga.MontagemCargaSqlPedidoProduto ObjetoMontagemCargaSqlPedidoProduto = new Dominio.ObjetosDeValor.Embarcador.Carga.MontagemCargaSqlPedidoProduto();

            bool setarOrdemEntrega = false;
            int qtdeSemOrdem = (from obj in pedidos
                                where obj.OrdemColetaProgramada == 0 && obj.OrdemEntregaProgramada == 0
                                select obj).Count();

            if ((carga.TipoOperacao?.ManterOrdemAoRoteirizarAgendaEntrega ?? false) && (pedidos.Count == qtdeSemOrdem || pedidosDevolucao))
            {
                if (!pedidos.Any(x => x.PrevisaoEntrega == null))
                {
                    pedidos = pedidos.OrderBy(x => x.PrevisaoEntrega).ToList();
                    setarOrdemEntrega = true;
                }
            }

            Repositorio.Embarcador.Pedidos.PedidoAnexo repPedidoAnexo = new Repositorio.Embarcador.Pedidos.PedidoAnexo(unitOfWork);
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoAnexo> pedidosAnexos = repPedidoAnexo.BuscarPorPedidos(codigosPedidos);

            Dominio.Entidades.Embarcador.Pedidos.Stage stage = Servicos.Embarcador.Pedido.Stage.ObterStageMaisRelevante(pedidosStage);

            Repositorio.Embarcador.Filiais.EstadoDestinoEmpresaEmissora repositorioEstadoDestinoEmpresaEmissora = new Repositorio.Embarcador.Filiais.EstadoDestinoEmpresaEmissora(unitOfWork);
            List<Dominio.Entidades.Embarcador.Filiais.EstadoDestinoEmpresaEmissora> estadosDestinoEmpresaEmissora = carga.Filial != null ? repositorioEstadoDestinoEmpresaEmissora.BuscarPorFilial(carga.Filial.Codigo) : new List<Dominio.Entidades.Embarcador.Filiais.EstadoDestinoEmpresaEmissora>();

            bool? utilizarDistribuidorPorRegiaoNaRegiaoDestino = carga.TipoOperacao?.ConfiguracaoCarga?.UtilizarDistribuidorPorRegiaoNaRegiaoDestino ?? false;
            bool utilizarOutroEnderecoPedidoMesmoSePossuirRecebedor = carga.TipoOperacao?.ConfiguracaoEmissaoDocumento?.UtilizarOutroEnderecoPedidoMesmoSePossuirRecebedor ?? false;

            List<Dominio.Entidades.Cliente> clientesBloquearEmissaoDosDestinatarios = carga.TipoOperacao?.ClientesBloquearEmissaoDosDestinatario.ToList();

            Repositorio.Embarcador.Configuracoes.IntegracaoIntercab repIntegracaoIntercab = new Repositorio.Embarcador.Configuracoes.IntegracaoIntercab(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab = repIntegracaoIntercab.BuscarIntegracao();

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao();

            foreach (Dominio.Entidades.Embarcador.Pedidos.Pedido pedido in pedidos)
            {
                Servicos.Log.TratarErro("Iniciou Pedido " + count.ToString() + " de " + pedidos.Count.ToString() + " " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "MontagemCarga");
                count++;

                Dominio.Entidades.Embarcador.Pedidos.Stage stageParticipantes = null; //#69031
                if (pedidosStage?.Count > 0)
                    stageParticipantes = (from obj in pedidosStage where obj.Pedido.Codigo == pedido.Codigo select obj.Stage).FirstOrDefault();

                if (carga.CargaPreCarga != null && !string.IsNullOrEmpty(carga.CargaPreCarga.NumeroCargaVincularPreCarga))
                {
                    List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosPreCargaDestinatario = (from obj in cargaPedidosPreCarga where obj.Pedido.Destinatario?.CPF_CNPJ == pedido.Destinatario?.CPF_CNPJ select obj).ToList();
                    Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoPreCarga = cargaPedidosPreCargaDestinatario.FirstOrDefault();

                    if (cargaPedidoPreCarga != null)
                    {
                        string numeroPedido;
                        if (configuracaoPedido.ConcatenarNumeroPreCargaNoPedido)
                        {
                            string prefixoNumeroPedidoPreCarga = $"{cargaPedidoPreCarga.Carga.CodigoCargaEmbarcador}_";
                            IEnumerable<string> numerosPedidosPreCarga = cargaPedidosPreCargaDestinatario.Select(o => o.Pedido.NumeroPedidoEmbarcador.Replace(prefixoNumeroPedidoPreCarga, ""));
                            numeroPedido = $"{carga.CodigoCargaEmbarcador}_{string.Join("_", numerosPedidosPreCarga)}";
                        }
                        else
                            numeroPedido = cargaPedidoPreCarga.Pedido.NumeroPedidoEmbarcador.Replace(cargaPedidoPreCarga.Carga.CodigoCargaEmbarcador, carga.CodigoCargaEmbarcador);

                        pedido.NumeroPedidoEmbarcador = numeroPedido.Left(tamanho: 50);
                        pedido.PrevisaoEntrega = cargaPedidoPreCarga.Pedido.PrevisaoEntrega;
                        pedido.QtVolumes = cargaPedidosPreCargaDestinatario.Sum(o => o.Pedido.QtVolumes);
                    }
                }

                carga.CargaTakeOrPay = pedido.PedidoTakeOrPay;
                carga.CargaDemurrage = pedido.PedidoDemurrage;
                carga.CargaDetention = pedido.PedidoDetention;
                carga.CargaDestinadaCTeComplementar = pedido?.TipoOperacao?.OperacaoDestinadaCTeComplementar ?? false;
                carga.CargaSVMTerceiro = pedido.PedidoDeSVMTerceiro;
                if (carga.CargaSVMTerceiro)
                    carga.CargaSVM = false;

                if (carga.CargaDestinadaCTeComplementar)
                {
                    string numeroOSMae = repPedido.BuscarNumeroOSMae(pedido.Codigo);
                    if (!string.IsNullOrWhiteSpace(numeroOSMae))
                        this.VincularMotoristaVeiculosOSMae(carga, pedido, numeroOSMae, unitOfWork, tipoServicoMultisoftware, configuracao);
                }

                if (pedido.DataInicialColeta.HasValue && (pedido.DataInicialColeta < dataInicialPrevisaoCarregamento || dataInicialPrevisaoCarregamento == DateTime.MinValue))
                    dataInicialPrevisaoCarregamento = pedido.DataInicialColeta.Value;

                if (pedido.DataFinalColeta.HasValue && (pedido.DataFinalColeta > dataFinalPrevisaoCarregamento || dataFinalPrevisaoCarregamento == DateTime.MinValue))
                    dataFinalPrevisaoCarregamento = pedido.DataFinalColeta.Value;

                if (pedido.DataCarregamentoPedido.HasValue && (pedido.DataCarregamentoPedido < dataCarregamento || dataCarregamento == DateTime.MinValue))
                    dataCarregamento = pedido.DataCarregamentoPedido.Value;

                List<Dominio.Entidades.Cliente> listaFronteirasPedidoValidar = repositorioPedidoFronteira.BuscarFronteirasPorPedido(pedido.Codigo);
                if (listaFronteirasPedidoValidar.Count == 0 && pedido.Fronteira != null)
                {
                    listaFronteirasPedidoValidar.Add(pedido.Fronteira);
                }

                bool fronteirasPedidoIguais = true;
                if (listaFronteirasPedido.Count != listaFronteirasPedidoValidar.Count && carga.Pedidos?.Count > 0)
                {
                    fronteirasPedidoIguais = false;
                }
                else
                {
                    List<double> cpfsOriginal = listaFronteirasPedido?.Select(c => c.CPF_CNPJ).OrderBy(c => c).ToList();
                    List<double> cpfsValidar = listaFronteirasPedidoValidar.Select(c => c.CPF_CNPJ).OrderBy(c => c).ToList();

                    if (cpfsOriginal?.Count > 0)
                        fronteirasPedidoIguais = cpfsOriginal.SequenceEqual(cpfsValidar);
                }

                if (listaFronteirasPedido.Count == 0 && listaFronteirasPedidoValidar.Count > 0 || fronteirasPedidoIguais)
                {
                    listaFronteirasPedido = listaFronteirasPedidoValidar;
                }
                else
                    retorno = "Não é possível gerar uma carga de pedidos, onde a fronteira seja diferente";

                if (configuracaoPedido.AtivarValidacaoCriacaoCarga)
                {
                    Dominio.Entidades.Veiculo veiculoTracao = pedido.VeiculoTracao;
                    if (veiculoTracao == null && pedido.Veiculos != null && pedido.Veiculos.Count > 0)
                        veiculoTracao = pedido.Veiculos.Where(c => c.TipoVeiculo == "0")?.FirstOrDefault();

                    if (veiculoTracao == null && (pedido.Motoristas == null || pedido.Motoristas.Count == 0))
                    {
                        retorno = "Com a configuração de validação da criação de carga, não é possível gerar uma carga sem veículo ou motorista";
                    }
                    else
                    {
                        if (configuracaoPedido.QuantidadeCargasEmAberto > 0)
                        {
                            int quantidadeCargaPedido = 0;
                            if (veiculoTracao != null && pedido.Motoristas != null && pedido.Motoristas.Count > 0)
                                quantidadeCargaPedido = repCargaPedido.BuscarQuantidadeCargaPedidoPorVeiculoMotorista(veiculoTracao.Codigo, pedido.Motoristas.Select(c => c.Codigo).ToList());
                            if (veiculoTracao != null && quantidadeCargaPedido == 0)
                                quantidadeCargaPedido = repCargaPedido.BuscarQuantidadeCargaPedidoPorVeiculoMotorista(veiculoTracao.Codigo);
                            if (pedido.Motoristas != null && pedido.Motoristas.Count > 0 && quantidadeCargaPedido == 0)
                                quantidadeCargaPedido = repCargaPedido.BuscarQuantidadeCargaPedidoPorVeiculoMotorista(pedido.Motoristas.Select(c => c.Codigo).ToList());

                            if (quantidadeCargaPedido > configuracaoPedido.QuantidadeCargasEmAberto)
                                retorno = "A quantidade de cargas atual (" + quantidadeCargaPedido.ToString("D") + ") excede a quantidade limite de cargas em aberto configurado (" + configuracaoPedido.QuantidadeCargasEmAberto.ToString("D") + ")";
                        }

                        Dominio.Entidades.Embarcador.Cargas.CargaPedido ultimoCargaPedido = null;
                        if (veiculoTracao != null && pedido.Motoristas != null && pedido.Motoristas.Count > 0)
                            ultimoCargaPedido = repCargaPedido.BuscarUltimaCargaPedidoPorVeiculoMotorista(veiculoTracao.Codigo, pedido.Motoristas.Select(c => c.Codigo).ToList());
                        if (veiculoTracao != null && ultimoCargaPedido == null)
                            ultimoCargaPedido = repCargaPedido.BuscarUltimaCargaPedidoPorVeiculoMotorista(veiculoTracao.Codigo);
                        if (pedido.Motoristas != null && pedido.Motoristas.Count > 0 && ultimoCargaPedido == null)
                            ultimoCargaPedido = repCargaPedido.BuscarUltimaCargaPedidoPorVeiculoMotorista(pedido.Motoristas.Select(c => c.Codigo).ToList());

                        if (ultimoCargaPedido != null)
                        {
                            if ((pedido.Origem?.Codigo ?? 0) != (ultimoCargaPedido?.Destino?.Codigo ?? 0))
                                retorno = "A origem do pedido (" + (pedido.Origem?.Descricao ?? "") + ") não está de acordo com o último destino (" + (ultimoCargaPedido?.Destino?.Descricao ?? "") + " Carga: " + (ultimoCargaPedido?.Carga?.CodigoCargaEmbarcador ?? "") + ")";
                        }
                    }
                }

                List<Dominio.Entidades.Embarcador.Pedidos.PedidoProduto> listaPedidoProduto = listaTodosPedidoProduto.Where(o => o.Pedido.Codigo == pedido.Codigo).ToList();

                List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoProduto> produtosDoPedidoNoCarregamento = new List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoProduto>();

                if (montagemCargaPorPedidoProduto && codigoCarregamento > 0)
                    produtosDoPedidoNoCarregamento = (from cpp in listaTodosPedidoProdutoCarregamento
                                                      where cpp.CarregamentoPedido.Carregamento.Codigo == codigoCarregamento &&
                                                      cpp.CarregamentoPedido.Pedido.Codigo == pedido.Codigo
                                                      select cpp).ToList();


                decimal pesoTotalPedidoCarga = pedido.PesoTotal;
                decimal palletTotalPedidoCarga = pedido.TotalPallets;
                decimal pesoPallet = 0;
                decimal volumesCarregados = pedido.SaldoVolumesRestante;
                bool todosProdutosPedidoNestaCarga = false;
                TipoPaleteCliente tipoPaleteCliente = TipoPaleteCliente.NaoDefinido;

                if (pedidosCarregamento != null && pedidosCarregamento.Any())
                {
                    pesoTotalPedidoCarga = pedidosCarregamento.FirstOrDefault(p => p.Pedido.Codigo == pedido.Codigo && p.Peso > 0)?.Peso ?? pedido.PesoTotal;
                    palletTotalPedidoCarga = pedidosCarregamento.FirstOrDefault(p => p.Pedido.Codigo == pedido.Codigo && p.Pallet > 0)?.Pallet ?? pedido.TotalPallets;
                    pesoPallet = pedidosCarregamento.FirstOrDefault(p => p.Pedido.Codigo == pedido.Codigo && p.PesoPallet > 0)?.PesoPallet ?? 0;
                    tipoPaleteCliente = pedidosCarregamento.Find(p => p.Pedido.Codigo == pedido.Codigo)?.Pedido?.TipoPaleteCliente ?? TipoPaleteCliente.NaoDefinido;
                }

                if (montagemCargaPorPedidoProduto)
                {
                    pesoTotalPedidoCarga = produtosDoPedidoNoCarregamento.Sum(x => x.Peso);
                    volumesCarregados = produtosDoPedidoNoCarregamento.Sum(x => x.Quantidade);
                    todosProdutosPedidoNestaCarga = ((volumesCarregados + 0.5m) > listaPedidoProduto.Sum(x => x.Quantidade));
                }

                Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);

                Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido = new Dominio.Entidades.Embarcador.Cargas.CargaPedido
                {
                    Carga = carga,
                    CargaOrigem = carga,
                    Pedido = pedido,
                    Peso = pesoTotalPedidoCarga,
                    Pallet = palletTotalPedidoCarga,
                    PesoPallet = pesoPallet,
                    PesoLiquido = pedido.PesoLiquidoTotal,
                    Ativo = true,
                    ValorFrete = 0m,
                    SituacaoEmissao = SituacaoNF.Nova,
                    NumeroReboque = numeroReboque,
                    TipoCarregamentoPedido = tipoCarregamentoPedido,
                    PrevisaoEntrega = dataPrevistaChegadaCliente,
                    BloquearEmissaoDosDestinatario = false,
                    BloquearEmissaoDeEntidadeSemCadastro = false,
                    TipoServicoMultimodal = TipoServicoMultimodal.Normal,
                    CanalEntrega = stage?.CanalEntrega ?? stageParticipantes?.CanalEntrega ?? pedido.CanalEntrega,
                    CanalVenda = stage?.CanalVenda ?? stageParticipantes?.CanalVenda ?? pedido.CanalVenda,
                    StageRelevanteCusto = stage,
                    TipoPaleteCliente = tipoPaleteCliente,
                    IncluirICMSBCFreteProprio = carregamentoRoterizacaoValoresFrete?.ValorFrete?.ICMS?.IncluirICMSBCFreteProprio
                };

                if (carregamentoRoterizacaoValoresFrete != null)
                {

                    if (carregamentoRoterizacaoValoresFrete.ValorFrete?.ICMS?.IncluirICMSBCFreteProprio == false)
                    {
                        carregamentoRoterizacaoValoresFrete.ValorFrete.ValorTotalAReceber = carregamentoRoterizacaoValoresFrete.ValorFrete.FreteProprio;
                        carregamentoRoterizacaoValoresFrete.ValorFrete.FreteProprio = 0;
                        carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS = null;
                    }
                    if (carregamentoRoterizacaoValoresFrete.ValorFrete?.ICMS?.IncluirICMSBCFreteProprio == true)
                        carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS = null;

                    if (carga.TipoFreteEscolhido != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Cliente)
                    {
                        if (carregamentoRoterizacaoValoresFrete.ValorFrete != null)
                        {
                            if (carregamentoRoterizacaoValoresFrete.ValorFrete.FreteProprio == 0 && carregamentoRoterizacaoValoresFrete.ValorFrete.ValorTotalAReceber > 0)//neste caso deve encontrar o valor do frete liquido
                            {
                                if (cargaPedido.PossuiCTe)
                                {
                                    bool incluirBase = false;
                                    decimal baseCalculo = carregamentoRoterizacaoValoresFrete.ValorFrete.ValorTotalAReceber;
                                    decimal percentualIncluir = 100;
                                    if (carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS != null)
                                    {
                                        if (carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS.CST == "60")
                                            carregamentoRoterizacaoValoresFrete.ValorFrete.FreteProprio = carregamentoRoterizacaoValoresFrete.ValorFrete.ValorTotalAReceber;
                                        else
                                            carregamentoRoterizacaoValoresFrete.ValorFrete.FreteProprio = carregamentoRoterizacaoValoresFrete.ValorFrete.ValorTotalAReceber - carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS.ValorICMS;
                                    }
                                    else
                                    {
                                        if (repTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.CargoX) != null)
                                            carregamentoRoterizacaoValoresFrete.ValorFrete.FreteProprio = 0;
                                        else
                                        {
                                            Dominio.ObjetosDeValor.Embarcador.ICMS.RegraICMS regraICMS = serRegraICMS.BuscarRegraICMS(cargaPedido.Carga, cargaPedido, cargaPedido.Carga.Empresa, cargaPedido.Pedido.Remetente, cargaPedido.Pedido.Destinatario, cargaPedido.ObterTomador(), cargaPedido.Origem, cargaPedido.Destino, ref incluirBase, ref percentualIncluir, baseCalculo, null, unitOfWork, tipoServicoMultisoftware, configuracao);
                                            if (regraICMS.CST == "60")
                                                carregamentoRoterizacaoValoresFrete.ValorFrete.FreteProprio = carregamentoRoterizacaoValoresFrete.ValorFrete.ValorTotalAReceber;
                                            else if (regraICMS.Aliquota == 0)
                                                carregamentoRoterizacaoValoresFrete.ValorFrete.FreteProprio = carregamentoRoterizacaoValoresFrete.ValorFrete.ValorTotalAReceber;
                                            else
                                                carregamentoRoterizacaoValoresFrete.ValorFrete.FreteProprio = serRegraICMS.ObterValorLiquido(carregamentoRoterizacaoValoresFrete.ValorFrete.ValorTotalAReceber, regraICMS.Aliquota);
                                        }

                                    }

                                }
                                else if (cargaPedido.PossuiNFS || cargaPedido.PossuiNFSManual)
                                {
                                    if (repTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.CargoX) != null)
                                        carregamentoRoterizacaoValoresFrete.ValorFrete.FreteProprio = 0;
                                    else
                                        carregamentoRoterizacaoValoresFrete.ValorFrete.FreteProprio = carregamentoRoterizacaoValoresFrete.ValorFrete.ValorTotalAReceber;
                                }
                            }

                            cargaPedido.ValorFrete = carregamentoRoterizacaoValoresFrete.ValorFrete.FreteProprio;
                            cargaPedido.ValorFreteAPagar = carregamentoRoterizacaoValoresFrete.ValorFrete.ValorTotalAReceber;

                            if (carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS != null && cargaPedido.PossuiCTe)
                            {
                                cargaPedido.PercentualAliquota = carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS.Aliquota;
                                cargaPedido.IncluirICMSBaseCalculo = carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS.IncluirICMSBC;
                                cargaPedido.ImpostoInformadoPeloEmbarcador = true;
                                cargaPedido.ValorICMS = carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS.ValorICMS;
                                cargaPedido.BaseCalculoICMS = carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS.ValorBaseCalculoICMS;
                                cargaPedido.ObservacaoRegraICMSCTe = carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS.ObservacaoCTe;

                                bool incluirBC = cargaPedido.IncluirICMSBaseCalculo;
                                decimal percentualIncluirBaseCalculo = cargaPedido.PercentualIncluirBaseCalculo;

                                Dominio.Entidades.Empresa empresa = cargaPedido.Carga.Empresa;
                                Dominio.ObjetosDeValor.Embarcador.ICMS.RegraICMS regraICMS = serRegraICMS.BuscarRegraICMS(cargaPedido.Carga, cargaPedido, empresa, cargaPedido.Pedido.Remetente, cargaPedido.Pedido.Destinatario, cargaPedido.ObterTomador(), cargaPedido.Origem, cargaPedido.Destino, ref incluirBC, ref percentualIncluirBaseCalculo, cargaPedido.BaseCalculoICMS, null, unitOfWork, tipoServicoMultisoftware, configuracao);

                                carga.ValorICMS += cargaPedido.ValorICMS;

                                if (!string.IsNullOrWhiteSpace(regraICMS.ObservacaoCTe))
                                    cargaPedido.ObservacaoRegraICMSCTe += regraICMS.ObservacaoCTe;

                                if (!string.IsNullOrWhiteSpace(carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS.CST))
                                {
                                    cargaPedido.CST = carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS.CST;
                                    cargaPedido.PercentualIncluirBaseCalculo = carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS.PercentualInclusaoBC;
                                    cargaPedido.PercentualReducaoBC = carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS.PercentualReducaoBC;
                                }
                                else
                                {
                                    if (!string.IsNullOrWhiteSpace(regraICMS.CST))
                                    {
                                        cargaPedido.CST = regraICMS.CST;
                                        cargaPedido.PercentualIncluirBaseCalculo = regraICMS.PercentualInclusaoBC;
                                        cargaPedido.PercentualReducaoBC = regraICMS.PercentualReducaoBC;
                                    }
                                }

                                if (cargaPedido.ValorFreteAPagar == 0 && carregamentoRoterizacaoValoresFrete.ValorFrete.ValorPrestacaoServico > 0)
                                {
                                    if (regraICMS.DescontarICMSDoValorAReceber && cargaPedido.ValorICMS > 0)
                                        cargaPedido.ValorFreteAPagar = carregamentoRoterizacaoValoresFrete.ValorFrete.ValorPrestacaoServico - cargaPedido.ValorICMS;
                                    else
                                        cargaPedido.ValorFreteAPagar = carregamentoRoterizacaoValoresFrete.ValorFrete.ValorPrestacaoServico;

                                }

                                if (regraICMS.SimplesNacional || carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS.SimplesNacional)
                                    cargaPedido.CST = "";
                            }
                            else
                            {
                                cargaPedido.PercentualIncluirBaseCalculo = 100;
                                cargaPedido.IncluirICMSBaseCalculo = true;
                            }

                            if (carregamentoRoterizacaoValoresFrete.ValorFrete.ISS != null && cargaPedido.PossuiNFS)
                            {
                                cargaPedido.PercentualAliquotaISS = carregamentoRoterizacaoValoresFrete.ValorFrete.ISS.Aliquota;
                                cargaPedido.IncluirISSBaseCalculo = carregamentoRoterizacaoValoresFrete.ValorFrete.ISS.IncluirISSBaseCalculo;
                                cargaPedido.PercentualRetencaoISS = carregamentoRoterizacaoValoresFrete.ValorFrete.ISS.PercentualRetencao;
                                cargaPedido.ValorISS = carregamentoRoterizacaoValoresFrete.ValorFrete.ISS.ValorISS;
                                cargaPedido.BaseCalculoISS = carregamentoRoterizacaoValoresFrete.ValorFrete.ISS.ValorBaseCalculoISS;
                                cargaPedido.ImpostoInformadoPeloEmbarcador = true;
                                carga.ValorISS += cargaPedido.ValorISS;
                                carga.ValorRetencaoISS += cargaPedido.ValorRetencaoISS;
                            }

                            decimal valorFreteLiquido = 0;

                            if ((carregamentoRoterizacaoValoresFrete.ValorFrete.ICMS == null && cargaPedido.PossuiCTe) || (carregamentoRoterizacaoValoresFrete.ValorFrete.ISS == null && cargaPedido.PossuiNFS))
                            {
                                carga.ValorFrete += cargaPedido.ValorFrete;

                                if (cargaPedido.ValorFreteAPagar > 0)
                                    carga.ValorFreteAPagar += cargaPedido.ValorFreteAPagar;
                                else
                                    carga.ValorFreteAPagar += cargaPedido.ValorFrete;
                            }
                            else
                            {
                                carga.ValorFrete += cargaPedido.ValorFrete;
                                carga.ValorFreteAPagar += cargaPedido.ValorFreteAPagar;

                                if (cargaPedido.PossuiCTe)
                                    cargaPedido.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("57");
                                if (cargaPedido.PossuiNFS)
                                    cargaPedido.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("39");
                                if (cargaPedido.PossuiNFSManual)
                                    cargaPedido.ModeloDocumentoFiscal = null;

                                if (carga != null && carga.TipoOperacao != null && carga.TipoOperacao.UsarConfiguracaoEmissao && carga.TipoOperacao.ModeloDocumentoFiscal != null)
                                    cargaPedido.ModeloDocumentoFiscal = carga.TipoOperacao.ModeloDocumentoFiscal;
                            }

                            carga.ValorFreteLiquido = Math.Round(carga.ValorFrete + valorFreteLiquido, 2, MidpointRounding.AwayFromZero);
                            carga.TipoFreteEscolhido = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Embarcador;
                            serCarga.InformarSituacaoCargaFreteValido(ref carga, tipoServicoMultisoftware, unitOfWork);
                            repCarga.Atualizar(carga);
                        }
                        else
                        {
                            cargaPedido.PercentualIncluirBaseCalculo = 100;
                            cargaPedido.IncluirICMSBaseCalculo = true;
                        }
                    }

                }

                Dominio.Entidades.Embarcador.Cargas.Carga cargaOrigemPedido = cargaOrigemPedidos.FirstOrDefault(c => c.Pedidos.FirstOrDefault(p => p.Codigo == pedido.Codigo) != null);

                if (cargaOrigemPedido != null)
                    cargaPedido.CargaControleEntrega = cargaOrigemPedido;

                if ((carga?.Carregamento?.SessaoRoteirizador?.RoteirizacaoRedespacho ?? false) && (carga?.Carregamento?.SessaoRoteirizador?.Expedidor ?? null) != null)
                {
                    cargaPedido.Expedidor = carga.Carregamento.SessaoRoteirizador.Expedidor;
                    cargaPedido.Recebedor = null;
                }

                if (carga?.Carregamento?.Expedidor != null)
                    cargaPedido.Expedidor = carga?.Carregamento?.Expedidor;

                if (pedido.ReentregaSolicitada)
                {
                    cargaPedido.ReentregaSolicitada = true;
                    pedido.ReentregaSolicitada = false;
                    repPedido.Atualizar(pedido);
                }

                if (!string.IsNullOrEmpty(carga.ObservacaoTransportador) && !string.IsNullOrEmpty(pedido.Observacao))
                    pedido.Observacao = carga.ObservacaoTransportador;

                if (pedido.OrdemColetaProgramada > 0)
                {
                    cargaPedido.OrdemColeta = pedido.OrdemColetaProgramada;
                    carga.OrdemRoteirizacaoDefinida = true;
                }

                if (pedido.OrdemEntregaProgramada > 0)
                {
                    cargaPedido.OrdemEntrega = pedido.OrdemEntregaProgramada;
                    carga.OrdemRoteirizacaoDefinida = true;
                }

                if (carregamentoPedidos != null)
                {
                    int ordemEntrega = ((from obj in carregamentoPedidos where obj.Pedido.Codigo == pedido.Codigo select obj.Ordem)?.FirstOrDefault() ?? 0);
                    if (ordemEntrega > 0)
                        cargaPedido.OrdemEntrega = ordemEntrega;
                }
                else if (pedidosDevolucao)
                {
                    // Adicionando o pedido de devolução na mesma ordem do pedido principal.
                    if (pedido.PedidoDeDevolucao)
                    {
                        Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoPrincipal = repPedido.BuscarPedidoPrincipalPeloPedidoDevolucao(pedido.Codigo);
                        Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoPrincipal = repCargaPedido.BuscarPorCargaEPedido(carga.Codigo, pedidoPrincipal.Codigo);
                        if (cargaPedidoPrincipal != null)
                        {
                            cargaPedido.OrdemEntrega = cargaPedidoPrincipal.OrdemEntrega;
                            carga.OrdemRoteirizacaoDefinida = true;
                        }
                        else
                            cargaPedido.OrdemEntrega = (count - 1);
                    }
                }
                else if (setarOrdemEntrega)
                {
                    cargaPedido.OrdemEntrega = (count - 1);
                    carga.OrdemRoteirizacaoDefinida = true;
                }

                var anexos = pedidosAnexos.Where(p => p.EntidadeAnexo.Codigo == pedido.Codigo).ToList();
                if (anexos.Any()) VincularAnexosPedidoNaCargaAnexo(anexos, cargaPedido.Carga, unitOfWork, Auditado);

                string retornoDadosPedido = serCargaPedido.SetarDadosCargaPedido(ref cargaPedido, carga, pedido, tipoServicoMultisoftware, unitOfWork, configuracao, configuracaoGeralCarga, clientesDescarga, possuiRegraTomador, utilizarDistribuidorPorRegiaoNaRegiaoDestino);
                if (!string.IsNullOrWhiteSpace(retornoDadosPedido))
                    retorno = retornoDadosPedido;

                //metodo usado para gerar cargas filhos da Unilever, setamos o recebedor e exepedidor da stage do agrupamento
                if (stageParticipantes?.Recebedor != null && !configuracao.IncluirCargaCanceladaProcessarDT)
                {
                    cargaPedido.Recebedor = stageParticipantes?.Recebedor;
                    cargaPedido.Destino = stageParticipantes?.Recebedor?.Localidade;
                    cargaPedido.TipoEmissaoCTeParticipantes = cargaPedido.Expedidor != null ? TipoEmissaoCTeParticipantes.ComExpedidorERecebedor : TipoEmissaoCTeParticipantes.ComRecebedor;
                }

                //metodo usado para gerar cargas filhos da Unilever, setamos o recebedor e exepedidor da stage do agrupamento
                if (stageParticipantes?.Expedidor != null && !configuracao.IncluirCargaCanceladaProcessarDT)
                {
                    cargaPedido.Expedidor = stageParticipantes?.Expedidor;
                    cargaPedido.Origem = stageParticipantes?.Expedidor?.Localidade;
                    cargaPedido.TipoEmissaoCTeParticipantes = cargaPedido.Recebedor != null ? TipoEmissaoCTeParticipantes.ComExpedidorERecebedor : TipoEmissaoCTeParticipantes.ComExpedidor;
                }


                if ((from obj in notasPedidos where obj.Codigo == pedido.Codigo select obj).Count() > 0)//if (pedido.NotasFiscais != null && pedido.NotasFiscais.Count > 0)
                    cargaPedido.SituacaoEmissao = SituacaoNF.NFEnviada;

                repCargaPedido.Inserir(cargaPedido);

                //TODO: PPC - Adicionado log temporário para identificar problema no cargaPedido.Peso.
                //Servicos.Log.TratarErro($"Pedido {cargaPedido.Pedido.NumeroPedidoEmbarcador} - CargaPedido.Codigo = {cargaPedido.Codigo} - Criou carga pedido.: {cargaPedido.Peso}. Carga.CriarCargaPedidosPorPedidos", "PesoCargaPedido");

                serCargaPedido.SetarContaContabilPedido(cargaPedido, pedido, unitOfWork);

                if (notasPedidos.Count == 0 && !carga.CargaColeta && (cargaPedido.Carga.Carregamento == null || !cargaPedido.Carga.Carregamento.CarregamentoRedespacho))
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedido redespachoProximoTrecho = redespachosProximoTrecho.Where(x => x.Pedido.Codigo == pedido.Codigo).FirstOrDefault();
                    if (redespachoProximoTrecho != null)
                    {
                        redespachoProximoTrecho.CargaPedidoTrechoAnterior = cargaPedido;
                        cargaPedido.CargaPedidoProximoTrecho = redespachoProximoTrecho;

                        repCargaPedido.Atualizar(redespachoProximoTrecho);
                        repCargaPedido.Atualizar(cargaPedido);
                    }
                }

                //aqui vamos preencher o objeto de valor e depois criar o insert dos produtos da cargaPedido;
                serCargaPedido.AdicionarProdutosCargaParaProcessamentoPosterior(cargaPedido, listaPedidoProduto, configuracao.UsarPesoProdutoSumarizacaoCarga, unitOfWork, ObjetoMontagemCargaSqlPedidoProduto, montagemCargaPorPedidoProduto, produtosDoPedidoNoCarregamento);

                if ((tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS ||
                    tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador) && !carga.CargaRecebidaDeIntegracao)
                    serCargaPedido.BuscarConfiguracoesMultimodal(carga, unitOfWork, ref cargaPedido, integracaoIntercab, clientesBloquearEmissaoDosDestinatarios);


                if (pedido.ValorFreteNegociado > 0m || pedido.ValorFreteAReceber > 0m)
                {
                    List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoProduto> cargaPedidoProdutos = serRegraICMS.CriarProdutosCargaContidosEmRegras(cargaPedido, listaPedidoProduto, unitOfWork);
                    if (!pedido.ImpostoNegociado)
                    {
                        pedido.IncluirBaseCalculoICMS = true;
                        pedido.PercentualInclusaoBC = 100;
                    }

                    bool incluirBase = pedido.IncluirBaseCalculoICMS;
                    decimal percentualIncluir = pedido.PercentualInclusaoBC;

                    if (pedido.ValorFreteAReceber > 0m && pedido.ValorFreteNegociado == 0m && pedido.Destinatario != null)
                    {
                        if (cargaPedido.PossuiCTe)
                        {
                            decimal baseCalculo = pedido.ValorFreteAReceber;
                            bool incliur = false;
                            decimal percentual = 0;

                            Dominio.ObjetosDeValor.Embarcador.ICMS.RegraICMS regraICMSFreteLiquido = serRegraICMS.BuscarRegraICMS(cargaPedido.Carga, cargaPedido, cargaPedido.Carga.Empresa, cargaPedido.Pedido.Remetente, cargaPedido.Pedido?.Destinatario, cargaPedido.ObterTomador(), cargaPedido.Origem, cargaPedido.Destino, ref incliur, ref percentual, baseCalculo, cargaPedidoProdutos, unitOfWork, tipoServicoMultisoftware, configuracao, tabelaAliquotas, tomadoresFilialEmissora);

                            decimal aliquota = (regraICMSFreteLiquido.Aliquota / 100);

                            pedido.ValorFreteNegociado = Math.Round((pedido.ValorFreteAReceber * (1 - aliquota)), 2, MidpointRounding.AwayFromZero);
                            pedido.ValorFreteAReceber = 0m;
                        }
                        else if (cargaPedido.PossuiNFS || cargaPedido.PossuiNFSManual) // regra para Danone, não remover o ISS, rever isso pois o ISS tem uma regra diferente.
                            pedido.ValorFreteNegociado = pedido.ValorFreteAReceber;
                    }

                    if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS && pedido.ColetaEmProdutorRural)
                    {
                        Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xmlNotaFiscal = pedido.NotasFiscais.FirstOrDefault();

                        if (xmlNotaFiscal != null)
                        {
                            xmlNotaFiscal.ValorFrete = pedido.ValorFreteNegociado;

                            repXMLNotaFiscal.Atualizar(xmlNotaFiscal);
                        }
                    }

                    cargaPedido.ValorFreteAPagar = pedido.ValorFreteAReceber;
                    cargaPedido.ValorFrete = pedido.ValorFreteNegociado;

                    if (carga.TipoOperacao != null && carga.TipoOperacao.UsarConfiguracaoEmissao && carga.TipoOperacao.ModeloDocumentoFiscal != null)
                        cargaPedido.ModeloDocumentoFiscal = carga.TipoOperacao.ModeloDocumentoFiscal;

                    if (cargaPedido.Recebedor != null)
                    {
                        if (cargaPedido.Destino == null)
                            cargaPedido.Destino = cargaPedido.Recebedor.Localidade;
                    }

                    if (pedido.Destinatario != null)
                    {
                        if (cargaPedido.Destino == null)
                            cargaPedido.Destino = cargaPedido.Pedido.Destinatario?.Localidade;

                        Dominio.ObjetosDeValor.Embarcador.ICMS.RegraICMS regraICMS = serRegraICMS.BuscarRegraICMS(cargaPedido.Carga, cargaPedido, cargaPedido.Carga.Empresa, cargaPedido.Pedido.Remetente, cargaPedido.Pedido?.Destinatario, cargaPedido.ObterTomador(), cargaPedido.Origem, cargaPedido.Destino, ref incluirBase, ref percentualIncluir, cargaPedido.BaseCalculoICMS, cargaPedidoProdutos, unitOfWork, tipoServicoMultisoftware, configuracao, tabelaAliquotas, tomadoresFilialEmissora);

                        cargaPedido.CFOP = repCFOP.BuscarPorNumero(regraICMS.CFOP);
                        cargaPedido.CST = regraICMS.CST;
                        cargaPedido.ObservacaoRegraICMSCTe = regraICMS.ObservacaoCTe;
                        cargaPedido.SetarRegraICMS(regraICMS.CodigoRegra);
                    }

                    List<Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete> pedidosComponenteFrete = listaTodosPedidosComponenteFrete.Where(o => o.Pedido.Codigo == pedido.Codigo && !o.ComponenteFilialEmissora).ToList();
                    foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete pedidoComponenteFrete in pedidosComponenteFrete)
                    {
                        serComponenteFrete.AdicionarCargaPedidoComponente(cargaPedido, pedidoComponenteFrete.ValorComponente, pedidoComponenteFrete.Percentual, pedidoComponenteFrete.TipoValor,
                            pedidoComponenteFrete.TipoComponenteFrete, pedidoComponenteFrete.ComponenteFrete, pedidoComponenteFrete.IncluirBaseCalculoICMS, pedidoComponenteFrete.IncluirIntegralmenteContratoFreteTerceiro, pedidoComponenteFrete.ModeloDocumentoFiscal,
                            pedidoComponenteFrete.RateioFormula, pedidoComponenteFrete.OutraDescricaoCTe, pedidoComponenteFrete.DescontarValorTotalAReceber, pedidoComponenteFrete.AcrescentaValorTotalAReceber,
                            pedidoComponenteFrete.ComponenteFilialEmissora, unitOfWork, pedidoComponenteFrete.PorQuantidadeDocumentos, pedidoComponenteFrete.TipoCalculoQuantidadeDocumentos,
                            pedidoComponenteFrete.QuantidadeTotalDocumentos, pedidoComponenteFrete.ModeloDocumentoFiscalRateio, pedidoComponenteFrete.NaoSomarValorTotalAReceber, ref cargaPedidosComponentesCarga, pedidoComponenteFrete.NaoSomarValorTotalPrestacao, MoedaCotacaoBancoCentral.Real, 0m, 0m);
                    }

                    List<Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete> pedidosComponenteFreteFilialEmissora = listaTodosPedidosComponenteFrete.Where(o => o.Pedido.Codigo == pedido.Codigo && o.ComponenteFilialEmissora).ToList();
                    foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete pedidoComponenteFrete in pedidosComponenteFreteFilialEmissora)
                    {
                        serComponenteFrete.AdicionarCargaPedidoComponente(cargaPedido, pedidoComponenteFrete.ValorComponente, pedidoComponenteFrete.Percentual, pedidoComponenteFrete.TipoValor,
                            pedidoComponenteFrete.TipoComponenteFrete, pedidoComponenteFrete.ComponenteFrete, pedidoComponenteFrete.IncluirBaseCalculoICMS, pedidoComponenteFrete.IncluirIntegralmenteContratoFreteTerceiro, pedidoComponenteFrete.ModeloDocumentoFiscal,
                            pedidoComponenteFrete.RateioFormula, pedidoComponenteFrete.OutraDescricaoCTe, pedidoComponenteFrete.DescontarValorTotalAReceber, pedidoComponenteFrete.AcrescentaValorTotalAReceber,
                            pedidoComponenteFrete.ComponenteFilialEmissora, unitOfWork, pedidoComponenteFrete.PorQuantidadeDocumentos, pedidoComponenteFrete.TipoCalculoQuantidadeDocumentos,
                            pedidoComponenteFrete.QuantidadeTotalDocumentos, pedidoComponenteFrete.ModeloDocumentoFiscalRateio, pedidoComponenteFrete.NaoSomarValorTotalAReceber, ref cargaPedidosComponentesCarga, pedidoComponenteFrete.NaoSomarValorTotalPrestacao, MoedaCotacaoBancoCentral.Real, 0m, 0m);
                    }

                    if (pedido.ImpostoNegociado)
                    {
                        if (cargaPedido.PossuiNFS) //#6451 DPA - Emitir NFSe a partir da importação do PBR com os valores de impostos
                            cargaPedido.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorTipoDocumento(Dominio.Enumeradores.TipoDocumento.NFSe);

                        if (cargaPedido.PossuiNFS && cargaPedido.ModeloDocumentoFiscal != null && cargaPedido.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFSe)
                        {
                            cargaPedido.PercentualAliquotaISS = pedido.PercentualAliquota;
                            cargaPedido.BaseCalculoISS = pedido.BaseCalculoICMS;
                            cargaPedido.ValorISS = pedido.ValorICMS;
                            cargaPedido.PercentualIncluirBaseCalculo = percentualIncluir;
                            cargaPedido.IncluirISSBaseCalculo = pedido.IncluirBaseCalculoICMS;
                            cargaPedido.ImpostoInformadoPeloEmbarcador = true;
                            cargaPedido.ValorFrete = pedido.BaseCalculoICMS;
                        }
                        else
                        {
                            cargaPedido.PercentualAliquota = pedido.PercentualAliquota;
                            cargaPedido.BaseCalculoICMS = pedido.BaseCalculoICMS;
                            cargaPedido.ValorICMS = pedido.ValorICMS;
                            cargaPedido.PercentualIncluirBaseCalculo = percentualIncluir;
                            cargaPedido.IncluirICMSBaseCalculo = pedido.IncluirBaseCalculoICMS;
                            cargaPedido.ImpostoInformadoPeloEmbarcador = true;

                            Servicos.Log.TratarErro($"1 - CargaPedido: {cargaPedido.Codigo} -> Aliquota: {cargaPedido.PercentualAliquota}", "ProcessarAliquota");
                        }
                    }
                    else
                    {
                        cargaPedido.IncluirICMSBaseCalculo = true;
                        cargaPedido.PercentualIncluirBaseCalculo = 100;

                        if (pedido.Destinatario != null)
                            serRateioFrete.CalcularImpostos(ref carga, carga, cargaPedido, cargaPedido.ValorFrete, false, tipoServicoMultisoftware, unitOfWork, configuracao, cargaPedidosComponentesCarga, pedagioEstadosBaseCalculo, cargaPedidoProdutos, tabelaAliquotas, tomadoresFilialEmissora, configuracaoGeralCarga);
                    }

                    cargaPedido.ValorFreteFilialEmissora = pedido.ValorFreteFilialEmissora;

                    serCargaPedido.VerificarFilialEmissaoCargaPedido(cargaPedido, configuracaoGeralCarga);
                    if (cargaPedido.CargaPedidoFilialEmissora)
                    {
                        Dominio.Entidades.Embarcador.Filiais.EstadoDestinoEmpresaEmissora estadoDestino = estadosDestinoEmpresaEmissora.Find(e => e.Estado.Codigo == cargaPedido.Destino?.Estado.Codigo);

                        if (carga.EmpresaFilialEmissora == null)
                        {

                            if ((estadosDestinoEmpresaEmissora.Count > 0) && estadoDestino != null)
                                carga.EmpresaFilialEmissora = estadoDestino.Empresa;
                            else
                                carga.EmpresaFilialEmissora = carga.Filial.EmpresaEmissora;
                        }

                        if ((estadosDestinoEmpresaEmissora.Count > 0) && estadoDestino != null)
                            carga.EmiteMDFeFilialEmissora = carga.Filial.EmiteMDFeFilialEmissoraPorEstadoDestino;
                        else
                            carga.EmiteMDFeFilialEmissora = carga.Filial.EmiteMDFeFilialEmissora;

                        if (carga.Filial?.UtilizarCtesAnterioresComoCteFilialEmissora ?? false)
                            carga.UtilizarCTesAnterioresComoCTeFilialEmissora = true;

                        cargaPedido.IncluirICMSBaseCalculoFilialEmissora = cargaPedido.IncluirICMSBaseCalculo;
                        serRateioFrete.CalcularImpostos(ref carga, carga, cargaPedido, cargaPedido.ValorFreteFilialEmissora, true, tipoServicoMultisoftware, unitOfWork, configuracao, cargaPedidosComponentesCarga, pedagioEstadosBaseCalculo, cargaPedidoProdutos, tabelaAliquotas, tomadoresFilialEmissora, configuracaoGeralCarga);
                    }

                    repCargaPedido.Atualizar(cargaPedido);
                }
                else
                {
                    Servicos.Embarcador.Carga.Carga.CalcularValorDescargaPorCargaPedido(cargaPedido, configuracao, unitOfWork);

                    serCargaPedido.VerificarFilialEmissaoCargaPedido(cargaPedido, configuracaoGeralCarga);
                    if (cargaPedido.CargaPedidoFilialEmissora)
                    {
                        Dominio.Entidades.Embarcador.Filiais.EstadoDestinoEmpresaEmissora estadoDestino = estadosDestinoEmpresaEmissora.Find(e => e.Estado.Codigo == cargaPedido.Destino?.Estado.Codigo);
                        if (carga.EmpresaFilialEmissora == null)
                        {

                            if ((estadosDestinoEmpresaEmissora.Count > 0) && estadoDestino != null)
                                carga.EmpresaFilialEmissora = estadoDestino.Empresa;
                            else
                                carga.EmpresaFilialEmissora = carga.Filial.EmpresaEmissora;
                        }

                        if ((estadosDestinoEmpresaEmissora.Count > 0) && estadoDestino != null)
                            carga.EmiteMDFeFilialEmissora = carga.Filial.EmiteMDFeFilialEmissoraPorEstadoDestino;
                        else
                            carga.EmiteMDFeFilialEmissora = carga.Filial.EmiteMDFeFilialEmissora;

                        if (carga.Filial?.UtilizarCtesAnterioresComoCteFilialEmissora ?? false)
                            carga.UtilizarCTesAnterioresComoCTeFilialEmissora = true;
                    }

                    repCargaPedido.Atualizar(cargaPedido);
                }

                if ((utilizarOutroEnderecoPedidoMesmoSePossuirRecebedor))
                {
                    if ((pedido?.Recebedor?.CPF_CNPJ ?? 0) > 0)
                    {
                        Repositorio.Embarcador.Pessoas.ClienteOutroEndereco repClienteOutroEndereco = new Repositorio.Embarcador.Pessoas.ClienteOutroEndereco(unitOfWork);
                        Dominio.Entidades.Embarcador.Pessoas.ClienteOutroEndereco endereco = repClienteOutroEndereco.BuscarPorPessoa(pedido.Recebedor.CPF_CNPJ).FirstOrDefault();

                        if (endereco != null)
                        {
                            cargaPedido.Destino = endereco.Localidade;
                            repCargaPedido.Atualizar(cargaPedido);
                        }
                    }
                }

                //Servicos.Log.TratarErro("Montagem Carga", "VincularNotasFiscaisDosPedido");

                VincularNotasFiscaisDosPedido(cargaPedido, notasUtilizadas, xMLNotaFiscals, notasPedidos, listaCarregamentoPedidoNotaFiscal, listaNotasJaEnviadasDosPedidos, tipoServicoMultisoftware, unitOfWork, Auditado, configuracaoTMS);

                if (notasPedidos.Count <= 0)
                {
                    VincularCtesParciaisDosPedido(cargaPedido, tipoServicoMultisoftware, unitOfWork, ctesParciais);

                    if (!cargaPedido.Carga.CargaColeta)
                        VincularNotasParciaisDosPedido(cargaPedido, tipoServicoMultisoftware, unitOfWork, Auditado, configuracao, notasParciais);

                    VincularCTeTerceiroDosPedido(cargaPedido, tipoServicoMultisoftware, unitOfWork);
                }
                else
                {
                    decimal peso = 0m;
                    decimal pesoLiquido = 0m;
                    serCargaPedido.AdicionarCargaPedidoQuantidades(cargaPedido, xMLNotaFiscals, notasPedidos, tipoServicoMultisoftware, configuracao, ref peso, ref pesoLiquido, configuracao.NaoAtualizarPesoPedidoPelaNFe, unitOfWork, null, cargaPedidoQuantidades);
                }

                if (!cargaPedido.PedidoSemNFe && apolicesSeguro?.Count > 0)
                {
                    foreach (Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro apoliceSeguro in apolicesSeguro)
                    {
                        Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao apoliceSeguroAverbacao = new Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao
                        {
                            CargaPedido = cargaPedido,
                            ApoliceSeguro = apoliceSeguro
                        };

                        repApoliceSeguroAverbacao.Inserir(apoliceSeguroAverbacao);
                    }
                }

                if (configuracao.UtilizarIntegracaoPedido)
                    pedido.PedidoIntegradoEmbarcador = false;

                List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> notasFiscaisEnviadasDoPedido = listaTotalNotasJaEnviadas.Where(obj => obj.CarregamentoPedido.Pedido.Codigo == pedido.Codigo).ToList();
                List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> notasEnviadasDoPedido = listaCarregamentoPedidoNotaFiscal.Where(obj => obj.CarregamentoPedido.Pedido.Codigo == pedido.Codigo).ToList();
                int notasEnviadas = 0;
                foreach (Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal notaEnviadasDoPedido in notasFiscaisEnviadasDoPedido)
                    notasEnviadas += notaEnviadasDoPedido.NotasFiscais.Count();

                if (notasEnviadasDoPedido.Count > 0 && notasFiscaisEnviadasDoPedido.Count > 0 && notasEnviadas < pedido.NotasFiscais.Count)
                {
                    if (configuracaoMontagemCarga.TipoControleSaldoPedido == TipoControleSaldoPedido.Pallet)
                    {
                        decimal palletConsiderar = palletTotalPedidoCarga;
                        if (configuracaoMontagemCarga.ConsiderarPesoNFSaldoPedido)
                        {
                            palletConsiderar = 0;
                            foreach (Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal carregamentoPedidoNotaFiscal in notasEnviadasDoPedido)
                                palletConsiderar += carregamentoPedidoNotaFiscal.NotasFiscais.Sum(x => x.QuantidadePallets);
                        }
                        pedido.PalletSaldoRestante -= palletConsiderar;
                        pedido.PedidoTotalmenteCarregado = (pedido.PalletSaldoRestante <= 0.01m);
                    }
                    else
                    {
                        decimal pesoConsiderar = pesoTotalPedidoCarga;
                        if (configuracaoMontagemCarga.ConsiderarPesoNFSaldoPedido)
                        {
                            pesoConsiderar = 0;
                            foreach (Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal carregamentoPedidoNotaFiscal in notasEnviadasDoPedido)
                                pesoConsiderar += carregamentoPedidoNotaFiscal.NotasFiscais.Sum(x => x.Peso);
                        }
                        pedido.PesoSaldoRestante -= pesoConsiderar;
                        pedido.PedidoTotalmenteCarregado = (pedido.PesoSaldoRestante <= 0);
                        //TODO: PPC - Adicionado log temporário para identificar problema de retorno de saldo de pedido.
                        //Servicos.Log.TratarErro($"Pedido {pedido.NumeroPedidoEmbarcador} - Atualizou saldo pedido {pedido.PesoSaldoRestante} - Peso Total.: {pedido.PesoTotal} - Totalmente carregado.: {pedido.PedidoTotalmenteCarregado} - CargaPedido.Codigo.: {cargaPedido.Codigo}. 1 - Carga.CriarCargaPedidosPorPedidos", "SaldoPedido");
                    }
                }
                else if (carga.Carregamento != null && montagemCargaPorPedidoProduto)
                {
                    List<Dominio.ObjetosDeValor.Embarcador.Carga.MontagemCarga.SaldoPedidoProduto> produtosPedidoNaoAtendido = produtosPedidosNaoAtendido.Where(o => o.CodigoPedido == pedido.Codigo).ToList();
                    pedido.PesoSaldoRestante -= pesoTotalPedidoCarga;
                    pedido.SaldoVolumesRestante -= (int)volumesCarregados;

                    if (produtosPedidoNaoAtendido?.Count > 0)
                        pedido.PedidoTotalmenteCarregado = false;
                    else
                        pedido.PedidoTotalmenteCarregado = (pedido.PesoSaldoRestante <= 0.5m && pedido.SaldoVolumesRestante <= 0) || todosProdutosPedidoNestaCarga;
                    //TODO: PPC - Adicionado log temporário para identificar problema de retorno de saldo de pedido.
                    //Servicos.Log.TratarErro($"Pedido {pedido.NumeroPedidoEmbarcador} - Atualizou saldo pedido {pedido.PesoSaldoRestante} - Peso Total.: {pedido.PesoTotal} - Totalmente carregado.: {pedido.PedidoTotalmenteCarregado}. 2 - Carga.CriarCargaPedidosPorPedidos", "SaldoPedido");
                }
                else if (carga.Carregamento != null && !montagemCargaPorPedidoProduto)
                {
                    //Boticario
                    if (!(carga.Carregamento?.TipoOperacao?.AgendamentoGeraApenasPedido ?? false))
                    {
                        if (carga.Carregamento.CarregamentoRedespacho || (carga.Carregamento?.SessaoRoteirizador?.RoteirizacaoRedespacho ?? false))
                        {
                            pedido.PedidoRedespachoTotalmenteCarregado = true;
                            pedido.PedidoTotalmenteCarregado = true;
                            Servicos.Log.TratarErro($"Pedido {pedido.NumeroPedidoEmbarcador} - Atualizou redespacho e pedido totalmente carregado - Peso Total.: {pedido.PesoTotal}. 3.0 - Carga.CriarCargaPedidosPorPedidos", "SaldoPedido");
                        }
                        else
                        {
                            if (configuracaoMontagemCarga.TipoControleSaldoPedido == TipoControleSaldoPedido.Pallet)
                            {
                                pedido.PalletSaldoRestante -= palletTotalPedidoCarga;
                                pedido.PedidoTotalmenteCarregado = (pedido.PalletSaldoRestante <= 0.1m);
                            }
                            else
                            {
                                pedido.PesoSaldoRestante -= pesoTotalPedidoCarga;
                                pedido.PedidoTotalmenteCarregado = (pedido.PesoSaldoRestante <= 0.5m);
                            }
                        }
                        //TODO: PPC - Adicionado log temporário para identificar problema de retorno de saldo de pedido.
                        //Servicos.Log.TratarErro($"Pedido {pedido.NumeroPedidoEmbarcador} - Atualizou saldo pedido {pedido.PesoSaldoRestante} - Peso Total.: {pedido.PesoTotal} - Totalmente carregado.: {pedido.PedidoTotalmenteCarregado}. 3 - Carga.CriarCargaPedidosPorPedidos", "SaldoPedido");
                    }
                    else
                        Servicos.Log.TratarErro($"Pedido {pedido.NumeroPedidoEmbarcador} - Não atualizou saldo pedido {pedido.PesoSaldoRestante} - Peso Total.: {pedido.PesoTotal} - Totalmente carregado.: {pedido.PedidoTotalmenteCarregado}. 3.1 - Carga.CriarCargaPedidosPorPedidos", "SaldoPedido");
                }
                else if (carga.Carregamento == null || !carga.Carregamento.CarregamentoRedespacho)
                {
                    //#56420-DANONE, carga que não é carga.. que não vai para a rua... não permitindo gerar uma carga de redespacho.
                    if ((pedido?.TipoOperacao?.NaoExigeVeiculoParaEmissao ?? true) == false)
                    {
                        if (configuracao.ControlarAgendamentoSKU)
                            pedido.PedidoTotalmenteCarregado = pedido.SaldoVolumesRestante <= 0;
                        else
                            pedido.PedidoTotalmenteCarregado = true;
                        //TODO: PPC - Adicionado log temporário para identificar problema de retorno de saldo de pedido.
                        //Servicos.Log.TratarErro($"Pedido {pedido.NumeroPedidoEmbarcador} - Atualizou saldo pedido {pedido.PesoSaldoRestante} - Peso Total.: {pedido.PesoTotal} - Totalmente carregado.: {pedido.PedidoTotalmenteCarregado}. 4 - Carga.CriarCargaPedidosPorPedidos", "SaldoPedido");
                    }
                }
                else
                    pedido.PedidoRedespachoTotalmenteCarregado = true;

                pedido.CodigoCargaEmbarcador = carga.CodigoCargaEmbarcador;

                if (pedido.Destinatario != null)
                {
                    //List<Dominio.Entidades.Embarcador.Pedidos.Pedido> recolhimentos = recolhimentosDestinatarios.Where(o => o.Destinatario.CPF_CNPJ == pedido.Destinatario.CPF_CNPJ).ToList();
                    List<Dominio.ObjetosDeValor.Embarcador.Pedido.PedidoRecolhimentoDestinatario> recolhimentos = recolhimentosDestinatarios.Where(o => o.CPF_CNPJ == pedido.Destinatario.CPF_CNPJ).ToList();

                    for (int i = 0, s = recolhimentos.Count; i < s; i++)
                    {
                        Dominio.Entidades.Embarcador.Pedidos.PedidoRecolhimentoTroca pedidoRecolhimento = new Dominio.Entidades.Embarcador.Pedidos.PedidoRecolhimentoTroca()
                        {
                            Pedido = pedido,
                            RecolhimentoTroca = new Dominio.Entidades.Embarcador.Pedidos.Pedido() { Codigo = recolhimentos[i].Codigo }
                        };

                        repPedidoRecolhimentoTroca.Inserir(pedidoRecolhimento);
                    }
                }

                if (carga.DataPrevisaoTerminoCarga.HasValue)
                    pedido.PrevisaoEntrega = carga.DataPrevisaoTerminoCarga;

                pedido.PedidoDePreCarga = carga.CargaDePreCarga;

                repPedido.Atualizar(pedido);
                repCargaPedido.Atualizar(cargaPedido);
                cargaPedidos.Add(cargaPedido);
            }

            //Rodar os inserts dos produtos preenchidos acima;
            if (ObjetoMontagemCargaSqlPedidoProduto.ListaObjetosPedidoProduto.Count > 0)
            {
                Repositorio.Embarcador.Cargas.CargaPedidoProduto repCargaPedidoProduto = new Repositorio.Embarcador.Cargas.CargaPedidoProduto(unitOfWork);
                repCargaPedidoProduto.InsertSQL(ObjetoMontagemCargaSqlPedidoProduto);
            }

            if (xMLNotaFiscals.Count > 0)
            {
                Servicos.Embarcador.Canhotos.Canhoto serCanhoto = new Canhotos.Canhoto(unitOfWork);

                List<Dominio.Entidades.Usuario> motoristas = carga.Motoristas != null ? carga.Motoristas.ToList() : repCargaMotorista.BuscarMotoristasPorCarga(carga.Codigo);
                Repositorio.Embarcador.Configuracoes.ConfiguracaoCanhoto repConfiguracaoCanhoto = new Repositorio.Embarcador.Configuracoes.ConfiguracaoCanhoto(unitOfWork);
                Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoCanhoto configuracaoCanhoto = repConfiguracaoCanhoto.BuscarConfiguracaoPadrao();

                foreach (Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xmlNotaFiscal in xMLNotaFiscals)
                {
                    int primeiroPedido = (from obj in notasPedidos where obj.Total == xmlNotaFiscal.Codigo select obj.Codigo).FirstOrDefault();
                    Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido = (from obj in cargaPedidos where obj.Pedido.Codigo == primeiroPedido select obj).FirstOrDefault();
                    if (cargaPedido != null)
                        serCanhoto.SalvarCanhotoNota(xmlNotaFiscal, cargaPedido, carga.FreteDeTerceiro ? carga.Veiculo.Proprietario : null, motoristas, tipoServicoMultisoftware, configuracao, unitOfWork, configuracaoCanhoto);
                }
            }

            serComponenteFrete.AdicionarComponentesCargaAgrupada(carga, false, cargaPedidosComponentesCarga, unitOfWork);

            serRateioFrete.AcrescentarValoresDaCargaAgrupada(carga, false, cargaPedidos, unitOfWork);

            if (possuiFilialEmissora)
            {
                serComponenteFrete.AdicionarComponentesCargaAgrupada(carga, true, cargaPedidosComponentesCarga, unitOfWork);
                serRateioFrete.AcrescentarValoresDaCargaAgrupada(carga, true, cargaPedidos, unitOfWork);
            }

            CargaFronteira serCargaFronteira = new Servicos.Embarcador.Carga.CargaFronteira(unitOfWork);

            if (!configuracao.UtilizaEmissaoMultimodal && !serCargaFronteira.TemFronteira(carga) && (listaFronteirasPedido.Count > 0))
            {
                Repositorio.Embarcador.Cargas.CargaFronteira repCargaFronteira = new Repositorio.Embarcador.Cargas.CargaFronteira(unitOfWork);

                foreach (Dominio.Entidades.Cliente itemFronteira in listaFronteirasPedido)
                {
                    repCargaFronteira.Inserir(new Dominio.Entidades.Embarcador.Cargas.CargaFronteira
                    {
                        Carga = carga,
                        Fronteira = itemFronteira
                    });
                }
            }

            if (dataInicialPrevisaoCarregamento != DateTime.MinValue)
                carga.DataInicialPrevisaoCarregamento = dataInicialPrevisaoCarregamento;

            if (dataFinalPrevisaoCarregamento != DateTime.MinValue)
                carga.DataFinalPrevisaoCarregamento = dataFinalPrevisaoCarregamento;

            if (dataCarregamento != DateTime.MinValue && !configuracaoGeralCarga.UtilizarDataCarregamentoAoCriarCargaViaIntegracao)
                carga.DataCarregamentoCarga = dataCarregamento;

            if (pedidosDevolucao && setarOrdemEntrega)
            {
                cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo);// SE JA EXISTE PQ?
                cargaPedidos = cargaPedidos.OrderBy(x => x.OrdemEntrega).ToList();
                for (int i = 0; i < cargaPedidos.Count; i++)
                {
                    cargaPedidos[i].OrdemEntrega = (i + 1);
                    repCargaPedido.Atualizar(cargaPedidos[i]);
                }
            }

            if (carga.OrdemRoteirizacaoDefinida && !cargaPedidos.Exists(obj => obj.OrdemEntrega > 0))
            {
                int ordemEntrega = (from obj in cargaPedidos select obj.OrdemColeta).Max();
                if (ordemEntrega > 0)
                {
                    List<(double CNPJ, int CodigoDestino)> destinatarios = (from obj in cargaPedidos where obj.Recebedor != null select (obj.Recebedor.CPF_CNPJ, obj.Destino.Codigo)).Distinct().ToList();
                    destinatarios.AddRange((from obj in cargaPedidos where obj.Recebedor == null && obj.Pedido.Destinatario != null select (obj.Pedido.Destinatario.CPF_CNPJ, obj.Destino.Codigo)).Distinct().ToList());
                    foreach ((double CNPJ, int CodigoDestino) destinatario in destinatarios)
                    {
                        ordemEntrega++;
                        repCargaPedido.SetarOrdemEntregaPorEndereco(carga.Codigo, ordemEntrega, destinatario.CNPJ, destinatario.CodigoDestino);
                    }
                }
            }

            new Servicos.Embarcador.Carga.RateioFormula().SubstituirFormulaDeRateio(carga, cargaPedidos, unitOfWork);

            repCarga.Atualizar(carga);

            return retorno;
        }

        public async Task<List<Dominio.Entidades.Embarcador.Cargas.CargaPedido>> CriarCargaPedidosPorPedidosAsync(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro> apolicesSeguro, Repositorio.UnitOfWork unitOfWork, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado = null, bool montagemCargaPorPedidoProduto = false, NumeroReboque numeroReboque = NumeroReboque.SemReboque, TipoCarregamentoPedido tipoCarregamentoPedido = TipoCarregamentoPedido.Normal, List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedido> carregamentoPedidos = null, bool pedidosDevolucao = false, List<Dominio.Entidades.Embarcador.Pedidos.PedidoStage> pedidosStage = null)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork, _cancellationToken);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoQuantidades repCargaPedidoQuantidade = new Repositorio.Embarcador.Cargas.CargaPedidoQuantidades(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoProduto repPedidoProduto = new Repositorio.Embarcador.Pedidos.PedidoProduto(unitOfWork, _cancellationToken);
            Repositorio.Embarcador.Pedidos.PedidoComponenteFrete repPedidoComponenteFrete = new Repositorio.Embarcador.Pedidos.PedidoComponenteFrete(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork, _cancellationToken);
            Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repApoliceSeguroAverbacao = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new ModeloDocumentoFiscal(unitOfWork, _cancellationToken);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unitOfWork, _cancellationToken);
            Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoProduto repCarregamentoPedidoProduto = new Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoProduto(unitOfWork, _cancellationToken);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork, _cancellationToken);
            Repositorio.Embarcador.Pedidos.PedidoRecolhimentoTroca repPedidoRecolhimentoTroca = new Repositorio.Embarcador.Pedidos.PedidoRecolhimentoTroca(unitOfWork);
            Repositorio.CFOP repCFOP = new CFOP(unitOfWork);
            Repositorio.Embarcador.ICMS.PedagioEstadoBaseCalculo repPedagioEstadoBaseCalculo = new Repositorio.Embarcador.ICMS.PedagioEstadoBaseCalculo(unitOfWork);
            Repositorio.Embarcador.Pessoas.ClienteDescarga repClienteDescarga = new Repositorio.Embarcador.Pessoas.ClienteDescarga(unitOfWork, _cancellationToken);
            Repositorio.Embarcador.Pedidos.RegraTomador repRegraTomador = new Repositorio.Embarcador.Pedidos.RegraTomador(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCTeParcial repositorioPedidoCTeParcial = new Repositorio.Embarcador.Pedidos.PedidoCTeParcial(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoNotaParcial repPedidoNotaParcial = new Repositorio.Embarcador.Pedidos.PedidoNotaParcial(unitOfWork);
            Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal repositorioCarregamentoPedidoNotaFiscal = new Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal(unitOfWork, _cancellationToken);
            Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoPedido repCarregamentoPedido = new Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoPedido(unitOfWork, _cancellationToken);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork, _cancellationToken);
            Repositorio.Embarcador.Pedidos.RegraTomador repositorioRegraTomador = new Repositorio.Embarcador.Pedidos.RegraTomador(unitOfWork);
            Repositorio.Embarcador.Filiais.Filial repositorioFilial = new Repositorio.Embarcador.Filiais.Filial(unitOfWork, _cancellationToken);
            Repositorio.Embarcador.Pedidos.PedidoAdicional repositorioPedidoAdicional = new Repositorio.Embarcador.Pedidos.PedidoAdicional(unitOfWork, _cancellationToken);

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoPedido configuracaoPedido = await new Repositorio.Embarcador.Configuracoes.ConfiguracaoPedido(unitOfWork, _cancellationToken).BuscarPrimeiroRegistroAsync();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoMontagemCarga configuracaoMontagemCarga = await new Repositorio.Embarcador.Configuracoes.ConfiguracaoMontagemCarga(unitOfWork).BuscarPrimeiroRegistroAsync();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga = await new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork).BuscarPrimeiroRegistroAsync();

            Servicos.Embarcador.Carga.CargaPedido serCargaPedido = new Servicos.Embarcador.Carga.CargaPedido(unitOfWork);
            Servicos.Embarcador.Carga.ICMS serRegraICMS = new Embarcador.Carga.ICMS(unitOfWork);
            Servicos.Embarcador.Carga.ComponetesFrete serComponenteFrete = new ComponetesFrete(unitOfWork);
            Servicos.Embarcador.Carga.RateioFrete serRateioFrete = new RateioFrete(unitOfWork);

            DateTime? dataPrevistaChegadaCliente = null;

            pedidos.ForEach(x => x.Initialize());

            if (configuracaoMontagemCarga.UtilizarDataPrevisaoSaidaVeiculo)
            {
                dataPrevistaChegadaCliente = carga.Carregamento?.DataInicioViagemPrevista ?? carga.Carregamento?.DataCarregamentoCarga;

                if (dataPrevistaChegadaCliente.HasValue)
                {
                    Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacao repositorioCarregamentoRoteirizacao = new Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacao(unitOfWork);
                    Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacao carregamentoRoteirizacao = await repositorioCarregamentoRoteirizacao.BuscarPorCarregamentoAsync(carga.Carregamento?.Codigo ?? 0);

                    if (carregamentoRoteirizacao != null)
                        dataPrevistaChegadaCliente = dataPrevistaChegadaCliente.Value.AddMinutes(carregamentoRoteirizacao.TempoDeViagemEmMinutos);
                }
            }

            if (carga.TipoOperacao?.ManterOrdemAoRoteirizarAgendaEntrega ?? false)
                pedidos = pedidos.OrderBy(x => x.PrevisaoEntrega).ToList();

            List<int> codigosPedidos = pedidos.Select(o => o.Codigo).ToList();

            Dominio.Entidades.Cliente fronteira = null;

            List<Dominio.Entidades.Embarcador.ICMS.PedagioEstadoBaseCalculo> pedagioEstadosBaseCalculo = await repPedagioEstadoBaseCalculo.BuscarPorEstadosAsync(pedidos.Select(o => o.Origem.Estado.Sigla).Distinct().ToList());
            List<Dominio.ObjetosDeValor.Embarcador.ICMS.TabelaAliquota> tabelaAliquotas = new List<Dominio.ObjetosDeValor.Embarcador.ICMS.TabelaAliquota>();
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete> cargaPedidosComponentesCarga = new List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete>();

            List<Dominio.Entidades.Cliente> tomadoresFilialEmissora = new List<Dominio.Entidades.Cliente>();

            if (carga.EmpresaFilialEmissora != null)
            {
                double.TryParse(carga.EmpresaFilialEmissora.CNPJ_SemFormato, out double cnpjTomadorFilialEmissora);

                tomadoresFilialEmissora.Add(await repCliente.BuscarPorCPFCNPJAsync(cnpjTomadorFilialEmissora));
            }

            int codigoCarregamento = carga.Carregamento?.Codigo ?? 0;

            //listas que sao usadas dentro do for
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoNotaParcial> notasParciais = await repPedidoNotaParcial.BuscarPorPedidosAsync(codigosPedidos);
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParcial> ctesParciais = await repositorioPedidoCTeParcial.BuscarPorPedidosAsync(codigosPedidos);
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoProduto> listaTodosPedidoProduto = await repPedidoProduto.BuscarPorPedidosAsync(codigosPedidos);
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete> listaTodosPedidosComponenteFrete = await repPedidoComponenteFrete.BuscarPorPedidosAsync(codigosPedidos);
            List<Dominio.ObjetosDeValor.Embarcador.Carga.TotalizadorModeloDocumento> notasPedidos = await repPedido.BuscarNotasPorPedidosAsync(codigosPedidos);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> redespachosProximoTrecho = await repCargaPedido.BuscarCargaPedidosProximoTrechoAsync(codigosPedidos);
            List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaOrigemPedidos> cargaOrigemPedidos = await repCargaPedido.BuscarCargaComComTipoOperacaoDisponivelParaCarrementoDiferenteDaAtualAsync(codigosPedidos, carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoQuantidades> cargaPedidoQuantidades = await repCargaPedidoQuantidade.BuscarPorCargaPedidosQuantidadesAsync(codigosPedidos);
            List<Dominio.ObjetosDeValor.Embarcador.Carga.DadosCrtMicPedido> dadosCrtMicPedido = await repositorioPedidoAdicional.BuscarDadosCrtMicPorPedidosAsync(codigosPedidos);

            List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoProduto> listaTodosPedidoProdutoCarregamento = new List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoProduto>();
            List<Dominio.ObjetosDeValor.Embarcador.Carga.MontagemCarga.SaldoPedidoProduto> produtosPedidosNaoAtendido = new List<Dominio.ObjetosDeValor.Embarcador.Carga.MontagemCarga.SaldoPedidoProduto>();

            if (montagemCargaPorPedidoProduto && codigoCarregamento > 0)
            {
                listaTodosPedidoProdutoCarregamento = await repCarregamentoPedidoProduto.BuscarPorCarregamentoEPedidoProdutosAsync(codigoCarregamento, codigosPedidos);

                List<Dominio.ObjetosDeValor.Embarcador.Carga.MontagemCarga.SaldoPedidoProduto> produtos = new Servicos.Embarcador.Carga.MontagemCarga.SaldoPedidoProduto().ObterSaldoPedidoProdutosComSaldo(listaTodosPedidoProdutoCarregamento);

                produtosPedidosNaoAtendido = (from prod in produtos where prod.SaldoQtde > 0 select prod).ToList();
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = new List<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            bool possuiFilialEmissora = false;

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosPreCarga = new List<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
            if (carga.CargaPreCarga != null && !string.IsNullOrEmpty(carga.CargaPreCarga.NumeroCargaVincularPreCarga))
                cargaPedidosPreCarga = await repCargaPedido.BuscarPorCargaAsync(carga.CargaPreCarga.Codigo);

            List<double> cnpjDestinatarios = (from ped in pedidos where ped.Destinatario != null select ped.Destinatario.CPF_CNPJ).Distinct().ToList();

            List<Dominio.ObjetosDeValor.Embarcador.Pedido.PedidoRecolhimentoDestinatario> recolhimentosDestinatarios = new List<Dominio.ObjetosDeValor.Embarcador.Pedido.PedidoRecolhimentoDestinatario>();
            if (cnpjDestinatarios?.Count > 0)
                recolhimentosDestinatarios = await repPedido.BuscarPedidoParaRecolhimentoAsync(cnpjDestinatarios);

            List<int> notas = notasPedidos.Select(obj => obj.Total).ToList();

            List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> listaCarregamentoPedidoNotaFiscal = await repositorioCarregamentoPedidoNotaFiscal.BuscarPorCarregamentoAsync(codigoCarregamento);

            List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> xMLNotaFiscals = notas.Any() ? await repXMLNotaFiscal.BuscarPorCodigosAsync(notasPedidos.Select(obj => obj.Total).Distinct().ToList()) : new List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal>();

            List<Dominio.Entidades.Embarcador.Pessoas.ClienteDescarga> clientesDescarga = cnpjDestinatarios.Any() ? await repClienteDescarga.BuscarPorPessoasAsync(cnpjDestinatarios) : new List<Dominio.Entidades.Embarcador.Pessoas.ClienteDescarga>();

            bool possuiRegraTomador = await repRegraTomador.PossuiRegrasAsync();

            List<int> notasUtilizadas = new List<int>();

            int count = 1;

            List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> listaNotasJaEnviadasDosPedidos = repositorioCarregamentoPedidoNotaFiscal.BuscarJaUtilizadasPorCarregamentoEPedidos(codigosPedidos, codigoCarregamento);
            List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> listaTotalNotasJaEnviadas = new List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal>();
            listaTotalNotasJaEnviadas.AddRange(listaNotasJaEnviadasDosPedidos);
            listaTotalNotasJaEnviadas.AddRange(listaCarregamentoPedidoNotaFiscal);

            List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedido> pedidosCarregamento = carregamentoPedidos;

            if (carga != null && carga.Carregamento != null && pedidosCarregamento == null)
                pedidosCarregamento = await repCarregamentoPedido.BuscarPorCarregamentoAsync(carga.Carregamento.Codigo);

            Dominio.ObjetosDeValor.Embarcador.Carga.MontagemCargaSqlPedidoProduto ObjetoMontagemCargaSqlPedidoProduto = new Dominio.ObjetosDeValor.Embarcador.Carga.MontagemCargaSqlPedidoProduto();

            bool setarOrdemEntrega = false;
            int qtdeSemOrdem = (from obj in pedidos
                                where obj.OrdemColetaProgramada == 0
                                select obj).Count();

            if ((carga.TipoOperacao?.ManterOrdemAoRoteirizarAgendaEntrega ?? false) && (pedidos.Count == qtdeSemOrdem || pedidosDevolucao) && !pedidos.Any(x => x.PrevisaoEntrega == null))
            {
                pedidos = pedidos.OrderBy(x => x.PrevisaoEntrega).ToList();
                setarOrdemEntrega = true;
            }

            Repositorio.Embarcador.Pedidos.PedidoAnexo repPedidoAnexo = new Repositorio.Embarcador.Pedidos.PedidoAnexo(unitOfWork);
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoAnexo> pedidosAnexos = await repPedidoAnexo.BuscarPorPedidosAsync(codigosPedidos);

            Dominio.Entidades.Embarcador.Pedidos.Stage stage = Servicos.Embarcador.Pedido.Stage.ObterStageMaisRelevante(pedidosStage);

            Repositorio.Embarcador.Filiais.EstadoDestinoEmpresaEmissora repositorioEstadoDestinoEmpresaEmissora = new Repositorio.Embarcador.Filiais.EstadoDestinoEmpresaEmissora(unitOfWork);
            List<Dominio.Entidades.Embarcador.Filiais.EstadoDestinoEmpresaEmissora> estadosDestinoEmpresaEmissora = carga.Filial != null ? await repositorioEstadoDestinoEmpresaEmissora.BuscarPorFilialAsync(carga.Filial.Codigo) : new List<Dominio.Entidades.Embarcador.Filiais.EstadoDestinoEmpresaEmissora>();

            bool? utilizarDistribuidorPorRegiaoNaRegiaoDestino = carga.TipoOperacao?.ConfiguracaoCarga?.UtilizarDistribuidorPorRegiaoNaRegiaoDestino ?? false;
            bool utilizarOutroEnderecoPedidoMesmoSePossuirRecebedor = carga.TipoOperacao?.ConfiguracaoEmissaoDocumento?.UtilizarOutroEnderecoPedidoMesmoSePossuirRecebedor ?? false;

            List<Dominio.Entidades.Cliente> clientesBloquearEmissaoDosDestinatarios = carga.TipoOperacao?.ClientesBloquearEmissaoDosDestinatario.ToList();

            Repositorio.Embarcador.Configuracoes.IntegracaoIntercab repIntegracaoIntercab = new Repositorio.Embarcador.Configuracoes.IntegracaoIntercab(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoFronteira repositorioPedidoFronteira = new Repositorio.Embarcador.Pedidos.PedidoFronteira(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab = await repIntegracaoIntercab.BuscarIntegracaoAsync();

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = await new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadraoAsync();

            List<string> cnpjsRemetenteDestinario = pedidos.Select(x => x.Remetente.CPF_CNPJ.ToString()).Concat(pedidos.Select(x => x.Destinatario.CPF_CNPJ.ToString())).ToList();
            List<Dominio.Entidades.Embarcador.Filiais.Filial> filiais = await repositorioFilial.BuscarPorCNPJSAsync(cnpjsRemetenteDestinario.Distinct().ToList());
            List<Dominio.Entidades.Embarcador.Pedidos.RegraTomador> regrasTomardor = await repositorioRegraTomador.BuscarPorRemetentesOuDestinatariosAsync(pedidos.Select(x => x.Remetente.CPF_CNPJ).Distinct().ToList(), pedidos.Select(x => x.Destinatario.CPF_CNPJ).Distinct().ToList());
            List<Dominio.Entidades.Embarcador.Pedidos.RegraTomador> regrasTomardorSemTomador = await repositorioRegraTomador.BuscarPorFilialNaoFilialAsync();

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> pedidosXMLNotaFiscalInserir = new List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal>();
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoQuantidades> cargaPedidoQuantidadesDeletar = new List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoQuantidades>();
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoQuantidades> cargaPedidoQuantidadesInserir = new List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoQuantidades>();
            List<Dominio.Entidades.Cliente> listaFronteirasPedido = new List<Dominio.Entidades.Cliente>();

            foreach (Dominio.Entidades.Embarcador.Pedidos.Pedido pedido in pedidos)
            {
                Servicos.Log.GravarInfo("Iniciou Pedido " + count.ToString() + " de " + pedidos.Count.ToString() + " " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "MontagemCarga");
                count++;

                Dominio.Entidades.Embarcador.Pedidos.Stage stageParticipantes = null; //#69031
                if (pedidosStage?.Count > 0)
                    stageParticipantes = (from obj in pedidosStage where obj.Pedido.Codigo == pedido.Codigo select obj.Stage).FirstOrDefault();

                if (carga.CargaPreCarga != null && !string.IsNullOrEmpty(carga.CargaPreCarga.NumeroCargaVincularPreCarga))
                {
                    List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosPreCargaDestinatario = (from obj in cargaPedidosPreCarga where obj.Pedido.Destinatario?.CPF_CNPJ == pedido.Destinatario?.Codigo select obj).ToList();
                    Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoPreCarga = cargaPedidosPreCargaDestinatario.FirstOrDefault();

                    if (cargaPedidoPreCarga != null)
                    {
                        string numeroPedido;
                        if (configuracaoPedido.ConcatenarNumeroPreCargaNoPedido)
                        {
                            string prefixoNumeroPedidoPreCarga = $"{cargaPedidoPreCarga.Carga.CodigoCargaEmbarcador}_";
                            IEnumerable<string> numerosPedidosPreCarga = cargaPedidosPreCargaDestinatario.Select(o => o.Pedido.NumeroPedidoEmbarcador.Replace(prefixoNumeroPedidoPreCarga, ""));
                            numeroPedido = $"{carga.CodigoCargaEmbarcador}_{string.Join("_", numerosPedidosPreCarga)}";
                        }
                        else
                            numeroPedido = cargaPedidoPreCarga.Pedido.NumeroPedidoEmbarcador.Replace(cargaPedidoPreCarga.Carga.CodigoCargaEmbarcador, carga.CodigoCargaEmbarcador);

                        pedido.NumeroPedidoEmbarcador = numeroPedido.Left(tamanho: 50);
                        pedido.PrevisaoEntrega = cargaPedidoPreCarga.Pedido.PrevisaoEntrega;
                        pedido.QtVolumes = cargaPedidosPreCargaDestinatario.Sum(o => o.Pedido.QtVolumes);
                    }
                }

                carga.CargaTakeOrPay = pedido.PedidoTakeOrPay;
                carga.CargaDemurrage = pedido.PedidoDemurrage;
                carga.CargaDetention = pedido.PedidoDetention;
                carga.CargaDestinadaCTeComplementar = pedido?.TipoOperacao?.OperacaoDestinadaCTeComplementar ?? false;
                carga.CargaSVMTerceiro = pedido.PedidoDeSVMTerceiro;

                if (carga.CargaSVMTerceiro)
                    carga.CargaSVM = false;

                if (carga.CargaDestinadaCTeComplementar)
                {
                    string numeroOSMae = await repPedido.BuscarNumeroOSMaeAsync(pedido.Codigo);
                    if (!string.IsNullOrWhiteSpace(numeroOSMae))
                        await this.VincularMotoristaVeiculosOSMaeAsync(carga, pedido, numeroOSMae, unitOfWork, tipoServicoMultisoftware, configuracao); // Migar para outro serviço silvani
                }

                List<Dominio.Entidades.Cliente> listaFronteirasPedidoValidar = await repositorioPedidoFronteira.BuscarFronteirasPorPedidoAsync(pedido.Codigo);

                bool fronteirasPedidoIguais = true;

                if (listaFronteirasPedido?.Count != listaFronteirasPedidoValidar.Count)
                {
                    fronteirasPedidoIguais = false;
                }
                else
                {
                    List<double> cpfsOriginal = listaFronteirasPedido.Select(c => c.CPF_CNPJ).OrderBy(c => c).ToList();
                    List<double> cpfsValidar = listaFronteirasPedidoValidar.Select(c => c.CPF_CNPJ).OrderBy(c => c).ToList();

                    if (cpfsOriginal?.Count > 0)
                        fronteirasPedidoIguais = cpfsOriginal.SequenceEqual(cpfsValidar);
                }

                if (fronteirasPedidoIguais || carga.Pedidos?.Count == 1)
                {
                    listaFronteirasPedido = listaFronteirasPedidoValidar;
                }
                else
                    throw new ServicoException("Não é possível gerar uma carga de pedidos, onde a fronteira seja diferente");

                if (configuracaoPedido.AtivarValidacaoCriacaoCarga) // largar em uma função
                {
                    Dominio.Entidades.Veiculo veiculoTracao = pedido.VeiculoTracao;

                    if (veiculoTracao == null && pedido.Veiculos != null && pedido.Veiculos.Count > 0)
                        veiculoTracao = pedido.Veiculos.Where(c => c.TipoVeiculo == "0")?.FirstOrDefault();

                    if (veiculoTracao == null && (pedido.Motoristas == null || pedido.Motoristas.Count == 0))
                    {
                        throw new ServicoException("Com a configuração de validação da criação de carga, não é possível gerar uma carga sem veículo ou motorista");
                    }
                    else
                    {
                        if (configuracaoPedido.QuantidadeCargasEmAberto > 0)
                        {
                            int quantidadeCargaPedido = 0;
                            if (veiculoTracao != null && pedido.Motoristas != null && pedido.Motoristas.Count > 0)
                                quantidadeCargaPedido = await repCargaPedido.BuscarQuantidadeCargaPedidoPorVeiculoMotoristaAsync(veiculoTracao.Codigo, pedido.Motoristas.Select(c => c.Codigo).ToList());
                            if (veiculoTracao != null && quantidadeCargaPedido == 0)
                                quantidadeCargaPedido = await repCargaPedido.BuscarQuantidadeCargaPedidoPorVeiculoMotoristaAsync(veiculoTracao.Codigo, null);
                            if (pedido.Motoristas != null && pedido.Motoristas.Count > 0 && quantidadeCargaPedido == 0)
                                quantidadeCargaPedido = await repCargaPedido.BuscarQuantidadeCargaPedidoPorVeiculoMotoristaAsync(0, pedido.Motoristas.Select(c => c.Codigo).ToList());

                            if (quantidadeCargaPedido > configuracaoPedido.QuantidadeCargasEmAberto)
                                throw new ServicoException("A quantidade de cargas atual (" + quantidadeCargaPedido.ToString("D") + ") excede a quantidade limite de cargas em aberto configurado (" + configuracaoPedido.QuantidadeCargasEmAberto.ToString("D") + ")");
                        }

                        Dominio.Entidades.Embarcador.Cargas.CargaPedido ultimoCargaPedido = null;
                        if (veiculoTracao != null && pedido.Motoristas != null && pedido.Motoristas.Count > 0)
                            ultimoCargaPedido = await repCargaPedido.BuscarUltimaCargaPedidoPorVeiculoMotoristaAsync(veiculoTracao.Codigo, pedido.Motoristas.Select(c => c.Codigo).ToList());
                        if (veiculoTracao != null && ultimoCargaPedido == null)
                            ultimoCargaPedido = await repCargaPedido.BuscarUltimaCargaPedidoPorVeiculoMotoristaAsync(veiculoTracao.Codigo, null);
                        if (pedido.Motoristas != null && pedido.Motoristas.Count > 0 && ultimoCargaPedido == null)
                            ultimoCargaPedido = await repCargaPedido.BuscarUltimaCargaPedidoPorVeiculoMotoristaAsync(0, pedido.Motoristas.Select(c => c.Codigo).ToList());

                        if (ultimoCargaPedido != null && (pedido.Origem?.Codigo ?? 0) != (ultimoCargaPedido?.Destino?.Codigo ?? 0))
                            throw new ServicoException("A origem do pedido(" + (pedido.Origem?.Descricao ?? "") + ") não está de acordo com o último destino(" + (ultimoCargaPedido?.Destino?.Descricao ?? "") + " Carga: " + (ultimoCargaPedido?.Carga?.CodigoCargaEmbarcador ?? "") + ")");
                    }
                }


                List<Dominio.Entidades.Embarcador.Pedidos.PedidoProduto> listaPedidoProduto = listaTodosPedidoProduto.Where(o => o.Pedido.Codigo == pedido.Codigo).ToList();

                List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoProduto> produtosDoPedidoNoCarregamento = new List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoProduto>();

                //Filtra os produtos do pedido contidos no carregamento referente a carga que está sendo gerada.
                if (montagemCargaPorPedidoProduto && codigoCarregamento > 0)
                    produtosDoPedidoNoCarregamento = (from cpp in listaTodosPedidoProdutoCarregamento
                                                      where cpp.CarregamentoPedido.Carregamento.Codigo == codigoCarregamento &&
                                                      cpp.CarregamentoPedido.Pedido.Codigo == pedido.Codigo
                                                      select cpp).ToList();


                decimal pesoTotalPedidoCarga = pedido.PesoTotal;
                decimal palletTotalPedidoCarga = pedido.TotalPallets;
                decimal pesoPallet = 0;
                decimal volumesCarregados = pedido.SaldoVolumesRestante;
                bool todosProdutosPedidoNestaCarga = false;
                TipoPaleteCliente tipoPaleteCliente = TipoPaleteCliente.NaoDefinido;

                if (pedidosCarregamento != null && pedidosCarregamento.Any())
                {
                    pesoTotalPedidoCarga = pedidosCarregamento.FirstOrDefault(p => p.Pedido.Codigo == pedido.Codigo && p.Peso > 0)?.Peso ?? pedido.PesoTotal;
                    palletTotalPedidoCarga = pedidosCarregamento.FirstOrDefault(p => p.Pedido.Codigo == pedido.Codigo && p.Pallet > 0)?.Pallet ?? pedido.TotalPallets;
                    pesoPallet = pedidosCarregamento.FirstOrDefault(p => p.Pedido.Codigo == pedido.Codigo && p.PesoPallet > 0)?.PesoPallet ?? 0;
                    tipoPaleteCliente = pedidosCarregamento.Find(p => p.Pedido.Codigo == pedido.Codigo)?.Pedido?.TipoPaleteCliente ?? TipoPaleteCliente.NaoDefinido;
                }

                if (montagemCargaPorPedidoProduto)
                {
                    pesoTotalPedidoCarga = produtosDoPedidoNoCarregamento.Sum(x => x.Peso);
                    volumesCarregados = produtosDoPedidoNoCarregamento.Sum(x => x.Quantidade);
                    todosProdutosPedidoNestaCarga = ((volumesCarregados + 0.5m) > listaPedidoProduto.Sum(x => x.Quantidade));
                }

                Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido = new Dominio.Entidades.Embarcador.Cargas.CargaPedido
                {
                    Carga = carga,
                    CargaOrigem = carga,
                    Pedido = pedido,
                    Peso = pesoTotalPedidoCarga,
                    Pallet = palletTotalPedidoCarga,
                    PesoPallet = pesoPallet,
                    PesoLiquido = pedido.PesoLiquidoTotal,
                    Ativo = true,
                    ValorFrete = 0m,
                    SituacaoEmissao = SituacaoNF.Nova,
                    NumeroReboque = numeroReboque,
                    TipoCarregamentoPedido = tipoCarregamentoPedido,
                    PrevisaoEntrega = dataPrevistaChegadaCliente,
                    BloquearEmissaoDosDestinatario = false,
                    BloquearEmissaoDeEntidadeSemCadastro = false,
                    TipoServicoMultimodal = TipoServicoMultimodal.Normal,
                    CanalEntrega = stage?.CanalEntrega ?? stageParticipantes?.CanalEntrega ?? pedido.CanalEntrega,
                    CanalVenda = stage?.CanalVenda ?? stageParticipantes?.CanalVenda ?? pedido.CanalVenda,
                    StageRelevanteCusto = stage,
                    TipoPaleteCliente = tipoPaleteCliente
                };

                Dominio.ObjetosDeValor.Embarcador.Carga.CargaOrigemPedidos cargaOrigemPedido = cargaOrigemPedidos.FirstOrDefault(c => c.CodigoPedido == pedido.Codigo);

                if (cargaOrigemPedido != null)
                    cargaPedido.CargaControleEntrega = new Dominio.Entidades.Embarcador.Cargas.Carga() { Codigo = cargaOrigemPedido.Codigo };

                if ((carga?.Carregamento?.SessaoRoteirizador?.RoteirizacaoRedespacho ?? false) && (carga?.Carregamento?.SessaoRoteirizador?.Expedidor ?? null) != null)
                {
                    cargaPedido.Expedidor = carga.Carregamento.SessaoRoteirizador.Expedidor;
                    cargaPedido.Recebedor = null;
                }

                if (carga?.Carregamento?.Expedidor != null)
                    cargaPedido.Expedidor = carga?.Carregamento?.Expedidor;

                if (pedido.ReentregaSolicitada)
                {
                    cargaPedido.ReentregaSolicitada = true;
                    pedido.ReentregaSolicitada = false;
                }

                if (!string.IsNullOrEmpty(carga.ObservacaoTransportador) && !string.IsNullOrEmpty(pedido.Observacao))
                    pedido.Observacao = carga.ObservacaoTransportador;

                if (pedido.OrdemColetaProgramada > 0)
                {
                    cargaPedido.OrdemColeta = pedido.OrdemColetaProgramada;
                    carga.OrdemRoteirizacaoDefinida = true;
                }

                if (pedido.OrdemEntregaProgramada > 0)
                {
                    cargaPedido.OrdemEntrega = pedido.OrdemEntregaProgramada;
                    carga.OrdemRoteirizacaoDefinida = true;
                }

                if (carregamentoPedidos != null)
                {
                    int ordemEntrega = ((from obj in carregamentoPedidos where obj.Pedido.Codigo == pedido.Codigo select obj.Ordem)?.FirstOrDefault() ?? 0);

                    if (ordemEntrega > 0)
                        cargaPedido.OrdemEntrega = ordemEntrega;
                }
                else if (pedidosDevolucao)
                {
                    if (pedido.PedidoDeDevolucao)
                    {
                        Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoPrincipal = await repPedido.BuscarPedidoPrincipalPeloPedidoDevolucaoAsync(pedido.Codigo);
                        Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoPrincipal = await repCargaPedido.BuscarPorCargaEPedidoAsync(carga.Codigo, pedidoPrincipal.Codigo);

                        if (cargaPedidoPrincipal != null)
                        {
                            cargaPedido.OrdemEntrega = cargaPedidoPrincipal.OrdemEntrega;
                            carga.OrdemRoteirizacaoDefinida = true;
                        }
                        else
                            cargaPedido.OrdemEntrega = (count - 1);
                    }
                }
                else if (setarOrdemEntrega)
                {
                    cargaPedido.OrdemEntrega = (count - 1);
                    carga.OrdemRoteirizacaoDefinida = true;
                }

                List<Dominio.Entidades.Embarcador.Pedidos.PedidoAnexo> anexos = pedidosAnexos.Where(p => p.EntidadeAnexo.Codigo == pedido.Codigo).ToList();

                if (anexos.Any()) await VincularAnexosPedidoNaCargaAnexoAsync(anexos, cargaPedido.Carga, unitOfWork, Auditado);

                Dominio.Entidades.Cliente tomador = pedido.ObterTomador();

                string retornoDadosPedido = await serCargaPedido.SetarDadosCargaPedidoAsync(new Dominio.ObjetosDeValor.Embarcador.Carga.SetarDadosCargaPedido()
                {
                    Carga = carga,
                    CargaPedido = cargaPedido,
                    ClientesDescarga = clientesDescarga,
                    Configuracao = configuracao,
                    ConfiguracaoGeralCarga = configuracaoGeralCarga,
                    Pedido = pedido,
                    PossuiRegraTomador = possuiRegraTomador,
                    TipoServicoMultisoftware = tipoServicoMultisoftware,
                    Tomador = tomador,
                    UtilizarDistribuidorPorRegiaoNaRegiaoDestino = utilizarDistribuidorPorRegiaoNaRegiaoDestino,
                    Filiais = filiais,
                    RegrasTomadores = regrasTomardor,
                    RegrasTomadoresSemTomador = regrasTomardorSemTomador,
                    DadosCrtMicPedido = dadosCrtMicPedido,
                }, unitOfWork);

                if (!string.IsNullOrWhiteSpace(retornoDadosPedido))
                    throw new ServicoException(retornoDadosPedido);

                if (stageParticipantes?.Recebedor != null && !configuracao.IncluirCargaCanceladaProcessarDT)
                {
                    cargaPedido.Recebedor = stageParticipantes?.Recebedor;
                    cargaPedido.Destino = stageParticipantes?.Recebedor?.Localidade;
                    cargaPedido.TipoEmissaoCTeParticipantes = cargaPedido.Expedidor != null ? TipoEmissaoCTeParticipantes.ComExpedidorERecebedor : TipoEmissaoCTeParticipantes.ComRecebedor;
                }

                if (stageParticipantes?.Expedidor != null && !configuracao.IncluirCargaCanceladaProcessarDT)
                {
                    cargaPedido.Expedidor = stageParticipantes?.Expedidor;
                    cargaPedido.Origem = stageParticipantes?.Expedidor?.Localidade;
                    cargaPedido.TipoEmissaoCTeParticipantes = cargaPedido.Recebedor != null ? TipoEmissaoCTeParticipantes.ComExpedidorERecebedor : TipoEmissaoCTeParticipantes.ComExpedidor;
                }


                if ((from obj in notasPedidos where obj.Codigo == pedido.Codigo select obj).Count() > 0)
                    cargaPedido.SituacaoEmissao = SituacaoNF.NFEnviada;

                if (notasPedidos.Count == 0 && !carga.CargaColeta && (cargaPedido.Carga.Carregamento == null || !cargaPedido.Carga.Carregamento.CarregamentoRedespacho))
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedido redespachoProximoTrecho = redespachosProximoTrecho.FirstOrDefault(x => x.Pedido.Codigo == pedido.Codigo);
                    if (redespachoProximoTrecho != null)
                    {
                        redespachoProximoTrecho.CargaPedidoTrechoAnterior = cargaPedido;
                        cargaPedido.CargaPedidoProximoTrecho = redespachoProximoTrecho;

                        await repCargaPedido.AtualizarAsync(redespachoProximoTrecho);
                    }
                }

                serCargaPedido.AdicionarProdutosCargaParaProcessamentoPosterior(cargaPedido, listaPedidoProduto, configuracao.UsarPesoProdutoSumarizacaoCarga, unitOfWork, ObjetoMontagemCargaSqlPedidoProduto, montagemCargaPorPedidoProduto, produtosDoPedidoNoCarregamento);
                serCargaPedido.BuscarConfiguracoesMultimodal(carga, unitOfWork, ref cargaPedido, integracaoIntercab, clientesBloquearEmissaoDosDestinatarios, tomador, false);


                if (pedido.ValorFreteNegociado > 0m || pedido.ValorFreteAReceber > 0m)
                {
                    List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoProduto> cargaPedidoProdutos = serRegraICMS.CriarProdutosCargaContidosEmRegras(cargaPedido, listaPedidoProduto, unitOfWork);
                    if (!pedido.ImpostoNegociado)
                    {
                        pedido.IncluirBaseCalculoICMS = true;
                        pedido.PercentualInclusaoBC = 100;
                    }

                    bool incluirBase = pedido.IncluirBaseCalculoICMS;
                    decimal percentualIncluir = pedido.PercentualInclusaoBC;

                    if (pedido.ValorFreteAReceber > 0m && pedido.ValorFreteNegociado == 0m && pedido.Destinatario != null)
                    {
                        if (cargaPedido.PossuiCTe)
                        {
                            decimal baseCalculo = pedido.ValorFreteAReceber;
                            bool incliur = false;
                            decimal percentual = 0;

                            Dominio.ObjetosDeValor.Embarcador.ICMS.RegraICMS regraICMSFreteLiquido = await serRegraICMS.BuscarRegraICMSAsync(cargaPedido.Carga, cargaPedido, cargaPedido.Carga.Empresa, cargaPedido.Pedido.Remetente, cargaPedido.Pedido?.Destinatario, cargaPedido.ObterTomador(), cargaPedido.Origem, cargaPedido.Destino, incliur, percentual, baseCalculo, cargaPedidoProdutos, unitOfWork, tipoServicoMultisoftware, configuracao, tabelaAliquotas, tomadoresFilialEmissora);

                            decimal aliquota = (regraICMSFreteLiquido.Aliquota / 100);

                            pedido.ValorFreteNegociado = Math.Round((pedido.ValorFreteAReceber * (1 - aliquota)), 2, MidpointRounding.AwayFromZero);
                            pedido.ValorFreteAReceber = 0m;
                        }
                        else if (cargaPedido.PossuiNFS || cargaPedido.PossuiNFSManual)
                            pedido.ValorFreteNegociado = pedido.ValorFreteAReceber;
                    }

                    if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS && pedido.ColetaEmProdutorRural)
                        await repPedido.AtualizarValorFreteNegociadoProdutorRuralAsync(pedido.Codigo, pedido.ValorFreteNegociado);

                    cargaPedido.ValorFreteAPagar = pedido.ValorFreteAReceber;
                    cargaPedido.ValorFrete = pedido.ValorFreteNegociado;

                    if (carga.TipoOperacao != null && carga.TipoOperacao.UsarConfiguracaoEmissao && carga.TipoOperacao.ModeloDocumentoFiscal != null)
                        cargaPedido.ModeloDocumentoFiscal = carga.TipoOperacao.ModeloDocumentoFiscal;

                    if (cargaPedido.Recebedor != null && cargaPedido.Destino == null)
                        cargaPedido.Destino = cargaPedido.Recebedor.Localidade;

                    if (pedido.Destinatario != null)
                    {
                        if (cargaPedido.Destino == null)
                            cargaPedido.Destino = cargaPedido.Pedido.Destinatario?.Localidade;

                        Dominio.ObjetosDeValor.Embarcador.ICMS.RegraICMS regraICMS = await serRegraICMS.BuscarRegraICMSAsync(cargaPedido.Carga, cargaPedido, cargaPedido.Carga.Empresa, cargaPedido.Pedido.Remetente, cargaPedido.Pedido?.Destinatario, cargaPedido.ObterTomador(), cargaPedido.Origem, cargaPedido.Destino, incluirBase, percentualIncluir, cargaPedido.BaseCalculoICMS, cargaPedidoProdutos, unitOfWork, tipoServicoMultisoftware, configuracao, tabelaAliquotas, tomadoresFilialEmissora);

                        incluirBase = regraICMS.IncluirICMSBC;
                        percentualIncluir = regraICMS.PercentualInclusaoBC;

                        cargaPedido.CFOP = await repCFOP.BuscarPorNumeroAsync(regraICMS.CFOP);
                        cargaPedido.CST = regraICMS.CST;
                        cargaPedido.ObservacaoRegraICMSCTe = regraICMS.ObservacaoCTe;
                        cargaPedido.SetarRegraICMS(regraICMS.CodigoRegra);
                    }

                    List<Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete> pedidosComponenteFrete = listaTodosPedidosComponenteFrete.Where(o => o.Pedido.Codigo == pedido.Codigo).ToList();

                    foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete pedidoComponenteFrete in pedidosComponenteFrete)
                    {
                        serComponenteFrete.AdicionarCargaPedidoComponente(cargaPedido, pedidoComponenteFrete.ValorComponente, pedidoComponenteFrete.Percentual, pedidoComponenteFrete.TipoValor,
                            pedidoComponenteFrete.TipoComponenteFrete, pedidoComponenteFrete.ComponenteFrete, pedidoComponenteFrete.IncluirBaseCalculoICMS, pedidoComponenteFrete.IncluirIntegralmenteContratoFreteTerceiro, pedidoComponenteFrete.ModeloDocumentoFiscal,
                            pedidoComponenteFrete.RateioFormula, pedidoComponenteFrete.OutraDescricaoCTe, pedidoComponenteFrete.DescontarValorTotalAReceber, pedidoComponenteFrete.AcrescentaValorTotalAReceber,
                            pedidoComponenteFrete.ComponenteFilialEmissora, unitOfWork, pedidoComponenteFrete.PorQuantidadeDocumentos, pedidoComponenteFrete.TipoCalculoQuantidadeDocumentos,
                            pedidoComponenteFrete.QuantidadeTotalDocumentos, pedidoComponenteFrete.ModeloDocumentoFiscalRateio, pedidoComponenteFrete.NaoSomarValorTotalAReceber, ref cargaPedidosComponentesCarga, pedidoComponenteFrete.NaoSomarValorTotalPrestacao, MoedaCotacaoBancoCentral.Real, 0m, 0m);
                    }

                    if (pedido.ImpostoNegociado)
                    {
                        if (cargaPedido.PossuiNFS)
                            cargaPedido.ModeloDocumentoFiscal = await repModeloDocumentoFiscal.BuscarPorTipoDocumentoAsync(Dominio.Enumeradores.TipoDocumento.NFSe);

                        if (cargaPedido.PossuiNFS && cargaPedido.ModeloDocumentoFiscal != null && cargaPedido.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFSe)
                        {
                            cargaPedido.PercentualAliquotaISS = pedido.PercentualAliquota;
                            cargaPedido.BaseCalculoISS = pedido.BaseCalculoICMS;
                            cargaPedido.ValorISS = pedido.ValorICMS;
                            cargaPedido.PercentualIncluirBaseCalculo = percentualIncluir;
                            cargaPedido.IncluirISSBaseCalculo = pedido.IncluirBaseCalculoICMS;
                            cargaPedido.ImpostoInformadoPeloEmbarcador = true;
                            cargaPedido.ValorFrete = pedido.BaseCalculoICMS;
                        }
                        else
                        {
                            cargaPedido.PercentualAliquota = pedido.PercentualAliquota;
                            cargaPedido.BaseCalculoICMS = pedido.BaseCalculoICMS;
                            cargaPedido.ValorICMS = pedido.ValorICMS;
                            cargaPedido.PercentualIncluirBaseCalculo = percentualIncluir;
                            cargaPedido.IncluirICMSBaseCalculo = pedido.IncluirBaseCalculoICMS;
                            cargaPedido.ImpostoInformadoPeloEmbarcador = true;

                            Servicos.Log.TratarErro($"1 - CargaPedido: {cargaPedido.Codigo} -> Aliquota: {cargaPedido.PercentualAliquota}", "ProcessarAliquota");
                        }
                    }
                    else
                    {
                        cargaPedido.IncluirICMSBaseCalculo = true;
                        cargaPedido.PercentualIncluirBaseCalculo = 100;

                        if (pedido.Destinatario != null)
                            serRateioFrete.CalcularImpostos(ref carga, carga, cargaPedido, cargaPedido.ValorFrete, false, tipoServicoMultisoftware, unitOfWork, configuracao, cargaPedidosComponentesCarga, pedagioEstadosBaseCalculo, cargaPedidoProdutos, tabelaAliquotas, tomadoresFilialEmissora, configuracaoGeralCarga);
                    }

                    cargaPedido.ValorFreteFilialEmissora = pedido.ValorFreteFilialEmissora;

                    serCargaPedido.VerificarFilialEmissaoCargaPedido(cargaPedido, configuracaoGeralCarga);
                    if (cargaPedido.CargaPedidoFilialEmissora)
                    {
                        Dominio.Entidades.Embarcador.Filiais.EstadoDestinoEmpresaEmissora estadoDestino = estadosDestinoEmpresaEmissora.Find(e => e.Estado.Codigo == cargaPedido.Destino?.Estado.Codigo);

                        if (carga.EmpresaFilialEmissora == null)
                        {

                            if ((estadosDestinoEmpresaEmissora.Count > 0) && estadoDestino != null)
                                carga.EmpresaFilialEmissora = estadoDestino.Empresa;
                            else
                                carga.EmpresaFilialEmissora = carga.Filial.EmpresaEmissora;
                        }

                        if ((estadosDestinoEmpresaEmissora.Count > 0) && estadoDestino != null)
                            carga.EmiteMDFeFilialEmissora = carga.Filial.EmiteMDFeFilialEmissoraPorEstadoDestino;
                        else
                            carga.EmiteMDFeFilialEmissora = carga.Filial.EmiteMDFeFilialEmissora;

                        if (carga.Filial?.UtilizarCtesAnterioresComoCteFilialEmissora ?? false)
                            carga.UtilizarCTesAnterioresComoCTeFilialEmissora = true;

                        cargaPedido.IncluirICMSBaseCalculoFilialEmissora = cargaPedido.IncluirICMSBaseCalculo;
                        serRateioFrete.CalcularImpostos(ref carga, carga, cargaPedido, cargaPedido.ValorFreteFilialEmissora, true, tipoServicoMultisoftware, unitOfWork, configuracao, cargaPedidosComponentesCarga, pedagioEstadosBaseCalculo, cargaPedidoProdutos, tabelaAliquotas, tomadoresFilialEmissora, configuracaoGeralCarga);
                    }
                }
                else
                {
                    Servicos.Embarcador.Carga.Carga.CalcularValorDescargaPorCargaPedido(cargaPedido, configuracao, unitOfWork);

                    serCargaPedido.VerificarFilialEmissaoCargaPedido(cargaPedido, configuracaoGeralCarga);
                    if (cargaPedido.CargaPedidoFilialEmissora)
                    {
                        Dominio.Entidades.Embarcador.Filiais.EstadoDestinoEmpresaEmissora estadoDestino = estadosDestinoEmpresaEmissora.Find(e => e.Estado.Codigo == cargaPedido.Destino?.Estado.Codigo);
                        if (carga.EmpresaFilialEmissora == null)
                        {

                            if ((estadosDestinoEmpresaEmissora.Count > 0) && estadoDestino != null)
                                carga.EmpresaFilialEmissora = estadoDestino.Empresa;
                            else
                                carga.EmpresaFilialEmissora = carga.Filial.EmpresaEmissora;
                        }

                        if ((estadosDestinoEmpresaEmissora.Count > 0) && estadoDestino != null)
                            carga.EmiteMDFeFilialEmissora = carga.Filial.EmiteMDFeFilialEmissoraPorEstadoDestino;
                        else
                            carga.EmiteMDFeFilialEmissora = carga.Filial.EmiteMDFeFilialEmissora;

                        if (carga.Filial?.UtilizarCtesAnterioresComoCteFilialEmissora ?? false)
                            carga.UtilizarCTesAnterioresComoCTeFilialEmissora = true;
                    }
                }

                if ((utilizarOutroEnderecoPedidoMesmoSePossuirRecebedor) && (pedido?.Recebedor?.Codigo ?? 0) > 0)
                {
                    Repositorio.Embarcador.Pessoas.ClienteOutroEndereco repClienteOutroEndereco = new Repositorio.Embarcador.Pessoas.ClienteOutroEndereco(unitOfWork);
                    Dominio.Entidades.Embarcador.Pessoas.ClienteOutroEndereco endereco = repClienteOutroEndereco.BuscarPorPessoa(pedido.Recebedor.Codigo).FirstOrDefault();

                    if (endereco != null)
                    {
                        cargaPedido.Destino = endereco.Localidade;
                    }
                }

                pedidosXMLNotaFiscalInserir.Add(await VincularNotasFiscaisDosPedidoAsync(cargaPedido, notasUtilizadas, xMLNotaFiscals, notasPedidos, listaCarregamentoPedidoNotaFiscal, listaNotasJaEnviadasDosPedidos, tipoServicoMultisoftware, unitOfWork, Auditado, configuracaoTMS));

                if (notasPedidos.Count <= 0)
                {
                    VincularCtesParciaisDosPedido(cargaPedido, tipoServicoMultisoftware, unitOfWork, ctesParciais);

                    if (!cargaPedido.Carga.CargaColeta)
                        VincularNotasParciaisDosPedido(cargaPedido, tipoServicoMultisoftware, unitOfWork, Auditado, configuracao, notasParciais);

                    VincularCTeTerceiroDosPedido(cargaPedido, tipoServicoMultisoftware, unitOfWork);
                }
                else
                {
                    decimal peso = 0m;
                    decimal pesoLiquido = 0m;
                    await serCargaPedido.AdicionarCargaPedidoQuantidadesCarregamentoAsync(cargaPedido, xMLNotaFiscals, notasPedidos, tipoServicoMultisoftware, configuracao, peso, pesoLiquido, configuracao.NaoAtualizarPesoPedidoPelaNFe, unitOfWork, null, cargaPedidoQuantidades, false, cargaPedidoQuantidadesDeletar, cargaPedidoQuantidadesInserir);
                }

                if (!cargaPedido.PedidoSemNFe && apolicesSeguro?.Count > 0)
                {
                    foreach (Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro apoliceSeguro in apolicesSeguro)
                    {
                        Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao apoliceSeguroAverbacao = new Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao
                        {
                            CargaPedido = cargaPedido,
                            ApoliceSeguro = apoliceSeguro
                        };

                        await repApoliceSeguroAverbacao.InserirAsync(apoliceSeguroAverbacao);
                    }
                }

                if (configuracao.UtilizarIntegracaoPedido)
                    pedido.PedidoIntegradoEmbarcador = false;

                List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> notasFiscaisEnviadasDoPedido = listaTotalNotasJaEnviadas.Where(obj => obj.CarregamentoPedido.Pedido.Codigo == pedido.Codigo).ToList();
                List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> notasEnviadasDoPedido = listaCarregamentoPedidoNotaFiscal.Where(obj => obj.CarregamentoPedido.Pedido.Codigo == pedido.Codigo).ToList();
                int notasEnviadas = 0;

                foreach (Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal notaEnviadasDoPedido in notasFiscaisEnviadasDoPedido)
                    notasEnviadas += notaEnviadasDoPedido.NotasFiscais.Count();

                if (notasEnviadasDoPedido.Count > 0 && notasFiscaisEnviadasDoPedido.Count > 0 && notasEnviadas < pedido.QuantidadeNotasFiscais)
                {
                    if (configuracaoMontagemCarga.TipoControleSaldoPedido == TipoControleSaldoPedido.Pallet)
                    {
                        decimal palletConsiderar = palletTotalPedidoCarga;
                        if (configuracaoMontagemCarga.ConsiderarPesoNFSaldoPedido)
                        {
                            palletConsiderar = 0;
                            foreach (Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal carregamentoPedidoNotaFiscal in notasEnviadasDoPedido)
                                palletConsiderar += carregamentoPedidoNotaFiscal.NotasFiscais.Sum(x => x.QuantidadePallets);
                        }
                        pedido.PalletSaldoRestante -= palletConsiderar;
                        pedido.PedidoTotalmenteCarregado = (pedido.PalletSaldoRestante <= 0.01m);
                    }
                    else
                    {
                        decimal pesoConsiderar = pesoTotalPedidoCarga;
                        if (configuracaoMontagemCarga.ConsiderarPesoNFSaldoPedido)
                        {
                            pesoConsiderar = 0;
                            foreach (Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal carregamentoPedidoNotaFiscal in notasEnviadasDoPedido)
                                pesoConsiderar += carregamentoPedidoNotaFiscal.NotasFiscais.Sum(x => x.Peso);
                        }
                        pedido.PesoSaldoRestante -= pesoConsiderar;
                        pedido.PedidoTotalmenteCarregado = (pedido.PesoSaldoRestante <= 0);
                    }
                }
                else if (carga.Carregamento != null && montagemCargaPorPedidoProduto)
                {
                    List<Dominio.ObjetosDeValor.Embarcador.Carga.MontagemCarga.SaldoPedidoProduto> produtosPedidoNaoAtendido = produtosPedidosNaoAtendido.Where(o => o.CodigoPedido == pedido.Codigo).ToList();
                    pedido.PesoSaldoRestante -= pesoTotalPedidoCarga;
                    pedido.SaldoVolumesRestante -= (int)volumesCarregados;

                    if (produtosPedidoNaoAtendido?.Count > 0)
                        pedido.PedidoTotalmenteCarregado = false;
                    else
                        pedido.PedidoTotalmenteCarregado = (pedido.PesoSaldoRestante <= 0.5m && pedido.SaldoVolumesRestante <= 0) || todosProdutosPedidoNestaCarga;
                }
                else if (carga.Carregamento != null && !montagemCargaPorPedidoProduto)
                {
                    //Boticario
                    if (!(carga.Carregamento?.TipoOperacao?.AgendamentoGeraApenasPedido ?? false))
                    {
                        if (carga.Carregamento.CarregamentoRedespacho || (carga.Carregamento?.SessaoRoteirizador?.RoteirizacaoRedespacho ?? false))
                        {
                            pedido.PedidoRedespachoTotalmenteCarregado = true;
                            pedido.PedidoTotalmenteCarregado = true;
                            Servicos.Log.TratarErro($"Pedido {pedido.NumeroPedidoEmbarcador} - Atualizou redespacho e pedido totalmente carregado - Peso Total.: {pedido.PesoTotal}. 3.0 - Carga.CriarCargaPedidosPorPedidos", "SaldoPedido");
                        }
                        else
                        {
                            if (configuracaoMontagemCarga.TipoControleSaldoPedido == TipoControleSaldoPedido.Pallet)
                            {
                                pedido.PalletSaldoRestante -= palletTotalPedidoCarga;
                                pedido.PedidoTotalmenteCarregado = (pedido.PalletSaldoRestante <= 0.1m);
                            }
                            else
                            {
                                pedido.PesoSaldoRestante -= pesoTotalPedidoCarga;
                                pedido.PedidoTotalmenteCarregado = (pedido.PesoSaldoRestante <= 0.5m);
                            }
                        }
                    }
                    else
                        Servicos.Log.TratarErro($"Pedido {pedido.NumeroPedidoEmbarcador} - Não atualizou saldo pedido {pedido.PesoSaldoRestante} - Peso Total.: {pedido.PesoTotal} - Totalmente carregado.: {pedido.PedidoTotalmenteCarregado}. 3.1 - Carga.CriarCargaPedidosPorPedidos", "SaldoPedido");
                }
                else if (carga.Carregamento == null || !carga.Carregamento.CarregamentoRedespacho)
                {
                    if (!(pedido?.TipoOperacao?.NaoExigeVeiculoParaEmissao ?? true))
                    {
                        if (configuracao.ControlarAgendamentoSKU)
                            pedido.PedidoTotalmenteCarregado = pedido.SaldoVolumesRestante <= 0;
                        else
                            pedido.PedidoTotalmenteCarregado = true;
                    }
                }
                else
                    pedido.PedidoRedespachoTotalmenteCarregado = true;

                pedido.CodigoCargaEmbarcador = carga.CodigoCargaEmbarcador;

                if (pedido.Destinatario != null)
                {
                    List<Dominio.ObjetosDeValor.Embarcador.Pedido.PedidoRecolhimentoDestinatario> recolhimentos = recolhimentosDestinatarios.Where(o => o.CPF_CNPJ == pedido.Destinatario.Codigo).ToList();

                    for (int i = 0, s = recolhimentos.Count; i < s; i++)
                    {
                        Dominio.Entidades.Embarcador.Pedidos.PedidoRecolhimentoTroca pedidoRecolhimento = new Dominio.Entidades.Embarcador.Pedidos.PedidoRecolhimentoTroca()
                        {
                            Pedido = pedido,
                            RecolhimentoTroca = new Dominio.Entidades.Embarcador.Pedidos.Pedido() { Codigo = recolhimentos[i].Codigo }
                        };

                        await repPedidoRecolhimentoTroca.InserirAsync(pedidoRecolhimento);
                    }
                }

                if (carga.DataPrevisaoTerminoCarga.HasValue)
                    pedido.PrevisaoEntrega = carga.DataPrevisaoTerminoCarga;

                pedido.PedidoDePreCarga = carga.CargaDePreCarga;

                cargaPedidos.Add(cargaPedido);
            }

            await repCargaPedido.InserirAsync(cargaPedidos, "T_CARGA_PEDIDO");
            cargaPedidos.ForEach(x => x.Initialize());
            await repPedidoXMLNotaFiscal.InserirAsync(pedidosXMLNotaFiscalInserir.Where(x => x != null).ToList(), "T_PEDIDO_XML_NOTA_FISCAL");

            if (cargaPedidoQuantidadesDeletar?.Count > 0) repCargaPedidoQuantidade.Deletar(cargaPedidoQuantidadesDeletar, "T_CARGA_PEDIDO_QUANTIDADES");

            if (cargaPedidoQuantidadesInserir?.Count > 0) await repCargaPedidoQuantidade.InserirAsync(cargaPedidoQuantidadesInserir, "T_CARGA_PEDIDO_QUANTIDADES");


            if (ObjetoMontagemCargaSqlPedidoProduto.ListaObjetosPedidoProduto.Count > 0)
            {
                Repositorio.Embarcador.Cargas.CargaPedidoProduto repCargaPedidoProduto = new Repositorio.Embarcador.Cargas.CargaPedidoProduto(unitOfWork);

                ObjetoMontagemCargaSqlPedidoProduto.ListaObjetosPedidoProduto.ForEach(x => x.codigoCargaPedido = cargaPedidos.FirstOrDefault(o => o.Pedido.Codigo == x.codigoPedido).Codigo);

                await repCargaPedidoProduto.InsertSQLAsync(ObjetoMontagemCargaSqlPedidoProduto);
            }

            await AdicionaCanhotosCarregamentoAsync(carga, cargaPedidos, xMLNotaFiscals, notasPedidos, tipoServicoMultisoftware, configuracao, unitOfWork);
            AdicionaComponentesCargaAgrupada(carga, cargaPedidos, cargaPedidosComponentesCarga, possuiFilialEmissora, unitOfWork);

            CargaFronteira serCargaFronteira = new Servicos.Embarcador.Carga.CargaFronteira(unitOfWork);

            if (!configuracao.UtilizaEmissaoMultimodal && !serCargaFronteira.TemFronteira(carga) && fronteira != null)
            {
                Repositorio.Embarcador.Cargas.CargaFronteira repCargaFronteira = new Repositorio.Embarcador.Cargas.CargaFronteira(unitOfWork);

                await repCargaFronteira.InserirAsync(new Dominio.Entidades.Embarcador.Cargas.CargaFronteira
                {
                    Carga = carga,
                    Fronteira = new Dominio.Entidades.Cliente() { CPF_CNPJ = fronteira.CPF_CNPJ }
                });
            }

            AtualizaDatasCarregamento(carga, pedidos);

            if (pedidosDevolucao && setarOrdemEntrega)
            {
                cargaPedidos = cargaPedidos.OrderBy(x => x.OrdemEntrega).ToList();

                for (int i = 0; i < cargaPedidos.Count; i++)
                {
                    cargaPedidos[i].OrdemEntrega = (i + 1);
                    await repCargaPedido.AtualizarAsync(cargaPedidos[i]);
                }
            }

            if (carga.OrdemRoteirizacaoDefinida && !cargaPedidos.Exists(obj => obj.OrdemEntrega > 0))
            {
                int ordemEntrega = (from obj in cargaPedidos select obj.OrdemColeta).Max();
                if (ordemEntrega > 0)
                {
                    List<(double CNPJ, int CodigoDestino)> destinatarios = (from obj in cargaPedidos where obj.Recebedor != null select (obj.Recebedor.CPF_CNPJ, obj.Destino.Codigo)).Distinct().ToList();
                    destinatarios.AddRange((from obj in cargaPedidos where obj.Recebedor == null && obj.Pedido.Destinatario != null select (obj.Pedido.Destinatario.CPF_CNPJ, obj.Destino.Codigo)).Distinct().ToList());
                    foreach ((double CNPJ, int CodigoDestino) destinatario in destinatarios)
                    {
                        ordemEntrega++;
                        await repCargaPedido.SetarOrdemEntregaPorEnderecoAsync(carga.Codigo, ordemEntrega, destinatario.CNPJ, destinatario.CodigoDestino);
                    }
                }
            }

            new Servicos.Embarcador.Carga.RateioFormula().SubstituirFormulaDeRateio(carga, cargaPedidos, unitOfWork);

            await repCarga.AtualizarAsync(carga);

            repCargaPedido.AtualizarSomenteCamposAlterados(cargaPedidos);
            repPedido.AtualizarSomenteCamposAlterados(cargaPedidos.Select(cp => cp.Pedido).ToList());

            return cargaPedidos;
        }

        private async Task AdicionaCanhotosCarregamentoAsync(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> xMLNotaFiscals, List<Dominio.ObjetosDeValor.Embarcador.Carga.TotalizadorModeloDocumento> notasPedidos, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao, Repositorio.UnitOfWork unitOfWork)
        {
            if (xMLNotaFiscals.Count > 0)
            {
                Servicos.Embarcador.Canhotos.Canhoto serCanhoto = new Canhotos.Canhoto(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaMotorista repCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);

                List<Dominio.Entidades.Usuario> motoristas = carga.Motoristas != null ? carga.Motoristas.ToList() : await repCargaMotorista.BuscarMotoristasPorCargaAsnyc(carga.Codigo);

                Repositorio.Embarcador.Configuracoes.ConfiguracaoCanhoto repConfiguracaoCanhoto = new Repositorio.Embarcador.Configuracoes.ConfiguracaoCanhoto(unitOfWork);
                Repositorio.Embarcador.Canhotos.Canhoto repositorioCanhoto = new Repositorio.Embarcador.Canhotos.Canhoto(unitOfWork);

                Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoCanhoto configuracaoCanhoto = await repConfiguracaoCanhoto.BuscarConfiguracaoPadraoAsync();
                List<Dominio.Entidades.Embarcador.Canhotos.Canhoto> canhotos = await repositorioCanhoto.BuscarPorNotasAsync(xMLNotaFiscals.Select(x => x.Codigo).ToList());

                await serCanhoto.SalvarCanhotoNotaLoteAsync(
                    xMLNotaFiscals,
                    cargaPedidos,
                    carga.FreteDeTerceiro ? carga.Veiculo.Proprietario : null,
                    motoristas,
                    tipoServicoMultisoftware,
                    configuracao,
                    unitOfWork,
                    configuracaoCanhoto,
                    canhotos,
                    notasPedidos);
            }
        }

        private void AdicionaComponentesCargaAgrupada(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete> cargaPedidosComponentesCarga, bool possuiFilialEmissora, Repositorio.UnitOfWork unitOfWork)
        {
            if (!carga.CargaAgrupada)
                return;

            Servicos.Embarcador.Carga.ComponetesFrete serComponenteFrete = new ComponetesFrete(unitOfWork);
            Servicos.Embarcador.Carga.RateioFrete serRateioFrete = new RateioFrete();

            serComponenteFrete.AdicionarComponentesCargaAgrupada(carga, false, cargaPedidosComponentesCarga, unitOfWork);
            serRateioFrete.AcrescentarValoresDaCargaAgrupada(carga, false, cargaPedidos, unitOfWork);

            if (possuiFilialEmissora)
            {
                serComponenteFrete.AdicionarComponentesCargaAgrupada(carga, true, cargaPedidosComponentesCarga, unitOfWork);
                serRateioFrete.AcrescentarValoresDaCargaAgrupada(carga, true, cargaPedidos, unitOfWork);
            }

        }

        private void AtualizaDatasCarregamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos)
        {
            DateTime dataInicialPrevisao = pedidos
                .Where(p => p.DataInicialColeta.HasValue)
                .Select(p => p.DataInicialColeta.Value)
                .DefaultIfEmpty(DateTime.MaxValue)
                .Min();

            DateTime dataFinalPrevisao = pedidos
                .Where(p => p.DataFinalColeta.HasValue)
                .Select(p => p.DataFinalColeta.Value)
                .DefaultIfEmpty(DateTime.MinValue)
                .Max();

            DateTime dataCarregamento = pedidos
                .Where(p => p.DataCarregamentoPedido.HasValue)
                .Select(p => p.DataCarregamentoPedido.Value)
                .DefaultIfEmpty(DateTime.MaxValue)
                .Min();

            if (dataInicialPrevisao != DateTime.MaxValue)
                carga.DataInicialPrevisaoCarregamento = dataInicialPrevisao;

            if (dataFinalPrevisao != DateTime.MinValue)
                carga.DataFinalPrevisaoCarregamento = dataFinalPrevisao;

            if (dataCarregamento != DateTime.MaxValue)
                carga.DataCarregamentoCarga = dataCarregamento;
        }

        private void VincularAnexosPedidoNaCargaAnexo(
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoAnexo> pedidoAnexos,
            Dominio.Entidades.Embarcador.Cargas.Carga carga,
            UnitOfWork unitOfWork,
            Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado = null
            )
        {

            Repositorio.Embarcador.Cargas.CargaAnexo repCargaAnexo = new Repositorio.Embarcador.Cargas.CargaAnexo(unitOfWork);

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoAnexo anexo in pedidoAnexos)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaAnexo cargaAnexo = new Dominio.Entidades.Embarcador.Cargas.CargaAnexo()
                {
                    EntidadeAnexo = carga,
                    Descricao = anexo.Descricao,
                    NomeArquivo = anexo.NomeArquivo,
                    GuidArquivo = anexo.GuidArquivo
                };

                repCargaAnexo.Inserir(cargaAnexo, auditado);
            }
        }

        private async Task VincularAnexosPedidoNaCargaAnexoAsync(
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoAnexo> pedidoAnexos,
            Dominio.Entidades.Embarcador.Cargas.Carga carga,
            UnitOfWork unitOfWork,
            Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado = null
            )
        {

            Repositorio.Embarcador.Cargas.CargaAnexo repCargaAnexo = new Repositorio.Embarcador.Cargas.CargaAnexo(unitOfWork);

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoAnexo anexo in pedidoAnexos)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaAnexo cargaAnexo = new Dominio.Entidades.Embarcador.Cargas.CargaAnexo()
                {
                    EntidadeAnexo = carga,
                    Descricao = anexo.Descricao,
                    NomeArquivo = anexo.NomeArquivo,
                    GuidArquivo = anexo.GuidArquivo
                };

                await repCargaAnexo.InserirAsync(cargaAnexo, auditado);
            }
        }

        public string CriarCargaPorPedidos(ref Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro> apolicesSeguro, Repositorio.UnitOfWork unitOfWork, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado = null, bool montagemCargaPorPedidoProduto = false, NumeroReboque numeroReboque = NumeroReboque.SemReboque, TipoCarregamentoPedido tipoCarregamentoPedido = TipoCarregamentoPedido.Normal, List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedido> carregamentoPedidos = null)
        {
            string retorno = "";
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga repositorioGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga = repositorioGeralCarga.BuscarPrimeiroRegistro();

            Servicos.Log.TratarErro($"Atualização de CAR_CARGA_INTEGRADA_EMBARCADOR na carga {carga.Codigo} para false pelo Carga > CriarCargaPorPedidos", "AtualizacaoCargaIntegradaEmbarcador");

            carga.CargaIntegradaEmbarcador = false;
            carga.SituacaoCarga = SituacaoCarga.Nova;

            if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS || tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador)
            {
                if (carga.TipoOperacao?.DeslocamentoVazio ?? false)
                {
                    carga.ProcessandoDocumentosFiscais = true;
                    carga.DataInicioConfirmacaoDocumentosFiscais = DateTime.Now;
                }
            }

            if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
            {
                carga.ExigeNotaFiscalParaCalcularFrete = true;
            }
            else
            {
                if (carga.TipoOperacao == null)
                    carga.ExigeNotaFiscalParaCalcularFrete = configuracao.ExigirNotaFiscalParaCalcularFreteCarga;
                else
                {
                    carga.ExigeNotaFiscalParaCalcularFrete = carga.TipoOperacao.ExigeNotaFiscalParaCalcularFrete;
                    carga.NaoExigeVeiculoParaEmissao = carga.TipoOperacao.NaoExigeVeiculoParaEmissao;

                    if (configuracao.UtilizaEmissaoMultimodal)
                    {
                        carga.NaoExigeVeiculoParaEmissao = true;
                        carga.NaoGerarMDFe = true;
                    }

                    if (carga.TipoDeCarga == null)
                        carga.TipoDeCarga = carga.TipoOperacao.TipoDeCargaPadraoOperacao;
                }
            }

            decimal distanciaPedidos = 0;

            if (carga.TipoOperacao?.UtilizarMaiorDistanciaPedidoNaMontagemCarga ?? false)
                distanciaPedidos = pedidos.OrderByDescending(o => o.Distancia).FirstOrDefault().Distancia;
            else if (configuracaoGeralCarga?.ConsiderarApenasUmaVezKMParaPedidosComMesmoDestinoOrigemCarga ?? false)
            {
                HashSet<string> combinacoesUnicas = new HashSet<string>();

                foreach (Dominio.Entidades.Embarcador.Pedidos.Pedido pedido in pedidos)
                {
                    string combinacao = pedido.Origem.DescricaoCidadeEstado + pedido.Destino.DescricaoCidadeEstado;

                    if (!combinacoesUnicas.Contains(combinacao))
                    {
                        distanciaPedidos += pedido.Distancia;
                        combinacoesUnicas.Add(combinacao);
                    }
                }
            }
            else
                distanciaPedidos = pedidos.Sum(o => o.Distancia);

            if (distanciaPedidos > 0)
                carga.Distancia = distanciaPedidos;

            carga.CargaFechada = false;

            repCarga.Inserir(carga);

            carga.Protocolo = carga.Codigo;

            repCarga.Atualizar(carga);

            retorno = CriarCargaPedidosPorPedidos(ref carga, pedidos, tipoServicoMultisoftware, apolicesSeguro, unitOfWork, configuracao, Auditado, montagemCargaPorPedidoProduto, numeroReboque, tipoCarregamentoPedido, carregamentoPedidos);

            //#35071 - Pedidos
            List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidosDevolucao = (from obj in pedidos
                                                                                  where obj.PedidoDevolucao != null
                                                                                  select obj.PedidoDevolucao).ToList();
            if ((pedidosDevolucao?.Count ?? 0) > 0)
                retorno = CriarCargaPedidosPorPedidos(ref carga, pedidosDevolucao, tipoServicoMultisoftware, apolicesSeguro, unitOfWork, configuracao, Auditado, montagemCargaPorPedidoProduto, numeroReboque, tipoCarregamentoPedido, null, true);

            return retorno;
        }

        public void GerarNotificacaoEmailFornecedorDadosTransporte(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Email.ConfigEmailDocTransporte repositorioConfiguracaoEmail = new Repositorio.Embarcador.Email.ConfigEmailDocTransporte(unitOfWork);
            Dominio.Entidades.Embarcador.Email.ConfigEmailDocTransporte configuracaoEmail = repositorioConfiguracaoEmail.BuscarEmailEnviaDocumentoAtivo();
            Repositorio.Embarcador.Logistica.AgendamentoColeta repositorioAgendamentoColeta = new Repositorio.Embarcador.Logistica.AgendamentoColeta(unitOfWork);
            Dominio.Entidades.Embarcador.Logistica.AgendamentoColeta agendamentoColeta = repositorioAgendamentoColeta.BuscarPorCarga(carga.Codigo);

            if (agendamentoColeta == null) return;

            string assuntoEmail = $"Carga {carga.CodigoCargaEmbarcador} Confirmada pelo Transportador {carga.Empresa.NomeFantasia}";
            List<Dominio.Entidades.Cliente> fornecedores = ObterFornecedorCarga(carga, unitOfWork);

            foreach (Dominio.Entidades.Cliente fornecedor in fornecedores)
            {
                List<string> emails = new List<string>();

                if (!string.IsNullOrWhiteSpace(fornecedor.Email))
                    emails.AddRange(fornecedor.Email.Split(new char[] { ';' }, StringSplitOptions.RemoveEmptyEntries));

                if (configuracaoEmail == null)
                    return;

                string de = configuracaoEmail.Email;
                string login = configuracaoEmail.Email;
                string senha = configuracaoEmail.Senha;
                string[] copiaOcultaPara = new string[] { };
                string[] copiaPara = new string[] { };
                string servidorSMTP = configuracaoEmail.Smtp;
                string assinatura = "";
                bool possuiSSL = configuracaoEmail.RequerAutenticacaoSmtp;
                List<System.Net.Mail.Attachment> anexos = null;
                string corpo = $@"
                Olá {fornecedor.Descricao}, <br>
                A carga {carga.CodigoCargaEmbarcador}, com coleta prevista para o dia {agendamentoColeta.DataColeta?.ToString("dd/MM/yyyy HH:mm") ?? ""}, foi confirmada pelo transportador ({(carga.Empresa?.CNPJ_Formatado ?? "")}) {carga.Empresa?.Descricao ?? ""}.<br>
                <b>Motorista(s):</b> {carga.DadosSumarizados?.Motoristas ?? ""} <b>CPF:</b> {string.Join(", ", carga.Motoristas?.Select(x => x.CPF_Formatado))}<br>
                <b>Placa(s):</b> {carga.ObterPlacasComDescricao()}<b>
                ";

                foreach (string para in emails.Distinct())
                {
                    if (!Servicos.Email.EnviarEmail(de, login, senha, para, copiaOcultaPara, copiaPara, assuntoEmail, corpo, servidorSMTP, out string erro, configuracaoEmail.DisplayEmail, anexos, assinatura, possuiSSL, string.Empty, 0, unitOfWork))
                        Log.TratarErro(erro, "notificao_fornecedor_por_email");
                }
            }
        }

        public void ValidarEmissaoDocumentosCarga(int codigoCarga, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, string webServiceConsultaCTe, int tipoEnvio, bool controlarTempoLimiteEmissao)
        {
            string retorno = "";

            Servicos.Embarcador.Carga.RateioFrete serFreteRateio = new RateioFrete(unitOfWork);
            Servicos.Embarcador.Carga.RateioNotaFiscal serRateioNotaFiscal = new RateioNotaFiscal(unitOfWork);
            Servicos.Embarcador.Carga.MensagemAlertaCarga servicoMensagemAlerta = new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork);
            Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota servicoCargaValePedagioRota = new ValePedagio.CargaValePedagioRota(unitOfWork);

            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Configuracoes.IntegracaoMicDta repIntegracaoMicDta = new Repositorio.Embarcador.Configuracoes.IntegracaoMicDta(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoComponentesFrete repCargaPedidoComponenteFrete = new Repositorio.Embarcador.Cargas.CargaPedidoComponentesFrete(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao repPedidoCTeParaSubContratacao = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao(unitOfWork);
            Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio repCargaValePedagio = new Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoCargaCalculoFrete repConfiguracaoCargaCalculoFrete = new Repositorio.Embarcador.Configuracoes.ConfiguracaoCargaCalculoFrete(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoMicDta integracaoMicDta = repIntegracaoMicDta.BuscarPrimeiroRegistro();
            Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigoFetch(codigoCarga);

            try
            {
                if (carga.CalculandoFrete)
                {
                    Servicos.Log.TratarErro($"Carga {carga.CodigoCargaEmbarcador} em processo de cálculo de frete. Não sendo possível iniciar Emissão Documentos.");
                    return;
                }

                if (carga.ValorFreteOperador == 0 && carga.ObrigatorioInformarValorFreteOperador)
                {
                    servicoMensagemAlerta.Adicionar(carga, TipoMensagemAlerta.CargaSemValorFreteOperador, "Valor do frete não informado");
                    return;
                }

                if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador && configuracaoTMS.ExigirRotaRoteirizadaNaCarga && carga.Rota != null)
                {
                    if (new Servicos.Embarcador.Logistica.RestricaoRodagem(unitOfWork).IsPossuiRestricaoZonaExclusaoRota(carga.Rota.PolilinhaRota))
                    {
                        Servicos.Log.TratarErro($"Polilinha Rota Frete {carga.Rota.Descricao} não gerada para a carga {carga.CodigoCargaEmbarcador} ou violando uma Zona de Restrição de Rota.");

                        carga.SituacaoCarga = SituacaoCarga.CalculoFrete;
                        carga.CalculandoFrete = true;
                        carga.PossuiPendencia = true;
                        carga.SituacaoRoteirizacaoCarga = SituacaoRoteirizacao.SemDefinicao;
                        carga.MotivoPendencia = "Rota com restrição ou não gerada.";
                        repCarga.Atualizar(carga);
                        if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete)
                            Servicos.Log.TratarErro("Atualizou a situação para calculo frete 50 Carga " + carga.CodigoCargaEmbarcador, "AtualizouSituacaoCalculoFrete");
                        return;
                    }
                }

                if (carga.SituacaoCarga == SituacaoCarga.Cancelada || carga.SituacaoCarga == SituacaoCarga.Anulada)
                {
                    Servicos.Log.TratarErro("Carga Cancelada após autorização de emissão.");
                    return;
                }

                servicoMensagemAlerta.Remover(carga, TipoMensagemAlerta.ProblemaEmissaoCarga);
                ValidarEmissaoCargaComValorZerado(carga, configuracaoTMS, unitOfWork);

                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = (from obj in repCargaPedido.BuscarPorCarga(carga.Codigo, TipoPedido.Entrega) where (!obj.PedidoSemNFe || (obj.PedidoSemNFe == true && obj.IndicadorCTeGlobalizadoDestinatario)) select obj).ToList();

                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosNaoEmitidos = (from obj in cargaPedidos where !obj.CTesEmitidos select obj).ToList();
                bool emitindoCtesSubcontratacaoFilialEmissora = false;
                bool enviouTodasNF = true;

                if (carga.EmpresaFilialEmissora != null && carga.LiberadaParaEmissaoCTeSubContratacaoFilialEmissora)
                {
                    emitindoCtesSubcontratacaoFilialEmissora = true;
                    cargaPedidosNaoEmitidos = (from obj in cargaPedidos where !obj.CTesFilialEmissoraEmitidos select obj).ToList();
                }

                if (carga.CargaEmitidaParcialmente)
                    cargaPedidosNaoEmitidos = (from obj in cargaPedidosNaoEmitidos where obj.SituacaoEmissao == SituacaoNF.NFEnviada select obj).ToList();

                //validação para cargas de subtrecho nao emitirem cte (o cte deve ser emitido na carga pai)
                if (carga.DadosSumarizados?.CargaTrecho == CargaTrechoSumarizada.SubCarga && cargaPedidosNaoEmitidos.Count > 0)
                {
                    carga.AguardandoEmissaoDocumentoAnterior = true;
                    repCarga.Atualizar(carga);
                    return;
                }

                List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedidoNotaFiscal> cargaPedidoNotaFiscals = repPedidoXMLNotaFiscal.BuscarPedidoXMLNotaFiscal(carga.Codigo);
                List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedidoCteSubContratacao> pedidoCteSubContratacaos = repPedidoCTeParaSubContratacao.BuscarPedidoCTeParaSubContratacao(carga.Codigo);
                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cp in cargaPedidosNaoEmitidos)
                {
                    if (cp.PedidoSemNFe)
                        continue;

                    Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga tipoContrato = cp.TipoContratacaoCarga;

                    if (cp.CargaPedidoFilialEmissora && emitindoCtesSubcontratacaoFilialEmissora)
                        tipoContrato = cp.TipoContratacaoCargaSubContratacaoFilialEmissora;

                    int NumeroNF = (from obj in cargaPedidoNotaFiscals where obj.CargaPedido == cp.Codigo select obj).Count(); //repPedidoXMLNotaFiscal.ContarPorCargaPedido(cp.Codigo);
                    if (tipoContrato == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro
                        || tipoContrato == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada
                        || tipoContrato == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho
                        || tipoContrato == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMProprio
                        || tipoContrato == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario)
                        NumeroNF = (from obj in pedidoCteSubContratacaos where obj.CargaPedido == cp.Codigo select obj).Count(); //repPedidoCTeParaSubContratacao.ContarPorCargaPedido(cp.Codigo);

                    if ((NumeroNF == 0 && tipoContrato == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.NormalESubContratada))
                        NumeroNF = (from obj in pedidoCteSubContratacaos where obj.CargaPedido == cp.Codigo select obj).Count();//repPedidoCTeParaSubContratacao.ContarPorCargaPedido(cp.Codigo);

                    if (NumeroNF == 0)
                    {
                        enviouTodasNF = false;
                        break;
                    }
                }

                Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoCargaCalculoFrete configuracaoCargaCalculoFrete = repConfiguracaoCargaCalculoFrete.BuscarConfiguracaoPadrao();
                bool valorFreteExcedido = false;
                if (configuracaoCargaCalculoFrete != null && configuracaoCargaCalculoFrete.ValorMaximoCalculoFrete > 0m && carga.ValorFreteAPagar > configuracaoCargaCalculoFrete.ValorMaximoCalculoFrete)
                    valorFreteExcedido = true;

                if (configuracaoCargaCalculoFrete != null && (carga.TipoOperacao?.ConfiguracaoCalculoFrete?.ValorMaximoCalculoFrete ?? 0m) > 0m && carga.ValorFreteAPagar > carga.TipoOperacao.ConfiguracaoCalculoFrete.ValorMaximoCalculoFrete)
                    valorFreteExcedido = true;

                if (carga.Empresa == null && carga.ExigeNotaFiscalParaCalcularFrete && !(carga?.TipoOperacao?.ConfiguracaoAgendamentoColetaEntrega?.ObrigarInformarCTePortalFornecedor ?? false))
                {
                    Servicos.Log.TratarErro("Carga codigo " + carga.Codigo.ToString() + " sem transportador.");

                    carga.SituacaoCarga = SituacaoCarga.Nova;
                    repCarga.Atualizar(carga);
                }
                else if (enviouTodasNF && !valorFreteExcedido)
                {
                    bool permitirEmissaoCargaParcialmente = (configuracaoTMS.PermiteEmitirCargaDiferentesOrigensParcialmente || (carga.TipoOperacao?.PermiteEmitirCargaDiferentesOrigensParcialmente ?? false));

                    if (permitirEmissaoCargaParcialmente && (carga.DadosSumarizados.CargaTrecho != CargaTrechoSumarizada.Agrupadora) && !cargaPedidos.Any(o => o.CTeEmitidoNoEmbarcador) && !carga.NaoGerarMDFe && !(carga.Filial?.EmitirMDFeManualmente ?? false) && !(carga.TipoOperacao?.NaoEmitirMDFe ?? false))
                    {
                        Repositorio.Embarcador.Cargas.CargaMDFe repositorioCargaMDFe = new Repositorio.Embarcador.Cargas.CargaMDFe(unitOfWork);
                        Servicos.Embarcador.Carga.MDFe servicoCargaMDFe = new Servicos.Embarcador.Carga.MDFe(unitOfWork);
                        List<Dominio.Entidades.Embarcador.Cargas.CargaMDFe> cargaMDFes = repositorioCargaMDFe.BuscarAutorizadosEmitidoNoMultiCTePorCarga(carga.Codigo);

                        foreach (Dominio.Entidades.Embarcador.Cargas.CargaMDFe cargaMDFe in cargaMDFes)
                        {
                            Dominio.ObjetosDeValor.Embarcador.Carga.DadosEncerramentoMDFe dadosEncerramento = servicoCargaMDFe.ObterDadosEncerramento(cargaMDFe.Codigo, unitOfWork);

                            servicoCargaMDFe.EncerrarMDFe(dadosEncerramento.Codigo, carga.Codigo, dadosEncerramento.Localidades[0].Codigo, dadosEncerramento.DataEncerramento, webServiceConsultaCTe, null, tipoServicoMultisoftware, unitOfWork, null);
                            Servicos.Auditoria.Auditoria.AuditarSemDadosUsuario(carga, $"Solicitou o encerramento do MDF-e {cargaMDFe.MDFe.Numero} ao iniciar a emissão dos documento.", unitOfWork);
                        }
                    }

                    unitOfWork.Start();

                    servicoCargaValePedagioRota.RemoverValePedagioCargaSeTabelaIgnorarValePedagio(carga);
                    servicoCargaValePedagioRota.RemoverValePedagioCargaSeInformadoManualmenteNaCarga(carga, configuracaoTMS, unitOfWork);
                    servicoCargaValePedagioRota.RemoverValePedagioCargaSeOperadorOptarPorNaoComprar(carga);

                    if (carga.ExigeNotaFiscalParaCalcularFrete)
                        Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota.ValidarCompraValePedagioComIntegracaoValorPedagioEmbarcador(carga, unitOfWork, StringConexao, configuracaoTMS, tipoServicoMultisoftware);

                    if (!carga.LiberadaParaEmissaoCTeSubContratacaoFilialEmissora)
                    {
                        if (carga.CargaDePreCarga)
                        {
                            carga.CargaDePreCarga = false;

                            if (!configuracaoTMS.TrocarPreCargaPorCarga)
                            {
                                carga.CargaDePreCargaEmFechamento = false;
                                carga.CargaDePreCargaFechada = true;
                            }
                        }

                        if ((carga.TipoOperacao?.TipoConsolidacao == EnumTipoConsolidacao.PreCheckIn) || (carga.TipoOperacao?.ConfiguracaoCalculoFrete?.RatearValorFreteEntrePedidosAposReceberDocumentos ?? false))
                            serFreteRateio.RatearValorDoFrenteEntrePedidos(carga, cargaPedidos, configuracaoTMS, false, unitOfWork, tipoServicoMultisoftware);

                        if (!carga.ExigeNotaFiscalParaCalcularFrete)
                        {
                            Servicos.Log.TratarErro("1.1 - Carga: " + carga.Codigo + " Iniciou RatearFreteCargaPedidoEntreNotas", "ValidarEmissaoDocumentosCarga");
                            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete> cargaPedidosComponentesFreteCarga = repCargaPedidoComponenteFrete.BuscarPorCarga(carga.Codigo, false);
                            serRateioNotaFiscal.RatearFreteCargaPedidoEntreNotas(carga, cargaPedidosNaoEmitidos, cargaPedidosComponentesFreteCarga, false, tipoServicoMultisoftware, unitOfWork, configuracaoTMS);

                            if (carga.EmpresaFilialEmissora != null)
                            {
                                List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete> cargaPedidosComponentesFreteCargaFilialEmissora = repCargaPedidoComponenteFrete.BuscarPorCarga(carga.Codigo, true);
                                serRateioNotaFiscal.RatearFreteCargaPedidoEntreNotas(carga, cargaPedidosNaoEmitidos, cargaPedidosComponentesFreteCargaFilialEmissora, true, tipoServicoMultisoftware, unitOfWork, configuracaoTMS);
                            }

                            Servicos.Log.TratarErro("1.2 - Carga: " + carga.Codigo + " Finalizou RatearFreteCargaPedidoEntreNotas", "ValidarEmissaoDocumentosCarga");
                        }

                        if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador)
                        {
                            AdicionarIntegracaoOpenTech(carga, unitOfWork);
                            AdicionarIntegracaoBuonny(carga, unitOfWork);
                        }

                        AdicionarIntegracaoTrafegus(carga, unitOfWork);

                        Servicos.Embarcador.Integracao.IntegracaoCarga.AdicionarIntegracoesCarga(carga, cargaPedidos, tipoServicoMultisoftware, unitOfWork, true);

                        carga.VeiculoIntegradoEmbarcador = true;
                    }

                    carga.ControlaTempoParaEmissao = controlarTempoLimiteEmissao;

                    if (!carga.DataInicioGeracaoCTes.HasValue)
                        carga.DataInicioGeracaoCTes = DateTime.Now;

                    if (carga.TabelaFrete == null)
                    {
                        GerarOcorrenciaSemTabelaFrente(carga, cargaPedidos, unitOfWork, tipoServicoMultisoftware);
                    }

                    repCarga.Atualizar(carga);
                    unitOfWork.CommitChanges();

                    Servicos.Embarcador.Carga.CTe serCargaCTe = new Servicos.Embarcador.Carga.CTe(unitOfWork);
                    Servicos.Embarcador.Carga.NFe serCargaNFe = new Servicos.Embarcador.Carga.NFe(unitOfWork);
                    Servicos.Embarcador.Carga.MICDTA serMICDTA = new Servicos.Embarcador.Carga.MICDTA(unitOfWork);

                    Servicos.Log.TratarErro("2 - Carga " + carga.Codigo + " CargaPedidosNaoEmitidos" + (cargaPedidosNaoEmitidos?.Count() ?? 0).ToString(), "SolicitarEmissaoDocumentosAutorizados");

                    //não remover o trecho abaixo foi criado para resolver um session close.
                    List<Dominio.Entidades.Veiculo> reboques = carga.VeiculosVinculados.ToList();

                    if (PermitirEmitirCTe(carga, configuracaoTMS))
                        retorno += serCargaCTe.EmitirCTE(cargaPedidosNaoEmitidos, carga, unitOfWork, tipoServicoMultisoftware, webServiceConsultaCTe, tipoEnvio);

                    if (configuracaoTMS.EmitirNFeRemessaNaCarga && carga != null && carga.TipoOperacao != null && carga.TipoOperacao.EmitirNFeRemessa == true)
                        retorno += serCargaNFe.EmitirNFeRemessa(cargaPedidosNaoEmitidos, carga, unitOfWork, tipoServicoMultisoftware, configuracaoTMS, webServiceConsultaCTe, tipoEnvio);

                    if ((integracaoMicDta?.PossuiIntegracao ?? false) && (integracaoMicDta?.GerarIntegracaNaEtapaDoFrete ?? false) && (carga.TipoOperacao?.RealizarIntegracaoComMicDta ?? false))
                        retorno += serMICDTA.EmitirMICDTA(cargaPedidosNaoEmitidos, carga, unitOfWork, tipoServicoMultisoftware, configuracaoTMS);

                    if (carga?.ContratoFreteTransportador != null)
                        Embarcador.Frete.ContratoFreteTransportador.RatearContratoSaldoMesCTes(carga, unitOfWork);

                    Servicos.Log.TratarErro("10 - Carga " + carga.Codigo + " EmitirCTE retorno: " + retorno.ToString(), "SolicitarEmissaoDocumentosAutorizados");

                    bool situacaoEmissaoDocumentos = true;

                    repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
                    repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

                    foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidosNaoEmitidos)
                    {
                        if (cargaPedido.ValorFrete > 0 || tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                        {
                            bool somentePedidosFilialEmissora = false;
                            if (carga.EmpresaFilialEmissora != null && !carga.LiberadaParaEmissaoCTeSubContratacaoFilialEmissora)
                                somentePedidosFilialEmissora = true;

                            if (cargaPedido.Carga.CargaSVM && cargaPedido.Carga.CargaRecebidaDeIntegracao && cargaPedido.CTeEmitidoNoEmbarcador)
                            {
                                situacaoEmissaoDocumentos = true;
                                break;
                            }
                            int qtdCargaPedidoSemCTe = repPedidoXMLNotaFiscal.ContarPorCargaPedidoSemCTe(cargaPedido.Codigo, somentePedidosFilialEmissora);
                            if (qtdCargaPedidoSemCTe > 0 && carga.TipoFreteEscolhido != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Cliente && !configuracaoTMS.NaoEmitirDocumentoNasCargas)
                            { //existem notas sem ct-es, então a carga deve continuar em emissão
                                if (cargaPedido.PossuiCTe || cargaPedido.PossuiNFS)
                                {
                                    Servicos.Log.TratarErro("10.1 - Carga: " + carga.Codigo + " Quantidade PedidosXMLNotaFiscal sem CTE: " + qtdCargaPedidoSemCTe, "SolicitarEmissaoDocumentosAutorizados");
                                    situacaoEmissaoDocumentos = false;
                                    break;
                                }
                            }
                        }
                    }

                    if (situacaoEmissaoDocumentos)
                    {
                        Repositorio.ConhecimentoDeTransporteEletronico repCte = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
                        Repositorio.Embarcador.Cargas.CargaCTe repCargaCte = new Repositorio.Embarcador.Cargas.CargaCTe(unitOfWork);

                        unitOfWork.Start();

                        if (!emitindoCtesSubcontratacaoFilialEmissora)
                        {
                            repCargaPedido.InformarCTesEmitidos(carga.Codigo);

                            if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
                                Servicos.Embarcador.Pedido.Pedido.AtualizarSituacaoPlanejamentoPedidoTMS(carga, null, SituacaoPlanejamentoPedidoTMS.CargaGerouDocumentacao, unitOfWork);
                            //repCargaPedido.InformarCTesEmitidosPedido(carga.Codigo);
                        }
                        else
                            repCargaPedido.InformarCTesFilialEmissoraEmitidos(carga.Codigo);

                        carga = repCarga.BuscarPorCodigo(carga.Codigo);

                        carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.PendeciaDocumentos;
                        carga.EmEmissaoCTeSubContratacaoFilialEmissora = false;

                        List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> ctesDaCarga = repCargaCte.BuscarCTePorCarga(carga.Codigo);
                        foreach (Dominio.Entidades.ConhecimentoDeTransporteEletronico cte in ctesDaCarga)
                        {
                            if (cte == null)
                                continue;
                            cte.UsuarioEmissaoCTe = carga?.Operador;
                            repCte.Atualizar(cte);
                        }

                        if ((carga.Empresa?.ValidarTransportadorContribuinte ?? false) && (!(carga.Empresa?.Contribuinte ?? false) || (!carga.Empresa.DataValidadeContribuinte.HasValue || carga.Empresa.DataValidadeContribuinte < DateTime.Now)))
                        {
                            carga.PossuiPendencia = true;
                            carga.PendenciaDocumentoTransportador = true;
                            carga.MotivoPendencia = "Necessário Informar os documentos do transportador";
                        }

                        if (carga.AgImportacaoCTe)
                        {
                            if (repCargaValePedagio.VerificarExistePorCargaAgIntegracao(carga.Codigo))//|| repCargaConsultaValorPedagioIntegracao.VerificarExistePorCargaAgIntegracao(carga.Codigo))
                            {
                                carga.IntegrandoValePedagio = true;
                                carga.ProblemaIntegracaoValePedagio = false;
                                repCarga.Atualizar(carga);
                            }
                            else
                                Servicos.Embarcador.Carga.PreCTe.VerificarSeLiberaCargaSemIntegrarCTes(carga);
                        }

                        if (carga.TipoOperacao?.TipoConsolidacao == EnumTipoConsolidacao.PreCheckIn && carga.DadosSumarizados?.CargaTrecho == CargaTrechoSumarizada.Agrupadora)
                        {
                            TransferirCtesEmitidosParaCargasDeSubTrecho(carga, unitOfWork);
                            Servicos.Log.TratarErro("13 - Transferiu CTE EMITIDO " + carga.Codigo, "SolicitarEmissaoDocumentosAutorizados");
                        }

                        repCarga.Atualizar(carga);

                        AdicionarSaldoContratoPrestacaoServico(carga, unitOfWork);

                        unitOfWork.CommitChanges();

                        Servicos.Log.TratarErro("14 - FIM " + carga.Codigo, "SolicitarEmissaoDocumentosAutorizados");
                    }
                    else
                    {
                        throw new ServicoException("A carga não será emitida devido a Situação de Emissão dos Documentos não estar Autorizada.");
                    }
                }
                else
                {
                    if (!valorFreteExcedido)
                    {
                        Servicos.Log.TratarErro("Limpou DataEnvioUltimaNFe carga codigo " + carga.Codigo, "DataEnvioUltimaNFe");
                        carga.SituacaoCarga = SituacaoCarga.AgNFe;
                    }
                    else
                        carga.SituacaoCarga = SituacaoCarga.CalculoFrete;

                    carga.DataEnvioUltimaNFe = null;
                    carga.DataInicioEmissaoDocumentos = null;
                    repCarga.Atualizar(carga);
                }
            }
            catch (ServicoException excecao)
            {
                servicoMensagemAlerta.Adicionar(carga, TipoMensagemAlerta.ProblemaEmissaoCarga, excecao.Message);

                carga.DataEnvioUltimaNFe = null;
                carga.DataInicioEmissaoDocumentos = null;
                carga.SituacaoCarga = carga.ExigeNotaFiscalParaCalcularFrete ? SituacaoCarga.CalculoFrete : SituacaoCarga.AgNFe;

                repCarga.Atualizar(carga);
            }
        }
        public string BuscarPendenciaConfiguracaoFaturamentoTomador(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao)
        {
            if (configuracao.ValidarConfiguracaoFaturamentoTomador && carga != null && carga.Pedidos != null && carga.Pedidos.Count > 0)
            {
                Repositorio.Embarcador.Configuracoes.AcordoFaturamentoCliente repAcordo = new Repositorio.Embarcador.Configuracoes.AcordoFaturamentoCliente(unitOfWork);

                List<string> mensagensAlerta = new List<string>();
                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in carga.Pedidos)
                {
                    if (cargaPedido != null && cargaPedido.TipoCobrancaMultimodal != TipoCobrancaMultimodal.BLLongoCurso)
                    {
                        bool contemConfiguracao = false;
                        Dominio.Entidades.Cliente tomadorPedido = cargaPedido.ObterTomador();
                        if (tomadorPedido != null)
                        {
                            bool naoValidarPossuiAcordoFaturamentoAvancoCarga = tomadorPedido.GrupoPessoas?.NaoValidarPossuiAcordoFaturamentoAvancoCarga ?? false;
                            contemConfiguracao = (configuracao.UtilizaEmissaoMultimodal || naoValidarPossuiAcordoFaturamentoAvancoCarga) ? repAcordo.ContemAcordoFaturamentoCliente(tomadorPedido.CPF_CNPJ, 0) : false;
                            if (!contemConfiguracao)
                            {
                                contemConfiguracao = tomadorPedido.GerarFaturamentoAVista || tomadorPedido.GerarTituloPorDocumentoFiscal || tomadorPedido.GerarTituloAutomaticamente;
                                if (!contemConfiguracao && tomadorPedido.DiasSemanaFatura != null && tomadorPedido.DiasSemanaFatura.Count > 0)
                                    contemConfiguracao = true;
                                if (!contemConfiguracao && tomadorPedido.DiasMesFatura != null && tomadorPedido.DiasMesFatura.Count > 0)
                                    contemConfiguracao = true;
                                if (!contemConfiguracao && tomadorPedido.DiasDePrazoFatura > 0)
                                    contemConfiguracao = true;
                                if (!contemConfiguracao && tomadorPedido.GrupoPessoas != null)
                                {
                                    contemConfiguracao = (configuracao.UtilizaEmissaoMultimodal || naoValidarPossuiAcordoFaturamentoAvancoCarga) ? repAcordo.ContemAcordoFaturamentoCliente(0, tomadorPedido.GrupoPessoas.Codigo) : false;
                                    if (!contemConfiguracao)
                                    {
                                        contemConfiguracao = tomadorPedido.GrupoPessoas.GerarFaturamentoAVista || tomadorPedido.GrupoPessoas.GerarTituloPorDocumentoFiscal || tomadorPedido.GrupoPessoas.GerarTituloAutomaticamente;
                                        if (!contemConfiguracao && tomadorPedido.GrupoPessoas.DiasSemanaFatura != null && tomadorPedido.GrupoPessoas.DiasSemanaFatura.Count > 0)
                                            contemConfiguracao = true;
                                        if (!contemConfiguracao && tomadorPedido.GrupoPessoas.DiasMesFatura != null && tomadorPedido.GrupoPessoas.DiasMesFatura.Count > 0)
                                            contemConfiguracao = true;
                                        if (!contemConfiguracao && tomadorPedido.GrupoPessoas.DiasDePrazoFatura > 0)
                                            contemConfiguracao = true;
                                    }
                                }
                                if (!contemConfiguracao)
                                    mensagensAlerta.Add("O Tomador " + tomadorPedido.Descricao + " não possui configuração de fatura, favor verifique antes de avançar a carga.");
                            }
                        }
                    }
                }
                if (mensagensAlerta != null && mensagensAlerta.Count > 0)
                    return string.Join("<br /> ", mensagensAlerta.ToList());
            }
            return "";
        }

        public string VerificarOperadorPodeConfigurarCarga(Dominio.Entidades.Usuario usuario, Dominio.Entidades.Embarcador.Cargas.Carga carga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unidadeTrabalho = null)
        {
            string retorno = "";

            if (unidadeTrabalho == null)
                unidadeTrabalho = new Repositorio.UnitOfWork(StringConexao);

            if (usuario == null)
                return "";

            Repositorio.Embarcador.Operacional.OperadorLogistica repOperadorLogistica = new Repositorio.Embarcador.Operacional.OperadorLogistica(unidadeTrabalho);
            Dominio.Entidades.Embarcador.Operacional.OperadorLogistica operadorLogistica = repOperadorLogistica.BuscarPorUsuario(usuario.Codigo);

            if (tipoServicoMultisoftware != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe && tipoServicoMultisoftware != TipoServicoMultisoftware.Fornecedor)
            {
                if (operadorLogistica != null)
                {
                    if (carga.Operador != null && !operadorLogistica.SupervisorLogistica && carga.Operador.Codigo != usuario.Codigo)
                    {
                        retorno = "Não é possível alterar a carga pois a mesma já está sendo configurada pelo operador " + carga.Operador.Nome + ".";
                    }
                }
                else
                {
                    retorno = "Somente um operador da logistica pode configurar a carga.";
                }
            }

            return retorno;
        }

        public void FecharCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, AdminMultisoftware.Dominio.Entidades.Pessoas.Cliente ClienteMultisoftware, bool recriarRotas = false, bool adicionarJanelaDescarregamento = true, bool adicionarJanelaCarregamento = true, bool validarDados = false, bool gerarAgendamentoColeta = true, Dominio.ObjetosDeValor.Embarcador.Carga.PropriedadesGeracaoCarga propriedades = null, bool notificarAcompanhamento = true, bool viaWSAtualizarCarga = false, string ip = "", bool viaWSRest = false)
        {
            FecharCarga servicoFecharCarga = new FecharCarga(unitOfWork);
            servicoFecharCarga.FecharCargaAsync(carga, tipoServicoMultisoftware, ClienteMultisoftware, recriarRotas, adicionarJanelaDescarregamento, adicionarJanelaCarregamento, validarDados, gerarAgendamentoColeta, propriedades, notificarAcompanhamento, viaWSAtualizarCarga, ip, viaWSRest).GetAwaiter().GetResult();
        }

        public void TransferirCtesEmitidosParaCargasDeSubTrecho(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.StageAgrupamento repStageAgrupamento = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento> agrupamentoStageCarga = repStageAgrupamento.BuscarPorCargaDt(carga.Codigo);

            Repositorio.Embarcador.Cargas.CargaCTe repCargaCte = new Repositorio.Embarcador.Cargas.CargaCTe(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe repCargaPedidoXMLNotaFiscalCTe = new Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe(unitOfWork);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe> listaCargaPedidoXMLNotaFiscalCTe = repCargaPedidoXMLNotaFiscalCTe.BuscarPorCargaNaoReplicados(carga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento agrupamento in agrupamentoStageCarga)
            {
                if (agrupamento.CargaGerada == null)
                    continue;

                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe cargapedidoXmlNotaFiscalCte in listaCargaPedidoXMLNotaFiscalCTe)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoCargaFilho = repCargaPedido.BuscarPorCargaEPedido(agrupamento.CargaGerada.Codigo, cargapedidoXmlNotaFiscalCte.PedidoXMLNotaFiscal?.CargaPedido?.Pedido?.Codigo ?? 0);

                    if (cargaPedidoCargaFilho != null)
                    {
                        //Enccontramos o cargapedido filho, dessa forma todos os carga pedidos dessa carga filho devem ficar como emitidos, assim como os proximos trechos
                        List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargasPedidosCargaFilho = repCargaPedido.BuscarPorCarga(agrupamento.CargaGerada.Codigo);
                        foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargasPedidosCargaFilho)
                            SetarCTEEmitidoCargaFilho(cargaPedido, unitOfWork);

                        Servicos.Log.TratarErro("11 - Carga Pedido Filho " + cargaPedidoCargaFilho.Codigo + " Cte emitido", "SolicitarEmissaoDocumentosAutorizados");

                        Dominio.Entidades.Embarcador.Cargas.CargaCTe cargaCteExiste = repCargaCte.BuscarPorCargaECTe(agrupamento.CargaGerada.Codigo, cargapedidoXmlNotaFiscalCte.CargaCTe?.CTe?.Codigo ?? 0);
                        if (cargaCteExiste == null)
                        {
                            Dominio.Entidades.Embarcador.Cargas.CargaCTe cargaCteClonado = cargapedidoXmlNotaFiscalCte.CargaCTe.Clonar();
                            Utilidades.Object.DefinirListasGenericasComoNulas(cargaCteClonado);

                            cargaCteClonado.Carga = agrupamento.CargaGerada;
                            cargaCteClonado.CargaOrigem = agrupamento.CargaGerada;
                            cargaCteClonado.CTe = cargapedidoXmlNotaFiscalCte.CargaCTe.CTe;
                            repCargaCte.Inserir(cargaCteClonado);

                            cargapedidoXmlNotaFiscalCte.CargaCTe.ReplicadoCargaFilho = true;
                            repCargaCte.Atualizar(cargapedidoXmlNotaFiscalCte.CargaCTe);

                            Servicos.Log.TratarErro("12 - CargaCTE clonado cargaFilho " + agrupamento.CargaGerada.Codigo, "SolicitarEmissaoDocumentosAutorizados");
                            List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> ListaPedidoXMlNotaFiscalFilho = repPedidoXMLNotaFiscal.BuscarPorCargaPedido(cargaPedidoCargaFilho.Codigo);

                            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoxmlNotaFiscal in ListaPedidoXMlNotaFiscalFilho)
                            {
                                Dominio.Entidades.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe cargaPedidoXMLNotaFiscalTransbordo = new Dominio.Entidades.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe();
                                cargaPedidoXMLNotaFiscalTransbordo.PedidoXMLNotaFiscal = pedidoxmlNotaFiscal;
                                cargaPedidoXMLNotaFiscalTransbordo.CargaCTe = cargaCteClonado;
                                repCargaPedidoXMLNotaFiscalCTe.Inserir(cargaPedidoXMLNotaFiscalTransbordo);
                            }
                        }

                        agrupamento.CargaGerada.AguardandoEmissaoDocumentoAnterior = false; //libera a carga filho para seguir agora sem cargaPedidos para emitir
                        repCarga.Atualizar(agrupamento.CargaGerada);
                    }
                }

                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidoCargaFilhoSemNota = repCargaPedido.BuscarPorCarga(agrupamento.CargaGerada.Codigo, null, true, false, true);
                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoFilho in cargaPedidoCargaFilhoSemNota)
                {
                    if (cargaPedidoFilho.CTesEmitidos && cargaPedidoFilho.StageRelevanteCusto == null)
                        agrupamento.CargaGerada.AguardandoEmissaoDocumentoAnterior = false;//libera a carga filho para seguir agora sem cargaPedidos para emitir essas cargas são cargas sem irrelevancia
                }
            }
        }

        public void SetarValePedagioPedidoCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaValePedagio repCargaValePedagio = new Repositorio.Embarcador.Cargas.CargaValePedagio(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoValePedagio repPedidoValePedagio = new Repositorio.Embarcador.Pedidos.PedidoValePedagio(unitOfWork);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unitOfWork);

            IList<Dominio.ObjetosDeValor.MDFe.ValePedagio> listaValePedagio = repPedidoValePedagio.BuscarPorCarga(carga.Codigo);
            if (listaValePedagio != null && listaValePedagio.Count > 0)
            {
                foreach (Dominio.ObjetosDeValor.MDFe.ValePedagio valePedagio in listaValePedagio)
                {
                    double.TryParse(Utilidades.String.OnlyNumbers(valePedagio.CNPJFornecedor), out double cnpjFornecedor);
                    double.TryParse(Utilidades.String.OnlyNumbers(valePedagio.CNPJResponsavel), out double cnpjResponsavel);

                    Dominio.Entidades.Embarcador.Cargas.CargaValePedagio cargaValePedagioParaMDFe = new Dominio.Entidades.Embarcador.Cargas.CargaValePedagio();
                    cargaValePedagioParaMDFe.Carga = carga;
                    cargaValePedagioParaMDFe.Fornecedor = repCliente.BuscarPorCPFCNPJ(cnpjFornecedor);
                    cargaValePedagioParaMDFe.NumeroComprovante = valePedagio.NumeroComprovante;
                    cargaValePedagioParaMDFe.Valor = valePedagio.ValorValePedagio;
                    cargaValePedagioParaMDFe.Responsavel = repCliente.BuscarPorCPFCNPJ(cnpjResponsavel);
                    cargaValePedagioParaMDFe.QuantidadeEixos = valePedagio.QuantidadeEixos;
                    cargaValePedagioParaMDFe.TipoCompra = valePedagio.TipoCompra.HasValue ? valePedagio.TipoCompra.Value : Dominio.Enumeradores.TipoCompraValePedagio.Tag;
                    repCargaValePedagio.Inserir(cargaValePedagioParaMDFe);
                }
            }
        }

        public async Task SetarValePedagioPedidoCargaAsync(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaValePedagio repCargaValePedagio = new Repositorio.Embarcador.Cargas.CargaValePedagio(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoValePedagio repPedidoValePedagio = new Repositorio.Embarcador.Pedidos.PedidoValePedagio(unitOfWork);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unitOfWork);

            IList<Dominio.ObjetosDeValor.MDFe.ValePedagio> listaValePedagio = repPedidoValePedagio.BuscarPorCarga(carga.Codigo);
            if (listaValePedagio != null && listaValePedagio.Count > 0)
            {
                foreach (Dominio.ObjetosDeValor.MDFe.ValePedagio valePedagio in listaValePedagio)
                {
                    double.TryParse(Utilidades.String.OnlyNumbers(valePedagio.CNPJFornecedor), out double cnpjFornecedor);
                    double.TryParse(Utilidades.String.OnlyNumbers(valePedagio.CNPJResponsavel), out double cnpjResponsavel);

                    Dominio.Entidades.Embarcador.Cargas.CargaValePedagio cargaValePedagioParaMDFe = new Dominio.Entidades.Embarcador.Cargas.CargaValePedagio();
                    cargaValePedagioParaMDFe.Carga = carga;
                    cargaValePedagioParaMDFe.Fornecedor = await repCliente.BuscarPorCPFCNPJAsync(cnpjFornecedor);
                    cargaValePedagioParaMDFe.NumeroComprovante = valePedagio.NumeroComprovante;
                    cargaValePedagioParaMDFe.Valor = valePedagio.ValorValePedagio;
                    cargaValePedagioParaMDFe.Responsavel = await repCliente.BuscarPorCPFCNPJAsync(cnpjResponsavel);
                    cargaValePedagioParaMDFe.QuantidadeEixos = valePedagio.QuantidadeEixos;
                    cargaValePedagioParaMDFe.TipoCompra = valePedagio.TipoCompra.HasValue ? valePedagio.TipoCompra.Value : Dominio.Enumeradores.TipoCompraValePedagio.Tag;
                    await repCargaValePedagio.InserirAsync(cargaValePedagioParaMDFe);
                }
            }
        }

        public void AlterarSegmentoCarga(ref Dominio.Entidades.Embarcador.Cargas.Carga carga)
        {
            if (carga.Veiculo != null && carga.Veiculo.VeiculosVinculados != null)
            {
                if (carga.Veiculo.VeiculosVinculados.Count == 0)
                {
                    carga.SegmentoGrupoPessoas = carga.Veiculo.GrupoPessoas != null ? carga.Veiculo.GrupoPessoas : null;
                    carga.SegmentoModeloVeicularCarga = carga.Veiculo.ModeloVeicularCarga != null ? carga.Veiculo.ModeloVeicularCarga : null;
                }
                else
                {
                    carga.SegmentoGrupoPessoas = carga.Veiculo.VeiculosVinculados.FirstOrDefault().GrupoPessoas != null ? carga.Veiculo.VeiculosVinculados.FirstOrDefault().GrupoPessoas : null;
                    carga.SegmentoModeloVeicularCarga = carga.Veiculo.VeiculosVinculados.FirstOrDefault().ModeloVeicularCarga != null ? carga.Veiculo.VeiculosVinculados.FirstOrDefault().ModeloVeicularCarga : null;
                }
            }
            else
            {
                carga.SegmentoGrupoPessoas = null;
                carga.SegmentoModeloVeicularCarga = null;
            }
        }

        public void AtualizarPendenciaDocumentoPortoPorto(Dominio.Entidades.Embarcador.Cargas.Carga carga, bool erro, string msgErro, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Configuracoes.IntegracaoIntercab repIntegracaoIntercab = new Repositorio.Embarcador.Configuracoes.IntegracaoIntercab(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            Servicos.Embarcador.Hubs.Carga serHubCarga = new Servicos.Embarcador.Hubs.Carga();
            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab = repIntegracaoIntercab.BuscarIntegracao();

            if (((integracaoIntercab?.HabilitarTimelineCargaPorta ?? false) || (integracaoIntercab?.HabilitarTimelineCargaPortoPorto ?? false)) && (carga.Pedidos?.Any(p => p.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto) ?? false))
            {
                carga.CargaPortoPortoPendenciaDocumento = erro;
                carga.MotivoCargaPortoPortoPendenciaDocumento = msgErro;
                repositorioCarga.Atualizar(carga);

                serHubCarga.InformarCargaAtualizada(carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoAcaoCarga.Alterada, unitOfWork.StringConexao);
            }
        }

        public bool AtualizarTipoServicoCargaMultimodal(Dominio.Entidades.Embarcador.CTe.CTeTerceiro cteIntegracao, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, Repositorio.UnitOfWork unitOfWork, out string msgRetorno)
        {
            msgRetorno = string.Empty;
            Servicos.Embarcador.Hubs.Carga serHubCarga = new Servicos.Embarcador.Hubs.Carga();

            if (cargaPedido == null || cargaPedido.Carga == null)
                return true;

            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            TipoServicoCarga? tipoServicoAtual = cargaPedido.Carga.TipoServicoCarga;
            TipoServicoCarga? tipoServicoModificar = null;

            if (cargaPedido.Pedido.TipoServicoCarga == TipoServicoCarga.Feeder)
            {
                cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.Redespacho;
                tipoServicoModificar = TipoServicoCarga.Feeder;
                cargaPedido.Redespacho = true;
            }
            else if (cargaPedido.Carga.TipoServicoCarga == TipoServicoCarga.SVMProprio)
            {
                cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.SVMProprio;
                tipoServicoModificar = TipoServicoCarga.SVMProprio;
            }
            else if (cargaPedido.Carga.TipoServicoCarga == TipoServicoCarga.Feeder)
            {
                cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.Redespacho;
                tipoServicoModificar = TipoServicoCarga.Feeder;
                cargaPedido.Redespacho = true;
            }
            else if (cteIntegracao != null && cteIntegracao.LocalidadeInicioPrestacao != null && cargaPedido.Pedido != null && cargaPedido.Pedido.OrigemBooking != null && cargaPedido.Pedido.DestinoBooking != null && cteIntegracao.LocalidadeInicioPrestacao.CodigoIBGE == cargaPedido.Pedido.OrigemBooking.CodigoIBGE && cteIntegracao.LocalidadeTerminoPrestacao.CodigoIBGE == cargaPedido.Pedido.DestinoBooking.CodigoIBGE)
            {
                cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.SubContratada;
                tipoServicoModificar = TipoServicoCarga.SubContratada;
            }
            else if (cteIntegracao != null &&
                (cargaPedido.Pedido.PedidoDeSVMTerceiro ||
                (cteIntegracao.LocalidadeInicioPrestacao != null && cargaPedido.Pedido != null &&
                ((cargaPedido.Pedido.OrigemBooking == null && cargaPedido.Pedido.DestinoBooking == null) ||
                (cteIntegracao.LocalidadeInicioPrestacao.CodigoIBGE != cargaPedido.Pedido.OrigemBooking.CodigoIBGE || cteIntegracao.LocalidadeTerminoPrestacao.CodigoIBGE != cargaPedido.Pedido.DestinoBooking.CodigoIBGE)))))
            {
                if (cteIntegracao.Modal == TipoModal.Multimodal)
                {
                    cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.SVMTerceiro;
                    tipoServicoModificar = TipoServicoCarga.SVMTerceiro;
                }
                else
                {
                    cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.RedespachoIntermediario;
                    tipoServicoModificar = TipoServicoCarga.RedespachoIntermediario;
                }
            }
            else if (cteIntegracao != null)
            {
                cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.SubContratada;
                tipoServicoModificar = TipoServicoCarga.SubContratada;
            }
            else
            {
                cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.Normal;
                tipoServicoModificar = TipoServicoCarga.Normal;
            }

            if (!tipoServicoAtual.HasValue || tipoServicoAtual.Value == TipoServicoCarga.Normal || tipoServicoAtual.Value == TipoServicoCarga.NaoInformado || tipoServicoAtual.Value == tipoServicoModificar.Value)
                cargaPedido.Carga.TipoServicoCarga = tipoServicoModificar;
            else
            {
                //msgRetorno = "Não é possível enviar um documento com o tipo de serviço diferente da carga. Serviço do doc: " + tipoServicoModificar.Value.ObterDescricao() + " Serviço da Carga: " + tipoServicoAtual.Value.ObterDescricao();
                msgRetorno = "Os CT-es associados a carga resultam em mais de um tipo de serviço, " + (tipoServicoModificar.HasValue ? tipoServicoModificar.Value.ObterDescricao() : "") + ", " + (tipoServicoAtual.HasValue ? tipoServicoAtual.Value.ObterDescricao() : "");
                return false;
            }

            cargaPedido.Carga.CargaSVMTerceiro = tipoServicoModificar == TipoServicoCarga.SVMTerceiro;

            repCarga.Atualizar(cargaPedido.Carga);
            this.SetarTipoContratacaoCarga(cargaPedido.Carga, unitOfWork);
            serHubCarga.InformarCargaAtualizada(cargaPedido.Carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoAcaoCarga.Alterada, unitOfWork.StringConexao);
            return true;
        }

        public bool AtualizarTipoServicoCargaMultimodal(Dominio.ObjetosDeValor.Embarcador.CTe.CTe cteIntegracao, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, out string msgRetorno, Repositorio.UnitOfWork unitOfWork)
        {
            msgRetorno = string.Empty;
            Servicos.Embarcador.Hubs.Carga serHubCarga = new Servicos.Embarcador.Hubs.Carga();

            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            TipoServicoCarga? tipoServicoAtual = cargaPedido.Carga.TipoServicoCarga;
            TipoServicoCarga? tipoServicoModificar = null;

            if (cargaPedido.Pedido.TipoServicoCarga == TipoServicoCarga.Feeder)
            {
                cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.Redespacho;
                tipoServicoModificar = TipoServicoCarga.Feeder;
                cargaPedido.Redespacho = true;
            }
            else if (cargaPedido.Carga.TipoServicoCarga == TipoServicoCarga.SVMProprio)
                cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.SVMProprio;
            else if (cargaPedido.Carga.TipoServicoCarga == TipoServicoCarga.Feeder)
            {
                cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.Redespacho;
                tipoServicoModificar = TipoServicoCarga.Feeder;
                cargaPedido.Redespacho = true;
            }
            else if (cteIntegracao != null && cteIntegracao.LocalidadeInicioPrestacao != null && cargaPedido.Pedido != null && cargaPedido.Pedido.OrigemBooking != null && cargaPedido.Pedido.DestinoBooking != null && cteIntegracao.LocalidadeInicioPrestacao.IBGE == cargaPedido.Pedido.OrigemBooking.CodigoIBGE && cteIntegracao.LocalidadeFimPrestacao.IBGE == cargaPedido.Pedido.DestinoBooking.CodigoIBGE)
            {
                cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.SubContratada;
                tipoServicoModificar = TipoServicoCarga.SubContratada;
            }
            else if (cteIntegracao != null &&
                (cargaPedido.Pedido.PedidoDeSVMTerceiro ||
                (cteIntegracao.LocalidadeInicioPrestacao != null && cargaPedido.Pedido != null &&
                ((cargaPedido.Pedido.OrigemBooking == null && cargaPedido.Pedido.DestinoBooking == null) ||
                (cteIntegracao.LocalidadeInicioPrestacao.IBGE != cargaPedido.Pedido.OrigemBooking.CodigoIBGE || cteIntegracao.LocalidadeFimPrestacao.IBGE != cargaPedido.Pedido.DestinoBooking.CodigoIBGE)))))
            {
                if (cteIntegracao.TipoModal == TipoModal.Multimodal)
                {
                    cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.SVMTerceiro;
                    tipoServicoModificar = TipoServicoCarga.SVMTerceiro;
                }
                else
                {
                    cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.RedespachoIntermediario;
                    tipoServicoModificar = TipoServicoCarga.RedespachoIntermediario;
                }
            }
            else if (cteIntegracao != null)
            {
                cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.SubContratada;
                tipoServicoModificar = TipoServicoCarga.SubContratada;
            }
            else
            {
                cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.Normal;
                tipoServicoModificar = TipoServicoCarga.Normal;
            }

            if (!tipoServicoAtual.HasValue || tipoServicoAtual.Value == TipoServicoCarga.Normal || tipoServicoAtual.Value == TipoServicoCarga.NaoInformado || tipoServicoAtual.Value == tipoServicoModificar.Value)
                cargaPedido.Carga.TipoServicoCarga = tipoServicoModificar;
            else
            {
                //msgRetorno = "Não é possível enviar um documento com o tipo de serviço diferente da carga. Serviço do doc: " + tipoServicoModificar.Value.ObterDescricao() + " Serviço da Carga: " + tipoServicoAtual.Value.ObterDescricao();
                msgRetorno = "Os CT-es associados a carga resultam em mais de um tipo de serviço, " + tipoServicoModificar.Value.ObterDescricao() + ", " + tipoServicoAtual.Value.ObterDescricao();
                return false;
            }

            cargaPedido.Carga.CargaSVMTerceiro = tipoServicoModificar == TipoServicoCarga.SVMTerceiro;

            repCarga.Atualizar(cargaPedido.Carga);
            this.SetarTipoContratacaoCarga(cargaPedido.Carga, unitOfWork);
            serHubCarga.InformarCargaAtualizada(cargaPedido.Carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoAcaoCarga.Alterada, unitOfWork.StringConexao);
            return true;
        }

        public void SetarTipoContratacaoCarga(Dominio.Entidades.Embarcador.Cargas.Carga cargaAtualizar, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga> tiposContratacaoCarga = null;

            if (cargaAtualizar.EmpresaFilialEmissora == null)
                tiposContratacaoCarga = repCargaPedido.BuscarTipoContratosPorCarga(cargaAtualizar.Codigo);
            else
                tiposContratacaoCarga = repCargaPedido.BuscarTipoContratosSubContratacaoFilialEmissoraPorCarga(cargaAtualizar.Codigo);

            if (tiposContratacaoCarga.Any(obj => obj == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Normal))
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Normal;
                if (cargaAtualizar.TipoServicoCarga != TipoServicoCarga.Feeder)
                    cargaAtualizar.TipoServicoCarga = TipoServicoCarga.Normal;
            }
            else if (tiposContratacaoCarga.Any(obj => obj == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.NormalESubContratada))
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.NormalESubContratada;
                if (cargaAtualizar.TipoServicoCarga != TipoServicoCarga.Feeder)
                    cargaAtualizar.TipoServicoCarga = TipoServicoCarga.NormalESubContratada;
            }
            else if (tiposContratacaoCarga.Any(obj => obj == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho))
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho;
                if (cargaAtualizar.TipoServicoCarga != TipoServicoCarga.Feeder)
                    cargaAtualizar.TipoServicoCarga = TipoServicoCarga.Redespacho;
            }
            else if (tiposContratacaoCarga.Any(obj => obj == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario))
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario;
                if (cargaAtualizar.TipoServicoCarga != TipoServicoCarga.Feeder)
                    cargaAtualizar.TipoServicoCarga = TipoServicoCarga.RedespachoIntermediario;
            }
            else if (tiposContratacaoCarga.Any(obj => obj == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada))
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada;
                if (cargaAtualizar.TipoServicoCarga != TipoServicoCarga.Feeder)
                    cargaAtualizar.TipoServicoCarga = TipoServicoCarga.SubContratada;
            }
            else if (tiposContratacaoCarga.Any(obj => obj == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMProprio))
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMProprio;
                if (cargaAtualizar.TipoServicoCarga != TipoServicoCarga.Feeder)
                    cargaAtualizar.TipoServicoCarga = TipoServicoCarga.SVMProprio;
            }
            else if (tiposContratacaoCarga.Any(obj => obj == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro))
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro;
                if (cargaAtualizar.TipoServicoCarga != TipoServicoCarga.Feeder)
                    cargaAtualizar.TipoServicoCarga = TipoServicoCarga.SVMTerceiro;
            }
            else
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Normal;
                cargaAtualizar.TipoServicoCarga = TipoServicoCarga.Normal;
            }

            repCarga.Atualizar(cargaAtualizar);
        }

        public async Task SetarTipoContratacaoCargaAsync(Dominio.Entidades.Embarcador.Cargas.Carga cargaAtualizar, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga> tiposContratacaoCarga = null;

            if (cargaAtualizar.EmpresaFilialEmissora == null)
                tiposContratacaoCarga = repCargaPedido.BuscarTipoContratosPorCarga(cargaAtualizar.Codigo);
            else
                tiposContratacaoCarga = repCargaPedido.BuscarTipoContratosSubContratacaoFilialEmissoraPorCarga(cargaAtualizar.Codigo);

            if (tiposContratacaoCarga.Any(obj => obj == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Normal))
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Normal;
                if (cargaAtualizar.TipoServicoCarga != TipoServicoCarga.Feeder)
                    cargaAtualizar.TipoServicoCarga = TipoServicoCarga.Normal;
            }
            else if (tiposContratacaoCarga.Any(obj => obj == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.NormalESubContratada))
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.NormalESubContratada;
                if (cargaAtualizar.TipoServicoCarga != TipoServicoCarga.Feeder)
                    cargaAtualizar.TipoServicoCarga = TipoServicoCarga.NormalESubContratada;
            }
            else if (tiposContratacaoCarga.Any(obj => obj == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho))
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho;
                if (cargaAtualizar.TipoServicoCarga != TipoServicoCarga.Feeder)
                    cargaAtualizar.TipoServicoCarga = TipoServicoCarga.Redespacho;
            }
            else if (tiposContratacaoCarga.Any(obj => obj == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario))
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario;
                if (cargaAtualizar.TipoServicoCarga != TipoServicoCarga.Feeder)
                    cargaAtualizar.TipoServicoCarga = TipoServicoCarga.RedespachoIntermediario;
            }
            else if (tiposContratacaoCarga.Any(obj => obj == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada))
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada;
                if (cargaAtualizar.TipoServicoCarga != TipoServicoCarga.Feeder)
                    cargaAtualizar.TipoServicoCarga = TipoServicoCarga.SubContratada;
            }
            else if (tiposContratacaoCarga.Any(obj => obj == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMProprio))
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMProprio;
                if (cargaAtualizar.TipoServicoCarga != TipoServicoCarga.Feeder)
                    cargaAtualizar.TipoServicoCarga = TipoServicoCarga.SVMProprio;
            }
            else if (tiposContratacaoCarga.Any(obj => obj == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro))
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro;
                if (cargaAtualizar.TipoServicoCarga != TipoServicoCarga.Feeder)
                    cargaAtualizar.TipoServicoCarga = TipoServicoCarga.SVMTerceiro;
            }
            else
            {
                cargaAtualizar.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Normal;
                cargaAtualizar.TipoServicoCarga = TipoServicoCarga.Normal;
            }

            await repCarga.AtualizarAsync(cargaAtualizar);
        }

        public string ValidarSeCargaEstaAptaParaCancelamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, string motivoDoCancelamento, Repositorio.UnitOfWork unitOfWork)
        {
            if (carga == null)
                return "O codigo da carga informado é inválido.";

            if (motivoDoCancelamento.Length < 20)
                return "Para solicitar o cancelamento da carga é obrigatório informar o motivo do cancelamento com pelo menos 20 caracteres.";

            if (carga.SituacaoCarga == SituacaoCarga.Cancelada || carga.SituacaoCarga == SituacaoCarga.LiberadoPagamento || carga.SituacaoCarga == SituacaoCarga.Encerrada)
                return "Não é possível solicitar o cancelamento da carga em sua atual situação (" + carga.DescricaoSituacaoCarga + ").";

            return "";
        }

        public bool VerificarSeCargaEmEmissao(Dominio.Entidades.Embarcador.Cargas.Carga carga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            bool EmissaoLiberada = false;

            if (carga.ExigeNotaFiscalParaCalcularFrete && carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete && (carga.DataEnvioUltimaNFe.HasValue && carga.DataEnvioUltimaNFe.Value <= DateTime.Now.AddMinutes(5)) && !carga.AguardandoEmissaoDocumentoAnterior && !carga.AgValorRedespacho && !carga.PendenteGerarCargaDistribuidor && !carga.CalculandoFrete)
                EmissaoLiberada = true;
            else if (!carga.ExigeNotaFiscalParaCalcularFrete && carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe && (carga.DataEnvioUltimaNFe.HasValue && carga.DataEnvioUltimaNFe.Value <= DateTime.Now.AddMinutes(5)) && !carga.AguardandoEmissaoDocumentoAnterior && !carga.AgValorRedespacho && !carga.PendenteGerarCargaDistribuidor && !carga.CalculandoFrete)
                EmissaoLiberada = true;

            return EmissaoLiberada;
        }
        public async Task<bool> VerificarSeCargaEmEmissaoAsync(Dominio.Entidades.Embarcador.Cargas.Carga carga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            bool EmissaoLiberada = false;

            if (carga.ExigeNotaFiscalParaCalcularFrete && carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete && (carga.DataEnvioUltimaNFe.HasValue && carga.DataEnvioUltimaNFe.Value <= DateTime.Now.AddMinutes(5)) && !carga.AguardandoEmissaoDocumentoAnterior && !carga.AgValorRedespacho && !carga.PendenteGerarCargaDistribuidor && !carga.CalculandoFrete)
                EmissaoLiberada = await Task.FromResult(true);
            else if (!carga.ExigeNotaFiscalParaCalcularFrete && carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe && (carga.DataEnvioUltimaNFe.HasValue && carga.DataEnvioUltimaNFe.Value <= DateTime.Now.AddMinutes(5)) && !carga.AguardandoEmissaoDocumentoAnterior && !carga.AgValorRedespacho && !carga.PendenteGerarCargaDistribuidor && !carga.CalculandoFrete)
                EmissaoLiberada = await Task.FromResult(true);

            return EmissaoLiberada;
        }

        public bool VerificarSeCargaEstaNaLogistica(Dominio.Entidades.Embarcador.Cargas.Carga carga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova ||
                carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete ||
                carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgTransportador)
            {
                if (carga.SituacaoCarga == SituacaoCarga.CalculoFrete && !carga.CalculandoFrete && (carga.SituacaoAlteracaoFreteCarga == SituacaoAlteracaoFreteCarga.NaoInformada || carga.SituacaoAlteracaoFreteCarga == SituacaoAlteracaoFreteCarga.Aprovada))
                {
                    bool EmissaoLiberada = VerificarSeCargaEmEmissao(carga, tipoServicoMultisoftware);
                    if (!EmissaoLiberada)
                        return true;
                    else
                        return false;
                }
                else
                {
                    return true;
                }
            }
            else
            {
                if (carga.ExigeNotaFiscalParaCalcularFrete && carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe)
                    return true;
                else
                    return false;
                //if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS && carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe)
                //    return true;
                //else if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador && carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe && (carga.TipoOperacao != null && (carga.TipoOperacao.PermiteImportarDocumentosManualmente || !carga.DataEnvioUltimaNFe.HasValue)))
                //    return true;
                //else
                //    return false;
            }
        }
        public async Task<bool> VerificarSeCargaEstaNaLogisticaAsync(Dominio.Entidades.Embarcador.Cargas.Carga carga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova ||
                carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete ||
                carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgTransportador)
            {
                if (carga.SituacaoCarga == SituacaoCarga.CalculoFrete && !carga.CalculandoFrete && (carga.SituacaoAlteracaoFreteCarga == SituacaoAlteracaoFreteCarga.NaoInformada || carga.SituacaoAlteracaoFreteCarga == SituacaoAlteracaoFreteCarga.Aprovada))
                {
                    bool EmissaoLiberada = await VerificarSeCargaEmEmissaoAsync(carga, tipoServicoMultisoftware);
                    if (!EmissaoLiberada)
                        return await Task.FromResult(true);
                    else
                        return await Task.FromResult(false);
                }
                else
                {
                    return await Task.FromResult(true);
                }
            }
            else
            {
                if (carga.ExigeNotaFiscalParaCalcularFrete && carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe)
                    return await Task.FromResult(true);
                else
                    return await Task.FromResult(false);
            }
        }

        public bool VerificarCargaSubTrechoTransferencia(Dominio.Entidades.Embarcador.Cargas.Carga carga)
        {
            //se a carga esta em calculo frete ou aguardando transp e nao exige deve liberar
            if ((carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgTransportador || carga.SituacaoCarga == SituacaoCarga.CalculoFrete) && !(carga.TipoOperacao?.ExigeNotaFiscalParaCalcularFrete ?? false))
                return true;
            else
            {
                if (carga.ExigeNotaFiscalParaCalcularFrete && (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe || carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova))
                    return true;
                else
                    return false;
            }
        }

        public bool VerificarCargaSubTrechoTransferenciaEntrega(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.StageAgrupamento repositorioStageAgrupamento = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);
            Repositorio.Embarcador.Pedidos.Stage repositorioStage = new Repositorio.Embarcador.Pedidos.Stage(unitOfWork);
            Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento agrupamento = repositorioStageAgrupamento.BuscarPrimeiroPorCargaGerada(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Pedidos.Stage> stage = repositorioStage.BuscarporAgrupamento(agrupamento?.Codigo ?? 0);

            if (stage == null)
                return false;

            if (!(carga.DadosSumarizados?.CargaTrecho == CargaTrechoSumarizada.SubCarga && !carga.ExigeNotaFiscalParaCalcularFrete))
                return false;

            List<Vazio> vazios = stage.Select(x => x.TipoPercurso).ToList();

            if (vazios.Contains(Vazio.PercursoPrincipal) || vazios.Contains(Vazio.PercursoSubSeQuente))
                return true;

            return false;
        }

        public void SolicitarEncerramentoMDFeAutomaticamente(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, string webServiceConsultaCTe, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado, Dominio.Entidades.Usuario usuario)
        {
            string notaEncerramento = "Encerramento gerado automaticamente";

            GerarRegistroEncerramentoCarga(ref carga, notaEncerramento, usuario, tipoServicoMultisoftware, Auditado, unitOfWork);
        }

        public string SolicitarEncerramentoCarga(int codigoCarga, string observacao, string webServiceConsultaCTe, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado)
        {
            string retorno = "";
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaMDFe repCargaMDFe = new Repositorio.Embarcador.Cargas.CargaMDFe(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaRegistroEncerramento repCargaRegistroEncerramento = new Repositorio.Embarcador.Cargas.CargaRegistroEncerramento(unitOfWork);
            Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigo(codigoCarga);

            if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento || carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte)
            {
                if (Auditado == null)
                {
                    Auditado = new Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado()
                    {
                        OrigemAuditado = Dominio.ObjetosDeValor.Enumerador.OrigemAuditado.Sistema,
                        TipoAuditado = Dominio.ObjetosDeValor.Enumerador.TipoAuditado.Sistema,
                        Texto = "Gerado encerramento de carga pelo fluxo de controle e entrega"
                    };
                }
                List<Dominio.Entidades.Embarcador.Cargas.CargaMDFe> cargaMDFe = repCargaMDFe.BuscarPorCarga(carga.Codigo);

                if (!cargaMDFe.Exists(obj => obj.MDFe != null && obj.SistemaEmissor == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SistemaEmissor.MultiCTe && obj.MDFe.Status != Dominio.Enumeradores.StatusMDFe.Encerrado && obj.MDFe.Status != Dominio.Enumeradores.StatusMDFe.Cancelado))
                {
                    Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);
                    serCarga.GerarRegistroEncerramentoCarga(ref carga, observacao, null, tipoServicoMultisoftware, Auditado, unitOfWork);

                    //carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada;
                    //carga.DataEncerramentoCarga = DateTime.Now;
                    //repCarga.Atualizar(carga);

                    //if (Auditado != null)
                    //    Servicos.Auditoria.Auditoria.Auditar(Auditado, carga, null, Auditado.Texto, unitOfWork);

                    //Dominio.Entidades.Embarcador.Cargas.CargaRegistroEncerramento cargaRegistroEncerramento = repCargaRegistroEncerramento.BuscarPorCarga(carga.Codigo);
                    //if (cargaRegistroEncerramento == null)
                    //{
                    //    if ((!string.IsNullOrWhiteSpace(observacao) && observacao.Length >= 20) || tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    //    {
                    //        Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);
                    //        serCarga.GerarRegistroEncerramentoCarga(ref carga, observacao, null, tipoServicoMultisoftware, Auditado, unitOfWork);
                    //    }
                    //    else
                    //    {
                    //        retorno = "Para encerrar a carga sem canhotos é necessário informar uma observação de no mínimo 20 caracteres";
                    //    }
                    //}
                }
                else
                {
                    //if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    //{
                    SolicitarEncerramentoMDFeAutomaticamente(carga, unitOfWork, tipoServicoMultisoftware, webServiceConsultaCTe, Auditado, null);
                    //}
                    //else
                    //{
                    //    retorno = "Não é possível encerrar a carga, pois existe(m) MDF-e(s) não encerrado(s)";
                    //}
                }
            }
            else
            {
                retorno = "A atual situação da carga (" + carga.DescricaoSituacaoCarga + ") não permite encerrá-la";
            }
            return retorno;
        }

        public void ValidarCargasFinalizadas(ref Dominio.Entidades.Embarcador.Cargas.Carga carga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado, Repositorio.UnitOfWork unitOfWork)
        {
            if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte && !carga.CargaEmitidaParcialmente)
            {
                Repositorio.Embarcador.Cargas.CargaMDFe repCargaMDFe = new Repositorio.Embarcador.Cargas.CargaMDFe(unitOfWork);
                Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao();

                List<Dominio.Entidades.Embarcador.Cargas.CargaMDFe> cargaMDFEs = repCargaMDFe.BuscarPorCarga(carga.Codigo);

                if (!cargaMDFEs.Exists(obj => obj.MDFe != null && (configuracaoTMS.PermiteEncerrarMDFeEmitidoNoEmbarcador || obj.SistemaEmissor == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SistemaEmissor.MultiCTe) && obj.MDFe.Status != Dominio.Enumeradores.StatusMDFe.Encerrado))
                {
                    Repositorio.Embarcador.Cargas.CargaNFS repCargaNFS = new Repositorio.Embarcador.Cargas.CargaNFS(unitOfWork);
                    List<Dominio.Entidades.Embarcador.Cargas.CargaNFS> cargaNFSs = repCargaNFS.BuscarPorCarga(carga.Codigo);
                    if (cargaNFSs.Count == 0 || !cargaNFSs.Exists(obj => obj.NotaFiscalServico == null))
                    {
                        this.LiberarSituacaoDeCargaFinalizada(carga, unitOfWork, tipoServicoMultisoftware, Auditado);
                    }
                }
            }
        }

        public void LiberarSituacaoDeCargaFinalizada(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado, Dominio.Entidades.Usuario usuario = null)
        {
            if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada || carga.CargaEmitidaParcialmente)
                return;

            Servicos.Embarcador.Canhotos.Canhoto serCanhoto = new Canhotos.Canhoto(unitOfWork);
            Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);
            Servicos.Embarcador.Hubs.Carga servicoHubCarga = new Servicos.Embarcador.Hubs.Carga();

            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao();

            DisponibilizarMotoristasFilaCarregamento(carga, tipoServicoMultisoftware, unitOfWork);

            carga.SituacaoCarga = configuracaoEmbarcador.SituacaoCargaAposFinalizacaoDaCarga;
            repCarga.Atualizar(carga);
            if (configuracaoEmbarcador?.SituacaoCargaAposFinalizacaoDaCarga == SituacaoCarga.Encerrada)
            {
                carga = serCarga.AtualizarStatusCustoExtra(carga, servicoHubCarga, repCarga);

                if (Auditado == null)
                    Servicos.Auditoria.Auditoria.Auditar(new Auditado { OrigemAuditado = OrigemAuditado.Sistema, TipoAuditado = TipoAuditado.Sistema }, carga, null, $"Alterou carga para situação {Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada.ObterDescricao()}", unitOfWork);
                else
                    Servicos.Auditoria.Auditoria.Auditar(Auditado, carga, null, $"Alterou carga para situação {Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada.ObterDescricao()}", unitOfWork);
            }

            //aqui quando um pedido pertencer a mais de uma carga, não finaliza o pedido sem que as outras cargas sejam finalizadas.
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo);

            //GerarRegistroEncerramentoCarga(ref carga, "", usuario, tipoServicoMultisoftware, Auditado, unitOfWork);
            serCanhoto.VerificarQuantidadeCanhotosPendenteEnvioCarga(carga, tipoServicoMultisoftware, unitOfWork, Auditado);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
            {
                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> pedidoCargas = repCargaPedido.BuscarPorPedido(cargaPedido.Pedido.Codigo);
                bool finalizaPedido = true;
                int codCarga = carga.Codigo;

                if (pedidoCargas.Exists(obj => obj.Carga.Codigo != codCarga))
                {
                    if (pedidoCargas.Exists(obj => obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada && obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada && obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento))
                        finalizaPedido = false;
                }

                if (!finalizaPedido)
                    continue;

                if (configuracaoEmbarcador.UtilizarProtocoloDaPreCargaNaCarga && !cargaPedido.Pedido.PedidoTotalmenteCarregado)
                    continue;

                cargaPedido.Pedido.SituacaoPedido = cargaPedido.Pedido.ReentregaSolicitada ? SituacaoPedido.Aberto : SituacaoPedido.Finalizado;//Mantém em aberto para ser utilizado em nova carga quando é de reentrega
                repPedido.Atualizar(cargaPedido.Pedido);

                if (cargaPedido.Pedido.PedidosRecolhimentoTroca.Count > 0)
                {
                    foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoRecolhimentoTroca pedidoRecolhimento in cargaPedido.Pedido.PedidosRecolhimentoTroca)
                    {
                        pedidoRecolhimento.RecolhimentoTroca.SituacaoPedido = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoPedido.Finalizado;
                        repPedido.Atualizar(pedidoRecolhimento.RecolhimentoTroca);
                    }
                }
            }
        }

        public bool VerificarFinalizarCargaAoFinalizarGestaoPatio(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS)
        {
            if (!configuracaoTMS.EncerrarCargaQuandoFinalizarGestaoPatio)
                return false;

            if (carga == null)
                return false;

            if (carga.SituacaoCarga != SituacaoCarga.EmTransporte && carga.SituacaoCarga != SituacaoCarga.Encerrada)
                throw new ServicoException($"A atual situação da carga {carga.SituacaoCarga.ObterDescricao()} não permite finalizar a operação.");

            return true;
        }

        public void GerarRegistroEncerramentoCarga(ref Dominio.Entidades.Embarcador.Cargas.Carga carga, string notaEncerramento, Dominio.Entidades.Usuario usuario, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado, Repositorio.UnitOfWork unitOfWork)
        {
            //Servicos.Embarcador.Canhotos.Canhoto serCanhoto = new Canhotos.Canhoto(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaRegistroEncerramento repCargaRegistroEncerramento = new Repositorio.Embarcador.Cargas.CargaRegistroEncerramento(unitOfWork);
            Dominio.Entidades.Embarcador.Cargas.CargaRegistroEncerramento cargaRegistroEncerramento = new Dominio.Entidades.Embarcador.Cargas.CargaRegistroEncerramento();

            cargaRegistroEncerramento.Carga = carga;
            cargaRegistroEncerramento.NotaEncerramento = notaEncerramento;
            cargaRegistroEncerramento.Usuario = usuario;
            cargaRegistroEncerramento.Situacao = SituacaoEncerramentoCarga.AgEncerramentoDocumentos;
            cargaRegistroEncerramento.DataEncerramento = null;

            repCargaRegistroEncerramento.Inserir(cargaRegistroEncerramento, Auditado);
            //serCanhoto.VerificarQuantidadeCanhotosPendenteEnvioCarga(carga, tipoServicoMultisoftware, unitOfWork, Auditado);
        }

        public void InformarSituacaoCargaFreteValido(ref Dominio.Entidades.Embarcador.Cargas.Carga carga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {
            //Repositorio.Embarcador.Cargas.CargaPedido repCargaPedio = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            //Repositorio.Embarcador.Cargas.LeilaoTipoOperacaoConfiguracao repLeilaoTipoOperacaoConfiguracao = new Repositorio.Embarcador.Cargas.LeilaoTipoOperacaoConfiguracao(unitOfWork);

            //Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido = repCargaPedio.BuscarPorCarga(carga.Codigo).FirstOrDefault();
            //Dominio.Entidades.Embarcador.Cargas.LeilaoTipoOperacaoConfiguracao leilaoTipoOperacaoConfig = repLeilaoTipoOperacaoConfiguracao.BuscarPorTipoOperacao(cargaPedido.Pedido.TipoOperacaoEmissao);

            if (carga.ExigeNotaFiscalParaCalcularFrete)
            {
                if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
                    carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova;
                else
                {
                    if (carga.TipoOperacao?.ConfiguracaoCarga?.ManterCargaNaEtapaUmAteXHorasAntesDaDataDeCarregamento ?? false)
                    {
                        if ((carga.Pedidos?.Count > 0) && (carga.Pedidos.First().Pedido.DataInicialColeta.HasValue) && (carga.TipoOperacao.ConfiguracaoCarga?.HorasManterCargaNaEtapaUmAteXHorasAntesDaDataDeCarregamento > 0))
                        {
                            int horasConfiguradas = carga.TipoOperacao.ConfiguracaoCarga.HorasManterCargaNaEtapaUmAteXHorasAntesDaDataDeCarregamento;
                            DateTime horaLimite = carga.Pedidos.First().Pedido.DataInicialColeta.Value.AddHours(-horasConfiguradas);
                            if (DateTime.Now <= horaLimite)
                                carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova;
                            else
                                carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete;
                        }
                    }
                    else
                        carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete;
                }

                if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete)
                    Servicos.Log.TratarErro("Atualizou a situação para calculo frete 49 Carga " + carga.CodigoCargaEmbarcador, "AtualizouSituacaoCalculoFrete");
            }
            else
            {
                Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga repositorioConfiguracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork);

                bool existeConfirmacaoEtapaFreteNoFluxoNotaAposFretePorTipoOperacao = repositorioConfiguracaoGeralCarga.ExisteConfirmacaoEtapaFreteNoFluxoNotaAposFretePorTipoOperacao() && (carga.TipoOperacao?.ExigeConformacaoFreteAntesEmissao ?? false);

                if (!existeConfirmacaoEtapaFreteNoFluxoNotaAposFretePorTipoOperacao)
                    carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgTransportador;
            }
        }

        public List<dynamic> ObterDetalhesDaCargas(List<Dominio.Entidades.Embarcador.Cargas.Carga> cargas, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, bool existePacote, Repositorio.UnitOfWork unitOfWork, bool permitirLiberarComProblemaIntegracaoGrMotoristaVeiculo, Dominio.Entidades.Embarcador.Cargas.TipoCargaModeloVeicularAutoConfig tipoCargaModeloVeicularAutoConfig = null, Dominio.Entidades.Embarcador.Pedidos.ContainerTipo tipoContainer = null, Dominio.Entidades.Usuario usuario = null)
        {
            List<dynamic> lista = new List<dynamic>();
            if (cargas == null || cargas.Count() == 0)
                return lista;

            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPreCalculo repCargaPreCalculo = new Repositorio.Embarcador.Cargas.CargaPreCalculo(unitOfWork);
            Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntrega repCargaEntrega = new Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntrega(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaRotaFrete repCargaRotaFrete = new Repositorio.Embarcador.Cargas.CargaRotaFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaVeiculoContainer repCargaVeiculoContainer = new Repositorio.Embarcador.Cargas.CargaVeiculoContainer(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaVeiculoContainerAnexo repCargaVeiculoContainerAnexo = new Repositorio.Embarcador.Cargas.CargaVeiculoContainerAnexo(unitOfWork);
            Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repositorioApoliceSeguroAverbacao = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaCarregamento repCargaJanelaCarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamento(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaDescarregamento repCargaJanelaDescarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaDescarregamento(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCancelamento repCargaCancelamento = new Repositorio.Embarcador.Cargas.CargaCancelamento(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaMotorista repCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);
            Repositorio.Embarcador.Logistica.AgendamentoColeta repAgendamentoColeta = new Repositorio.Embarcador.Logistica.AgendamentoColeta(unitOfWork);
            Repositorio.Embarcador.Cargas.OrdemEmbarque.CargaOrdemEmbarqueIntegracao repositorioCargaOrdemEmbarqueIntegracao = new Repositorio.Embarcador.Cargas.OrdemEmbarque.CargaOrdemEmbarqueIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarque repositorioOrdemEmbarque = new Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarque(unitOfWork);
            Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarqueSituacao repOrdemEmbarqueSituacao = new Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarqueSituacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.RetiradaContainer repositorioRetiradaContainer = new Repositorio.Embarcador.Pedidos.RetiradaContainer(unitOfWork);
            Repositorio.Embarcador.Veiculos.VeiculoMotorista repVeiculoMotorista = new Repositorio.Embarcador.Veiculos.VeiculoMotorista(unitOfWork);
            Repositorio.Embarcador.WMS.MontagemContainer repositorioMontagemContainer = new Repositorio.Embarcador.WMS.MontagemContainer(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportadorTermoAceite repositorioTransportadorTermoAceite = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportadorTermoAceite(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportador repositorioJanelTransportador = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportador(unitOfWork);
            Repositorio.Embarcador.Cargas.MontagemCarga.SimulacaoFrete repositorioSimulacaoFrete = new Repositorio.Embarcador.Cargas.MontagemCarga.SimulacaoFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaDadosParaProcesamentoDt repCargaDadosParaProcesamentoDt = new Repositorio.Embarcador.Cargas.CargaDadosParaProcesamentoDt(unitOfWork);
            Repositorio.Embarcador.Financeiro.DocumentoFaturamento repDocumentoFaturamento = new Repositorio.Embarcador.Financeiro.DocumentoFaturamento(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repositorioXmlNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.LinhaSeparacao repositorioLinhaSeparacao = new Repositorio.Embarcador.Pedidos.LinhaSeparacao(unitOfWork);
            Repositorio.Embarcador.Transportadores.MotoristaIntegracao repMotoristaIntegracao = new Repositorio.Embarcador.Transportadores.MotoristaIntegracao(unitOfWork);
            Repositorio.Embarcador.Veiculos.VeiculoIntegracao repVeiculoIntegracao = new Repositorio.Embarcador.Veiculos.VeiculoIntegracao(unitOfWork);
            Repositorio.Embarcador.Logistica.Monitoramento repMonitoramento = new Repositorio.Embarcador.Logistica.Monitoramento(unitOfWork);
            Repositorio.Embarcador.PreCargas.PreCarga repositorioPreCarga = new Repositorio.Embarcador.PreCargas.PreCarga(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoIntegracao tipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork).BuscarPrimeiroRegistro(); ;
            Servicos.Embarcador.Carga.MensagemAlertaCarga servicoMensagemAlerta = new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork, configuracaoGeralCarga);

            List<int> codigosCargas = (from obj in cargas select obj.Codigo).ToList();
            List<int> codigosCarregamento = (from obj in cargas where obj.Carregamento != null select obj.Carregamento.Codigo).Distinct().ToList();
            List<int> codigosVeiculos = (from obj in cargas where obj.Veiculo != null select obj.Veiculo.Codigo).Distinct().ToList();
            List<int> codigosMotoristas = (from obj in cargas where obj.Motoristas.FirstOrDefault() != null select obj.Motoristas.FirstOrDefault().Codigo).Distinct().ToList();
            List<int> codigosPrecarga = (from obj in cargas where obj.PreCarga != null select obj.PreCarga.Codigo).ToList();
            List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer> cargaVeiculosContainer = repCargaVeiculoContainer.BuscarPorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainerAnexo> cargaVeiculosContainerAnexo = repCargaVeiculoContainerAnexo.BuscarPorCargas(codigosCargas);
            List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedido> cargaPedidos = repCargaPedido.BuscarCodigosCargaPedidoPorCargas(codigosCargas, configuracaoTMS.NaoUsarPesoNotasPallet);
            List<Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntrega> EntregasParqueamento = repCargaEntrega.BuscarCargaEntregaParqueamentoPorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Logistica.AgendamentoColeta> agendamentos = repAgendamentoColeta.BuscarPorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoTransportadorTermoAceite> termosAceite = repositorioTransportadorTermoAceite.BuscarPorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoTransportador> janelasTransportador = repositorioJanelTransportador.BuscarPorCargasESituacao(codigosCargas, SituacaoCargaJanelaCarregamentoTransportador.Confirmada);
            List<Dominio.Entidades.Embarcador.Cargas.CargaCancelamento> cargasCancelamento = new List<Dominio.Entidades.Embarcador.Cargas.CargaCancelamento>();
            List<Dominio.Entidades.Embarcador.PreCargas.PreCarga> preCarga = repositorioPreCarga.BuscarPorCargas(codigosCargas);

            if (cargas.Any(obj => obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada || obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada))
                cargasCancelamento = repCargaCancelamento.BuscarPorCargas(codigosCargas);

            List<Dominio.ObjetosDeValor.WebService.Carga.Carga> cargasOrigem = new List<Dominio.ObjetosDeValor.WebService.Carga.Carga>();

            if (cargas.Any(obj => obj.CargaAgrupada))
                cargasOrigem = repCarga.BuscarNumerosCargasAgrupadas(codigosCargas);

            List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao> apolicesSeguraAverbacao = repositorioApoliceSeguroAverbacao.BuscarPorCargas(codigosCargas);
            List<int> cargasComRota = repCargaRotaFrete.VerificarSeExistePorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> cargaMotorista = repCargaMotorista.BuscarPorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento> cargaJanelaCarregamento = repCargaJanelaCarregamento.BuscarPorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaDescarregamento> cargaJanelaDescarregamento = repCargaJanelaDescarregamento.BuscarPorCarga(codigosCargas);
            List<Dominio.ObjetosDeValor.Embarcador.Alertas.MensagemAlerta> mensagensAlerta = servicoMensagemAlerta.ObterMensagensPorEntidades(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.OrdemEmbarque.CargaOrdemEmbarqueIntegracao> cargaOrdensEmbarqueIntegracao = repositorioCargaOrdemEmbarqueIntegracao.BuscarPorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarque> ordensEmbarque = repositorioOrdemEmbarque.BuscarPorCargas(codigosCargas);
            List<string> codigosIntegracaoSituacaoOrdemCancelada = repOrdemEmbarqueSituacao.GetCodigosIntegracaoSituacaoOrdemCancelada();
            List<Dominio.Entidades.Embarcador.Pedidos.RetiradaContainer> retiradasContainer = repositorioRetiradaContainer.BuscarPorCargas(codigosCargas);

            Repositorio.Embarcador.Configuracoes.IntegracaoIntercab repIntegracaoIntercab = new Repositorio.Embarcador.Configuracoes.IntegracaoIntercab(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab = repIntegracaoIntercab.BuscarIntegracao();

            bool possuiMontagemContainer = repositorioMontagemContainer.BuscarSeExisteCadastrado();
            bool possuiIntegracaoHUBOfertas = tipoIntegracao.ExistePorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.HUB);
            // aqui 
            List<Dominio.Entidades.Embarcador.Veiculos.VeiculoMotorista> lstVeiculosMotorista = repVeiculoMotorista.BuscarMotoristaPrincipal(cargas.Select(x => x.Veiculo?.Codigo ?? 0).ToList());
            IList<Dominio.ObjetosDeValor.Embarcador.Logistica.QuantidadeDePaletesPorCarga> lstquantidadePallets = repCargaPedido.BuscarNumeroPaletesPorCarga(codigosCargas);
            IList<Dominio.ObjetosDeValor.Embarcador.Frete.SimulacaoDeFrete> lstSimulacoesDeFrete = codigosCarregamento.Count > 0 ? repositorioSimulacaoFrete.BuscarSimulacaoFrete(codigosCarregamento) : new List<Dominio.ObjetosDeValor.Embarcador.Frete.SimulacaoDeFrete>();
            List<Dominio.Entidades.Embarcador.Financeiro.DocumentoFaturamento> lstContemFaturamento = repDocumentoFaturamento.CargaDocumentoFaturamento(codigosCargas);
            List<Dominio.Entidades.Embarcador.Financeiro.DocumentoFaturamento> lstTodosCTesForamFaturados = repDocumentoFaturamento.ContemCTeSemFaturamento(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPreCalculo> lstCargaPreCalculo = repCargaPreCalculo.BuscarPorCargas(cargas.Select(x => x.Codigo).ToList());
            List<Dominio.Entidades.Embarcador.Cargas.CargaDadosParaProcessamentoDt> lstDadoDocumentoCarga = repCargaDadosParaProcesamentoDt.BuscarPorCargas(codigosCargas);
            IList<(int CodigoCarga, string DescricaoLinhaSeparacao)> listaLinhaSeparacaoDescricaoComCodigoCarga = cargaPedidos.Count > 0 ? repositorioLinhaSeparacao.BuscarDescricaoPorCodigosCargas(cargaPedidos.Select(o => o.CodigoCarga).Distinct().ToList()) : new List<(int CodigoCarga, string DescricaoLinhaSeparacao)>();
            List<Dominio.Entidades.Embarcador.Transportadores.MotoristaIntegracao> integracoesMotorista = repMotoristaIntegracao.BuscarPorMotoristas(codigosMotoristas);
            List<Dominio.Entidades.Embarcador.Veiculos.VeiculoIntegracao> integracoesVeiculo = repVeiculoIntegracao.BuscarPorVeiculos(codigosVeiculos);
            List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.SimulacaoFrete> simulacoesFrete = codigosCarregamento.Count > 0 ? repositorioSimulacaoFrete.BuscarPorCarregamentos(codigosCarregamento) : null;
            List<Dominio.ObjetosDeValor.Embarcador.Monitoramento.MonitoramentoDadosDetalhesCarga> monitoramentos = repMonitoramento.BuscarDadosMonitoramentoPorCodigosCargasAsync(codigosCargas).Result;
            List<Dominio.Entidades.Embarcador.Cargas.CargaCIOT> cargaCIOTList = new Repositorio.Embarcador.Cargas.CargaCIOT(unitOfWork).BuscarPorCargas(codigosCargas);

            //aqui fim

            foreach (Dominio.Entidades.Embarcador.Cargas.Carga carga in cargas)
            {
                /* *********************************************************************************************************************************************
                 *
                 *
                 *
                 * NÃO FAÇA QUERYS OU BUSCAS DESTRO DESTE FOREACH NEM DENTRO DE QUALQUER FOREACH BUSQUE AS LISTAS E DENTRO DO LOOP APENAS FILTRE A MEMORIA
                 * CASO TENHAM MUITOS DADOS NA MEMORIA ACIMA DE 5 MB USE INDICES E CRIE AREAS DE BUSCA SEPARADAS POR INDICE
                 *
                 *
                 * *********************************************************************************************************************************************/

                dynamic ContratoFreteTerceiro = carga.FreteDeTerceiro ? ObterDadosContratoFrete(carga, unitOfWork) : null;
                List<string> codigosAgrupados = new List<string>();
                if (carga.CargaDeVinculo || carga.CargaPossuiOutrosNumerosEmbarcador)
                    codigosAgrupados = carga.CodigosAgrupados.ToList();

                List<Dominio.ObjetosDeValor.Embarcador.Carga.PedidoTransbordo> cargaPedidosTransbordos = new List<Dominio.ObjetosDeValor.Embarcador.Carga.PedidoTransbordo>();
                if (configuracaoTMS.UtilizaEmissaoMultimodal && tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
                    cargaPedidosTransbordos = repCargaPedido.BuscarCodigosPedidoTransbordoPorCarga(carga.Codigo);

                Dominio.Entidades.Usuario motorista = null;
                if (carga.Veiculo != null)
                    motorista = lstVeiculosMotorista.Where(z => z.Veiculo.Codigo == carga.Veiculo.Codigo).Select(o => o.Motorista).FirstOrDefault();
                decimal quantidadePallets = lstquantidadePallets.Where(z => z.CodigoCarga == carga.Codigo).FirstOrDefault()?.QuantidadePaletes ?? 0;
                bool possuiSimulacaoFrete = carga.Carregamento == null ? false : lstSimulacoesDeFrete.Where(x => x.CodigoCarregamento == carga.Carregamento.Codigo).Any();
                bool contemFaturamento = lstContemFaturamento.Where(z => z.CargaPagamento.Codigo == carga.Codigo).Any();
                bool todosCTesForamFaturados = contemFaturamento ? !lstTodosCTesForamFaturados.Where(z => z.CargaPagamento.Codigo == carga.Codigo).Any() : false;
                Dominio.Entidades.Embarcador.Cargas.CargaPreCalculo cargaPreCalculo = lstCargaPreCalculo.Where(z => z.Carga.Codigo == carga.Codigo).FirstOrDefault();
                Dominio.Entidades.Embarcador.Cargas.CargaDadosParaProcessamentoDt dadoDocumentoCarga = lstDadoDocumentoCarga.Where(z => z.Carga.Codigo == carga.Codigo).FirstOrDefault();
                bool? recebeuNotasFilhas = null;
                List<Dominio.Entidades.Embarcador.Transportadores.MotoristaIntegracao> integracoesDoMotorista = integracoesMotorista.Where(obj => obj.Motorista.Codigo == (carga.Motoristas.FirstOrDefault()?.Codigo ?? 0)).ToList();
                List<Dominio.Entidades.Embarcador.Veiculos.VeiculoIntegracao> integracoesDoVeiculo = integracoesVeiculo.Where(obj => obj.Veiculo.Codigo == (carga.Veiculo?.Codigo ?? 0)).ToList();
                Dominio.Entidades.Embarcador.Cargas.MontagemCarga.SimulacaoFrete simulacaoFrete = simulacoesFrete != null ? (simulacoesFrete.Where(obj => obj.Carregamento.Codigo == (carga.Carregamento?.Codigo ?? 0)).FirstOrDefault()) : null;

                if (carga.TipoOperacao?.ConfiguracaoCarga?.PrecisaEsperarNotasFilhaParaGerarPagamento ?? false)
                {
                    recebeuNotasFilhas = true;
                    List<string> numerosControle = (from obj in cargaPedidos where obj.CodigoCarga == carga.Codigo select obj.NumeroControlePedido).Distinct().ToList();
                    List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> notasCarga = repositorioXmlNotaFiscal.BuscarPorCarga(carga.Codigo);
                    if (!numerosControle.Any(numero => notasCarga.Any(nc => nc.NumeroControlePedido == numero)))
                        recebeuNotasFilhas = false;
                }

                lista.Add(
                    ObterDadosDetalheCarga(
                        carga,
                        tipoServicoMultisoftware,
                        configuracaoTMS,
                        (from obj in cargaVeiculosContainer where obj.Carga.Codigo == carga.Codigo select obj).ToList(),
                        (from obj in cargaVeiculosContainerAnexo where obj.EntidadeAnexo.Carga.Codigo == carga.Codigo select obj).ToList(),
                        (from obj in cargaPedidos where obj.CodigoCarga == carga.Codigo select obj).ToList(),
                        (from obj in cargasCancelamento where obj.Carga.Codigo == carga.Codigo select obj).FirstOrDefault(),
                        (from obj in cargasOrigem where obj.Protocolo == carga.Codigo select obj).ToList(),
                        codigosAgrupados,
                        (from obj in apolicesSeguraAverbacao where obj.CargaPedido.Carga.Codigo == carga.Codigo select obj.ApoliceSeguro).Distinct().ToList(),
                        (from obj in cargasComRota where obj == carga.Codigo select obj).Any(),
                        tipoCargaModeloVeicularAutoConfig,
                        ContratoFreteTerceiro,
                        (from obj in cargaMotorista where obj.Carga.Codigo == carga.Codigo select obj).ToList(),
                        cargaPedidosTransbordos,
                        (from obj in cargaJanelaCarregamento where obj.Carga.Codigo == carga.Codigo select obj).FirstOrDefault(),
                        (from obj in cargaJanelaDescarregamento where obj.Carga.Codigo == carga.Codigo select obj).FirstOrDefault(),
                        (from obj in mensagensAlerta where obj.CodigoEntidade == carga.Codigo select obj).ToList(),
                        permitirLiberarComProblemaIntegracaoGrMotoristaVeiculo,
                        (from obj in agendamentos where obj.Carga.Codigo == carga.Codigo || obj.Carga.CargaAgrupamento?.Codigo == carga.Codigo select obj).FirstOrDefault(),
                        (from o in ordensEmbarque where o.Carga.Codigo == carga.Codigo || o.Carga.CargaAgrupamento?.Codigo == carga.Codigo select o).ToList(),
                        (from obj in cargaOrdensEmbarqueIntegracao where obj.Carga.Codigo == carga.Codigo select obj).FirstOrDefault(),
                        codigosIntegracaoSituacaoOrdemCancelada,
                        motorista,
                        possuiMontagemContainer,
                        (from o in retiradasContainer where o.Carga.Codigo == carga.Codigo select o).FirstOrDefault(),
                        (from obj in termosAceite where obj.Carga.Codigo == carga.Codigo select obj).ToList(),
                        (from obj in janelasTransportador where obj.CargaJanelaCarregamento.Carga.Codigo == carga.Codigo select obj).ToList(),
                        quantidadePallets,
                        possuiSimulacaoFrete,
                        (from obj in EntregasParqueamento where obj.Carga.Codigo == carga.Codigo select obj).ToList(),
                        cargaPreCalculo,
                        dadoDocumentoCarga,
                        integracaoIntercab,
                        contemFaturamento,
                        todosCTesForamFaturados,
                        existePacote,
                        simulacaoFrete,
                        unitOfWork,
                        recebeuNotasFilhas,
                        usuario,
                        listaLinhaSeparacaoDescricaoComCodigoCarga.ToList(),
                        carga.Ajudantes.ToList(),
                        integracoesDoMotorista,
                        integracoesDoVeiculo,
                        monitoramentos,
                        (from o in preCarga where o.Carga.Codigo == carga.Codigo select o).FirstOrDefault(),
                        cargaCIOTList, possuiIntegracaoHUBOfertas
                    )
                );

            }

            return lista;
        }
        public async Task<List<dynamic>> ObterDetalhesDaCargasAsync(CancellationToken cancellationToken, List<Dominio.Entidades.Embarcador.Cargas.Carga> cargas, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS,
            AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, bool existePacote, Repositorio.UnitOfWork unitOfWork, bool permitirLiberarComProblemaIntegracaoGrMotoristaVeiculo,
            Dominio.Entidades.Embarcador.Cargas.TipoCargaModeloVeicularAutoConfig tipoCargaModeloVeicularAutoConfig = null,
            Dominio.Entidades.Embarcador.Pedidos.ContainerTipo tipoContainer = null, Dominio.Entidades.Usuario usuario = null)
        {
            List<dynamic> lista = new List<dynamic>();
            if (cargas == null || cargas.Count() == 0)
                return lista;

            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork, cancellationToken);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork, cancellationToken);
            Repositorio.Embarcador.Cargas.CargaPreCalculo repCargaPreCalculo = new Repositorio.Embarcador.Cargas.CargaPreCalculo(unitOfWork);
            Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntrega repCargaEntrega = new Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntrega(unitOfWork, cancellationToken);
            Repositorio.Embarcador.Cargas.CargaRotaFrete repCargaRotaFrete = new Repositorio.Embarcador.Cargas.CargaRotaFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaVeiculoContainer repCargaVeiculoContainer = new Repositorio.Embarcador.Cargas.CargaVeiculoContainer(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaVeiculoContainerAnexo repCargaVeiculoContainerAnexo = new Repositorio.Embarcador.Cargas.CargaVeiculoContainerAnexo(unitOfWork);
            Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repositorioApoliceSeguroAverbacao = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaCarregamento repCargaJanelaCarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamento(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaDescarregamento repCargaJanelaDescarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaDescarregamento(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCancelamento repCargaCancelamento = new Repositorio.Embarcador.Cargas.CargaCancelamento(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaMotorista repCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);
            Repositorio.Embarcador.Logistica.AgendamentoColeta repAgendamentoColeta = new Repositorio.Embarcador.Logistica.AgendamentoColeta(unitOfWork);
            Repositorio.Embarcador.Cargas.OrdemEmbarque.CargaOrdemEmbarqueIntegracao repositorioCargaOrdemEmbarqueIntegracao = new Repositorio.Embarcador.Cargas.OrdemEmbarque.CargaOrdemEmbarqueIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarque repositorioOrdemEmbarque = new Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarque(unitOfWork);
            Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarqueSituacao repOrdemEmbarqueSituacao = new Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarqueSituacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.RetiradaContainer repositorioRetiradaContainer = new Repositorio.Embarcador.Pedidos.RetiradaContainer(unitOfWork);
            Repositorio.Embarcador.Veiculos.VeiculoMotorista repVeiculoMotorista = new Repositorio.Embarcador.Veiculos.VeiculoMotorista(unitOfWork);
            Repositorio.Embarcador.WMS.MontagemContainer repositorioMontagemContainer = new Repositorio.Embarcador.WMS.MontagemContainer(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportadorTermoAceite repositorioTransportadorTermoAceite = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportadorTermoAceite(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportador repositorioJanelTransportador = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportador(unitOfWork);
            Repositorio.Embarcador.Cargas.MontagemCarga.SimulacaoFrete repositorioSimulacaoFrete = new Repositorio.Embarcador.Cargas.MontagemCarga.SimulacaoFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaDadosParaProcesamentoDt repCargaDadosParaProcesamentoDt = new Repositorio.Embarcador.Cargas.CargaDadosParaProcesamentoDt(unitOfWork);
            Repositorio.Embarcador.Financeiro.DocumentoFaturamento repDocumentoFaturamento = new Repositorio.Embarcador.Financeiro.DocumentoFaturamento(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repositorioXmlNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.LinhaSeparacao repositorioLinhaSeparacao = new Repositorio.Embarcador.Pedidos.LinhaSeparacao(unitOfWork);
            Repositorio.Embarcador.Transportadores.MotoristaIntegracao repMotoristaIntegracao = new Repositorio.Embarcador.Transportadores.MotoristaIntegracao(unitOfWork);
            Repositorio.Embarcador.Veiculos.VeiculoIntegracao repVeiculoIntegracao = new Repositorio.Embarcador.Veiculos.VeiculoIntegracao(unitOfWork);
            Repositorio.Embarcador.Logistica.Monitoramento repMonitoramento = new Repositorio.Embarcador.Logistica.Monitoramento(unitOfWork);
            Repositorio.Embarcador.PreCargas.PreCarga repositorioPreCarga = new Repositorio.Embarcador.PreCargas.PreCarga(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoIntegracao tipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork).BuscarPrimeiroRegistro(); ;
            Servicos.Embarcador.Carga.MensagemAlertaCarga servicoMensagemAlerta = new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork, configuracaoGeralCarga);

            List<int> codigosCargas = (from obj in cargas select obj.Codigo).ToList();
            List<int> codigosCarregamento = (from obj in cargas where obj.Carregamento != null select obj.Carregamento.Codigo).Distinct().ToList();
            List<int> codigosVeiculos = (from obj in cargas where obj.Veiculo != null select obj.Veiculo.Codigo).Distinct().ToList();
            List<int> codigosMotoristas = (from obj in cargas where obj.Motoristas.FirstOrDefault() != null select obj.Motoristas.FirstOrDefault().Codigo).Distinct().ToList();
            List<int> codigosPrecarga = (from obj in cargas where obj.PreCarga != null select obj.PreCarga.Codigo).ToList();
            List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer> cargaVeiculosContainer = repCargaVeiculoContainer.BuscarPorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainerAnexo> cargaVeiculosContainerAnexo = repCargaVeiculoContainerAnexo.BuscarPorCargas(codigosCargas);
            List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedido> cargaPedidos = repCargaPedido.BuscarCodigosCargaPedidoPorCargas(codigosCargas, configuracaoTMS.NaoUsarPesoNotasPallet);
            List<Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntrega> EntregasParqueamento = repCargaEntrega.BuscarCargaEntregaParqueamentoPorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Logistica.AgendamentoColeta> agendamentos = repAgendamentoColeta.BuscarPorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoTransportadorTermoAceite> termosAceite = repositorioTransportadorTermoAceite.BuscarPorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoTransportador> janelasTransportador = repositorioJanelTransportador.BuscarPorCargasESituacao(codigosCargas, SituacaoCargaJanelaCarregamentoTransportador.Confirmada);
            List<Dominio.Entidades.Embarcador.Cargas.CargaCancelamento> cargasCancelamento = new List<Dominio.Entidades.Embarcador.Cargas.CargaCancelamento>();
            List<Dominio.Entidades.Embarcador.PreCargas.PreCarga> preCarga = repositorioPreCarga.BuscarPorCargas(codigosCargas);

            if (cargas.Any(obj => obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada || obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada))
                cargasCancelamento = repCargaCancelamento.BuscarPorCargas(codigosCargas);

            List<Dominio.ObjetosDeValor.WebService.Carga.Carga> cargasOrigem = new List<Dominio.ObjetosDeValor.WebService.Carga.Carga>();

            if (cargas.Any(obj => obj.CargaAgrupada))
                cargasOrigem = repCarga.BuscarNumerosCargasAgrupadas(codigosCargas);

            List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao> apolicesSeguraAverbacao = repositorioApoliceSeguroAverbacao.BuscarPorCargas(codigosCargas);
            List<int> cargasComRota = repCargaRotaFrete.VerificarSeExistePorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> cargaMotorista = repCargaMotorista.BuscarPorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento> cargaJanelaCarregamento = repCargaJanelaCarregamento.BuscarPorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaDescarregamento> cargaJanelaDescarregamento = repCargaJanelaDescarregamento.BuscarPorCarga(codigosCargas);
            List<Dominio.ObjetosDeValor.Embarcador.Alertas.MensagemAlerta> mensagensAlerta = servicoMensagemAlerta.ObterMensagensPorEntidades(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.OrdemEmbarque.CargaOrdemEmbarqueIntegracao> cargaOrdensEmbarqueIntegracao = repositorioCargaOrdemEmbarqueIntegracao.BuscarPorCargas(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarque> ordensEmbarque = repositorioOrdemEmbarque.BuscarPorCargas(codigosCargas);
            List<string> codigosIntegracaoSituacaoOrdemCancelada = repOrdemEmbarqueSituacao.GetCodigosIntegracaoSituacaoOrdemCancelada();
            List<Dominio.Entidades.Embarcador.Pedidos.RetiradaContainer> retiradasContainer = repositorioRetiradaContainer.BuscarPorCargas(codigosCargas);

            Repositorio.Embarcador.Configuracoes.IntegracaoIntercab repIntegracaoIntercab = new Repositorio.Embarcador.Configuracoes.IntegracaoIntercab(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab = repIntegracaoIntercab.BuscarIntegracao();

            bool possuiMontagemContainer = repositorioMontagemContainer.BuscarSeExisteCadastrado();
            bool possuiIntegracaoHUBOfertas = tipoIntegracao.ExistePorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.HUB);

            // aqui 
            List<Dominio.Entidades.Embarcador.Veiculos.VeiculoMotorista> lstVeiculosMotorista = repVeiculoMotorista.BuscarMotoristaPrincipal(cargas.Select(x => x.Veiculo?.Codigo ?? 0).ToList());
            IList<Dominio.ObjetosDeValor.Embarcador.Logistica.QuantidadeDePaletesPorCarga> lstquantidadePallets = repCargaPedido.BuscarNumeroPaletesPorCarga(codigosCargas);
            IList<Dominio.ObjetosDeValor.Embarcador.Frete.SimulacaoDeFrete> lstSimulacoesDeFrete = codigosCarregamento.Count > 0 ? repositorioSimulacaoFrete.BuscarSimulacaoFrete(codigosCarregamento) : new List<Dominio.ObjetosDeValor.Embarcador.Frete.SimulacaoDeFrete>();
            List<Dominio.Entidades.Embarcador.Financeiro.DocumentoFaturamento> lstContemFaturamento = repDocumentoFaturamento.CargaDocumentoFaturamento(codigosCargas);
            List<Dominio.Entidades.Embarcador.Financeiro.DocumentoFaturamento> lstTodosCTesForamFaturados = repDocumentoFaturamento.ContemCTeSemFaturamento(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPreCalculo> lstCargaPreCalculo = repCargaPreCalculo.BuscarPorCargas(cargas.Select(x => x.Codigo).ToList());
            List<Dominio.Entidades.Embarcador.Cargas.CargaDadosParaProcessamentoDt> lstDadoDocumentoCarga = repCargaDadosParaProcesamentoDt.BuscarPorCargas(codigosCargas);
            IList<(int CodigoCarga, string DescricaoLinhaSeparacao)> listaLinhaSeparacaoDescricaoComCodigoCarga = cargaPedidos.Count > 0 ? repositorioLinhaSeparacao.BuscarDescricaoPorCodigosCargas(cargaPedidos.Select(o => o.CodigoCarga).Distinct().ToList()) : new List<(int CodigoCarga, string DescricaoLinhaSeparacao)>();
            List<Dominio.Entidades.Embarcador.Transportadores.MotoristaIntegracao> integracoesMotorista = repMotoristaIntegracao.BuscarPorMotoristas(codigosMotoristas);
            List<Dominio.Entidades.Embarcador.Veiculos.VeiculoIntegracao> integracoesVeiculo = repVeiculoIntegracao.BuscarPorVeiculos(codigosVeiculos);
            List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.SimulacaoFrete> simulacoesFrete = codigosCarregamento.Count > 0 ? repositorioSimulacaoFrete.BuscarPorCarregamentos(codigosCarregamento) : null;
            List<Dominio.ObjetosDeValor.Embarcador.Monitoramento.MonitoramentoDadosDetalhesCarga> monitoramentos = await repMonitoramento.BuscarDadosMonitoramentoPorCodigosCargasAsync(codigosCargas);
            List<Dominio.Entidades.Embarcador.Cargas.CargaCIOT> cargaCIOTList = new Repositorio.Embarcador.Cargas.CargaCIOT(unitOfWork).BuscarPorCargas(codigosCargas);

            //aqui fim

            foreach (Dominio.Entidades.Embarcador.Cargas.Carga carga in cargas)
            {
                /* *********************************************************************************************************************************************
                 *
                 *
                 *
                 * NÃO FAÇA QUERYS OU BUSCAS DESTRO DESTE FOREACH NEM DENTRO DE QUALQUER FOREACH BUSQUE AS LISTAS E DENTRO DO LOOP APENAS FILTRE A MEMORIA
                 * CASO TENHAM MUITOS DADOS NA MEMORIA ACIMA DE 5 MB USE INDICES E CRIE AREAS DE BUSCA SEPARADAS POR INDICE
                 *
                 *
                 * *********************************************************************************************************************************************/

                dynamic ContratoFreteTerceiro = carga.FreteDeTerceiro ? ObterDadosContratoFrete(carga, unitOfWork) : null;
                List<string> codigosAgrupados = new List<string>();
                if (carga.CargaDeVinculo || carga.CargaPossuiOutrosNumerosEmbarcador)
                    codigosAgrupados = carga.CodigosAgrupados.ToList();

                List<Dominio.ObjetosDeValor.Embarcador.Carga.PedidoTransbordo> cargaPedidosTransbordos = new List<Dominio.ObjetosDeValor.Embarcador.Carga.PedidoTransbordo>();
                if (configuracaoTMS.UtilizaEmissaoMultimodal && tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
                    cargaPedidosTransbordos = repCargaPedido.BuscarCodigosPedidoTransbordoPorCarga(carga.Codigo);

                Dominio.Entidades.Usuario motorista = null;
                if (carga.Veiculo != null)
                    motorista = lstVeiculosMotorista.Where(z => z.Veiculo.Codigo == carga.Veiculo.Codigo).Select(o => o.Motorista).FirstOrDefault();
                decimal quantidadePallets = lstquantidadePallets.Where(z => z.CodigoCarga == carga.Codigo).FirstOrDefault()?.QuantidadePaletes ?? 0;
                bool possuiSimulacaoFrete = carga.Carregamento == null ? false : lstSimulacoesDeFrete.Where(x => x.CodigoCarregamento == carga.Carregamento.Codigo).Any();
                bool contemFaturamento = lstContemFaturamento.Where(z => z.CargaPagamento.Codigo == carga.Codigo).Any();
                bool todosCTesForamFaturados = contemFaturamento ? !lstTodosCTesForamFaturados.Where(z => z.CargaPagamento.Codigo == carga.Codigo).Any() : false;
                Dominio.Entidades.Embarcador.Cargas.CargaPreCalculo cargaPreCalculo = lstCargaPreCalculo.Where(z => z.Carga.Codigo == carga.Codigo).FirstOrDefault();
                Dominio.Entidades.Embarcador.Cargas.CargaDadosParaProcessamentoDt dadoDocumentoCarga = lstDadoDocumentoCarga.Where(z => z.Carga.Codigo == carga.Codigo).FirstOrDefault();
                bool? recebeuNotasFilhas = null;
                List<Dominio.Entidades.Embarcador.Transportadores.MotoristaIntegracao> integracoesDoMotorista = integracoesMotorista.Where(obj => obj.Motorista.Codigo == (carga.Motoristas.FirstOrDefault()?.Codigo ?? 0)).ToList();
                List<Dominio.Entidades.Embarcador.Veiculos.VeiculoIntegracao> integracoesDoVeiculo = integracoesVeiculo.Where(obj => obj.Veiculo.Codigo == (carga.Veiculo?.Codigo ?? 0)).ToList();
                Dominio.Entidades.Embarcador.Cargas.MontagemCarga.SimulacaoFrete simulacaoFrete = simulacoesFrete != null ? (simulacoesFrete.Where(obj => obj.Carregamento.Codigo == (carga.Carregamento?.Codigo ?? 0)).FirstOrDefault()) : null;

                if (carga.TipoOperacao?.ConfiguracaoCarga?.PrecisaEsperarNotasFilhaParaGerarPagamento ?? false)
                {
                    recebeuNotasFilhas = true;
                    List<string> numerosControle = (from obj in cargaPedidos where obj.CodigoCarga == carga.Codigo select obj.NumeroControlePedido).Distinct().ToList();
                    List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> notasCarga = repositorioXmlNotaFiscal.BuscarPorCarga(carga.Codigo);
                    if (!numerosControle.Any(numero => notasCarga.Any(nc => nc.NumeroControlePedido == numero)))
                        recebeuNotasFilhas = false;
                }

                lista.Add(
                    ObterDadosDetalheCarga(
                        carga,
                        tipoServicoMultisoftware,
                        configuracaoTMS,
                        (from obj in cargaVeiculosContainer where obj.Carga.Codigo == carga.Codigo select obj).ToList(),
                        (from obj in cargaVeiculosContainerAnexo where obj.EntidadeAnexo.Carga.Codigo == carga.Codigo select obj).ToList(),
                        (from obj in cargaPedidos where obj.CodigoCarga == carga.Codigo select obj).ToList(),
                        (from obj in cargasCancelamento where obj.Carga.Codigo == carga.Codigo select obj).FirstOrDefault(),
                        (from obj in cargasOrigem where obj.Protocolo == carga.Codigo select obj).ToList(),
                        codigosAgrupados,
                        (from obj in apolicesSeguraAverbacao where obj.CargaPedido.Carga.Codigo == carga.Codigo select obj.ApoliceSeguro).Distinct().ToList(),
                        (from obj in cargasComRota where obj == carga.Codigo select obj).Any(),
                        tipoCargaModeloVeicularAutoConfig,
                        ContratoFreteTerceiro,
                        (from obj in cargaMotorista where obj.Carga.Codigo == carga.Codigo select obj).ToList(),
                        cargaPedidosTransbordos,
                        (from obj in cargaJanelaCarregamento where obj.Carga.Codigo == carga.Codigo select obj).FirstOrDefault(),
                        (from obj in cargaJanelaDescarregamento where obj.Carga.Codigo == carga.Codigo select obj).FirstOrDefault(),
                        (from obj in mensagensAlerta where obj.CodigoEntidade == carga.Codigo select obj).ToList(),
                        permitirLiberarComProblemaIntegracaoGrMotoristaVeiculo,
                        (from obj in agendamentos where obj.Carga.Codigo == carga.Codigo || obj.Carga.CargaAgrupamento?.Codigo == carga.Codigo select obj).FirstOrDefault(),
                        (from o in ordensEmbarque where o.Carga.Codigo == carga.Codigo || o.Carga.CargaAgrupamento?.Codigo == carga.Codigo select o).ToList(),
                        (from obj in cargaOrdensEmbarqueIntegracao where obj.Carga.Codigo == carga.Codigo select obj).FirstOrDefault(),
                        codigosIntegracaoSituacaoOrdemCancelada,
                        motorista,
                        possuiMontagemContainer,
                        (from o in retiradasContainer where o.Carga.Codigo == carga.Codigo select o).FirstOrDefault(),
                        (from obj in termosAceite where obj.Carga.Codigo == carga.Codigo select obj).ToList(),
                        (from obj in janelasTransportador where obj.CargaJanelaCarregamento.Carga.Codigo == carga.Codigo select obj).ToList(),
                        quantidadePallets,
                        possuiSimulacaoFrete,
                        (from obj in EntregasParqueamento where obj.Carga.Codigo == carga.Codigo select obj).ToList(),
                        cargaPreCalculo,
                        dadoDocumentoCarga,
                        integracaoIntercab,
                        contemFaturamento,
                        todosCTesForamFaturados,
                        existePacote,
                        simulacaoFrete,
                        unitOfWork,
                        recebeuNotasFilhas,
                        usuario,
                        listaLinhaSeparacaoDescricaoComCodigoCarga.ToList(),
                        carga.Ajudantes.ToList(),
                        integracoesDoMotorista,
                        integracoesDoVeiculo,
                        monitoramentos,
                        (from o in preCarga where o.Carga.Codigo == carga.Codigo select o).FirstOrDefault(),
                        cargaCIOTList, possuiIntegracaoHUBOfertas
                    )
                );

            }

            return lista;
        }

        public dynamic ObterDetalhesDaCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, Dominio.Entidades.Embarcador.Cargas.TipoCargaModeloVeicularAutoConfig tipoCargaModeloVeicularAutoConfig = null, bool existePacote = false, Dominio.Entidades.Usuario usuario = null)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            if (carga.CargaAgrupamento != null)
                carga = repCarga.BuscarPorCodigo(carga.CargaAgrupamento.Codigo);

            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaRotaFrete repCargaRotaFrete = new Repositorio.Embarcador.Cargas.CargaRotaFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPreCalculo repCargaPreCalculo = new Repositorio.Embarcador.Cargas.CargaPreCalculo(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaVeiculoContainer repCargaVeiculoContainer = new Repositorio.Embarcador.Cargas.CargaVeiculoContainer(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaVeiculoContainerAnexo repCargaVeiculoContainerAnexo = new Repositorio.Embarcador.Cargas.CargaVeiculoContainerAnexo(unitOfWork);
            Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repositorioApoliceSeguroAverbacao = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaCarregamento repCargaJanelaCarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamento(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaMotorista repCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaDescarregamento repCargaJanelaDescarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaDescarregamento(unitOfWork);
            Repositorio.Embarcador.Logistica.AgendamentoColeta repAgendamentoColeta = new Repositorio.Embarcador.Logistica.AgendamentoColeta(unitOfWork);
            Repositorio.Embarcador.Cargas.OrdemEmbarque.CargaOrdemEmbarqueIntegracao repositorioCargaOrdemEmbarqueIntegracao = new Repositorio.Embarcador.Cargas.OrdemEmbarque.CargaOrdemEmbarqueIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarque repositorioOrdemEmbarque = new Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarque(unitOfWork);
            Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarqueSituacao repOrdemEmbarqueSituacao = new Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarqueSituacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.RetiradaContainer repositorioRetiradaContainer = new Repositorio.Embarcador.Pedidos.RetiradaContainer(unitOfWork);
            Repositorio.Embarcador.Veiculos.VeiculoMotorista repVeiculoMotorista = new Repositorio.Embarcador.Veiculos.VeiculoMotorista(unitOfWork);
            Repositorio.Embarcador.WMS.MontagemContainer repositorioMontagemContainer = new Repositorio.Embarcador.WMS.MontagemContainer(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportadorTermoAceite repositorioTransportadorTermoAceite = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportadorTermoAceite(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportador repositorioJanelaTransportador = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportador(unitOfWork);
            Repositorio.Embarcador.Cargas.MontagemCarga.SimulacaoFrete repositorioSimulacaoFrete = new Repositorio.Embarcador.Cargas.MontagemCarga.SimulacaoFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntrega repCargaEntrega = new Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntrega(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaDadosParaProcesamentoDt repCargaDadosParaProcesamentoDt = new Repositorio.Embarcador.Cargas.CargaDadosParaProcesamentoDt(unitOfWork);
            Repositorio.Embarcador.Configuracoes.IntegracaoIntercab repIntegracaoIntercab = new Repositorio.Embarcador.Configuracoes.IntegracaoIntercab(unitOfWork);
            Repositorio.Embarcador.Financeiro.DocumentoFaturamento repDocumentoFaturamento = new Repositorio.Embarcador.Financeiro.DocumentoFaturamento(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repositorioXmlNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Veiculos.VeiculoIntegracao repVeiculoIntegracao = new Repositorio.Embarcador.Veiculos.VeiculoIntegracao(unitOfWork);
            Repositorio.Embarcador.Transportadores.MotoristaIntegracao repMotoristaIntegracao = new Repositorio.Embarcador.Transportadores.MotoristaIntegracao(unitOfWork);
            Repositorio.Embarcador.Logistica.Monitoramento repMonitoramento = new Repositorio.Embarcador.Logistica.Monitoramento(unitOfWork);
            Repositorio.Embarcador.PreCargas.PreCarga repositorioPreCarga = new Repositorio.Embarcador.PreCargas.PreCarga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCIOT repositorioCargaCIOT = new Repositorio.Embarcador.Cargas.CargaCIOT(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork).BuscarPrimeiroRegistro(); ;

            Servicos.Embarcador.Carga.MensagemAlertaCarga servicoMensagemAlerta = new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork, configuracaoGeralCarga);

            Dominio.Entidades.Embarcador.Logistica.AgendamentoColeta agendamentoColeta = repAgendamentoColeta.BuscarPorCarga(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer> cargaVeiculosContainer = repCargaVeiculoContainer.BuscarPorCarga(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainerAnexo> cargaVeiculosContainerAnexo = repCargaVeiculoContainerAnexo.BuscarPorCarga(carga.Codigo);
            List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedido> cargaPedidos = repCargaPedido.BuscarCodigosCargaPedidoPorCarga(carga.Codigo, configuracaoEmbarcador.NaoUsarPesoNotasPallet);
            List<Dominio.ObjetosDeValor.Embarcador.Carga.PedidoTransbordo> cargaPedidosTransbordos = repCargaPedido.BuscarCodigosPedidoTransbordoPorCarga(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoTransportadorTermoAceite> termosAceite = repositorioTransportadorTermoAceite.BuscarPorCargas(new List<int> { carga.Codigo });
            List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoTransportador> janelasTransportador = repositorioJanelaTransportador.BuscarPorCargaESituacao(carga.Codigo, SituacaoCargaJanelaCarregamentoTransportador.Confirmada);

            Dominio.Entidades.Embarcador.Cargas.CargaCancelamento cargaCancelamento = null;
            if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada || carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada)
            {
                Repositorio.Embarcador.Cargas.CargaCancelamento repCargaCancelamento = new Repositorio.Embarcador.Cargas.CargaCancelamento(unitOfWork);
                cargaCancelamento = repCargaCancelamento.BuscarPorCarga(carga.Codigo);
            }
            List<Dominio.ObjetosDeValor.WebService.Carga.Carga> cargasOrigem = new List<Dominio.ObjetosDeValor.WebService.Carga.Carga>();
            List<string> codigosAgrupados = new List<string>();
            if (carga.CargaDeVinculo || carga.CargaPossuiOutrosNumerosEmbarcador)
                codigosAgrupados = carga.CodigosAgrupados.ToList();
            else if (carga.CargaAgrupada)
                cargasOrigem = repCarga.BuscarNumeroCargasAgrupadas(carga.Codigo);

            List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro> apolicesSeguroAverbacao = repositorioApoliceSeguroAverbacao.BuscarApolicesPorCarga(carga.Codigo);

            bool possuiRotaDefinida = repCargaRotaFrete.VerificarSeExistePorCarga(carga.Codigo);
            bool possuiMontagemContainer = repositorioMontagemContainer.BuscarSeExisteCadastrado();
            bool contemFaturamento = repDocumentoFaturamento.CargaContemDocumentoFaturamento(carga.Codigo);
            bool todosCTesForamFaturados = contemFaturamento ? !repDocumentoFaturamento.ContemCTeSemFaturamento(carga.Codigo) : false;

            dynamic ContratoFreteTerceiro = carga.FreteDeTerceiro ? ObterDadosContratoFrete(carga, unitOfWork) : null;

            List<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> motoristas = repCargaMotorista.BuscarPorCarga(carga.Codigo);

            List<Dominio.Entidades.Usuario> ajudantes = carga.Ajudantes?.ToList() ?? new List<Dominio.Entidades.Usuario>();
            Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento = repCargaJanelaCarregamento.BuscarPorCarga(carga.Codigo);
            Dominio.Entidades.Embarcador.Cargas.CargaJanelaDescarregamento cargaJanelaDescarregamento = repCargaJanelaDescarregamento.BuscarPorCarga(carga.Codigo);
            List<Dominio.ObjetosDeValor.Embarcador.Alertas.MensagemAlerta> mensagensAlerta = servicoMensagemAlerta.ObterMensagensPorEntidade(carga.Codigo);
            Dominio.Entidades.Embarcador.Cargas.OrdemEmbarque.CargaOrdemEmbarqueIntegracao cargaOrdemEmbarqueIntegracao = repositorioCargaOrdemEmbarqueIntegracao.BuscarPorCarga(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarque> ordensEmbarque = repositorioOrdemEmbarque.BuscarPorCarga(carga.Codigo);
            List<string> codigosIntegracaoSituacaoOrdemCancelada = repOrdemEmbarqueSituacao.GetCodigosIntegracaoSituacaoOrdemCancelada();
            Dominio.Entidades.Usuario veiculoMotorista = carga.Veiculo != null ? repVeiculoMotorista.BuscarMotoristaPrincipal(carga.Veiculo.Codigo) : null;
            Dominio.Entidades.Embarcador.Pedidos.RetiradaContainer retiradaContainer = repositorioRetiradaContainer.BuscarPorCarga(carga.Codigo);
            Dominio.Entidades.Embarcador.Cargas.CargaPreCalculo cargaPreCalculo = repCargaPreCalculo.BuscarPorCarga(carga.Codigo);
            Dominio.Entidades.Embarcador.Cargas.CargaDadosParaProcessamentoDt dadoDocumentoCarga = repCargaDadosParaProcesamentoDt.BuscarPorCarga(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntrega> EntregasParqueamento = repCargaEntrega.BuscarCargaEntregaParqueamentoPorCargas(new List<int> { carga.Codigo });
            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab = repIntegracaoIntercab.BuscarIntegracao();
            List<Dominio.Entidades.Embarcador.Transportadores.MotoristaIntegracao> integracoesMotorista = repMotoristaIntegracao.BuscarPorMotorista((carga.Motoristas?.FirstOrDefault()?.Codigo ?? 0));
            List<Dominio.Entidades.Embarcador.Veiculos.VeiculoIntegracao> integracoesVeiculo = repVeiculoIntegracao.BuscarPorVeiculo(carga.Veiculo?.Codigo ?? 0);
            Dominio.Entidades.Embarcador.Cargas.MontagemCarga.SimulacaoFrete simulacaoFrete = carga.Carregamento != null ? repositorioSimulacaoFrete.BuscarPorCarregamento(carga.Carregamento.Codigo) : null;
            List<Dominio.ObjetosDeValor.Embarcador.Monitoramento.MonitoramentoDadosDetalhesCarga> monitoramento = repMonitoramento.BuscarDadosMonitoramentoPorCodigosCargasAsync(new List<int> { carga.Codigo }).Result;
            Dominio.Entidades.Embarcador.PreCargas.PreCarga preCarga = repositorioPreCarga.BuscarPorCarga(carga.Codigo);

            decimal quantidadePallets = repCargaPedido.BuscarNumeroPaletesPorCarga(carga.Codigo);
            bool possuiSimulacaoFrete = carga.Carregamento != null ? repositorioSimulacaoFrete.PossuiSimulacaoFrete(carga.Carregamento.Codigo) : false;

            bool? recebeuNotasFilhas = null;

            if (carga?.TipoOperacao?.ConfiguracaoCarga?.PrecisaEsperarNotasFilhaParaGerarPagamento ?? false)
            {
                recebeuNotasFilhas = true;

                List<string> numerosControle = cargaPedidos.Select(cp => cp.NumeroControlePedido).Distinct().ToList();
                List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> notasCarga = repositorioXmlNotaFiscal.BuscarPorCarga(carga.Codigo);

                if (!numerosControle.Any(numero => notasCarga.Any(nc => nc.NumeroControlePedido == numero)))
                    recebeuNotasFilhas = false;
            }
            Dominio.Entidades.Embarcador.Cargas.CargaCIOT cargaCIOT = new Repositorio.Embarcador.Cargas.CargaCIOT(unitOfWork).BuscarPorCarga(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaCIOT> cargaCIOTList = new List<Dominio.Entidades.Embarcador.Cargas.CargaCIOT>();
            if (cargaCIOT != null) cargaCIOTList.Add(cargaCIOT);

            dynamic dynCarga = ObterDadosDetalheCarga(carga, tipoServicoMultisoftware, configuracaoEmbarcador, cargaVeiculosContainer, cargaVeiculosContainerAnexo, cargaPedidos, cargaCancelamento, cargasOrigem, codigosAgrupados, apolicesSeguroAverbacao, possuiRotaDefinida, tipoCargaModeloVeicularAutoConfig, ContratoFreteTerceiro, motoristas, cargaPedidosTransbordos, cargaJanelaCarregamento, cargaJanelaDescarregamento, mensagensAlerta, false, agendamentoColeta, ordensEmbarque, cargaOrdemEmbarqueIntegracao, codigosIntegracaoSituacaoOrdemCancelada, veiculoMotorista, possuiMontagemContainer, retiradaContainer, termosAceite, janelasTransportador, quantidadePallets, possuiSimulacaoFrete, EntregasParqueamento, cargaPreCalculo, dadoDocumentoCarga, integracaoIntercab, contemFaturamento, todosCTesForamFaturados, existePacote, simulacaoFrete, unitOfWork, recebeuNotasFilhas, usuario, null, ajudantes, integracoesMotorista, integracoesVeiculo, monitoramento, preCarga, cargaCIOTList);
            return dynCarga;
        }

        public async Task<dynamic> ObterDetalhesDaCargaAsync(Dominio.Entidades.Embarcador.Cargas.Carga carga,
            AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork,
            Dominio.Entidades.Embarcador.Cargas.TipoCargaModeloVeicularAutoConfig tipoCargaModeloVeicularAutoConfig = null, bool existePacote = false,
            Dominio.Entidades.Usuario usuario = null)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            if (carga.CargaAgrupamento != null)
                carga = await repCarga.BuscarPorCodigoAsync(carga.CargaAgrupamento.Codigo);

            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaRotaFrete repCargaRotaFrete = new Repositorio.Embarcador.Cargas.CargaRotaFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPreCalculo repCargaPreCalculo = new Repositorio.Embarcador.Cargas.CargaPreCalculo(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaVeiculoContainer repCargaVeiculoContainer = new Repositorio.Embarcador.Cargas.CargaVeiculoContainer(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaVeiculoContainerAnexo repCargaVeiculoContainerAnexo = new Repositorio.Embarcador.Cargas.CargaVeiculoContainerAnexo(unitOfWork);
            Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repositorioApoliceSeguroAverbacao = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaCarregamento repCargaJanelaCarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamento(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaMotorista repCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaDescarregamento repCargaJanelaDescarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaDescarregamento(unitOfWork);
            Repositorio.Embarcador.Logistica.AgendamentoColeta repAgendamentoColeta = new Repositorio.Embarcador.Logistica.AgendamentoColeta(unitOfWork);
            Repositorio.Embarcador.Cargas.OrdemEmbarque.CargaOrdemEmbarqueIntegracao repositorioCargaOrdemEmbarqueIntegracao = new Repositorio.Embarcador.Cargas.OrdemEmbarque.CargaOrdemEmbarqueIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarque repositorioOrdemEmbarque = new Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarque(unitOfWork);
            Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarqueSituacao repOrdemEmbarqueSituacao = new Repositorio.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarqueSituacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.RetiradaContainer repositorioRetiradaContainer = new Repositorio.Embarcador.Pedidos.RetiradaContainer(unitOfWork);
            Repositorio.Embarcador.Veiculos.VeiculoMotorista repVeiculoMotorista = new Repositorio.Embarcador.Veiculos.VeiculoMotorista(unitOfWork);
            Repositorio.Embarcador.WMS.MontagemContainer repositorioMontagemContainer = new Repositorio.Embarcador.WMS.MontagemContainer(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportadorTermoAceite repositorioTransportadorTermoAceite = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportadorTermoAceite(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportador repositorioJanelaTransportador = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportador(unitOfWork);
            Repositorio.Embarcador.Cargas.MontagemCarga.SimulacaoFrete repositorioSimulacaoFrete = new Repositorio.Embarcador.Cargas.MontagemCarga.SimulacaoFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntrega repCargaEntrega = new Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntrega(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaDadosParaProcesamentoDt repCargaDadosParaProcesamentoDt = new Repositorio.Embarcador.Cargas.CargaDadosParaProcesamentoDt(unitOfWork);
            Repositorio.Embarcador.Configuracoes.IntegracaoIntercab repIntegracaoIntercab = new Repositorio.Embarcador.Configuracoes.IntegracaoIntercab(unitOfWork);
            Repositorio.Embarcador.Financeiro.DocumentoFaturamento repDocumentoFaturamento = new Repositorio.Embarcador.Financeiro.DocumentoFaturamento(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repositorioXmlNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Veiculos.VeiculoIntegracao repVeiculoIntegracao = new Repositorio.Embarcador.Veiculos.VeiculoIntegracao(unitOfWork);
            Repositorio.Embarcador.Transportadores.MotoristaIntegracao repMotoristaIntegracao = new Repositorio.Embarcador.Transportadores.MotoristaIntegracao(unitOfWork);
            Repositorio.Embarcador.Logistica.Monitoramento repMonitoramento = new Repositorio.Embarcador.Logistica.Monitoramento(unitOfWork);
            Repositorio.Embarcador.PreCargas.PreCarga repositorioPreCarga = new Repositorio.Embarcador.PreCargas.PreCarga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCIOT repositorioCargaCIOT = new Repositorio.Embarcador.Cargas.CargaCIOT(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork).BuscarPrimeiroRegistro(); ;

            Servicos.Embarcador.Carga.MensagemAlertaCarga servicoMensagemAlerta = new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork, configuracaoGeralCarga);

            Dominio.Entidades.Embarcador.Logistica.AgendamentoColeta agendamentoColeta = repAgendamentoColeta.BuscarPorCarga(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer> cargaVeiculosContainer = repCargaVeiculoContainer.BuscarPorCarga(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainerAnexo> cargaVeiculosContainerAnexo = repCargaVeiculoContainerAnexo.BuscarPorCarga(carga.Codigo);
            List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedido> cargaPedidos = repCargaPedido.BuscarCodigosCargaPedidoPorCarga(carga.Codigo, configuracaoEmbarcador.NaoUsarPesoNotasPallet);
            List<Dominio.ObjetosDeValor.Embarcador.Carga.PedidoTransbordo> cargaPedidosTransbordos = repCargaPedido.BuscarCodigosPedidoTransbordoPorCarga(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoTransportadorTermoAceite> termosAceite = repositorioTransportadorTermoAceite.BuscarPorCargas(new List<int> { carga.Codigo });
            List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoTransportador> janelasTransportador = repositorioJanelaTransportador.BuscarPorCargaESituacao(carga.Codigo, SituacaoCargaJanelaCarregamentoTransportador.Confirmada);

            Dominio.Entidades.Embarcador.Cargas.CargaCancelamento cargaCancelamento = null;
            if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada || carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada)
            {
                Repositorio.Embarcador.Cargas.CargaCancelamento repCargaCancelamento = new Repositorio.Embarcador.Cargas.CargaCancelamento(unitOfWork);
                cargaCancelamento = repCargaCancelamento.BuscarPorCarga(carga.Codigo);
            }
            List<Dominio.ObjetosDeValor.WebService.Carga.Carga> cargasOrigem = new List<Dominio.ObjetosDeValor.WebService.Carga.Carga>();
            List<string> codigosAgrupados = new List<string>();
            if (carga.CargaDeVinculo || carga.CargaPossuiOutrosNumerosEmbarcador)
                codigosAgrupados = carga.CodigosAgrupados.ToList();
            else if (carga.CargaAgrupada)
                cargasOrigem = repCarga.BuscarNumeroCargasAgrupadas(carga.Codigo);

            List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro> apolicesSeguroAverbacao = repositorioApoliceSeguroAverbacao.BuscarApolicesPorCarga(carga.Codigo);

            bool possuiRotaDefinida = repCargaRotaFrete.VerificarSeExistePorCarga(carga.Codigo);
            bool possuiMontagemContainer = repositorioMontagemContainer.BuscarSeExisteCadastrado();
            bool contemFaturamento = repDocumentoFaturamento.CargaContemDocumentoFaturamento(carga.Codigo);
            bool todosCTesForamFaturados = contemFaturamento ? !repDocumentoFaturamento.ContemCTeSemFaturamento(carga.Codigo) : false;

            dynamic ContratoFreteTerceiro = carga.FreteDeTerceiro ? ObterDadosContratoFrete(carga, unitOfWork) : null;

            List<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> motoristas = repCargaMotorista.BuscarPorCarga(carga.Codigo);

            List<Dominio.Entidades.Usuario> ajudantes = carga.Ajudantes?.ToList() ?? new List<Dominio.Entidades.Usuario>();
            Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento = repCargaJanelaCarregamento.BuscarPorCarga(carga.Codigo);
            Dominio.Entidades.Embarcador.Cargas.CargaJanelaDescarregamento cargaJanelaDescarregamento = repCargaJanelaDescarregamento.BuscarPorCarga(carga.Codigo);
            List<Dominio.ObjetosDeValor.Embarcador.Alertas.MensagemAlerta> mensagensAlerta = servicoMensagemAlerta.ObterMensagensPorEntidade(carga.Codigo);
            Dominio.Entidades.Embarcador.Cargas.OrdemEmbarque.CargaOrdemEmbarqueIntegracao cargaOrdemEmbarqueIntegracao = repositorioCargaOrdemEmbarqueIntegracao.BuscarPorCarga(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarque> ordensEmbarque = repositorioOrdemEmbarque.BuscarPorCarga(carga.Codigo);
            List<string> codigosIntegracaoSituacaoOrdemCancelada = repOrdemEmbarqueSituacao.GetCodigosIntegracaoSituacaoOrdemCancelada();
            Dominio.Entidades.Usuario veiculoMotorista = carga.Veiculo != null ? repVeiculoMotorista.BuscarMotoristaPrincipal(carga.Veiculo.Codigo) : null;
            Dominio.Entidades.Embarcador.Pedidos.RetiradaContainer retiradaContainer = repositorioRetiradaContainer.BuscarPorCarga(carga.Codigo);
            Dominio.Entidades.Embarcador.Cargas.CargaPreCalculo cargaPreCalculo = repCargaPreCalculo.BuscarPorCarga(carga.Codigo);
            Dominio.Entidades.Embarcador.Cargas.CargaDadosParaProcessamentoDt dadoDocumentoCarga = repCargaDadosParaProcesamentoDt.BuscarPorCarga(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntrega> EntregasParqueamento = repCargaEntrega.BuscarCargaEntregaParqueamentoPorCargas(new List<int> { carga.Codigo });
            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab = repIntegracaoIntercab.BuscarIntegracao();
            List<Dominio.Entidades.Embarcador.Transportadores.MotoristaIntegracao> integracoesMotorista = repMotoristaIntegracao.BuscarPorMotorista((carga.Motoristas?.FirstOrDefault()?.Codigo ?? 0));
            List<Dominio.Entidades.Embarcador.Veiculos.VeiculoIntegracao> integracoesVeiculo = repVeiculoIntegracao.BuscarPorVeiculo(carga.Veiculo?.Codigo ?? 0);
            Dominio.Entidades.Embarcador.Cargas.MontagemCarga.SimulacaoFrete simulacaoFrete = carga.Carregamento != null ? repositorioSimulacaoFrete.BuscarPorCarregamento(carga.Carregamento.Codigo) : null;
            List<Dominio.ObjetosDeValor.Embarcador.Monitoramento.MonitoramentoDadosDetalhesCarga> monitoramento = await repMonitoramento.BuscarDadosMonitoramentoPorCodigosCargasAsync(new List<int> { carga.Codigo });
            Dominio.Entidades.Embarcador.PreCargas.PreCarga preCarga = repositorioPreCarga.BuscarPorCarga(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaCIOT> cargaCIOTList = new List<Dominio.Entidades.Embarcador.Cargas.CargaCIOT>();
            Dominio.Entidades.Embarcador.Cargas.CargaCIOT cargaCIOT = repositorioCargaCIOT.BuscarPorCarga(carga.Codigo);

            if (cargaCIOT != null)
                cargaCIOTList.Add(cargaCIOT);

            decimal quantidadePallets = repCargaPedido.BuscarNumeroPaletesPorCarga(carga.Codigo);
            bool possuiSimulacaoFrete = carga.Carregamento != null ? repositorioSimulacaoFrete.PossuiSimulacaoFrete(carga.Carregamento.Codigo) : false;

            bool? recebeuNotasFilhas = null;

            if (carga?.TipoOperacao?.ConfiguracaoCarga?.PrecisaEsperarNotasFilhaParaGerarPagamento ?? false)
            {
                recebeuNotasFilhas = true;

                List<string> numerosControle = cargaPedidos.Select(cp => cp.NumeroControlePedido).Distinct().ToList();
                List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> notasCarga = repositorioXmlNotaFiscal.BuscarPorCarga(carga.Codigo);

                if (!numerosControle.Any(numero => notasCarga.Any(nc => nc.NumeroControlePedido == numero)))
                    recebeuNotasFilhas = false;
            }

            dynamic dynCarga = ObterDadosDetalheCarga(carga, tipoServicoMultisoftware, configuracaoEmbarcador, cargaVeiculosContainer, cargaVeiculosContainerAnexo, cargaPedidos, cargaCancelamento, cargasOrigem, codigosAgrupados, apolicesSeguroAverbacao, possuiRotaDefinida, tipoCargaModeloVeicularAutoConfig, ContratoFreteTerceiro, motoristas, cargaPedidosTransbordos, cargaJanelaCarregamento, cargaJanelaDescarregamento, mensagensAlerta, false, agendamentoColeta, ordensEmbarque, cargaOrdemEmbarqueIntegracao, codigosIntegracaoSituacaoOrdemCancelada, veiculoMotorista, possuiMontagemContainer, retiradaContainer, termosAceite, janelasTransportador, quantidadePallets, possuiSimulacaoFrete, EntregasParqueamento, cargaPreCalculo, dadoDocumentoCarga, integracaoIntercab, contemFaturamento, todosCTesForamFaturados, existePacote, simulacaoFrete, unitOfWork, recebeuNotasFilhas, usuario, null, ajudantes, integracoesMotorista, integracoesVeiculo, monitoramento, preCarga, cargaCIOTList);
            return dynCarga;
        }

        public dynamic ObterDetalhesDaCargaParaFatura(int codigoFatura, Dominio.Entidades.Embarcador.Cargas.Carga carga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaMotorista repCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);
            Repositorio.Embarcador.Fatura.FaturaCarga repFaturaCarga = new Repositorio.Embarcador.Fatura.FaturaCarga(unitOfWork);
            Repositorio.Embarcador.Fatura.Fatura repFatura = new Repositorio.Embarcador.Fatura.Fatura(unitOfWork);

            Servicos.Embarcador.Carga.Documentos serCargaDocumentos = new Documentos(unitOfWork);
            Servicos.Embarcador.Carga.CargaDadosSumarizados serCargaDadosSumarizados = new Servicos.Embarcador.Carga.CargaDadosSumarizados(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> cargaMotoristas = repCargaMotorista.BuscarPorCarga(carga.Codigo);
            Dominio.Entidades.Embarcador.Fatura.Fatura fatura = repFatura.BuscarPorCodigo(codigoFatura);

            string origem = serCargaDadosSumarizados.ObterOrigemTMS(carga);
            string destino = serCargaDadosSumarizados.ObterDestinos(carga, false);
            if (!string.IsNullOrWhiteSpace(destino) && destino.Contains("<i style='font-size:10px;'>"))
                destino = destino.Replace("<i style='font-size:10px;'>", "");
            string origemDestinos = serCargaDadosSumarizados.ObterOrigemDestinos(carga, true, tipoServicoMultisoftware);

            var dynCarga = new
            {
                carga.Codigo,
                NumeroCarga = carga.CodigoCargaEmbarcador,
                Filial = carga.Filial != null ? carga.Filial.Descricao : "",
                DataCarga = carga.DataCriacaoCarga.ToString("dd/MM/yyyy HH:mm"),
                ValorFatura = repFaturaCarga.ValorConhecimentos(codigoFatura, carga.Codigo),
                NumeroDocumentos = repFaturaCarga.QuantidadeTotalDocumentosCarga(codigoFatura, carga.Codigo),
                Motoristas = (from p in cargaMotoristas
                              select new
                              {
                                  Codigo = p.Motorista.Codigo,
                                  Descricao = p.Motorista.Nome,
                                  CPF = p.Motorista.CPF_Formatado
                              }).ToList(),
                Origem = origem,
                Destino = destino,
                OrigemDestinos = origemDestinos,
                Veiculo = new
                {
                    Codigo = carga.Veiculo != null ? carga.Veiculo.Codigo : 0,
                    Descricao = carga.Veiculo != null ? carga.Veiculo.Placa : "",
                    ModeloVeicularCarga = carga.Veiculo != null && carga.Veiculo.ModeloVeicularCarga != null ? carga.Veiculo.ModeloVeicularCarga.Descricao : ""
                },
                Conjuntos = carga.Veiculo != null ? (from obj in carga.VeiculosVinculados
                                                     select new
                                                     {
                                                         Codigo = obj.Codigo,
                                                         Descricao = obj.Placa,
                                                         ModeloVeicularCarga = obj.ModeloVeicularCarga != null ? obj.ModeloVeicularCarga.Descricao : "",
                                                     }).ToList() : null,
                SituacaoCarga = repFaturaCarga.SituacaoCarga(codigoFatura, carga.Codigo)
            };
            return dynCarga;
        }

        public dynamic ObterDadosCargaPedido(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaFronteira repositorioCargaFronteira = new Repositorio.Embarcador.Cargas.CargaFronteira(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoRotas repCargaPedidoRotas = new Repositorio.Embarcador.Cargas.CargaPedidoRotas(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoRotaFrete repCargaPedidoRotaFrete = new Repositorio.Embarcador.Cargas.CargaPedidoRotaFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoModalidadePagamentoNFAprovacao repCargaPedidoModalidadePagamentoNFAprovacao = new Repositorio.Embarcador.Cargas.CargaPedidoModalidadePagamentoNFAprovacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repApoliceSeguroAverbacao = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.CargaPedidoModalidadePagamentoNFAprovacao cargaPedidoModalidadePagamentoNFAprovacao = repCargaPedidoModalidadePagamentoNFAprovacao.BuscarPorCargaPedido(cargaPedido.Codigo);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoRotas> cargaPedidoRotas = repCargaPedidoRotas.BuscarPorCargaPedido(cargaPedido.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoRotaFrete> cargaPedidoRotaFrete = repCargaPedidoRotaFrete.BuscarPorCargaPedido(cargaPedido.Codigo);
            Dominio.Entidades.Embarcador.Cargas.Carga cargaTrocaNota = repCarga.BuscarCargaPorCargaTrocaNota(cargaPedido.Carga.Codigo);
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> pedidoXMLNotaFiscals = repPedidoXMLNotaFiscal.BuscarPorCargaPedido(cargaPedido.Codigo);
            List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao> apoliceSeguroAverbacoes = repApoliceSeguroAverbacao.BuscarPorCargaPedido(cargaPedido.Codigo);

            int taraContainer = 0;
            int.TryParse(cargaPedido.Pedido?.TaraContainer ?? "", out taraContainer);

            List<Dominio.Entidades.Cliente> fronteiras = repositorioCargaFronteira.BuscarFronteirasPorCarga(cargaPedido.Carga.Codigo);

            var dynCargaPedido = new
            {
                cargaPedido.Pedido.Codigo,
                CodigoCargaPedido = cargaPedido.Codigo,
                cargaPedido.Pedido.NumeroPedidoEmbarcador,
                cargaPedido.Pedido.NumeroBooking,
                cargaPedido.Pedido.ObservacaoCTe,
                cargaPedido.CTeEmitidoNoEmbarcador,
                cargaPedido.Pedido.PedidoTransbordo,
                cargaPedido.Pedido.TipoPagamento,
                cargaPedido.Pedido.PedidoSubContratado,
                cargaPedido.Redespacho,
                Destinatario = cargaPedido?.Pedido?.Destinatario != null ? (cargaPedido.Pedido?.Destinatario?.Descricao + " - " + cargaPedido.Pedido?.Destinatario?.Localidade.DescricaoCidadeEstado + "") : "",
                NotasFiscais = tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador ? string.Join(", ", (from obj in pedidoXMLNotaFiscals select obj.XMLNotaFiscal.Numero)) : "",
                ViagemJaOcorreu = cargaPedido.Pedido.SituacaoPedido == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoPedido.Finalizado ? true : false,
                ModalidadePagamentoNFAgAprovacao = cargaPedidoModalidadePagamentoNFAprovacao != null && cargaPedidoModalidadePagamentoNFAprovacao.SituacaoAutorizacaoModalidadePagamento == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoAutorizacaoModalidadePagamento.AgLiberacao ? true : false,
                cargaPedido.CienciaDoEnvioDaNotaInformado,
                NumeroCargaTrechoAnterior = cargaPedido.CargaPedidoTrechoAnterior != null ? cargaPedido.CargaPedidoTrechoAnterior.Carga.CodigoCargaEmbarcador : "",
                IncluirICMSBC = cargaPedido.IncluirICMSBaseCalculo,
                TipoOperacaoPermiteTrocaNota = cargaPedido.Carga.TipoOperacao?.PermitirTrocaNota ?? false,
                PermitirTransportadorInformarObservacaoImpressaoCarga = cargaPedido.Carga.TipoOperacao?.PermitirTransportadorInformarObservacaoImpressaoCarga ?? false,
                CargaTrocaNota = new
                {
                    Codigo = cargaTrocaNota?.Codigo ?? 0,
                    Descricao = cargaTrocaNota?.Descricao ?? ""
                },
                ApolicesSeguro = (from obj in apoliceSeguroAverbacoes
                                  select new
                                  {
                                      obj.ApoliceSeguro.Codigo,
                                      Seguradora = obj.ApoliceSeguro.Seguradora.Nome,
                                      Responsavel = obj.ApoliceSeguro.DescricaoResponsavel,
                                      obj.ApoliceSeguro.NumeroApolice,
                                      obj.ApoliceSeguro.NumeroAverbacao,
                                      InicioVigencia = obj.ApoliceSeguro.InicioVigencia.ToString("dd/MM/yyyy"),
                                      FimVigencia = obj.ApoliceSeguro.FimVigencia.ToString("dd/MM/yyyy"),
                                      Vigencia = "até " + obj.ApoliceSeguro.FimVigencia.ToString("dd/MM/yyyy")
                                  }).ToList(),
                Origem = new { Codigo = cargaPedido.Origem.Codigo, Descricao = cargaPedido.Origem.DescricaoCidadeEstado },
                Destino = new { Codigo = cargaPedido.Destino != null ? cargaPedido.Destino.Codigo : 0, Descricao = cargaPedido.Destino != null ? cargaPedido.Destino.DescricaoCidadeEstado : "" },
                Filial = new { Codigo = cargaPedido.Pedido.Filial != null ? cargaPedido.Pedido.Filial.Codigo : 0, Descricao = cargaPedido.Pedido.Filial != null ? cargaPedido.Pedido.Filial.Descricao : "" },
                FilialVenda = new { Codigo = cargaPedido.Pedido.FilialVenda != null ? cargaPedido.Pedido.FilialVenda.Codigo : 0, Descricao = cargaPedido.Pedido.FilialVenda != null ? cargaPedido.Pedido.FilialVenda.Descricao : "" },
                Cliente = new
                {
                    Codigo = cargaPedido?.Pedido?.Destinatario != null ? cargaPedido?.Pedido?.Destinatario.CPF_CNPJ : 0,
                    Descricao = cargaPedido?.Pedido?.Destinatario != null ? cargaPedido?.Pedido?.Destinatario.Nome : "",
                    CPF_CNPJ = cargaPedido?.Pedido?.Destinatario != null ? cargaPedido?.Pedido?.Destinatario.CPF_CNPJ_Formatado : "",
                },
                Tomador = new
                {
                    Codigo = cargaPedido.Tomador != null ? cargaPedido.Tomador.CPF_CNPJ : 0,
                    CPF_CNPJ = cargaPedido.Tomador != null ? cargaPedido.Tomador.CPF_CNPJ_Formatado : "",
                    Nome = cargaPedido.Tomador != null ? cargaPedido.Tomador.Nome : "",
                    Descricao = cargaPedido.Tomador != null ? cargaPedido.Tomador.Nome : "",
                    Localidade = cargaPedido.Tomador != null ? new { cargaPedido.Tomador.Localidade.Codigo, Descricao = cargaPedido.Tomador.Localidade.DescricaoCidadeEstado } : null
                },
                Remetente = new
                {
                    Codigo = cargaPedido.Pedido.Remetente != null ? cargaPedido.Pedido.Remetente.CPF_CNPJ : 0,
                    Descricao = cargaPedido.Pedido.Remetente != null ? cargaPedido.Pedido.Remetente.Nome : "",
                    CPF_CNPJ = cargaPedido.Pedido.Remetente != null ? cargaPedido.Pedido.Remetente.CPF_CNPJ_Formatado : ""
                },
                FormulaRateio = cargaPedido.FormulaRateio != null ? new { cargaPedido.FormulaRateio.Codigo, cargaPedido.FormulaRateio.Descricao, cargaPedido.FormulaRateio.ParametroRateioFormula } : new { Codigo = 0, Descricao = "", ParametroRateioFormula = ParametroRateioFormula.todos },
                cargaPedido.Pedido.UsarTipoPagamentoNF,
                numeroPaletes = cargaPedido.Pedido.NumeroPaletes,
                observacaoInterna = cargaPedido.Pedido.ObservacaoInterna,
                PrevisaoEntrega = cargaPedido.Pedido.PrevisaoEntrega != null ? cargaPedido.Pedido.PrevisaoEntrega.Value.ToString("dd/MM/yyyy HH:mm") : "",
                cargaPedido.Pedido.SituacaoPedido,
                cargaPedido.TipoEmissaoCTeParticipantes,
                cargaPedido.TipoRateio,
                cargaPedido.Pedido.TipoOperacaoEmissao,
                Empresa = cargaPedido.Carga.Empresa != null ? new { Descricao = cargaPedido.Carga.Empresa.Descricao, cargaPedido.Carga.Empresa.Codigo } : null,
                RotasFrete = (from obj in cargaPedidoRotaFrete
                              select new
                              {
                                  Codigo = obj.RotaFrete.Codigo,
                                  Descricao = obj.RotaFrete.Descricao
                              }).ToList(),
                CargaPedidoRotas = (from obj in cargaPedidoRotas
                                    select new
                                    {
                                        obj.Codigo,
                                        obj.IdenticacaoRota
                                    }).ToList(),
                Recebedor = new
                {
                    Codigo = cargaPedido.Recebedor != null ? cargaPedido.Recebedor.CPF_CNPJ : 0,
                    CPF_CNPJ = cargaPedido.Recebedor != null ? cargaPedido.Recebedor.CPF_CNPJ_Formatado : "",
                    Nome = cargaPedido.Recebedor != null ? cargaPedido.Recebedor.Nome : "",
                    Descricao = cargaPedido.Recebedor != null ? cargaPedido.Recebedor.Nome : "",
                    Localidade = cargaPedido.Recebedor != null ? new { cargaPedido.Recebedor.Localidade.Codigo, Descricao = cargaPedido.Recebedor.Localidade.DescricaoCidadeEstado } : null
                },
                Expedidor = new
                {
                    Codigo = cargaPedido.Expedidor != null ? cargaPedido.Expedidor.CPF_CNPJ : 0,
                    CPF_CNPJ = cargaPedido.Expedidor != null ? cargaPedido.Expedidor.CPF_CNPJ_Formatado : "",
                    Nome = cargaPedido.Expedidor != null ? cargaPedido.Expedidor.Nome : "",
                    Descricao = cargaPedido.Expedidor != null ? cargaPedido.Expedidor.Nome : "",
                    Localidade = cargaPedido.Expedidor != null ? new { cargaPedido.Expedidor.Localidade.Codigo, Descricao = cargaPedido.Expedidor.Localidade.DescricaoCidadeEstado } : null
                },
                PesoTotal = cargaPedido.Peso,
                cargaPedido.Pedido.AdicionadaManualmente,
                Fronteiras = (from o in fronteiras
                              select new
                              {
                                  o.Codigo,
                                  o.Nome,
                                  o.Descricao,
                                  o.Latitude,
                                  o.Longitude,
                              }).ToList(),
                TaraContainer = taraContainer.ToString("D"),
                cargaPedido.Pedido.LacreContainerUm,
                cargaPedido.Pedido.LacreContainerDois,
                cargaPedido.Pedido.LacreContainerTres,
                DataPrevisaoSaida = cargaPedido.Pedido.DataPrevisaoSaida.HasValue ? cargaPedido.Pedido.DataPrevisaoSaida.Value.ToString("dd/MM/yyyy HH:mm") : "",
                DataPrevisaoEntrega = cargaPedido.Pedido.PrevisaoEntrega.HasValue ? cargaPedido.Pedido.PrevisaoEntrega.Value.ToString("dd/MM/yyyy HH:mm") : "",
                DataAgendamento = cargaPedido.Pedido.DataAgendamento.HasValue ? cargaPedido.Pedido.DataAgendamento.Value.ToString("dd/MM/yyyy HH:mm") : "",
                Container = new
                {
                    Codigo = cargaPedido.Pedido.Container?.Codigo ?? 0,
                    Descricao = cargaPedido.Pedido.Container?.Descricao ?? string.Empty
                },
                ContainerTipoReserva = new
                {
                    Codigo = cargaPedido.Pedido.ContainerTipoReserva?.Codigo ?? 0,
                    Descricao = cargaPedido.Pedido.ContainerTipoReserva?.Descricao ?? string.Empty
                },
                ContainerTipo = new
                {
                    Codigo = cargaPedido.Pedido.Container?.ContainerTipo?.Codigo ?? 0,
                    Descricao = cargaPedido.Pedido.Container?.ContainerTipo?.Descricao ?? string.Empty
                },
                EnderecoDestinatario = new
                {
                    Codigo = cargaPedido.Pedido.UsarOutroEnderecoDestino && cargaPedido.Pedido.EnderecoDestino != null ? cargaPedido.Pedido.EnderecoDestino?.ClienteOutroEndereco?.Codigo ?? 0 : 0,
                    Descricao = cargaPedido.Pedido.UsarOutroEnderecoDestino && cargaPedido.Pedido.EnderecoDestino != null ? cargaPedido.Pedido.EnderecoDestino?.ClienteOutroEndereco?.Descricao ?? string.Empty : string.Empty
                },
                EnderecoRecebedor = new
                {
                    Codigo = cargaPedido.Pedido.EnderecoRecebedor != null ? cargaPedido.Pedido.EnderecoRecebedor?.ClienteOutroEndereco?.Codigo ?? 0 : 0,
                    Descricao = cargaPedido.Pedido.EnderecoRecebedor != null ? cargaPedido.Pedido.EnderecoRecebedor?.ClienteOutroEndereco?.Descricao ?? string.Empty : string.Empty
                },
                EnderecoExpedidor = new
                {
                    Codigo = cargaPedido.Pedido.EnderecoExpedidor != null ? cargaPedido.Pedido.EnderecoExpedidor?.ClienteOutroEndereco?.Codigo ?? 0 : 0,
                    Descricao = cargaPedido.Pedido.EnderecoExpedidor != null ? cargaPedido.Pedido.EnderecoExpedidor?.ClienteOutroEndereco?.Descricao ?? string.Empty : string.Empty
                },
                cargaPedido.TipoCobrancaMultimodal,
                cargaPedido.ModalPropostaMultimodal,
                cargaPedido.TipoServicoMultimodal,
                cargaPedido.TipoPropostaMultimodal,
                HabilitarConsultaContainerEMP = (cargaPedido.Pedido.TipoOperacao?.ConfiguracaoCarga?.HabilitarConsultaContainerEMP ?? false),
                cargaPedido.TipoUsoFatorCubagemRateioFormula,
                FatorCubagemRateioFormula = cargaPedido.FatorCubagemRateioFormula?.ToString("N2") ?? "",
            };

            return dynCargaPedido;
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga DuplicarCarga(int codigoCarga, bool liberarPedidosParaMontagemCarga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {

            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCancelamento repCargaCancelamento = new Repositorio.Embarcador.Cargas.CargaCancelamento(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaComplementoFrete repCargaComplementoFrete = new Repositorio.Embarcador.Cargas.CargaComplementoFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaComponentesFrete repCargaComponentesFrete = new Repositorio.Embarcador.Cargas.CargaComponentesFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCTeComplementoInfo repCargaCTeComplementoInfo = new Repositorio.Embarcador.Cargas.CargaCTeComplementoInfo(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCTeComponentesFrete repCargaCTeComponentesFrete = new Repositorio.Embarcador.Cargas.CargaCTeComponentesFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaIntegracao repCargaIntegracao = new Repositorio.Embarcador.Cargas.CargaIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCTeIntegracao repCargaCTeIntegracao = new Repositorio.Embarcador.Cargas.CargaCTeIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCTeIntegracaoLote repCargaCTeIntegracaoLote = new Repositorio.Embarcador.Cargas.CargaCTeIntegracaoLote(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaIntegracaoNatura repCargaIntegracaoNatura = new Repositorio.Embarcador.Cargas.CargaIntegracaoNatura(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaIntegracaoAvon repCargaIntegracaoAvon = new Repositorio.Embarcador.Cargas.CargaIntegracaoAvon(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaEDIIntegracao repCargaEDIIntegracao = new Repositorio.Embarcador.Cargas.CargaEDIIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCargaIntegracao repCargaCargaIntegracao = new Repositorio.Embarcador.Cargas.CargaCargaIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.ValePedagio.CargaValePedagioRota repCargaValePedagioRota = new Repositorio.Embarcador.Cargas.ValePedagio.CargaValePedagioRota(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoRotaFrete repCargaPedidoRotaFrete = new Repositorio.Embarcador.Cargas.CargaPedidoRotaFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaValePedagio repCargaValePedagio = new Repositorio.Embarcador.Cargas.CargaValePedagio(unitOfWork);

            Repositorio.Embarcador.Cargas.CargaLocaisPrestacao repCargaLocaisPrestacao = new Repositorio.Embarcador.Cargas.CargaLocaisPrestacao(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaLocaisPrestacaoPassagens repCargaLocaisPrestacaoPassagens = new Repositorio.Embarcador.Cargas.CargaLocaisPrestacaoPassagens(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaMotorista repCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoComponentesFrete repCargaPedidoComponentesFrete = new Repositorio.Embarcador.Cargas.CargaPedidoComponentesFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoProduto repCargaPedidoProduto = new Repositorio.Embarcador.Cargas.CargaPedidoProduto(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoQuantidades repCargaPedidoQuantidades = new Repositorio.Embarcador.Cargas.CargaPedidoQuantidades(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoRotas repCargaPedidoRotas = new Repositorio.Embarcador.Cargas.CargaPedidoRotas(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPercurso repCargaPercurso = new Repositorio.Embarcador.Cargas.CargaPercurso(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaTabelaFreteCliente repCargaTabelaFreteCliente = new Repositorio.Embarcador.Cargas.CargaTabelaFreteCliente(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaTabelaFreteComponenteFrete repCargaTabelaFreteComponenteFrete = new Repositorio.Embarcador.Cargas.CargaTabelaFreteComponenteFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaTabelaFreteRota repCargaTabelaFreteRota = new Repositorio.Embarcador.Cargas.CargaTabelaFreteRota(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaTabelaFreteSubContratacao repCargaTabelaFreteSubContratacao = new Repositorio.Embarcador.Cargas.CargaTabelaFreteSubContratacao(unitOfWork);
            Repositorio.Embarcador.Canhotos.CanhotoAvulso repCanhotoAvulso = new Repositorio.Embarcador.Canhotos.CanhotoAvulso(unitOfWork);
            Repositorio.Embarcador.Pallets.DevolucaoPallet repDevolucaoPallets = new Repositorio.Embarcador.Pallets.DevolucaoPallet(unitOfWork);
            Repositorio.Embarcador.Canhotos.Canhoto repCanhoto = new Repositorio.Embarcador.Canhotos.Canhoto(unitOfWork);
            Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoPedido repCarregamentoPedido = new Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoPedido(unitOfWork);

            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoProduto repPedidoProduto = new Repositorio.Embarcador.Pedidos.PedidoProduto(unitOfWork);
            Repositorio.Embarcador.Creditos.SolicitacaoCredito repSolicitacaoCredito = new Repositorio.Embarcador.Creditos.SolicitacaoCredito(unitOfWork);
            Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unitOfWork);
            Repositorio.Usuario repUsuario = new Repositorio.Usuario(unitOfWork);
            Repositorio.Embarcador.Seguros.ApoliceSeguro repApoliceSeguro = new Repositorio.Embarcador.Seguros.ApoliceSeguro(unitOfWork);
            Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repApoliceSeguroAverbacao = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);
            Repositorio.AverbacaoMDFe repAverbacaoMDFe = new Repositorio.AverbacaoMDFe(unitOfWork);
            Repositorio.AverbacaoCTe repAverbacaoCTe = new Repositorio.AverbacaoCTe(unitOfWork);
            Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio repCargaIntegracaoValePedagio = new Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio(unitOfWork);

            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao repPedidoCTeParaSubContratacao = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacaoPedidoNotaFiscal repPedidoCTeParaSubContratacaoPedidoNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacaoPedidoNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCteParaSubContratacaoComponenteFrete repPedidoCTeParaSubContratacaoComponenteFrete = new Repositorio.Embarcador.Pedidos.PedidoCteParaSubContratacaoComponenteFrete(unitOfWork);

            Repositorio.Embarcador.CTe.CTeTerceiro repCTeTerceiro = new Repositorio.Embarcador.CTe.CTeTerceiro(unitOfWork);
            Repositorio.Embarcador.CTe.CTeTerceiroNotaFiscal repCTeTerceiroNotaFiscal = new Repositorio.Embarcador.CTe.CTeTerceiroNotaFiscal(unitOfWork);
            Repositorio.Embarcador.CTe.CTeTerceiroQuantidade repCTeTerceiroQuantidade = new Repositorio.Embarcador.CTe.CTeTerceiroQuantidade(unitOfWork);
            Repositorio.Embarcador.CTe.CTeTerceiroNFe repCTeTerceiroNFe = new Repositorio.Embarcador.CTe.CTeTerceiroNFe(unitOfWork);
            Repositorio.Embarcador.CTe.CTeTerceiroOutrosDocumentos repCTeTerceiroOutrosDocumentos = new Repositorio.Embarcador.CTe.CTeTerceiroOutrosDocumentos(unitOfWork);
            Repositorio.Embarcador.CTe.CTeTerceiroSeguro repCTeTerceiroSeguro = new Repositorio.Embarcador.CTe.CTeTerceiroSeguro(unitOfWork);
            Repositorio.Embarcador.CTe.CTeTerceiroDimensao repCTeTerceiroDimensao = new Repositorio.Embarcador.CTe.CTeTerceiroDimensao(unitOfWork);
            Repositorio.Embarcador.CTe.CTeTerceiroXML repCTeTerceiroXML = new Repositorio.Embarcador.CTe.CTeTerceiroXML(unitOfWork);

            Repositorio.Embarcador.Cargas.CargaMDFe repCargaMDFe = new Repositorio.Embarcador.Cargas.CargaMDFe(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCTe repCargaCTe = new Repositorio.Embarcador.Cargas.CargaCTe(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaNFS repCargaNFS = new Repositorio.Embarcador.Cargas.CargaNFS(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaDocumentoParaEmissaoNFSManual repCargaDocumentoParaEmissaoNFSManual = new Repositorio.Embarcador.Cargas.CargaDocumentoParaEmissaoNFSManual(unitOfWork);
            Repositorio.Embarcador.Rateio.RateioCargaPedidoProduto repRateioCargaPedidoProduto = new Repositorio.Embarcador.Rateio.RateioCargaPedidoProduto(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaMDFeManual repCargaMDFeManual = new Repositorio.Embarcador.Cargas.CargaMDFeManual(unitOfWork);

            Repositorio.Embarcador.Financeiro.DocumentoFaturamento repDocumentoFaturamento = new Repositorio.Embarcador.Financeiro.DocumentoFaturamento(unitOfWork);
            Repositorio.Embarcador.Financeiro.TituloDocumento repTituloDocumento = new Repositorio.Embarcador.Financeiro.TituloDocumento(unitOfWork);
            Repositorio.Embarcador.Terceiros.ContratoFrete repContratoFrete = new Repositorio.Embarcador.Terceiros.ContratoFrete(unitOfWork);
            Repositorio.Embarcador.Terceiros.AprovacaoAlcadaContratoFrete repAprovacaoAlcadaContratoFrete = new Repositorio.Embarcador.Terceiros.AprovacaoAlcadaContratoFrete(unitOfWork);
            Repositorio.Embarcador.Terceiros.ContratoFreteCTe repContratoFreteCTe = new Repositorio.Embarcador.Terceiros.ContratoFreteCTe(unitOfWork);
            Repositorio.Embarcador.Financeiro.Titulo repTitulo = new Repositorio.Embarcador.Financeiro.Titulo(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCIOT repCargaCIOT = new Repositorio.Embarcador.Cargas.CargaCIOT(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoComponenteFrete repPedidoComponenteFrete = new Repositorio.Embarcador.Pedidos.PedidoComponenteFrete(unitOfWork);

            Servicos.Embarcador.Canhotos.Canhoto serCanhoto = new Canhotos.Canhoto(unitOfWork);
            Servicos.Embarcador.Carga.CargaRotaFrete servicoCargaRotaFrete = new Servicos.Embarcador.Carga.CargaRotaFrete(unitOfWork);

            Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe repCargaPedidoDocumentoCTe = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoDocumentoMDFe repCargaPedidoDocumentoMDFe = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoMDFe(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS config = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao();

            Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga = repCarga.BuscarPorCodigo(codigoCarga);

            List<Dominio.Entidades.Embarcador.Cargas.CargaComplementoFrete> listaCargaComplementoFreteAntiga = repCargaComplementoFrete.BuscarPorCarga(codigoCarga);
            List<Dominio.Entidades.Embarcador.Cargas.CargaComponentesFrete> listaCargaComponentesFreteAntiga = repCargaComponentesFrete.BuscarPorCarga(codigoCarga);
            List<Dominio.Entidades.Embarcador.Cargas.CargaIntegracao> listaCargaIntegracao = repCargaIntegracao.BuscarPorCarga(codigoCarga);
            List<Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacao> listaCargaLocaisPrestacao = repCargaLocaisPrestacao.BuscarPorCarga(codigoCarga);
            List<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> listaCargaMotorista = repCargaMotorista.BuscarPorCarga(codigoCarga);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> listaCargaPedido = repCargaPedido.BuscarPorCarga(codigoCarga);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPercurso> listaCargaPercurso = repCargaPercurso.ConsultarPorCarga(codigoCarga);
            List<Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteCliente> cargaTabelaFretesClienteAntiga = repCargaTabelaFreteCliente.BuscarPorCarga(codigoCarga);
            List<Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteComponenteFrete> listaCargaTabelaFreteComponenteFrete = repCargaTabelaFreteComponenteFrete.BuscarPorCarga(codigoCarga);
            List<Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteRota> cargaTabelaFretesRotaAntiga = repCargaTabelaFreteRota.BuscarPorCarga(codigoCarga);
            List<Dominio.Entidades.Embarcador.Cargas.CargaMDFeManual> cargaMDFeManuais = repCargaMDFeManual.BuscarTodosPorCarga(codigoCarga);
            Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteSubContratacao cargaTabelaFreteSubContratacaoAntiga = repCargaTabelaFreteSubContratacao.BuscarPorCarga(codigoCarga);
            Dominio.Entidades.Embarcador.Terceiros.ContratoFrete contratoFrete = repContratoFrete.BuscarPorCarga(codigoCarga);
            List<Dominio.Entidades.Embarcador.Financeiro.Titulo> titulosContratoFrete = new List<Dominio.Entidades.Embarcador.Financeiro.Titulo>();

            if (contratoFrete != null)
                titulosContratoFrete = repTitulo.BuscarTodosPorContratoFrete(contratoFrete.Codigo);

            if (cargaAntiga == null)
                return null;

            Dominio.Entidades.Embarcador.Cargas.CargaCancelamento cargaCancelamento = repCargaCancelamento.BuscarPorCarga(codigoCarga);

            Dominio.Entidades.Embarcador.Cargas.Carga novaCarga = GerarCargaDuplicada(cargaAntiga, cargaCancelamento, cargaAntiga.SituacaoCarga, null, false, unitOfWork, tipoServicoMultisoftware);

            servicoCargaRotaFrete.DuplicarCargaRotaFrete(novaCarga, cargaAntiga);

            Dominio.Entidades.Embarcador.Cargas.CargaCIOT cargaCIOT = repCargaCIOT.BuscarPorCarga(cargaAntiga.Codigo);

            if (cargaCIOT != null)
            {
                cargaCIOT.Carga = novaCarga;
                repCargaCIOT.Atualizar(cargaCIOT);
            }

            if (contratoFrete != null)
            {
                Dominio.Entidades.Embarcador.Terceiros.ContratoFrete contratoFreteNovo = contratoFrete.Clonar();
                contratoFreteNovo.Carga = novaCarga;
                Utilidades.Object.DefinirListasGenericasComoNulas(contratoFreteNovo);

                repContratoFrete.Inserir(contratoFreteNovo);

                foreach (Dominio.Entidades.Embarcador.Terceiros.AprovacaoAlcadaContratoFrete alcada in contratoFrete.ContratoAutorizacoes)
                {
                    alcada.ContratoFrete = contratoFreteNovo;
                    repAprovacaoAlcadaContratoFrete.Atualizar(alcada);
                }

                foreach (Dominio.Entidades.Embarcador.Financeiro.Titulo titulo in titulosContratoFrete)
                {
                    titulo.ContratoFrete = contratoFreteNovo;
                    repTitulo.Atualizar(titulo);
                }

                foreach (Dominio.Entidades.Embarcador.Terceiros.ContratoFreteCTe cte in contratoFrete.CTes)
                {
                    cte.ContratoFrete = contratoFreteNovo;
                    repContratoFreteCTe.Atualizar(cte);
                }

                contratoFrete.SituacaoContratoFrete = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoContratoFrete.Aberto;
                repContratoFrete.Atualizar(contratoFrete);
            }

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaMDFeManual cargaMDFeManual in cargaMDFeManuais)
            {
                cargaMDFeManual.Cargas.Remove(cargaAntiga);
                cargaMDFeManual.Cargas.Add(novaCarga);

                repCargaMDFeManual.Atualizar(cargaMDFeManual);
            }

            Dominio.Entidades.Embarcador.Financeiro.DocumentoFaturamento documentoFaturamento = repDocumentoFaturamento.BuscarPorCarga(cargaAntiga.Codigo);

            if (documentoFaturamento != null)
            {
                documentoFaturamento.Carga = novaCarga;
                repDocumentoFaturamento.Atualizar(documentoFaturamento);
            }

            List<Dominio.Entidades.Embarcador.Financeiro.TituloDocumento> tituloDocumentos = repTituloDocumento.BuscarPorCarga(cargaAntiga.Codigo);
            foreach (Dominio.Entidades.Embarcador.Financeiro.TituloDocumento tituloDocumento in tituloDocumentos)
            {
                tituloDocumento.Carga = novaCarga;
                repTituloDocumento.Atualizar(tituloDocumento);
            }

            List<Dominio.Entidades.Veiculo> veiculoVinculados = cargaAntiga.VeiculosVinculados.ToList();
            if (veiculoVinculados.Count > 0)
            {
                novaCarga.VeiculosVinculados = new List<Dominio.Entidades.Veiculo>();
                for (int i = 0; i < veiculoVinculados.Count; i++)
                {
                    Dominio.Entidades.Veiculo veiculo = repVeiculo.BuscarPorCodigo(veiculoVinculados[i].Codigo);
                    novaCarga.VeiculosVinculados.Add(veiculo);
                }
                repCarga.Atualizar(novaCarga);
            }

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteCliente cargaTabelaFreteClienteAntiga in cargaTabelaFretesClienteAntiga)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteCliente novaCargaTabelaFreteCliente = new Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteCliente();
                novaCargaTabelaFreteCliente = cargaTabelaFreteClienteAntiga.Clonar();
                novaCargaTabelaFreteCliente.Carga = novaCarga;

                repCargaTabelaFreteCliente.Inserir(novaCargaTabelaFreteCliente);
            }

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteRota cargaTabelaFreteRotaAntiga in cargaTabelaFretesRotaAntiga)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteRota novaCargaTabelaFreteRota = new Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteRota();
                novaCargaTabelaFreteRota = cargaTabelaFreteRotaAntiga.Clonar();
                novaCargaTabelaFreteRota.Carga = novaCarga;

                repCargaTabelaFreteRota.Inserir(novaCargaTabelaFreteRota);
            }

            if (cargaTabelaFreteSubContratacaoAntiga != null)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteSubContratacao novaCargaTabelaFreteSubContratacao = new Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteSubContratacao();
                novaCargaTabelaFreteSubContratacao = cargaTabelaFreteSubContratacaoAntiga.Clonar();
                novaCargaTabelaFreteSubContratacao.Carga = novaCarga;

                repCargaTabelaFreteSubContratacao.Inserir(novaCargaTabelaFreteSubContratacao);
            }

            for (int i = 0; i < listaCargaComplementoFreteAntiga.Count; i++)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaComplementoFrete novaCargaComplementoFrete = new Dominio.Entidades.Embarcador.Cargas.CargaComplementoFrete();
                novaCargaComplementoFrete = listaCargaComplementoFreteAntiga[i].Clonar();
                novaCargaComplementoFrete.Carga = novaCarga;

                if (listaCargaComplementoFreteAntiga[i].SolicitacaoCredito != null)
                {
                    Dominio.Entidades.Embarcador.Creditos.SolicitacaoCredito novaSolicitacaoCredito = new Dominio.Entidades.Embarcador.Creditos.SolicitacaoCredito();
                    novaSolicitacaoCredito = listaCargaComplementoFreteAntiga[i].SolicitacaoCredito.Clonar();
                    novaSolicitacaoCredito.Carga = novaCarga;
                    repSolicitacaoCredito.Inserir(novaSolicitacaoCredito);

                    novaCargaComplementoFrete.SolicitacaoCredito = novaSolicitacaoCredito;
                }

                repCargaComplementoFrete.Inserir(novaCargaComplementoFrete);
            }

            for (int i = 0; i < listaCargaComponentesFreteAntiga.Count; i++)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaComponentesFrete novaCargaComponentesFrete = new Dominio.Entidades.Embarcador.Cargas.CargaComponentesFrete();
                novaCargaComponentesFrete = listaCargaComponentesFreteAntiga[i].Clonar();
                novaCargaComponentesFrete.Carga = novaCarga;

                if (listaCargaComponentesFreteAntiga[i].CargaComplementoFrete != null)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaComplementoFrete novoCargaComplementoFrete = new Dominio.Entidades.Embarcador.Cargas.CargaComplementoFrete();
                    novoCargaComplementoFrete = listaCargaComponentesFreteAntiga[i].CargaComplementoFrete.Clonar();
                    novoCargaComplementoFrete.Carga = novaCarga;
                    repCargaComplementoFrete.Inserir(novoCargaComplementoFrete);

                    novaCargaComponentesFrete.CargaComplementoFrete = novoCargaComplementoFrete;
                }

                repCargaComponentesFrete.Inserir(novaCargaComponentesFrete);
            }


            for (int i = 0; i < listaCargaIntegracao.Count; i++)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaIntegracao novaCargaIntegracao = new Dominio.Entidades.Embarcador.Cargas.CargaIntegracao();
                novaCargaIntegracao = listaCargaIntegracao[i].Clonar();
                novaCarga.SituacaoCarga = SituacaoCarga.AgIntegracao;
                novaCargaIntegracao.Carga = novaCarga;
                repCargaIntegracao.Inserir(novaCargaIntegracao);
            }

            for (int i = 0; i < listaCargaLocaisPrestacao.Count; i++)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacao novaCargaLocaisPrestacao = new Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacao();
                novaCargaLocaisPrestacao = listaCargaLocaisPrestacao[i].Clonar();
                novaCargaLocaisPrestacao.Carga = novaCarga;
                repCargaLocaisPrestacao.Inserir(novaCargaLocaisPrestacao);

                List<Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacaoPassagens> listaCargaLocaisPrestacaoPassagens = repCargaLocaisPrestacaoPassagens.BuscarPorLocalPrestacao(listaCargaLocaisPrestacao[i].Codigo);

                for (int a = 0; a < listaCargaLocaisPrestacaoPassagens.Count; a++)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacaoPassagens novaCargaLocaisPrestacaoPassagens = new Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacaoPassagens();
                    novaCargaLocaisPrestacaoPassagens = listaCargaLocaisPrestacaoPassagens[a].Clonar();
                    novaCargaLocaisPrestacaoPassagens.CargaLocaisPrestacao = novaCargaLocaisPrestacao;
                    repCargaLocaisPrestacaoPassagens.Inserir(novaCargaLocaisPrestacaoPassagens);
                }
            }

            for (int i = 0; i < listaCargaMotorista.Count; i++)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaMotorista novaCargaMotorista = new Dominio.Entidades.Embarcador.Cargas.CargaMotorista();
                novaCargaMotorista = listaCargaMotorista[i].Clonar();
                novaCargaMotorista.Carga = novaCarga;
                repCargaMotorista.Inserir(novaCargaMotorista);
            }

            for (int i = 0; i < listaCargaPedido.Count; i++)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntiga = listaCargaPedido[i];

                if (liberarPedidosParaMontagemCarga && cargaPedidoAntiga.Pedido != null)
                {
                    Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoOriginal = cargaPedidoAntiga.Pedido;
                    Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoClonado = pedidoOriginal.Clonar();
                    Utilidades.Object.DefinirListasGenericasComoNulas(pedidoClonado);

                    pedidoClonado.SituacaoPedido = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoPedido.Cancelado;
                    pedidoOriginal.GerarAutomaticamenteCargaDoPedido = false;
                    pedidoOriginal.PedidoTotalmenteCarregado = false;
                    pedidoOriginal.PedidoRedespachoTotalmenteCarregado = false;
                    pedidoOriginal.SituacaoAcompanhamentoPedido = SituacaoAcompanhamentoPedido.AgColeta;
                    cargaPedidoAntiga.Pedido = pedidoClonado;
                    //TODO: PPC - Adicionado log temporário para identificar problema de retorno de saldo de pedido.
                    //Servicos.Log.TratarErro($"Pedido {pedidoOriginal.NumeroPedidoEmbarcador} - Liberou saldo pedido {pedidoOriginal.PesoSaldoRestante} - Peso Total.: {pedidoOriginal.PesoTotal} - Totalmente carregado.: {pedidoOriginal.PedidoTotalmenteCarregado}. Carga.DuplicarCarga", "SaldoPedido");

                    List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedido> carregamentoPedidos = repCarregamentoPedido.BuscarPorPedido(pedidoOriginal.Codigo);
                    foreach (Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedido carregamentoPedido in carregamentoPedidos)
                        repCarregamentoPedido.Deletar(carregamentoPedido);

                    if (pedidoClonado.ValorTaxaFeeder > 0)
                    {
                        pedidoClonado.ValorFreteNegociado = pedidoClonado.ValorTaxaFeeder > 0 ? (pedidoClonado.ValorFreteNegociado / pedidoClonado.ValorTaxaFeeder) : pedidoClonado.ValorFreteNegociado;

                        List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete> cargaPedidoComponentesFretes = repCargaPedidoComponentesFrete.BuscarPorPedido(pedidoClonado.Codigo);
                        foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete componente in cargaPedidoComponentesFretes)
                        {
                            componente.ValorComponente = pedidoClonado.ValorTaxaFeeder > 0 ? (componente.ValorComponente / pedidoClonado.ValorTaxaFeeder) : componente.ValorComponente;
                            repCargaPedidoComponentesFrete.Atualizar(componente);
                        }
                        List<Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete> pedidoComponenteFretes = repPedidoComponenteFrete.BuscarPorPedido(pedidoClonado.Codigo);
                        foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete componente in pedidoComponenteFretes)
                        {
                            componente.ValorComponente = pedidoClonado.ValorTaxaFeeder > 0 ? (componente.ValorComponente / pedidoClonado.ValorTaxaFeeder) : componente.ValorComponente;
                            repPedidoComponenteFrete.Atualizar(componente);
                        }

                        if (!string.IsNullOrWhiteSpace(pedidoClonado.ObservacaoCTe) && pedidoClonado.ObservacaoCTe.Contains("Conversão de valor em dólar:") && pedidoClonado.ObservacaoCTe.Contains("//"))
                        {
                            int posInicial = pedidoClonado.ObservacaoCTe.IndexOf("Conversão de valor em dólar:");
                            int posFinal = pedidoClonado.ObservacaoCTe.IndexOf("//") + 1;
                            if ((posFinal - posInicial) > 0 && posInicial > (posFinal - posInicial))
                                pedidoClonado.ObservacaoCTe = pedidoClonado.ObservacaoCTe.Remove(posInicial, posFinal - posInicial);
                        }

                        pedidoClonado.ValorTaxaFeeder = 0;
                    }

                    repPedido.Atualizar(pedidoOriginal);
                    repPedido.Inserir(pedidoClonado);
                    repCargaPedido.Atualizar(cargaPedidoAntiga);
                    continue;
                }

                Dominio.Entidades.Embarcador.Cargas.CargaPedido novaCargaPedido = new Dominio.Entidades.Embarcador.Cargas.CargaPedido();
                novaCargaPedido = cargaPedidoAntiga.Clonar();
                novaCargaPedido.Carga = novaCarga;
                novaCargaPedido.CargaOrigem = novaCarga;

                Utilidades.Object.DefinirListasGenericasComoNulas(novaCargaPedido);

                if (cargaPedidoAntiga.Pedido != null)
                {
                    Dominio.Entidades.Embarcador.Pedidos.Pedido novoPedido = new Dominio.Entidades.Embarcador.Pedidos.Pedido();
                    novoPedido = cargaPedidoAntiga.Pedido.Clonar();
                    novaCargaPedido.Pedido = novoPedido;

                    repCargaPedido.Inserir(novaCargaPedido);

                    Utilidades.Object.DefinirListasGenericasComoNulas(novoPedido);

                    List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao> listaApoliceSeguro = repApoliceSeguroAverbacao.BuscarPorCargaPedido(cargaPedidoAntiga.Codigo);
                    if (listaApoliceSeguro.Count > 0)
                    {
                        for (int a = 0; a < listaApoliceSeguro.Count; a++)
                        {
                            Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao apoliceSeguro = listaApoliceSeguro[a];

                            List<Dominio.Entidades.AverbacaoCTe> averbacoesCTes = repAverbacaoCTe.BuscarPorApoliceSeguroAverbacao(apoliceSeguro.Codigo);
                            List<Dominio.Entidades.AverbacaoMDFe> averbacoesMDFes = repAverbacaoMDFe.BuscarPorApoliceSeguroAverbacao(apoliceSeguro.Codigo);

                            Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao apoliceSeguroNova = new Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao()
                            {
                                ApoliceSeguro = apoliceSeguro.ApoliceSeguro,
                                Desconto = apoliceSeguro.Desconto,
                                SeguroFilialEmissora = apoliceSeguro.SeguroFilialEmissora,
                                CargaPedido = novaCargaPedido,
                            };

                            repApoliceSeguroAverbacao.Inserir(apoliceSeguroNova);

                            for (int b = 0; b < averbacoesCTes.Count; b++)
                            {
                                Dominio.Entidades.AverbacaoCTe averbacaoCTe = averbacoesCTes[b];

                                averbacaoCTe.ApoliceSeguroAverbacao = apoliceSeguroNova;
                                averbacaoCTe.Carga = novaCarga;

                                repAverbacaoCTe.Atualizar(averbacaoCTe);
                            }

                            for (int b = 0; b < averbacoesMDFes.Count; b++)
                            {
                                Dominio.Entidades.AverbacaoMDFe averbacaoMDFe = averbacoesMDFes[b];

                                averbacaoMDFe.ApoliceSeguroAverbacao = apoliceSeguroNova;
                                averbacaoMDFe.Carga = novaCarga;

                                repAverbacaoMDFe.Atualizar(averbacaoMDFe);
                            }
                        }
                    }

                    if (cargaPedidoAntiga.Pedido.Motoristas != null && cargaPedidoAntiga.Pedido.Motoristas.Count > 0)
                    {
                        List<Dominio.Entidades.Usuario> listaMotoristas = cargaPedidoAntiga.Pedido.Motoristas.ToList();
                        novoPedido.Motoristas = new List<Dominio.Entidades.Usuario>();

                        for (int a = 0; a < listaMotoristas.Count; a++)
                        {
                            Dominio.Entidades.Usuario novoMotorista = repUsuario.BuscarPorCodigo(listaMotoristas[a].Codigo);
                            novoPedido.Motoristas.Add(novoMotorista);
                        }
                    }

                    if (cargaPedidoAntiga.Pedido.Veiculos != null && cargaPedidoAntiga.Pedido.Veiculos.Count > 0)
                    {
                        List<Dominio.Entidades.Veiculo> listaVeiculos = cargaPedidoAntiga.Pedido.Veiculos.ToList();
                        novoPedido.Veiculos = new List<Dominio.Entidades.Veiculo>();

                        for (int a = 0; a < listaVeiculos.Count; a++)
                        {
                            Dominio.Entidades.Veiculo novoVeiculo = repVeiculo.BuscarPorCodigo(listaVeiculos[a].Codigo);
                            novoPedido.Veiculos.Add(novoVeiculo);
                        }
                    }

                    novoPedido.SituacaoPedido = SituacaoPedido.Aberto;
                    novoPedido.SituacaoAcompanhamentoPedido = SituacaoAcompanhamentoPedido.AgColeta;
                    cargaPedidoAntiga.Pedido.PedidoDePreCarga = cargaAntiga.CargaDePreCargaFechada || cargaAntiga.CargaDePreCargaEmFechamento;

                    repPedido.Inserir(novoPedido);
                    repPedido.Atualizar(cargaPedidoAntiga.Pedido);

                    if (cargaPedidoAntiga.Pedido.Produtos != null && cargaPedidoAntiga.Pedido.Produtos.Count > 0)
                    {
                        for (int a = 0; a < cargaPedidoAntiga.Pedido.Produtos.Count; a++)
                        {
                            Dominio.Entidades.Embarcador.Pedidos.PedidoProduto novoPedidoProduto = cargaPedidoAntiga.Pedido.Produtos[a].Clonar();

                            Utilidades.Object.DefinirListasGenericasComoNulas(novoPedidoProduto);

                            novoPedidoProduto.Pedido = novoPedido;

                            repPedidoProduto.Inserir(novoPedidoProduto);
                        }
                    }

                    if (!cargaPedidoAntiga.Pedido.PedidoTransbordo)
                    {
                        if (!cargaPedidoAntiga.CTeEmitidoNoEmbarcador)
                        {
                            Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe repCargaPedidoXMLNotaFiscalCTe = new Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe(unitOfWork);
                            List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> notasFiscaisPedido = repPedidoXMLNotaFiscal.BuscarPorCargaPedido(cargaPedidoAntiga.Codigo);
                            for (int a = 0; a < notasFiscaisPedido.Count; a++)
                            {
                                if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS || config.SempreDuplicarCargaCancelada) //|| (cargaPedidoAntiga.Carga.TipoOperacao != null && cargaPedidoAntiga.Carga.TipoOperacao.PermiteImportarDocumentosManualmente))
                                {
                                    Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xmlNotaFiscalNova = notasFiscaisPedido[a].XMLNotaFiscal.Clonar();

                                    Utilidades.Object.DefinirListasGenericasComoNulas(xmlNotaFiscalNova);

                                    xmlNotaFiscalNova.DataRecebimento = DateTime.Now;
                                    repXMLNotaFiscal.Inserir(xmlNotaFiscalNova);

                                    Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscalNovo = notasFiscaisPedido[a].Clonar();

                                    Utilidades.Object.DefinirListasGenericasComoNulas(pedidoXMLNotaFiscalNovo);

                                    pedidoXMLNotaFiscalNovo.XMLNotaFiscal = xmlNotaFiscalNova;
                                    pedidoXMLNotaFiscalNovo.CargaPedido = novaCargaPedido;
                                    repPedidoXMLNotaFiscal.Inserir(pedidoXMLNotaFiscalNovo);


                                    foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe cargaPedidoXMLNotaFiscalCTe in notasFiscaisPedido[a].CTes)
                                    {
                                        Dominio.Entidades.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe novaCargaPedidoXMLNotaFiscalCTe = new Dominio.Entidades.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe();
                                        novaCargaPedidoXMLNotaFiscalCTe.CargaCTe = cargaPedidoXMLNotaFiscalCTe.CargaCTe;
                                        novaCargaPedidoXMLNotaFiscalCTe.PedidoXMLNotaFiscal = pedidoXMLNotaFiscalNovo;
                                        repCargaPedidoXMLNotaFiscalCTe.Inserir(novaCargaPedidoXMLNotaFiscalCTe);
                                        repCargaPedidoXMLNotaFiscalCTe.Deletar(cargaPedidoXMLNotaFiscalCTe);
                                    }

                                }
                                else
                                {
                                    notasFiscaisPedido[a].CargaPedido = novaCargaPedido;
                                    repPedidoXMLNotaFiscal.Atualizar(notasFiscaisPedido[a]);
                                }
                            }

                            List<Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao> pedidoCTesParaSubContratacao = repPedidoCTeParaSubContratacao.BuscarPorCargaPedido(cargaPedidoAntiga.Codigo);
                            for (int a = 0; a < pedidoCTesParaSubContratacao.Count; a++)
                            {
                                Dominio.Entidades.Embarcador.CTe.CTeTerceiro cteTerceiroNovo = pedidoCTesParaSubContratacao[a].CTeTerceiro.Clonar();
                                Utilidades.Object.DefinirListasGenericasComoNulas(cteTerceiroNovo);

                                cteTerceiroNovo.Ativo = true;

                                if (pedidoCTesParaSubContratacao[a].CTeTerceiro.Emitente != null)
                                {
                                    cteTerceiroNovo.Emitente = pedidoCTesParaSubContratacao[a].CTeTerceiro.Emitente.Clonar();
                                    cteTerceiroNovo.Emitente.Codigo = 0;
                                }

                                if (pedidoCTesParaSubContratacao[a].CTeTerceiro.Remetente != null)
                                {
                                    cteTerceiroNovo.Remetente = pedidoCTesParaSubContratacao[a].CTeTerceiro.Remetente.Clonar();
                                    cteTerceiroNovo.Remetente.Codigo = 0;
                                }

                                if (pedidoCTesParaSubContratacao[a].CTeTerceiro.Expedidor != null)
                                {
                                    cteTerceiroNovo.Expedidor = pedidoCTesParaSubContratacao[a].CTeTerceiro.Expedidor.Clonar();
                                    cteTerceiroNovo.Expedidor.Codigo = 0;
                                }

                                if (pedidoCTesParaSubContratacao[a].CTeTerceiro.Recebedor != null)
                                {
                                    cteTerceiroNovo.Recebedor = pedidoCTesParaSubContratacao[a].CTeTerceiro.Recebedor.Clonar();
                                    cteTerceiroNovo.Recebedor.Codigo = 0;
                                }

                                if (pedidoCTesParaSubContratacao[a].CTeTerceiro.Destinatario != null)
                                {
                                    cteTerceiroNovo.Destinatario = pedidoCTesParaSubContratacao[a].CTeTerceiro.Destinatario.Clonar();
                                    cteTerceiroNovo.Destinatario.Codigo = 0;
                                }

                                repCTeTerceiro.Inserir(cteTerceiroNovo);

                                foreach (Dominio.Entidades.Embarcador.CTe.CTeTerceiroNFe nfe in pedidoCTesParaSubContratacao[a].CTeTerceiro.CTesTerceiroNFes)
                                {
                                    Dominio.Entidades.Embarcador.CTe.CTeTerceiroNFe nfeNovo = nfe.Clonar();
                                    nfeNovo.CTeTerceiro = cteTerceiroNovo;
                                    repCTeTerceiroNFe.Inserir(nfeNovo);
                                }

                                foreach (Dominio.Entidades.Embarcador.CTe.CTeTerceiroQuantidade quantidade in pedidoCTesParaSubContratacao[a].CTeTerceiro.CTeTerceiroQuantidades)
                                {
                                    Dominio.Entidades.Embarcador.CTe.CTeTerceiroQuantidade quantidadeNovo = quantidade.Clonar();
                                    quantidadeNovo.CTeTerceiro = cteTerceiroNovo;
                                    repCTeTerceiroQuantidade.Inserir(quantidadeNovo);
                                }

                                List<Dominio.Entidades.Embarcador.CTe.CTeTerceiroNotaFiscal> notasFiscaisCTeTerceiro = repCTeTerceiroNotaFiscal.BuscarPorCTeParaSubContratacao(pedidoCTesParaSubContratacao[a].CTeTerceiro.Codigo);
                                foreach (Dominio.Entidades.Embarcador.CTe.CTeTerceiroNotaFiscal notaFiscal in notasFiscaisCTeTerceiro)
                                {
                                    Dominio.Entidades.Embarcador.CTe.CTeTerceiroNotaFiscal notaFiscalNovo = notaFiscal.Clonar();
                                    notaFiscalNovo.CTeTerceiro = cteTerceiroNovo;
                                    repCTeTerceiroNotaFiscal.Inserir(notaFiscalNovo);
                                }

                                List<Dominio.Entidades.Embarcador.CTe.CTeTerceiroOutrosDocumentos> outrosDocumentos = repCTeTerceiroOutrosDocumentos.BuscarPorCTeParaSubContratacao(pedidoCTesParaSubContratacao[a].CTeTerceiro.Codigo);
                                foreach (Dominio.Entidades.Embarcador.CTe.CTeTerceiroOutrosDocumentos outroDocumento in outrosDocumentos)
                                {
                                    Dominio.Entidades.Embarcador.CTe.CTeTerceiroOutrosDocumentos outroDocumentoNovo = outroDocumento.Clonar();
                                    outroDocumentoNovo.CTeTerceiro = cteTerceiroNovo;
                                    repCTeTerceiroOutrosDocumentos.Inserir(outroDocumentoNovo);
                                }

                                List<Dominio.Entidades.Embarcador.CTe.CTeTerceiroSeguro> seguros = repCTeTerceiroSeguro.BuscarPorCTeParaSubContratacao(pedidoCTesParaSubContratacao[a].CTeTerceiro.Codigo);
                                foreach (Dominio.Entidades.Embarcador.CTe.CTeTerceiroSeguro seguro in seguros)
                                {
                                    Dominio.Entidades.Embarcador.CTe.CTeTerceiroSeguro seguroNovo = seguro.Clonar();
                                    seguroNovo.CTeTerceiro = cteTerceiroNovo;
                                    repCTeTerceiroSeguro.Inserir(seguroNovo);
                                }

                                List<Dominio.Entidades.Embarcador.CTe.CTeTerceiroDimensao> dimensoes = repCTeTerceiroDimensao.BuscarPorCTeParaSubContratacao(pedidoCTesParaSubContratacao[a].CTeTerceiro.Codigo);
                                foreach (Dominio.Entidades.Embarcador.CTe.CTeTerceiroDimensao dimensao in dimensoes)
                                {
                                    Dominio.Entidades.Embarcador.CTe.CTeTerceiroDimensao dimensaoNovo = dimensao.Clonar();
                                    dimensaoNovo.CTeTerceiro = cteTerceiroNovo;
                                    repCTeTerceiroDimensao.Inserir(dimensaoNovo);
                                }

                                Dominio.Entidades.Embarcador.CTe.CTeTerceiroXML xml = repCTeTerceiroXML.BuscarPorCodigoCTeTerceiro(pedidoCTesParaSubContratacao[a].CTeTerceiro.Codigo);
                                if (xml != null)
                                {
                                    Dominio.Entidades.Embarcador.CTe.CTeTerceiroXML xmlNovo = xml.Clonar();
                                    xmlNovo.CTeTerceiro = cteTerceiroNovo;
                                    repCTeTerceiroXML.Inserir(xml);
                                }

                                Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao pedidoCTeParaSubContratacaoNovo = pedidoCTesParaSubContratacao[a].Clonar();

                                Utilidades.Object.DefinirListasGenericasComoNulas(pedidoCTeParaSubContratacaoNovo);

                                pedidoCTeParaSubContratacaoNovo.CargaPedido = novaCargaPedido;
                                pedidoCTeParaSubContratacaoNovo.CTeTerceiro = cteTerceiroNovo;

                                repPedidoCTeParaSubContratacao.Inserir(pedidoCTeParaSubContratacaoNovo);

                                List<Dominio.Entidades.Embarcador.Pedidos.PedidoCteParaSubContratacaoComponenteFrete> pedidoCTeParaSubContratacaoComponentesFrete = repPedidoCTeParaSubContratacaoComponenteFrete.BuscarPorPedidoCteParaSubcontratacao(pedidoCTesParaSubContratacao[a].Codigo, false);
                                for (int zulu = 0; zulu < pedidoCTeParaSubContratacaoComponentesFrete.Count; zulu++)
                                {
                                    Dominio.Entidades.Embarcador.Pedidos.PedidoCteParaSubContratacaoComponenteFrete pedidoCTeParaSubContratacaoComponenteFreteNovo = pedidoCTeParaSubContratacaoComponentesFrete[zulu].Clonar();
                                    pedidoCTeParaSubContratacaoComponenteFreteNovo.PedidoCTeParaSubContratacao = pedidoCTeParaSubContratacaoNovo;
                                    repPedidoCTeParaSubContratacaoComponenteFrete.Inserir(pedidoCTeParaSubContratacaoComponenteFreteNovo);
                                }

                                List<Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacaoPedidoNotaFiscal> pedidoCTeParaSubContratacaoPedidoNotaFiscal = repPedidoCTeParaSubContratacaoPedidoNotaFiscal.BuscarPorPedidoCTeParaSubcontratacao(pedidoCTesParaSubContratacao[a].Codigo);

                                List<Dominio.Entidades.Usuario> novosMotoristas = new List<Dominio.Entidades.Usuario>();
                                foreach (Dominio.Entidades.Embarcador.Cargas.CargaMotorista cargaMotorista in listaCargaMotorista)
                                    novosMotoristas.Add(cargaMotorista.Motorista);
                                Repositorio.Embarcador.Configuracoes.ConfiguracaoCanhoto repConfiguracaoCanhoto = new Repositorio.Embarcador.Configuracoes.ConfiguracaoCanhoto(unitOfWork);
                                Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoCanhoto configuracaoCanhoto = repConfiguracaoCanhoto.BuscarConfiguracaoPadrao();

                                for (int b = 0; b < pedidoCTeParaSubContratacaoPedidoNotaFiscal.Count; b++)
                                {
                                    if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS || (cargaPedidoAntiga.Carga.TipoOperacao != null && cargaPedidoAntiga.Carga.TipoOperacao.PermiteImportarDocumentosManualmente))
                                    {
                                        Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscalNovo = pedidoCTeParaSubContratacaoPedidoNotaFiscal[b].PedidoXMLNotaFiscal.Clonar();

                                        Utilidades.Object.DefinirListasGenericasComoNulas(pedidoXMLNotaFiscalNovo);

                                        Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xmlNotaFiscalNova = pedidoCTeParaSubContratacaoPedidoNotaFiscal[b].PedidoXMLNotaFiscal.XMLNotaFiscal.Clonar();
                                        Utilidades.Object.DefinirListasGenericasComoNulas(xmlNotaFiscalNova);
                                        xmlNotaFiscalNova.DataRecebimento = DateTime.Now;
                                        repXMLNotaFiscal.Inserir(xmlNotaFiscalNova);

                                        serCanhoto.SalvarCanhotoNota(xmlNotaFiscalNova, novaCargaPedido, novaCargaPedido.Carga.FreteDeTerceiro && novaCargaPedido.Carga.Veiculo != null ? novaCargaPedido.Carga.Veiculo.Proprietario : novaCargaPedido.Carga.ProvedorOS, novosMotoristas, tipoServicoMultisoftware, config, unitOfWork, configuracaoCanhoto);

                                        pedidoXMLNotaFiscalNovo.XMLNotaFiscal = xmlNotaFiscalNova;
                                        pedidoXMLNotaFiscalNovo.CargaPedido = novaCargaPedido;
                                        repPedidoXMLNotaFiscal.Inserir(pedidoXMLNotaFiscalNovo);

                                        Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacaoPedidoNotaFiscal pedidoCTeParaSubContratacaoPedidoNotaFiscalNovo = new Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacaoPedidoNotaFiscal();
                                        pedidoCTeParaSubContratacaoPedidoNotaFiscalNovo.PedidoXMLNotaFiscal = pedidoXMLNotaFiscalNovo;
                                        pedidoCTeParaSubContratacaoPedidoNotaFiscalNovo.PedidoCTeParaSubContratacao = pedidoCTeParaSubContratacaoNovo;
                                        repPedidoCTeParaSubContratacaoPedidoNotaFiscal.Inserir(pedidoCTeParaSubContratacaoPedidoNotaFiscalNovo);
                                    }
                                    else
                                    {
                                        pedidoCTeParaSubContratacaoPedidoNotaFiscal[b].PedidoXMLNotaFiscal.CargaPedido = novaCargaPedido;
                                        repPedidoCTeParaSubContratacaoPedidoNotaFiscal.Atualizar(pedidoCTeParaSubContratacaoPedidoNotaFiscal[b]);
                                    }
                                }

                                serCanhoto.SalvarCanhotoCTe(cteTerceiroNovo, novaCargaPedido, novaCargaPedido.Carga.FreteDeTerceiro && novaCargaPedido.Carga.Veiculo != null ? novaCargaPedido.Carga.Veiculo.Proprietario : novaCargaPedido.Carga.ProvedorOS, novosMotoristas, tipoServicoMultisoftware, unitOfWork);
                            }
                        }
                        else
                        {
                            if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS && cargaCancelamento.SituacaoCargaNoCancelamento == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete)
                            {
                                novaCarga.ValorFrete = 0;
                                novaCarga.ValorFreteAPagar = 0;
                                novaCarga.ValorFreteEmbarcador = 0;
                                novaCarga.ValorICMS = 0;
                                novaCarga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe;

                                repCarga.Atualizar(novaCarga);
                            }

                            if (cargaCancelamento.CancelarDocumentosEmitidosNoEmbarcador) //se cancela os documentos emitidos no embarcador, a nova carga deve ficar sem vinculo dos mesmos (pois estão na carga antiga)
                            {
                                Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe repCargaPedidoXMLNotaFiscalCTe = new Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe(unitOfWork);
                                List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> notasFiscaisPedido = repPedidoXMLNotaFiscal.BuscarPorCargaPedido(cargaPedidoAntiga.Codigo);

                                for (int a = 0; a < notasFiscaisPedido.Count; a++)
                                {
                                    notasFiscaisPedido[a].CargaPedido = novaCargaPedido;
                                    repPedidoXMLNotaFiscal.Atualizar(notasFiscaisPedido[a]);
                                }

                                List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoMDFe> cargaPedidoDocumentoMDFes = repCargaPedidoDocumentoMDFe.BuscarPorCargaPedido(cargaPedidoAntiga.Codigo);
                                List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe> cargaPedidoDocumentoCTes = repCargaPedidoDocumentoCTe.BuscarPorCargaPedido(cargaPedidoAntiga.Codigo);

                                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe cargaPedidoDocumentoCTe in cargaPedidoDocumentoCTes)
                                {
                                    cargaPedidoDocumentoCTe.CargaPedido = novaCargaPedido;
                                    Utilidades.Object.DefinirListasGenericasComoNulas(cargaPedidoDocumentoCTe);
                                    repCargaPedidoDocumentoCTe.Atualizar(cargaPedidoDocumentoCTe);
                                }

                                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoMDFe cargaPedidoDocumentoMDFe in cargaPedidoDocumentoMDFes)
                                {
                                    cargaPedidoDocumentoMDFe.CargaPedido = novaCargaPedido;
                                    repCargaPedidoDocumentoMDFe.Atualizar(cargaPedidoDocumentoMDFe);
                                }
                            }
                        }
                    }
                    else
                    {
                        if (cargaPedidoAntiga.CTeEmitidoNoEmbarcador)
                        {
                            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoMDFe> cargaPedidoDocumentoMDFes = repCargaPedidoDocumentoMDFe.BuscarPorCargaPedido(cargaPedidoAntiga.Codigo);

                            for (int a = 0; a < cargaPedidoDocumentoMDFes.Count; a++)
                            {
                                Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoMDFe cargaPedidoDocumentoMDFe = cargaPedidoDocumentoMDFes[a].Clonar();
                                cargaPedidoDocumentoMDFe.CargaPedido = novaCargaPedido;
                                repCargaPedidoDocumentoMDFe.Inserir(cargaPedidoDocumentoMDFe);
                            }

                            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe> cargaPedidoDocumentoCTes = repCargaPedidoDocumentoCTe.BuscarPorCargaPedido(cargaPedidoAntiga.Codigo);

                            for (int a = 0; a < cargaPedidoDocumentoCTes.Count; a++)
                            {
                                Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe cargaPedidoDocumentoCTe = cargaPedidoDocumentoCTes[a].Clonar();
                                cargaPedidoDocumentoCTe.CargaPedido = novaCargaPedido;
                                repCargaPedidoDocumentoCTe.Inserir(cargaPedidoDocumentoCTe);
                            }

                            List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> notasFiscaisPedido = repPedidoXMLNotaFiscal.BuscarPorCargaPedido(cargaPedidoAntiga.Codigo);
                            for (int a = 0; a < notasFiscaisPedido.Count; a++)
                            {
                                Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscalNovo = notasFiscaisPedido[a].Clonar();
                                Utilidades.Object.DefinirListasGenericasComoNulas(pedidoXMLNotaFiscalNovo);
                                pedidoXMLNotaFiscalNovo.XMLNotaFiscal = notasFiscaisPedido[a].XMLNotaFiscal;
                                pedidoXMLNotaFiscalNovo.CargaPedido = novaCargaPedido;
                                repPedidoXMLNotaFiscal.Inserir(pedidoXMLNotaFiscalNovo);
                            }
                        }
                    }
                }

                List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoRotaFrete> listaCargaPedidoRotasFrete = repCargaPedidoRotaFrete.BuscarPorCargaPedido(cargaPedidoAntiga.Codigo);
                for (int a = 0; a < listaCargaPedidoRotasFrete.Count; a++)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedidoRotaFrete novaCargaPedidoRotaFrete = listaCargaPedidoRotasFrete[a].Clonar();
                    novaCargaPedidoRotaFrete.CargaPedido = novaCargaPedido;
                    repCargaPedidoRotaFrete.Inserir(novaCargaPedidoRotaFrete);
                }

                List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete> listaCargaPedidoComponentesFrete = repCargaPedidoComponentesFrete.BuscarPorCargaPedido(cargaPedidoAntiga.Codigo, false, cargaPedidoAntiga.ModeloDocumentoFiscal);
                for (int a = 0; a < listaCargaPedidoComponentesFrete.Count; a++)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete novaCargaPedidoComponentesFrete = new Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete();
                    novaCargaPedidoComponentesFrete = listaCargaPedidoComponentesFrete[a].Clonar();
                    novaCargaPedidoComponentesFrete.CargaPedido = novaCargaPedido;
                    repCargaPedidoComponentesFrete.Inserir(novaCargaPedidoComponentesFrete);
                }

                List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoProduto> listaCargaPedidoProduto = repCargaPedidoProduto.BuscarPorCargaPedido(cargaPedidoAntiga.Codigo);
                for (int a = 0; a < listaCargaPedidoProduto.Count; a++)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedidoProduto novaCargaPedidoProduto = new Dominio.Entidades.Embarcador.Cargas.CargaPedidoProduto();
                    novaCargaPedidoProduto = listaCargaPedidoProduto[a].Clonar();
                    novaCargaPedidoProduto.CargaPedido = novaCargaPedido;
                    repCargaPedidoProduto.Inserir(novaCargaPedidoProduto);
                }

                List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoQuantidades> listaCargaPedidoQuantidades = repCargaPedidoQuantidades.BuscarPorCargaPedido(cargaPedidoAntiga.Codigo);
                for (int a = 0; a < listaCargaPedidoQuantidades.Count; a++)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedidoQuantidades novaCargaPedidoQuantidades = new Dominio.Entidades.Embarcador.Cargas.CargaPedidoQuantidades();
                    novaCargaPedidoQuantidades = listaCargaPedidoQuantidades[a].Clonar();
                    novaCargaPedidoQuantidades.CargaPedido = novaCargaPedido;
                    repCargaPedidoQuantidades.Inserir(novaCargaPedidoQuantidades);
                }

                List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoRotas> listaCargaPedidoRotas = repCargaPedidoRotas.BuscarPorCargaPedido(cargaPedidoAntiga.Codigo);
                for (int a = 0; a < listaCargaPedidoRotas.Count; a++)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedidoRotas novaCargaPedidoRotas = new Dominio.Entidades.Embarcador.Cargas.CargaPedidoRotas();
                    novaCargaPedidoRotas = listaCargaPedidoRotas[a].Clonar();
                    novaCargaPedidoRotas.CargaPedido = novaCargaPedido;
                    repCargaPedidoRotas.Inserir(novaCargaPedidoRotas);
                }

                List<Dominio.Entidades.Embarcador.Pallets.DevolucaoPallet> devolucoes = repDevolucaoPallets.BuscarPorCargaPedido(cargaPedidoAntiga.Codigo);
                foreach (Dominio.Entidades.Embarcador.Pallets.DevolucaoPallet devolucao in devolucoes)
                {
                    if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
                    {
                        repDevolucaoPallets.Deletar(devolucao);
                    }
                    else
                    {
                        devolucao.CargaPedido = novaCargaPedido;
                        repDevolucaoPallets.Atualizar(devolucao);
                    }
                }

                List<Dominio.Entidades.Embarcador.Rateio.RateioCargaPedidoProduto> rateioRateioCargaPedidoProdutos = repRateioCargaPedidoProduto.buscarPorCargaPedido(cargaPedidoAntiga.Codigo);
                foreach (Dominio.Entidades.Embarcador.Rateio.RateioCargaPedidoProduto rateioRateioCargaPedidoProduto in rateioRateioCargaPedidoProdutos)
                {
                    rateioRateioCargaPedidoProduto.CargaPedido = novaCargaPedido;
                    repRateioCargaPedidoProduto.Atualizar(rateioRateioCargaPedidoProduto);
                }

                if (cargaPedidoAntiga.SituacaoEmissao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoNF.NFEnviada)
                {
                    cargaPedidoAntiga.SituacaoEmissao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoNF.AgEnvioNF;
                    cargaPedidoAntiga.CienciaDoEnvioDaNotaInformado = false;
                    repCargaPedido.Atualizar(cargaPedidoAntiga);
                }

            }

            Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoAvon cargaIntegracaoAvon = repCargaIntegracaoAvon.BuscarPorCarga(cargaAntiga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoMinutaAvon.Sucesso);
            if (cargaIntegracaoAvon != null)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoAvon cargaIntegracaoAvonNova = cargaIntegracaoAvon.Clonar();
                cargaIntegracaoAvonNova.Carga = novaCarga;
                repCargaIntegracaoAvon.Inserir(cargaIntegracaoAvonNova);
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoNatura> cargaIntegracoesNatura = repCargaIntegracaoNatura.BuscarPorCarga(cargaAntiga.Codigo);
            foreach (Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoNatura cargaIntegracaoNatura in cargaIntegracoesNatura)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoNatura cargaIntegracaoNaturaNova = cargaIntegracaoNatura.Clonar();
                cargaIntegracaoNaturaNova.Carga = novaCarga;
                repCargaIntegracaoNatura.Inserir(cargaIntegracaoNaturaNova);

                List<Dominio.Entidades.Embarcador.Cargas.CargaCTeIntegracaoLote> cargaCTeIntegracoesLote = repCargaCTeIntegracaoLote.BuscarPorCargaIntegracaoNatura(cargaIntegracaoNatura.Codigo);

                foreach (Dominio.Entidades.Embarcador.Cargas.CargaCTeIntegracaoLote cargaCTeIntegracaoLote in cargaCTeIntegracoesLote)
                {
                    cargaCTeIntegracaoLote.IntegracaoNatura = cargaIntegracaoNaturaNova;

                    repCargaCTeIntegracaoLote.Atualizar(cargaCTeIntegracaoLote);
                }
            }

            List<Dominio.Entidades.Embarcador.Canhotos.Canhoto> canhotosAvulsos = repCanhotoAvulso.BuscarCanhotoPorCarga(cargaAntiga.Codigo);
            foreach (Dominio.Entidades.Embarcador.Canhotos.Canhoto canhoto in canhotosAvulsos)
            {
                canhoto.Carga = novaCarga;
                repCanhoto.Atualizar(canhoto);
            }

            List<Dominio.Entidades.Embarcador.Canhotos.Canhoto> canhotosCTesCarga = repCanhoto.BuscarCanhotoCTePorCarga(cargaAntiga.Codigo);
            foreach (Dominio.Entidades.Embarcador.Canhotos.Canhoto canhotoCTe in canhotosCTesCarga)
            {
                canhotoCTe.Carga = novaCarga;
                repCanhoto.Atualizar(canhotoCTe);
            }

            List<Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio> cargaIntegracoesValePedagio = repCargaIntegracaoValePedagio.BuscarPorCarga(cargaAntiga.Codigo);
            foreach (Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio cargaIntegracaoValePedagio in cargaIntegracoesValePedagio)
            {
                cargaIntegracaoValePedagio.Carga = novaCarga;
                repCargaIntegracaoValePedagio.Atualizar(cargaIntegracaoValePedagio);

                Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio cargaValePedagio = new Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio();
                cargaValePedagio.Carga = cargaAntiga;
                cargaValePedagio.SituacaoValePedagio = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoValePedagio.Pendete;
                cargaValePedagio.TipoIntegracao = cargaIntegracaoValePedagio.TipoIntegracao;
                cargaValePedagio.ProblemaIntegracao = "";
                cargaValePedagio.DataIntegracao = DateTime.Now;
                cargaValePedagio.SituacaoIntegracao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoIntegracao.AgIntegracao;
                cargaValePedagio.OperacaoContainer = cargaIntegracaoValePedagio.OperacaoContainer;

                repCargaIntegracaoValePedagio.Inserir(cargaValePedagio);

                List<Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaValePedagioRota> rotasValePedagio = repCargaValePedagioRota.BuscarPorCargaValePedagio(cargaIntegracaoValePedagio.Codigo);
                foreach (Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaValePedagioRota rota in rotasValePedagio)
                {
                    Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaValePedagioRota cargaValePedagioRota = new Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaValePedagioRota();
                    cargaValePedagioRota.CargaValePedagio = cargaValePedagio;
                    cargaValePedagioRota.DescricaoRota = rota.DescricaoRota;
                    cargaValePedagioRota.CodigosPracaSemParar = rota.CodigosPracaSemParar;
                    repCargaValePedagioRota.Inserir(cargaValePedagioRota);
                }

                List<Dominio.Entidades.Embarcador.Cargas.CargaValePedagio> cargasPedagio = repCargaValePedagio.BuscarPorCarga(cargaAntiga.Codigo);
                foreach (Dominio.Entidades.Embarcador.Cargas.CargaValePedagio cargaPedagio in cargasPedagio)
                {
                    cargaPedagio.Carga = novaCarga;
                    repCargaValePedagio.Atualizar(cargaPedagio);
                }
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaMDFe> cargaMDFes = repCargaMDFe.BuscarPorCarga(cargaAntiga.Codigo);
            foreach (Dominio.Entidades.Embarcador.Cargas.CargaMDFe cargaMDFe in cargaMDFes)
            {
                cargaMDFe.Carga = novaCarga;
                cargaMDFe.CargaLocaisPrestacao = null;
                repCargaMDFe.Atualizar(cargaMDFe);
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaCTe> cargaCTes = repCargaCTe.BuscarPorCarga(cargaAntiga.Codigo);
            foreach (Dominio.Entidades.Embarcador.Cargas.CargaCTe cargaCTe in cargaCTes)
            {
                cargaCTe.Carga = novaCarga;
                repCargaCTe.Atualizar(cargaCTe);
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaDocumentoParaEmissaoNFSManual> cargaDocumentosParaEmissao = repCargaDocumentoParaEmissaoNFSManual.BuscarPorCarga(cargaAntiga.Codigo);
            foreach (Dominio.Entidades.Embarcador.Cargas.CargaDocumentoParaEmissaoNFSManual cargaDocumentoParaEmissaoNFSManual in cargaDocumentosParaEmissao)
            {
                cargaDocumentoParaEmissaoNFSManual.Carga = novaCarga;
                repCargaDocumentoParaEmissaoNFSManual.Atualizar(cargaDocumentoParaEmissaoNFSManual);
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaEDIIntegracao> cargaEDIIntegracoes = repCargaEDIIntegracao.BuscarPorCarga(cargaAntiga.Codigo);
            foreach (Dominio.Entidades.Embarcador.Cargas.CargaEDIIntegracao cargaEDIIntegracao in cargaEDIIntegracoes)
            {
                cargaEDIIntegracao.Carga = novaCarga;
                repCargaEDIIntegracao.Atualizar(cargaEDIIntegracao);
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaCargaIntegracao> cargaCargaIntegracoes = repCargaCargaIntegracao.BuscarPorCarga(cargaAntiga.Codigo);
            foreach (Dominio.Entidades.Embarcador.Cargas.CargaCargaIntegracao cargaCargaIntegracao in cargaCargaIntegracoes)
            {
                cargaCargaIntegracao.Carga = novaCarga;
                cargaCargaIntegracao.Carga.SituacaoCarga = SituacaoCarga.AgIntegracao;
                repCargaCargaIntegracao.Atualizar(cargaCargaIntegracao);
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaNFS> cargaNFSs = repCargaNFS.BuscarPorCarga(cargaAntiga.Codigo);
            foreach (Dominio.Entidades.Embarcador.Cargas.CargaNFS cargaNFs in cargaNFSs)
            {
                cargaNFs.Carga = novaCarga;
                repCargaNFS.Atualizar(cargaNFs);
            }

            for (int i = 0; i < listaCargaPercurso.Count; i++)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaPercurso novaCargaPercurso = new Dominio.Entidades.Embarcador.Cargas.CargaPercurso();
                novaCargaPercurso = listaCargaPercurso[i].Clonar();
                novaCargaPercurso.Carga = novaCarga;
                repCargaPercurso.Inserir(novaCargaPercurso);
            }

            for (int i = 0; i < listaCargaTabelaFreteComponenteFrete.Count; i++)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteComponenteFrete novaCargaTabelaFreteComponenteFrete = new Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteComponenteFrete();
                novaCargaTabelaFreteComponenteFrete = listaCargaTabelaFreteComponenteFrete[i].Clonar();
                novaCargaTabelaFreteComponenteFrete.Carga = novaCarga;
                repCargaTabelaFreteComponenteFrete.Inserir(novaCargaTabelaFreteComponenteFrete);
            }

            cargaCancelamento.CargaDuplicada = cargaAntiga;
            cargaCancelamento.Carga = novaCarga;
            repCargaCancelamento.Atualizar(cargaCancelamento);

            if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
            {
                if (
                    (cargaCancelamento.SituacaoCargaNoCancelamento != SituacaoCarga.Nova) &&
                    (cargaCancelamento.SituacaoCargaNoCancelamento != SituacaoCarga.AgTransportador) &&
                    (cargaCancelamento.SituacaoCargaNoCancelamento != SituacaoCarga.AgNFe)
                )
                {
                    if (listaCargaPedido.Any(o => o.CTeEmitidoNoEmbarcador) && cargaCancelamento.CancelarDocumentosEmitidosNoEmbarcador)
                        cargaAntiga.SituacaoCarga = SituacaoCarga.AgNFe;
                    else
                        cargaAntiga.SituacaoCarga = SituacaoCarga.CalculoFrete;

                    if (cargaAntiga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete)
                        Servicos.Log.TratarErro("Atualizou a situação para calculo frete 48 Carga " + cargaAntiga.CodigoCargaEmbarcador, "AtualizouSituacaoCalculoFrete");
                }
            }
            else if (cargaCancelamento.SituacaoCargaNoCancelamento.IsSituacaoCargaEmitida())
                cargaAntiga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe;

            cargaAntiga.AutorizouTodosCTes = false;
            cargaAntiga.PossuiPendencia = false;
            cargaAntiga.OrigemFretePelaJanelaTransportador = false;
            cargaAntiga.problemaNFS = false;
            cargaAntiga.problemaMDFe = false;
            cargaAntiga.problemaAverbacaoCTe = false;
            cargaAntiga.problemaEmissaoNFeRemessa = false;
            cargaAntiga.ProblemaAverbacaoMDFe = false;
            cargaAntiga.ProblemaIntegracaoCIOT = false;
            cargaAntiga.problemaCTE = false;
            cargaAntiga.EmitindoCTes = false;
            cargaAntiga.LiberarComProblemaAverbacao = false;
            cargaAntiga.LiberarComProblemaAverbacaoMDFe = false;
            cargaAntiga.LiberadoComProblemaCIOT = false;
            cargaAntiga.LiberarComProblemaAverbacao = false;
            cargaAntiga.AverbandoCTes = false;
            cargaAntiga.EmitindoNFeRemessa = false;
            cargaAntiga.CargaIntegradaEmbarcador = false;
            cargaAntiga.IntegradoraNFe = null;
            cargaAntiga.DataInicioEmissaoDocumentos = null;
            cargaAntiga.DataInicioConfirmacaoDocumentosFiscais = null;
            cargaAntiga.DataInicioCalculoFrete = null;
            cargaAntiga.DataEnvioUltimaNFe = null;
            cargaAntiga.DataRecebimentoUltimaNFe = null;
            cargaAntiga.DataFechamentoCarga = null;
            cargaAntiga.DataFinalizacaoEmissao = null;
            cargaAntiga.DataInicioGeracaoCTes = null;
            cargaAntiga.GerandoIntegracoes = false;
            cargaAntiga.GerouControleFaturamento = false;
            cargaAntiga.GerouMovimentacaoAutorizacao = false;
            cargaAntiga.GerouTituloAutorizacao = false;
            cargaAntiga.NaoGerarMDFe = false;
            cargaAntiga.CarregamentoIntegradoERP = false;

            if (liberarPedidosParaMontagemCarga)
                cargaAntiga.CargaFechada = false;

            if (cargaAntiga.CargaDePreCargaFechada || cargaAntiga.CargaDePreCargaEmFechamento)
            {
                cargaAntiga.CargaDePreCarga = true;
                cargaAntiga.SituacaoCarga = SituacaoCarga.AgNFe;
            }

            repCarga.Atualizar(cargaAntiga);

            return novaCarga;
        }

        public dynamic SalvarDadosTransporteCarga(Dominio.ObjetosDeValor.Embarcador.Carga.CargaDadosTransporte dadosTransporte, out string mensagemErro, Dominio.Entidades.Usuario usuario, bool liberarComProblemaIntegracaoGrMotoristaVeiculo, TipoServicoMultisoftware tipoServicoMultisoftware, string webServiceConsultaCTe, AdminMultisoftware.Dominio.Entidades.Pessoas.Cliente cliente, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, UnitOfWork unitOfWork, bool notificar = true, bool naoNotificarCarga = false)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.ModeloVeicularCarga repModeloVeicular = new Repositorio.Embarcador.Cargas.ModeloVeicularCarga(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoDeCarga repTipoCarga = new Repositorio.Embarcador.Cargas.TipoDeCarga(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoCargaDadosTransporte repositorioConfiguracaoCargaDadosTransporte = new Repositorio.Embarcador.Configuracoes.ConfiguracaoCargaDadosTransporte(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoGeral repositorioConfiguracaoGeral = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeral(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga repositorioConfiguracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoJanelaCarregamento repositorioConfiguracaoJanelaCarregamento = new Repositorio.Embarcador.Configuracoes.ConfiguracaoJanelaCarregamento(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoMotorista repositorioConfiguracaoMotorista = new Repositorio.Embarcador.Configuracoes.ConfiguracaoMotorista(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoVeiculo repositorioConfiguracaoVeiculo = new Repositorio.Embarcador.Configuracoes.ConfiguracaoVeiculo(unitOfWork);
            Repositorio.Embarcador.Pedidos.TipoOperacao repTipoOperacao = new Repositorio.Embarcador.Pedidos.TipoOperacao(unitOfWork);
            Repositorio.Setor repSetor = new Repositorio.Setor(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoViagemNavio repPedidoViagemNavio = new Repositorio.Embarcador.Pedidos.PedidoViagemNavio(unitOfWork);
            Repositorio.Embarcador.Logistica.VeiculoDisponivelCarregamento repVeiculoDisponivelCarregamento = new Repositorio.Embarcador.Logistica.VeiculoDisponivelCarregamento(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaControleExpedicao repCargaControleExpedicao = new Repositorio.Embarcador.Cargas.CargaControleExpedicao(unitOfWork);
            Repositorio.Embarcador.Cargas.ColetaEntrega.EtapaVeiculoAlocado repEtapaVeiculoAlocado = new Repositorio.Embarcador.Cargas.ColetaEntrega.EtapaVeiculoAlocado(unitOfWork);
            Repositorio.Embarcador.Canhotos.Canhoto repCanhoto = new Repositorio.Embarcador.Canhotos.Canhoto(unitOfWork);
            Repositorio.Embarcador.Pedidos.TipoTerminalImportacao repTipoTerminalImportacao = new Repositorio.Embarcador.Pedidos.TipoTerminalImportacao(unitOfWork);
            Repositorio.Usuario repUsuario = new Repositorio.Usuario(unitOfWork);
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unitOfWork);
            Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unitOfWork);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unitOfWork);
            Repositorio.Embarcador.PreCargas.PreCarga repPreCarga = new Repositorio.Embarcador.PreCargas.PreCarga(unitOfWork);
            Repositorio.Embarcador.Pedidos.Porto repPorto = new Repositorio.Embarcador.Pedidos.Porto(unitOfWork);
            Repositorio.RotaFrete repositorioRotaFrete = new Repositorio.RotaFrete(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repositorioPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoGuarita repositorioGuarita = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoGuarita(unitOfWork);
            Repositorio.Embarcador.Veiculos.VeiculoMotorista repVeiculoMotorista = new Repositorio.Embarcador.Veiculos.VeiculoMotorista(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaMDFe repCargaMDFe = new Repositorio.Embarcador.Cargas.CargaMDFe(unitOfWork);
            Repositorio.Embarcador.WMS.MontagemContainer repositorioMontagemContainer = new Repositorio.Embarcador.WMS.MontagemContainer(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaMotorista repCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);
            Repositorio.Embarcador.Cargas.MontagemCarga.Carregamento repositorioCarregamento = new Repositorio.Embarcador.Cargas.MontagemCarga.Carregamento(unitOfWork);
            Repositorio.Embarcador.Pedidos.RetiradaContainer repositorioRetiradaContainer = new Repositorio.Embarcador.Pedidos.RetiradaContainer(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoCarregamento repTipoCarregamento = new Repositorio.Embarcador.Cargas.TipoCarregamento(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoEmissaoDocumentoEmbarcador repConfiguracaoEmissaoDocumentoEmbarcador = new Repositorio.Embarcador.Configuracoes.ConfiguracaoEmissaoDocumentoEmbarcador(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoControleEntrega repositorioConfiguracaoControleEntrega = new Repositorio.Embarcador.Configuracoes.ConfiguracaoControleEntrega(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaDadosTransporteIntegracao repCargaDadosTransporteIntegracao = new Repositorio.Embarcador.Cargas.CargaDadosTransporteIntegracao(unitOfWork);
            Repositorio.Embarcador.Configuracoes.IntegracaoGeralEFrete configuracaoIntegracaoGeralEFrete = new Repositorio.Embarcador.Configuracoes.IntegracaoGeralEFrete(unitOfWork);
            Repositorio.Embarcador.Pedidos.Container repositorioContainer = new Repositorio.Embarcador.Pedidos.Container(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao();
            Servicos.Embarcador.CTe.CTEsImportados serCTEsImportados = new Servicos.Embarcador.CTe.CTEsImportados(unitOfWork);
            Servicos.Embarcador.Canhotos.Canhoto serCanhoto = new Canhotos.Canhoto(unitOfWork);
            Servicos.Embarcador.Carga.CargaDadosSumarizados serCargaDadosSumarizados = new Servicos.Embarcador.Carga.CargaDadosSumarizados(unitOfWork);
            Servicos.Embarcador.Carga.CargaMotorista servicoCargaMotorista = new Servicos.Embarcador.Carga.CargaMotorista(unitOfWork);
            Servicos.Embarcador.Hubs.Carga serHubCarga = new Servicos.Embarcador.Hubs.Carga();
            Servicos.Embarcador.Integracao.OneTrust.IntegracaoOneTrust servicoIntegracaoOneTrust = new Servicos.Embarcador.Integracao.OneTrust.IntegracaoOneTrust(configuracaoEmbarcador, unitOfWork);
            Servicos.Embarcador.Carga.CargaPallets serCargaPallets = new CargaPallets(unitOfWork, configuracaoEmbarcador);
            Servicos.Embarcador.Carga.CargaOperador servicoCargaOperador = new Servicos.Embarcador.Carga.CargaOperador(unitOfWork, configuracaoEmbarcador);
            Servicos.Embarcador.Integracao.Marfrig.IntegracaoOrdemEmbarqueMarfrig servicoIntegracaoOrdemEmbarqueMarfrig = new Servicos.Embarcador.Integracao.Marfrig.IntegracaoOrdemEmbarqueMarfrig(unitOfWork);
            Servicos.Embarcador.Carga.CargaIndicador servicoCargaIndicador = new CargaIndicador(unitOfWork);
            Servicos.Embarcador.Veiculo.LicencaVeiculo servicoLicencaVeiculo = new Veiculo.LicencaVeiculo(unitOfWork, tipoServicoMultisoftware);
            Servicos.Embarcador.GestaoPatio.FluxoGestaoPatioConfiguracaoEtapa servicoFluxoGestaoPatioConfiguracaoEtapa = new Servicos.Embarcador.GestaoPatio.FluxoGestaoPatioConfiguracaoEtapa(unitOfWork);
            Servicos.Embarcador.Logistica.CargaJanelaCarregamento servicoCargaJanelaCarregamento = new Servicos.Embarcador.Logistica.CargaJanelaCarregamento(unitOfWork, configuracaoEmbarcador);
            Integracao.IntegracaoCarregamento servicoIntegracaoCarregamento = new Integracao.IntegracaoCarregamento(unitOfWork);
            Servicos.Embarcador.Logistica.CargaJanelaCarregamentoTransportador servicoCargaJanelaCarregamentoTransportador = new Servicos.Embarcador.Logistica.CargaJanelaCarregamentoTransportador(unitOfWork, configuracaoEmbarcador);
            Servicos.Embarcador.Logistica.CargaJanelaCarregamentoConsulta servicoCargaJanelaCarregamentoConsulta = new Servicos.Embarcador.Logistica.CargaJanelaCarregamentoConsulta(unitOfWork);
            Servicos.Embarcador.Logistica.CargaJanelaDescarregamento servicoCargaJanelaDescarregamento = new Servicos.Embarcador.Logistica.CargaJanelaDescarregamento(unitOfWork, auditado);
            Servicos.Embarcador.Logistica.FilaCarregamentoVeiculo servicoFilaCarregamentoVeiculo = new Servicos.Embarcador.Logistica.FilaCarregamentoVeiculo(unitOfWork, auditado.Usuario, Logistica.FilaCarregamentoVeiculo.ObterOrigemAlteracaoFilaCarregamento(tipoServicoMultisoftware));
            Servicos.Embarcador.Carga.Carga serCarga = new Carga(unitOfWork);
            Servicos.Embarcador.Logistica.JanelaCarregamentoTransportadorValidacoes servicoJanelaCarregamentoTransportadorValidacoes = new Servicos.Embarcador.Logistica.JanelaCarregamentoTransportadorValidacoes(unitOfWork, tipoServicoMultisoftware);
            Servicos.Embarcador.Pedido.Pedido servicoPedido = new Servicos.Embarcador.Pedido.Pedido();
            Servicos.Embarcador.Carga.MensagemAlertaCarga servicoMensagemAlerta = new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork);
            Servicos.Embarcador.Frota.OrdemServicoVeiculoManutencao ordemServicoVeiculoManutencao = new Servicos.Embarcador.Frota.OrdemServicoVeiculoManutencao(unitOfWork);
            Servicos.Embarcador.Seguro.Seguro servicoSeguro = new Seguro.Seguro(unitOfWork);
            Servicos.Embarcador.Carga.FreteSubcontratacaoTerceiro servicoFreteSubcontratacaoTerceiro = new Servicos.Embarcador.Carga.FreteSubcontratacaoTerceiro(unitOfWork);
            Servicos.Embarcador.Veiculo.Veiculo servicoVeiculo = new Servicos.Embarcador.Veiculo.Veiculo(unitOfWork);
            Servicos.Embarcador.GestaoPatio.FluxoGestaoPatio servicoFluxoGestaoPatio = new Servicos.Embarcador.GestaoPatio.FluxoGestaoPatio(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoControleEntrega configuracaoControleEntrega = repositorioConfiguracaoControleEntrega.BuscarPrimeiroRegistro();

            mensagemErro = string.Empty;
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoCargaDadosTransporte configuracaoDadosTransporte = repositorioConfiguracaoCargaDadosTransporte.BuscarPrimeiroRegistro();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeral configuracaoGeral = repositorioConfiguracaoGeral.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga = repositorioConfiguracaoGeralCarga.BuscarPrimeiroRegistro();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoJanelaCarregamento configuracaoJanelaCarregamento = repositorioConfiguracaoJanelaCarregamento.BuscarPrimeiroRegistro();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoMotorista configuracaoConfiguracaoMotorista = repositorioConfiguracaoMotorista.BuscarPrimeiroRegistro();
            Dominio.Entidades.Embarcador.Cargas.Carga carga = dadosTransporte.Carga;
            Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacaoOrigem = carga.TipoOperacao;
            Dominio.Entidades.Empresa empresaOrigem = carga.Empresa;
            Dominio.Entidades.Veiculo veiculoDaCarga = carga.Veiculo;
            Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento = servicoCargaJanelaCarregamentoConsulta.ObterCargaJanelaCarregamentoPorCarga(carga.Codigo);
            Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoGuarita cargaGuarita = repositorioGuarita.BuscarPorCarga(carga.Codigo);
            Dominio.ObjetosDeValor.Embarcador.GestaoPatio.GestaoPatioEtapaConfiguracao configuracoesGestaoPatioPorCarga = servicoFluxoGestaoPatioConfiguracaoEtapa.ObterConfiguracoesPorCarga(carga);
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoVeiculo configuracaoVeiculo = repositorioConfiguracaoVeiculo.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoGeralEFrete configuracaoIntegracaoEFrete = configuracaoIntegracaoGeralEFrete.BuscarPrimeiroRegistro();

            bool abriuTransacao = unitOfWork.IsActiveTransaction();
            int codigoModeloVeicularOriginal = carga.ModeloVeicularCarga?.Codigo ?? 0;

            try
            {
                if (carga.CargaBloqueadaParaEdicaoIntegracao)
                    throw new ServicoException("A carga não pode ser salva, pois está bloqueada.");

                carga.Initialize();

                if (IsCargaBloqueada(carga, unitOfWork))
                    throw new ServicoException($"A {carga.DescricaoEntidade} está bloqueada e não permite alteração.");

                Dominio.Entidades.Veiculo veiculoAnterior = null;
                List<Dominio.Entidades.Veiculo> reboquesAnteriores = null;

                veiculoAnterior = carga.Veiculo;
                reboquesAnteriores = carga.VeiculosVinculados?.ToList();

                if (carga.CargaAgrupada)
                    carga.AgIntegracaoAgrupamentoCarga = true;
                carga.NumeroPager = dadosTransporte.NumeroPager;
                carga.DataAtualizacaoCarga = DateTime.Now;
                if (dadosTransporte.TipoCheckin.HasValue)
                    carga.TipoCheckin = dadosTransporte.TipoCheckin;
                if (dadosTransporte.DataCheckout.HasValue)
                    carga.DataCheckout = dadosTransporte.DataCheckout;

                bool unilever = repTipoIntegracao.ExistePorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Unilever);
                bool recalcularFrete = !(carga.TipoOperacao?.SolicitarNotasFiscaisAoSalvarDadosTransportador ?? false) && !unilever;
                bool validarModeloDocumentoFiscal = !unilever;
                bool ModeloVeicularDiferenteDoSolicitado = false;

                ValidarPermissaoAlterarDadosEtapaTransportadorOuDadosTransporte(carga, configuracaoEmbarcador, tipoServicoMultisoftware, unitOfWork);

                if (servicoIntegracaoOrdemEmbarqueMarfrig.PossuiOrdemEmbarqueAguardandoRetornoIntegracao(carga))
                    throw new ServicoException("A integração da carga para gerar ordem de embarque está aguardando o retorno.");

                dynamic retorno;

                if (carga.ExigeNotaFiscalParaCalcularFrete)
                {
                    Servicos.Embarcador.Carga.Frete serFrete = new Servicos.Embarcador.Carga.Frete(unitOfWork, tipoServicoMultisoftware);

                    string retornoVerificarOperador = VerificarOperadorPodeConfigurarCarga(usuario, carga, tipoServicoMultisoftware, unitOfWork);

                    if (!string.IsNullOrWhiteSpace(retornoVerificarOperador))
                        throw new ServicoException(retornoVerificarOperador);

                    if (!abriuTransacao)
                        unitOfWork.Start();
                    bool atualizouModeloVeicular = false;

                    if (tipoServicoMultisoftware != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe && dadosTransporte.CodigoTipoCarga > 0)
                    {
                        if (carga.TipoDeCarga == null)
                            carga.TipoDeCarga = repTipoCarga.BuscarPorCodigo(dadosTransporte.CodigoTipoCarga);
                        else if (carga.TipoDeCarga != null && carga.TipoDeCarga.Codigo != dadosTransporte.CodigoTipoCarga)
                            carga.TipoDeCarga = repTipoCarga.BuscarPorCodigo(dadosTransporte.CodigoTipoCarga);

                        if (carga.CargaAgrupada)
                        {
                            foreach (Dominio.Entidades.Embarcador.Cargas.Carga cargaOrigem in carga.CargasAgrupamento.ToList())
                            {
                                if (carga.TipoDeCarga?.Codigo != cargaOrigem.TipoDeCarga?.Codigo)
                                {
                                    cargaOrigem.TipoDeCarga = carga.TipoDeCarga;
                                    repCarga.Atualizar(cargaOrigem);
                                }
                            }
                        }
                    }

                    if (dadosTransporte.CodigoModeloVeicular > 0)
                    {
                        Dominio.Entidades.Embarcador.Cargas.ModeloVeicularCarga modeloVeicularInformado = repModeloVeicular.BuscarPorCodigo(dadosTransporte.CodigoModeloVeicular);

                        if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador && modeloVeicularInformado != null)
                        {
                            if (carga.ModeloVeicularCarga != null && carga.ModeloVeicularCarga?.Codigo != dadosTransporte.CodigoModeloVeicular)
                            {
                                // alterou modelo veicular;
                                Dominio.Entidades.Embarcador.Pedidos.RetiradaContainer retiradaContainer = repositorioRetiradaContainer.BuscarPorCarga(carga.Codigo);
                                if (retiradaContainer != null)
                                {
                                    if (retiradaContainer.ColetaContainer != null)
                                        throw new ServicoException("Não é permitido a troca do modelo veicular, a carga já possuí retirada container com coleta de container vinculada");

                                    if (retiradaContainer.ContainerTipo != null && modeloVeicularInformado.ContainerTipo != null && retiradaContainer.ContainerTipo.Codigo != modeloVeicularInformado.ContainerTipo.Codigo)
                                    {
                                        retiradaContainer.Container = null;
                                        retiradaContainer.ContainerTipo = modeloVeicularInformado.ContainerTipo;
                                        repositorioRetiradaContainer.Atualizar(retiradaContainer, auditado);
                                    }
                                }

                                atualizouModeloVeicular = true;
                            }

                            if (modeloVeicularInformado.ContainerTipo == null)
                                new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork).Confirmar(carga, TipoMensagemAlerta.CargaSemInformacaoContainer);//remover mensagem
                        }

                        if (tipoServicoMultisoftware != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe)
                            carga.ModeloVeicularCarga = modeloVeicularInformado;

                    }

                    serCarga.ValidarCapacidadeModeloVeicularCarga(carga, configuracaoEmbarcador, unitOfWork);

                    if (dadosTransporte.CodigoTipoOperacao > 0 && tipoServicoMultisoftware != TipoServicoMultisoftware.MultiCTe)
                        carga.TipoOperacao = repTipoOperacao.BuscarPorCodigo(dadosTransporte.CodigoTipoOperacao);
                    if (dadosTransporte.Container > 0)
                        carga.Container = repositorioContainer.BuscarPorCodigo(dadosTransporte.Container);
                    if (dadosTransporte.CodigoSetor > 0)
                        carga.Setor = repSetor.BuscarPorCodigo(dadosTransporte.CodigoSetor);

                    if (carga.TipoOperacao?.ConfiguracaoCarga?.ObrigatorioJustificarCustoExtra == true && carga.Setor == null)
                        throw new ServicoException("O setor deve ser preenchido.");

                    if (dadosTransporte.CodigoJustificativaAutorizacaoCarga > 0)
                    {
                        Repositorio.Embarcador.Cargas.JustificativaAutorizacaoCarga repJustificativaAutorizacaoCarga = new Repositorio.Embarcador.Cargas.JustificativaAutorizacaoCarga(unitOfWork);
                        carga.JustificativaAutorizacaoCarga = repJustificativaAutorizacaoCarga.BuscarPorCodigo(dadosTransporte.CodigoJustificativaAutorizacaoCarga);
                    }
                    else
                    {
                        if (carga.TipoOperacao?.ConfiguracaoCarga?.ObrigatorioJustificarCustoExtra ?? false)
                            throw new ServicoException("Preencha o campo Justificativa Custo Extra");
                    }

                    carga.TipoCarregamento = repTipoCarregamento.BuscarPorCodigo(dadosTransporte.CodigoTipoCarregamento, true);

                    servicoCargaOperador.Atualizar(carga, usuario, tipoServicoMultisoftware);

                    carga.VeiculoIntegradoEmbarcador = false;
                    carga.PossuiPendencia = false;
                    carga.MotivoPendencia = "";

                    if (tipoServicoMultisoftware != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe)
                    {
                        if (
                            dadosTransporte.CodigoEmpresa > 0 &&
                            carga.Empresa == null &&
                            cargaJanelaCarregamento != null &&
                            cargaJanelaCarregamento.CentroCarregamento != null &&
                            cargaJanelaCarregamento.Situacao == SituacaoCargaJanelaCarregamento.SemTransportador &&
                            cargaJanelaCarregamento.DataSituacaoAtual.HasValue &&
                            cargaJanelaCarregamento.CentroCarregamento.TempoBloqueioEscolhaTransportador > 0
                        )
                        {
                            double minutosSituacao = (DateTime.Now - cargaJanelaCarregamento.DataSituacaoAtual.Value).TotalMinutes;

                            if (minutosSituacao < cargaJanelaCarregamento.CentroCarregamento.TempoBloqueioEscolhaTransportador)
                                throw new ServicoException($"Não é possível setar o transportador da carga, pois a carga deve ficar disponível por mais {(cargaJanelaCarregamento.CentroCarregamento.TempoBloqueioEscolhaTransportador - minutosSituacao).ToString("n0")} minutos para a visualização dos transportadores na janela de carregamento.");
                        }

                        carga.Empresa = repEmpresa.BuscarPorCodigo(dadosTransporte.CodigoEmpresa);
                    }

                    bool possuiMontagemContainer = repositorioMontagemContainer.BuscarSeExisteCadastrado();
                    if (possuiMontagemContainer && (carga.TipoOperacao?.CargaTipoConsolidacao ?? false))
                    {
                        Repositorio.Embarcador.Pedidos.ContainerTipo repositorioTipoContainer = new Repositorio.Embarcador.Pedidos.ContainerTipo(unitOfWork);

                        carga.Empresa = repEmpresa.BuscarEmpresaPadraoRetirada();
                        carga.TipoContainer = repositorioTipoContainer.BuscarPorCodigo(dadosTransporte.CodigoTipoContainer);
                    }

                    Dominio.Entidades.Embarcador.Financeiro.CentroResultado centroResultadoNovoTipoOperacao = null;
                    List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo, TipoPedido.Entrega, true, configuracaoEmbarcador.RatearFretePedidosAposLiberarEmissaoSemNFe);

                    AlterarCentroResultadoPedidoCarga(carga, dadosTransporte, auditado, unitOfWork);

                    List<int> codigosVeiculos = new List<int>();
                    if (dadosTransporte.CodigoTracao > 0)
                        codigosVeiculos.Add(dadosTransporte.CodigoTracao);

                    if (dadosTransporte.CodigoReboque > 0)
                        codigosVeiculos.Add(dadosTransporte.CodigoReboque);

                    if (dadosTransporte.CodigoSegundoReboque > 0)
                        codigosVeiculos.Add(dadosTransporte.CodigoSegundoReboque);

                    if (dadosTransporte.CodigoTerceiroReboque > 0)
                        codigosVeiculos.Add(dadosTransporte.CodigoTerceiroReboque);

                    ordemServicoVeiculoManutencao.VeiculoIndisponivelParaTransporte(cargaPedidos.Select(o => o.Pedido).ToList(), codigosVeiculos);

                    if (tipoOperacaoOrigem?.Codigo != carga.TipoOperacao?.Codigo && carga.TipoOperacao != null)
                    {
                        if (configuracaoEmbarcador.ManterOperacaoUnicaEmCargasAgrupadas && carga.CargaAgrupada)
                        {
                            foreach (Dominio.Entidades.Embarcador.Cargas.Carga cargaOrigem in carga.CargasAgrupamento.ToList())
                            {
                                cargaOrigem.TipoOperacao = carga.TipoOperacao;
                                repCarga.Atualizar(cargaOrigem);
                            }
                        }

                        if (tipoOperacaoOrigem != null && carga.TipoOperacao != null && tipoOperacaoOrigem.EmiteCTeFilialEmissora != carga.TipoOperacao.EmiteCTeFilialEmissora)
                        {
                            AlternarEmiteCTeFilialEmissora(carga, unitOfWork);
                            Auditoria.Auditoria.Auditar(auditado, carga, null, $"Tipo de operação alterado para um que {(carga.TipoOperacao.EmiteCTeFilialEmissora ? "emite" : "não emite")} ct-e da filial emissora", unitOfWork);
                        }
                        //throw new ServicoException($"Não é possível mudar o tipo de operação desta para um tipo que{(carga.TipoOperacao.EmiteCTeFilialEmissora ? " emite " : " não emite ")}ct-e da filial emissora, nesse caso cancele a carga e crie ela novamente com o tipo correto.");

                        Servicos.Embarcador.Logistica.ProcedimentoEmbarque.SetarProcedimentoEmbarqueCarga(carga, unitOfWork);
                        Servicos.Embarcador.Carga.RotaFrete.SetarRotaFreteCarga(carga, cargaPedidos, configuracaoEmbarcador, unitOfWork, tipoServicoMultisoftware);

                        if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
                        {
                            Repositorio.Embarcador.Financeiro.CentroResultado repCentroResultado = new Repositorio.Embarcador.Financeiro.CentroResultado(unitOfWork);
                            centroResultadoNovoTipoOperacao = repCentroResultado.BuscarPorTipoOperacao(carga.TipoOperacao.Codigo);
                        }

                        if (carga.TipoOperacao.UsarConfiguracaoEmissao)
                            repCargaPedido.SetarTipoRatioDocumentosPorCarga(carga.Codigo, carga.TipoOperacao.TipoEmissaoCTeDocumentos);
                    }

                    if (carga.Empresa?.BloquearTransportador ?? false)
                    {
                        string mensagemBloqueioVeiculo = $"O transportador {carga.Empresa.Descricao} está bloqueado";

                        if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador)
                            mensagemBloqueioVeiculo += $" pelo motivo {carga.Empresa.MotivoBloqueio}.";
                        else
                            mensagemBloqueioVeiculo += $". Entre em contato com o embarcador para entender o motivo.";

                        throw new ServicoException(mensagemBloqueioVeiculo);
                    }

                    if ((carga.Empresa != null) && carga.IsChangedByPropertyName("Empresa"))
                    {
                        new Servicos.Embarcador.GestaoPallet.MovimentacaoPallet(unitOfWork, auditado).InformarTrocaTransportador(carga);
                        servicoCargaIndicador.DefinirIndicadorTransportador(carga, CargaIndicadorTransportador.InformadoManualmente);
                    }

                    Dominio.Entidades.Veiculo veiculo = null;

                    if (dadosTransporte.CodigoTracao > 0)
                    {
                        veiculo = repVeiculo.BuscarPorCodigo(dadosTransporte.CodigoTracao);

                        if ((carga.TipoOperacao?.ExigirVeiculoComRastreador ?? false) && (veiculo != null && !(veiculo?.PossuiRastreador ?? false)))
                            throw new ServicoException($"Para o tipo de operação '{carga.TipoOperacao.Descricao}' é obrigatório informar um veiculo com o rastreador cadastrado.");

                        if (veiculo.TipoVeiculo == "1")
                        {
                            if (veiculo.VeiculosTracao != null && veiculo.VeiculosTracao.Count > 0)
                            {
                                Dominio.Entidades.Veiculo tracao = (from obj in veiculo.VeiculosTracao where obj.Ativo select obj).FirstOrDefault();
                                if (tracao != null)
                                    veiculo = tracao;
                            }
                        }
                    }

                    if (veiculo != null)
                    {
                        //Ao salvar os dados de transporte, atualiza a situação da tag do vale pedágio.
                        servicoMensagemAlerta.Remover(carga, TipoMensagemAlerta.ProblemaConsultaTagValePedagioVeiculo);

                        Dominio.Entidades.Embarcador.Veiculos.VeiculoIntegracao integracaoVeiculo = new Servicos.Embarcador.Integracao.SemParar.ConsultaCadastroVeiculo(unitOfWork, tipoServicoMultisoftware).GerarIntegracaoCadastroVeiculo(veiculo);

                        if (!veiculo.PossuiTagValePedagio && !veiculo.NaoComprarValePedagio)
                        {
                            if (configuracaoJanelaCarregamento.BloquearVeiculoSemTagValePedagioAtiva ?? false)
                                throw new ServicoException(Localization.Resources.Logistica.JanelaCarregamentoTransportador.NaoPossuiTagValePedagioAtiva);

                            if (configuracaoIntegracaoEFrete?.ConsultarTagAoIncluirVeiculoNaCarga ?? false)
                                servicoMensagemAlerta.Adicionar(carga, TipoMensagemAlerta.ProblemaConsultaTagValePedagioVeiculo, integracaoVeiculo?.ProblemaIntegracao ?? "Falha ao consultar o vale pedágio do veículo.");
                        }

                        if (veiculo.Tipo == "T") //&& (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS || (carga.Empresa?.Configuracao.TipoIntegradoraCIOT.HasValue ?? false))
                            carga.FreteDeTerceiro = true;
                        else if (carga.ProvedorOS != null)
                            carga.FreteDeTerceiro = true;
                        else
                            carga.FreteDeTerceiro = false;

                        if (veiculo.VeiculoBloqueado)
                        {
                            string mensagemBloqueioVeiculo = $"O veículo {veiculo.Placa_Formatada} está bloqueado";

                            if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador)
                                mensagemBloqueioVeiculo += $" pelo motivo {veiculo.MotivoBloqueio}.";
                            else
                                mensagemBloqueioVeiculo += $". Entre em contato com o embarcador para entender o motivo.";

                            throw new ServicoException(mensagemBloqueioVeiculo);
                        }

                        if (configuracaoEmbarcador.FiltrarBuscaVeiculosPorEmpresa && (veiculo.Empresa?.Codigo != carga.Empresa?.Codigo) && (carga.Empresa?.Matriz?.FirstOrDefault() == null || veiculo.Empresa?.Codigo != carga.Empresa?.Matriz?.FirstOrDefault().Codigo))
                            throw new ServicoException($"O veículo informado não pertence a empresa selecionada (Empresa: {carga.Empresa?.RazaoSocial}).");

                        AtualizarVinculoVeiculoMotorista(veiculo, dadosTransporte.ListaCodigoMotorista, configuracaoEmbarcador, unitOfWork, auditado);
                    }
                    else if (carga.ProvedorOS != null)
                        carga.FreteDeTerceiro = true;

                    carga.Veiculo = veiculo;
                    if (veiculo != null)
                        new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork).Confirmar(carga, TipoMensagemAlerta.CargaSemVeiculoInformado);

                    if (carga.VeiculosVinculados == null)
                        carga.VeiculosVinculados = new List<Dominio.Entidades.Veiculo>();

                    bool veiculoAlterado = carga.IsChangedByPropertyName("Veiculo");

                    if (carga.TipoOperacao?.ExigePlacaTracao ?? false)
                    {
                        carga.VeiculosVinculados.Clear();

                        if (dadosTransporte.CodigoReboque > 0)
                        {
                            Dominio.Entidades.Veiculo reboque = repVeiculo.BuscarPorCodigo(dadosTransporte.CodigoReboque);

                            if (reboque != null && !carga.VeiculosVinculados.Contains(reboque))
                                carga.VeiculosVinculados.Add(reboque);
                        }

                        if (dadosTransporte.CodigoSegundoReboque > 0)
                        {
                            Dominio.Entidades.Veiculo reboque = repVeiculo.BuscarPorCodigo(dadosTransporte.CodigoSegundoReboque);

                            if (reboque != null && !carga.VeiculosVinculados.Contains(reboque))
                                carga.VeiculosVinculados.Add(reboque);
                        }

                        if (dadosTransporte.CodigoTerceiroReboque > 0)
                        {
                            Dominio.Entidades.Veiculo reboque = repVeiculo.BuscarPorCodigo(dadosTransporte.CodigoTerceiroReboque);

                            if (reboque != null && !carga.VeiculosVinculados.Contains(reboque))
                                carga.VeiculosVinculados.Add(reboque);
                        }

                        RealocarVeiculosSeNecessario(veiculo, veiculoAnterior, veiculoAlterado, carga.VeiculosVinculados.ToList(), reboquesAnteriores, carga, unitOfWork, tipoServicoMultisoftware);
                    }
                    else if (carga.Veiculo != null)
                    {
                        bool atualizarVeiculosVinculados = veiculoAlterado || !configuracaoGeralCarga.UtilizarProgramacaoCarga || !servicoFilaCarregamentoVeiculo.ExisteFilaCarregamentoVeiculoPorCarga(carga.Codigo);

                        if (atualizarVeiculosVinculados)
                        {
                            carga.VeiculosVinculados.Clear();

                            foreach (Dominio.Entidades.Veiculo veiculoVinculado in carga.Veiculo.VeiculosVinculados)
                                carga.VeiculosVinculados.Add(veiculoVinculado);

                            RealocarVeiculosSeNecessario(veiculo, veiculoAnterior, veiculoAlterado, carga.VeiculosVinculados.ToList(), reboquesAnteriores, carga, unitOfWork, tipoServicoMultisoftware);
                        }
                    }
                    else
                    {
                        carga.VeiculosVinculados.Clear();
                        RealocarVeiculosSeNecessario(veiculo, veiculoAnterior, veiculoAlterado, carga.VeiculosVinculados.ToList(), reboquesAnteriores, carga, unitOfWork, tipoServicoMultisoftware);
                    }

                    if (carga.VeiculosVinculados != null)
                    {
                        List<string> placasBloqueadas = carga.VeiculosVinculados.Where(o => o.VeiculoBloqueado).Select(o => o.Placa).ToList();

                        if (placasBloqueadas.Any())
                            throw new ServicoException($"Os veículos vinculados ({string.Join(", ", placasBloqueadas)}) estão bloqueados, portanto, não é possível salvar os dados de transporte.");
                    }

                    if (configuracaoVeiculo.NaoPermitirCadastrarVeiculoSemRastreador)
                        servicoSeguro.ValidarRastreadorVeiculoEValorSeguroApolice(carga, null, unitOfWork);

                    servicoVeiculo.ValidarDataANTT(veiculo, configuracaoVeiculo);

                    if (configuracoesGestaoPatioPorCarga.BloquearEdicaoVeiculosCarga && (veiculoAlterado || carga.IsChangedByPropertyName("VeiculosVinculados")))
                        throw new ServicoException($"O veículo não pode mais ser alterado.");

                    AlterarSegmentoCarga(ref carga);

                    if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador && carga.Filial != null && carga.Empresa != null && carga.Empresa.FiliaisEmbarcadorHabilitado != null && carga.Empresa.FiliaisEmbarcadorHabilitado.Count > 0)
                    {
                        if (!carga.Empresa.FiliaisEmbarcadorHabilitado.Any(obj => obj.Codigo == carga.Filial.Codigo))
                            throw new ServicoException($"O transportador selecionado não está apto a transportar na filial {carga.Filial.Descricao}.");
                    }

                    servicoJanelaCarregamentoTransportadorValidacoes.ValidarApoliceSeguro(carga.Codigo, carga.Empresa, null, configuracaoDadosTransporte);

                    if (carga.TipoOperacao != null && carga.TipoOperacao.UsaJanelaCarregamentoPorEscala && cargaJanelaCarregamento == null)
                    {
                        if (carga.Empresa != null && carga.Veiculo != null)
                        {
                            DateTime dataEscala = carga.DataCarregamentoCarga.HasValue ? carga.DataCarregamentoCarga.Value : carga.DataCriacaoCarga;
                            Dominio.Entidades.Embarcador.PreCargas.PreCarga preCarga = repPreCarga.BuscarPorEscala(carga.Veiculo.Codigo, carga.Empresa.Codigo, carga.Filial?.Codigo ?? 0, dataEscala.Date);

                            if (preCarga != null)
                                servicoCargaJanelaCarregamento.DefinirCargaPorPreCarga(carga, preCarga);
                        }
                    }

                    ModeloVeicularDiferenteDoSolicitado = VerificarModeloVeicularDiferenteDoSolicitado(carga);

                    Repositorio.Embarcador.Cargas.CargaMotorista repositorioCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);
                    List<int> codigosMotoristasAntesDaAtualizacao = repositorioCargaMotorista.BuscarCodigoMotoristasPorCarga(carga.Codigo);
                    string retornoGrMotorista = string.Empty;
                    Dominio.ObjetosDeValor.Embarcador.GR.RetornoGR retornoGR = null;
                    List<Dominio.Entidades.Usuario> motoristas = new List<Dominio.Entidades.Usuario>();

                    foreach (int codigoMotorista in dadosTransporte.ListaCodigoMotorista)
                    {
                        Dominio.Entidades.Usuario motorista = repUsuario.BuscarPorCodigo(codigoMotorista);
                        servicoIntegracaoOneTrust.VerificarSituacaoMotorista(motorista);

                        if (configuracaoEmbarcador.ValidarDataLiberacaoSeguradora && !motorista.DataValidadeLiberacaoSeguradora.HasValue)
                            throw new ServicoException("O motorista não possui uma data de limite da seguradora configurada, por isso não é possível informar este motorista para transportar essa carga, verifique e tente novamente.");

                        if (configuracaoEmbarcador.ValidarDataLiberacaoSeguradora && (motorista.DataValidadeLiberacaoSeguradora.HasValue && motorista.DataValidadeLiberacaoSeguradora.Value.AddDays(1).AddMinutes(-1) < DateTime.Now))
                            throw new ServicoException($"A data de limite do motorista na seguradora está válido até {motorista.DataValidadeLiberacaoSeguradora.Value.ToString("dd/MM/yyyy")}, por isso não é possível informar este motorista para transportar essa carga, verifique e tente novamente.");

                        if (configuracaoEmbarcador.FiltrarBuscaVeiculosPorEmpresa && (motorista.Empresa?.Codigo != carga.Empresa?.Codigo) && (carga.Empresa?.Matriz?.FirstOrDefault() == null || motorista.Empresa?.Codigo != carga.Empresa?.Matriz?.FirstOrDefault().Codigo))
                            throw new ServicoException($"O motorista informado não pertence a empresa selecionada (Empresa: {carga.Empresa?.RazaoSocial}).");

                        if (motorista.Bloqueado)
                            throw new ServicoException("O motorista informado está bloqueado");

                        if (carga.TipoOperacao?.ConfiguracaoCarga?.NaoPermitirInformarMotoristaComCNHVencida ?? false)
                        {
                            if (!motorista.DataVencimentoHabilitacao.HasValue)
                                throw new ServicoException("O motorista não possui a data de validade da CNH preenchida, por isso não é possível informar este motorista para transportar a carga, verifique e tente novamente.");
                            if (motorista.DataVencimentoHabilitacao.Value.AddDays(30) < DateTime.Now.Date)
                                throw new ServicoException($"A data de validade da CNH do motorista estava valida até {motorista.DataVencimentoHabilitacao.Value.ToDateString()} e já excedeu os 30 dias permitidos, por isso não é possível informar este motorista para transportar a carga, verifique e tente novamente.");
                        }

                        retornoGR = ValidarMotoristaGR(liberarComProblemaIntegracaoGrMotoristaVeiculo, carga, motorista, tipoServicoMultisoftware, unitOfWork);

                        if (retornoGR != null)
                            retornoGrMotorista = retornoGR.Mensagem;

                        motoristas.Add(motorista);
                    }

                    bool atualizouMotorista = servicoCargaMotorista.AtualizarMotoristas(carga, motoristas);

                    if (dadosTransporte.ListaCodigoAjudante != null)
                    {
                        if (carga.Ajudantes?.Count > 0)
                            carga.Ajudantes.Clear();
                        else
                            carga.Ajudantes = new List<Dominio.Entidades.Usuario>();

                        foreach (int codigoAjudante in dadosTransporte.ListaCodigoAjudante)
                        {
                            Dominio.Entidades.Usuario ajudante = repUsuario.BuscarPorCodigo(codigoAjudante);

                            carga.Ajudantes.Add(ajudante);
                        }
                    }

                    servicoFilaCarregamentoVeiculo.AtualizarPorCarga(carga, tipoServicoMultisoftware);

                    if ((tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador || tipoServicoMultisoftware == TipoServicoMultisoftware.MultiCTe) && (dadosTransporte.CodigoTracao > 0 || dadosTransporte.ListaCodigoMotorista.Count > 0))
                    {
                        if (carga.IsChangedByPropertyName("Veiculo") || carga.IsChangedByPropertyName("Motoristas"))
                            servicoCargaIndicador.DefinirIndicadorDadosTransporte(carga, tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador ? CargaIndicadorVeiculoMotorista.InformadoEmbarcador : CargaIndicadorVeiculoMotorista.InformadoTransportador);
                    }

                    ValidarVeiculoGR(liberarComProblemaIntegracaoGrMotoristaVeiculo, carga, unitOfWork);

                    if (carga.CargaPossuiPreCalculoFrete && (carga.TipoOperacao != null && carga.TipoOperacao.TipoConsolidacao == EnumTipoConsolidacao.AutorizacaoEmissao))
                    {
                        string retornoValidarPreCalculo = serCarga.ValidarPreCalculoCargasFilho(carga, unitOfWork);

                        if (!string.IsNullOrEmpty(retornoValidarPreCalculo))
                            throw new ServicoException($"Não é possível confirmar os dados de transporte da carga. Carga com problemas no pré calculo de frete dos trechos subsequentes (" + retornoValidarPreCalculo + ").");
                    }

                    Servicos.Embarcador.Veiculo.Veiculo.ValidarBloqueioPorCargaNaoFinalizada(carga.Veiculo?.Placa, carga.Codigo, configuracaoEmbarcador, unitOfWork);
                    Servicos.Embarcador.Veiculo.Veiculo.ValidarDataLiberacaoSeguradora(carga.Veiculo, configuracaoEmbarcador);
                    Servicos.Embarcador.Veiculo.Veiculo.ValidarDataLiberacaoSeguradora(carga.VeiculosVinculados, configuracaoEmbarcador);

                    carga.Mercosul = carga.TipoOperacao?.TipoOperacaoMercosul ?? false;
                    carga.EmitindoCRT = carga.TipoOperacao?.TipoOperacaoMercosul ?? false;
                    carga.Internacional = carga.TipoOperacao?.ConfiguracaoCarga?.TipoOperacaoInternacional ?? false;

                    carga.CargaDestinadaCTeComplementar = carga.TipoOperacao?.OperacaoDestinadaCTeComplementar ?? false;

                    if (dadosTransporte.CodigoPedidoViagemNavio > 0)
                        carga.PedidoViagemNavio = repPedidoViagemNavio.BuscarPorCodigo(dadosTransporte.CodigoPedidoViagemNavio);

                    if (dadosTransporte.CodigoPortoOrigem > 0)
                        carga.PortoOrigem = repPorto.BuscarPorCodigo(dadosTransporte.CodigoPortoOrigem);

                    if (dadosTransporte.CodigoPortoDestino > 0)
                        carga.PortoDestino = repPorto.BuscarPorCodigo(dadosTransporte.CodigoPortoDestino);

                    if (dadosTransporte.CodigoTerminalOrigem > 0)
                        carga.TerminalOrigem = repTipoTerminalImportacao.BuscarPorCodigo(dadosTransporte.CodigoTerminalOrigem);

                    if (dadosTransporte.CodigoTerminalDestino > 0)
                        carga.TerminalDestino = repTipoTerminalImportacao.BuscarPorCodigo(dadosTransporte.CodigoTerminalDestino);

                    if (carga?.TipoOperacao != null)
                        carga.CargaBloqueadaParaEdicaoIntegracao = carga?.TipoOperacao?.CargaBloqueadaParaEdicaoIntegracao ?? false;

                    carga.ObservacaoTransportador = (!string.IsNullOrWhiteSpace(dadosTransporte.ObservacaoTransportador)) ? dadosTransporte.ObservacaoTransportador : null;

                    servicoLicencaVeiculo.GerarCargaLicenca(carga);

                    AjustarCargasOriginais(carga, tipoOperacaoOrigem, empresaOrigem, configuracaoGeralCarga, unitOfWork);

                    serFrete.LimparTabelaFreteRotaParaCarga(carga, unitOfWork);

                    Dominio.ObjetosDeValor.Embarcador.Frete.RetornoDadosFrete dadosFrete = new Dominio.ObjetosDeValor.Embarcador.Frete.RetornoDadosFrete
                    {
                        situacao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoRetornoDadosFrete.CalculandoFrete,
                        PermiteLiberarComLicencaInvalida = carga.TipoOperacao?.PermitirAvancarEtapaComLicencaInvalida ?? true
                    };

                    List<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> cargaMotoristas = repCargaMotorista.BuscarPorCarga(carga.Codigo);

                    //deve ser chamado sempre que atualiza o veiculo na carga
                    AtualizarIntegracaoConsultaCalculoValePedagio(carga, unitOfWork, tipoServicoMultisoftware);

                    //irá adicionar as integrações antes de mudar a situação, pois estava avançando a etapa de Dados Transporte antes de efetuar a integração
                    Servicos.Embarcador.Integracao.IntegracaoCarga.AdicionarIntegracoesCarga(carga, cargaPedidos, tipoServicoMultisoftware, unitOfWork, false);
                    Servicos.Embarcador.Integracao.IntegracaoCarga.AdicionarIntegracoesCargaDadosTransporte(carga, cargaPedidos, cargaMotoristas, configuracaoEmbarcador, tipoServicoMultisoftware, unitOfWork, atualizouMotorista, atualizouModeloVeicular);
                    Servicos.Embarcador.Integracao.MercadoLivre.IntegracaoMercadoLivre svcIntegracaoMercadoLivre = new Integracao.MercadoLivre.IntegracaoMercadoLivre(unitOfWork);
                    svcIntegracaoMercadoLivre.VerificarConsultaRotaEFacilityAutomatizada(carga, carga.Pedidos.ToList(), tipoServicoMultisoftware, unitOfWork);

                    bool dadosTransporteInformados = VerificarDadosFrete(dadosTransporte.LiberadaComCargaSemPlanejamento, carga, motoristas.Count > 0);
                    bool permiteAvancoEtapa = (carga.NaoExigeVeiculoParaEmissao && carga.TipoDeCarga != null) || dadosTransporteInformados;

                    if (!carga.AguardarIntegracaoDadosTransporte &&
                        (!carga.ProblemaIntegracaoGrMotoristaVeiculo || carga.LiberadoComProblemaIntegracaoGrMotoristaVeiculo) &&
                        (!carga.LicencaInvalida || carga.LiberadaComLicencaInvalida) &&
                        !carga.AguardarIntegracaoEtapaTransportador)
                    {

                        if (carga.TipoOperacao?.ConfiguracaoCarga?.ManterCargaNaEtapaUmAteXHorasAntesDaDataDeCarregamento ?? false)
                        {
                            if ((carga.Pedidos?.Count > 0) && (carga.Pedidos.First().Pedido.DataInicialColeta.HasValue) && (carga.TipoOperacao.ConfiguracaoCarga?.HorasManterCargaNaEtapaUmAteXHorasAntesDaDataDeCarregamento > 0))
                            {
                                //mercado Livre, as cargas vao avançar por uma thread assim q atinger o tempo limite pela data carregamento enquanto nao atende segue nova.
                                List<SituacaoCarga> situacaoesPermitidas = new List<SituacaoCarga>() {
                                    SituacaoCarga.Nova,
                                    SituacaoCarga.AgNFe,
                                    };

                                int horasConfiguradas = carga.TipoOperacao.ConfiguracaoCarga.HorasManterCargaNaEtapaUmAteXHorasAntesDaDataDeCarregamento;
                                DateTime horaLimite = carga.Pedidos.First().Pedido.DataInicialColeta.Value.AddHours(-horasConfiguradas);
                                if (DateTime.Now < horaLimite && situacaoesPermitidas.Contains(carga.SituacaoCarga))
                                    carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova;
                                else
                                {
                                    if (carga.SituacaoCarga == SituacaoCarga.Nova)
                                        carga.SituacaoCarga = SituacaoCarga.CalculoFrete;
                                }
                            }
                        }
                        else
                        {
                            if ((!carga.TipoOperacao?.ConfiguracaoCarga?.AdicionarBLComoOutroDocumentoAutomaticamenteNaCarga ?? false)
                                && ((carga.SituacaoCarga != SituacaoCarga.Nova && carga.DataEnvioUltimaNFe.HasValue) || carga.SituacaoCarga == SituacaoCarga.CalculoFrete)
                                && permiteAvancoEtapa
                                && (!(carga.TipoOperacao?.PermiteImportarDocumentosManualmente ?? false) || !(carga.TipoOperacao?.NaoExigeConformacaoDasNotasEmissao ?? false))
                            )
                            {
                                //if (!carga.TipoOperacao?.ExigirConfirmacaoDadosTransportadorAvancarCarga ?? false)
                                //{
                                if (carga.TipoFreteEscolhido != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Embarcador || carga.ExigeConfirmacaoAntesEmissao)
                                {
                                    carga.DataEnvioUltimaNFe = null; //volta a situacao a data de envio da nota para poder calcular o frete e ver se pode emitir.
                                    carga.DataInicioEmissaoDocumentos = null;
                                }

                                if ((carga.TipoFreteEscolhido != TipoFreteEscolhido.Operador || carga.Empresa?.Codigo != empresaOrigem?.Codigo) && recalcularFrete)
                                {
                                    carga.MotivoPendenciaFrete = MotivoPendenciaFrete.NenhumPendencia;
                                    carga.PossuiPendencia = false;

                                    carga.MotivoPendencia = "";
                                    carga.CalculandoFrete = true;
                                    carga.DataInicioCalculoFrete = DateTime.Now;
                                    carga.SituacaoCarga = SituacaoCarga.CalculoFrete;
                                    carga.SituacaoAlteracaoFreteCarga = SituacaoAlteracaoFreteCarga.NaoInformada;

                                    if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete)
                                        Servicos.Log.TratarErro("Atualizou a situação para calculo frete 47 Carga " + carga.CodigoCargaEmbarcador, "AtualizouSituacaoCalculoFrete");
                                }
                                //}
                                //else
                                //{
                                //    //carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova;
                                //    carga.CalculandoFrete = false;
                                //    if (!carga.DataEnvioUltimaNFe.HasValue)
                                //    {
                                //        if ((!(carga.TipoOperacao?.PermiteImportarDocumentosManualmente ?? false) || carga.TipoOperacao.NaoExigeConformacaoDasNotasEmissao) && repCargaPedido.VerificarSeTodosPedidosEstaoAutorizadosPorCarga(carga.Codigo))
                                //            carga.DataEnvioUltimaNFe = DateTime.Now;
                                //    }
                                //}
                            }
                            else if (!dadosTransporte.SalvarDadosTransporteSemSolicitarNFes)
                            {
                                if (permiteAvancoEtapa)
                                {
                                    carga.SituacaoCarga = SituacaoCarga.AgNFe;

                                    if (!(carga.TipoOperacao?.PermiteImportarDocumentosManualmente ?? false) && repCargaPedido.VerificarSeTodosPedidosEstaoAutorizadosPorCarga(carga.Codigo) && tipoServicoMultisoftware != TipoServicoMultisoftware.MultiTMS)
                                    {

                                        bool exigeConfirmacaoFreteAntesEmissao = carga.Filial?.ExigeConfirmacaoFreteAntesEmissao ?? false;
                                        if (!exigeConfirmacaoFreteAntesEmissao)
                                            exigeConfirmacaoFreteAntesEmissao = carga.TipoOperacao?.ExigeConformacaoFreteAntesEmissao ?? true;

                                        if (!exigeConfirmacaoFreteAntesEmissao)
                                        {
                                            carga.DataEnvioUltimaNFe = DateTime.Now;
                                            carga.DataInicioEmissaoDocumentos = DateTime.Now;
                                        }

                                        carga.ProcessandoDocumentosFiscais = true;
                                        carga.DataInicioConfirmacaoDocumentosFiscais = DateTime.Now;
                                    }
                                }
                                else if (!dadosTransporteInformados && carga.SituacaoCarga == SituacaoCarga.AgNFe)
                                    carga.SituacaoCarga = SituacaoCarga.Nova;
                                else if (carga.TipoOperacao?.CargaTipoConsolidacao ?? false)
                                    carga.SituacaoCarga = SituacaoCarga.AgNFe;
                            }
                        }
                    }

                    if (carga.TipoOperacao?.ExigirConfirmacaoDadosTransportadorAvancarCarga ?? false)
                    {
                        if (!cargaPedidos.Any(o => o.CTeEmitidoNoEmbarcador) && !carga.NaoGerarMDFe && (carga.Filial == null || !carga.Filial.EmitirMDFeManualmente) && (carga.TipoOperacao == null || !carga.TipoOperacao.NaoEmitirMDFe) && carga.Veiculo != null && cargaPedidos.Any(obj => obj.Pedido.SituacaoPedido == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoPedido.Aberto))
                        {
                            List<Dominio.Entidades.Embarcador.Cargas.CargaMDFe> cargasMDFe = repCargaMDFe.BuscarPorCargaVeiculosMDFeNaoEncerrados(carga.Veiculo.Placa);

                            foreach (Dominio.Entidades.Embarcador.Cargas.CargaMDFe cargaMDFe in cargasMDFe)
                            {
                                if (cargaMDFe.Carga.Codigo != carga.Codigo)
                                {
                                    if (cargaMDFe.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Autorizado && cargaMDFe.SistemaEmissor == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SistemaEmissor.MultiCTe)
                                    {
                                        if (configuracaoEmbarcador.EncerrarMDFesDeOutrasViagensAutomaticamente && !(cargaMDFe.Carga.TipoOperacao?.EncerrarMDFeManualmente ?? false) && !(configuracaoGeralCarga?.NaoEncerrarMDFeDeFormaAutomaticaAoConfirmarDadosDeTransporte ?? false))
                                        {
                                            Servicos.Auditoria.Auditoria.Auditar(auditado, cargaMDFe.Carga, null, $"Solicitou o encerramento do MDF-e, ao confirmar a placa na carga {carga.CodigoCargaEmbarcador}.", unitOfWork);
                                            serCarga.SolicitarEncerramentoMDFeAutomaticamente(cargaMDFe.Carga, unitOfWork, tipoServicoMultisoftware, webServiceConsultaCTe, auditado, usuario);
                                        }
                                    }
                                }
                            }
                        }
                    }

                    if (carga.AguardarIntegracaoEtapaTransportador || carga.AguardarIntegracaoDadosTransporte)
                        carga.PossuiPendencia = true;

                    List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoIntegracao> situacoes = repCargaDadosTransporteIntegracao.BuscarSituacoesPorCarga(carga.Codigo);
                    if (!situacoes.Any() || situacoes.All(o => o == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoIntegracao.Integrado))
                    {
                        carga.ProblemaIntegracaoDadosTransporte = false;
                        carga.PossuiPendencia = false;
                        carga.MotivoPendencia = string.Empty;
                    }

                    if ((configuracaoDadosTransporte?.RetornarCargaPendenteConsultaCarregamentoAoSalvarDadosTransporte ?? false) && (carga.IsChangedByPropertyName("Veiculo") || carga.IsChangedByPropertyName("Motoristas")))
                        carga.CarregamentoIntegradoERP = false;

                    if (!string.IsNullOrWhiteSpace(dadosTransporte.ProtocoloIntegracaoGR))
                        carga.ProtocoloIntegracaoGR = dadosTransporte.ProtocoloIntegracaoGR;

                    if (carga.TipoOperacao != null && carga.TipoOperacao.ConfiguracaoDocumentoEmissao != null && carga.TipoOperacao.ConfiguracaoDocumentoEmissao.MinutosAvancarParaEmissaoseInformadosDadosTransporte > 0)
                        carga.DataEnvioUltimaNFe = DateTime.Now.AddMinutes(carga.TipoOperacao.ConfiguracaoDocumentoEmissao.MinutosAvancarParaEmissaoseInformadosDadosTransporte);

                    if (carga.TipoOperacao != null && carga.TipoOperacao.TipoCobrancaMultimodal == TipoCobrancaMultimodal.CTEAquaviario && tipoServicoMultisoftware != TipoServicoMultisoftware.MultiTMS)
                    {
                        Repositorio.Embarcador.Pedidos.Navio repositorioNavio = new Repositorio.Embarcador.Pedidos.Navio(unitOfWork);
                        carga.Navio = repositorioNavio.BuscarPorCodigo(dadosTransporte.CodigoNavio);
                        carga.Balsa = repositorioNavio.BuscarPorCodigo(dadosTransporte.CodigoBalsa);
                    }

                    if (carga.TipoOperacao?.ConfiguracaoCarga?.InformarTransportadorSubcontratadoEtapaUm ?? false)
                        carga.EmpresaSubcontrada = repEmpresa.BuscarPorCodigo(dadosTransporte.CodigoTransportadorSubcontratado);

                    this.GerarOperacaoContainer(ref carga, tipoServicoMultisoftware, configuracaoEmbarcador, cargaPedidos, unitOfWork);

                    repCarga.Atualizar(carga);

                    if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
                        AtualizarVeiculoEMotoristasPedidos(carga, auditado, unitOfWork);

                    if (carga.Empresa != null)
                        repCanhoto.SetarTransportadorCanhotos(carga.Codigo, carga.Empresa.Codigo);

                    bool possuiGenset = cargaPedidos.Any(o => o.Pedido.PossuiGenset == true);

                    AtualizarContainerVeiculo(carga, dadosTransporte, configuracaoEmbarcador, possuiGenset, unitOfWork);

                    if (empresaOrigem?.Codigo != carga.Empresa?.Codigo || tipoOperacaoOrigem?.Codigo != carga.TipoOperacao?.Codigo || (configuracaoGeral.PermiteRealizarConsultaVPUtilizandoModeloVeicularCarga && codigoModeloVeicularOriginal != carga.ModeloVeicularCarga?.Codigo))
                    {
                        Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota.CriarCargaValePedagioPorRotaFrete(carga, cargaPedidos, configuracaoEmbarcador, unitOfWork, tipoServicoMultisoftware);
                        Seguro.Seguro.SetarDadosSeguroCarga(carga, cargaPedidos, configuracaoEmbarcador, tipoServicoMultisoftware, unitOfWork);
                    }

                    serCargaPallets.RatearPaletesModeloVeicularCargaEntreOsPedidos(carga, cargaPedidos);

                    if (carga.TipoOperacao?.ConfiguracaoCalculoFrete?.PermiteInformarQuantidadePaletes ?? false)
                        serCargaPallets.RatearPaletesEntreOsPedidos(dadosTransporte.QuantidadePaletes, cargaPedidos);

                    //Se alterar a empresa ou tipo de operação da carga, deve consultar novamente a rota de frete, porém sem considerar a rota frete do pedido, pois esta deve ser atualizada tbm
                    if (configuracaoGeralCarga.AtualizarDadosDosPedidosComDadosDaCarga && tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador && ((tipoOperacaoOrigem?.Codigo != carga.TipoOperacao?.Codigo && carga.TipoOperacao != null) || (empresaOrigem?.Codigo != carga.Empresa?.Codigo && carga.Empresa != null)))
                        Servicos.Embarcador.Carga.RotaFrete.SetarRotaFreteCarga(carga, cargaPedidos, configuracaoEmbarcador, unitOfWork, tipoServicoMultisoftware, false);

                    List<Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoEmissaoDocumentoEmbarcador> cacheConfiguracaoEmissaoDocumentoEmbarcador = repConfiguracaoEmissaoDocumentoEmbarcador.BuscaConfiguracaoEmissaoDocumentoEmbarcadorPorClientesDaCarga(cargaPedidos);
                    foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
                    {
                        if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador && carga.TipoOperacao != null)
                        {
                            if (carga.TipoOperacao.UtilizarExpedidorComoTransportador && cargaPedido.Expedidor == null)
                            {
                                cargaPedido.Expedidor = repCliente.BuscarPorCPFCNPJ(double.Parse(carga.Empresa.CNPJ_SemFormato));
                                if (cargaPedido.Expedidor != null)
                                {
                                    cargaPedido.Origem = cargaPedido.Expedidor.Localidade;
                                }
                            }
                            else if (cargaPedido.Expedidor != null)
                                cargaPedido.Origem = cargaPedido.Expedidor.Localidade;

                            if ((!cargaPedido.Pedido.ImpostoNegociado || cargaPedido.ModeloDocumentoFiscal == null) && validarModeloDocumentoFiscal)
                            {
                                if (carga.TipoOperacao.UsarConfiguracaoEmissao && carga.TipoOperacao.ModeloDocumentoFiscal != null)
                                    cargaPedido.ModeloDocumentoFiscal = carga.TipoOperacao.ModeloDocumentoFiscal;
                                else if (tipoOperacaoOrigem?.Codigo != carga.TipoOperacao.Codigo)
                                    cargaPedido.ModeloDocumentoFiscal = null;
                            }

                            if ((carga.Empresa != null && (carga.Empresa.EmpresaPropria || carga.Empresa.ModeloDocumentoFiscalCargaPropria != null)) || (carga.TipoOperacao != null && carga.TipoOperacao.CargaPropria))
                            {
                                if (carga.Empresa?.ModeloDocumentoFiscalCargaPropria != null)
                                {
                                    cargaPedido.ModeloDocumentoFiscal = carga.Empresa.ModeloDocumentoFiscalCargaPropria;
                                    cargaPedido.ModeloDocumentoEmpresaPropria = true;
                                }
                            }
                        }

                        if (cargaPedido.SituacaoEmissao != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoNF.NFEnviada)
                            cargaPedido.SituacaoEmissao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoNF.AgEnvioNF;

                        bool cteEmitidoNoEmbarcador = VerificarSeCTeEmitidoNoEmbarcador(cargaPedido, unitOfWork, cacheConfiguracaoEmissaoDocumentoEmbarcador);

                        if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS && cteEmitidoNoEmbarcador != cargaPedido.CTeEmitidoNoEmbarcador && VerificarSePossuiDocumentoVinculado(carga, unitOfWork))
                            throw new ServicoException("Não é possível alterar o tipo de operação desta carga pois existem documentos/notas fiscais vinculados à mesma.");

                        cargaPedido.CTeEmitidoNoEmbarcador = cteEmitidoNoEmbarcador;

                        if (cargaPedido.CTeEmitidoNoEmbarcador && !configuracaoGeralCarga.NaoVincularAutomaticamenteDocumentosEmitidosEmbarcador)
                        {
                            Servicos.Embarcador.MDFe.MDFeImportado.VerificarSeCargaPossuiAlgumMDFeCompativel(out string erro, cargaPedido.Codigo, unitOfWork, auditado, configuracaoEmbarcador);
                            serCTEsImportados.VerificarSeCargaPossuiAlgumCTe(cargaPedido, unitOfWork, auditado);
                        }
                        else
                        {
                            serCTEsImportados.VerificarSeCargaPossuiAlgumCTeTerceiro(cargaPedido, unitOfWork, auditado, tipoServicoMultisoftware);
                        }

                        if (centroResultadoNovoTipoOperacao != null || (configuracaoEmbarcador.UtilizaMoedaEstrangeira && dadosTransporte.DataBaseCRT.HasValue))
                        {
                            Dominio.Entidades.Embarcador.Pedidos.Pedido pedido = cargaPedido.Pedido;
                            pedido.Initialize();

                            if (centroResultadoNovoTipoOperacao != null)
                                pedido.CentroResultado = centroResultadoNovoTipoOperacao;

                            if (configuracaoEmbarcador.UtilizaMoedaEstrangeira && dadosTransporte.DataBaseCRT.HasValue)
                                pedido.DataBaseCRT = dadosTransporte.DataBaseCRT;

                            repositorioPedido.Atualizar(pedido, auditado);
                        }

                        if (configuracaoGeralCarga.AtualizarDadosDosPedidosComDadosDaCarga && tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador)
                        {
                            bool alterouPedido = false;
                            cargaPedido.Pedido.Initialize();

                            if (cargaPedido.Pedido.Empresa != null && carga.Empresa != null && cargaPedido.Pedido.Empresa != carga.Empresa)
                            {
                                cargaPedido.Pedido.Empresa = carga.Empresa;
                                alterouPedido = true;
                            }

                            if (cargaPedido.Pedido.TipoOperacao != null && carga.TipoOperacao != null && cargaPedido.Pedido.TipoOperacao != carga.TipoOperacao)
                            {
                                cargaPedido.Pedido.TipoOperacao = carga.TipoOperacao;
                                alterouPedido = true;
                            }

                            if (cargaPedido.Pedido.RotaFrete != carga.Rota)
                            {
                                cargaPedido.Pedido.RotaFrete = carga.Rota;
                                alterouPedido = true;
                            }

                            if (alterouPedido)
                            {
                                if (cargaPedido.Pedido.RotaFrete == null)
                                    cargaPedido.Pedido.RotaFrete = repositorioRotaFrete.BuscarPorOrigemDestinoTipoOperacaoTransportador(cargaPedido.Pedido.Origem.Codigo, cargaPedido.Pedido.Destino.Codigo, cargaPedido.Pedido.TipoOperacao?.Codigo ?? 0, cargaPedido.Pedido.Empresa?.Codigo ?? 0);

                                Auditoria.Auditoria.Auditar(auditado, cargaPedido.Pedido, cargaPedido.Pedido.GetChanges(), $"Dados do pedido alterado pela carga {cargaPedido.Carga.CodigoCargaEmbarcador} ao salvar os dados de transporte.", unitOfWork);
                                repositorioPedido.Atualizar(cargaPedido.Pedido, auditado);
                            }
                        }

                        repCargaPedido.Atualizar(cargaPedido);
                    }

                    servicoPedido.AtualizarLocalParqueamentoPedido(carga, cargaPedidos, tipoServicoMultisoftware, unitOfWork);

                    if (cargaGuarita != null)
                    {
                        cargaGuarita.ChegadaDenegada = false;
                        repositorioGuarita.Atualizar(cargaGuarita);
                    }

                    AtualizarApoliceSeguro(carga, cargaPedidos, dadosTransporte, unitOfWork);
                    AtualizarDatasCarregamento(carga, cargaJanelaCarregamento, dadosTransporte, tipoServicoMultisoftware, configuracaoEmbarcador, auditado, unitOfWork);

                    if (cargaJanelaCarregamento != null && (cargaJanelaCarregamento.CentroCarregamento?.LimiteCarregamentos == LimiteCarregamentosCentroCarregamento.TempoCarregamento || dadosTransporteInformados))
                    {
                        if (empresaOrigem?.Codigo != carga.Empresa?.Codigo)
                            cargaJanelaCarregamento.CargaCotacaoGanhaAutomaticamente = false;

                        AtualizarDadosCarregamento(carga, cargaJanelaCarregamento, usuario, tipoServicoMultisoftware, configuracaoEmbarcador, unitOfWork);
                    }

                    Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao();
                    RotaFrete.SetarRotaFreteCarga(carga, cargaPedidos, configuracaoTMS, unitOfWork, tipoServicoMultisoftware);

                    AdicionarFluxoGestaoPatio(carga, cargaJanelaCarregamento, unitOfWork, tipoServicoMultisoftware, validarDadosTransporteInformados: true);
                    servicoFluxoGestaoPatio.AtualizarEquipamento(carga);

                    AvancarEtapaGestaoDevolucao(carga, unitOfWork, auditado, cliente);
                    serCargaDadosSumarizados.AlterarDadosSumarizadosCarga(ref carga, cargaPedidos, configuracaoEmbarcador, unitOfWork, tipoServicoMultisoftware);
                    servicoCargaJanelaDescarregamento.AtualizarSituacao(carga, SituacaoCargaJanelaDescarregamentoCadastrada.Programado);

                    serCanhoto.AtualizarDadosCanhotosDaCarga(carga, unitOfWork);

                    if (carga.Carregamento != null)
                        servicoIntegracaoCarregamento.AdicionarIntegracaoCarregamento(carga.Carregamento, StatusCarregamentoIntegracao.Atualizar, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.TelhaNorte);

                    if (cargaJanelaCarregamento != null)
                    {
                        bool reenviarIntegracaoJanelaCarregamento = atualizouMotorista || veiculoAlterado;
                        new Servicos.Embarcador.Logistica.CargaJanelaCarregamentoIntegracao(unitOfWork, tipoServicoMultisoftware).AdicionarJanelaCarregamentoIntegracao(cargaJanelaCarregamento, reenviarIntegracaoJanelaCarregamento);
                    }

                    if ((atualizouMotorista || veiculoAlterado || (configuracaoControleEntrega?.CalcularDataAgendamentoAutomaticamenteDataFaturamento ?? false)) &&
                        (carga.ModeloVeicularCarga?.IntegrarDadosTransporteBrasilRiskAoAtualizarVeiculoNaCarga ?? false) &&
                        (carga.TipoOperacao?.IntegrarDadosTransporteBrasilRiskAoAtualizarVeiculoMotorista ?? false))
                        GerarIntegracaoBrasilRiskCargaVazia(carga, unitOfWork);

                    Dominio.Entidades.Embarcador.Cargas.ColetaEntrega.EtapaVeiculoAlocado etapaVeiculoAlocado = repEtapaVeiculoAlocado.BuscarPorCarga(carga.Codigo);

                    if (etapaVeiculoAlocado != null)
                    {
                        Servicos.Embarcador.Carga.ColetaEntrega.FluxoColetaEntrega.ReplicarInformacoesAlocacao(carga, unitOfWork);
                        if (!etapaVeiculoAlocado.FluxoColetaEntrega.DataVeiculoAlocado.HasValue && etapaVeiculoAlocado.FluxoColetaEntrega.EtapaFluxoColetaEntregaEtapaAtual == EtapaFluxoColetaEntrega.VeiculoAlocado)
                        {
                            etapaVeiculoAlocado.DataInformada = DateTime.Now;
                            repEtapaVeiculoAlocado.Atualizar(etapaVeiculoAlocado);
                            Servicos.Embarcador.Carga.ColetaEntrega.FluxoColetaEntrega.SetarProximaEtapa(carga, EtapaFluxoColetaEntrega.VeiculoAlocado, unitOfWork);
                        }
                    }

                    ControleDisponibilidadeVeiculo(carga, veiculoDaCarga, unitOfWork);

                    Servicos.Embarcador.Carga.AlertaCarga.CargaSemVeiculo servicoAlertaCargaSemVeiculo = new Servicos.Embarcador.Carga.AlertaCarga.CargaSemVeiculo(unitOfWork, StringConexao);
                    if (servicoAlertaCargaSemVeiculo.EstaAtivo() && carga.Veiculo != null)
                        servicoAlertaCargaSemVeiculo.TratarAlertaAposAdicionarVeiculoCarga(carga, carga.Veiculo);

                    if (carga.DataLimiteConfirmacaoMotorista.HasValue && servicoMensagemAlerta.IsMensagemSemConfirmacao(carga, TipoMensagemAlerta.CargaSemConfirmacaoMotorista))
                        carga.SituacaoCarga = SituacaoCarga.Nova; //nao deixa carga avançar.

                    Servicos.Embarcador.Monitoramento.Monitoramento.GerarMonitoramentoEIniciar(carga, configuracaoEmbarcador, auditado, "Salvar dados de transporte da carga (exige nota)", unitOfWork);

                    AtualizarAgendamentoColeta(carga, auditado, unitOfWork);

                    if (carga.SituacaoCarga == SituacaoCarga.AgNFe && (carga.TipoOperacao?.ConfiguracaoCarga?.TempoParaRecebimentoDosPacotes ?? 0) > 0)
                        carga.DataSalvouDadosCarga = DateTime.Now;

                    if (carga.SituacaoCarga == SituacaoCarga.Nova &&
                        configuracaoEmbarcador.QuandoIniciarMonitoramento.HasValue &&
                        configuracaoEmbarcador.QuandoIniciarMonitoramento.Value == QuandoIniciarMonitoramento.AoGerarCarga)
                        carga.DadosSumarizados.RoteirizarNaEtapaDeDadosTransporte = true;

                    carga.SetChanges();

                    IntegrarAlteracaoOrdensEmbarque(carga, usuario, unitOfWork);

                    if (configuracaoVeiculo.CriarVinculoFrotaCargaForaDoPlanejamentoFrota)
                        AplicarAlteracaoCargaAoPlanejamentoFrota(carga, tipoServicoMultisoftware, cliente, webServiceConsultaCTe, unitOfWork);

                    if (!abriuTransacao)
                        unitOfWork.CommitChanges();

                    if (notificar)
                    {
                        if (!naoNotificarCarga)
                            serHubCarga.InformarCargaAtualizada(carga.Codigo, TipoAcaoCarga.Alterada, StringConexao);
                        NotificarAppMotoristas(carga, motoristas, codigosMotoristasAntesDaAtualizacao, cliente);
                    }

                    if (dadosTransporte.ListaCodigoMotorista.Count > 0 && (!dadosTransporte.ListaCodigoMotorista.All(codigosMotoristasAntesDaAtualizacao.Contains)) &&
                       (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador || tipoServicoMultisoftware == TipoServicoMultisoftware.MultiCTe) &&
                       !configuracaoGeralCarga.NotificarNovaCargaAposConfirmacaoDocumentos)
                    {
                        Notificacao.NotificacaoMTrack serNotificacaoMTrack = new Notificacao.NotificacaoMTrack(unitOfWork);
                        serNotificacaoMTrack.NotificarMudancaCarga(carga, motoristas, MobileHubs.NovaCargaMotorista);
                    }

                    dadosFrete.Placas = ObterPlacas(carga, configuracaoEmbarcador);
                    dadosFrete.MensagemProblemaIntegracaoGrMotoristaVeiculo = carga.MensagemProblemaIntegracaoGrMotoristaVeiculo;
                    dadosFrete.situacaoCarga = carga.SituacaoCarga;
                    AtualizarIntegracaoSILEMP(repCargaDadosTransporteIntegracao, carga);

                    if (ModeloVeicularDiferenteDoSolicitado)
                        GerarAtendimentoPorGatilhoNaCarga(carga, TipoMotivoChamadoGatilhoNaCarga.AoSalvarPlacaComModeloVeicularDiferenteDoPrevisto, tipoServicoMultisoftware, unitOfWork, auditado);

                    if ((carga.ModeloVeicularCarga?.Codigo ?? 0) != codigoModeloVeicularOriginal)
                        ObterTipoTrechoDadosTransporte(carga, cargaPedidos, unitOfWork);

                    EnviarEmailNotificacaoAutomaticamenteTransportadorDaCarga(carga, unitOfWork, auditado);

                    retorno = dadosFrete;
                }
                else
                {
                    if (!abriuTransacao)
                        unitOfWork.Start();

                    string retornoVerificarOperador = VerificarOperadorPodeConfigurarCarga(usuario, carga, tipoServicoMultisoftware, unitOfWork);

                    if (!string.IsNullOrWhiteSpace(retornoVerificarOperador))
                        throw new ServicoException(retornoVerificarOperador);

                    bool permitirSalvarDadosTrasporteCargaEtapaNFe = (carga.SituacaoCarga == SituacaoCarga.AgNFe) && configuracaoEmbarcador.PermitirInformarDadosTransportadorCargaEtapaNFe;

                    if ((carga.SituacaoCarga != SituacaoCarga.AgTransportador) && !permitirSalvarDadosTrasporteCargaEtapaNFe)
                        throw new ServicoException($"Não é possível alterar o transportador na atual situação da carga ({carga.DescricaoSituacaoCarga})");

                    if (configuracaoEmbarcador.ExigirCargaRoteirizada && carga.CalculandoFrete && carga.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Concluido)
                        throw new ServicoException("Carga está calculando o Frete, favor aguardar!");

                    if (repCarga.CargaEstaEmCancelamento(carga.Codigo))
                        throw new ServicoException("Carga já está em Cancelamento!");

                    ControleDisponibilidadeVeiculo(carga, veiculoDaCarga, unitOfWork);

                    Repositorio.Embarcador.Cargas.CargaJanelaCarregamento repCargaJanelaCarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamento(unitOfWork);

                    if (dadosTransporte.CodigoEmpresa > 0 &&
                        carga.Empresa == null &&
                        cargaJanelaCarregamento != null &&
                        cargaJanelaCarregamento.CentroCarregamento != null &&
                        cargaJanelaCarregamento.Situacao == SituacaoCargaJanelaCarregamento.SemTransportador &&
                        cargaJanelaCarregamento.DataSituacaoAtual.HasValue &&
                        cargaJanelaCarregamento.CentroCarregamento.TempoBloqueioEscolhaTransportador > 0)
                    {
                        double minutosSituacao = (DateTime.Now - cargaJanelaCarregamento.DataSituacaoAtual.Value).TotalMinutes;

                        if (minutosSituacao < cargaJanelaCarregamento.CentroCarregamento.TempoBloqueioEscolhaTransportador)
                            throw new ServicoException($"Não é possível setar o transportador da carga, pois a carga deve ficar disponível por mais {(cargaJanelaCarregamento.CentroCarregamento.TempoBloqueioEscolhaTransportador - minutosSituacao).ToString("n0")} minutos para a visualização dos transportadores na janela de carregamento.");
                    }

                    if (dadosTransporte.CodigoModeloVeicular > 0)
                    {
                        Dominio.Entidades.Embarcador.Cargas.ModeloVeicularCarga modeloVeicularInformado = repModeloVeicular.BuscarPorCodigo(dadosTransporte.CodigoModeloVeicular);

                        if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador && modeloVeicularInformado != null)
                        {
                            if (carga.ModeloVeicularCarga != null && carga.Carregamento?.ModeloVeicularCarga != null && carga.Carregamento?.ModeloVeicularCarga?.Codigo == carga.ModeloVeicularCarga.Codigo && carga.Carregamento?.ModeloVeicularCarga?.Codigo != dadosTransporte.CodigoModeloVeicular)
                            {
                                // alterou modelo veicular;
                                Dominio.Entidades.Embarcador.Pedidos.RetiradaContainer retiradaContainer = repositorioRetiradaContainer.BuscarPorCarga(carga.Codigo);
                                if (retiradaContainer != null)
                                {
                                    if (retiradaContainer.ColetaContainer != null)
                                        throw new ServicoException("Não é permitido a troca do modelo veicular, a carga já possuí retirada container com coleta de container vinculada");

                                    if (retiradaContainer.ContainerTipo != null && modeloVeicularInformado.ContainerTipo != null && retiradaContainer.ContainerTipo.Codigo != modeloVeicularInformado.ContainerTipo.Codigo)
                                    {
                                        retiradaContainer.Container = null;
                                        retiradaContainer.ContainerTipo = modeloVeicularInformado.ContainerTipo;
                                        repositorioRetiradaContainer.Atualizar(retiradaContainer, auditado);
                                    }
                                }
                            }

                            if (modeloVeicularInformado.ContainerTipo == null)
                                new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork).Confirmar(carga, TipoMensagemAlerta.CargaSemInformacaoContainer);//remover mensagem
                        }

                        carga.ModeloVeicularCarga = modeloVeicularInformado;
                    }

                    if (dadosTransporte.CodigoTipoCarga > 0)
                    {
                        carga.TipoDeCarga = repTipoCarga.BuscarPorCodigo(dadosTransporte.CodigoTipoCarga);

                        if (carga.CargaAgrupada)
                        {
                            foreach (Dominio.Entidades.Embarcador.Cargas.Carga cargaOrigem in carga.CargasAgrupamento.ToList())
                            {
                                if (carga.TipoDeCarga?.Codigo != cargaOrigem.TipoDeCarga?.Codigo)
                                {
                                    cargaOrigem.TipoDeCarga = carga.TipoDeCarga;
                                    repCarga.Atualizar(cargaOrigem);
                                }
                            }
                        }
                    }

                    if (carga.TipoOperacao != null && carga.TipoOperacao.TipoCobrancaMultimodal == TipoCobrancaMultimodal.CTEAquaviario && tipoServicoMultisoftware != TipoServicoMultisoftware.MultiTMS)
                    {
                        Repositorio.Embarcador.Pedidos.Navio repositorioNavio = new Repositorio.Embarcador.Pedidos.Navio(unitOfWork);
                        carga.Navio = repositorioNavio.BuscarPorCodigo(dadosTransporte.CodigoNavio);
                        carga.Balsa = repositorioNavio.BuscarPorCodigo(dadosTransporte.CodigoBalsa);
                    }

                    if (dadosTransporte.CodigoTipoOperacao > 0)
                        carga.TipoOperacao = repTipoOperacao.BuscarPorCodigo(dadosTransporte.CodigoTipoOperacao);

                    if (dadosTransporte.Container > 0)
                        carga.Container = repositorioContainer.BuscarPorCodigo(dadosTransporte.Container);

                    Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCodigo(dadosTransporte.CodigoEmpresa);

                    if (empresa != null && (string.IsNullOrWhiteSpace(empresa.NomeCertificado) || empresa.DataFinalCertificado < DateTime.Now) && carga.TipoFreteEscolhido != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Cliente && !empresa.EmissaoDocumentosForaDoSistema)
                        throw new ServicoException("O transportador informado não está apto a emitir pelo Multi Embarcador");

                    carga.Empresa = empresa;

                    if (empresaOrigem?.Codigo != carga.Empresa?.Codigo)
                    {
                        recalcularFrete = true;
                        if (cargaJanelaCarregamento != null && cargaJanelaCarregamento.CargaCotacaoGanhaAutomaticamente)
                        {
                            cargaJanelaCarregamento.CargaCotacaoGanhaAutomaticamente = false;
                            repCargaJanelaCarregamento.Atualizar(cargaJanelaCarregamento);
                        }
                    }

                    if (carga.Empresa?.BloquearTransportador ?? false)
                    {
                        string mensagemBloqueioVeiculo = $"O transportador {carga.Empresa.Descricao} está bloqueado";

                        if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador)
                            mensagemBloqueioVeiculo += $" pelo motivo {carga.Empresa.MotivoBloqueio}.";
                        else
                            mensagemBloqueioVeiculo += $". Entre em contato com o embarcador para entender o motivo.";

                        throw new ServicoException(mensagemBloqueioVeiculo);
                    }

                    if ((carga.Empresa != null) && carga.IsChangedByPropertyName("Empresa"))
                    {
                        new Servicos.Embarcador.GestaoPallet.MovimentacaoPallet(unitOfWork, auditado).InformarTrocaTransportador(carga);
                        servicoCargaIndicador.DefinirIndicadorTransportador(carga, CargaIndicadorTransportador.InformadoManualmente);
                    }

                    Dominio.Entidades.Veiculo veiculo = null;

                    if (dadosTransporte.CodigoTracao > 0)
                    {
                        veiculo = repVeiculo.BuscarPorCodigo(dadosTransporte.CodigoTracao);

                        if ((carga.TipoOperacao?.ExigirVeiculoComRastreador ?? false) && (veiculo != null && !(veiculo?.PossuiRastreador ?? false)))
                            throw new ServicoException($"Para o tipo de operação '{carga.TipoOperacao.Descricao}' é obrigatório informar um veiculo com o rastreador cadastrado.");

                        if (veiculo.TipoVeiculo == "1")
                        {
                            if (veiculo.VeiculosTracao != null && veiculo.VeiculosTracao.Count > 0)
                                veiculo = veiculo.VeiculosTracao.FirstOrDefault();
                        }
                    }

                    if (veiculo != null && configuracaoEmbarcador.Pais != TipoPais.Exterior)
                    {
                        if (string.IsNullOrWhiteSpace(veiculo.Renavam))
                            throw new ServicoException($"Não é possível selecionar o veículo ({veiculo.Placa}) pois o mesmo não possui o RENAVAM Informado, por favor, entre em contato com o transportador e solicite que ele informe o RENAVAM do veículo");

                        //Ao salvar os dados de transporte, atualiza a situação da tag do vale pedágio.
                        servicoMensagemAlerta.Remover(carga, TipoMensagemAlerta.ProblemaConsultaTagValePedagioVeiculo);

                        Dominio.Entidades.Embarcador.Veiculos.VeiculoIntegracao integracaoVeiculo = new Servicos.Embarcador.Integracao.SemParar.ConsultaCadastroVeiculo(unitOfWork, tipoServicoMultisoftware).GerarIntegracaoCadastroVeiculo(veiculo);

                        if (!veiculo.PossuiTagValePedagio && !veiculo.NaoComprarValePedagio)
                        {
                            if (configuracaoJanelaCarregamento.BloquearVeiculoSemTagValePedagioAtiva ?? false)
                                throw new ServicoException(Localization.Resources.Logistica.JanelaCarregamentoTransportador.NaoPossuiTagValePedagioAtiva);

                            if (configuracaoIntegracaoEFrete?.ConsultarTagAoIncluirVeiculoNaCarga ?? false)
                                servicoMensagemAlerta.Adicionar(carga, TipoMensagemAlerta.ProblemaConsultaTagValePedagioVeiculo, integracaoVeiculo?.ProblemaIntegracao ?? "Falha ao consultar o vale pedágio do veículo.");
                        }

                        if (veiculo.ModeloVeicularCarga == null)
                        {
                            veiculo.ModeloVeicularCarga = carga.ModeloVeicularCarga;
                            repVeiculo.Atualizar(veiculo);

                            foreach (Dominio.Entidades.Veiculo veiculoVinculado in veiculo.VeiculosVinculados)
                            {
                                veiculoVinculado.ModeloVeicularCarga = carga.ModeloVeicularCarga;
                                repVeiculo.Atualizar(veiculoVinculado);
                            }
                        }

                        if (veiculo.Tipo == "T")
                            carga.FreteDeTerceiro = true;
                        else if (carga.ProvedorOS != null)
                            carga.FreteDeTerceiro = true;
                        else
                            carga.FreteDeTerceiro = false;

                        if (veiculo.VeiculoBloqueado)
                        {
                            string mensagemBloqueioVeiculo = $"O veículo {veiculo.Placa_Formatada} está bloqueado";

                            if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador && !(configuracaoVeiculo.NaoMostrarMotivoBloqueio ?? false))
                                mensagemBloqueioVeiculo += $" pelo motivo {veiculo.MotivoBloqueio}.";
                            else
                                mensagemBloqueioVeiculo += $". Entre em contato com o embarcador para entender o motivo.";

                            throw new ServicoException(mensagemBloqueioVeiculo);
                        }

                        ValidarDadosFaltantesNoVeiculo(veiculo, carga.Empresa, unitOfWork);

                        Dominio.Entidades.Empresa matriz = null;
                        if (carga.Empresa.Matriz != null && carga.Empresa.Matriz.Count > 0)
                            matriz = carga.Empresa.Matriz.FirstOrDefault();

                        if (configuracaoEmbarcador.FiltrarBuscaVeiculosPorEmpresa && (veiculo.Empresa.Codigo != carga.Empresa.Codigo) && (matriz == null || veiculo.Empresa.Codigo != matriz.Codigo))
                            throw new ServicoException($"O veículo informado não pertence a empresa selecionada (Empresa: {carga.Empresa.RazaoSocial}).");

                        //string codigoCargaAberto = repCarga.BuscaNumeroDaCargaEmAbertoPorVeiculo(carga.Codigo, veiculo.Placa);

                        //if (!string.IsNullOrWhiteSpace(codigoCargaAberto))
                        //    throw new ServicoException($"Não é possível selecionar este veículo pois ele está alocado em uma carga que está em processo de alocação (carga: {codigoCargaAberto}).");
                    }
                    else if (carga.ProvedorOS != null)
                        carga.FreteDeTerceiro = true;

                    carga.Veiculo = veiculo;

                    if (carga.VeiculosVinculados == null)
                        carga.VeiculosVinculados = new List<Dominio.Entidades.Veiculo>();

                    bool veiculoAlterado = carga.IsChangedByPropertyName("Veiculo");

                    if (carga.TipoOperacao?.ExigePlacaTracao ?? false)
                    {
                        carga.VeiculosVinculados.Clear();

                        if (dadosTransporte.CodigoReboque > 0)
                        {
                            Dominio.Entidades.Veiculo reboque = repVeiculo.BuscarPorCodigo(dadosTransporte.CodigoReboque);

                            if (reboque != null && !carga.VeiculosVinculados.Contains(reboque))
                                carga.VeiculosVinculados.Add(reboque);
                        }

                        if (dadosTransporte.CodigoSegundoReboque > 0)
                        {
                            Dominio.Entidades.Veiculo reboque = repVeiculo.BuscarPorCodigo(dadosTransporte.CodigoSegundoReboque);

                            if (reboque != null && !carga.VeiculosVinculados.Contains(reboque))
                                carga.VeiculosVinculados.Add(reboque);
                        }

                        if (dadosTransporte.CodigoTerceiroReboque > 0)
                        {
                            Dominio.Entidades.Veiculo reboque = repVeiculo.BuscarPorCodigo(dadosTransporte.CodigoTerceiroReboque);

                            if (reboque != null && !carga.VeiculosVinculados.Contains(reboque))
                                carga.VeiculosVinculados.Add(reboque);
                        }

                        RealocarVeiculosSeNecessario(veiculo, veiculoAnterior, veiculoAlterado, carga.VeiculosVinculados.ToList(), reboquesAnteriores, carga, unitOfWork, tipoServicoMultisoftware);
                    }
                    else if (carga.Veiculo != null)
                    {
                        bool atualizarVeiculosVinculados = veiculoAlterado || !configuracaoGeralCarga.UtilizarProgramacaoCarga || !servicoFilaCarregamentoVeiculo.ExisteFilaCarregamentoVeiculoPorCarga(carga.Codigo);

                        if (atualizarVeiculosVinculados)
                        {
                            carga.VeiculosVinculados.Clear();

                            foreach (Dominio.Entidades.Veiculo veiculoVinculado in carga.Veiculo.VeiculosVinculados)
                                carga.VeiculosVinculados.Add(veiculoVinculado);

                            RealocarVeiculosSeNecessario(veiculo, veiculoAnterior, veiculoAlterado, carga.VeiculosVinculados.ToList(), reboquesAnteriores, carga, unitOfWork, tipoServicoMultisoftware);
                        }
                    }
                    else
                        carga.VeiculosVinculados.Clear();

                    if (carga.Veiculo != null)
                    {
                        Repositorio.Embarcador.GestaoPatio.FluxoPatioCancelamento repositorioFluxoPatioCancelamento = new Repositorio.Embarcador.GestaoPatio.FluxoPatioCancelamento(unitOfWork);
                        bool possuiVeiculoBloqueado = repositorioFluxoPatioCancelamento.BuscarSeVeiculoEstaBloqueadoPorCargaVeiculo(carga.Codigo, carga.Veiculo.Codigo);

                        if (possuiVeiculoBloqueado)
                            throw new ServicoException("Esse veículo está bloqueado para está carga.");

                    }

                    ModeloVeicularDiferenteDoSolicitado = VerificarModeloVeicularDiferenteDoSolicitado(carga);

                    if (configuracoesGestaoPatioPorCarga.BloquearEdicaoVeiculosCarga && (veiculoAlterado || carga.IsChangedByPropertyName("VeiculosVinculados")))
                        throw new ServicoException($"O veículo não pode mais ser alterado.");

                    if (configuracaoEmbarcador.UtilizaEmissaoMultimodal)
                        carga.NaoExigeVeiculoParaEmissao = true;

                    if (!carga.NaoExigeVeiculoParaEmissao && !configuracaoEmbarcador.PermitirSalvarDadosParcialmenteInformadosEtapaTransportador && carga.Veiculo == null)
                        throw new ServicoException("É obrigatório informar o veículo para autorizar os dados.");

                    AjustarCargasOriginais(carga, tipoOperacaoOrigem, empresaOrigem, configuracaoGeralCarga, unitOfWork);

                    servicoJanelaCarregamentoTransportadorValidacoes.ValidarApoliceSeguro(carga.Codigo, carga.Empresa, null, configuracaoDadosTransporte);

                    if (carga.TipoOperacao != null && carga.TipoOperacao.UsaJanelaCarregamentoPorEscala && cargaJanelaCarregamento == null)
                    {
                        if (carga.Empresa != null && carga.Veiculo != null)
                        {
                            DateTime dataEscala = carga.DataCarregamentoCarga.HasValue ? carga.DataCarregamentoCarga.Value : carga.DataCriacaoCarga;
                            Dominio.Entidades.Embarcador.PreCargas.PreCarga preCarga = repPreCarga.BuscarPorEscala(carga.Veiculo.Codigo, carga.Empresa.Codigo, carga.Filial?.Codigo ?? 0, dataEscala.Date);

                            if (preCarga != null)
                                servicoCargaJanelaCarregamento.DefinirCargaPorPreCarga(carga, preCarga);
                        }
                    }

                    if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador && carga.Filial != null && carga.Empresa != null && carga.Empresa.FiliaisEmbarcadorHabilitado != null && carga.Empresa.FiliaisEmbarcadorHabilitado.Count > 0)
                    {
                        if (!carga.Empresa.FiliaisEmbarcadorHabilitado.Any(obj => obj.Codigo == carga.Filial.Codigo))
                            throw new ServicoException($"O transportador selecionado não está apto a transportar na filial {carga.Filial.Descricao}.");
                    }

                    servicoCargaOperador.Atualizar(carga, usuario, tipoServicoMultisoftware);

                    carga.VeiculoIntegradoEmbarcador = false;

                    Dominio.Entidades.Embarcador.Cargas.CargaControleExpedicao cargaControleExpedicao = repCargaControleExpedicao.BuscarPorCarga(carga.Codigo);

                    if (carga.Veiculo != null)
                    {
                        Dominio.Entidades.Embarcador.Logistica.VeiculoDisponivelCarregamento veiculoDisponivelJanela = repVeiculoDisponivelCarregamento.BuscarPorVeiculoEmpresa(carga.Veiculo.Codigo, carga.Empresa.Codigo);

                        if (veiculoDisponivelJanela != null)
                        {
                            veiculoDisponivelJanela.Disponivel = false;
                            veiculoDisponivelJanela.DataIndisponibilizacaoVeiculo = DateTime.Now;
                            veiculoDisponivelJanela.UsuarioIndisponibilizou = usuario;

                            repVeiculoDisponivelCarregamento.Atualizar(veiculoDisponivelJanela);
                            servicoCargaJanelaCarregamentoTransportador.ValidarCargasInteressadas(carga.Empresa, carga);
                        }

                        if (carga.PossuiPendencia)
                        {

                            if (cargaControleExpedicao != null && carga.Veiculo != null)
                            {
                                if (carga.Veiculo.Placa.ToUpper() == cargaControleExpedicao.Placa.ToUpper() || carga.VeiculosVinculados.Any(obj => obj.Placa.ToUpper() == cargaControleExpedicao.Placa.ToUpper()))
                                {
                                    carga.PossuiPendencia = false;
                                    carga.MotivoPendencia = "";
                                    cargaControleExpedicao.SituacaoCargaControleExpedicao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCargaControleExpedicao.Liberada;
                                    repCargaControleExpedicao.Atualizar(cargaControleExpedicao);
                                }
                                else
                                    throw new ServicoException(carga.MotivoPendencia);
                            }
                        }

                        AtualizarVinculoVeiculoMotorista(carga.Veiculo, dadosTransporte.ListaCodigoMotorista, configuracaoEmbarcador, unitOfWork, auditado);
                    }

                    Dominio.ObjetosDeValor.Embarcador.GR.RetornoGR retornoGR = null;
                    List<Dominio.Entidades.Usuario> motoristas = new List<Dominio.Entidades.Usuario>();

                    foreach (int codigoMotorista in dadosTransporte.ListaCodigoMotorista)
                    {
                        Dominio.Entidades.Usuario motorista = repUsuario.BuscarPorCodigo(codigoMotorista);
                        servicoIntegracaoOneTrust.VerificarSituacaoMotorista(motorista);

                        if (configuracaoEmbarcador.ValidarDataLiberacaoSeguradora && !motorista.DataValidadeLiberacaoSeguradora.HasValue)
                            throw new ServicoException("O motorista não possui uma data de limite da seguradora configurada, por isso não é possível informar este motorista para transportar essa carga, verifique e tente novamente.");

                        if (configuracaoEmbarcador.ValidarDataLiberacaoSeguradora && (motorista.DataValidadeLiberacaoSeguradora.HasValue && motorista.DataValidadeLiberacaoSeguradora.Value.AddDays(1).AddMinutes(-1) < DateTime.Now))
                            throw new ServicoException($"A data de limite do motorista na seguradora está válido até {motorista.DataValidadeLiberacaoSeguradora.Value.ToString("dd/MM/yyyy")}, por isso não é possível informar este motorista para transportar essa carga, verifique e tente novamente.");

                        if (motorista.Bloqueado)
                        {
                            string mensagemMotoristaVeiculo = $"O motorista {motorista.Descricao} está bloqueado";

                            if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador)
                                mensagemMotoristaVeiculo += $" pelo motivo {motorista.MotivoBloqueio}.";
                            else
                                mensagemMotoristaVeiculo += $". Entre em contato com o embarcador para entender o motivo.";

                            if (!string.IsNullOrWhiteSpace(configuracaoConfiguracaoMotorista.MensagemPersonalizadaMotoristaBloqueado))
                                mensagemMotoristaVeiculo = configuracaoConfiguracaoMotorista.MensagemPersonalizadaMotoristaBloqueado;

                            throw new ServicoException(mensagemMotoristaVeiculo);
                        }

                        if (carga.TipoOperacao?.ConfiguracaoCarga?.NaoPermitirInformarMotoristaComCNHVencida ?? false)
                        {
                            if (!motorista.DataVencimentoHabilitacao.HasValue)
                                throw new ServicoException("O motorista não possui a data de validade da CNH preenchida, por isso não é possível informar este motorista para transportar a carga, verifique e tente novamente.");
                            if (motorista.DataVencimentoHabilitacao.Value.AddDays(30) < DateTime.Now.Date)
                                throw new ServicoException($"A data de validade da CNH do motorista estava valida até {motorista.DataVencimentoHabilitacao.Value.ToDateString()} e já excedeu os 30 dias permitidos, por isso não é possível informar este motorista para transportar a carga, verifique e tente novamente.");
                        }

                        retornoGR = ValidarMotoristaGR(liberarComProblemaIntegracaoGrMotoristaVeiculo, carga, motorista, tipoServicoMultisoftware, unitOfWork);
                        VerificarErroAdagio(retornoGR, liberarComProblemaIntegracaoGrMotoristaVeiculo);

                        Dominio.Entidades.Usuario veiculoMotorista = null;
                        if (carga.Veiculo != null)
                            veiculoMotorista = repVeiculoMotorista.BuscarMotoristaPrincipal(carga.Veiculo.Codigo);

                        if (configuracaoEmbarcador.PreencherMotoristaAutomaticamenteAoInformarVeiculo && carga.Veiculo != null && veiculoMotorista == null)
                        {
                            // carga.Veiculo.Motorista = motorista;
                            // repVeiculo.Atualizar(carga.Veiculo);
                            Dominio.Entidades.Embarcador.Veiculos.VeiculoMotorista VeiculoMotoristaPrincipal = new Dominio.Entidades.Embarcador.Veiculos.VeiculoMotorista
                            {
                                CPF = motorista.CPF,
                                Motorista = motorista,
                                Nome = motorista.Nome,
                                Veiculo = carga.Veiculo,
                                Principal = true
                            };

                            repVeiculoMotorista.Inserir(VeiculoMotoristaPrincipal);
                        }

                        motoristas.Add(motorista);
                    }

                    bool atualizouMotorista = servicoCargaMotorista.AtualizarMotoristas(carga, motoristas);
                    servicoFilaCarregamentoVeiculo.AtualizarPorCarga(carga, tipoServicoMultisoftware);

                    if ((tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador || tipoServicoMultisoftware == TipoServicoMultisoftware.MultiCTe) && (dadosTransporte.CodigoTracao > 0 || dadosTransporte.ListaCodigoMotorista.Count > 0))
                    {
                        if (carga.IsChangedByPropertyName("Veiculo") || carga.IsChangedByPropertyName("Motoristas"))
                            servicoCargaIndicador.DefinirIndicadorDadosTransporte(carga, tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador ? CargaIndicadorVeiculoMotorista.InformadoEmbarcador : CargaIndicadorVeiculoMotorista.InformadoTransportador);
                    }

                    List<Dominio.ObjetosDeValor.Embarcador.GR.RetornoGR> retornosGRVeiculos = ValidarVeiculoGR(liberarComProblemaIntegracaoGrMotoristaVeiculo, carga, unitOfWork);

                    foreach (Dominio.ObjetosDeValor.Embarcador.GR.RetornoGR retornoGRVeiculo in retornosGRVeiculos)
                    {
                        VerificarErroAdagio(retornoGRVeiculo, liberarComProblemaIntegracaoGrMotoristaVeiculo);
                    }

                    if (carga.Empresa != null)
                        repCanhoto.SetarTransportadorCanhotos(carga.Codigo, carga.Empresa.Codigo);

                    List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo);
                    bool possuiGenset = cargaPedidos.Any(o => o.Pedido.PossuiGenset == true);

                    Servicos.Embarcador.Veiculo.Veiculo.ValidarBloqueioPorCargaNaoFinalizada(carga.Veiculo?.Placa, carga.Codigo, configuracaoEmbarcador, unitOfWork);
                    Servicos.Embarcador.Veiculo.Veiculo.ValidarDataLiberacaoSeguradora(carga.Veiculo, configuracaoEmbarcador);
                    Servicos.Embarcador.Veiculo.Veiculo.ValidarDataLiberacaoSeguradora(carga.VeiculosVinculados, configuracaoEmbarcador);

                    AtualizarContainerVeiculo(carga, dadosTransporte, configuracaoEmbarcador, possuiGenset, unitOfWork);

                    //deve ser chamado sempre que atualiza o veiculo na carga
                    AtualizarIntegracaoConsultaCalculoValePedagio(carga, unitOfWork, tipoServicoMultisoftware);

                    if (carga.TipoFreteEscolhido != TipoFreteEscolhido.Cliente)
                    {
                        if (carga.TipoFreteEscolhido != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Embarcador && carga.TipoFreteEscolhido != TipoFreteEscolhido.Operador)
                        {
                            if (recalcularFrete)
                            {
                                carga.MotivoPendenciaFrete = Dominio.ObjetosDeValor.Embarcador.Enumeradores.MotivoPendenciaFrete.NenhumPendencia;
                                carga.PossuiPendencia = false;
                                carga.CalcularFreteSemEstornarComplemento = true;
                                carga.MotivoPendencia = "";
                                carga.CalculandoFrete = true;
                                carga.DataInicioCalculoFrete = DateTime.Now;

                                if (permitirSalvarDadosTrasporteCargaEtapaNFe)
                                    carga.SituacaoCarga = SituacaoCarga.AgTransportador;
                            }
                        }
                        else
                        {
                            Servicos.Embarcador.Carga.RateioFrete serCargaRateio = new Servicos.Embarcador.Carga.RateioFrete(unitOfWork);
                            serCargaRateio.RatearValorDoFrenteEntrePedidos(carga, cargaPedidos, configuracaoEmbarcador, false, unitOfWork, tipoServicoMultisoftware);
                            if (carga.EmpresaFilialEmissora != null)
                                serCargaRateio.RatearValorDoFrenteEntrePedidos(carga, cargaPedidos, configuracaoEmbarcador, true, unitOfWork, tipoServicoMultisoftware);
                        }
                    }

                    if ((configuracaoDadosTransporte?.RetornarCargaPendenteConsultaCarregamentoAoSalvarDadosTransporte ?? false) && (carga.IsChangedByPropertyName("Veiculo") || carga.IsChangedByPropertyName("Motoristas")))
                        carga.CarregamentoIntegradoERP = false;

                    if (!string.IsNullOrWhiteSpace(dadosTransporte.ProtocoloIntegracaoGR))
                        carga.ProtocoloIntegracaoGR = dadosTransporte.ProtocoloIntegracaoGR;

                    if (carga.DataLimiteConfirmacaoMotorista.HasValue && servicoMensagemAlerta.IsMensagemSemConfirmacao(carga, TipoMensagemAlerta.CargaSemConfirmacaoMotorista))
                        carga.SituacaoCarga = SituacaoCarga.Nova; //nao deixa carga avançar.

                    repCarga.Atualizar(carga);

                    Servicos.Embarcador.Monitoramento.Monitoramento.GerarMonitoramentoEIniciar(carga, configuracaoEmbarcador, auditado, "Salvar dados de transporte da carga (não exige nota)", unitOfWork);

                    if (
                        carga.Rota != null && (carga.Rota.SituacaoDaRoteirizacao == SituacaoRoteirizacao.Erro || carga.Rota.SituacaoDaRoteirizacao == SituacaoRoteirizacao.SemDefinicao) &&
                        !configuracaoEmbarcador.CadastrarRotaAutomaticamente && !configuracaoEmbarcador.ExigirRotaRoteirizadaNaCarga
                    )
                        Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota.CriarCargaValePedagioPorRotaFrete(carga, cargaPedidos, configuracaoEmbarcador, unitOfWork, tipoServicoMultisoftware);

                    AtualizarApoliceSeguro(carga, cargaPedidos, dadosTransporte, unitOfWork);
                    AtualizarDatasCarregamento(carga, cargaJanelaCarregamento, dadosTransporte, tipoServicoMultisoftware, configuracaoEmbarcador, auditado, unitOfWork);

                    List<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> cargaMotoristas = repCargaMotorista.BuscarPorCarga(carga.Codigo);

                    Servicos.Embarcador.Integracao.IntegracaoCarga.AdicionarIntegracoesCarga(carga, cargaPedidos, tipoServicoMultisoftware, unitOfWork, false);
                    Servicos.Embarcador.Integracao.IntegracaoCarga.AdicionarIntegracoesCargaDadosTransporte(carga, cargaPedidos, cargaMotoristas, configuracaoEmbarcador, tipoServicoMultisoftware, unitOfWork);

                    if (carga.AguardarIntegracaoEtapaTransportador || carga.AguardarIntegracaoDadosTransporte)
                        carga.PossuiPendencia = true;

                    List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoIntegracao> situacoes = repCargaDadosTransporteIntegracao.BuscarSituacoesPorCarga(carga.Codigo);
                    if (!situacoes.Any() || situacoes.All(o => o == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoIntegracao.Integrado))
                    {
                        carga.ProblemaIntegracaoDadosTransporte = false;
                        carga.PossuiPendencia = false;
                        carga.MotivoPendencia = string.Empty;
                    }

                    servicoFreteSubcontratacaoTerceiro.CalcularFreteSubcontratacao(carga, carga.TipoFreteEscolhido, unitOfWork, false, tipoServicoMultisoftware, StringConexao);

                    if (cargaGuarita != null)
                    {
                        cargaGuarita.ChegadaDenegada = false;
                        repositorioGuarita.Atualizar(cargaGuarita);
                    }

                    if (cargaJanelaCarregamento != null)
                        AtualizarDadosCarregamento(carga, cargaJanelaCarregamento, usuario, tipoServicoMultisoftware, configuracaoEmbarcador, unitOfWork);

                    if (carga.Carregamento != null)
                        servicoIntegracaoCarregamento.AdicionarIntegracaoCarregamento(carga.Carregamento, StatusCarregamentoIntegracao.Atualizar, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.TelhaNorte);

                    if (cargaJanelaCarregamento != null)
                    {
                        bool reenviarIntegracaoJanelaCarregamento = atualizouMotorista || veiculoAlterado;
                        new Servicos.Embarcador.Logistica.CargaJanelaCarregamentoIntegracao(unitOfWork, tipoServicoMultisoftware).AdicionarJanelaCarregamentoIntegracao(cargaJanelaCarregamento, reenviarIntegracaoJanelaCarregamento);
                    }

                    if ((atualizouMotorista || veiculoAlterado || (configuracaoControleEntrega?.CalcularDataAgendamentoAutomaticamenteDataFaturamento ?? false)) &&
                        (carga.ModeloVeicularCarga?.IntegrarDadosTransporteBrasilRiskAoAtualizarVeiculoNaCarga ?? false) &&
                        (carga.TipoOperacao?.IntegrarDadosTransporteBrasilRiskAoAtualizarVeiculoMotorista ?? false))
                        GerarIntegracaoBrasilRiskCargaVazia(carga, unitOfWork);

                    if (cargaPedidos == null)
                        cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo);

                    if (configuracaoVeiculo.NaoPermitirCadastrarVeiculoSemRastreador)
                        servicoSeguro.ValidarRastreadorVeiculoEValorSeguroApolice(carga, null, unitOfWork);

                    servicoVeiculo.ValidarDataANTT(veiculo, configuracaoVeiculo);

                    Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao();
                    RotaFrete.SetarRotaFreteCarga(carga, cargaPedidos, configuracaoTMS, unitOfWork, tipoServicoMultisoftware);

                    AdicionarFluxoGestaoPatio(carga, cargaJanelaCarregamento, unitOfWork, tipoServicoMultisoftware, validarDadosTransporteInformados: true);
                    servicoFluxoGestaoPatio.AtualizarEquipamento(carga);

                    serCargaDadosSumarizados.AlterarDadosSumarizadosCarga(ref carga, cargaPedidos, configuracaoEmbarcador, unitOfWork, tipoServicoMultisoftware);
                    AvancarEtapaGestaoDevolucao(carga, unitOfWork, auditado, cliente);
                    servicoCargaJanelaDescarregamento.AtualizarSituacao(carga, SituacaoCargaJanelaDescarregamentoCadastrada.Programado);

                    Servicos.Embarcador.Carga.MDFe serCargaMDFe = new Servicos.Embarcador.Carga.MDFe(unitOfWork);
                    List<Dominio.Entidades.Embarcador.Cargas.CargaMDFe> cargasMDFeEncerramento = carga.Veiculo != null && (!carga.TipoOperacao?.PermitirSolicitarNotasFiscaisSemEncerrarMDFeAnterior ?? false) ? serCargaMDFe.ObterCargasEncerramentoPorPlacaVeiculo(carga.Veiculo.Placa, unitOfWork) : new List<Dominio.Entidades.Embarcador.Cargas.CargaMDFe>();

                    Dominio.Entidades.Embarcador.Cargas.ColetaEntrega.EtapaVeiculoAlocado etapaVeiculoAlocado = repEtapaVeiculoAlocado.BuscarPorCarga(carga.Codigo);
                    if (etapaVeiculoAlocado != null)
                    {
                        Servicos.Embarcador.Carga.ColetaEntrega.FluxoColetaEntrega.ReplicarInformacoesAlocacao(carga, unitOfWork);
                        if (!etapaVeiculoAlocado.FluxoColetaEntrega.DataVeiculoAlocado.HasValue && etapaVeiculoAlocado.FluxoColetaEntrega.EtapaFluxoColetaEntregaEtapaAtual == Dominio.ObjetosDeValor.Embarcador.Enumeradores.EtapaFluxoColetaEntrega.VeiculoAlocado)
                        {
                            etapaVeiculoAlocado.DataInformada = DateTime.Now;
                            repEtapaVeiculoAlocado.Atualizar(etapaVeiculoAlocado);
                            Servicos.Embarcador.Carga.ColetaEntrega.FluxoColetaEntrega.SetarProximaEtapa(carga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.EtapaFluxoColetaEntrega.VeiculoAlocado, unitOfWork);
                        }
                    }

                    AtualizarAgendamentoColeta(carga, auditado, unitOfWork);

                    if (configuracaoVeiculo.CriarVinculoFrotaCargaForaDoPlanejamentoFrota)
                        AplicarAlteracaoCargaAoPlanejamentoFrota(carga, tipoServicoMultisoftware, cliente, webServiceConsultaCTe, unitOfWork);

                    if (empresaOrigem?.Codigo != carga.Empresa?.Codigo)
                        AdicionarMensagemAlertaCargaBloqueadaEnquantoNaoReceberDesbloqueioViaIntegracaoOuManual(carga, configuracaoGeralCarga, unitOfWork);


                    carga.SetChanges();

                    if (cargasMDFeEncerramento.Count > 0 && !carga.NaoGerarMDFe && (carga.Filial == null || !carga.Filial.EmitirMDFeManualmente) && (carga.TipoOperacao == null || !carga.TipoOperacao.NaoEmitirMDFe))
                    {
                        SolicitarEncerramentoMDFeAutomaticamente(cargasMDFeEncerramento[0].Carga, unitOfWork, tipoServicoMultisoftware, webServiceConsultaCTe, auditado, usuario);

                        string mensagemRetorno = "Aguarde o encerramento do(s) MDF-e(s) " + string.Join(", ", cargasMDFeEncerramento.Select(o => o.MDFe.Numero)) + " da carga " + cargasMDFeEncerramento[0].Carga.RetornarCodigoCargaParaVisualizacao + " para solicitar as notas fiscais";

                        retorno = new
                        {
                            LiberarSolicitacaoNF = false,
                            EncerrandoMDFe = true,
                            Mensagem = mensagemRetorno,
                            Placas = ObterPlacas(carga, configuracaoEmbarcador),
                            ValorFrete = carga.ValorFrete + carga.ValorICMS,
                            MDFe = (
                                from p in cargasMDFeEncerramento
                                where p.MDFe != null
                                select new
                                {
                                    p.Codigo,
                                    CodigoMDFE = p.MDFe.Codigo,
                                    CodigoEmpresa = p.MDFe.Empresa.Codigo,
                                    p.MDFe.Numero,
                                    MDFeAutorizado = p.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Autorizado ? true : false,
                                    Serie = p.MDFe.Serie.Numero,
                                    Emissao = p.MDFe.DataEmissao.Value.ToString("dd/MM/yyyy HH:mm"),
                                    UFCarga = p.MDFe.EstadoCarregamento.Sigla + " - " + p.MDFe.EstadoCarregamento.Nome,
                                    UFDesgarga = p.MDFe.EstadoDescarregamento.Sigla + " - " + p.MDFe.EstadoDescarregamento.Nome,
                                    Status = p.MDFe.DescricaoStatus,
                                    RetornoSefaz = p.MDFe.MensagemStatus != null ? p.MDFe.MensagemStatus.MensagemDoErro : p.MDFe.MensagemRetornoSefaz,
                                    PossuiInformacoesIMO = !string.IsNullOrEmpty(p.MDFe.Empresa?.IMO) || (p.MDFe.Empresa?.DataValidadeIMO.HasValue ?? false)

                                }
                            ).ToList()
                        };

                        serHubCarga.InformarCargaAtualizada(carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoAcaoCarga.Alterada, StringConexao);

                        if (!abriuTransacao)
                            unitOfWork.CommitChanges();
                    }
                    else
                    {
                        IntegrarAlteracaoOrdensEmbarque(carga, usuario, unitOfWork);

                        if (!abriuTransacao)
                            unitOfWork.CommitChanges();

                        bool liberarSolicitacaoNF = true;

                        //if (cargaControleExpedicao != null)
                        //{
                        //    if (carga.Veiculo.Placa.ToUpper() != cargaControleExpedicao.Placa.ToUpper() && !carga.VeiculosVinculados.Any(obj => obj.Placa.ToUpper() == cargaControleExpedicao.Placa.ToUpper()))
                        //        liberarSolicitacaoNF = false;
                        //}

                        retorno = new
                        {
                            LiberarSolicitacaoNF = liberarSolicitacaoNF,
                            EncerrandoMDFe = false,
                            Placas = ObterPlacas(carga, configuracaoEmbarcador),
                            ValorFrete = carga.ValorFreteAPagar,
                            Mensagem = string.Empty,

                        };
                        serHubCarga.InformarCargaAtualizada(carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoAcaoCarga.Alterada, StringConexao);
                    }

                    AtualizarIntegracaoSILEMP(repCargaDadosTransporteIntegracao, carga);

                    if (ModeloVeicularDiferenteDoSolicitado)
                        GerarAtendimentoPorGatilhoNaCarga(carga, TipoMotivoChamadoGatilhoNaCarga.AoSalvarPlacaComModeloVeicularDiferenteDoPrevisto, tipoServicoMultisoftware, unitOfWork, auditado);

                    if ((carga.ModeloVeicularCarga.Codigo) != codigoModeloVeicularOriginal)
                        ObterTipoTrechoDadosTransporte(carga, cargaPedidos, unitOfWork);

                    EnviarEmailNotificacaoAutomaticamenteTransportadorDaCarga(carga, unitOfWork, auditado);
                }

                CriarCargaOferta(unitOfWork, carga);

                return retorno;
            }
            catch (ServicoException excecao)
            {
                mensagemErro = excecao.Message;
                unitOfWork.Rollback();
                return null;
            }
        }

        public void CriarCargaOferta(UnitOfWork unitOfWork, Dominio.Entidades.Embarcador.Cargas.Carga carga)
        {
            Repositorio.Embarcador.Cargas.Ofertas.ParametrosOfertas repositorioParametrosOfertas = new(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new(unitOfWork);

            IList<Dominio.ObjetosDeValor.Embarcador.Carga.Ofertas.ParametrosOfertas> parametrosOferta = repositorioParametrosOfertas.BuscarPorCarga(carga);

            if (!parametrosOferta.Any())
                return;

            Repositorio.Embarcador.Cargas.CargaMotorista repositorioCargaMotorista = new(unitOfWork);
            int codigoCargaMotorista = repositorioCargaMotorista.BuscarPrimeiroCodigoPorCargaAsync(carga.Codigo).GetAwaiter().GetResult();
            if (carga.Empresa != null && (codigoCargaMotorista == 0) && carga.Veiculo == null)
            {
                Repositorio.Embarcador.Cargas.CargaOferta repositorioCargaOferta = new(unitOfWork);
                Dominio.Entidades.Embarcador.Cargas.CargaOferta cargaOfertaExistente = repositorioCargaOferta.BuscarPorCargaAsync(carga.Codigo).GetAwaiter().GetResult();

                if (cargaOfertaExistente == null && parametrosOferta.Count > 0)
                {
                    Dominio.ObjetosDeValor.Embarcador.Carga.Ofertas.ParametrosOfertas parametroOferta = new(carga.Empresa?.Codigo,
                                                                                                            carga.Filial?.Codigo,
                                                                                                            carga.TipoDeCarga?.Codigo,
                                                                                                            carga.TipoOperacao?.Codigo);

                    IList<Dominio.ObjetosDeValor.Embarcador.Carga.Ofertas.ParametrosOfertas> parametrosOrdenados = Utilidades.Object
                        .OrdenarEnumeravelPorCompatibilidade(parametroOferta, parametrosOferta)
                        .ToArray();

                    Dominio.ObjetosDeValor.Embarcador.Carga.Ofertas.ParametrosOfertas parametroMaisCompativel = parametrosOrdenados[0];
                    Dominio.Entidades.Embarcador.Cargas.Ofertas.ParametrosOfertas parametroOfertaEntidade = repositorioParametrosOfertas.BuscarPorCodigo(parametroMaisCompativel.Codigo, false);
                    Dominio.Entidades.Embarcador.Cargas.CargaOferta cargaOferta = new()
                    {
                        Carga = carga,
                        Situacao = SituacaoCargaOferta.PendenteDeOferta,
                        DataCriacao = DateTime.Now,
                        Data = null,
                        DataAceite = null,
                        SituacaoIntegracao = SituacaoIntegracao.AgIntegracao,
                        ParametrosOfertas = parametroOfertaEntidade,
                    };

                    carga.DadosSumarizados.RoteirizarNaEtapaDeDadosTransporte = true;

                    repositorioCarga.Atualizar(carga);
                    repositorioCargaOferta.Inserir(cargaOferta);
                }
            }
        }

        public async Task ExcluirDadosTransporteParaOfertaCanceladaAsync(Dominio.Entidades.Embarcador.Cargas.CargaOferta cargaOferta, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, CancellationToken cancellationToken)
        {
            if (cargaOferta.Situacao != SituacaoCargaOferta.Confirmada)
                return;

            string placas = cargaOferta.Carga.PlacasVeiculos ?? string.Empty;
            string motoristas = cargaOferta.Carga.NomeMotoristas ?? string.Empty;

            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new(_unitOfWork);
            await repositorioCarga.ExcluirDadosTransporteAsync(cargaOferta.Carga.Codigo, cancellationToken);

            List<Dominio.Entidades.Auditoria.HistoricoPropriedade> alteracoes = SalvarAlteraçõesCarga(placas, motoristas);
            await Servicos.Auditoria.Auditoria.AuditarAsync(auditado, cargaOferta.Carga, alteracoes, "Informações de transporte removidas via cancelamento da oferta da carga.", _unitOfWork, Dominio.ObjetosDeValor.Enumerador.AcaoBancoDados.Update, cancellationToken);

            RetornarEtapa(cargaOferta.Carga.Codigo, _unitOfWork, _tipoServicoMultisoftware, auditado, apenasRetornarEtapa: true);
        }

        private List<Dominio.Entidades.Auditoria.HistoricoPropriedade> SalvarAlteraçõesCarga(string placasParametro, string motoristasParametro)
        {
            string[] placas = placasParametro.Split(',');
            string[] motoristas = motoristasParametro.Split(',');
            List<Dominio.Entidades.Auditoria.HistoricoPropriedade> alteracoes = new List<Dominio.Entidades.Auditoria.HistoricoPropriedade>();

            if (placas != null)
            {
                foreach (string placa in placas)
                    alteracoes.Add(new Dominio.Entidades.Auditoria.HistoricoPropriedade("Placa", placa, ""));
            }

            if (motoristas != null)
            {
                foreach (string motorista in motoristas)
                    alteracoes.Add(new Dominio.Entidades.Auditoria.HistoricoPropriedade("Motorista", motorista, ""));
            }

            return alteracoes;
        }

        private static void AtualizarIntegracaoSILEMP(Repositorio.Embarcador.Cargas.CargaDadosTransporteIntegracao repCargaDadosTransporteIntegracao, Dominio.Entidades.Embarcador.Cargas.Carga carga)
        {
            if ((carga.TipoOperacao?.ConfiguracaoEMP?.AtivarIntegracaoComSIL ?? false) && repCargaDadosTransporteIntegracao.ExistePorCargaETipoIntegracao(carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.EMP))
            {
                Dominio.Entidades.Embarcador.Cargas.CargaDadosTransporteIntegracao cargaDadosTransporteIntegracao = repCargaDadosTransporteIntegracao.BuscarPorCargaETipoIntegracao(carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.EMP);

                if (cargaDadosTransporteIntegracao != null)
                {
                    cargaDadosTransporteIntegracao.SituacaoIntegracao = SituacaoIntegracao.AgIntegracao;
                    repCargaDadosTransporteIntegracao.Atualizar(cargaDadosTransporteIntegracao);
                }
            }
        }

        public void SolicitarNotasFiscais(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repositorioPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoApolice repositorioCarregamentoApolice = new Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoApolice(unitOfWork);

            if (IsCargaBloqueada(carga, unitOfWork))
                throw new ServicoException($"A {carga.DescricaoEntidade} está bloqueada e não permite alteração.");

            if (carga.TipoOperacao?.TipoOperacaoUtilizaContaRazao ?? false)
            {
                Repositorio.Embarcador.Cargas.CargaPedidoContaContabilContabilizacao repositorioCargaPedidoContaContabilContabilizacao = new Repositorio.Embarcador.Cargas.CargaPedidoContaContabilContabilizacao(unitOfWork);
                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosContaRazao = repositorioCargaPedido.BuscarPorCarga(carga.Codigo);

                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidosContaRazao)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedidoContaContabilContabilizacao contaContabil = repositorioCargaPedidoContaContabilContabilizacao.BuscarFirstOrDefaultPorCargaPedido(cargaPedido.Codigo);

                    if (contaContabil == null || contaContabil.PlanoConta == null)
                        throw new ServicoException("É necessário informar uma conta contábil.");
                }
            }

            if ((carga.Empresa == null || carga.Veiculo == null || carga.Motoristas == null || carga.Motoristas.Count == 0) && !carga.NaoExigeVeiculoParaEmissao)
                throw new ServicoException("Por favor, informe os dados de transporte antes de continuar!");

            Repositorio.Embarcador.Filiais.ConfiguracaoGestaoPatio repositorioConfiguracaoGestaoPatio = new Repositorio.Embarcador.Filiais.ConfiguracaoGestaoPatio(unitOfWork);
            Dominio.Entidades.Embarcador.Filiais.ConfiguracaoGestaoPatio configuracaoGestaoPatio = repositorioConfiguracaoGestaoPatio.BuscarConfiguracao();
            bool faturamentoPermiteSolicitarNotasFiscaisEtapaBloqueada = configuracaoGestaoPatio?.FaturamentoPermiteSolicitarNotasFiscaisEtapaBloqueada ?? false;

            GestaoPatio.FluxoGestaoPatio servicoFluxoGestaoPatio = new GestaoPatio.FluxoGestaoPatio(unitOfWork);
            Dominio.Entidades.Embarcador.GestaoPatio.FluxoGestaoPatio fluxoGestaoPatio = servicoFluxoGestaoPatio.ObterFluxoGestaoPatio(carga);

            if (((carga.TipoOperacao?.InserirDadosContabeisXCampoXTextCTe ?? false) || configuracaoEmbarcador.CentroResultadoPedidoObrigatorio) && carga.PossuiPendenciaConfiguracaoContabil)
                throw new ServicoException("Não é possível solicitar as notas fiscais para a carga pois não foram localizadas configurações contábeis compativeis com e mesma, por favor ajuste as configurações de centro de custo ou conta contábil e calcule o frete novamente para aplicar as novas configurações na carga.");

            if (!faturamentoPermiteSolicitarNotasFiscaisEtapaBloqueada && fluxoGestaoPatio != null && fluxoGestaoPatio.Etapas.Any(obj => obj.EtapaFluxoGestaoPatio == EtapaFluxoGestaoPatio.Faturamento) && !carga.EtapaFaturamentoLiberado)
                throw new ServicoException("Ainda não foi liberado o faturamento para esta carga.");

            if (carga.CargaAgrupamento != null || carga.CargaVinculada != null)
                throw new ServicoException("A carga foi agrupada, sendo assim não é possível alterá-la.");

            if (configuracaoEmbarcador.InformaApoliceSeguroMontagemCarga && carga.Carregamento != null && !repositorioCarregamentoApolice.ExistePorCarregamento(carga.Carregamento.Codigo))
            {
                Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repApoliceSeguro = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);
                List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao> listaApoliceSeguroAverbacao = repApoliceSeguro.BuscarPorCarga(carga.Codigo);

                if (listaApoliceSeguroAverbacao.Count == 0)
                    throw new ServicoException("Obrigatório informar apólice de seguro para seguir.");
            }

            //Repositorio.Embarcador.Cargas.ColetaEntrega.FluxoColetaEntrega repositorioFluxoColetaEntrega = new Repositorio.Embarcador.Cargas.ColetaEntrega.FluxoColetaEntrega(unitOfWork);
            //Dominio.Entidades.Embarcador.Cargas.ColetaEntrega.FluxoColetaEntrega fluxoColetaEntrega = repositorioFluxoColetaEntrega.BuscarPorCarga(carga.Codigo);

            //if (fluxoColetaEntrega != null && !carga.EtapaFaturamentoLiberado && !faturamentoPermiteSolicitarNotasFiscaisEtapaBloqueada)
            //    throw new ServicoException("Ainda não foi liberado o faturamento para esta carga.");

            //Repositorio.Embarcador.Cargas.CargaControleExpedicao repositorioCargaControleExpedicao = new Repositorio.Embarcador.Cargas.CargaControleExpedicao(unitOfWork);
            //Dominio.Entidades.Embarcador.Cargas.CargaControleExpedicao cargaControleExpedicao = repositorioCargaControleExpedicao.BuscarPorCarga(carga.Codigo);

            //if (!carga.CargaDePreCarga && cargaControleExpedicao != null && cargaControleExpedicao.SituacaoCargaControleExpedicao != SituacaoCargaControleExpedicao.Liberada)
            //    throw new ServicoException("É necessário que a expedição confirme a placa antes de liberar a viagem.");

            new Pedido.AlteracaoPedido(unitOfWork).ValidarAlteracaoPedidoPendenteAprovacao(carga);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = null;

            if (configuracaoEmbarcador.NaoPermiteEmitirCargaSemAverbacao && !(carga.TipoOperacao?.PermitirCargaSemAverbacao ?? false) && carga.TipoFreteEscolhido != TipoFreteEscolhido.Cliente)
            {
                Dominio.Entidades.Empresa empresa = carga.ObterEmpresaEmissora;

                if (!empresa.LiberarEmissaoSemAverbacao)
                {
                    if (!carga.DadosSumarizados.PossuiAverbacaoCTe)
                    {
                        cargaPedidos = repositorioCargaPedido.BuscarPorCarga(carga.Codigo, TipoPedido.Entrega);
                        Seguro.Seguro.SetarDadosSeguroCarga(carga, cargaPedidos, configuracaoEmbarcador, tipoServicoMultisoftware, unitOfWork);
                    }

                    if (!carga.DadosSumarizados.PossuiAverbacaoCTe)
                        throw new ServicoException("Não é possível solicitar as notas desta carga pois não existe uma averbação de CT-e configurada para o transportador.");
                }
            }

            if (carga.CalculandoFrete && !carga.IntegrandoValePedagio)
                throw new ServicoException("Não é possível soliciar as notas enquanto o frete estiver sendo calculado, por favor aguarde.");

            if (!carga.ExigeNotaFiscalParaCalcularFrete)
            {
                if (
                    carga.Rota == null && (
                        (carga.GrupoPessoaPrincipal != null && carga.GrupoPessoaPrincipal.ExigirRotaParaEmissaoDocumentos) ||
                        (configuracaoEmbarcador.ExigirRotaParaEmissaoDocumentos && Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota.IsComprarValePedagio(carga, unitOfWork) && !carga.Pedidos.Any(o => o.ValorPedagio > 0))
                    )
                )
                    throw new ServicoException("Obrigatório informar uma Rota para a Emissão dos Documentos.");
            }

            bool situacaoCargaPermiteSolicitarDocumentos = (
                (carga.SituacaoCarga == SituacaoCarga.AgTransportador) ||
                (
                    (carga.SituacaoCarga == SituacaoCarga.CalculoFrete) &&
                    (carga.PossuiPendencia == false) &&
                    (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                ) ||
                (carga.ExigeNotaFiscalParaCalcularFrete && carga.SituacaoCarga == SituacaoCarga.Nova)
            );

            if (!situacaoCargaPermiteSolicitarDocumentos)
                throw new ServicoException($"Não é possível solicitar os documentos na situação atual da carga ({carga.DescricaoSituacaoCarga})");

            bool valorFreteObrigatorio = (
                (carga.TipoOperacao?.ExigirValorFreteAvancarCarga ?? false) ||
                (
                    (carga.TipoFreteEscolhido != TipoFreteEscolhido.Cliente) &&
                    (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                )
            );

            if ((carga.ValorFreteAPagar <= 0) && valorFreteObrigatorio)
                throw new ServicoException("Não é possível solicitar as notas para uma carga sem valor de frete, por favor, verifique!");

            if (cargaPedidos == null)
                cargaPedidos = repositorioCargaPedido.BuscarPorCarga(carga.Codigo, TipoPedido.Entrega);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
            {
                if (cargaPedido.SituacaoEmissao != SituacaoNF.NFEnviada)
                {
                    cargaPedido.SituacaoEmissao = SituacaoNF.AgEnvioNF;
                    repositorioCargaPedido.Atualizar(cargaPedido);
                }
                else if (!carga.DataEnvioUltimaNFe.HasValue && carga.ExigeNotaFiscalParaCalcularFrete)
                    throw new ServicoException("Não é possível solicitar as NFEs, pois, notas fiscais já foram enviadas para essa carga.");

                if (cargaPedido.PossuiNFS)
                {
                    Dominio.Entidades.Cliente tomador = cargaPedido.ObterTomador();
                    NFSe.NFSe servicoNFSe = new NFSe.NFSe(unitOfWork);
                    Dominio.Entidades.Embarcador.Transportadores.TransportadorConfiguracaoNFSe configNFSe = servicoNFSe.BuscarConfiguracaoEmissaoNFSe(carga.Empresa?.Codigo ?? 0, cargaPedido.Destino.Codigo, tomador?.Localidade?.Estado?.Sigla ?? "", tomador?.GrupoPessoas?.Codigo ?? 0, tomador?.Localidade?.Codigo ?? 0, carga.TipoOperacao?.Codigo ?? 0, tomador?.CPF_CNPJ ?? 0, 0, unitOfWork);

                    if (configNFSe == null)
                        throw new ServicoException($"O transportado informado não está apto a emitir notas fiscais de serviço em {cargaPedido.Destino.DescricaoCidadeEstado}.");
                }
            }

            if (new PreCarga.PreCarga(unitOfWork).IsAlteracoesDadosPreCargaSemConfirmacao(carga))
                throw new ServicoException("Não é possível solicitar as NF-e sem confirmar as alterações dos dados da pré carga.");

            if (IsCargaComPedidosSemProdutos(carga, unitOfWork))
                throw new ServicoException("Não é possível solicitar as NF-e sem adicionar pelo menos um produto na carga.");

            if (IsCargaComClienteSemLocalidade(carga, unitOfWork))
                throw new ServicoException("Não é possível solicitar as NF-e, carga possui cliente sem localidade.");

            if (!carga.DataCarregamentoCarga.HasValue && !configuracaoEmbarcador.PermitirInformarDatasCarregamentoCarga)
            {
                carga.DataCarregamentoCarga = DateTime.Now;

                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargapedido in cargaPedidos)
                {
                    cargapedido.Pedido.DataCarregamentoPedido = carga.DataCarregamentoCarga;
                    repositorioPedido.Atualizar(cargapedido.Pedido);
                }
            }

            if ((tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador || tipoServicoMultisoftware == TipoServicoMultisoftware.MultiCTe) && !carga.NaoGerarMDFe && (carga.Veiculo != null) && (!carga.TipoOperacao?.PermitirSolicitarNotasFiscaisSemEncerrarMDFeAnterior ?? false))
            {
                Repositorio.Embarcador.Cargas.CargaMDFe repositorioCargaMDFe = new Repositorio.Embarcador.Cargas.CargaMDFe(unitOfWork);
                List<Dominio.Entidades.Embarcador.Cargas.CargaMDFe> cargasMDFe = repositorioCargaMDFe.BuscarPorCargaVeiculosMDFeNaoEncerrados(carga.Veiculo.Placa);

                foreach (Dominio.Entidades.Embarcador.Cargas.CargaMDFe cargaMDFe in cargasMDFe)
                {
                    if (cargaMDFe.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Autorizado)
                        throw new ServicoException("Não é possível solicitar as notas fiscais pois o veículo está alocado em uma carga em que o MDF-e ainda não foi encerrado (carga: " + cargaMDFe.Carga.RetornarCodigoCargaParaVisualizacao.ToString() + ").");

                    throw new ServicoException("Aguarde o MDF-e ser encerrado para solicitar as notas fiscais desta carga.");
                }
            }

            bool cteEmitidoNoEmbarcador = repositorioCargaPedido.ExisteCTeEmitidoNoEmbarcador(carga.Codigo);
            bool rotaFreteNaoRoteirizada = configuracaoEmbarcador.ExigirRotaRoteirizadaNaCarga && (carga.Rota == null || carga.Rota.SituacaoDaRoteirizacao != SituacaoRoteirizacao.Concluido);
            bool cargaRotaNaoRoteirizada = (configuracaoEmbarcador.ExigirCargaRoteirizada || (carga.TipoOperacao?.ExigirCargaRoteirizada ?? false)) && (carga.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Aguardando || carga.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Erro);
            bool naoExigeRoteirizacao = carga.TipoOperacao?.NaoExigeRotaRoteirizada ?? false;

            if (!cteEmitidoNoEmbarcador && !naoExigeRoteirizacao)
            {
                if (rotaFreteNaoRoteirizada)
                    throw new ServicoException("Necessário que a rota frete esteja roteirizada, favor verificar o cadastro da rota.");

                if (cargaRotaNaoRoteirizada)
                    throw new ServicoException("Necessário que a carga esteja roteirizada, favor aguardar ou solicitar para reprocessar caso esteja com erro.");
            }

            if (carga.SituacaoRoteirizacaoCarga != SituacaoRoteirizacao.Aguardando && !carga.CalculandoFrete)
                carga.SituacaoCarga = SituacaoCarga.AgNFe;

            carga.problemaAverbacaoCTe = false;
            carga.DataInicioGeracaoCTes = DateTime.Now;

            repositorioCarga.Atualizar(carga);

            if (!carga.ExigeNotaFiscalParaCalcularFrete)
                Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota.ValidarCompraValePedagioComIntegracaoValorPedagioEmbarcador(carga, unitOfWork, StringConexao, configuracaoEmbarcador, tipoServicoMultisoftware);

            if ((carga.Rota != null && (carga.Rota.SituacaoDaRoteirizacao == SituacaoRoteirizacao.Erro || carga.Rota.SituacaoDaRoteirizacao == SituacaoRoteirizacao.SemDefinicao) &&
                !configuracaoEmbarcador.CadastrarRotaAutomaticamente && !configuracaoEmbarcador.ExigirRotaRoteirizadaNaCarga) || !carga.ExigeNotaFiscalParaCalcularFrete)
                Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota.CriarCargaValePedagioPorRotaFrete(carga, cargaPedidos, configuracaoEmbarcador, unitOfWork, tipoServicoMultisoftware);

            if (carga.Carregamento != null)
            {
                Repositorio.Embarcador.Cargas.MontagemCarga.Carregamento repositorioCarregamento = new Repositorio.Embarcador.Cargas.MontagemCarga.Carregamento(unitOfWork);
                carga.Carregamento.SituacaoCarregamento = SituacaoCarregamento.Fechado;
                repositorioCarregamento.Atualizar(carga.Carregamento);
            }

            CargaLocaisPrestacao servicoCargaLocaisPrestacao = new CargaLocaisPrestacao(unitOfWork);

            if (!carga.NaoGerarMDFe && !carga.NaoExigeVeiculoParaEmissao && !servicoCargaLocaisPrestacao.ValidarPassagensMDFe(carga, unitOfWork) && (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador || tipoServicoMultisoftware == TipoServicoMultisoftware.MultiCTe))
                throw new ServicoException("Antes de solicitar as Notas Fiscais é necessário configurar o percurso válido para gerar o(s) MDF-e(s).", errorCode: CodigoExcecao.PercursoNaoConfigurado);

            Auditoria.Auditoria.Auditar(auditado, carga, null, "Solicitou Notas Fiscais", unitOfWork);

            string retornoCIOT = Servicos.Embarcador.CIOT.CIOT.ObterCIOTCarga(carga, configuracaoEmbarcador, tipoServicoMultisoftware, unitOfWork);

            if (!string.IsNullOrWhiteSpace(retornoCIOT))
                throw new ServicoException(retornoCIOT);

            CargaIntegracao.AdicionarIntegracoesEtapaNFe(carga, configuracaoEmbarcador, tipoServicoMultisoftware, unitOfWork);
        }

        public void NotificarRemetentesPorEmailAoSolicitarNotasFiscais(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Email.ConfigEmailDocTransporte repositorioConfigEmailDocTransporte = new Repositorio.Embarcador.Email.ConfigEmailDocTransporte(unitOfWork);
            Dominio.Entidades.Embarcador.Email.ConfigEmailDocTransporte configuracaoEmail = repositorioConfigEmailDocTransporte.BuscarEmailEnviaDocumentoAtivo(0);

            if (configuracaoEmail == null)
            {
                Servicos.Log.TratarErro("Não há um e-mail configurado.", "EnviarEmailRemetente");
                return;
            }

            try
            {
                List<Dominio.Entidades.Cliente> remetentes = (from obj in carga.Pedidos select obj.Pedido.Remetente).ToList();

                foreach (Dominio.Entidades.Cliente cliente in remetentes)
                {
                    if (cliente.Email == null)
                    {
                        Servicos.Log.TratarErro("Cliente " + cliente.CPF_CNPJ_SemFormato + " sem e-mail configurado.", "EnviarEmailRemetente");
                        continue;
                    }

                    string mensagemErro = "Erro ao enviar e-mail";
                    string assunto = "Nova notificação de " + carga.Filial?.Descricao + " - Carga " + carga.CodigoCargaEmbarcador + " - Data Embarque: " + (carga.DataCarregamentoCarga.HasValue ? carga.DataCarregamentoCarga.Value.ToString("dd/MM/yyyy") : carga.DataCriacaoCarga.ToString("dd/MM/yyyy"));

                    if (carga.Empresa?.TipoAmbiente == Dominio.Enumeradores.TipoAmbiente.Homologacao)
                        assunto = string.Concat("TESTE - " + assunto);

                    string mensagemEmail = string.Empty;

                    mensagemEmail = @"

                                        Carga: " + carga.CodigoCargaEmbarcador + @"
                                        Filial: " + carga.Filial?.Descricao + @"
                                        Pecuarista: " + carga.DadosSumarizados.Remetentes + @"
                                        Data Carregamento: " + (carga.DataCarregamentoCarga.HasValue ? carga.DataCarregamentoCarga.Value.ToString("dd/MM/yyyy") : string.Empty) + @"
                                        Distancia: " + (carga.Distancia > 0 ? carga.Distancia.ToString("n2") : carga.DadosSumarizados.Distancia.ToString("n2")) + @"
                                        Operação: " + carga.TipoOperacao?.Descricao + @"
                                        Tipo de Carga: " + carga.TipoDeCarga?.Descricao + @"
                                        Modelo Veicular: " + carga.ModeloVeicularCarga?.Descricao + @"
                                        Operador: " + carga.Operador?.Nome + @"
                                        Transportador: " + carga.Empresa?.Descricao + @"
                                        Placa(s): " + carga.DadosSumarizados.Veiculos + @"
                                        Motorista: " + carga.DadosSumarizados.Motoristas + @"


                                            *** E-mail enviado automaticamente. Por favor, não responder ***";

                    List<string> emails = new List<string>();

                    if (!string.IsNullOrWhiteSpace(cliente.Email))
                        emails.AddRange(cliente.Email.Split(';').ToList());

                    foreach (Dominio.Entidades.Embarcador.Pessoas.ClienteOutroEmail outroEmail in cliente.Emails)
                    {
                        if (!string.IsNullOrWhiteSpace(outroEmail.Email) && outroEmail.EmailStatus == "A")
                            emails.Add(outroEmail.Email);
                    }

                    emails = emails.Distinct().ToList();

                    if (emails.Count > 0)
                    {
                        List<System.Net.Mail.Attachment> attachments = new List<System.Net.Mail.Attachment>();
                        bool sucesso = Servicos.Email.EnviarEmail(configuracaoEmail.Email, configuracaoEmail.Email, configuracaoEmail.Senha, null, emails.ToArray(), null, assunto, mensagemEmail, configuracaoEmail.Smtp, out mensagemErro, configuracaoEmail.DisplayEmail, attachments, "", configuracaoEmail.RequerAutenticacaoSmtp, "", configuracaoEmail.PortaSmtp, unitOfWork);

                        if (!sucesso)
                            Servicos.Log.TratarErro($"Problemas ao enviar o cte para o tomador do CT-e por e-mail: {mensagemErro}", "EnviarEmailRemetente");
                    }
                }
            }
            catch (Exception excecao)
            {
                Servicos.Log.TratarErro(excecao);
            }
        }

        public dynamic SalvarValorFreteManual(Dominio.Entidades.Usuario usuario, Dominio.Entidades.Embarcador.Operacional.OperadorLogistica operadorLogistica, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, int codigoCarga, decimal valorFrete, Repositorio.UnitOfWork unitOfWork, bool freteFilialEmissora = false)
        {
            bool transacaoExternaAtiva = unitOfWork.IsActiveTransaction();

            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Frete.TabelaFrete repTabelaFrete = new Repositorio.Embarcador.Frete.TabelaFrete(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configEmbarcador = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao(); ;
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoPedido configuracaoPedido = new Repositorio.Embarcador.Configuracoes.ConfiguracaoPedido(unitOfWork).BuscarConfiguracaoPadrao();

            Servicos.Embarcador.Carga.CargaDadosSumarizados serCargaDadosSumarizados = new CargaDadosSumarizados(unitOfWork);
            Servicos.Embarcador.Carga.Frete serCargaFrete = new Servicos.Embarcador.Carga.Frete(unitOfWork, tipoServicoMultisoftware);
            Servicos.Embarcador.Carga.FreteSubcontratacaoTerceiro serFreteSubcontratacaoTerceiro = new Servicos.Embarcador.Carga.FreteSubcontratacaoTerceiro(unitOfWork);
            Servicos.Embarcador.Carga.CargaAprovacaoFrete servicoCargaAprovacaoFrete = new Servicos.Embarcador.Carga.CargaAprovacaoFrete(unitOfWork, configEmbarcador);
            Servicos.Embarcador.Logistica.CargaJanelaCarregamento servicoCargaJanelaCarregamento = new Servicos.Embarcador.Logistica.CargaJanelaCarregamento(unitOfWork, configEmbarcador);
            Servicos.Embarcador.Frete.ContratoFreteCliente.ContratoFreteCliente servicoContratoFreteCliente = new Servicos.Embarcador.Frete.ContratoFreteCliente.ContratoFreteCliente(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigo(codigoCarga);
            string mensagem = null;

            unitOfWork.Start();

            repCargaPedido.SetarPedidoEncaixeParaNulo(carga.Codigo);
            repCargaPedido.ZerarValorFreteNegociado(carga.Codigo);

            Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);
            string retornoVerificarOperador = serCarga.VerificarOperadorPodeConfigurarCarga(usuario, carga, tipoServicoMultisoftware);

            if (!string.IsNullOrWhiteSpace(retornoVerificarOperador))
            {
                mensagem = retornoVerificarOperador;
                unitOfWork.Rollback();
                return mensagem;
            }

            if (carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete &&
                carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgTransportador)
            {
                mensagem = "Não é possível recalcular o frete na atual situação da carga (" + carga.DescricaoSituacaoCarga + ").";
                unitOfWork.Rollback();
                return mensagem;
            }

            if (servicoCargaAprovacaoFrete.IsUtilizarAlcadaAprovacaoAlteracaoValorFrete() && (carga.SituacaoAlteracaoFreteCarga == SituacaoAlteracaoFreteCarga.Aprovada))
            {
                mensagem = "O valor de frete está aprovado e não pode mais ser alterado.";
                unitOfWork.Rollback();
                return mensagem;
            }

            if (!carga.ExigeNotaFiscalParaCalcularFrete && RecebeuNumeroCargaEmbarcador(carga, unitOfWork))
            {
                mensagem = "A carga já recebeu o número de carga do Embarcador e não permite mais recalcular o frete.";
                unitOfWork.Rollback();
                return mensagem;
            }

            if ((carga.ValorFreteTabelaFrete <= valorFrete) && !configEmbarcador.PermitirOperadorInformarValorFreteMaiorQueTabela)
            {
                mensagem = "O valor do frete deve ser inferior ao estipulado pela tabela (" + carga.ValorFreteTabelaFrete.ToString("n2") + ").";
                unitOfWork.Rollback();
                return mensagem;
            }

            if (!servicoContratoFreteCliente.ValidaNovoFreteComSaldo(carga, valorFrete, out string erro))
            {
                mensagem = erro;
                unitOfWork.Rollback();
                return mensagem;
            }

            Servicos.Embarcador.Carga.Frete serFrete = new Servicos.Embarcador.Carga.Frete(unitOfWork, tipoServicoMultisoftware);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo);

            if (PermiteInformarFreteManualmenteNaSituacaoAtual(carga) && carga.PossuiPendencia && (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS || configEmbarcador.PermitirOperadorInformarValorFreteMaiorQueTabela))
            {
                Repositorio.Embarcador.Cargas.CargaPercurso repCargaPercurso = new Repositorio.Embarcador.Cargas.CargaPercurso(unitOfWork);
                Servicos.Embarcador.Carga.Rota serCargaRota = new Servicos.Embarcador.Carga.Rota(unitOfWork);

                Dominio.ObjetosDeValor.Embarcador.Carga.RetornoRotasCarga dynRota = null;

                if (repCargaPercurso.ConsultarPorCarga(carga.Codigo).Count <= 0)
                {
                    dynRota = serCargaRota.CriarRota(carga, tipoServicoMultisoftware, unitOfWork, configuracaoPedido);
                    serCargaDadosSumarizados.AlterarDadosSumarizadosCarga(ref carga, cargaPedidos, configEmbarcador, unitOfWork, tipoServicoMultisoftware);
                }
                else
                {
                    dynRota = new Dominio.ObjetosDeValor.Embarcador.Carga.RetornoRotasCarga();
                    dynRota.situacao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoRetornoRotas.Valida;
                }

                Servicos.Embarcador.Carga.ComposicaoFrete.ComposicaoFrete.ExcluirComposicoesFreteValor(carga, unitOfWork);
                if (dynRota.situacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoRetornoRotas.Valida)
                {
                    if (carga.TabelaFrete == null || configEmbarcador.IncluirICMSFreteInformadoManualmente)
                    {
                        foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
                        {
                            if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador && !configEmbarcador.IncluirICMSFreteInformadoManualmente)
                            {
                                cargaPedido.IncluirICMSBaseCalculo = false;
                                cargaPedido.PercentualIncluirBaseCalculo = 0;
                            }
                            else
                            {
                                cargaPedido.IncluirICMSBaseCalculo = true;
                                cargaPedido.PercentualIncluirBaseCalculo = 100;
                            }

                            if (cargaPedido.CargaPedidoFilialEmissora)
                            {
                                cargaPedido.IncluirICMSBaseCalculoFilialEmissora = true;
                                cargaPedido.PercentualIncluirBaseCalculoFilialEmissora = 100;
                            }
                        }
                    }

                    decimal valorFreteAnterior = carga.ValorFrete;
                    carga.TipoFreteEscolhido = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Operador;
                    carga.ValorFrete = valorFrete;
                    Servicos.Embarcador.Carga.RateioFrete serRateioFrete = new Servicos.Embarcador.Carga.RateioFrete(unitOfWork);
                    serRateioFrete.RatearValorDoFrenteEntrePedidos(carga, cargaPedidos, configEmbarcador, false, unitOfWork, tipoServicoMultisoftware);

                    Dominio.ObjetosDeValor.Embarcador.Frete.ComposicaoFrete composicao = (Servicos.Embarcador.Frete.ComposicaoFrete.ObterComposicaoFrete("Valor Informado Pelo Operador", " Valor Informado = " + valorFrete.ToString("n2"), valorFrete, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoParametroBaseTabelaFrete.ValorFreteLiquido, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoCampoValorTabelaFrete.ValorFixo, "Valor informado pelo Operador", 0, valorFrete));
                    Servicos.Embarcador.Carga.ComposicaoFrete.ComposicaoFrete.SetarComposicaoFrete(carga, null, null, null, false, composicao, unitOfWork, null);

                    if (carga.EmpresaFilialEmissora != null || carga.CalcularFreteCliente)
                    {
                        Dominio.ObjetosDeValor.Embarcador.Frete.RetornoDadosFrete retornoFrete = Servicos.Embarcador.Carga.FreteFilialEmissora.CalcularFreteFilialEmissora(carga, false, false, true, unitOfWork, tipoServicoMultisoftware, configEmbarcador, configuracaoPedido);

                        if (configEmbarcador.NotificarAlteracaoCargaAoOperador && (retornoFrete.situacao == SituacaoRetornoDadosFrete.ProblemaCalcularFrete))
                            NotificarAlteracaoAoOperador(carga, string.Format(Localization.Resources.Cargas.Carga.NaoFoiPossivelCalcularFreteCarga, carga.CodigoCargaEmbarcador), unitOfWork);
                    }
                    else if (carga.TipoOperacao != null && carga.TipoOperacao.EmiteCTeFilialEmissora && carga.Filial != null && carga.Filial.EmpresaEmissora != null)
                    {
                        Servicos.Embarcador.Carga.FreteFilialEmissora.SetarValorFreteFilialTrechoAnterior(ref carga, false, tipoServicoMultisoftware, unitOfWork, configEmbarcador);
                    }

                    Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga repositorioConfiguracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork);

                    bool existeConfirmacaoEtapaFreteNoFluxoNotaAposFretePorTipoOperacao = repositorioConfiguracaoGeralCarga.ExisteConfirmacaoEtapaFreteNoFluxoNotaAposFretePorTipoOperacao() && (carga.TipoOperacao?.ExigeConformacaoFreteAntesEmissao ?? false);

                    if (!carga.ExigeNotaFiscalParaCalcularFrete && !existeConfirmacaoEtapaFreteNoFluxoNotaAposFretePorTipoOperacao)
                        carga.SituacaoCarga = SituacaoCarga.AgTransportador;

                    if (valorFreteAnterior != valorFrete)
                        AtualizarSituacaoJanelaCarregamento(carga, usuario, configEmbarcador, unitOfWork);

                    carga.PossuiPendencia = false;
                    carga.MotivoPendencia = "";
                }
                else
                {
                    unitOfWork.Rollback();
                    mensagem = "Não foi possível encotrar a rota para calcular o frete.";
                    return null;
                }
            }
            else
            {
                carga.TipoFreteEscolhido = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Operador;
                carga = serFrete.RecalcularFrete(carga, cargaPedidos, configEmbarcador, tipoServicoMultisoftware, valorFrete, unitOfWork, configuracaoPedido, freteFilialEmissora);
                Dominio.ObjetosDeValor.Embarcador.Frete.ComposicaoFrete composicao = (Servicos.Embarcador.Frete.ComposicaoFrete.ObterComposicaoFrete("Valor Informado Pelo Operador", " Valor Informado = " + valorFrete.ToString("n2"), valorFrete, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoParametroBaseTabelaFrete.ValorFreteLiquido, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoCampoValorTabelaFrete.ValorFixo, "Valor informado pelo Operador", 0, valorFrete));
                Servicos.Embarcador.Carga.ComposicaoFrete.ComposicaoFrete.SetarComposicaoFrete(carga, null, null, null, freteFilialEmissora, composicao, unitOfWork, null);
            }

            carga.ValorFreteOperador = carga.ValorFrete;

            if (freteFilialEmissora)
                carga.ValorFreteOperador = carga.ValorFreteFilialEmissora + carga.ValorFrete;

            serFreteSubcontratacaoTerceiro.CalcularFreteSubcontratacao(carga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Operador, unitOfWork, false, tipoServicoMultisoftware, StringConexao);

            new Servicos.Embarcador.Carga.CargaOperador(unitOfWork, configEmbarcador).Atualizar(carga, usuario, tipoServicoMultisoftware);

            repCarga.Atualizar(carga);

            servicoCargaJanelaCarregamento.AtualizarSituacao(carga, tipoServicoMultisoftware);
            servicoCargaAprovacaoFrete.CriarAprovacao(carga, TipoRegraAutorizacaoCarga.InformadoManualmente, tipoServicoMultisoftware, valorFrete);

            if (!carga.ObrigatorioInformarValorFreteOperador)
            {
                serFrete.ProcessarRegraInclusaoICMSComponenteFrete(carga, cargaPedidos, configEmbarcador, unitOfWork);
                serFrete.CalcularValorFreteComICMSIncluso(carga, unitOfWork);
            }

            if (!transacaoExternaAtiva)
                unitOfWork.CommitChanges();

            return mensagem;
        }

        public bool PermiteInformarFreteManualmenteNaSituacaoAtual(Dominio.Entidades.Embarcador.Cargas.Carga carga)
        {
            return carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete || (!carga.ExigeNotaFiscalParaCalcularFrete && carga.SituacaoCarga == SituacaoCarga.AgTransportador);
        }

        public void ValidarDadosFaltantesNoVeiculo(Dominio.Entidades.Veiculo veiculo, Dominio.Entidades.Empresa empresa, Repositorio.UnitOfWork unitOfWork)
        {
            //(Rodrigo Romanovski) Cesar quem pediu para criar essa regra no dia 20/06/2016, segundo ele o processo não pode parar por falta desses dados no veiculo, por isso setamos um padrão qualquer.

            Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unitOfWork);

            bool alterarVeiculo = false;

            if (veiculo.Tara == 0)
            {
                veiculo.Tara = 10000;
                alterarVeiculo = true;
            }

            if (veiculo.CapacidadeKG == 0)
            {
                veiculo.CapacidadeKG = 10000;
                alterarVeiculo = true;
            }

            if (veiculo.Tipo == "T" && veiculo.RNTRC == 0)
            {
                veiculo.RNTRC = !string.IsNullOrWhiteSpace(empresa.RegistroANTT) ? int.Parse(empresa.RegistroANTT) : 12345678;
                alterarVeiculo = true;
            }

            if (alterarVeiculo)
                repVeiculo.Atualizar(veiculo);

            if (veiculo.VeiculosVinculados != null && veiculo.VeiculosVinculados.Count > 0)
            {
                foreach (Dominio.Entidades.Veiculo veiculoVinculado in veiculo.VeiculosVinculados)
                    ValidarDadosFaltantesNoVeiculo(veiculoVinculado, empresa, unitOfWork);
            }
        }

        public void CancelarAgendamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, TipoServicoMultisoftware tipoServicoMultisoftware, UnitOfWork unitOfWork, bool apenasAtualizarPedido = false)
        {
            Repositorio.Embarcador.Logistica.AgendamentoColeta repAgendamentoColeta = new Repositorio.Embarcador.Logistica.AgendamentoColeta(unitOfWork);
            Servicos.Embarcador.Logistica.AgendamentoColeta servicoAgendamento = new Servicos.Embarcador.Logistica.AgendamentoColeta(unitOfWork);

            Dominio.Entidades.Embarcador.Logistica.AgendamentoColeta agendamentoColeta = repAgendamentoColeta.BuscarAgendamentoPorCarga(carga.Codigo);

            if (agendamentoColeta != null)
            {
                List<SituacaoAgendamentoColeta> situacaoAgendamentoColetaPermitidasCancelar = new List<SituacaoAgendamentoColeta>() { SituacaoAgendamentoColeta.Agendado, SituacaoAgendamentoColeta.AguardandoConfirmacao, SituacaoAgendamentoColeta.AguardandoCTes, SituacaoAgendamentoColeta.AguardandoGeracaoSenha };
                if (situacaoAgendamentoColetaPermitidasCancelar.Contains(agendamentoColeta.Situacao ?? SituacaoAgendamentoColeta.Agendado))
                    agendamentoColeta.Situacao = tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador ? SituacaoAgendamentoColeta.CanceladoEmbarcador : SituacaoAgendamentoColeta.Cancelado;
                repAgendamentoColeta.Atualizar(agendamentoColeta);
                servicoAgendamento.SubtrairSaldoVolumesPendentesPedidos(agendamentoColeta, unitOfWork, true, apenasAtualizarPedido);
            }
        }

        public void CancelarAgendamentoPallet(Dominio.Entidades.Embarcador.Cargas.Carga carga, UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.GestaoPallet.AgendamentoPallet repositorioAgendamentoPallet = new Repositorio.Embarcador.GestaoPallet.AgendamentoPallet(unitOfWork);

            Dominio.Entidades.Embarcador.GestaoPallet.AgendamentoPallet agendamentoPallet = repositorioAgendamentoPallet.BuscarPorCarga(carga.Codigo);

            if (agendamentoPallet == null)
                return;

            List<SituacaoAgendamentoPallet> situacaoAgendamentoPalletPermitidasCancelar = new List<SituacaoAgendamentoPallet>() { SituacaoAgendamentoPallet.Agendamento, SituacaoAgendamentoPallet.Acompanhamento };

            if (situacaoAgendamentoPalletPermitidasCancelar.Contains(agendamentoPallet.Situacao ?? SituacaoAgendamentoPallet.Agendamento))
            {
                agendamentoPallet.EtapaAgendamentoPallet = EtapaAgendamentoPallet.Acompanhamento;
                agendamentoPallet.Situacao = SituacaoAgendamentoPallet.Cancelado;
                agendamentoPallet.DataCancelamento = DateTime.Now;
            }

            repositorioAgendamentoPallet.Atualizar(agendamentoPallet);
        }

        public void CancelarConsolidacao(Dominio.Entidades.Embarcador.Cargas.Carga carga, TipoServicoMultisoftware tipoServicoMultisoftware, UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Logistica.ConsolidacaoSolicitacaoAbastecimentoGas repositorioConsolidacao = new Repositorio.Embarcador.Logistica.ConsolidacaoSolicitacaoAbastecimentoGas(unitOfWork);
            Dominio.Entidades.Embarcador.Logistica.ConsolidacaoSolicitacaoAbastecimentoGas consolidacao = repositorioConsolidacao.BuscarConsolidacaoPorCarga(carga.Codigo);

            if (consolidacao?.SolicitacaoAbastecimentoGas != null)
            {
                Repositorio.Embarcador.Logistica.SolicitacaoAbastecimentoGas repositorioSolicitacao = new Repositorio.Embarcador.Logistica.SolicitacaoAbastecimentoGas(unitOfWork);
                consolidacao.SolicitacaoAbastecimentoGas.VolumeRodoviarioCarregamentoProximoDia += consolidacao.QuantidadeCarga;
                repositorioSolicitacao.Atualizar(consolidacao.SolicitacaoAbastecimentoGas);

                Dominio.Entidades.Embarcador.Logistica.SolicitacaoAbastecimentoGas solicitacoesDescontarVolume = repositorioSolicitacao.BuscarSolicitacaoComDisponibilidadeTransferenciaPorDataDeMedicao(consolidacao.SolicitacaoAbastecimentoGas.DataMedicao);

                if (solicitacoesDescontarVolume != null)
                {
                    solicitacoesDescontarVolume.SaldoRestante += consolidacao.QuantidadeCarga;
                    repositorioSolicitacao.Atualizar(solicitacoesDescontarVolume);
                }
            }
        }

        public void IniciaViagemVeiculo(int codigoVeiculo, Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado)
        {
            try
            {
                Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unitOfWork);
                Repositorio.Embarcador.Veiculos.SituacaoVeiculo repSituacaoVeiculo = new Repositorio.Embarcador.Veiculos.SituacaoVeiculo(unitOfWork);

                Dominio.Entidades.Veiculo veiculo = repVeiculo.BuscarPorCodigo(codigoVeiculo);
                if (veiculo.SituacaoVeiculo != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoVeiculo.EmViagem)
                {
                    veiculo.SituacaoVeiculo = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoVeiculo.EmViagem;
                    veiculo.DataHoraPrevisaoDisponivel = carga.DataPrevisaoTerminoCarga;
                    veiculo.LocalidadeAtual = carga.LocaisPrestacao != null && carga.LocaisPrestacao.Count > 0 ? carga.LocaisPrestacao.Select(o => o.LocalidadeTerminoPrestacao).LastOrDefault() : null;
                    veiculo.VeiculoVazio = false;

                    repVeiculo.Atualizar(veiculo);

                    Dominio.Entidades.Embarcador.Veiculos.SituacaoVeiculo situacao = new Dominio.Entidades.Embarcador.Veiculos.SituacaoVeiculo();
                    situacao.DataHoraEmissao = DateTime.Now;
                    situacao.DataHoraSituacao = carga.DataFinalizacaoEmissao;
                    situacao.Veiculo = veiculo;
                    situacao.Localidade = veiculo.LocalidadeAtual;
                    situacao.Motorista = carga.Motoristas != null && carga.Motoristas.Count > 0 ? carga.Motoristas.Select(o => o).FirstOrDefault() : null;
                    situacao.DataHoraSaidaInicioViagem = DateTime.Now;
                    situacao.DataHoraPrevisaoRetornoInicioViagem = carga.DataPrevisaoTerminoCarga;
                    situacao.LocalidadeDestinoInicioViagem = veiculo.LocalidadeAtual;

                    situacao.Situacao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoVeiculo.EmViagem;

                    repSituacaoVeiculo.Inserir(situacao);

                    if (Auditado != null)
                    {
                        Servicos.Auditoria.Auditoria.Auditar(Auditado, situacao, null, "Inicio de Viagem Carga " + carga.Codigo, unitOfWork);
                        Servicos.Auditoria.Auditoria.Auditar(Auditado, veiculo, null, "Inicio de Viagem Carga " + carga.Codigo, unitOfWork);
                    }
                }
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro(ex);
            }
        }

        public void FinalizarViagemVeiculo(string placaVeiculo, Dominio.Entidades.ManifestoEletronicoDeDocumentosFiscais mdfe, Repositorio.UnitOfWork unitOfWork, Dominio.Entidades.Localidade localidadeFim, DateTime dataFim, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado)
        {
            try
            {
                Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unitOfWork);
                Repositorio.Embarcador.Veiculos.SituacaoVeiculo repSituacaoVeiculo = new Repositorio.Embarcador.Veiculos.SituacaoVeiculo(unitOfWork);

                Dominio.Entidades.Veiculo veiculo = repVeiculo.BuscarPorPlaca(placaVeiculo);
                if (veiculo != null && veiculo.SituacaoVeiculo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoVeiculo.EmViagem)
                {
                    veiculo.SituacaoVeiculo = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoVeiculo.Disponivel;
                    veiculo.VeiculoVazio = true;
                    veiculo.DataHoraPrevisaoDisponivel = null;
                    veiculo.LocalidadeAtual = localidadeFim;
                    veiculo.AvisadoCarregamento = false;

                    repVeiculo.Atualizar(veiculo);

                    Dominio.Entidades.Embarcador.Veiculos.SituacaoVeiculo situacao = new Dominio.Entidades.Embarcador.Veiculos.SituacaoVeiculo();
                    situacao.DataHoraEmissao = DateTime.Now;
                    situacao.DataHoraSituacao = DateTime.Now;
                    situacao.Veiculo = veiculo;
                    situacao.Localidade = localidadeFim;
                    situacao.Motorista = null;
                    situacao.DataHoraRetornoViagem = dataFim;
                    situacao.LocalidadeRetornoViagem = localidadeFim;
                    situacao.Situacao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoVeiculo.EmViagem;

                    repSituacaoVeiculo.Inserir(situacao);

                    if (Auditado != null)
                    {
                        Servicos.Auditoria.Auditoria.Auditar(Auditado, situacao, null, "Fim de Viagem MDFe " + mdfe.Numero.ToString(), unitOfWork);
                        Servicos.Auditoria.Auditoria.Auditar(Auditado, veiculo, null, "Fim de Viagem MDFe " + mdfe.Numero.ToString(), unitOfWork);
                    }
                }
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro(ex);
            }
        }

        public bool VerificarIntegracaoOrtec(int carga, TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {
            if (tipoServicoMultisoftware != TipoServicoMultisoftware.MultiEmbarcador)
                return true;

            Integracao.Ortec.IntegracaoOrtec servicoIntegracaoOrtec = new Integracao.Ortec.IntegracaoOrtec(unitOfWork);

            if (!servicoIntegracaoOrtec.IsPossuiIntegracaoOrtec())
                return true;

            if (servicoIntegracaoOrtec.IsCargaPossuiAgrupamentoVinculado(carga))
                return true;

            return false;
        }

        public void AdicionarIntegracaoBuonny(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaIntegracao repCargaIntegracao = new Repositorio.Embarcador.Cargas.CargaIntegracao(unitOfWork);
            Repositorio.Embarcador.Configuracoes.Integracao repConfiguracaoIntegracao = new Repositorio.Embarcador.Configuracoes.Integracao(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.Integracao configuracaoIntegracao = repConfiguracaoIntegracao.Buscar();

            if (configuracaoIntegracao != null && !string.IsNullOrWhiteSpace(configuracaoIntegracao.URLHomologacaoBuonny) && !string.IsNullOrWhiteSpace(configuracaoIntegracao.URLProducaoBuonny))
            {
                Dominio.Entidades.Embarcador.Cargas.TipoIntegracao tipoIntegracao = repTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Buonny);

                if (tipoIntegracao != null &&
                    repCargaIntegracao.ContarPorCargaETipoIntegracao(carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Buonny) <= 0)
                {
                    Servicos.Embarcador.Integracao.IntegracaoCarga svcIntegracaoCarga = new Integracao.IntegracaoCarga(unitOfWork);

                    svcIntegracaoCarga.InformarIntegracaoCarga(carga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Buonny, unitOfWork);
                }
            }
        }

        public void NotificarAlteracaoAoOperador(Dominio.Entidades.Embarcador.Cargas.Carga carga, string mensagem, Repositorio.UnitOfWork unitOfWork)
        {
            NotificarAlteracaoAoOperador(carga, mensagem, unitOfWork, TipoServicoMultisoftware.MultiEmbarcador);
        }

        public void NotificarAlteracaoAoOperador(Dominio.Entidades.Embarcador.Cargas.Carga carga, string mensagem, Repositorio.UnitOfWork unitOfWork, TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            if (carga.Operador == null)
                return;

            Notificacao.Notificacao servicoNotificacao = new Notificacao.Notificacao(unitOfWork.StringConexao, cliente: null, tipoServicoMultisoftware: tipoServicoMultisoftware, adminStringConexao: string.Empty);

            servicoNotificacao.GerarNotificacaoEmail(
                usuario: carga.Operador,
                usuarioGerouNotificacao: null,
                codigoObjeto: carga.Codigo,
                URLPagina: "Cargas/Carga",
                titulo: string.Format(Localization.Resources.Cargas.Carga.AlteracaoCarga, carga.CodigoCargaEmbarcador),
                nota: mensagem,
                icone: IconesNotificacao.atencao,
                tipoNotificacao: TipoNotificacao.alerta,
                tipoServicoMultisoftwareNotificar: tipoServicoMultisoftware,
                unitOfWork: unitOfWork
            );
        }

        public void NotificarAlteracaoAoTransportador(Dominio.Entidades.Embarcador.Cargas.Carga carga, string mensagem, Repositorio.UnitOfWork unitOfWork, TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            if (carga.Empresa == null)
                return;

            Dominio.ObjetosDeValor.Embarcador.Configuracoes.ConfiguracaoAmbiente configuracaoAmbiente = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoAmbiente();

            string ambiente = configuracaoAmbiente.IdentificacaoAmbiente;

            Notificacao.NotificacaoEmpresa servicoNotificacaoEmpresa = new Notificacao.NotificacaoEmpresa(unitOfWork);
            Dominio.ObjetosDeValor.Embarcador.Notificacao.NotificacaoEmpresa notificacaoEmpresa = new Dominio.ObjetosDeValor.Embarcador.Notificacao.NotificacaoEmpresa()
            {
                AssuntoEmail = string.Format(Localization.Resources.NotaFiscal.NaoConformidadeAprovacao.AtualizacaoCarga, ambiente),
                CabecalhoMensagem = string.Format(Localization.Resources.NotaFiscal.NaoConformidadeAprovacao.AlteracaoCarga, carga.CodigoCargaEmbarcador),
                CodigoOrigemNotificacao = carga.Codigo,
                Empresa = carga.Empresa,
                Mensagem = mensagem,
                TipoServicoMultisoftware = tipoServicoMultisoftware
            };

            servicoNotificacaoEmpresa.GerarNotificacao(notificacaoEmpresa, "Cargas/Carga", IconesNotificacao.atencao, TipoNotificacao.alerta);
            servicoNotificacaoEmpresa.GerarNotificacaoEmail(notificacaoEmpresa);
        }

        public void LiberarCargaSemNFe(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao, Repositorio.UnitOfWork unitOfWork, TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            LiberarCargaSemNFe(carga, cargaPedidos, configuracao, unitOfWork, tipoServicoMultisoftware, auditado: null);
        }

        public void LiberarRestanteCargaEmitidaParcialmente(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);

            carga.LiberadaParaEmissaoCTeSubContratacaoFilialEmissora = false;
            carga.AverbouTodosCTes = false;
            carga.AutorizouTodosCTes = false;
            carga.EmitindoCTes = false;
            Servicos.Embarcador.Carga.MDFe serMDFe = new Embarcador.Carga.MDFe(unitOfWork);
            List<string> ufsDestino = repCargaPedido.BuscarUFsDestinoPorLocalColeta(carga.Codigo, cargaPedido.Origem.Codigo);
            serMDFe.EncerrarMDFesCargaEmitidaParcialmente(cargaPedido.Carga, cargaPedido.Origem, ufsDestino, null, tipoServicoMultisoftware, unitOfWork, auditado);
        }

        public void LiberarCargaSemNFe(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao, Repositorio.UnitOfWork unitOfWork, TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado)
        {
            if (carga.ProcessandoDocumentosFiscais)
                throw new ServicoException("A carga já está processando os documentos fiscais para avançar para a próxima etapa, aguarde.");

            Servicos.Embarcador.Pedido.AlteracaoPedido servicoAlteracaoPedido = new Servicos.Embarcador.Pedido.AlteracaoPedido(unitOfWork);
            Servicos.Embarcador.Carga.CargaDadosSumarizados servicoCargaDadosSumarizados = new Servicos.Embarcador.Carga.CargaDadosSumarizados(unitOfWork);

            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repositorioPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);

            servicoAlteracaoPedido.ValidarAlteracaoPedidoPendenteAprovacao(carga);

            bool possuiPedidoComNFe = false;

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
            {
                if (repositorioPedidoXMLNotaFiscal.ContarXMLPorCargaPedido(cargaPedido.Codigo) == 0 && (cargaPedido.PedidoCTesParaSubContratacao?.Count ?? 0) == 0)
                {
                    cargaPedido.BaseCalculoICMS = 0;
                    cargaPedido.PedidoSemNFe = true;
                    repositorioCargaPedido.Atualizar(cargaPedido);
                    if (cargaPedido.CargaPedidoProximoTrecho != null)
                    {
                        cargaPedido.CargaPedidoProximoTrecho.PedidoSemNFe = true;
                        repositorioCargaPedido.Atualizar(cargaPedido.CargaPedidoProximoTrecho);
                    }
                }
                else
                    possuiPedidoComNFe = true;
            }

            servicoCargaDadosSumarizados.AtualizarPesos(carga, cargaPedidos, unitOfWork, tipoServicoMultisoftware);

            if (carga.ExigeNotaFiscalParaCalcularFrete)
            {
                AdicionarCargaDadosTransporteIntegracaoTipoTransportador(carga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.OpenTech, configuracao.NaoAvancarEtapaComRejeicaoIntegracaoTransportadorRejeitada, unitOfWork);

                if (!carga.AguardarIntegracaoEtapaTransportador)
                {
                    if (!possuiPedidoComNFe)
                    {
                        carga.DataInicioEmissaoDocumentos = DateTime.Now;
                        carga.DataInicioCalculoFrete = DateTime.Now;
                        carga.CalculandoFrete = true;
                        carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete;

                        if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete)
                            Servicos.Log.TratarErro("Atualizou a situação para calculo frete 46 Carga " + carga.CodigoCargaEmbarcador, "AtualizouSituacaoCalculoFrete");
                    }
                    else
                        carga.ProcessandoDocumentosFiscais = true;
                }
            }
            else
            {
                carga.ProcessandoDocumentosFiscais = true;
                carga.DataInicioConfirmacaoDocumentosFiscais = DateTime.Now;

                Servicos.Embarcador.Carga.RateioFrete serRateioFrete = new Servicos.Embarcador.Carga.RateioFrete(unitOfWork);
                serRateioFrete.RatearValorDoFrenteEntrePedidos(carga, cargaPedidos, configuracao, false, unitOfWork, tipoServicoMultisoftware);

                AdicionarIntegracaoCargaTipoTransportador(carga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.OpenTech, configuracao.NaoAvancarEtapaComRejeicaoIntegracaoTransportadorRejeitada, unitOfWork);
            }

            if (carga.CargaEmitidaParcialmente)
            {
                carga.PossuiPendencia = false;
                carga.MotivoPendencia = "";
                LiberarRestanteCargaEmitidaParcialmente(carga, cargaPedidos.FirstOrDefault(), tipoServicoMultisoftware, auditado, unitOfWork);
                carga.CargaEmitidaParcialmente = false;
            }

            repositorioCarga.Atualizar(carga);

            if (auditado != null)
                Servicos.Auditoria.Auditoria.Auditar(auditado, carga, null, Localization.Resources.Cargas.Carga.LiberouEmissaoSemNFe, unitOfWork);
        }

        public System.IO.MemoryStream ObterPDFsNFesBoletos(List<int> listaPedidos, Repositorio.UnitOfWork unitOfWork, ref string mensagem)
        {

            Repositorio.Embarcador.Cargas.Impressao.CargaImpressaoNFe repCargaImpressaoNFe = new Repositorio.Embarcador.Cargas.Impressao.CargaImpressaoNFe(unitOfWork);
            Repositorio.Embarcador.Cargas.Impressao.CargaImpressaoBoleto repCargaImpressaoBoleto = new Repositorio.Embarcador.Cargas.Impressao.CargaImpressaoBoleto(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.Impressao.CargaImpressaoBoleto> listaBoletos = repCargaImpressaoBoleto.BuscarPorPedidos(listaPedidos);
            List<Dominio.Entidades.Embarcador.Cargas.Impressao.CargaImpressaoNFe> listaNfes = repCargaImpressaoNFe.BuscarPorPedidos(listaPedidos);

            MemoryStream fZip = new MemoryStream();
            ZipOutputStream zipOStream = new ZipOutputStream(fZip);
            zipOStream.SetLevel(9);

            bool adicionouArquivo = false;

            foreach (Dominio.Entidades.Embarcador.Cargas.Impressao.CargaImpressaoBoleto boleto in listaBoletos)
            {
                if (!string.IsNullOrWhiteSpace(boleto.CaminhoPDF) && Utilidades.IO.FileStorageService.Storage.Exists(boleto.CaminhoPDF))
                {
                    byte[] dacte = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(boleto.CaminhoPDF);

                    ZipEntry entry = new ZipEntry(System.IO.Path.GetFileName(boleto.CaminhoPDF));
                    entry.DateTime = DateTime.Now;
                    zipOStream.PutNextEntry(entry);
                    zipOStream.Write(dacte, 0, dacte.Length);
                    zipOStream.CloseEntry();
                    adicionouArquivo = true;
                }
            }

            foreach (Dominio.Entidades.Embarcador.Cargas.Impressao.CargaImpressaoNFe nota in listaNfes)
            {
                if (!string.IsNullOrWhiteSpace(nota.CaminhoPDF) && Utilidades.IO.FileStorageService.Storage.Exists(nota.CaminhoPDF))
                {
                    byte[] dacte = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(nota.CaminhoPDF);

                    ZipEntry entry = new ZipEntry(System.IO.Path.GetFileName(nota.CaminhoPDF));
                    entry.DateTime = DateTime.Now;
                    zipOStream.PutNextEntry(entry);
                    zipOStream.Write(dacte, 0, dacte.Length);
                    zipOStream.CloseEntry();
                    adicionouArquivo = true;
                }
            }

            if (!adicionouArquivo)
            {
                mensagem = "Não existem PDFs disponíveis para download";
                return null;
            }


            zipOStream.IsStreamOwner = false;
            zipOStream.Close();

            fZip.Position = 0;

            return fZip;
        }

        public static bool AvancarEtapaDocumentosEmissaoCarga(out string erro, int codigoCarga, bool liberouProdutosDivergentes, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, List<AdminMultisoftware.Dominio.Enumeradores.PermissaoPersonalizada> permissoesPersonalizadas = null, Dominio.Entidades.Usuario usuario = null, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado = null, bool? finalizarCarga = null, bool naoValidarApolice = false)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscalComponente repXMLNotaFiscalComponente = new Repositorio.Embarcador.Pedidos.XMLNotaFiscalComponente(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXmlNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao repPedidoCTeParaSubContratacao = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.ColetaContainer repositorioColetaContainer = new Repositorio.Embarcador.Pedidos.ColetaContainer(unitOfWork);
            Repositorio.Embarcador.Pedidos.RetiradaContainer repositorioRetiradaContainer = new Repositorio.Embarcador.Pedidos.RetiradaContainer(unitOfWork);
            Repositorio.Embarcador.Cargas.ColetaEntrega.FluxoColetaEntrega repFluxoColetaEntrega = new Repositorio.Embarcador.Cargas.ColetaEntrega.FluxoColetaEntrega(unitOfWork);
            Repositorio.Embarcador.Logistica.GuaritaTMS repGuaritaTMS = new Repositorio.Embarcador.Logistica.GuaritaTMS(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe repCargaPedidoDocumentoCTe = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoDocumentoMDFe repCargaPedidoDocumentoMDFe = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoMDFe(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalParcial repCargaPedidoXMLNotaFiscalParcial = new Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalParcial(unitOfWork);
            Repositorio.Embarcador.WMS.RecebimentoMercadoria repRecebimentoMercadoria = new Repositorio.Embarcador.WMS.RecebimentoMercadoria(unitOfWork);
            Repositorio.Embarcador.Filiais.ConfiguracaoGestaoPatio repositorioConfiguracaoGestaoPatio = new Repositorio.Embarcador.Filiais.ConfiguracaoGestaoPatio(unitOfWork);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unitOfWork);
            Repositorio.Embarcador.Pedidos.ColetaContainerAnexo repositorioColetaContainerAnexo = new Repositorio.Embarcador.Pedidos.ColetaContainerAnexo(unitOfWork);
            Repositorio.Embarcador.Configuracoes.IntegracaoIntercab repIntegracaoIntercab = new Repositorio.Embarcador.Configuracoes.IntegracaoIntercab(unitOfWork);
            Repositorio.Embarcador.Pedidos.Container repContainer = new Repositorio.Embarcador.Pedidos.Container(unitOfWork);
            Repositorio.Embarcador.Pedidos.ContainerTipo repContainerTipo = new Repositorio.Embarcador.Pedidos.ContainerTipo(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoPaletes repConfiguracaoPaletes = new Repositorio.Embarcador.Configuracoes.ConfiguracaoPaletes(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoControleEntrega repConfiguracaoControleEntrega = new Repositorio.Embarcador.Configuracoes.ConfiguracaoControleEntrega(unitOfWork);

            Servicos.Embarcador.Pedido.NotaFiscal serPedidoNotaFiscal = new Servicos.Embarcador.Pedido.NotaFiscal(unitOfWork);
            Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);
            Servicos.Embarcador.Carga.RateioFormula serRateioFormula = new Servicos.Embarcador.Carga.RateioFormula();
            Servicos.Embarcador.Pedido.Pedido serPedido = new Servicos.Embarcador.Pedido.Pedido();
            Servicos.Embarcador.Pedido.AlteracaoPedido servicoAlteracaoPedido = new Servicos.Embarcador.Pedido.AlteracaoPedido(unitOfWork);
            Servicos.Embarcador.Pedido.ColetaContainer servicoColetaContainer = new Servicos.Embarcador.Pedido.ColetaContainer(unitOfWork);
            Servicos.Embarcador.Carga.CargaDadosSumarizados serCargaDadosSumarizados = new Servicos.Embarcador.Carga.CargaDadosSumarizados(unitOfWork);
            Servicos.Embarcador.GestaoPatio.FluxoGestaoPatio servicoFluxoGestaoPatio = new Servicos.Embarcador.GestaoPatio.FluxoGestaoPatio(unitOfWork);
            Servicos.Embarcador.Logistica.RegraPlanejamentoFrota serRegraPlanejamentoFrota = new Servicos.Embarcador.Logistica.RegraPlanejamentoFrota(unitOfWork);
            Servicos.Embarcador.Carga.ControleEntrega.PrevisaoControleEntrega servicoPrevisaoControleEntrega = new Servicos.Embarcador.Carga.ControleEntrega.PrevisaoControleEntrega(unitOfWork, configuracaoTMS);

            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab = repIntegracaoIntercab.BuscarIntegracao();
            Dominio.Entidades.Embarcador.Filiais.ConfiguracaoGestaoPatio configuracaoGestaoPatio = repositorioConfiguracaoGestaoPatio.BuscarConfiguracao();
            bool faturamentoPermiteSolicitarNotasFiscaisEtapaBloqueada = configuracaoGestaoPatio?.FaturamentoPermiteSolicitarNotasFiscaisEtapaBloqueada ?? false;
            bool avancoSemIntegracaoOrtec = !serCarga.VerificarIntegracaoOrtec(codigoCarga, tipoServicoMultisoftware, unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigo(codigoCarga);
            Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacao = carga.TipoOperacao;

            if (avancoSemIntegracaoOrtec && permissoesPersonalizadas != null && !permissoesPersonalizadas.Contains(AdminMultisoftware.Dominio.Enumeradores.PermissaoPersonalizada.Carga_AutorizarSemArquivoOrtec))
            {
                erro = "Você não possui permissões para executar esta ação.";
                return false;
            }

            if (IsCargaBloqueada(carga, unitOfWork))
            {
                erro = $"A {carga.DescricaoEntidade} está bloqueada e não permite seguir para a próxima etapa.";
                return false;
            }

            if (carga.ProcessandoDocumentosFiscais)
            {
                erro = "A carga já está processando os documentos fiscais para avançar para a próxima etapa, aguarde.";
                return false;
            }

            if ((carga.SituacaoCarga != SituacaoCarga.AgNFe) && !carga.CargaEmitidaParcialmente)
            {
                erro = "Não é possível avançar a etapa de documentos na atual situação da carga (" + carga.DescricaoSituacaoCarga + ").";
                return false;
            }

            if (!carga.ExigeNotaFiscalParaCalcularFrete &&
                (carga.DataEnvioUltimaNFe.HasValue && carga.DataEnvioUltimaNFe.Value <= DateTime.Now.AddSeconds(-configuracaoTMS.TempoSegundosParaInicioEmissaoDocumentos)) &&
                !carga.AguardandoEmissaoDocumentoAnterior && !carga.AguardarIntegracaoEtapaTransportador &&
                !carga.AgValorRedespacho && !carga.PendenteGerarCargaDistribuidor)
            {
                erro = "Os documentos da carga já estão sendo gerados, aguarde.";
                return false;
            }

            if (carga.CargaDePreCargaEmFechamento)
            {
                erro = "A carga desta pré carga está sendo fechada, aguarde.";
                return false;
            }

            if ((carga.TipoOperacao?.ObrigatorioVincularContainerCarga ?? false) && tipoServicoMultisoftware != TipoServicoMultisoftware.MultiTMS)
            {
                Dominio.Entidades.Embarcador.Pedidos.ColetaContainer coletaContainer;

                if (carga.TipoOperacao?.OperacaoTransferenciaContainer ?? false)
                {
                    Dominio.Entidades.Embarcador.Pedidos.ColetaContainer coletaContainerDeletar;

                    coletaContainer = repositorioColetaContainer.BuscarPorCargaAtual(carga.Codigo);

                    if (coletaContainer.Container == null)//POG verificar se tem para essa carga uma coleta container com container e deletar essa q nao tem container (é uma coleta).
                    {
                        coletaContainerDeletar = coletaContainer;

                        if (coletaContainer != null && coletaContainer.Container == null)
                            repositorioColetaContainer.DeletarPorCodigo(coletaContainerDeletar.Codigo);

                        coletaContainer = repositorioColetaContainer.BuscarPorCargaAtualComContainer(carga.Codigo);
                    }
                }
                else
                    coletaContainer = repositorioColetaContainer.BuscarPorCargaDeColeta(codigoCarga);

                if (coletaContainer?.Container == null)
                {
                    erro = "É obrigatório informar o container para poder avançar essa etapa";
                    return false;
                }

                if (carga.TipoOperacao?.ObrigarInformarRICnaColetaDeConteiner ?? false)
                {
                    List<Dominio.Entidades.Embarcador.Pedidos.ColetaContainerAnexo> anexosColetaContainerAnexo = repositorioColetaContainerAnexo.BuscarPorColetaContainerECarga(coletaContainer?.Codigo ?? 0, carga?.Codigo ?? 0);

                    if (anexosColetaContainerAnexo.Count == 0)
                        throw new ServicoException("É obrigatório informar o Ric do Container para poder avançar a carga!");

                    if (new Pedido.ConferenciaContainer(unitOfWork).PossuiConferenciaSemAprovacao(carga))
                    {
                        erro = "É obrigatório realizar a conferência do container para poder avançar essa etapa";
                        return false;
                    }
                }
            }
            else
            {
                Dominio.Entidades.Embarcador.Pedidos.RetiradaContainer retiradaContainer = repositorioRetiradaContainer.BuscarPorCarga(carga.Codigo);
                Dominio.Entidades.Embarcador.Pedidos.ContainerTipo containerTipo = retiradaContainer?.ContainerTipo ?? carga.ModeloVeicularCarga?.ContainerTipo ?? carga.Carregamento?.ModeloVeicularCarga?.ContainerTipo;

                if (containerTipo != null)
                {
                    if (retiradaContainer?.ColetaContainer?.Container == null)
                    {
                        if (!carga.LiberadaSemRetiradaContainer)
                        {
                            erro = $"O container do tipo {containerTipo.Descricao} ainda não foi informado para esta carga, não sendo possível prosseguir.";
                            return false;
                        }
                    }
                    //else
                    //{
                    //    servicoColetaContainer.AtualizarSituacaoColetaContainerEGerarHistorico(new Dominio.ObjetosDeValor.Embarcador.Pedido.AtualizarColetaContainerParametro()
                    //    {
                    //        coletaContainer = retiradaContainer.ColetaContainer,
                    //        DataAtualizacao = DateTime.Now,
                    //        Status = StatusColetaContainer.EmDeslocamentoCarregado,
                    //        Usuario = usuario,
                    //        OrigemMonimentacaoContainer = OrigemMovimentacaoContainer.Sistema,
                    //        InformacaoOrigemMonimentacaoContainer = InformacaoOrigemMovimentacaoContainer.AutomaticamenteAvancoEtapaDocumentos
                    //    });
                    //}
                }
            }

            if (!carga.CargaTransbordo && !repCargaPedido.ExisteCTeEmitidoNoEmbarcador(carga.Codigo) && (repCargaPedidoDocumentoCTe.ExistePorCarga(carga.Codigo) || repCargaPedidoDocumentoMDFe.ExistePorCarga(carga.Codigo)))
            {
                erro = "Existem MDF-es e/ou CT-es emitidos pelo embarcador vinculados à esta carga, não sendo possível prosseguir.";
                return false;
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo);

            if (!carga.CargaTransbordo && repCargaPedido.ExisteCTeEmitidoNoEmbarcador(carga.Codigo))
            {
                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
                {
                    if (!repCargaPedidoDocumentoCTe.ExistePorCargaPedido(cargaPedido.Codigo))
                    {
                        erro = $"Não existem CT-es emitidos pelo embarcador vinculados à esta carga, pedido {cargaPedido.Pedido.Numero}, não sendo possível prosseguir.";
                        return false;
                    }
                }
            }

            if (!IsAnexosAgendamentoColetaValido(carga, unitOfWork))
            {
                erro = "A carga está marcada como Carga Perigosa, é obrigatório inserir um anexo.";
                return false;
            }

            string retornoVerificarOperador = usuario != null ? serCarga.VerificarOperadorPodeConfigurarCarga(usuario, carga, tipoServicoMultisoftware, unitOfWork) : string.Empty;

            if (!string.IsNullOrWhiteSpace(retornoVerificarOperador))
            {
                erro = retornoVerificarOperador;
                return false;
            }

            if (carga.Integracoes.Any(o => o.TipoIntegracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Logiun) && repPedidoXMLNotaFiscal.VerificarSeExisteNotaSemQuantidadePallets(carga.Codigo))
            {
                erro = "Existem notas fiscais sem quantidade de pallets informada.";
                return false;
            }

            if (!configuracaoTMS.PermiteAdicionarNFeRepetidaParaOutroPedidoCarga && !(carga.TipoOperacao?.PermiteConsultarPorPacotesLoggi ?? false) && (!carga.Empresa?.IgnorarDocumentosDuplicadosNaEmissaoCTe ?? false))
            {
                IList<string> listaChaveNFeDuplicada = repPedidoXMLNotaFiscal.BuscarListaChaveNFeDuplicadaPorCarga(carga.Codigo);

                if (listaChaveNFeDuplicada.Count > 0)
                    throw new ServicoException("Existem NF-es duplicadas na carga.");
            }

            if (carga.Integracoes.Any(o => o.TipoIntegracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.MercadoLivre))
            {
                Repositorio.Embarcador.Cargas.CargaIntegracaoMercadoLivre repCargaIntegracaoMercadoLivre = new Repositorio.Embarcador.Cargas.CargaIntegracaoMercadoLivre(unitOfWork);

                if (repCargaIntegracaoMercadoLivre.ExisteInvalidoPorCarga(carga.Codigo))
                {
                    erro = "A situação dos Handling Units não permitem prosseguir.";
                    return false;
                }
            }

            if (configuracaoTMS.NaoPermitirAvancarCargaSemEstoque && tipoOperacao != null && tipoOperacao.EmitirNFeRemessa)
            {
                IList<Dominio.ObjetosDeValor.Embarcador.WMS.EstoqueProdutoCarga> produtosSemEstoque = repRecebimentoMercadoria.ProdutosSemEstoqueDaCarga(carga.Codigo);
                if (produtosSemEstoque != null && produtosSemEstoque.Count > 0)
                {
                    erro = "Existe(m) produto(s) desta carga que não possui(em) estoque suficiente: <br />";

                    foreach (Dominio.ObjetosDeValor.Embarcador.WMS.EstoqueProdutoCarga produto in produtosSemEstoque)
                        erro += produto.Codigo + " - " + produto.Descricao + " Qtd: " + produto.Quantidade.ToString("n2") + " Est. Atual: " + produto.QtdEstoque.ToString("n2") + "<br />";
                    return false;
                }
            }

            Dominio.Entidades.Embarcador.Rateio.RateioFormula formulaRateio = serRateioFormula.ObterFormulaDeRateio(carga, unitOfWork, carga.Pedidos?.FirstOrDefault() ?? null);

            if (configuracaoTMS.UtilizaEmissaoMultimodal && repPedidoXMLNotaFiscal.VerificarSeAlgumaNaoPossuiPeso(carga.Codigo) && carga.Pedidos.Any(o => o.TipoPropostaMultimodal != TipoPropostaMultimodal.VAS))
            {
                erro = "Existem notas fiscais sem peso. Informe o peso para prosseguir.";
                return false;
            }

            if ((formulaRateio == null || (formulaRateio != null && formulaRateio.ParametroRateioFormula == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ParametroRateioFormula.peso)) && repPedidoXMLNotaFiscal.VerificarSeAlgumaNaoPossuiPeso(carga.Codigo))
            {
                if (configuracaoTMS.UtilizaEmissaoMultimodal && carga.Pedidos.Any(o => o.TipoPropostaMultimodal != TipoPropostaMultimodal.VAS))
                {
                    erro = "Existem notas fiscais sem peso. Informe o peso para prosseguir.";
                    return false;
                }
                else if (!configuracaoTMS.UtilizaEmissaoMultimodal)
                {
                    erro = "Existem notas fiscais sem peso. Informe o peso para prosseguir.";
                    return false;
                }
            }

            List<int> numerosNotasCanceladasPeloEmitente = serPedidoNotaFiscal.ObterNumerosNotasCanceladasPeloEmitente(carga.Codigo);
            if (numerosNotasCanceladasPeloEmitente.Count > 0)
            {
                erro = $"Existem notas fiscais ({string.Join(",", numerosNotasCanceladasPeloEmitente)}) canceladas pelo emitente na carga, por favor, remova as notas antes de avançar.";
                return false;
            }

            if (repPedidoXMLNotaFiscal.ObterPesoTotalPorCarga(carga.Codigo) > 999999m && !configuracaoTMS.UtilizaEmissaoMultimodal)
            {
                erro = "O peso total das notas fiscais ultrapassa 999.999kg. Ajuste o peso das notas fiscais antes de prosseguir.";
                return false;
            }
            else if (configuracaoTMS.UtilizaEmissaoMultimodal && repPedidoXMLNotaFiscal.ObterPesoTotalPorCarga(carga.Codigo) > 41999999m)
            {
                erro = "O peso total das notas fiscais ultrapassa 42.000.000kg. Ajuste o peso das notas fiscais antes de prosseguir.";
                return false;
            }

            if ((carga.Empresa?.EmpresaPropria ?? false) && repPedidoXMLNotaFiscal.VerificarSeAlgumaEmContingenciaNaoPossuiSegundoCodigoBarras(carga.Codigo))
            {
                erro = "Existem notas fiscais emitidas em contingência sem a informação do Segundo Código de Barras.";
                return false;
            }

            if (configuracaoTMS.UtilizaEmissaoMultimodal && carga.PedidoViagemNavio == null && (tipoOperacao == null || tipoOperacao.TipoEmissaoIntramunicipal != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoIntramunicipal.SempreNFSManual))
            {
                erro = "O navio/viagem/direção não foi informado na etapa 1.";
                return false;
            }

            bool obrigatorioPassagemExpedicao = tipoOperacao?.ObrigatorioPassagemExpedicao ?? false;

            if (obrigatorioPassagemExpedicao)
            {
                if (carga.PossuiSeparacao && !carga.SeparacaoConferida)
                {
                    erro = "As mercadorias desta carga ainda não foram conferidas na tela de expedição.";
                    return false;
                }

                if (obrigatorioPassagemExpedicao && !carga.SeparacaoConferida)
                {
                    erro = "O tipo de operação selecionado obriga a carga passar pela a etapa de expedição.";
                    return false;
                }
            }

            Dominio.Entidades.Embarcador.GestaoPatio.FluxoGestaoPatio fluxoGestaoPatio = servicoFluxoGestaoPatio.ObterFluxoGestaoPatio(carga);
            if (!faturamentoPermiteSolicitarNotasFiscaisEtapaBloqueada && fluxoGestaoPatio != null && fluxoGestaoPatio.Etapas.Any(obj => obj.EtapaFluxoGestaoPatio == Dominio.ObjetosDeValor.Embarcador.Enumeradores.EtapaFluxoGestaoPatio.Faturamento) && !carga.EtapaFaturamentoLiberado)
            {
                erro = "Ainda não foi liberado o faturamento para esta carga.";
                return false;
            }

            if (tipoOperacao != null && tipoOperacao.BloquearEmissaoDeEntidadeSemCadastro.HasValue && tipoOperacao.BloquearEmissaoDeEntidadeSemCadastro.Value && repPedidoXMLNotaFiscal.ContemmClientesSemCadastro(carga.Codigo))
            {
                erro = "A operação selecionada não permite realizar a carga contendo clientes sem cadastro.";
                return false;
            }

            if (tipoOperacao != null && tipoOperacao.BloquearEmissaoDosDestinatario.HasValue && tipoOperacao.BloquearEmissaoDosDestinatario.Value && tipoOperacao.ClientesBloquearEmissaoDosDestinatario != null && tipoOperacao.ClientesBloquearEmissaoDosDestinatario.Count > 0 && repCargaPedido.ContemDestinatariosParaBloquear(carga.Codigo, tipoOperacao.ClientesBloquearEmissaoDosDestinatario.Select(o => o.CPF_CNPJ).ToList()))
            {
                erro = "A operação selecionada não permite realizar a carga para o(s) destinatário(s) desta carga.";
                return false;
            }

            if (tipoOperacao != null && tipoOperacao.ExigeChaveVendaAntesConfirmarNotas && repPedidoXMLNotaFiscal.ContemXMLSemChaveVenda(carga.Codigo))
            {
                erro = "Não é permitido avançar a etapa sem informar todas chaves de venda.";
                return false;
            }

            if (configuracaoTMS.ObrigarTerGuaritaParaLancamentoEFinalizacaoCarga && !repGuaritaTMS.ContemRegistroGuaritaCarga(carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEntradaSaida.Saida))
            {
                erro = "Não foi encontrado nenhum registro de saída da Guarita. Favor realize o lançamento antes de avançar a etapa desta carga.";
                return false;
            }

            if (new Servicos.Embarcador.PreCarga.PreCarga(unitOfWork).IsAlteracoesDadosPreCargaSemConfirmacao(carga))
            {
                erro = "Não é possível seguir para a próxima etapa sem confirmar as alterações dos dados da pré carga.";
                return false;
            }

            if (repCargaPedidoXMLNotaFiscalParcial.VerificarSeExisteNotaParcialSemNota(codigoCarga))
            {
                erro = "Não é possível seguir para a próxima etapa sem enviar todas notas parciais da carga.";
                return false;
            }

            if ((tipoOperacao?.NaoPermitirEmitirCargaComMesmoNumeroOutroDocumento ?? false) && repPedidoXMLNotaFiscal.VerificarSeExisteNumeroOutroDocumentoOutraCarga(carga.Codigo))
            {
                erro = "Existem notas fiscais com o mesmo Nº Outro Documento em outra carga de mesmo Remetente e Tomador do Pedido.";
                return false;
            }

            if (configuracaoTMS.UtilizaEmissaoMultimodal)
            {
                serCarga.SetarTipoContratacaoCarga(carga, unitOfWork);

                bool exigirInformarM3 = tipoOperacao?.ExigirInformarM3 ?? false;
                bool exigirInformarCFOP = tipoOperacao?.ExigirInformarCFOP ?? false;
                bool exigirInformarNCM = tipoOperacao?.ExigirInformarNCM ?? false;
                bool exigirInformarValorMercadoria = tipoOperacao?.ExigirInformarValorMercadoria ?? false;
                bool exigirInformarValorNota = tipoOperacao?.ExigirInformarValorNota ?? false;
                bool exigirInformarQuantidadeMercadoria = tipoOperacao?.ExigirInformarQuantidadeMercadoria ?? false;
                bool exigirInformarPeso = tipoOperacao?.ExigirInformarPeso ?? false;

                bool exigirNumeroControleCliente = carga.GrupoPessoaPrincipal?.ExigirNumeroControleCliente ?? false;
                bool exigirNumeroNumeroReferenciaCliente = carga.GrupoPessoaPrincipal?.ExigirNumeroNumeroReferenciaCliente ?? false;

                if (!exigirNumeroControleCliente)
                {
                    foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
                    {
                        if (!exigirNumeroControleCliente && cargaPedido.ObterTomador() != null)
                            exigirNumeroControleCliente = cargaPedido.ObterTomador().ExigirNumeroControleCliente;
                    }
                }

                if (!exigirNumeroNumeroReferenciaCliente)
                {
                    foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
                    {
                        if (!exigirNumeroNumeroReferenciaCliente && cargaPedido.ObterTomador() != null)
                            exigirNumeroNumeroReferenciaCliente = cargaPedido.ObterTomador().ExigirNumeroNumeroReferenciaCliente;
                    }
                }

                if (!carga.CargaSVM && !carga.CargaTakeOrPay)
                {
                    if (carga.GrupoPessoaPrincipal != null && carga.GrupoPessoaPrincipal.ExigirNumeroPedido && carga.Pedidos.Any(cargaPedido => string.IsNullOrWhiteSpace(cargaPedido.Pedido.NumeroPedidoEmbarcador)))
                    {
                        erro = "É necessário informar o número do pedido para confirmar a emissão dos documentos.";
                        return false;
                    }

                    if (!carga.CargaSVMTerceiro && carga.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMProprio && carga.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho && carga.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario
                        && carga.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada && carga.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro)
                    {
                        bool contemNotaEletronica = repPedidoXMLNotaFiscal.ContemNotaEletronicaNaCarga(carga.Codigo);

                        if (exigirInformarM3 && repPedidoXMLNotaFiscal.ObterMetroCubicoPorCarga(carga.Codigo) <= 0)
                        {
                            erro = "O Tipo de Operação selecionado obriga a informação do M³ nos documentos.";
                            return false;
                        }

                        if (contemNotaEletronica && exigirInformarCFOP && repPedidoXMLNotaFiscal.ContemDocumentoSemCFOP(carga.Codigo))
                        {
                            erro = "O Tipo de Operação selecionado obriga a informação da CFOP nos documentos.";
                            return false;
                        }

                        if (exigirInformarValorMercadoria && repPedidoXMLNotaFiscal.ObterValorMercadoriaPorCarga(carga.Codigo) <= 0)
                        {
                            erro = "O Tipo de Operação selecionado obriga a informação do Valor da Mercadoria nos documentos.";
                            return false;
                        }

                        if (exigirInformarValorNota && repPedidoXMLNotaFiscal.ObterValorNotaPorCarga(carga.Codigo) <= 0)
                        {
                            erro = "O Tipo de Operação selecionado obriga a informação do Valor da Nota nos documentos.";
                            return false;
                        }

                        if (exigirInformarQuantidadeMercadoria && repPedidoXMLNotaFiscal.ObterQuantidadeMercadoriaPorCarga(carga.Codigo) <= 0)
                        {
                            erro = "O Tipo de Operação selecionado obriga a informação da Quantidade nos documentos.";
                            return false;
                        }

                        if (exigirInformarPeso && repPedidoXMLNotaFiscal.ObterPesoTotalPorCarga(carga.Codigo) <= 0)
                        {
                            erro = "O Tipo de Operação selecionado obriga a informação do Peso nos documentos.";
                            return false;
                        }

                        if (contemNotaEletronica && exigirNumeroControleCliente && repPedidoXMLNotaFiscal.ContemDocumentoSemNumeroControleCliente(carga.Codigo))
                        {
                            erro = "O Grupo de Pessoa/Cliente selecionado obriga a informação do número de controle nos documentos.";
                            return false;
                        }

                        if (contemNotaEletronica && exigirNumeroNumeroReferenciaCliente && repPedidoXMLNotaFiscal.ContemDocumentoSemNumeroReferenciaEDI(carga.Codigo))
                        {
                            erro = "O Grupo de Pessoa/Cliente selecionado obriga a informação do número de referência do EDI nos documentos.";
                            return false;
                        }

                        if (exigirInformarNCM && repPedidoXMLNotaFiscal.ContemDocumentoSemNCM(carga.Codigo))
                        {
                            if (!repCargaPedido.ContemProdutoEmbarcador(carga.Codigo) || repCargaPedido.ContemProdutoSemNCM(carga.Codigo))
                            {
                                erro = "O Tipo de Operação selecionado obriga a informação do NCM nos documentos.";
                                return false;
                            }
                        }
                    }
                    else if (carga.CargaSVMTerceiro || carga.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMProprio || carga.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho || carga.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario
                        || carga.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada || carga.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro)
                    {
                        bool contemNotaEletronica = repPedidoCTeParaSubContratacao.ContemNotaEletronicaNaCarga(carga.Codigo);

                        if (contemNotaEletronica && exigirInformarNCM && repPedidoCTeParaSubContratacao.ContemDocumentoSemNCM(carga.Codigo))
                        {
                            if (!repCargaPedido.ContemProdutoEmbarcador(carga.Codigo) || repCargaPedido.ContemProdutoSemNCM(carga.Codigo))
                            {
                                erro = "O Tipo de Operação selecionado obriga a informação do NCM nos documentos.";
                                return false;
                            }
                        }
                        else if (!contemNotaEletronica && exigirInformarNCM && repPedidoCTeParaSubContratacao.ContemOutroDocumentoSemNCM(carga.Codigo))
                        {
                            if (!repCargaPedido.ContemProdutoEmbarcador(carga.Codigo) || repCargaPedido.ContemProdutoSemNCM(carga.Codigo))
                            {
                                erro = "O Tipo de Operação selecionado obriga a informação do NCM nos documentos.";
                                return false;
                            }
                        }

                        if (contemNotaEletronica && exigirInformarPeso && repPedidoCTeParaSubContratacao.ContemDocumentoSemPeso(carga.Codigo))
                        {
                            erro = "O Tipo de Operação selecionado obriga a informação do Peso nos documentos.";
                            return false;
                        }
                    }
                }
            }

            List<Dominio.ObjetosDeValor.Embarcador.Carga.PedidoDestinatarioBloqueado> lstPedidoDestinatarioBloqueado = repPedido.BuscarPedidosDestinatarioBloqueados(cargaPedidos.Select(x => x.Pedido.Codigo).ToList());
            List<Dominio.Entidades.Embarcador.Pedidos.Container> lstContainer = repContainer.BuscarPorListaDeNumero(cargaPedidos.Where(x => x.Pedido?.Container?.Codigo != null).Select(x => x.Pedido.Container.Codigo).ToList());
            List<Dominio.Entidades.Embarcador.Pedidos.ContainerTipo> lstContainerTipoReserva = repContainerTipo.BuscarPorListaDeCodigo(cargaPedidos.Where(x => x.Pedido.ContainerTipoReserva?.Codigo != null).Select(x => x.Pedido.ContainerTipoReserva.Codigo).ToList());
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoPaletes configuracaoPaletes = repConfiguracaoPaletes.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoControleEntrega configuracaoControleEntrega = repConfiguracaoControleEntrega.BuscarPrimeiroRegistro();
            List<int> CodigoPedidoQueExisteNotaParcialSemNotaParaCargaPedido = repCargaPedidoXMLNotaFiscalParcial.BuscarCodigoPedidoQueExisteNotaParcialSemNotaParaCargaPedido(carga.Codigo);
            IList<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> lstPedidoXMLNotaFiscal = repPedidoXMLNotaFiscal.BuscarCodigoPedidoQuePossuNotafiscalPorCarga(carga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
            {
                if (tipoOperacao != null && tipoOperacao.ValidarTomadorDoPedidoDiferenteDaCarga && (cargaPedido.Pedido.TipoTomador == Dominio.Enumeradores.TipoTomador.Remetente || cargaPedido.Pedido.TipoPagamento == Dominio.Enumeradores.TipoPagamento.Pago))
                {
                    Dominio.Entidades.Cliente tomadorPedido = cargaPedido.ObterTomador();

                    List<double> cpfCnpjTomadoresNotasFiscais = repPedidoXMLNotaFiscal.ObterCPFCNPJTomadores(cargaPedido.Codigo);

                    if (tomadorPedido != null && cpfCnpjTomadoresNotasFiscais.Count > 0)
                    {
                        foreach (double cpfCnpjTomadorNotaFiscal in cpfCnpjTomadoresNotasFiscais)
                        {
                            if (cpfCnpjTomadorNotaFiscal != tomadorPedido.CPF_CNPJ)
                            {
                                Dominio.Entidades.Cliente tomadorNotaFiscal = repCliente.BuscarPorCPFCNPJ(cpfCnpjTomadorNotaFiscal);
                                erro = "O tomador do pedido " + tomadorPedido.Descricao + " está diferente do tomador da carga " + tomadorNotaFiscal?.Descricao + ".";
                                return false;
                            }
                        }
                    }
                }

                if (cargaPedido.Pedido != null && cargaPedido.Pedido.ValidarDigitoVerificadorContainer && cargaPedido.Pedido.Container != null && cargaPedido.Pedido.Container.TipoPropriedade == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPropriedadeContainer.Proprio && !string.IsNullOrWhiteSpace(cargaPedido.Pedido.Container.Numero))
                {
                    if (!serPedido.ValidarDigitoContainerNumero(cargaPedido.Pedido.Container.Numero))
                    {
                        erro = "O container associado ao pedido está inválido de acordo com o cálculo do digito verificado.";
                        return false;
                    }
                }

                if (configuracaoTMS.UtilizaEmissaoMultimodal && cargaPedido.Pedido != null && cargaPedido.Pedido.Container == null && !cargaPedido.Pedido.ContainerADefinir)
                {
                    erro = "Favor informe o container do pedido antes de seguir para a próxima etapa.";
                    return false;
                }

                if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS && (carga.TipoOperacao?.ObrigatorioVincularContainerCarga ?? false))
                {
                    if (repCargaPedido.ContemPedidoSemContainer(carga.Codigo))
                    {
                        erro = "Favor informe o container do pedido antes de seguir para a próxima etapa.";
                        return false;
                    }
                }

                decimal taraContainer = 0m;
                decimal.TryParse(cargaPedido.Pedido?.TaraContainer ?? "", out taraContainer);
                if (configuracaoTMS.UtilizaEmissaoMultimodal && cargaPedido.Pedido != null && cargaPedido.Pedido.Container != null && taraContainer == 0 && !cargaPedido.Pedido.ContainerADefinir)
                {
                    erro = "Favor informe a tara do container no pedido antes de seguir para a próxima etapa.";
                    return false;
                }

                if (configuracaoTMS.UtilizaEmissaoMultimodal && cargaPedido.Pedido != null && cargaPedido.Pedido.Container != null && string.IsNullOrWhiteSpace(cargaPedido.Pedido.LacreContainerUm) && !cargaPedido.Pedido.ContainerADefinir)
                {
                    erro = "Favor informe ao menos o primeiro lacre do container no pedido antes de seguir para a próxima etapa.";
                    return false;
                }

                List<string> DestinatarioBloqueado = lstPedidoDestinatarioBloqueado.Where(x => x.Pedido == cargaPedido.Pedido.Codigo).Select(x => x.CnpjCpfDestinatarioBloqueado).ToList();
                if (tipoOperacao != null && DestinatarioBloqueado != null && DestinatarioBloqueado.Count > 0 && repPedidoXMLNotaFiscal.ContemDestinatariosParaBloquear(carga.Codigo, DestinatarioBloqueado))
                {
                    erro = "A operação selecionada não permite realizar a carga para o(s) destinatário(s) desta carga.";
                    return false;
                }

                Dominio.Entidades.Embarcador.Pedidos.Container container = lstContainer.Where(x => x.Codigo == cargaPedido.Pedido.Container.Codigo).FirstOrDefault();
                Dominio.Entidades.Embarcador.Pedidos.ContainerTipo containerTipoReserva = lstContainerTipoReserva.Where(x => x.Codigo == cargaPedido.Pedido.ContainerTipoReserva.Codigo).FirstOrDefault();

                if (container != null && containerTipoReserva != null && container.ContainerTipo != null && containerTipoReserva.Codigo != container.ContainerTipo.Codigo)
                {
                    erro = "Foi informado um container do tipo " + cargaPedido.Pedido.Container.ContainerTipo.Descricao + " porém esta carga só permite container do tipo " + cargaPedido.Pedido.ContainerTipoReserva.Descricao + ".";
                    return false;
                }

                if (configuracaoTMS.UtilizaEmissaoMultimodal && cargaPedido.Recebedor == null && (cargaPedido.TipoPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPropostaMultimodal.CargaFechada || cargaPedido.TipoPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPropostaMultimodal.CargaFracionada) && repPedidoXMLNotaFiscal.QuantidadeDestinatariosNaNota(carga.Codigo) > 1)
                {
                    erro = "Esta carga possui notas com múltiplos destinatários e sem recebedor informado. Favor informe o Recebedor no Pedido.";
                    return false;
                }

                if (!carga.CargaSVM && !carga.CargaTakeOrPay && configuracaoTMS.UtilizaEmissaoMultimodal && cargaPedido.Pedido.Container != null && cargaPedido.Pedido.Container.ContainerTipo == null)
                {
                    erro = "Favor informe o Tipo do Container no container " + cargaPedido.Pedido.Container.Numero + " do pedido " + cargaPedido.Pedido.Numero.ToString("0n") + ".";
                    return false;
                }

                if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
                {
                    if (cargaPedido.Pedido.Destinatario == null && (carga == null || tipoOperacao == null || !tipoOperacao.CTeEmitidoNoEmbarcador))
                    {
                        erro = "Favor informe o destinatário do pedido corretamente.";
                        return false;
                    }
                }

                if (!PreencherDadosPalletsDoPedido(out erro, carga, cargaPedido, tipoOperacao, unitOfWork, configuracaoPaletes))
                    return false;

                if (configuracaoTMS.UtilizaEmissaoMultimodal && cargaPedido.Pedido != null)
                {
                    if (cargaPedido.Recebedor != null && cargaPedido.Pedido.EnderecoRecebedor != null && cargaPedido.Pedido.EnderecoRecebedor.Localidade != null)
                        cargaPedido.Destino = cargaPedido.Pedido.EnderecoRecebedor.Localidade;
                    else if (cargaPedido.Pedido.Recebedor != null && cargaPedido.Pedido.Recebedor.Localidade != null)
                        cargaPedido.Destino = cargaPedido.Pedido.Recebedor.Localidade;
                    else if (cargaPedido.Pedido.Destinatario != null && cargaPedido.Pedido.Destinatario.Localidade != null)
                        cargaPedido.Destino = cargaPedido.Pedido.Destinatario.Localidade;

                    if (cargaPedido.Expedidor != null)
                        cargaPedido.Origem = cargaPedido.Expedidor.Localidade;
                    else if (cargaPedido.Expedidor != null && cargaPedido.Pedido.EnderecoExpedidor != null && cargaPedido.Pedido.EnderecoExpedidor.Localidade != null)
                        cargaPedido.Origem = cargaPedido.Pedido.EnderecoExpedidor.Localidade;

                    repCargaPedido.Atualizar(cargaPedido);
                }

                bool exgirInformarProduto = tipoOperacao?.ExigeProdutoEmbarcadorPedido ?? false;
                bool bloquearEmisssaoComMesmoLocalDeOrigemEDestino = tipoOperacao?.BloquearEmisssaoComMesmoLocalDeOrigemEDestino ?? false;
                if (exgirInformarProduto && (cargaPedido.Pedido.Produtos == null || cargaPedido.Pedido.Produtos.Count == 0))
                {
                    erro = "O Tipo de Operação selecionado obriga a informação do produto do embarcador na etapa do Pedido.";
                    return false;
                }
                if (bloquearEmisssaoComMesmoLocalDeOrigemEDestino && cargaPedido.Destino != null && cargaPedido.Origem != null && cargaPedido.Destino.CodigoIBGE == cargaPedido.Origem.CodigoIBGE)
                {
                    erro = "O Tipo de Operação selecionado não permite a emissão de carga com a origem igual ao destino.";
                    return false;
                }

                if (finalizarCarga.HasValue && finalizarCarga.Value && !CodigoPedidoQueExisteNotaParcialSemNotaParaCargaPedido.Where(x => x == cargaPedido.Codigo).Any() && lstPedidoXMLNotaFiscal != null && lstPedidoXMLNotaFiscal.Where(x => x.CargaPedido.Codigo == cargaPedido.Codigo).ToList().Count() > 0)
                    cargaPedido.SituacaoEmissao = SituacaoNF.NFEnviada;

                if (configuracaoTMS.ValidarMunicipioDiferentePedido &&
                    cargaPedido.TipoPropostaMultimodal != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPropostaMultimodal.VAS &&
                    cargaPedido.NotasFiscais != null &&
                    cargaPedido.NotasFiscais.Count > 0 &&
                    (cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorta ||
                     cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorto ||
                     cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortoPorta))
                {
                    Dominio.Entidades.Localidade origemPedido = cargaPedido.Pedido.OrigemBooking;
                    Dominio.Entidades.Localidade destinoPedido = cargaPedido.Pedido.DestinoBooking;

                    foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal notaFiscal in cargaPedido.NotasFiscais)
                    {
                        if (notaFiscal.XMLNotaFiscal != null)
                        {
                            Dominio.Entidades.Localidade origemNotaFiscal = notaFiscal.XMLNotaFiscal != null && notaFiscal.XMLNotaFiscal.Expedidor != null ? notaFiscal.XMLNotaFiscal.Expedidor.Localidade : notaFiscal.XMLNotaFiscal.Emitente?.Localidade ?? null;
                            Dominio.Entidades.Localidade destinoNotaFiscal = notaFiscal.XMLNotaFiscal != null && notaFiscal.XMLNotaFiscal.Recebedor != null ? notaFiscal.XMLNotaFiscal.Recebedor.Localidade : notaFiscal.XMLNotaFiscal.Destinatario?.Localidade ?? null;

                            Dominio.Entidades.Localidade enderecoRecebedor = cargaPedido.Pedido.EnderecoRecebedor?.Localidade ?? cargaPedido.Recebedor?.Localidade ?? destinoNotaFiscal;
                            Dominio.Entidades.Localidade enderecoDestinatario = cargaPedido.Pedido.EnderecoDestino?.Localidade ?? destinoNotaFiscal;

                            if (cargaPedido.Recebedor == null && (cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorta || cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortoPorta)
                                && destinoPedido != null && enderecoDestinatario != null && enderecoDestinatario.Estado != null && enderecoDestinatario.Estado.Sigla != "EX" && destinoPedido.Codigo != enderecoDestinatario.Codigo)
                            {
                                erro = "A localidade do destino da nota de Nº " + notaFiscal.XMLNotaFiscal.Numero.ToString("D") + " (" + enderecoDestinatario.DescricaoCidadeEstado + ") é diferente da informada na carga (" + destinoPedido.DescricaoCidadeEstado + ").";
                                return false;
                            }
                            else if (destinoPedido != null && cargaPedido.Recebedor != null && (cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorta || cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortoPorta)
                                && enderecoRecebedor.Estado != null && enderecoRecebedor.Estado.Sigla != "EX" && destinoPedido.Codigo != enderecoRecebedor.Codigo)
                            {
                                erro = "A localidade do recebedor do pedido (" + enderecoRecebedor.DescricaoCidadeEstado + ") é diferente do destino informada na carga/booking (" + destinoPedido.DescricaoCidadeEstado + ").";
                                return false;
                            }

                            if (cargaPedido.Expedidor == null && (cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorta || cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorto)
                                && origemPedido != null && origemNotaFiscal != null && origemNotaFiscal.Estado != null && origemNotaFiscal.Estado.Sigla != "EX" && origemPedido.Codigo != origemNotaFiscal.Codigo)
                            {
                                erro = "A localidade da origem da nota de Nº " + notaFiscal.XMLNotaFiscal.Numero.ToString("D") + " (" + origemNotaFiscal.DescricaoCidadeEstado + ") é diferente da informada na carga (" + origemPedido.DescricaoCidadeEstado + ".)";
                                return false;
                            }
                            else if (origemPedido != null && cargaPedido.Expedidor != null && (cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorta || cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorto)
                                && cargaPedido.Expedidor.Localidade.Estado != null && cargaPedido.Expedidor.Localidade.Estado.Sigla != "EX" && origemPedido.Codigo != cargaPedido.Expedidor.Localidade.Codigo)
                            {
                                erro = "A localidade do expedidor do pedido (" + cargaPedido.Expedidor.Localidade.DescricaoCidadeEstado + ") é diferente da origem informada na carga/booking (" + origemPedido.DescricaoCidadeEstado + ".)";
                                return false;
                            }

                            var remarkSped = $"Receita de {carga?.TipoOperacao?.Descricao} {notaFiscal?.XMLNotaFiscal?.Numero.ToString("D")}";
                        }
                    }
                }
                else if (configuracaoTMS.ValidarMunicipioDiferentePedido &&
                    cargaPedido.TipoPropostaMultimodal != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPropostaMultimodal.VAS &&
                    cargaPedido.PedidoCTesParaSubContratacao != null &&
                    cargaPedido.PedidoCTesParaSubContratacao.Count > 0 &&
                    (cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorta ||
                     cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorto ||
                     cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortoPorta))
                {
                    Dominio.Entidades.Localidade origemPedido = cargaPedido.Pedido.OrigemBooking;
                    Dominio.Entidades.Localidade destinoPedido = cargaPedido.Pedido.DestinoBooking;

                    foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao cte in cargaPedido.PedidoCTesParaSubContratacao)
                    {
                        if (cte.CTeTerceiro != null)
                        {
                            Dominio.Entidades.Localidade origemNotaFiscal = cte.CTeTerceiro != null && cte.CTeTerceiro.Expedidor != null ? cte.CTeTerceiro.Expedidor.Localidade : cte.CTeTerceiro.Emitente?.Localidade ?? null;
                            Dominio.Entidades.Localidade destinoNotaFiscal = cte.CTeTerceiro != null && cte.CTeTerceiro.Recebedor != null ? cte.CTeTerceiro.Recebedor.Localidade : cte.CTeTerceiro.Destinatario?.Localidade ?? null;

                            Dominio.Entidades.Localidade enderecoRecebedor = cargaPedido.Pedido.EnderecoRecebedor?.Localidade ?? cargaPedido.Recebedor?.Localidade ?? destinoNotaFiscal;
                            Dominio.Entidades.Localidade enderecoDestinatario = cargaPedido.Pedido.EnderecoDestino?.Localidade ?? destinoNotaFiscal;

                            if (cargaPedido.Recebedor == null && (cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorta || cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortoPorta)
                                && destinoPedido != null && enderecoDestinatario != null && enderecoDestinatario.Estado != null && enderecoDestinatario.Estado.Sigla != "EX" && destinoPedido.Codigo != enderecoDestinatario.Codigo)
                            {
                                erro = "A localidade do destino do documento de Nº " + cte.CTeTerceiro.Numero.ToString("D") + " (" + enderecoDestinatario.DescricaoCidadeEstado + ") é diferente da informada na carga (" + destinoPedido.DescricaoCidadeEstado + ").";
                                return false;
                            }
                            else if (destinoPedido != null && cargaPedido.Recebedor != null && (cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorta || cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortoPorta)
                                && enderecoRecebedor.Estado != null && enderecoRecebedor.Estado.Sigla != "EX" && destinoPedido.Codigo != enderecoRecebedor.Codigo)
                            {
                                erro = "A localidade do recebedor do pedido (" + enderecoRecebedor.DescricaoCidadeEstado + ") é diferente do destino informada na carga/booking (" + destinoPedido.DescricaoCidadeEstado + ").";
                                return false;
                            }

                            if (cargaPedido.Expedidor == null && (cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorta || cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorto)
                                && origemPedido != null && origemNotaFiscal != null && origemNotaFiscal.Estado != null && origemNotaFiscal.Estado.Sigla != "EX" && origemPedido.Codigo != origemNotaFiscal.Codigo)
                            {
                                erro = "A localidade da origem do documento  de Nº " + cte.CTeTerceiro.Numero.ToString("D") + " (" + origemNotaFiscal.DescricaoCidadeEstado + ") é diferente da informada na carga (" + origemPedido.DescricaoCidadeEstado + ".)";
                                return false;
                            }
                            else if (origemPedido != null && cargaPedido.Expedidor != null && (cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorta || cargaPedido.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorto)
                                && cargaPedido.Expedidor.Localidade.Estado != null && cargaPedido.Expedidor.Localidade.Estado.Sigla != "EX" && origemPedido.Codigo != cargaPedido.Expedidor.Localidade.Codigo)
                            {
                                erro = "A localidade do expedidor do pedido (" + cargaPedido.Expedidor.Localidade.DescricaoCidadeEstado + ") é diferente da origem informada na carga/booking (" + origemPedido.DescricaoCidadeEstado + ".)";
                                return false;
                            }
                        }
                    }
                }
            }
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);

            if (repTipoIntegracao.ExistePorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Intercement))
            {
                Dominio.Entidades.Embarcador.Cargas.TipoIntegracao tipoIntegracaoCarga = null;
                if (carga.TipoOperacao != null && carga.TipoOperacao.UsarConfiguracaoEmissao && carga.TipoOperacao.TipoIntegracao != null)
                    tipoIntegracaoCarga = carga.TipoOperacao.TipoIntegracao;
                else if (carga.GrupoPessoaPrincipal != null && carga.GrupoPessoaPrincipal.TipoIntegracao != null)
                    tipoIntegracaoCarga = carga.GrupoPessoaPrincipal.TipoIntegracao;

                if (tipoIntegracaoCarga == null || tipoIntegracaoCarga.Tipo != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Intercement)
                {
                    List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> notasFiscais = repPedidoXMLNotaFiscal.BuscarNotasFiscaisPorCarga(carga.Codigo);
                    foreach (Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xmlNotaFiscal in notasFiscais)
                    {
                        if (repPedidoXMLNotaFiscal.ContemNotaFiscalEmOutraCarga(carga.Codigo, xmlNotaFiscal.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Intercement))
                        {
                            repXMLNotaFiscalComponente.DeletarPorXMLNotaFiscal(xmlNotaFiscal.Codigo);
                            xmlNotaFiscal.ValorFrete = 0;
                            repXmlNotaFiscal.Atualizar(xmlNotaFiscal);
                        }
                    }
                }
            }

            serCargaDadosSumarizados.AlterarDadosSumarizadosCarga(ref carga, cargaPedidos, configuracaoTMS, unitOfWork, tipoServicoMultisoftware);
            servicoAlteracaoPedido.ValidarAlteracaoPedidoPendenteAprovacao(carga);
            //AdicionarIntegracaoHUB(carga, unitOfWork);

            if (carga.ExigeNotaFiscalParaCalcularFrete && !carga.AvancouCargaEtapaDocumentoLote)
                new Servicos.Embarcador.Carga.CargaOperador(unitOfWork).Atualizar(carga, usuario, tipoServicoMultisoftware);

            carga.ProcessandoDocumentosFiscais = true;
            carga.DataInicioConfirmacaoDocumentosFiscais = DateTime.Now;
            carga.DataConfirmacaoDocumentosFiscais = DateTime.Now;

            if (carga.CargaEmitidaParcialmente)
            {
                carga.SituacaoCarga = SituacaoCarga.AgNFe;
                carga.PossuiPendencia = false;
                carga.MotivoPendencia = "";
                if (!carga.ExigeNotaFiscalParaCalcularFrete)
                {
                    carga.DataInicioEmissaoDocumentos = null;
                    carga.DataEnvioUltimaNFe = null;
                }
            }

            if (ValidarRecriarControleEntrega(carga, configuracaoTMS, unitOfWork, tipoServicoMultisoftware))
                Servicos.Embarcador.Carga.CargaRotaFrete.GerarIntegracoesRoteirizacaoCarga(carga, unitOfWork, configuracaoTMS, tipoServicoMultisoftware);

            if (configuracaoControleEntrega?.CalcularDataAgendamentoAutomaticamenteDataFaturamento ?? false)
                servicoPrevisaoControleEntrega.CalcularDataAgendamentoColetaEntregaAutomatico(carga, unitOfWork);

            if (naoValidarApolice)
                carga.NaoValidarValorLimiteApolice = true;

            repCarga.Atualizar(carga);

            if (!(carga.TipoOperacao?.NaoIntegrarOpentech ?? false) && !(carga.Veiculo?.NaoIntegrarOpentech ?? false))
                carga.AguardarIntegracaoEtapaTransportador = Servicos.WebService.NFe.NotaFiscal.AdicionarIntegracaoSM(carga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.OpenTech, configuracaoTMS.NaoAvancarEtapaComRejeicaoIntegracaoTransportadorRejeitada, carga.CargaEmitidaParcialmente, unitOfWork);

            if (auditado != null)
                Servicos.Auditoria.Auditoria.Auditar(auditado, carga, null, "Confirmou o envio dos documentos" + (avancoSemIntegracaoOrtec ? " mesmo sem integração Ortec" : "") + (liberouProdutosDivergentes ? " mesmo com divergência entre os produtos esperados e recebidos" : "") + (naoValidarApolice ? " mesmo com valor limite da apólice divergente" : "") + ".", unitOfWork);

            erro = string.Empty;
            return true;
        }

        public void AvancarEtapaAgNFe(Dominio.Entidades.Embarcador.Cargas.Carga carga)
        {
            carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe;
            carga.ProcessandoDocumentosFiscais = true;
            carga.DataInicioConfirmacaoDocumentosFiscais = DateTime.Now;
        }

        public static void AdicionarIntegracaoHUB(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.TipoIntegracao repositorioTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaIntegracaoHUBOfertas repositorioCargaIntegracaoHUB = new Repositorio.Embarcador.Cargas.CargaIntegracaoHUBOfertas(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.TipoIntegracao tipoIntegracao = repositorioTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.HUB);

            if (tipoIntegracao == null)
                return;


            if (!repositorioCargaIntegracaoHUB.ExistePorTipoIntegracao(carga.Codigo, tipoIntegracao.Codigo))
            {
                Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoHUBOfertas cargaIntegracao = new Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoHUBOfertas()
                {
                    Carga = carga,
                    TipoIntegracao = tipoIntegracao,
                    TipoEnvioHUBOfertas = TipoEnvioHUBOfertas.EnvioDemandaOferta,
                    ProblemaIntegracao = "",
                    DataIntegracao = DateTime.Now,
                    SituacaoIntegracao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoIntegracao.AgIntegracao
                };

                repositorioCargaIntegracaoHUB.Inserir(cargaIntegracao);
            }
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga GerarCargaPorCargaEPedidos(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos, Dominio.Entidades.Embarcador.Filiais.Filial filial, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, AdminMultisoftware.Dominio.Entidades.Pessoas.Cliente ClienteMultisoftware, Repositorio.UnitOfWork unitOfWork, DateTime? dataCarregamento, bool adicionarJanelaDescarregamento = true, bool adicionarJanelaCarregamento = true, NumeroReboque numeroReboque = NumeroReboque.SemReboque, TipoCarregamentoPedido tipoCarregamentoPedido = TipoCarregamentoPedido.Normal)
        {
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaFronteira repositorioCargaFronteira = new Repositorio.Embarcador.Cargas.CargaFronteira(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Logistica.CentroCarregamento repositorioCentroCarregamento = new Repositorio.Embarcador.Logistica.CentroCarregamento(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repositorioPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repositorioApoliceSeguroAverbacao = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);

            Servicos.Embarcador.Carga.Carga servicoCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);
            Servicos.Embarcador.Carga.CargaMotorista servicoCargaMotorista = new Servicos.Embarcador.Carga.CargaMotorista(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido = repositorioCargaPedido.BuscarPrimeiraPorCarga(carga.Codigo);
            bool montagemCargaPorPedidoProduto = false;

            if (filial != null)
            {
                Dominio.Entidades.Embarcador.Logistica.CentroCarregamento centroCarregamento = repositorioCentroCarregamento.BuscarPorFilial(filial.Codigo);
                montagemCargaPorPedidoProduto = centroCarregamento?.MontagemCarregamentoPedidoProduto ?? false;
            }

            Dominio.Entidades.Embarcador.Cargas.Carga cargaNova = new Dominio.Entidades.Embarcador.Cargas.Carga
            {
                Filial = filial
            };

            if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
            {
                cargaNova.NumeroSequenciaCarga = Servicos.Embarcador.Cargas.CargaSequencial.GetInstance().ObterProximoNumeroSequencial(unitOfWork);
                cargaNova.CodigoCargaEmbarcador = cargaNova.NumeroSequenciaCarga.ToString();
            }
            else
            {
                if (configuracaoEmbarcador.NumeroCargaSequencialUnico || (carga.Carregamento == null))
                {
                    cargaNova.NumeroSequenciaCarga = Servicos.Embarcador.Cargas.CargaSequencial.GetInstance().ObterProximoNumeroSequencial(unitOfWork);
                    cargaNova.CodigoCargaEmbarcador = cargaNova.NumeroSequenciaCarga.ToString();
                }
                else
                {
                    //#58808-DECATHLON- Cargas sendo gerada com o mesmo número por importação de arquivo e montagem carga.
                    if (repositorioCarga.ExisteCarga(carga.Carregamento.NumeroCarregamento, filial?.CodigoFilialEmbarcador ?? string.Empty, false))
                    {
                        cargaNova.NumeroSequenciaCarga = Servicos.Embarcador.Cargas.CargaSequencial.GetInstance().ObterProximoNumeroSequencial(unitOfWork);
                        cargaNova.CodigoCargaEmbarcador = cargaNova.NumeroSequenciaCarga.ToString();
                    }
                    else
                    {
                        cargaNova.CodigoCargaEmbarcador = carga.Carregamento.NumeroCarregamento;
                        cargaNova.NumeroSequenciaCarga = carga.Carregamento.AutoSequenciaNumero;
                    }
                }

                cargaNova.DataPrevisaoTerminoCarga = carga.DataPrevisaoTerminoCarga;
            }

            cargaNova.Carregamento = carga.Carregamento;
            cargaNova.TipoOperacao = carga.TipoOperacao ?? pedidos.FirstOrDefault().TipoOperacao;
            cargaNova.TipoCondicaoPagamento = carga.TipoCondicaoPagamento;
            cargaNova.CargaColeta = carga.CargaColeta;
            cargaNova.Rota = carga.Rota;
            cargaNova.CalcularFreteLote = carga.CalcularFreteLote;
            cargaNova.CargaDePreCarga = carga.CargaDePreCarga;
            cargaNova.TipoDeCarga = carga.TipoDeCarga ?? pedidos.FirstOrDefault().TipoDeCarga;
            cargaNova.NaoExigeVeiculoParaEmissao = carga.NaoExigeVeiculoParaEmissao;
            cargaNova.NaoGerarMDFe = carga.NaoGerarMDFe;
            cargaNova.PedidoViagemNavio = carga.PedidoViagemNavio;
            cargaNova.CargaSVMTerceiro = pedidos.FirstOrDefault().PedidoDeSVMTerceiro;
            cargaNova.DescontoSeguro = carga.DescontoSeguro;
            cargaNova.PercentualDescontoSeguro = carga.PercentualDescontoSeguro;
            cargaNova.CargaDestinadaCTeComplementar = carga.TipoOperacao?.OperacaoDestinadaCTeComplementar ?? false;

            if (carga.CargaDestinadaCTeComplementar)
            {
                string numeroOSMae = repositorioPedido.BuscarNumeroOSMae(pedidos.FirstOrDefault().Codigo);
                if (!string.IsNullOrWhiteSpace(numeroOSMae))
                    this.VincularMotoristaVeiculosOSMae(carga, pedidos.FirstOrDefault(), numeroOSMae, unitOfWork, tipoServicoMultisoftware, configuracaoEmbarcador);
            }

            List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro> apolicesSeguro = repositorioApoliceSeguroAverbacao.BuscarApolicesPorCargaPedido(cargaPedido.Codigo);

            new Servicos.Embarcador.Logistica.RestricaoRodagem(unitOfWork).ValidaAtualizaZonaExclusaoRota(cargaNova.Rota);

            string mensagemErro = servicoCarga.CriarCargaPorPedidos(ref cargaNova, pedidos, tipoServicoMultisoftware, apolicesSeguro, unitOfWork, configuracaoEmbarcador, null, montagemCargaPorPedidoProduto, numeroReboque, tipoCarregamentoPedido);

            if (!string.IsNullOrWhiteSpace(mensagemErro))
                throw new ServicoException(mensagemErro);

            cargaNova.Empresa = carga.Empresa;
            cargaNova.ModeloVeicularCarga = carga.ModeloVeicularCarga;
            cargaNova.Veiculo = carga.Veiculo;
            cargaNova.ModeloVeicularCarga = carga.ModeloVeicularCarga;
            cargaNova.VeiculosVinculados = carga.Veiculo?.VeiculosVinculados?.ToList();

            if (dataCarregamento.HasValue)
                cargaNova.DataCarregamentoCarga = dataCarregamento;

            servicoCargaMotorista.AdicionarMotoristas(carga, cargaNova);
            servicoCarga.FecharCarga(cargaNova, unitOfWork, tipoServicoMultisoftware, ClienteMultisoftware, false, adicionarJanelaDescarregamento, adicionarJanelaCarregamento);

            cargaNova.CargaFechada = true;

            repositorioCarga.Atualizar(cargaNova);

            CargaFronteira serCargaFronteira = new Servicos.Embarcador.Carga.CargaFronteira(unitOfWork);
            List<Dominio.Entidades.Embarcador.Cargas.CargaFronteira> fronteirasCargaAntiga = serCargaFronteira.ObterFronteirasPorCarga(carga);
            repositorioCargaFronteira.CopiarFronteirasParaCarga(fronteirasCargaAntiga, cargaNova);

            return cargaNova;
        }

        public void ValidarCapacidadeModeloVeicularCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, Repositorio.UnitOfWork unitOfWork)
        {
            if (carga.ModeloVeicularCarga == null)
                return;

            if (!configuracaoEmbarcador.ValidarCapacidadeModeloVeicularCargaNaMontagemCarga)
                return;

            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repositorioCargaPedido.BuscarPorCarga(carga.Codigo);
            string numeroCarga = ObterNumeroCarga(carga, configuracaoEmbarcador);
            decimal pesoTotal = cargaPedidos.Sum(o => o.Peso);
            decimal ocupacaoCubicaPaletes = (carga.TipoDeCarga?.Paletizado ?? false) ? carga.ModeloVeicularCarga.ObterOcupacaoCubicaPaletes() : 0m;
            decimal cubagemTotal = cargaPedidos.Sum(o => o.Pedido.CubagemTotal) + ocupacaoCubicaPaletes;
            decimal totalPallets = cargaPedidos.Sum(o => o.Pedido.NumeroPaletes + o.Pedido.NumeroPaletesFracionado);
            decimal toleranciaMinima = carga.ModeloVeicularCarga.ToleranciaPesoMenor;
            decimal toleranciaMaxima = carga.ModeloVeicularCarga.ToleranciaPesoExtra;
            decimal capacidadeMaxima = (carga.ModeloVeicularCarga.CapacidadePesoTransporte + toleranciaMaxima);

            if (pesoTotal > capacidadeMaxima)
                throw new ServicoException($"O peso de {pesoTotal.ToString("n2")} da carga {numeroCarga} excede a capacidade do modelo veicular de carga ({capacidadeMaxima.ToString("n2")})");

            if (pesoTotal < toleranciaMinima)
                throw new ServicoException($"O peso de {pesoTotal.ToString("n2")} da carga {numeroCarga} não atinge a tolerância mínima do modelo veicular de carga ({toleranciaMinima.ToString("n2")})");

            int capacidadePallet = 0;
            if (carga.ModeloVeicularCarga.NumeroPaletes.HasValue)
                capacidadePallet = carga.ModeloVeicularCarga.NumeroPaletes.Value;

            if (carga.ModeloVeicularCarga.VeiculoPaletizado && (totalPallets > capacidadePallet))
                throw new ServicoException($"O número de {totalPallets.ToString("n2")} pallets da carga {numeroCarga} excede a capacidade do modelo veicular de carga {((decimal)capacidadePallet).ToString("n2")}");

            if (carga.ModeloVeicularCarga.ModeloControlaCubagem && (cubagemTotal > carga.ModeloVeicularCarga.Cubagem))
                throw new ServicoException($"A cubagem de {cubagemTotal.ToString("n2")} da carga {numeroCarga} excede a capacidade do modelo veicular de carga {carga.ModeloVeicularCarga.Cubagem.ToString("n2")}");
        }

        public string ObterNumeroCarga(Dominio.Entidades.Embarcador.Cargas.CargaBase cargaBase, Repositorio.UnitOfWork unitOfWork)
        {
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao(); ;
            return ObterNumeroCarga(cargaBase, configuracaoEmbarcador);
        }

        public string ObterNumeroCarga(Dominio.Entidades.Embarcador.Cargas.CargaBase cargaBase, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador)
        {
            if (cargaBase == null)
                return string.Empty;

            if (!cargaBase.IsCarga())
                return ((Dominio.Entidades.Embarcador.PreCargas.PreCarga)cargaBase).NumeroPreCarga;

            Dominio.Entidades.Embarcador.Cargas.Carga carga = (Dominio.Entidades.Embarcador.Cargas.Carga)cargaBase;

            if (configuracaoEmbarcador.ExibirNumeroCargaQuandoExistirCarregamento || (carga.Carregamento == null))
                return carga.CodigoCargaEmbarcador;

            return carga.Carregamento.NumeroCarregamento;
        }

        public decimal ObterDistancia(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, Repositorio.UnitOfWork unitOfWork)
        {
            if (carga.Distancia > 0m)
                return carga.Distancia;

            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            decimal distanciaPorPedidos = repositorioCargaPedido.BuscarDistanciaPorCarga(carga.Codigo);

            if (distanciaPorPedidos > 0m)
                return distanciaPorPedidos;

            if (carga?.Carregamento?.Rota != null && configuracaoEmbarcador.SubstituirRoteirizacaoCarregamentoPorRoteirizacaoRotaFreteCarregamento && carga.Rota == carga.Carregamento?.Rota && carga.Rota?.Quilometros > 0m)
                return carga.Rota.Quilometros;

            if ((carga.Carregamento != null) && (configuracaoEmbarcador?.UtilizarDistanciaRoteirizacaoCarregamentoNaCarga ?? true)) // && !carga.CargaAgrupada) commentado pois foi tratado no agrupar carga somente manter o carregamento no agrupar pelo montagem carga.
            {
                Repositorio.Embarcador.Cargas.CargaCancelamento repCargaCancelamento = new Repositorio.Embarcador.Cargas.CargaCancelamento(unitOfWork);
                bool cargaDuplicada = repCargaCancelamento.VerificarCargaDuplicada(carga.Codigo);

                if (!cargaDuplicada)
                {
                    Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacao repositorioCarregamentoRoteirizacao = new Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacao(unitOfWork);
                    Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacao carregamentoRoteirizacao = repositorioCarregamentoRoteirizacao.BuscarPorCarregamento(carga.Carregamento.Codigo);

                    if (carregamentoRoteirizacao != null && carregamentoRoteirizacao.DistanciaKM > 0)
                        return (int)carregamentoRoteirizacao.DistanciaKM;
                }
            }

            if (carga.Rota?.Quilometros > 0m)
                return (int)carga.Rota.Quilometros;

            if (carga.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Concluido)
                return (int)(carga.DadosSumarizados?.Distancia ?? 0m);

            Repositorio.Embarcador.Cargas.CargaRotaFretePontosPassagem repositorioCargaRotaFretePontosPassagem = new Repositorio.Embarcador.Cargas.CargaRotaFretePontosPassagem(unitOfWork);
            decimal distanciaRotaFretePontosPassagem = repositorioCargaRotaFretePontosPassagem.BuscarDistanciaPorCarga(carga.Codigo);
            if (distanciaRotaFretePontosPassagem > 0m)
                return (distanciaRotaFretePontosPassagem / 1000);

            Repositorio.Embarcador.Cargas.CargaPercurso repositorioCargaPercurso = new Repositorio.Embarcador.Cargas.CargaPercurso(unitOfWork);

            return repositorioCargaPercurso.ConsultarDistanciaTotalPorCarga(carga.Codigo);
        }

        public bool RecebeuNumeroCargaEmbarcador(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            if (!carga.CargaPossuiOutrosNumerosEmbarcador)
                return false;

            Repositorio.Embarcador.Cargas.TipoIntegracao repositorioTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Dominio.Entidades.Embarcador.Cargas.TipoIntegracao tipoIntegracaoMinerva = repositorioTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Minerva);

            return tipoIntegracaoMinerva != null;
        }

        public void ValidarPermissaoAlterarDadosEtapaFrete(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            if ((carga.CargaAgrupamento != null) || (carga.CargaVinculada != null))
                throw new ServicoException("A carga foi agrupada, sendo assim não é possível alterá-la.");

            if (!carga.ExigeNotaFiscalParaCalcularFrete && RecebeuNumeroCargaEmbarcador(carga, unitOfWork))
                throw new ServicoException("A carga já recebeu o número de carga do Embarcador e não permite essa alteração.");
        }

        public void ValidarPermissaoAlterarDadosEtapaTransportadorOuDadosTransporte(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {
            bool permitirSalvarDadosTrasporteCargaEtapaNFe = (!carga.ExigeNotaFiscalParaCalcularFrete && (carga.SituacaoCarga == SituacaoCarga.AgNFe) && configuracaoEmbarcador.PermitirInformarDadosTransportadorCargaEtapaNFe);

            if (!permitirSalvarDadosTrasporteCargaEtapaNFe && !VerificarSeCargaEstaNaLogistica(carga, tipoServicoMultisoftware) && !(carga.TipoOperacao?.ConfiguracaoCarga?.ReceberAtualizacaoDeTransporteEmQualquerSituacaoCarga ?? false))
                throw new ServicoException($"A Atual situação da carga ({carga.DescricaoSituacaoCarga}) não permite essa alteração.");

            if (!carga.ExigeNotaFiscalParaCalcularFrete && RecebeuNumeroCargaEmbarcador(carga, unitOfWork))
                throw new ServicoException("A carga já recebeu o número de carga do Embarcador e não permite essa alteração.");
        }

        public void IntegrarAlteracaoOrdensEmbarque(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Usuario usuario, Repositorio.UnitOfWork unitOfWork)
        {
            Integracao.Marfrig.IntegracaoOrdemEmbarqueMarfrig servicoIntegracaoOrdemEmbarqueMarfrig = new Integracao.Marfrig.IntegracaoOrdemEmbarqueMarfrig(unitOfWork);

            if (!servicoIntegracaoOrdemEmbarqueMarfrig.PossuiOrdemEmbarque(carga))
                return;

            if (!VerificarAlteracoesDadosOrdemEmbarque(carga))
                return;

            servicoIntegracaoOrdemEmbarqueMarfrig.IntegrarAlteracaoOrdensEmbarque(carga, usuario);
        }

        public void AplicarAlteracaoCargaAoPlanejamentoFrota(Dominio.Entidades.Embarcador.Cargas.Carga carga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, AdminMultisoftware.Dominio.Entidades.Pessoas.Cliente cliente, string webServiceConsultaCTe, Repositorio.UnitOfWork unitOfWork)
        {
            Servicos.Embarcador.Frota.Frota servicoFrota = new Servicos.Embarcador.Frota.Frota(unitOfWork, tipoServicoMultisoftware, cliente, webServiceConsultaCTe);
            Repositorio.Embarcador.Frota.Frota repFrota = new Repositorio.Embarcador.Frota.Frota(unitOfWork);
            Repositorio.Embarcador.Frota.FrotaCarga repFrotaCarga = new Repositorio.Embarcador.Frota.FrotaCarga(unitOfWork);

            Dominio.Entidades.Veiculo veiculo = carga.Veiculo;
            Dominio.Entidades.Embarcador.Frota.Frota veiculoFrota;

            if (veiculo != null)
            {
                veiculoFrota = repFrota.BuscarPorVeiculoTracao(veiculo.Codigo);

                if (veiculoFrota != null)
                {
                    Dominio.Entidades.Embarcador.Frota.FrotaCarga frotaVinculada = repFrotaCarga.BuscarPorFrotaOuCargaEData(veiculoFrota.Codigo, carga.Codigo, carga.DataCarregamentoCarga.HasValue ? carga.DataCarregamentoCarga.Value : DateTime.Now.Date);

                    if (frotaVinculada == null)
                    {

                        if (carga.VeiculosVinculados?.Count() > 0 && (veiculoFrota.Reboque1 != null || veiculoFrota.Reboque2 != null))
                        {
                            //validar veiculos de acordo com a frota selecionada.
                            if (veiculoFrota.Reboque1 != null)
                            {
                                if (!carga.VeiculosVinculados.Contains(veiculoFrota.Reboque1))
                                    throw new ServicoException($"Não foi possível finalizar esta ação, verifique a frota vinculada ao veículo {veiculo.Placa} o veículo  {veiculoFrota.Reboque1.Placa} não foi selecionado. Favor acesse o Planejamento de Frota e ajuste os vínculos para a carga.");
                            }

                            if (veiculoFrota.Reboque2 != null)
                            {
                                if (!carga.VeiculosVinculados.Contains(veiculoFrota.Reboque2))
                                    throw new ServicoException($"Não foi possível finalizar esta ação, verifique a frota vinculada ao veículo {veiculo.Placa} o veículo  {veiculoFrota.Reboque2.Placa} não foi selecionado. Favor acesse o Planejamento de Frota e ajuste os vínculos para a carga.");
                            }
                        }

                        if (carga.Motoristas?.Count() > 0)
                        {
                            //validar veiculos de acordo com a frota selecionada.
                            if (veiculoFrota.Motorista != null)
                            {
                                if (!carga.Motoristas.Contains(veiculoFrota.Motorista))
                                    throw new ServicoException($"Não foi possível finalizar esta ação, verifique o motorista vinculado ao veículo  {veiculo.Placa} no planejamento frota, o motorista {veiculoFrota.Motorista.Descricao} não foi selecionado. Favor acesse o Planejamento de Frota e ajuste os vínculos para a carga.");
                            }

                            if (veiculoFrota.MotoristaAuxiliar != null)
                            {
                                if (!carga.Motoristas.Contains(veiculoFrota.MotoristaAuxiliar))
                                    throw new ServicoException($"Não foi possível finalizar esta ação, verifique o motorista vinculado ao veículo  {veiculo.Placa} no planejamento frota, o motorista {veiculoFrota.MotoristaAuxiliar.Descricao} não foi selecionado. Favor acesse o Planejamento de Frota e ajuste os vínculos para a carga.");
                            }

                            if (veiculoFrota.Motorista == null)
                            {
                                veiculoFrota.Motorista = carga.Motoristas.FirstOrDefault();

                                if (carga.Motoristas.Count() > 1)
                                    veiculoFrota.MotoristaAuxiliar = carga.Motoristas.LastOrDefault();

                                repFrota.Atualizar(veiculoFrota);
                            }
                        }

                        Dominio.Entidades.Embarcador.Frota.FrotaCarga frotaCarga = new Dominio.Entidades.Embarcador.Frota.FrotaCarga
                        {
                            Carga = carga,
                            DataCarregamento = carga.DataCarregamentoCarga.HasValue ? carga.DataCarregamentoCarga.Value : DateTime.Now.Date,
                            Frota = veiculoFrota,
                            DataPrevistaFimViagem = carga.DadosSumarizados.DataPrevisaoEntrega.HasValue ? carga.DadosSumarizados.DataPrevisaoEntrega.Value : carga.DataCarregamentoCarga,
                            DataPrevistaInicioViagem = carga.DadosSumarizados.DataPrevisaoSaida.HasValue ? carga.DadosSumarizados.DataPrevisaoSaida : carga.DataCarregamentoCarga,
                        };

                        repFrotaCarga.Inserir(frotaCarga);

                    }
                    else if (frotaVinculada.Carga.Codigo != carga.Codigo || frotaVinculada.Frota.Codigo != veiculoFrota.Codigo)
                    {
                        if (frotaVinculada.Carga.Codigo != carga.Codigo)
                            throw new ServicoException($"Não foi possível finalizar esta ação, pois frota pertencente ao veículo {veiculo.Placa} já esta vinculada a Carga {frotaVinculada.Carga.CodigoCargaEmbarcador} na data {carga.DataCarregamentoCarga?.ToString("dd/MM/yyyy") ?? ""}");
                        else if (frotaVinculada.Frota.Codigo != veiculoFrota.Codigo)
                            throw new ServicoException($"Não foi possível finalizar esta ação, pois Carga já esta vinculada a outra Frota na data {carga.DataCarregamentoCarga?.ToString("dd/MM/yyyy") ?? ""}");
                    }

                }

            }

        }

        public string ValidacaoInicialDosCamposObrigratorios(Dominio.ObjetosDeValor.WebService.Carga.CargaIntegracaoCompleta cargaIntegracaoCompleta, Repositorio.UnitOfWork unitOfWork)
        {
            if (string.IsNullOrWhiteSpace(cargaIntegracaoCompleta.NumeroCarga))
                return "Precisa informar o número da carga";

            if (cargaIntegracaoCompleta.Pedidos == null || cargaIntegracaoCompleta.Pedidos.Count == 0)
                return "Nenhum pedido informado. Por favor, adicione pelo menos 1 pedido.";

            Repositorio.Embarcador.Pedidos.Navio repNavio = new Repositorio.Embarcador.Pedidos.Navio(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoViagemNavio repPedidoViagemNavio = new Repositorio.Embarcador.Pedidos.PedidoViagemNavio(unitOfWork);
            Repositorio.Embarcador.Pedidos.TipoTerminalImportacao repTipoTerminalImportacao = new Repositorio.Embarcador.Pedidos.TipoTerminalImportacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.Porto repPorto = new Repositorio.Embarcador.Pedidos.Porto(unitOfWork);
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unitOfWork);
            Repositorio.Embarcador.Frete.ComponenteFrete repComponenteFrete = new Repositorio.Embarcador.Frete.ComponenteFrete(unitOfWork);

            foreach (var pedido in cargaIntegracaoCompleta.Pedidos)
            {

                if (pedido.Viagem?.Navio != null)
                {
                    string codigoIMO = pedido.Viagem.Navio.CodigoIMO;
                    string codigoIrin = pedido.Viagem.Navio.CodigoIRIN;

                    var navio = repNavio.BuscarTodosPorCodigoIMOConcatIRIN(codigoIMO, codigoIrin);

                    if (navio == null)
                        return "Navio não localizado";
                }


                if (pedido.ViagemLongoCurso?.Navio != null)
                {
                    string codigoIMO = pedido.ViagemLongoCurso.Navio.CodigoIMO;
                    string codigoIrin = pedido.ViagemLongoCurso.Navio.CodigoIRIN;

                    var navio = repNavio.BuscarTodosPorCodigoIMOConcatIRIN(codigoIMO, codigoIrin);

                    if (navio == null)
                        return "Navio não localizado";
                }

                if (pedido.Transbordo != null && pedido.Transbordo.Count > 0)
                {
                    foreach (var transbordo in pedido.Transbordo)
                    {
                        if (transbordo.Navio != null)
                        {
                            string codigoIMO = transbordo.Navio.CodigoIMO;
                            string codigoIrin = transbordo.Navio.CodigoIRIN;

                            var navio = repNavio.BuscarTodosPorCodigoIMOConcatIRIN(codigoIMO, codigoIrin);

                            if (navio == null)
                                return "Navio não localizado";
                        }


                        if (transbordo.Viagem?.Navio != null)
                        {
                            string codigoIMO = transbordo.Viagem?.Navio.CodigoIMO;
                            string codigoIrin = transbordo.Viagem?.Navio.CodigoIRIN;

                            var navio = repNavio.BuscarTodosPorCodigoIMOConcatIRIN(codigoIMO, codigoIrin);

                            if (navio == null)
                                return "Navio não localizado";
                        }
                    }
                }

                if (pedido.Viagem != null)
                {
                    int numeroViagem = pedido.Viagem.NumeroViagem;
                    var direcao = pedido.Viagem.Direcao;
                    string codigoIMO = pedido.Viagem.Navio.CodigoIMO;
                    string codigoIrin = pedido.Viagem.Navio.CodigoIRIN;

                    var navio = repPedidoViagemNavio.BuscarPorNumeroViagemDirecaoNavio(numeroViagem, direcao, codigoIMO, codigoIrin);
                    if (navio == null)
                        return "Navio/Viagem/Direção não localizada";
                }

                if (pedido.ViagemLongoCurso != null && pedido.ViagemLongoCurso.Navio != null)
                {
                    int numeroViagem = pedido.ViagemLongoCurso.NumeroViagem;
                    var direcao = pedido.ViagemLongoCurso.Direcao;
                    string codigoIMO = pedido.ViagemLongoCurso.Navio.CodigoIMO;
                    string codigoIrin = pedido.ViagemLongoCurso.Navio.CodigoIRIN;

                    var navio = repPedidoViagemNavio.BuscarPorNumeroViagemDirecaoNavio(numeroViagem, direcao, codigoIMO, codigoIrin);
                    if (navio == null)
                        return "Navio/Viagem/Direção não localizada";
                }

                if (pedido.Transbordo != null && pedido.Transbordo.Count > 0)
                {
                    foreach (var transbordo in pedido.Transbordo)
                    {
                        if (transbordo.Viagem != null && transbordo.Viagem.Navio != null)
                        {
                            int numeroViagem = transbordo.Viagem.NumeroViagem;
                            var direcao = transbordo.Viagem.Direcao;
                            string codigoIMO = transbordo.Viagem.Navio.CodigoIMO;
                            string codigoIrin = transbordo.Viagem.Navio.CodigoIRIN;

                            var navio = repPedidoViagemNavio.BuscarPorNumeroViagemDirecaoNavio(numeroViagem, direcao, codigoIMO, codigoIrin);
                            if (navio == null)
                                return "Navio/Viagem/Direção não localizada";
                        }
                    }
                }

                if (!string.IsNullOrWhiteSpace(pedido.TerminalPortoOrigem?.CodigoTerminal))
                {
                    string codigoTerminalOrigem = pedido.TerminalPortoOrigem.CodigoTerminal;
                    var terminalOrigem = repTipoTerminalImportacao.BuscarPorCodigoTerminal(codigoTerminalOrigem);
                    if (terminalOrigem == null)
                        return "Terminal Portuário não localizado";
                }

                if (!string.IsNullOrWhiteSpace(pedido.TerminalPortoDestino?.CodigoTerminal))
                {
                    string codigoTerminalDestino = pedido.TerminalPortoDestino.CodigoTerminal;
                    var terminalDestino = repTipoTerminalImportacao.BuscarPorCodigoTerminal(codigoTerminalDestino);
                    if (terminalDestino == null)
                        return "Terminal Portuário não localizado";
                }

                if (pedido.Transbordo != null && pedido.Transbordo.Any())
                {
                    foreach (var transbordo in pedido.Transbordo)
                    {
                        if (!string.IsNullOrWhiteSpace(transbordo.Terminal?.CodigoTerminal))
                        {
                            string codigoTerminalTransbordo = transbordo.Terminal.CodigoTerminal;
                            var terminalTransbordo = repTipoTerminalImportacao.BuscarPorCodigoTerminal(codigoTerminalTransbordo);
                            if (terminalTransbordo == null)
                                return "Terminal Portuário não localizado";
                        }
                    }
                }

                if (!string.IsNullOrWhiteSpace(pedido.PortoOrigem?.CodigoMercante))
                {
                    string codigoMercanteOrigem = pedido.PortoOrigem.CodigoMercante;
                    var portoOrigem = repPorto.BuscarPorCodigoMercante(codigoMercanteOrigem);
                    if (portoOrigem == null)
                        return "Porto não localizado";
                }

                if (!string.IsNullOrWhiteSpace(pedido.PortoDestino?.CodigoMercante))
                {
                    string codigoMercanteDestino = pedido.PortoDestino.CodigoMercante;
                    var portoDestino = repPorto.BuscarPorCodigoMercante(codigoMercanteDestino);
                    if (portoDestino == null)
                        return "Porto não localizado";
                }

                if (pedido.Transbordo != null && pedido.Transbordo.Any())
                {
                    foreach (var transbordo in pedido.Transbordo)
                    {
                        if (!string.IsNullOrWhiteSpace(transbordo.Porto?.CodigoMercante))
                        {
                            string codigoMercanteTransbordo = transbordo.Porto.CodigoMercante;
                            var portoTransbordo = repPorto.BuscarPorCodigoMercante(codigoMercanteTransbordo);
                            if (portoTransbordo == null)
                                return "Porto não localizado";
                        }
                    }
                }

                if (!string.IsNullOrWhiteSpace(pedido.TransportadoraEmitentePedido?.CNPJ) && !string.IsNullOrWhiteSpace(pedido.TransportadoraEmitentePedido?.IE))
                {
                    string cnpj = pedido.TransportadoraEmitentePedido.CNPJ;
                    string inscricaoEstadual = pedido.TransportadoraEmitentePedido.IE;

                    var empresa = repEmpresa.BuscarPorCNPJEInscricaoEstadual(cnpj, inscricaoEstadual);

                    if (empresa == null)
                        return "Empresa/Filial não localizada";

                }


                if (pedido.ValorFrete?.ComponentesAdicionais != null)
                {
                    foreach (var componenteAdicional in pedido.ValorFrete.ComponentesAdicionais)
                    {
                        if (componenteAdicional.Componente?.CodigoIntegracao != null)
                        {
                            var componente = repComponenteFrete.BuscarPorCodigoIntegracao(componenteAdicional.Componente.CodigoIntegracao);
                            if (componente == null)
                            {
                                return "Componente de frete não localizado";
                            }
                        }
                    }
                }
            }

            return string.Empty;
        }

        public void SetarPrevisaoEntregaPedidos(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaDadosSumarizados repCargaDadosSumarizados = new Repositorio.Embarcador.Cargas.CargaDadosSumarizados(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.CargaDadosSumarizados cargaDadosSumarizados = repCargaDadosSumarizados.BuscarPorCarga(carga.Codigo);

            if (cargaDadosSumarizados?.DiasItinerario > 0)
            {
                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo);
                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
                {
                    Dominio.Entidades.Embarcador.Pedidos.Pedido pedido = cargaPedido.Pedido;

                    if (pedido.DataInicialColeta.HasValue && pedido.DiasItinerario > 0)
                    {
                        pedido.PrevisaoEntrega = pedido.DataInicialColeta.Value.AddDays(pedido.DiasItinerario);
                        repPedido.Atualizar(pedido);
                    }
                }
            }
        }

        public List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao> ObterTipoIntegracoesPorTipoOperacaoETipoCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.TipoDeCargaIntegracao repositorioTipoDeCargaIntegracao = new Repositorio.Embarcador.Cargas.TipoDeCargaIntegracao(unitOfWork);

            List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao> integracoesPorTipoOperacaoETipoCarga = new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao>();
            if (carga.TipoOperacao?.Integracoes?.Count > 0)
                integracoesPorTipoOperacaoETipoCarga.AddRange(carga.TipoOperacao.Integracoes.Select(o => o.Tipo).ToList());

            List<Dominio.Entidades.Embarcador.Cargas.TipoDeCargaIntegracao> integracoesTipoCarga = carga.TipoDeCarga != null ? repositorioTipoDeCargaIntegracao.BuscarPorTipoCarga(carga.TipoDeCarga.Codigo) : null;
            if (integracoesTipoCarga?.Count > 0)
                integracoesPorTipoOperacaoETipoCarga.AddRange(integracoesTipoCarga.Select(o => o.Tipo).ToList());

            if (integracoesPorTipoOperacaoETipoCarga.Count > 0)
                integracoesPorTipoOperacaoETipoCarga = integracoesPorTipoOperacaoETipoCarga.Distinct().ToList();

            return integracoesPorTipoOperacaoETipoCarga;
        }

        public Dominio.ObjetosDeValor.Embarcador.Importacao.RetornoImportacao Importar(List<Dominio.ObjetosDeValor.Embarcador.Importacao.DadosLinha> linhas, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Entidades.Pessoas.ClienteURLAcesso ClienteAcesso, AdminMultisoftware.Repositorio.UnitOfWork unitOfWorkAdmin, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado)
        {
            Repositorio.Embarcador.Cargas.Carga respositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Usuario repositorioUsuario = new Repositorio.Usuario(unitOfWork);
            Repositorio.Veiculo repositorioVeiculo = new Repositorio.Veiculo(unitOfWork);
            Repositorio.Embarcador.Cargas.ModeloVeicularCarga repositorioModeloVeicularCarga = new Repositorio.Embarcador.Cargas.ModeloVeicularCarga(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoDeCarga repositorioTipoDeCarga = new Repositorio.Embarcador.Cargas.TipoDeCarga(unitOfWork);
            Repositorio.Embarcador.Pedidos.TipoOperacao repositorioTipoOperacao = new Repositorio.Embarcador.Pedidos.TipoOperacao(unitOfWork);
            Repositorio.Empresa repositorioTransportador = new Repositorio.Empresa(unitOfWork);
            Repositorio.Embarcador.Pedidos.StageAgrupamento repositorioStageAgrupamento = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);

            Servicos.Embarcador.Carga.CargaMotorista servicoCargaMotorista = new Servicos.Embarcador.Carga.CargaMotorista(unitOfWork);
            Servicos.Embarcador.Carga.Carga servicoCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);

            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS config = repConfiguracaoTMS.BuscarConfiguracaoPadrao();

            Dominio.ObjetosDeValor.Embarcador.Importacao.RetornoImportacao retornoImportacao = new Dominio.ObjetosDeValor.Embarcador.Importacao.RetornoImportacao();

            retornoImportacao.Retornolinhas = new List<Dominio.ObjetosDeValor.Embarcador.Importacao.RetonoLinha>();

            int vinculacaoConSucesso = 0;

            for (int i = 0; i < linhas.Count; i++)
            {
                try
                {
                    unitOfWork.FlushAndClear();
                    unitOfWork.Start();

                    string retorno = "";

                    Dominio.ObjetosDeValor.Embarcador.Importacao.DadosLinha linha = linhas[i];

                    Dominio.ObjetosDeValor.Embarcador.Importacao.DadosColuna colunaNumeroCarga = (from obj in linha.Colunas where obj.NomeCampo == "NumeroCarga" select obj).FirstOrDefault();
                    Dominio.ObjetosDeValor.Embarcador.Importacao.DadosColuna colunaPlacaVeiculo = (from obj in linha.Colunas where obj.NomeCampo == "PlacaVeiculo" select obj).FirstOrDefault();
                    Dominio.ObjetosDeValor.Embarcador.Importacao.DadosColuna colunaCpfMotorista = (from obj in linha.Colunas where obj.NomeCampo == "CpfMotorista" select obj).FirstOrDefault();
                    Dominio.ObjetosDeValor.Embarcador.Importacao.DadosColuna colunaNomeMotorista = (from obj in linha.Colunas where obj.NomeCampo == "NomeMotorista" select obj).FirstOrDefault();
                    Dominio.ObjetosDeValor.Embarcador.Importacao.DadosColuna colunaDataCheckoutVeiculo = (from obj in linha.Colunas where obj.NomeCampo == "DataCheckoutVeiculo" select obj).FirstOrDefault();
                    Dominio.ObjetosDeValor.Embarcador.Importacao.DadosColuna colunaTipoCheckin = (from obj in linha.Colunas where obj.NomeCampo == "TipoCheckin" select obj).FirstOrDefault();
                    Dominio.ObjetosDeValor.Embarcador.Importacao.DadosColuna colunaNroEixosCheckin = (from obj in linha.Colunas where obj.NomeCampo == "NroEixosCheckin" select obj).FirstOrDefault();
                    Dominio.ObjetosDeValor.Embarcador.Importacao.DadosColuna colunaPlacaReboque = (from obj in linha.Colunas where obj.NomeCampo == "PlacaReboque" select obj).FirstOrDefault();
                    Dominio.ObjetosDeValor.Embarcador.Importacao.DadosColuna colunaNumeroVeiculo = (from obj in linha.Colunas where obj.NomeCampo == "NumeroVeiculo" select obj).FirstOrDefault();
                    Dominio.ObjetosDeValor.Embarcador.Importacao.DadosColuna colunaTipoCarga = (from obj in linha.Colunas where obj.NomeCampo == "TipoCarga" select obj).FirstOrDefault();
                    Dominio.ObjetosDeValor.Embarcador.Importacao.DadosColuna colunaModeloVeicular = (from obj in linha.Colunas where obj.NomeCampo == "ModeloVeicular" select obj).FirstOrDefault();
                    Dominio.ObjetosDeValor.Embarcador.Importacao.DadosColuna colunaCNPJTransportador = (from obj in linha.Colunas where obj.NomeCampo == "CNPJTransportador" select obj).FirstOrDefault();
                    Dominio.ObjetosDeValor.Embarcador.Importacao.DadosColuna colunaTipoOperacao = (from obj in linha.Colunas where obj.NomeCampo == "TipoOperacao" select obj).FirstOrDefault();

                    Dominio.Entidades.Embarcador.Cargas.Carga existeCarga = null;

                    try
                    {
                        dynamic nroCargaSemEspacos = colunaNumeroCarga.Valor.Trim();
                        existeCarga = respositorioCarga.PesquisaPorCodigoEmbarcadorSituacaoValida(nroCargaSemEspacos);

                        if (existeCarga == null)
                            throw new ServicoException("Carga não encontrada, ou está em uma situação inválida para importação.");

                        string dadosValidos = VerificarFormatoDados(colunaCpfMotorista?.Valor, colunaDataCheckoutVeiculo?.Valor);

                        if (!string.IsNullOrEmpty(dadosValidos))
                            throw new ServicoException("Os dados do CPF Motorista ou Data Checkout Veículo estão com um formato errado.");

                        Dominio.ObjetosDeValor.Embarcador.Carga.CargaDadosTransporte dadosTrans = new Dominio.ObjetosDeValor.Embarcador.Carga.CargaDadosTransporte();
                        Dominio.Entidades.Veiculo existeVeiculo = repositorioVeiculo.BuscarPlaca(colunaPlacaVeiculo?.Valor);
                        Dominio.Entidades.Usuario existeMotorista = repositorioUsuario.BuscarMotoristaPorCPF(colunaCpfMotorista?.Valor);

                        if (colunaPlacaVeiculo != null && !string.IsNullOrEmpty(colunaPlacaVeiculo.Valor) && existeVeiculo == null)
                            retorno = "O veículo não esta cadastrado";


                        List<Dominio.Entidades.Veiculo> reboques = new List<Dominio.Entidades.Veiculo>();
                        if (existeVeiculo != null)
                        {
                            List<string> listaPlacasReboques = ((string)colunaPlacaReboque?.Valor).ToString().Split(';').ToList();

                            Dominio.Entidades.Veiculo reboqueVeiculo = null;

                            foreach (string placa in listaPlacasReboques)
                            {
                                reboqueVeiculo = repositorioVeiculo.BuscarPorPlaca(placa);

                                if (reboqueVeiculo == null)
                                    retorno = "Reboque não informado ou não encontrado!";

                                if (reboqueVeiculo.TipoVeiculo != "1")
                                    retorno = $"A Placa {reboqueVeiculo.Placa} não é de tipo reboque.";

                                if (colunaNumeroVeiculo == null)
                                    dadosTrans.CodigoReboque = reboqueVeiculo.Codigo;

                                reboques.Add(reboqueVeiculo);
                            }

                            if (existeVeiculo.TipoVeiculo != "0")
                                retorno = $"A Placa {colunaPlacaVeiculo?.Valor} não é de tipo tração.";

                            existeCarga.Veiculo = existeVeiculo;
                        }

                        if (!string.IsNullOrEmpty(colunaNumeroVeiculo?.Valor))
                        {
                            int.TryParse((string)colunaNumeroVeiculo.Valor, out int numeroVeiculo);
                            Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento existeStagePorNumeroVeiculo = repositorioStageAgrupamento.BuscarPorCargaENumeroVeiculo(existeCarga.Codigo, numeroVeiculo);

                            if (existeStagePorNumeroVeiculo == null)
                                retorno = $"Não foi possível achar o agrupamento da stagem com o número de veículo ({colunaNumeroVeiculo.Valor})";

                            if (existeStagePorNumeroVeiculo != null)
                            {
                                existeStagePorNumeroVeiculo.Veiculo = existeVeiculo;
                                existeStagePorNumeroVeiculo.Motorista = existeMotorista;

                                for (int index = 0; index < reboques.Count; index++)
                                {
                                    Dominio.Entidades.Veiculo reboque = reboques[index];
                                    if (index == 1)
                                    {
                                        existeStagePorNumeroVeiculo.SegundoReboque = reboque;
                                        continue;
                                    }
                                    existeStagePorNumeroVeiculo.Reboque = reboque;
                                }
                                repositorioStageAgrupamento.Atualizar(existeStagePorNumeroVeiculo);
                            }

                        }

                        List<Dominio.Entidades.Usuario> listaMotorista = new List<Dominio.Entidades.Usuario>();

                        if (!string.IsNullOrEmpty(colunaPlacaVeiculo?.Valor) && !string.IsNullOrEmpty(colunaNomeMotorista?.Valor))
                        {
                            existeMotorista = new Dominio.Entidades.Usuario();
                            existeMotorista.CPF = colunaCpfMotorista?.Valor;
                            existeMotorista.Nome = colunaNomeMotorista?.Valor;
                            existeMotorista.Tipo = "M";
                            existeMotorista.Status = "A";

                            if (config.CadastrarMotoristaMobileAutomaticamente)
                            {
                                existeMotorista.NaoBloquearAcessoSimultaneo = true;
                                string retornoMobile = Servicos.Usuario.ConfigurarUsuarioMobile(ref existeMotorista, null, ClienteAcesso, unitOfWorkAdmin);

                                if (!string.IsNullOrWhiteSpace(retornoMobile))
                                    retorno = retornoMobile;
                            }
                            existeMotorista.Empresa = existeCarga.Empresa;

                            repositorioUsuario.Inserir(existeMotorista);
                            listaMotorista.Add(existeMotorista);
                            dadosTrans.ListaCodigoMotorista.Add(existeMotorista.Codigo);
                        }


                        dadosTrans.Carga = existeCarga;
                        dadosTrans.CodigoTracao = existeVeiculo?.Codigo ?? 0;
                        dadosTrans.CodigoEmpresa = existeCarga?.Empresa?.Codigo ?? 0;

                        if (existeCarga.TipoDeCarga != null)
                            dadosTrans.CodigoTipoCarga = existeCarga.TipoDeCarga.Codigo;

                        if (existeCarga.TipoOperacao != null)
                            dadosTrans.CodigoTipoOperacao = existeCarga.TipoOperacao.Codigo;

                        if (existeCarga.ModeloVeicularCarga != null)
                            dadosTrans.CodigoModeloVeicular = existeCarga.ModeloVeicularCarga.Codigo;

                        if (!string.IsNullOrEmpty(colunaDataCheckoutVeiculo?.Valor))
                            dadosTrans.DataCheckout = Convert.ToDateTime(colunaDataCheckoutVeiculo?.Valor);

                        if (!string.IsNullOrEmpty(colunaTipoCheckin?.Valor))
                        {
                            int.TryParse((string)colunaTipoCheckin.Valor, out int tipoCheck);
                            dadosTrans.Carga.TipoCheckin = (TipoCheckin)tipoCheck;
                        }

                        if (!string.IsNullOrEmpty(colunaNroEixosCheckin?.Valor))
                        {
                            int.TryParse((string)colunaNroEixosCheckin.Valor, out int numeroEixos);
                            dadosTrans.Carga.NumeroEixosCheckin = numeroEixos;
                        }

                        string codigoIntegracaoModeloVeicular = "";
                        if (!string.IsNullOrEmpty(colunaModeloVeicular?.Valor))
                        {
                            codigoIntegracaoModeloVeicular = colunaModeloVeicular.Valor;

                            Dominio.Entidades.Embarcador.Cargas.ModeloVeicularCarga modeloVeicularCarga = repositorioModeloVeicularCarga.buscarPorCodigoIntegracao(codigoIntegracaoModeloVeicular);

                            if (modeloVeicularCarga == null)
                                throw new ServicoException("Modelo Veicular não encontrado por esse Código de Integração.");

                            dadosTrans.CodigoModeloVeicular = modeloVeicularCarga.Codigo;
                        }

                        string codigoIntegracaoTipoDeCarga = "";
                        if (!string.IsNullOrEmpty(colunaTipoCarga?.Valor))
                        {
                            codigoIntegracaoTipoDeCarga = colunaTipoCarga.Valor;

                            Dominio.Entidades.Embarcador.Cargas.TipoDeCarga tipoDeCarga = repositorioTipoDeCarga.BuscarPorCodigoEmbarcador(codigoIntegracaoTipoDeCarga);

                            if (tipoDeCarga == null)
                                throw new ServicoException("Tipo de Carga não encontrado por esse Código de Integração.");

                            dadosTrans.CodigoTipoCarga = tipoDeCarga.Codigo;
                        }

                        string codigoIntegracaoTipoOperacao = "";
                        if (!string.IsNullOrEmpty(colunaTipoOperacao?.Valor))
                        {
                            codigoIntegracaoTipoOperacao = colunaTipoOperacao.Valor;

                            Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacao = repositorioTipoOperacao.BuscarPorCodigoIntegracao(codigoIntegracaoTipoOperacao);

                            if (tipoOperacao == null)
                                throw new ServicoException("Tipo Operação não encontrado por esse Código de Integração.");

                            dadosTrans.CodigoTipoOperacao = tipoOperacao.Codigo;
                        }

                        string cnpjTransportador = "";
                        if (!string.IsNullOrEmpty(colunaCNPJTransportador?.Valor))
                        {
                            cnpjTransportador = colunaCNPJTransportador.Valor;

                            Dominio.Entidades.Empresa transportador = repositorioTransportador.BuscarPorCodigoIntegracao(cnpjTransportador);

                            cnpjTransportador = ((string)colunaCNPJTransportador.Valor).ObterSomenteNumeros();

                            if (transportador == null)
                                transportador = repositorioTransportador.BuscarPorCNPJ(cnpjTransportador);

                            if (transportador == null)
                                throw new ServicoException("CNPJ do Transportador não encontrado.");

                            dadosTrans.CodigoEmpresa = transportador.Codigo;
                        }

                        string mensagemErro = "";
                        dynamic retornoDadosTransportador = servicoCarga.SalvarDadosTransporteCarga(dadosTrans, out mensagemErro, null, false, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador, string.Empty, null, auditado, unitOfWork);

                        if (retornoDadosTransportador == null)
                            throw new ServicoException("Falha ao salvar os dados do transportador.");

                        Servicos.Auditoria.Auditoria.Auditar(auditado, existeCarga, "Dados de Transporte atualizados via importação de planilha", unitOfWork);

                        servicoCargaMotorista.AtualizarMotoristas(existeCarga, listaMotorista);
                        if (existeMotorista != null)
                            repositorioUsuario.Atualizar(existeMotorista);
                        respositorioCarga.Atualizar(existeCarga);

                        vinculacaoConSucesso++;
                        Dominio.ObjetosDeValor.Embarcador.Importacao.RetonoLinha retornoLinha = new Dominio.ObjetosDeValor.Embarcador.Importacao.RetonoLinha() { indice = i, processou = true, mensagemFalha = "" };
                        retornoImportacao.Retornolinhas.Add(retornoLinha);
                        unitOfWork.CommitChanges();
                    }
                    catch (ServicoException excecao)
                    {
                        Servicos.Log.TratarErro(excecao);
                        retornoImportacao.Retornolinhas.Add(RetornarFalhaLinha(excecao.Message, i));
                    }
                }
                catch (Exception excecao)
                {
                    unitOfWork.Rollback();
                    Servicos.Log.TratarErro(excecao);

                    retornoImportacao.Retornolinhas.Add(RetornarFalhaLinha("Ocorreu uma falha ao processar a linha.", i));
                }
            }

            retornoImportacao.MensagemAviso = "";
            retornoImportacao.Total = linhas.Count;
            retornoImportacao.Importados = vinculacaoConSucesso;
            return retornoImportacao;
        }

        public bool IsDadosTransporteinformados(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            if (carga.Empresa == null)
                return false;

            if (carga.Veiculo == null)
                return false;

            if (!new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork).ExistePorCarga(carga.Codigo))
                return false;

            return true;
        }

        public bool LiberarEtapaEmisao(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, TipoServicoMultisoftware tipoServicoMultisoftware, string webServiceConsultaCTe, out string mensagem)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.TipoOperacaoTipoCarga repositorioTipoOperacaoTipoCarga = new Repositorio.Embarcador.Pedidos.TipoOperacaoTipoCarga(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repositorioConfiguracaoEmbarcador = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Servicos.Embarcador.Carga.Carga svcCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);

            if (carga.SituacaoCarga != SituacaoCarga.CalculoFrete && !carga.PossuiPendencia)
            {
                mensagem = "Carga está numa situação que não é possivel avançar";
                return false;
            }

            List<int> tiposCargaTipoOperacao = repositorioTipoOperacaoTipoCarga.BuscarCodigosTiposCargasPorTipoOperacao(carga.TipoOperacao?.Codigo ?? 0);

            if (tiposCargaTipoOperacao.Count > 0 && carga.TipoDeCarga != null)
                if (tiposCargaTipoOperacao.Contains(carga.TipoDeCarga.Codigo))
                {
                    mensagem = "Esse tipo de carga não permite que os Documentos sejam emitidos.";
                    return false;
                }

            if (((carga.TipoOperacao?.AvancarEtapaFreteAutomaticamente ?? false) || (carga.TipoOperacao?.AvancarCargaAutomaticaAposMontagem ?? false)) &&
                !carga.NaoAvancarAutomaticamenteEtapaFretePorPendencia &&
                !carga.CargaSVM &&
                !carga.PossuiPendencia &&
                (carga.SituacaoAlteracaoFreteCarga == SituacaoAlteracaoFreteCarga.NaoInformada || carga.SituacaoAlteracaoFreteCarga == SituacaoAlteracaoFreteCarga.Aprovada || carga.SituacaoAlteracaoFreteCarga == SituacaoAlteracaoFreteCarga.Reprovada))
            {
                mensagem = "O avanço da carga ocorrerá automaticamente, não sendo possível realizar esta ação.";
                return false;
            }

            if (carga.ModeloVeicularCarga != null && carga.ModeloVeicularCarga.AlertarOperadorPesoExcederCapacidade)
            {
                decimal PesoCarga = carga.DadosSumarizados != null ? carga.DadosSumarizados.PesoLiquidoTotal : 0;
                decimal capacidadeModeloVeicular = carga.ModeloVeicularCarga.CapacidadePesoTransporte + carga.ModeloVeicularCarga.ToleranciaPesoExtra;
                if (PesoCarga > capacidadeModeloVeicular)
                    //o usuario foi alertado e liberou, sistema deve armazenar na auditoria da carta que o usuario liberou a emissão;
                    Servicos.Auditoria.Auditoria.Auditar(auditado, carga, null, "Liberou a emissão da carga ciente que o peso era superior a capacidade do modelo veicular", unitOfWork);
            }

            if ((carga.TipoOperacao?.ExigeProcImportacaoPedido ?? false) && repCargaPedido.PedidosNaoPossuiProcImportacao(carga.Codigo))
            {
                mensagem = "Existem pedidos na carga que não possuem Proc. Importação, não sendo possível realizar esta ação.";
                return false;
            }


            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = repositorioConfiguracaoEmbarcador.BuscarConfiguracaoPadrao();

            if (!svcCarga.IniciarEmissaoDocumentosCarga(out mensagem, out object retorno, carga, null, auditado, configuracaoEmbarcador, tipoServicoMultisoftware, unitOfWork, webServiceConsultaCTe))
                return false;

            mensagem = string.Empty;
            return true;
        }

        public void IntegrarCargasDiaAnteriorEMPAsync(Repositorio.UnitOfWork unitOfWork)
        {
            Servicos.WebService.Carga.Carga serCarga = new WebService.Carga.Carga();

            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Configuracoes.IntegracaoEMP repConfiguracaoIntegracaoEMP = new Repositorio.Embarcador.Configuracoes.IntegracaoEMP(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracao = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Repositorio.Embarcador.Integracao.IntegracaoEMPLog repIntegracaoEMPLog = new Repositorio.Embarcador.Integracao.IntegracaoEMPLog(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = repConfiguracao.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoEMP configuracaoIntegracaoEMP = repConfiguracaoIntegracaoEMP.Buscar();

            if (configuracaoIntegracaoEMP == null || !configuracaoIntegracaoEMP.AtivarEnvioCTesAnterioresEMP)
                return;
            try
            {


                int limite = 5;
                int inicio = 0;

                DateTime dataFinal = DateTime.Now.Date.AddDays(-1);
                DateTime dataInicial = DateTime.Now.Date.AddDays(-1);

                List<Dominio.Entidades.Embarcador.Cargas.Carga> listaCargas = repCarga.ConsultarCargasPorPeriodo(dataInicial, dataFinal, inicio, limite);
                if (listaCargas == null || listaCargas.Count == 0)
                {
                    Dominio.Entidades.Embarcador.Integracao.IntegracaoEMPLog integracaoEMPLog = new Dominio.Entidades.Embarcador.Integracao.IntegracaoEMPLog()
                    {
                        ArquivoEnvio = "",
                        ArquivoRetorno = "",
                        DataEnvio = DateTime.Now,
                        MensageRetorno = "Não foi localizado nenhuma Carga para realizar a integração",
                        StatusIntegracaoEMP = StatusIntegracaoEMP.NotPersisted,
                        Topic = configuracaoIntegracaoEMP?.TopicBuscarFaturaCTeEMP
                    };
                    repIntegracaoEMPLog.Inserir(integracaoEMPLog);
                    return;
                }
                List<int> codigosCarga = listaCargas.Select(o => o.Codigo).ToList();
                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargasPedido = repCargaPedido.BuscarCargasPedidoPorCodigosCarga(codigosCarga);

                string mensagem = string.Empty;

                List<Dominio.ObjetosDeValor.WebService.Carga.CargaIntegracao> cargasEnvio = serCarga.BuscarCargasPedidos(cargasPedido, configuracaoTMS, ref mensagem, unitOfWork);

                ProducerConfig config = new ProducerConfig
                {
                    BootstrapServers = configuracaoIntegracaoEMP?.BoostrapServersEMP ?? string.Empty,
                    SaslUsername = configuracaoIntegracaoEMP?.UsuarioEMP ?? string.Empty,
                    SaslPassword = configuracaoIntegracaoEMP?.SenhaEMP ?? string.Empty,
                    SecurityProtocol = SecurityProtocol.SaslSsl,
                    SaslMechanism = SaslMechanism.Plain,
                    Acks = Acks.Leader,
                    SslEndpointIdentificationAlgorithm = SslEndpointIdentificationAlgorithm.Https
                };
                Message<Null, string> kafkaMessage = new Message<Null, string>();
                kafkaMessage.Value = JsonConvert.SerializeObject(cargasEnvio);

                if (string.IsNullOrEmpty(config.SaslUsername) || string.IsNullOrEmpty(config.SaslPassword))
                    return;

                using (IProducer<Null, string> producer = new ProducerBuilder<Null, string>(config).Build())
                {
                    //try
                    //{
                    producer.Produce(configuracaoIntegracaoEMP?.TopicBuscarCargaEMP ?? string.Empty, kafkaMessage, handler);
                    //}
                    //catch (ProduceException<string, string> e)
                    //{
                    //   Servicos.Log.TratarErro($"Failed to deliver message: {e.Error.Reason}");
                    //}
                    producer.Flush(TimeSpan.FromSeconds(60));
                }
            }
            catch (Exception excecao)
            {
                Dominio.Entidades.Embarcador.Integracao.IntegracaoEMPLog integracaoEMPLog = new Dominio.Entidades.Embarcador.Integracao.IntegracaoEMPLog()
                {
                    ArquivoEnvio = "",
                    ArquivoRetorno = "",
                    DataEnvio = DateTime.Now,
                    MensageRetorno = "Falha ao integrar Cargas anterior: " + excecao.Message.Left(1500),
                    StatusIntegracaoEMP = StatusIntegracaoEMP.NotPersisted,
                    Topic = configuracaoIntegracaoEMP?.TopicBuscarCargaEMP
                };
                repIntegracaoEMPLog.Inserir(integracaoEMPLog);

                Servicos.Log.TratarErro($"Falha ao integrar Cargas anterior: {excecao.Message}");
            }
        }

        public void MostrarPedidosNaMontagemCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos, Repositorio.UnitOfWork unitOfWork)
        {
            VisibilidadeDosPedidosNaMontagemCarga(carga, pedidos, unitOfWork, false);
        }

        public void RemoverPedidosDaMontagemCarga(List<Dominio.Entidades.Embarcador.Cargas.Carga> cargas, List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos, Repositorio.UnitOfWork unitOfWork)
        {
            foreach (Dominio.Entidades.Embarcador.Cargas.Carga carga in cargas)
                VisibilidadeDosPedidosNaMontagemCarga(carga, pedidos, unitOfWork, true);
        }

        public void VisibilidadesDasCargas(List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos, Dominio.Entidades.Embarcador.Cargas.MontagemCarga.Carregamento carregamento, Repositorio.UnitOfWork unitOfWork, bool fechada)
        {
            if (pedidos.Count <= 0 || !(carregamento.TipoOperacao?.ConfiguracaoCarga?.DeixarPedidosDisponiveisParaMontegemCarga ?? false))
                return;

            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            List<int> codigoCargas = repositorioCargaPedido.BuscarCodigoCargaPorPedidosComTipoOperacao((from obj in pedidos select obj.Codigo).ToList());
            List<Dominio.Entidades.Embarcador.Cargas.Carga> cargas = repositorioCarga.BuscarPorCodigos(codigoCargas);

            foreach (Dominio.Entidades.Embarcador.Cargas.Carga carga in cargas)
            {
                carga.CargaFechada = fechada;
                repositorioCarga.Atualizar(carga);
            }

            if (!fechada)
                RemoverPedidosDaMontagemCarga(cargas, pedidos, unitOfWork);

        }

        public void GerarCargaEspelho(Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, bool cargaRetornoVazio = false)
        {
            CargaMotorista servicoCargaMotorista = new CargaMotorista(unitOfWork);
            CargaPedido servicoCargaPedido = new CargaPedido(unitOfWork);
            Servicos.Embarcador.Carga.CTe servicoCTe = new Embarcador.Carga.CTe(unitOfWork);
            Servicos.Embarcador.Carga.FilialEmissora servicoFilialEmissora = new Embarcador.Carga.FilialEmissora();
            Servicos.Embarcador.Canhotos.Canhoto servicoCanhoto = new Canhotos.Canhoto(unitOfWork);

            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.Pacote repositorioPacote = new Repositorio.Embarcador.Cargas.Pacote(unitOfWork);
            Repositorio.Embarcador.CTe.CTeTerceiro repositorioCTeTerceiro = new Repositorio.Embarcador.CTe.CTeTerceiro(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoPacote repositorioCargaPedidoPacote = new Repositorio.Embarcador.Cargas.CargaPedidoPacote(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaLocaisPrestacao repositorioCargaLocaisPrestacao = new Repositorio.Embarcador.Cargas.CargaLocaisPrestacao(unitOfWork);
            Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntregaPedido repositorioCargaEntregaPedido = new Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntregaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaLocaisPrestacaoPassagens repositorioCargaLocaisPrestacaoPassagens = new Repositorio.Embarcador.Cargas.CargaLocaisPrestacaoPassagens(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga repositorioConfiguracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repositorioPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoCanhoto repositorioConfiguracaoCanhoto = new Repositorio.Embarcador.Configuracoes.ConfiguracaoCanhoto(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaNFeAnexo repositorioCargaNFeAnexo = new Repositorio.Embarcador.Cargas.CargaNFeAnexo(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga = repositorioConfiguracaoGeralCarga.BuscarPrimeiroRegistro();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoCanhoto configuracaoCanhoto = repositorioConfiguracaoCanhoto.BuscarConfiguracaoPadrao();

            Dominio.Entidades.Empresa empresa = cargaAntiga.Empresa;

            bool existePacote = repositorioPacote.ExistePacote();
            bool gerarCargaDeSubcontratacao = false;
            Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacao = null;
            if (cargaRetornoVazio)
                tipoOperacao = cargaAntiga.TipoOperacao.ConfiguracaoCarga.TipoOperacaoCargaRetornoColetasRejeitadas;
            else
                tipoOperacao = cargaAntiga.TipoOperacao.ConfiguracaoCarga.TipoOperacaoCargaEspelho;

            if (repositorioCarga.ContemCargaDuplicadaNumeracaoTipoOperacao(cargaAntiga.CodigoCargaEmbarcador, tipoOperacao?.Codigo ?? 0))
                return;

            if ((cargaAntiga.TipoOperacao?.ConfiguracaoCarga?.InformarTransportadorSubcontratadoEtapaUm ?? false) && cargaAntiga.EmpresaSubcontrada != null)
            {
                empresa = cargaAntiga.EmpresaSubcontrada;
                gerarCargaDeSubcontratacao = true;
            }

            Dominio.Entidades.Embarcador.Cargas.Carga cargaNova = new Dominio.Entidades.Embarcador.Cargas.Carga()
            {
                AgImportacaoCTe = false,
                AgImportacaoMDFe = false,
                AguardandoEmissaoDocumentoAnterior = false,
                AutorizouTodosCTes = false,
                CargaFechada = false,
                CodigoCargaEmbarcador = cargaAntiga.CodigoCargaEmbarcador,
                ControlaTempoParaEmissao = cargaAntiga.ControlaTempoParaEmissao,
                DataCarregamentoCarga = cargaAntiga.DataCarregamentoCarga,
                DataEnvioUltimaNFe = null,
                DataInicioEmissaoDocumentos = null,
                DataFinalPrevisaoCarregamento = cargaAntiga.DataFinalPrevisaoCarregamento,
                DataInicialPrevisaoCarregamento = cargaAntiga.DataInicialPrevisaoCarregamento,
                DataPrevisaoTerminoCarga = cargaAntiga.DataPrevisaoTerminoCarga,
                Empresa = empresa,
                ExigeNotaFiscalParaCalcularFrete = tipoOperacao?.ExigeNotaFiscalParaCalcularFrete ?? cargaAntiga.ExigeNotaFiscalParaCalcularFrete,
                Filial = cargaAntiga.Filial,
                FreteDeTerceiro = cargaAntiga.FreteDeTerceiro,
                GrupoPessoaPrincipal = cargaAntiga.GrupoPessoaPrincipal,
                NaoExigeVeiculoParaEmissao = tipoOperacao?.NaoExigeVeiculoParaEmissao ?? cargaAntiga.NaoExigeVeiculoParaEmissao,
                Operador = cargaAntiga.Operador,
                PrioridadeEnvioIntegracao = cargaAntiga.PrioridadeEnvioIntegracao,
                NaoGerarMDFe = tipoOperacao?.NaoEmitirMDFe ?? cargaAntiga.NaoGerarMDFe,
                SegmentoGrupoPessoas = cargaAntiga.SegmentoGrupoPessoas,
                SegmentoModeloVeicularCarga = cargaAntiga.SegmentoModeloVeicularCarga,
                SituacaoCarga = SituacaoCarga.Nova,
                TabelaFrete = null,
                TipoDeCarga = cargaAntiga.TipoDeCarga,
                CalcularFreteLote = cargaAntiga.CalcularFreteLote,
                ModeloVeicularCarga = cargaAntiga.ModeloVeicularCarga,
                TipoFreteEscolhido = TipoFreteEscolhido.Tabela,
                TipoOperacao = tipoOperacao,
                ValorFrete = 0,
                ValorFreteAPagar = 0,
                ValorFreteEmbarcador = 0,
                ValorFreteLeilao = 0,
                ValorFreteLiquido = 0,
                ValorFreteOperador = 0,
                ValorFreteTabelaFrete = 0,
                ValorICMS = 0,
                ValorISS = 0,
                ValorRetencaoISS = 0m,
                VeiculoIntegradoEmbarcador = cargaAntiga.VeiculoIntegradoEmbarcador,
                Veiculo = cargaAntiga.Veiculo,
                LiberadaParaEmissaoCTeSubContratacaoFilialEmissora = false,
                EmpresaFilialEmissora = null,
                CargaEspelho = cargaAntiga,
            };

            Servicos.Log.TratarErro($"2 - Carga: {cargaAntiga.CodigoCargaEmbarcador} Antiga: {cargaAntiga.Codigo}", "CargaEspelhoGeracao");

            repositorioCarga.Inserir(cargaNova);

            Servicos.Log.TratarErro($"3 - Carga: {cargaAntiga.CodigoCargaEmbarcador} Nova: {cargaNova.Codigo}", "CargaEspelhoGeracao");

            string mensagemAuditoria = gerarCargaDeSubcontratacao ? "Carga espelho gerada ao finalizar primeira carga" : (cargaRetornoVazio ? "Carga espelho gerada ao rejeitar todas as coletas" : "Carga espelho gerada ao confirmar entrega");
            if (auditado == null)
            {
                auditado = new Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado()
                {
                    OrigemAuditado = Dominio.ObjetosDeValor.Enumerador.OrigemAuditado.Sistema,
                    TipoAuditado = Dominio.ObjetosDeValor.Enumerador.TipoAuditado.Sistema,
                    Texto = mensagemAuditoria
                };
            }
            Servicos.Auditoria.Auditoria.Auditar(auditado, cargaNova, null, mensagemAuditoria, unitOfWork);

            cargaNova.Protocolo = cargaNova.Codigo;
            cargaNova.VeiculosVinculados = new List<Dominio.Entidades.Veiculo>();

            foreach (Dominio.Entidades.Veiculo veiculo in cargaAntiga.VeiculosVinculados.ToList())
                cargaNova.VeiculosVinculados.Add(veiculo);

            servicoCargaMotorista.AdicionarMotoristas(cargaAntiga, cargaNova);

            repositorioCarga.Atualizar(cargaNova);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repositorioCargaPedido.BuscarPorCarga(cargaAntiga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntregaPedido> cargaEntregaPedidos = repositorioCargaEntregaPedido.BuscarPorCargaPedidos(cargaPedidos.Select(obj => obj.Codigo).ToList());
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoPacote> cargaPedidoPacotesAntigo = repositorioCargaPedidoPacote.BuscarCargaPedidoPacotePorCarga(cargaAntiga.Codigo);
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> pedidosXMLNotasFiscais = repositorioPedidoXMLNotaFiscal.BuscarPorCargaPedidos(cargaPedidos.Select(obj => obj.Codigo).ToList());

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosNovaCarga = new List<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
            {
                Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntregaPedido cargaEntregaPedidoAtual = cargaEntregaPedidos.Where(obj => obj.CargaPedido.Codigo == cargaPedido.Codigo).FirstOrDefault();

                if ((cargaEntregaPedidoAtual?.CargaEntrega?.Coleta ?? false) && cargaEntregaPedidoAtual.CargaEntrega.Situacao == SituacaoEntrega.Rejeitado && (cargaEntregaPedidoAtual.CargaEntrega.MotivoRejeicao?.Descricao.Equals("Coleta zerada") ?? false))
                    continue;

                Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoClonado = cargaPedido.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaPedidoClonado);

                cargaPedidoClonado.Carga = cargaNova;
                cargaPedidoClonado.CargaOrigem = cargaNova;
                cargaPedidoClonado.Pedido = cargaPedido.Pedido;
                cargaPedidoClonado.Recebedor = cargaPedido.Recebedor;
                cargaPedidoClonado.Expedidor = cargaPedido.Expedidor;
                cargaPedidoClonado.ModeloDocumentoFiscal = tipoOperacao?.ModeloDocumentoFiscal;
                cargaPedidoClonado.CargaPedidoFilialEmissora = false;
                cargaPedidoClonado.RegraTomador = null;
                cargaPedidoClonado.PedidoSemNFe = false;

                Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeParticipantes tipoEmissaoCTeParticipantes = ValidarTipoEmissaoCTeParticipantes(configuracaoGeralCarga, tipoOperacao);

                cargaPedidoClonado.TipoEmissaoCTeParticipantes = tipoEmissaoCTeParticipantes;
                cargaPedidoClonado.TipoContratacaoCarga = gerarCargaDeSubcontratacao ? TipoContratacaoCarga.SubContratada : ValidarTipoContratacaoCarga(tipoEmissaoCTeParticipantes);

                bool cargaDeComplemento = false;
                if (tipoOperacao != null && tipoOperacao.GerarCTeComplementarNaCarga)
                {
                    cargaPedidoClonado.TipoContratacaoCarga = TipoContratacaoCarga.Redespacho;
                    cargaDeComplemento = true;

                    if (cargaPedido.TipoTomador == Dominio.Enumeradores.TipoTomador.Remetente)
                        cargaPedidoClonado.TipoTomador = Dominio.Enumeradores.TipoTomador.Destinatario;
                    else if (cargaPedido.TipoTomador == Dominio.Enumeradores.TipoTomador.Destinatario)
                        cargaPedidoClonado.TipoTomador = Dominio.Enumeradores.TipoTomador.Remetente;
                }

                cargaPedidoClonado.Origem = cargaPedidoClonado.Expedidor != null ? cargaPedidoClonado.Expedidor.Localidade : cargaPedido.Pedido.Remetente.Localidade;
                cargaPedidoClonado.Destino = cargaPedidoClonado.Recebedor != null ? cargaPedidoClonado.Recebedor.Localidade : cargaPedido.Pedido.Destinatario.Localidade;
                cargaPedidoClonado.ValorFrete = 0;
                cargaPedidoClonado.PendenteGerarCargaDistribuidor = false;
                cargaPedidoClonado.ValorFreteAPagar = 0;
                cargaPedidoClonado.CargaRedespacho = null;
                cargaPedidoClonado.ValorFreteAPagarFilialEmissora = 0;
                cargaPedidoClonado.ValorFreteTabelaFrete = 0;
                cargaPedidoClonado.ValorFreteTabelaFreteFilialEmissora = 0;
                cargaPedidoClonado.ImpostoInformadoPeloEmbarcador = false;
                cargaPedidoClonado.ValorFreteFilialEmissora = 0;
                cargaPedidoClonado.BaseCalculoICMS = 0;
                cargaPedidoClonado.CargaPedidoProximoTrecho = null;
                cargaPedidoClonado.CargaPedidoTrechoAnterior = null;
                cargaPedidoClonado.ValorICMS = 0;
                cargaPedidoClonado.ValorAdValorem = 0;
                cargaPedidoClonado.ValorDescarga = 0;
                cargaPedidoClonado.TipoRateio = servicoCTe.BuscarTipoEmissaoDocumentosCTe(cargaPedidoClonado, tipoServicoMultisoftware, unitOfWork);

                bool possuiCTe = false;
                bool possuiNFS = false;
                bool possuiNFSManual = false;
                Dominio.Entidades.ModeloDocumentoFiscal modeloDocumentoIntramunicipal = null;

                if (!cargaDeComplemento)
                {
                    servicoCargaPedido.VerificarQuaisDocumentosDeveEmitir(cargaNova, cargaPedidoClonado, cargaPedidoClonado.Origem, cargaPedidoClonado.Destino, tipoServicoMultisoftware, unitOfWork, out possuiCTe, out possuiNFS, out possuiNFSManual, out modeloDocumentoIntramunicipal, configuracaoTMS, out bool sempreDisponibilizarDocumentoNFSManual);

                    cargaPedidoClonado.DisponibilizarDocumentoNFSManual = sempreDisponibilizarDocumentoNFSManual;
                    cargaPedidoClonado.PossuiCTe = possuiCTe;
                    cargaPedidoClonado.PossuiNFS = possuiNFS;
                    cargaPedidoClonado.PossuiNFSManual = possuiNFSManual;

                    if (gerarCargaDeSubcontratacao && (possuiNFSManual || cargaAntiga.Internacional))
                        cargaPedidoClonado.TipoContratacaoCarga = TipoContratacaoCarga.Normal;
                }
                else
                {
                    cargaPedidoClonado.PossuiCTe = cargaPedido.PossuiCTe;
                    cargaPedidoClonado.PossuiNFS = cargaPedido.PossuiNFS;
                    cargaPedidoClonado.PossuiNFSManual = cargaPedido.PossuiNFSManual;
                }

                repositorioCargaPedido.Inserir(cargaPedidoClonado);
                cargaPedidosNovaCarga.Add(cargaPedidoClonado);

                if (existePacote && cargaPedidoPacotesAntigo != null && cargaPedidoPacotesAntigo.Count > 0)
                {
                    List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoPacote> listaPacotesCargaPedido = cargaPedidoPacotesAntigo.FindAll(cpp => cpp.CargaPedido.Codigo == cargaPedido.Codigo);
                    foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoPacote cargaPedidoPacoteAntigo in listaPacotesCargaPedido)
                    {
                        Dominio.Entidades.Embarcador.Cargas.CargaPedidoPacote cargaPedidoPacote = new Dominio.Entidades.Embarcador.Cargas.CargaPedidoPacote
                        {
                            CargaPedido = cargaPedidoClonado,
                            Pacote = cargaPedidoPacoteAntigo.Pacote
                        };

                        repositorioCargaPedidoPacote.Inserir(cargaPedidoPacote);

                        List<Dominio.Entidades.Embarcador.CTe.CTeTerceiro> ctesTerceiro = repositorioCTeTerceiro.BuscarPorIdentificacaoPacote(cargaPedidoPacote.Pacote.LogKey);
                        foreach (Dominio.Entidades.Embarcador.CTe.CTeTerceiro cteTerceiro in ctesTerceiro)
                        {
                            string retorno = new Servicos.Embarcador.Pacote.Pacote(unitOfWork, tipoServicoMultisoftware).VincularCTeCargaPedidoPacoteAsync(cargaPedidoPacote, cteTerceiro).GetAwaiter().GetResult();
                            if (!string.IsNullOrWhiteSpace(retorno))
                                Servicos.Log.TratarErro($"Erro ao passar CTe para a carga espelho - {retorno}", "CargaEspelhoGeracao");
                        }
                    }
                }

                if (cargaAntiga.TipoOperacao?.ConfiguracaoCarga?.GerarCargaEspelhoAutomaticamenteAoFinalizarCarga ?? false)
                    servicoFilialEmissora.GerarCTesAnteriores(cargaPedido, cargaPedidoClonado, tipoServicoMultisoftware, unitOfWork, configuracaoTMS);

                if (cargaAntiga.Internacional && (cargaPedidoClonado.ModeloDocumentoFiscal?.DocumentoTipoCRT ?? false))
                {
                    foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscalAntiga in pedidosXMLNotasFiscais)
                    {
                        Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscalNovo = pedidoXMLNotaFiscalAntiga.Clonar();

                        Utilidades.Object.DefinirListasGenericasComoNulas(pedidoXMLNotaFiscalNovo);

                        pedidoXMLNotaFiscalNovo.CargaPedido = cargaPedidoClonado;

                        repositorioPedidoXMLNotaFiscal.Inserir(pedidoXMLNotaFiscalNovo);

                        servicoCanhoto.SalvarCanhotoNota(pedidoXMLNotaFiscalNovo.XMLNotaFiscal, cargaPedidoClonado, cargaPedidoClonado.Carga.Terceiro, cargaAntiga.Motoristas.ToList(), tipoServicoMultisoftware, configuracaoTMS, unitOfWork, configuracaoCanhoto);
                    }
                }
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacao> listaCargaLocaisPrestacao = repositorioCargaLocaisPrestacao.BuscarPorCarga(cargaAntiga.Codigo);
            foreach (Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacao cargaLocaisPrestacao in listaCargaLocaisPrestacao)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacao novaCargaLocaisPrestacao = cargaLocaisPrestacao.Clonar();
                novaCargaLocaisPrestacao.Carga = cargaNova;
                repositorioCargaLocaisPrestacao.Inserir(novaCargaLocaisPrestacao);

                List<Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacaoPassagens> listaCargaLocaisPrestacaoPassagens = repositorioCargaLocaisPrestacaoPassagens.BuscarPorLocalPrestacao(cargaLocaisPrestacao.Codigo);

                foreach (Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacaoPassagens cargaLocaisPrestacaoPassagem in listaCargaLocaisPrestacaoPassagens)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacaoPassagens novaCargaLocaisPrestacaoPassagens = cargaLocaisPrestacaoPassagem.Clonar();
                    novaCargaLocaisPrestacaoPassagens.CargaLocaisPrestacao = novaCargaLocaisPrestacao;
                    repositorioCargaLocaisPrestacaoPassagens.Inserir(novaCargaLocaisPrestacaoPassagens);
                }
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaNFeAnexo> cargaNFeAnexos = repositorioCargaNFeAnexo.BuscarPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaNFeAnexo cargaNFeAnexo in cargaNFeAnexos)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaNFeAnexo novaCargaNFeAnexo = cargaNFeAnexo.Clonar();
                novaCargaNFeAnexo.EntidadeAnexo = cargaNova;

                repositorioCargaNFeAnexo.Inserir(novaCargaNFeAnexo);
            }

            if (cargaAntiga.Rota != null)
                Servicos.Embarcador.Carga.RotaFrete.SetarRotaCarga(ref cargaNova, cargaPedidosNovaCarga, pedidosXMLNotasFiscais, cargaAntiga.Rota, configuracaoTMS, unitOfWork, tipoServicoMultisoftware);

            FecharCarga(cargaNova, unitOfWork, tipoServicoMultisoftware, ClienteMultisoftware: null);
            cargaNova.CargaFechada = true;

            SalvarDistanciaCargaNova(cargaAntiga, cargaNova, cargaPedidosNovaCarga, pedidosXMLNotasFiscais, configuracaoTMS, tipoServicoMultisoftware, unitOfWork);

            repositorioCarga.Atualizar(cargaNova);

            Servicos.Log.TratarErro($"4 - Carga: {cargaAntiga.CodigoCargaEmbarcador} Nova: {cargaNova.Codigo}", "CargaEspelhoGeracao");
        }

        private void GerarDocumentoTipoOutrosCargaPedido(UnitOfWork unitOfWork, TipoServicoMultisoftware tipoServicoMultisoftware, ConfiguracaoTMS configuracaoTMS, Auditado auditado, Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoClonado)
        {
            Servicos.Embarcador.Pedido.NotaFiscal serCargaNotaFiscal = new Servicos.Embarcador.Pedido.NotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);

            Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xmlNotaFiscal = new Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal()
            {
                CNPJTranposrtador = "",
                DataEmissao = DateTime.Now,
                Descricao = "Outros",
                Destinatario = cargaPedidoClonado?.Pedido?.Destinatario ?? new Dominio.Entidades.Cliente(),
                Emitente = cargaPedidoClonado?.Pedido?.Remetente ?? new Dominio.Entidades.Cliente(),
                Modelo = "99",
                nfAtiva = true,
                Numero = 1,
                PlacaVeiculoNotaFiscal = "",
                Serie = "",
                TipoDocumento = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoDocumento.Outros,
                TipoOperacaoNotaFiscal = TipoOperacaoNotaFiscal.Saida,
                XML = "",
                DataRecebimento = DateTime.Now,
                Peso = 1m,
                Valor = 1m
            };
            repXMLNotaFiscal.Inserir(xmlNotaFiscal);

            serCargaNotaFiscal.InserirNotaCargaPedido(xmlNotaFiscal, cargaPedidoClonado, tipoServicoMultisoftware, TipoNotaFiscal.Venda, configuracaoTMS, false, out bool alteradoTipoDeCarga, auditado);
        }

        public dynamic RetornarEtapa(int codigoCarga, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, bool permiteRetornarEtapaComNfeVinculadas = true, bool apenasRetornarEtapa = false)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigo(codigoCarga);

            if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe && !(carga?.TipoOperacao?.ConfiguracaoTransportador?.PermitirRetornarEtapa ?? false))
                throw new ServicoException("Não é possível retornar a etapa de transporte, por favor consulte o embarcador.");

            if (carga.PossuiOperacaoContainer)
                throw new ServicoException("Não é possível retornar a etapa de container.");

            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfigEmbarcador = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);

            Servicos.NFe serNFe = new Servicos.NFe(unitOfWork);
            Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = repConfigEmbarcador.BuscarConfiguracaoPadrao();
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo);

            int numeroNF = 0;
            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
            {
                numeroNF += repPedidoXMLNotaFiscal.ContarXMLPorCargaPedido(cargaPedido.Codigo);
            }

            bool possuiIntegracaoMinerva = repTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Minerva) != null;

            if (possuiIntegracaoMinerva && carga.CarregamentoIntegradoERP)
                throw new ServicoException("Não é possível retornar etapa pois sistema da Minerva já confirmou integração do carregamento.");
            else if (configuracaoEmbarcador.PermitirRetornoAgNotasFiscais && carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe && (numeroNF == 0 || permiteRetornarEtapaComNfeVinculadas))
            {
                if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador)
                {
                    if (!carga.ExigeNotaFiscalParaCalcularFrete)
                        carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgTransportador;
                    else
                        carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova;
                }
                else if (!possuiIntegracaoMinerva)
                {
                    if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
                        carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova;
                    else
                        carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete;
                }
                else
                    carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgTransportador;

                if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete)
                    Servicos.Log.TratarErro("Atualizou a situação para calculo frete 45 Carga " + carga.CodigoCargaEmbarcador, "AtualizouSituacaoCalculoFrete");

                Servicos.Auditoria.Auditoria.Auditar(auditado, carga, null, "Retornou Etapa NFe da Carga.", unitOfWork);
                repCarga.Atualizar(carga);

                if (carga.CargaAgrupamento != null || carga.CargaVinculada != null)
                    throw new ServicoException("A carga foi agrupada, sendo assim não é possível alterá-la.");

                if (apenasRetornarEtapa)
                    return new { };

                return serCarga.ObterDetalhesDaCarga(carga, tipoServicoMultisoftware, unitOfWork);
            }
            else
            {
                throw new ServicoException("Não é possível retornar a situação desta carga.");
            }
        }

        public string ObtemProximoSequencialAlfanumericoCarga(Repositorio.UnitOfWork unitOfWork)
        {
            string proximoSequencial = "";
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork).BuscarPrimeiroRegistro(); ;

            if (configuracaoGeralCarga.GerarNumerodeCargaAlfanumerico)
            {

                int quantidadeCaracteres = (int)configuracaoGeralCarga.TamanhoNumerodeCargaAlfanumerico;

                string sequencial = repositorioCarga.ObtemUltimoSequencialAlfanumericoCarga(quantidadeCaracteres);

                if (sequencial == null)
                    proximoSequencial = "A" + "1".PadLeft(quantidadeCaracteres - 1, '0');

                else
                {
                    List<String> listaSequencialSeparada = SeparaStringAlfanumericaEmLetraseNumeros(sequencial);

                    //Se ainda não tiver letras, soma próximo sequencial enquanto não chegar no limite do número. Se for estourar o limite, adiciona primeira letra e reinicia o sequencial.
                    if (listaSequencialSeparada.Count == 0)
                    {
                        int proximoSequencialInt = sequencial.ToInt() + 1;

                        if (proximoSequencialInt <= "".PadLeft(quantidadeCaracteres, '9').ToInt())
                            proximoSequencial = proximoSequencialInt.ToString().PadLeft(quantidadeCaracteres, '0');
                        else
                        {
                            quantidadeCaracteres -= 1;
                            proximoSequencial = "A" + "1".PadLeft(quantidadeCaracteres, '0');
                        }
                    }
                    //Se já tem letra no sequencial.
                    else
                    {
                        string letras = listaSequencialSeparada[0];
                        string numeros = listaSequencialSeparada[1];
                        char ultimaLetra = letras.Last();
                        int numerosInt = numeros.ToInt();
                        int quantidadeDeLetras = letras.Length;
                        int quantidadeDeNumeros = numeros.Length;
                        int maximoNumeroQuantidade = "".PadLeft(quantidadeDeNumeros, '9').ToInt();


                        if (numerosInt < maximoNumeroQuantidade)
                        {
                            numerosInt += 1;
                            proximoSequencial = letras + numerosInt.ToString().PadLeft(quantidadeDeNumeros, '0');
                        }
                        //Se for o ultimo número, adiciona uma letra e reinicia o sequencial.
                        else if (numerosInt == maximoNumeroQuantidade)
                        {
                            if (ultimaLetra == 'Z')
                            {
                                StringBuilder novasLetras = new StringBuilder();
                                char novaLetra = new char();
                                bool alterarAProxima = true;
                                foreach (char letra in letras.Reverse())
                                {
                                    novaLetra = letra;
                                    if (alterarAProxima)
                                    {
                                        novaLetra = GetProximaLetra(letra);
                                        alterarAProxima = novaLetra == 'A';
                                    }
                                    novasLetras = novasLetras.Append(novaLetra);
                                }
                                if (alterarAProxima)
                                {
                                    novasLetras.Append('A');
                                    quantidadeDeNumeros--;
                                }

                                if (quantidadeDeNumeros == 0)
                                    throw new ServicoException(string.Format("Limite de sequencial alcançado. Sequencial atual: {00}", sequencial));

                                proximoSequencial = new string(novasLetras.ToString().Reverse().ToArray()) + "1".ToString().PadLeft(quantidadeDeNumeros, '0');
                            }
                            else
                            {
                                ultimaLetra = (char)(ultimaLetra + 1);
                                proximoSequencial = letras.Substring(0, quantidadeDeLetras - 1) + ultimaLetra + "1".ToString().PadLeft(quantidadeDeNumeros, '0');
                            }
                        }
                    }
                }
            }
            return proximoSequencial;
        }

        /// <summary>
        /// São as cargas que devem ser emitidas após o Cálculo do Frete Fila Tipo Integração 0 (Padrão);
        /// </summary>
        public void SolicitarEmissaoDocumentosAutorizadosNaEtapaDeFrete(Repositorio.UnitOfWork unitOfWork, string stringConexao, string webServiceConsultaCTe, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, int inicioContadorNotas, int fimContadorNotas, IdentificadorControlePosicaoThread identificadorControlePosicaoThread)
        {
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repositorioConfiguracao = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);

            Servicos.Embarcador.Hubs.Carga serHubCarga = new Servicos.Embarcador.Hubs.Carga();
            Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);
            Servicos.Global.OrquestradorFila servicoOrquestradorFila = new Servicos.Global.OrquestradorFila(unitOfWork, identificadorControlePosicaoThread);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao = repositorioConfiguracao.BuscarConfiguracaoPadrao();

            int segundos = -configuracao.TempoSegundosParaInicioEmissaoDocumentos;
            int tipoEnvio = configuracao.CodigoTipoEnvioEmissaoCTe;

            List<int> codigosCargas = servicoOrquestradorFila.Ordenar((limiteRegistros) => repositorioCarga.BuscaCodigosCargasAutorizadasEmissaoNaEtapaDeFrete(DateTime.Now.AddSeconds(segundos), limiteRegistros, Dominio.Enumeradores.LoteCalculoFrete.Padrao, configuracao.ExigeInformarCienciaDoEnvioDasNotasAntesDeEmitirDocumentos, configuracao.ExigirCargaRoteirizada, inicioContadorNotas, fimContadorNotas, 0, 0));

            for (int i = 0; i < codigosCargas.Count; i++)
            {
                try
                {
                    Servicos.Log.GravarInfo("1 - Iniciando emissao documentos " + codigosCargas[i].ToString(), identificadorControlePosicaoThread.ObterDescricao());

                    serCarga.ValidarEmissaoDocumentosCarga(codigosCargas[i], unitOfWork, tipoServicoMultisoftware, webServiceConsultaCTe, tipoEnvio, true);
                    serHubCarga.InformarCargaAtualizada(codigosCargas[i], Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoAcaoCarga.Alterada, stringConexao);

                    servicoOrquestradorFila.RegistroLiberadoComSucesso(codigosCargas[i]);

                    Servicos.Log.GravarInfo("15 - Finalizada emissao documentos " + codigosCargas[i].ToString(), identificadorControlePosicaoThread.ObterDescricao());
                }
                catch (Exception excecao)
                {
                    unitOfWork.Rollback();

                    Servicos.Log.TratarErro(excecao);

                    servicoOrquestradorFila.RegistroComFalha(codigosCargas[i], excecao.Message);
                }

                unitOfWork.FlushAndClear();
            }
        }

        /// <summary>
        /// São as cargas que devem ser emitidas após o Cálculo do Frete Fila Tipo Integração 1 (Integração);
        /// </summary>
        public void SolicitarEmissaoDocumentosAutorizadosNaEtapaDeFreteIntegracao(Repositorio.UnitOfWork unitOfWork, string stringConexao, string webServiceConsultaCTe, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, int inicioContadorPedidos, int fimContadorPedidos, IdentificadorControlePosicaoThread identificadorControlePosicaoThread)
        {
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repositorioConfiguracao = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);

            Servicos.Embarcador.Hubs.Carga serHubCarga = new Servicos.Embarcador.Hubs.Carga();
            Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);
            Servicos.Global.OrquestradorFila servicoOrquestradorFila = new Servicos.Global.OrquestradorFila(unitOfWork, identificadorControlePosicaoThread);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao = repositorioConfiguracao.BuscarConfiguracaoPadrao();

            int segundos = -configuracao.TempoSegundosParaInicioEmissaoDocumentos;

            List<int> codigosCargas = servicoOrquestradorFila.Ordenar((limiteRegistros) => repositorioCarga.BuscaCodigosCargasAutorizadasEmissaoNaEtapaDeFrete(DateTime.Now.AddSeconds(segundos), limiteRegistros, Dominio.Enumeradores.LoteCalculoFrete.Integracao, configuracao.ExigeInformarCienciaDoEnvioDasNotasAntesDeEmitirDocumentos, configuracao.ExigirCargaRoteirizada, 0, 0, inicioContadorPedidos, fimContadorPedidos));

            for (var i = 0; i < codigosCargas.Count; i++)
            {
                try
                {
                    Servicos.Log.TratarErro("Iniciando emissao documentos " + codigosCargas[i].ToString(), identificadorControlePosicaoThread.ObterDescricao());

                    serCarga.ValidarEmissaoDocumentosCarga(codigosCargas[i], unitOfWork, tipoServicoMultisoftware, webServiceConsultaCTe, 1, false);
                    serHubCarga.InformarCargaAtualizada(codigosCargas[i], Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoAcaoCarga.Alterada, stringConexao);

                    servicoOrquestradorFila.RegistroLiberadoComSucesso(codigosCargas[i]);

                    Servicos.Log.TratarErro("Finalizada emissao documentos " + codigosCargas[i].ToString(), identificadorControlePosicaoThread.ObterDescricao());
                }
                catch (Exception excecao)
                {
                    unitOfWork.Rollback();

                    Servicos.Log.TratarErro(excecao);

                    servicoOrquestradorFila.RegistroComFalha(codigosCargas[i], excecao.Message);
                }

                unitOfWork.FlushAndClear();
            }
        }

        //#461
        public void GerarAtendimentoPorGatilhoNaCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, TipoMotivoChamadoGatilhoNaCarga gatilho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado)
        {
            Repositorio.Embarcador.Chamados.MotivoChamadoGatilhosNaCarga repMotivoChamadoGatilhosNaCarga = new Repositorio.Embarcador.Chamados.MotivoChamadoGatilhosNaCarga(unitOfWork);
            Repositorio.Embarcador.Chamados.Chamado repChamado = new Repositorio.Embarcador.Chamados.Chamado(unitOfWork);
            Repositorio.Embarcador.Chamados.MotivoChamado repMotivoChamado = new Repositorio.Embarcador.Chamados.MotivoChamado(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao(); ;

            List<Dominio.Entidades.Embarcador.Chamados.MotivoChamadoGatilhosNaCarga> motivoChamadoGatilhosNaCarga = repMotivoChamadoGatilhosNaCarga.BuscarPorTipoGatilhoNaCarga(gatilho);
            if (motivoChamadoGatilhosNaCarga == null || motivoChamadoGatilhosNaCarga.Count == 0) return;

            List<Dominio.Entidades.Embarcador.Chamados.MotivoChamado> motivoChamados = repMotivoChamado.BuscarPorCodigos(motivoChamadoGatilhosNaCarga.Select(o => o.MotivoChamado.Codigo).ToList());

            foreach (Dominio.Entidades.Embarcador.Chamados.MotivoChamado motivoChamado in motivoChamados)
            {
                bool gerarAtendimento = false;
                string descricao = string.Empty;

                switch (gatilho)
                {
                    case TipoMotivoChamadoGatilhoNaCarga.AoSalvarPlacaComModeloVeicularDiferenteDoPrevisto:
                        descricao = gatilho.ObterDescricaoAuditoria();
                        gerarAtendimento = !repChamado.ContemChamadoMesmaCargaEntregaMotivoSituacao(carga.Codigo, 0, motivoChamado.Codigo, SituacaoChamado.Aberto);
                        break;
                }

                if (!gerarAtendimento) continue;

                try
                {
                    auditado.Texto = "Criação de atendimento por gatilho: " + gatilho.ObterDescricao();
                    Auditoria.Auditoria.Auditar(auditado, carga, null, auditado.Texto, unitOfWork);

                    Dominio.ObjetosDeValor.Embarcador.Chamado.ObjetoChamado objChamado = new Dominio.ObjetosDeValor.Embarcador.Chamado.ObjetoChamado()
                    {
                        Empresa = carga.Empresa,
                        Pedido = repositorioCargaPedido.BuscarPorCargaUnica(carga.Codigo).Pedido,
                        Cliente = repositorioCargaPedido.BuscarPrimeiroClientePorCarga(carga.Codigo, !(configuracao?.ChamadoOcorrenciaUsaRemetente ?? false)),
                        TipoCliente = (configuracao?.ChamadoOcorrenciaUsaRemetente ?? false) ? Dominio.Enumeradores.TipoTomador.Remetente : Dominio.Enumeradores.TipoTomador.Destinatario,
                        MotivoChamado = motivoChamado,
                        Carga = carga,
                        Observacao = descricao
                    };

                    Dominio.Entidades.Usuario usuario = carga.Motoristas?.FirstOrDefault();
                    if (usuario == null)
                        usuario = carga.Operador ?? auditado?.Usuario;

                    if (usuario != null)//se nao tem usuario nao pode abrir chamado (classe obrigatoria no chamado Autor)
                        Servicos.Embarcador.Chamado.Chamado.AbrirChamado(objChamado, usuario, tipoServicoMultisoftware, null, unitOfWork);

                }
                catch (ServicoException ex)
                {
                    string mensagem = $"Falha na abertura do atendimento para Carga {carga.CodigoCargaEmbarcador}: {ex.Message}";
                    Log.TratarErro(mensagem);
                    Auditoria.Auditoria.Auditar(auditado, carga, null, mensagem, unitOfWork);
                }
            }
        }

        public bool ValidaPagamentoCTes(Dominio.Entidades.Embarcador.Cargas.Carga carga, out List<int> numeroCtesRetorno)
        {
            List<int> numeroCtesComTitulo = new List<int>();

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaCTe cargaCte in carga.CargaCTes)
            {
                if ((cargaCte.CTe.Titulo?.DataVencimento != null) || (cargaCte.CTe.Titulo?.DataLiquidacao != null))
                    numeroCtesComTitulo.Add(cargaCte.CTe.Numero);
            }

            numeroCtesRetorno = numeroCtesComTitulo;

            return numeroCtesComTitulo.Any();
        }

        public void AdicionarMensagemAlertaCargaBloqueadaEnquantoNaoReceberDesbloqueioViaIntegracaoOuManual(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga, Repositorio.UnitOfWork unitOfWork)
        {
            if (configuracaoGeralCarga?.SetarCargaComoBloqueadaEnquantoNaoReceberDesbloqueioViaIntegracaoOuManual ?? false)
                new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork).Adicionar(carga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoMensagemAlerta.CargaAguardandoDesbloqueio, true, $"Bloqueia carga e não libera  janela de carregamento transportador {carga.Empresa?.NomeFantasia ?? ""}  {DateTime.Now.ToString("dd/MM/yyyy HH:mm")}");
        }

        public void ObterTipoTrechoDadosTransporte(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Repositorio.UnitOfWork unitOfWork)
        {
            List<string> log = new List<string>();
            ObterTipoTrecho(carga, cargaPedidos, unitOfWork, false, ref log);
        }

        public bool PermitirFinalizarCargaAutomaticamente(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao, TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.Embarcador.Cargas.CargaMDFe repositorioCargaMDFe)
        {
            bool finalizarAutomaticamente = (!configuracao.NaoFinalizarCargasAutomaticamente && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS);
            bool finalizarAutomaticamentePorTipoOperacao = (carga.TipoOperacao?.ConfiguracaoEmissaoDocumento?.FinalizarCargaAutomaticamente ?? false);
            bool naoExisteMDFe = !repositorioCargaMDFe.ExistePorCarga(carga);

            return (finalizarAutomaticamente || finalizarAutomaticamentePorTipoOperacao) && naoExisteMDFe;
        }

        public bool VerificarModeloVeicularDiferenteDoSolicitado(Dominio.Entidades.Embarcador.Cargas.Carga carga, bool validarModeloVeicularVeiculoCargaEtapaFrete = false)
        {
            if (carga.ModeloVeicularCarga == null)
                return false;

            bool exigirVeiculoIgualModeloVeicularDaCarga = (carga.TipoOperacao?.ExigeQueVeiculoIgualModeloVeicularDaCarga ?? false) || validarModeloVeicularVeiculoCargaEtapaFrete;

            if (carga.VeiculosVinculados?.Count > 0)
            {
                List<string> placasReboque = carga.VeiculosVinculados.Where(reboque => reboque.ModeloVeicularCarga?.Codigo != carga.ModeloVeicularCarga.Codigo).Select(reboque => reboque.Placa).ToList();

                if (placasReboque.Count > 0)
                {
                    if (exigirVeiculoIgualModeloVeicularDaCarga)
                        throw new ServicoException($"{(placasReboque.Count > 1 ? "Reboques" : "Reboque")} {string.Join(", ", placasReboque)} com modelo veicular diferente do exigido para essa carga ({carga.ModeloVeicularCarga.Descricao}).");

                    return true;
                }
            }
            else if (carga.Veiculo != null)
            {
                if (carga.ModeloVeicularCarga.Codigo != carga.Veiculo.ModeloVeicularCarga?.Codigo)
                {
                    if (exigirVeiculoIgualModeloVeicularDaCarga)
                        throw new ServicoException($"Veículo {carga.Veiculo.Placa} com modelo veicular diferente do exigido para essa carga ({carga.ModeloVeicularCarga.Descricao}).");

                    return true;
                }
            }

            return false;
        }

        public void PreencherMotoristaGenericoCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, Auditado auditado, Repositorio.UnitOfWork unitOfWork)
        {
            if (carga.TipoOperacao?.ConfiguracaoCarga?.HabilitarVinculoMotoristaGenericoCarga ?? false)
            {
                Repositorio.Embarcador.Cargas.CargaMotorista repCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);
                List<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> cargaMotoristas = repCargaMotorista.BuscarPorCarga(carga.Codigo);

                if ((carga.Motoristas == null || carga.Motoristas.Count == 0) && (cargaMotoristas.Count() == 0))
                {
                    Servicos.Embarcador.Carga.CargaMotorista servicoCargaMotorista = new Servicos.Embarcador.Carga.CargaMotorista(unitOfWork);
                    Repositorio.Embarcador.Pedidos.TipoOperacaoFilialMotoristaGenerico repositorioTipoOperacaoFilialMotoristaGenerico = new Repositorio.Embarcador.Pedidos.TipoOperacaoFilialMotoristaGenerico(unitOfWork);
                    Dominio.Entidades.Embarcador.Pedidos.TipoOperacaoFilialMotoristaGenerico tipoOperacaoFilialMotoristaGenerico = repositorioTipoOperacaoFilialMotoristaGenerico.BuscarPorTipoOperacaoEFilial(carga.TipoOperacao?.Codigo ?? 0, carga.Filial?.Codigo ?? 0);

                    if (tipoOperacaoFilialMotoristaGenerico != null)
                    {
                        List<Dominio.Entidades.Usuario> motoristas = new List<Dominio.Entidades.Usuario>();
                        motoristas.Add(tipoOperacaoFilialMotoristaGenerico.Motorista);

                        bool atualizouMotorista = servicoCargaMotorista.AtualizarMotoristas(carga, motoristas);

                        if (atualizouMotorista)
                            Servicos.Auditoria.Auditoria.Auditar(auditado, carga, $"Motorista adicionado pela regra de vínculo de motorista genérico por filial e tipo de operação", unitOfWork);
                    }
                }
            }
        }

        public string CriarMensagemValidarMotoristas(IList<int> codigosMotoristas, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, UnitOfWork unitOfWork)
        {
            if (codigosMotoristas.Count > 0)
            {
                Repositorio.Usuario repositorioMotorista = new Repositorio.Usuario(unitOfWork);
                List<Dominio.Entidades.Usuario> motoristasParaValidar = repositorioMotorista.BuscarMotoristaPorCodigo(codigosMotoristas.ToArray());
                List<Dominio.Entidades.Usuario> motoristasBloqueados = repositorioMotorista.BuscarMotoristaBloqueadoPorCodigo(null, motoristasParaValidar);
                if (motoristasBloqueados.Count > 0)
                {
                    string mensagemBloqueioMotorista = $"O(s) seguinte(s) motorista(s) estão bloqueados {string.Join(", ", (from motoristasBloqueado in motoristasBloqueados select motoristasBloqueado.Nome))}";

                    if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador)
                        mensagemBloqueioMotorista += $" pelo(s) motivo(s) {string.Join(", ", (from motoristaBloqueado in motoristasBloqueados select motoristaBloqueado.MotivoBloqueio))}.";
                    else
                        mensagemBloqueioMotorista += ". Entre em contato com o embarcador para entender o motivo.";

                    return mensagemBloqueioMotorista;
                }

                DateTime dataAtual = DateTime.Now;
                string mensagemMotoristaSuspenso = string.Empty;
                foreach (var motorista in motoristasParaValidar)
                {
                    if (motorista.DataSuspensaoInicio.HasValue && motorista.DataSuspensaoFim.HasValue)
                        if ((dataAtual >= motorista.DataSuspensaoInicio) && (dataAtual <= motorista.DataSuspensaoFim))
                            mensagemMotoristaSuspenso += $"Nome {motorista.Nome} está suspenso.";
                }
                if (!string.IsNullOrEmpty(mensagemMotoristaSuspenso))
                {
                    mensagemMotoristaSuspenso = $"Existem motorista(s) suspenso(s), entrar em contato com a transportadora: {mensagemMotoristaSuspenso}";
                    return mensagemMotoristaSuspenso;
                }
            }
            return string.Empty;
        }

        public decimal BuscarPorcentagemOcupacaoVeiculo(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            decimal TaxaOcupacaoVeiculo = repositorioCarga.BuscarTaxaOcupacaoVeiculo(carga.Codigo);

            return TaxaOcupacaoVeiculo * 100;
        }

        public string ObterNumeroCargaAdicionar(Dominio.Entidades.Embarcador.Filiais.Filial filial)
        {
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(_unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(_unitOfWork);
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = repConfiguracaoTMS.BuscarConfiguracaoPadrao();

            int proximoNumeroCarga = 0;
            if (configuracaoEmbarcador.NumeroCargaSequencialUnico)
                proximoNumeroCarga = Cargas.CargaSequencial.GetInstance().ObterProximoNumeroSequencial(_unitOfWork);
            else
                proximoNumeroCarga = Cargas.CargaSequencial.GetInstance().ObterProximoNumeroSequencial(_unitOfWork, filial?.Codigo ?? 0);

            int numeroTentativasEncontrarProximoNumeroCargaDisponivel = 0;

            while (repositorioCarga.ExisteCarga(proximoNumeroCarga.ToString(), filial.CodigoFilialEmbarcador, false))
            {
                if (++numeroTentativasEncontrarProximoNumeroCargaDisponivel == 3)
                    throw new ServicoException($"Já existe uma carga com o número {proximoNumeroCarga}.");

                proximoNumeroCarga++;
            }

            Repositorio.Embarcador.Logistica.AgendamentoColeta repositorioAgendamentoColeta = new Repositorio.Embarcador.Logistica.AgendamentoColeta(_unitOfWork);

            List<SituacaoAgendamentoColeta> situacoesAgendamentoColetaCanceladas = SituacaoAgendamentoColetaHelper.Canceladas;

            if (repositorioAgendamentoColeta.ExisteAgendamentoPorNumeroCargaEFilial(proximoNumeroCarga.ToString(), filial.Codigo, situacoesAgendamentoColetaCanceladas))
            {
                StringBuilder mensagemErro = new($"Já existe um Agendamento de Coleta para a Carga de número {proximoNumeroCarga}");

                if (!string.IsNullOrWhiteSpace(filial.Descricao))
                    mensagemErro.Append($" com a Filial {filial.Descricao}");

                mensagemErro.Append($" que não está em nenhuma destas situações: {string.Join(", ", situacoesAgendamentoColetaCanceladas.Select(situacaoAgendamentoColeta => situacaoAgendamentoColeta.ObterDescricao()))}");

                throw new ServicoException(mensagemErro.ToString());
            }

            return proximoNumeroCarga.ToString();
        }

        #endregion Métodos Públicos

        #region Métodos Públicos Duplicar Carga

        public Dominio.Entidades.Embarcador.Cargas.Carga DuplicarCarga(Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Dominio.Entidades.Embarcador.Cargas.CargaCancelamento cargaCancelamento, bool liberarPedidosParaMontagemCarga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, AdminMultisoftware.Dominio.Entidades.Pessoas.Cliente ClienteMultisoftware, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado)
        {
            Repositorio.Embarcador.Cargas.CargaMotorista repCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCancelamento repCargaCancelamento = new Repositorio.Embarcador.Cargas.CargaCancelamento(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaDadosTransporteIntegracao repCargaDadosTransporteIntegracao = new Repositorio.Embarcador.Cargas.CargaDadosTransporteIntegracao(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoAprovacao repositorioConfiguracaoAprovacao = new Repositorio.Embarcador.Configuracoes.ConfiguracaoAprovacao(unitOfWork);

            Servicos.Embarcador.Carga.CargaRotaFrete servicoCargaRotaFrete = new Servicos.Embarcador.Carga.CargaRotaFrete(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoAprovacao configuracaoAprovacao = repositorioConfiguracaoAprovacao.BuscarConfiguracaoPadrao();

            cargaCancelamento = repCargaCancelamento.BuscarPorCodigo(cargaCancelamento.Codigo);

            if (cargaCancelamento.CargaDuplicada != null)
                return cargaCancelamento.CargaDuplicada;

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao(); ;

            cargaAntiga = repCarga.BuscarPorCodigo(cargaAntiga.Codigo);

            Dominio.Entidades.Embarcador.Cargas.Carga cargaNova = GerarCargaDuplicada(cargaAntiga, cargaCancelamento, cargaCancelamento.SituacaoCargaNoCancelamento, null, true, unitOfWork, tipoServicoMultisoftware);

            cargaAntiga.Protocolo = 0;

            if (!string.IsNullOrWhiteSpace(cargaAntiga.IdentificadorDeRota))
            {
                cargaNova.IdentificadorDeRota = cargaAntiga.IdentificadorDeRota;
                cargaAntiga.IdentificadorDeRota = null;
            }

            int codigoCarregamento = 0;
            if (cargaAntiga.Carregamento != null)
            {
                codigoCarregamento = cargaAntiga.Carregamento.Codigo;
                cargaAntiga.Carregamento = null;
            }
            repCarga.Atualizar(cargaAntiga);

            AlterarCargaEntrega(cargaNova, cargaAntiga, unitOfWork);

            if (!cargaAntiga.CargaDePreCargaFechada && !cargaAntiga.CargaDePreCargaEmFechamento)
            {
                AlterarMonitoramento(cargaNova, cargaAntiga, unitOfWork);
                AlterarAlertaMonitor(cargaNova, cargaAntiga, unitOfWork);
            }

            DuplicarCargaIntegracao(cargaNova, cargaAntiga, unitOfWork);
            DuplicarCargaIntegracaoAvon(cargaNova, cargaAntiga, unitOfWork);
            DuplicarCargaTabelaFreteCliente(cargaNova, cargaAntiga, unitOfWork);
            DuplicarCargaTabelaFreteRota(cargaNova, cargaAntiga, unitOfWork);
            DuplicarCargaTabelaFreteSubcontratacao(cargaNova, cargaAntiga, unitOfWork);
            //DuplicarCargaComplementoFrete(cargaNova, cargaAntiga, unitOfWork); Metodo DuplicarCargaComponenteFrete faz o mesmo
            DuplicarCargaComponenteFrete(cargaNova, cargaAntiga, unitOfWork);
            DuplicarCargaLocaisPrestacao(cargaNova, cargaAntiga, unitOfWork);
            DuplicarCargaMotorista(cargaNova, cargaAntiga, unitOfWork);

            if (cargaCancelamento.LiberarPedidosParaMontagemCarga)
                LiberarPedidosParaMontagemCarga(cargaNova, cargaAntiga, unitOfWork, auditado);
            else
                DuplicarCargaPedidos(cargaCancelamento, configuracaoTMS, cargaNova, cargaAntiga, unitOfWork, tipoServicoMultisoftware, auditado);

            DuplicarContratoFrete(configuracaoTMS, cargaNova, cargaAntiga, unitOfWork);
            DuplicarIntegracaoValePedagio(cargaNova, cargaAntiga, unitOfWork);
            DuplicarCargaPercurso(cargaNova, cargaAntiga, unitOfWork);
            servicoCargaRotaFrete.DuplicarCargaRotaFrete(cargaNova, cargaAntiga);
            DuplicarCargaFronteira(cargaNova, cargaAntiga, unitOfWork);
            DuplicarCargaDadosAverbacao(cargaNova, cargaAntiga, unitOfWork);

            if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
            {
                if (
                    (cargaCancelamento.SituacaoCargaNoCancelamento != SituacaoCarga.Nova) &&
                    (cargaCancelamento.SituacaoCargaNoCancelamento != SituacaoCarga.AgTransportador) &&
                    (cargaCancelamento.SituacaoCargaNoCancelamento != SituacaoCarga.AgNFe)
                )
                {
                    if (repCargaPedido.ExisteCTeEmitidoNoEmbarcadorPorCarga(cargaNova.Codigo) && cargaCancelamento.CancelarDocumentosEmitidosNoEmbarcador)
                        cargaNova.SituacaoCarga = SituacaoCarga.AgNFe;
                    else
                    {
                        if (cargaNova.TipoOperacao?.AvancarEtapaFreteAutomaticamente ?? false)
                            cargaNova.SituacaoCarga = SituacaoCarga.AgNFe;//cargaNova.NaoAvancarAutomaticamenteEtapaFretePorPendencia = true;
                        else
                        {
                            cargaNova.SituacaoCarga = SituacaoCarga.CalculoFrete;

                            bool naoCriarAprovacao = cargaAntiga.TipoOperacao?.NaoCriarAprovacaoCargaConfirmarDocumento ?? false;

                            if ((configuracaoTMS.UtilizaEmissaoMultimodal || configuracaoAprovacao.CriarAprovacaoCargaAoConfirmarDocumentos) && !naoCriarAprovacao)
                            {
                                new Servicos.Embarcador.Carga.CargaAprovacaoFrete(unitOfWork).CriarAprovacao(cargaNova, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoRegraAutorizacaoCarga.Outros, tipoServicoMultisoftware);
                            }
                        }
                    }
                }
            }
            else if (cargaCancelamento.SituacaoCargaNoCancelamento.IsSituacaoCargaEmitida())
                cargaNova.SituacaoCarga = SituacaoCarga.AgNFe;

            if (cargaNova.TipoOperacao != null && cargaNova.TipoOperacao.ExigirConfirmacaoDadosTransportadorAvancarCarga)
            {
                cargaNova.SituacaoCarga = SituacaoCarga.Nova;

                if (!cargaNova.DataEnvioUltimaNFe.HasValue)
                {
                    if ((!cargaNova.TipoOperacao.PermiteImportarDocumentosManualmente || cargaNova.TipoOperacao.NaoExigeConformacaoDasNotasEmissao))
                        cargaNova.DataEnvioUltimaNFe = DateTime.Now;
                }
            }

            if (cargaAntiga.CargaDePreCargaFechada || cargaAntiga.CargaDePreCargaEmFechamento)
            {
                cargaNova.CargaDePreCarga = true;
                cargaNova.LiberadoComProblemaIntegracaoGrMotoristaVeiculo = cargaAntiga.LiberadoComProblemaIntegracaoGrMotoristaVeiculo;
                cargaNova.MensagemProblemaIntegracaoGrMotoristaVeiculo = cargaAntiga.MensagemProblemaIntegracaoGrMotoristaVeiculo;
                cargaNova.ProtocoloIntegracaoGR = cargaAntiga.ProtocoloIntegracaoGR;
                cargaNova.ProblemaIntegracaoGrMotoristaVeiculo = cargaAntiga.ProblemaIntegracaoGrMotoristaVeiculo;
                cargaNova.TipoCondicaoPagamento = cargaAntiga.TipoCondicaoPagamento;
                cargaNova.SituacaoCarga = SituacaoCarga.AgNFe;

                TrocarCarga(cargaAntiga, cargaNova, tipoServicoMultisoftware, ClienteMultisoftware, configuracaoTMS, unitOfWork, trocarCargaAgrupada: true);
            }

            if (codigoCarregamento > 0)
                cargaNova.Carregamento = new Dominio.Entidades.Embarcador.Cargas.MontagemCarga.Carregamento() { Codigo = codigoCarregamento };

            cargaCancelamento.CargaDuplicada = cargaNova;

            repCarga.Atualizar(cargaNova);
            repCargaCancelamento.Atualizar(cargaCancelamento);

            if (configuracaoTMS.UtilizarDistanciaRoteirizacaoCarregamentoNaCarga && cargaNova.Carregamento != null)
            {
                Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacao repCarregamentoRoteirizacao = new Repositorio.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacao(unitOfWork);
                Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoRoteirizacao carregamentoRoteirizacao = repCarregamentoRoteirizacao.BuscarPorCarregamento(cargaNova.Carregamento.Codigo);
                if (carregamentoRoteirizacao != null)
                {
                    carregamentoRoteirizacao.DistanciaKM = 0;
                    repCarregamentoRoteirizacao.Atualizar(carregamentoRoteirizacao);
                }
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(cargaNova.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> cargaMotoristas = repCargaMotorista.BuscarPorCarga(cargaNova.Codigo);

            Servicos.Embarcador.Integracao.IntegracaoCarga.AdicionarIntegracoesCarga(cargaNova, cargaPedidos, tipoServicoMultisoftware, unitOfWork, true);
            Servicos.Embarcador.Integracao.IntegracaoCarga.AdicionarIntegracoesCargaDadosTransporte(cargaNova, cargaPedidos, cargaMotoristas, configuracaoTMS, tipoServicoMultisoftware, unitOfWork);

            // Ao cancelar a carga e duplicar, se a carga duplicada possuir alguma integração na etapa 1, o sistema deve manter a carga na etapa 1
            SituacaoIntegracao[] situacaoIntegracao = new Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoIntegracao[] { SituacaoIntegracao.AgIntegracao, SituacaoIntegracao.AgRetorno, SituacaoIntegracao.ProblemaIntegracao };
            if (cargaNova.SituacaoCarga != SituacaoCarga.Nova)
                if (repCargaDadosTransporteIntegracao.ContarPorCarga(cargaNova.Codigo, situacaoIntegracao) > 0)
                    cargaNova.SituacaoCarga = SituacaoCarga.Nova;

            return cargaNova;
        }

        #endregion Métodos Públicos Duplicar Carga

        #region Métodos Públicos Estáticos

        public static bool PreencherDadosPalletsDoPedido(out string erro, Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacao, Repositorio.UnitOfWork unitOfWork, Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoPaletes configuracaoPaletes)
        {
            erro = string.Empty;
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Dominio.Entidades.Embarcador.Pedidos.Pedido pedido = cargaPedido.Pedido;

            if (configuracaoPaletes.UtilizarControlePaletesPorModeloVeicular && !(tipoOperacao?.NaoGerarControlePaletes ?? false) && (carga.GrupoPessoaPrincipal?.ControlaPallets ?? false))
            {
                int quantidadePalletsModeloVeiculares = (carga.Veiculo?.ModeloVeicularCarga?.QuantidadePaletes ?? 0) + (carga.VeiculosVinculados?.Sum(o => o.ModeloVeicularCarga?.QuantidadePaletes ?? 0) ?? 0);
                int quantidadePalletsPedido = pedido.NumeroPaletes;
                int quantidadePalletsNotas = repPedidoXMLNotaFiscal.QuantidadePalletsControlePorCargaPedido(cargaPedido.Codigo);

                if (quantidadePalletsModeloVeiculares > 0)
                {
                    pedido.NumeroPaletes = quantidadePalletsModeloVeiculares;
                    repPedido.Atualizar(pedido);
                }
                else if (quantidadePalletsPedido == 0 && quantidadePalletsNotas > 0)
                {
                    pedido.NumeroPaletes = quantidadePalletsNotas;
                    repPedido.Atualizar(pedido);
                }
                else if (quantidadePalletsPedido == 0)
                {
                    erro = "A quantidade de paletes para o controle de paletes está zerada. Informe no pedido, nos modelos dos veículos ou nas notas fiscais.";
                    return false;
                }
            }
            else if ((carga.GrupoPessoaPrincipal?.ControlaPallets ?? false) && !(tipoOperacao?.NaoGerarControlePaletes ?? false))
            {
                if (repCargaPedido.ExisteCTeEmitidoNoEmbarcador(carga.Codigo) && pedido.NumeroPaletes > 0)
                    return true;

                int quantidadePalletsControle = repPedidoXMLNotaFiscal.QuantidadePalletsControlePorCargaPedido(cargaPedido.Codigo);
                if (quantidadePalletsControle == 0)
                {
                    erro = "Quantidade de Pallets para Controle está zerado. Favor informar nas notas.";
                    return false;
                }

                pedido.NumeroPaletes = quantidadePalletsControle;
                repPedido.Atualizar(pedido);
            }

            return true;
        }


        public static void AtualizarDadosCargaPedidoCobertura(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoCobertura, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repositorioXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);

            Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xmlNotaFiscalCobertura = cargaPedidoCobertura.NotasFiscais?.Select(obj => obj.XMLNotaFiscal)?.FirstOrDefault() ?? null;
            List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> xmlNotasFiscais = cargaPedidoCobertura.NotasFiscais?.Select(obj => obj.XMLNotaFiscal)?.ToList() ?? new List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal>();

            cargaPedidoCobertura.ValorMercadoriaDescontar = xmlNotasFiscais.Sum(obj => obj.Valor);
            cargaPedidoCobertura.PesoMercadoriaDescontar = cargaPedidoCobertura.Peso;

            if (xmlNotaFiscalCobertura != null)
            {
                xmlNotaFiscalCobertura.Destinatario = cargaPedidoCobertura.Pedido.Destinatario;
                repositorioXMLNotaFiscal.Atualizar(xmlNotaFiscalCobertura);
            }

            repositorioCargaPedido.Atualizar(cargaPedidoCobertura);

        }
        public static List<Dominio.Entidades.Embarcador.Cargas.Carga> ObterCargasOrigem(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            List<Dominio.Entidades.Embarcador.Cargas.Carga> cargasOrigem = new List<Dominio.Entidades.Embarcador.Cargas.Carga>();
            if (carga.CargaAgrupada)
            {
                Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
                cargasOrigem = repCarga.BuscarCargasOriginais(carga.Codigo);
                cargasOrigem.Add(carga);
            }
            else
            {
                cargasOrigem.Add(carga);
            }
            return cargasOrigem;
        }

        public static DateTime AjustarDataPrevisaoTerminoCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, long minutosRetorno, Repositorio.UnitOfWork unitOfWork)
        {
            //Pegar a maior data do pedido de entrega...
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repositorioCargaPedido.BuscarPorCarga(carga.Codigo);
            DateTime dataUltimaEntrega = (from cp in cargaPedidos select cp.Pedido.PrevisaoEntrega ?? carga.DataFimViagem ?? carga.DataPrevisaoTerminoCarga ?? DateTime.MinValue).Max();
            //Se não recebemos os minutos, vamos buscar do T_CARGA_ROTA_FRETE_PONTOS_PASSAGEM o retorno..
            if (minutosRetorno == 0)
            {
                Repositorio.Embarcador.Cargas.CargaRotaFrete repositorioRotaFrete = new Repositorio.Embarcador.Cargas.CargaRotaFrete(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaRotaFretePontosPassagem repositorioRotaFretePontosPassagem = new Repositorio.Embarcador.Cargas.CargaRotaFretePontosPassagem(unitOfWork);
                Dominio.Entidades.Embarcador.Cargas.CargaRotaFrete cargaRotaFrete = repositorioRotaFrete.BuscarPorCarga(carga.Codigo);
                Dominio.Entidades.Embarcador.Cargas.CargaRotaFretePontosPassagem cargaRotaFreteRetorno = null;
                if (cargaRotaFrete != null)
                {
                    List<Dominio.Entidades.Embarcador.Cargas.CargaRotaFretePontosPassagem> cargaRotaFretePontosPassagens = repositorioRotaFretePontosPassagem.BuscarPorCargaRotaFrete(cargaRotaFrete.Codigo);
                    cargaRotaFreteRetorno = (from ponto in cargaRotaFretePontosPassagens where ponto.TipoPontoPassagem == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPontoPassagem.Retorno select ponto).FirstOrDefault();
                    if (cargaRotaFreteRetorno != null)
                        minutosRetorno += cargaRotaFreteRetorno.Tempo;
                }
            }

            // Somar com o tempo de retorno..
            if (dataUltimaEntrega > DateTime.MinValue)
                carga.DataPrevisaoTerminoCarga = dataUltimaEntrega.AddMinutes(minutosRetorno);
            return dataUltimaEntrega.AddMinutes(minutosRetorno);
        }
        public static async Task<DateTime> AjustarDataPrevisaoTerminoCargaAsync(Dominio.Entidades.Embarcador.Cargas.Carga carga, long minutosRetorno, Repositorio.UnitOfWork unitOfWork)
        {
            //Pegar a maior data do pedido de entrega...
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = await repositorioCargaPedido.BuscarPorCargaAsync(carga.Codigo);
            DateTime dataUltimaEntrega = (from cp in cargaPedidos select cp.Pedido.PrevisaoEntrega ?? carga.DataFimViagem ?? carga.DataPrevisaoTerminoCarga ?? DateTime.MinValue).Max();
            //Se não recebemos os minutos, vamos buscar do T_CARGA_ROTA_FRETE_PONTOS_PASSAGEM o retorno..
            if (minutosRetorno == 0)
            {
                Repositorio.Embarcador.Cargas.CargaRotaFrete repositorioRotaFrete = new Repositorio.Embarcador.Cargas.CargaRotaFrete(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaRotaFretePontosPassagem repositorioRotaFretePontosPassagem = new Repositorio.Embarcador.Cargas.CargaRotaFretePontosPassagem(unitOfWork);
                Dominio.Entidades.Embarcador.Cargas.CargaRotaFrete cargaRotaFrete = await repositorioRotaFrete.BuscarPorCargaAsync(carga.Codigo);
                Dominio.Entidades.Embarcador.Cargas.CargaRotaFretePontosPassagem cargaRotaFreteRetorno = null;
                if (cargaRotaFrete != null)
                {
                    List<Dominio.Entidades.Embarcador.Cargas.CargaRotaFretePontosPassagem> cargaRotaFretePontosPassagens =
                        await repositorioRotaFretePontosPassagem.BuscarPorCargaRotaFreteAsync(cargaRotaFrete.Codigo);
                    cargaRotaFreteRetorno = (from ponto in cargaRotaFretePontosPassagens where ponto.TipoPontoPassagem == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPontoPassagem.Retorno select ponto).FirstOrDefault();
                    if (cargaRotaFreteRetorno != null)
                        minutosRetorno += cargaRotaFreteRetorno.Tempo;
                }
            }

            // Somar com o tempo de retorno..
            if (dataUltimaEntrega > DateTime.MinValue)
                carga.DataPrevisaoTerminoCarga = dataUltimaEntrega.AddMinutes(minutosRetorno);
            return dataUltimaEntrega.AddMinutes(minutosRetorno);
        }

        public static bool VerificarSePossuiMDFe(Dominio.Entidades.Embarcador.Cargas.Carga carga, UnitOfWork unitOfWork, TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCTe repCargaCTe = new Repositorio.Embarcador.Cargas.CargaCTe(unitOfWork);

            if (carga.NaoGerarMDFe || carga.AgImportacaoCTe)
                return false;

            if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador && carga.NaoExigeVeiculoParaEmissao)//por motivo obvio, se a carga não exige veículo não se emite MDF-e
                return false;

            if (carga.TipoFreteEscolhido == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Cliente)//quando o frete é de responsabilidade do cliente não emite documentos.
                return false;

            if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
            {
                if (repCargaPedido.ContarPorCargaESituacao(carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoPedido.Aberto) == 0)//quando os pedidos já estão encerrados não é emitido MDF-e pq a viagem já ocorreu
                    return false;
            }

            if ((carga.Filial?.EmitirMDFeManualmente ?? false) || (carga.TipoOperacao != null && carga.TipoOperacao.EmissaoMDFeManual && ((carga.Empresa != null && !carga.Empresa.EmiteMDFe20IntraEstadual) || carga.Empresa == null)))
                return false;

            if (repCargaCTe.BuscarSistemaEmissorPorCarga(carga.Codigo) == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SistemaEmissor.OutrosEmissores)
                return false;

            if (carga.Empresa?.EmissaoMDFeForaDoSistema ?? false)
                return false;

            Dominio.Entidades.Cliente tomador = carga.Pedidos.FirstOrDefault()?.ObterTomador();

            if (carga.TipoOperacao != null && carga.TipoOperacao.UsarConfiguracaoEmissao)
            {
                if (carga.TipoOperacao.NaoEmitirMDFe)
                    return false;
            }
            else if (tomador != null)
            {
                if (tomador.NaoUsarConfiguracaoEmissaoGrupo)
                {
                    if (tomador.NaoEmitirMDFe)
                        return false;
                }
                else if (tomador.GrupoPessoas != null)
                {
                    if (tomador.GrupoPessoas.NaoEmitirMDFe)
                        return false;
                }
            }

            return true;
        }

        public static bool VerificarSePossuiEDIFiscal(Dominio.Entidades.Embarcador.Cargas.Carga carga, bool subcontratada, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (subcontratada)
                return false;

            bool exigeEDIFiscalMT = carga.Empresa?.Configuracao?.ExigeEDIFiscalMT ?? false;

            if (!exigeEDIFiscalMT)
                return false;

            Repositorio.Embarcador.Cargas.CargaLocaisPrestacao repCargaLocalPrestacao = new Repositorio.Embarcador.Cargas.CargaLocaisPrestacao(unidadeTrabalho);
            Repositorio.Embarcador.Cargas.CargaLocaisPrestacaoPassagens repCargaLocalPrestacaoPassagem = new Repositorio.Embarcador.Cargas.CargaLocaisPrestacaoPassagens(unidadeTrabalho);

            List<Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacao> locaisPrestacao = repCargaLocalPrestacao.BuscarPorCarga(carga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacao localPrestacao in locaisPrestacao)
            {
                if (localPrestacao.LocalidadeInicioPrestacao.Estado.Sigla == "MT")
                    continue; //quando inicia no MT não tem EDI Fiscal (segundo a Maisa)

                if (localPrestacao.LocalidadeTerminoPrestacao.Estado.Sigla == "MT")
                    return true; //termina no MT a prestação, então tem EDI

                List<Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacaoPassagens> passagens = repCargaLocalPrestacaoPassagem.BuscarPorLocalPrestacao(localPrestacao.Codigo);

                if (passagens.Any(o => o.EstadoDePassagem.Sigla == "MT"))
                    return true; //tem passagem pelo MT, então tem EDI
            }

            return false;
        }

        public static byte[] GerarRelatorioDetalhesCarga(int codigoCarga, Repositorio.UnitOfWork unidadeTrabalho)
        {
            return ReportRequest.WithType(ReportType.DetalhesCarga)
                .WithExecutionType(ExecutionType.Sync)
                .AddExtraData("CodigoCarga", codigoCarga)
                .CallReport()
                .GetContentFile();
        }

        public static byte[] GerarOrdemColetaGuarita(int codigoCarga, Repositorio.UnitOfWork unidadeTrabalho)
        {
            return ReportRequest.WithType(ReportType.OrdemColetaGuarita)
                .WithExecutionType(ExecutionType.Sync)
                .AddExtraData("CodigoCarga", codigoCarga)
                .CallReport()
                .GetContentFile();

        }

        public static byte[] GerarPDFDetalheCTeMDF(int codigoCarga, Repositorio.UnitOfWork unitOfWork)
        {
            var result = ReportRequest.WithType(ReportType.DetalheCTeMDF)
                .WithExecutionType(ExecutionType.Sync)
                .AddExtraData("CodigoCarga", codigoCarga)
                .CallReport();

            if (result == null)
                throw new ServicoException("Retorno nulo da ReportAPI");

            Servicos.Log.TratarErro($"Report result FullPath: {result.FullPath}, Execution Status: {result.ExecutionStatus}, Error Message: {result.ErrorMessage ?? "None"}", "ObterLotePDFsAgrupado", TipoLogSistema.Info);

            return result.GetContentFile();
        }

        public static bool EnviarRelatorioDetalhesCargaPorEmail(int codigoCarga, List<string> emails, string observacao, Repositorio.UnitOfWork unidadeTrabalho, Dominio.Entidades.Usuario usuario, out string mensagem)
        {
            Repositorio.Embarcador.Email.ConfigEmailDocTransporte repConfigEmailDocTransporte = new Repositorio.Embarcador.Email.ConfigEmailDocTransporte(unidadeTrabalho);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unidadeTrabalho);

            Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigo(codigoCarga);
            Dominio.Entidades.Embarcador.Email.ConfigEmailDocTransporte email = repConfigEmailDocTransporte.BuscarEmailEnviaDocumentoAtivo();

            if (email == null)
            {
                mensagem = "Não há um e-mail configurado para realizar o envio.";
                return false;
            }

            byte[] pdf = GerarRelatorioDetalhesCarga(codigoCarga, unidadeTrabalho);

            if (pdf == null)
            {
                mensagem = "Não foi possível gerar o relatório de detalhes da carga. Tente novamente.";
                return false;
            }

            string assunto = carga.Filial.Localidade.Descricao + " - Carga " + carga.CodigoCargaEmbarcador + " - " + carga.Empresa?.RazaoSocial;

            string mensagemEmail = "Olá,<br/><br/>Seguem em anexo os detalhes da carga <b>" + carga.CodigoCargaEmbarcador + "</b>, do transportador " + carga.Empresa?.RazaoSocial + ".<br/><br/>";

            if (!string.IsNullOrWhiteSpace(observacao))
                mensagemEmail += "Observação: " + observacao + "<br/><br/>";

            mensagemEmail += "E-mail enviado automaticamente. Por favor, não responda.";

            bool sucesso = Servicos.Email.EnviarEmail(email.Email, email.Email, email.Senha, null, emails.ToArray(), null, assunto, mensagemEmail, email.Smtp, out mensagem, email.DisplayEmail, new List<System.Net.Mail.Attachment>() { new System.Net.Mail.Attachment(new System.IO.MemoryStream(pdf), "Carga " + carga.CodigoCargaEmbarcador + ".pdf", "application/pdf") }, carga.Filial?.Descricao, email.RequerAutenticacaoSmtp, "", email.PortaSmtp, unidadeTrabalho);

            if (sucesso)
            {
                Repositorio.Embarcador.Cargas.CargaEnvioEmailLog repCargaEnvioEmailLog = new Repositorio.Embarcador.Cargas.CargaEnvioEmailLog(unidadeTrabalho);

                Dominio.Entidades.Embarcador.Cargas.CargaEnvioEmailLog cargaEnvioEmailLog = new Dominio.Entidades.Embarcador.Cargas.CargaEnvioEmailLog()
                {
                    Carga = carga,
                    Usuario = usuario,
                    Data = DateTime.Now,
                    Emails = string.Join("; ", emails),
                    Observacao = observacao
                };

                repCargaEnvioEmailLog.Inserir(cargaEnvioEmailLog);
            }

            return sucesso;
        }

        public static void CalcularValoresDescarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, bool rateioFreteFilialEmissora, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unidadeTrabalho)
        {
            Repositorio.Embarcador.Configuracoes.ConfiguracaoTabelaFrete repConfigTabelaFrete = new Repositorio.Embarcador.Configuracoes.ConfiguracaoTabelaFrete(unidadeTrabalho);
            Repositorio.Embarcador.Frete.ConfiguracaoDescargaCliente repositorioConfiguracaoDescargaCliente = new Repositorio.Embarcador.Frete.ConfiguracaoDescargaCliente(unidadeTrabalho);
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unidadeTrabalho);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoTaxaDescargaAjudantes repConfiguracaoTaxaDescarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoTaxaDescargaAjudantes(unidadeTrabalho);
            //Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoTaxaDescarga configuracaoTaxaDescarga = repConfiguracaoTaxaDescarga.
            if (configuracaoEmbarcador.UtilizarValorDescarga)
                return;

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
            {
                cargaPedido.ValorDescarga = 0;
                cargaPedido.ConfiguracaoDescarga = null;

                repositorioCargaPedido.Atualizar(cargaPedido);
            }

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoTabelaFrete configuracaoTabelaFrete = repConfigTabelaFrete.BuscarPrimeiroRegistro();
            DateTime? dataValidarVigencia = configuracaoTabelaFrete.UtilizarVigenciaConfiguracaoDescargaCliente ? DateTime.Now : null;
            List<double> cpfCnpjDestino = cargaPedidos.Select(cargaPedido => (cargaPedido.Recebedor ?? cargaPedido.Pedido.Destinatario)?.CPF_CNPJ ?? 0).ToList();
            List<Dominio.Entidades.Embarcador.Frete.ConfiguracaoDescargaCliente> configuracoesDescarga = repositorioConfiguracaoDescargaCliente.BuscarConfiguracoesValidas(carga.Filial?.Codigo ?? 0, carga.TipoDeCarga?.Codigo ?? 0, carga.ModeloVeicularCarga?.Codigo ?? 0, dataValidarVigencia, cpfCnpjDestino);

            if (configuracoesDescarga.Count == 0)
                return;

            if (configuracoesDescarga.Any(x => x.Transportadores.Count > 0))
                ValidarFiltroTransportadoresDescarga(configuracoesDescarga, carga);


            bool tipoOperacaoIsentoValorDescarga = (carga.Filial != null) && (carga.TipoOperacao != null) && carga.Filial.TipoOperacoesIsencaoValorDescargaCliente.Contains(carga.TipoOperacao);
            bool somenteRemoverValorDescarga = (carga.Filial?.NaoAdicionarValorDescarga ?? false) || tipoOperacaoIsentoValorDescarga;

            if (somenteRemoverValorDescarga)
                return;

            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repositorioPedidoXmlNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unidadeTrabalho);
            Repositorio.Embarcador.Cargas.TipoIntegracao repositorioTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unidadeTrabalho);


            bool considerarVolumesNotasSemRemessaPallet = repositorioTipoIntegracao.ExistePorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Unilever);
            bool adicionouComponentePorCliente = false;

            foreach (Dominio.Entidades.Embarcador.Frete.ConfiguracaoDescargaCliente configuracaoDescarga in configuracoesDescarga)
            {
                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosValorDescarga = (from obj in cargaPedidos where configuracaoDescarga.Clientes.Contains(obj.Recebedor ?? obj.Pedido.Destinatario) select obj).ToList();

                if (cargaPedidosValorDescarga.Count == 0)
                    continue;

                decimal totalDescarga = 0;
                int codigoUltimoCargaPedido = cargaPedidosValorDescarga.LastOrDefault().Codigo;
                bool tipoOperacaoNaoPermiteCalcularValorDescarga = (carga.TipoOperacao != null) && (configuracaoDescarga.TiposOperacoes.Count > 0) && !configuracaoDescarga.TiposOperacoes.Any(tipoOperacao => tipoOperacao.Codigo == carga.TipoOperacao.Codigo);

                int quantidadeVolumenPedidos = cargaPedidosValorDescarga.Select(x => x.QtVolumes).Sum();
                Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoTaxaDescargaAjudantes existeConfiguracaoTaxaDescargaAjudante = repConfiguracaoTaxaDescarga.BuscarPorQuantidadeVolumens(quantidadeVolumenPedidos);

                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidosValorDescarga)
                {
                    cargaPedido.ValorDescarga = 0m;

                    if (tipoOperacaoNaoPermiteCalcularValorDescarga)
                    {
                        cargaPedido.ConfiguracaoDescarga = null;
                        repositorioCargaPedido.Atualizar(cargaPedido);
                        continue;
                    }

                    if (configuracaoDescarga.Valor > 0m)
                    {
                        decimal novoValor = Math.Round(configuracaoDescarga.Valor / cargaPedidosValorDescarga.Count, 2, MidpointRounding.AwayFromZero);

                        totalDescarga += novoValor;

                        if (cargaPedido.Codigo == codigoUltimoCargaPedido)
                            novoValor += configuracaoDescarga.Valor - totalDescarga;

                        cargaPedido.ValorDescarga += novoValor;
                    }

                    if (configuracaoDescarga.ValorTonelada > 0m)
                    {
                        decimal pesoEmToneladas = cargaPedido.Peso > 0m ? cargaPedido.Peso / 1000 : 0m;
                        cargaPedido.ValorDescarga += configuracaoDescarga.ValorTonelada * pesoEmToneladas;
                    }

                    if (configuracaoDescarga.ValorUnidade > 0m)
                    {
                        if (considerarVolumesNotasSemRemessaPallet)
                            cargaPedido.ValorDescarga += configuracaoDescarga.ValorUnidade * repositorioPedidoXmlNotaFiscal.BuscarVolumesPorCargaPedidoSemPallet(cargaPedido.Codigo);
                        else
                            cargaPedido.ValorDescarga += configuracaoDescarga.ValorUnidade * cargaPedido.Pedido.QtVolumes;
                    }

                    if (configuracaoDescarga.ValorPallet > 0m)
                        cargaPedido.ValorDescarga += configuracaoDescarga.ValorPallet * (cargaPedido.Pallet > 0 ? cargaPedido.Pallet : cargaPedido.Pedido.TotalPallets);

                    if (configuracaoDescarga.ValorAjudante > 0m && existeConfiguracaoTaxaDescargaAjudante != null)
                        cargaPedido.ValorDescarga = existeConfiguracaoTaxaDescargaAjudante.QuantidadeAjudantes * configuracaoDescarga.ValorAjudante;

                    cargaPedido.ConfiguracaoDescarga = configuracaoDescarga;

                    repositorioCargaPedido.Atualizar(cargaPedido);
                    adicionouComponentePorCliente = true;
                }
            }

            if (adicionouComponentePorCliente)
            {
                Servicos.Embarcador.Carga.CargaPedido servicoCargaPedido = new Servicos.Embarcador.Carga.CargaPedido(unidadeTrabalho);

                servicoCargaPedido.RemoverValorDescarga(carga, rateioFreteFilialEmissora, unidadeTrabalho, tipoServicoMultisoftware);
            }
        }

        public static void CalcularValorDescargaPorCargaPedido(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (!configuracaoEmbarcador.UtilizarValorDescarga)
                return;

            if (cargaPedido.Pedido.Destinatario == null)
            {
                cargaPedido.ValorDescarga = 0m;
                return;
            }

            double cpfCnpjDestino = (cargaPedido.Recebedor ?? cargaPedido.Pedido.Destinatario)?.CPF_CNPJ ?? 0;
            Repositorio.Embarcador.Pessoas.ClienteDescarga repositorioClienteDescarga = new Repositorio.Embarcador.Pessoas.ClienteDescarga(unidadeTrabalho);
            List<Dominio.Entidades.Embarcador.Pessoas.ClienteDescarga> clienteDescargas = repositorioClienteDescarga.BuscarListaPorPessoa(cpfCnpjDestino);

            if (clienteDescargas.Count == 0)
                return;

            Dominio.Entidades.Embarcador.Pessoas.ClienteDescarga clienteDescarga = null;

            if (clienteDescargas.Count > 0)
            {
                double cpfCnpjOrigem = (cargaPedido.Expedidor ?? cargaPedido.Pedido.Remetente)?.CPF_CNPJ ?? 0;
                clienteDescarga = (from obj in clienteDescargas where obj.ClienteOrigem != null && obj.ClienteOrigem.CPF_CNPJ == cpfCnpjOrigem select obj).FirstOrDefault();

                if (clienteDescarga == null)
                    clienteDescarga = (from obj in clienteDescargas where obj.ClienteOrigem == null select obj).FirstOrDefault();
            }

            if (clienteDescarga == null)
                return;

            decimal valorDescarga = 0m;

            if (clienteDescarga.ValorPorPallet > 0m)
                valorDescarga += cargaPedido.Pedido.NumeroPaletes * clienteDescarga.ValorPorPallet;

            if (clienteDescarga.ValorPorVolume > 0m)
            {
                Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repositorioPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unidadeTrabalho);
                int quantidadeVolumes = repositorioPedidoXMLNotaFiscal.BuscarVolumesPorCargaPedido(cargaPedido.Codigo);

                if (quantidadeVolumes <= 0)
                    quantidadeVolumes = cargaPedido.Pedido.QtVolumes;

                if (quantidadeVolumes > 0)
                    valorDescarga += quantidadeVolumes * clienteDescarga.ValorPorVolume;
            }

            if (valorDescarga > 0)
                cargaPedido.ValorDescarga = valorDescarga;
        }

        public static bool VerificarSeGeraMovimentacaoAgrupadaPorPedido(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unidadeTrabalho)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unidadeTrabalho);

            Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido = repCargaPedido.BuscarPrimeiroPedidoPorCarga(carga.Codigo);

            if (cargaPedido == null)
                return false;

            Dominio.Entidades.Cliente tomador = cargaPedido.ObterTomador();

            if (tomador != null)
            {
                if (cargaPedido.Carga.TipoOperacao != null && cargaPedido.Carga.TipoOperacao.UsarConfiguracaoEmissao)
                    return cargaPedido.Carga.TipoOperacao.AgruparMovimentoFinanceiroPorPedido;
                else if (tomador.NaoUsarConfiguracaoEmissaoGrupo || tomador.GrupoPessoas == null)
                    return tomador.AgruparMovimentoFinanceiroPorPedido;
                else
                    return tomador.GrupoPessoas.AgruparMovimentoFinanceiroPorPedido;
            }
            else
            {
                if (cargaPedido.Pedido.GrupoPessoas != null)
                    return cargaPedido.Pedido.GrupoPessoas.AgruparMovimentoFinanceiroPorPedido;
            }

            return false;
        }

        public static bool VerificarSePossuiValePedagioObrigatorio(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unidadeTrabalho)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unidadeTrabalho);

            Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido = repCargaPedido.BuscarPrimeiroPedidoPorCarga(carga.Codigo);

            Dominio.Entidades.Cliente tomador = cargaPedido.ObterTomador();

            if (tomador != null)
            {
                if (cargaPedido.Carga.TipoOperacao != null && cargaPedido.Carga.TipoOperacao.UsarConfiguracaoEmissao)
                    return cargaPedido.Carga.TipoOperacao.ValePedagioObrigatorio;
                else if (tomador.NaoUsarConfiguracaoEmissaoGrupo || tomador.GrupoPessoas == null)
                    return tomador.ValePedagioObrigatorio;
                else
                    return tomador.GrupoPessoas.ValePedagioObrigatorio;
            }
            else
            {
                if (cargaPedido.Pedido.GrupoPessoas != null)
                    return cargaPedido.Pedido.GrupoPessoas.ValePedagioObrigatorio;
            }

            return false;
        }

        public static bool VerificarSeGeraTituloAutomaticamente(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unidadeTrabalho, out bool gerarFaturamentoAVista, out bool gerarBoletoAutomaticamente, out int codigoBoletoConfiguracao, out bool enviarBoletoPorEmailAutomaticamente, out bool enviarDocumentacaoFaturamentoCTe)
        {
            codigoBoletoConfiguracao = 0;
            gerarFaturamentoAVista = false;
            gerarBoletoAutomaticamente = false;
            enviarBoletoPorEmailAutomaticamente = false;
            enviarDocumentacaoFaturamentoCTe = false;
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unidadeTrabalho);
            Repositorio.Embarcador.Configuracoes.AcordoFaturamentoCliente repAcordo = new Repositorio.Embarcador.Configuracoes.AcordoFaturamentoCliente(unidadeTrabalho);

            Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido = repCargaPedido.BuscarPrimeiroPedidoPorCarga(carga.Codigo);

            if (cargaPedido == null)
                return false;

            Dominio.Entidades.Cliente tomador = cargaPedido.ObterTomador();

            if (tomador != null)
            {
                Dominio.Entidades.Embarcador.Configuracoes.AcordoFaturamentoCliente acordoCliente = repAcordo.BuscarAcordoCliente(tomador.CPF_CNPJ, 0);
                if (acordoCliente == null && tomador.GrupoPessoas != null)
                    acordoCliente = repAcordo.BuscarAcordoCliente(0, tomador.GrupoPessoas.Codigo);

                if (acordoCliente != null)
                {
                    if (cargaPedido.Carga.TipoOperacao != null && cargaPedido.Carga.TipoOperacao.ConfiguracaoCarga != null && cargaPedido.Carga.TipoOperacao.ConfiguracaoCarga.AcordoFaturamento.ToString() != "0" && cargaPedido.Carga.TipoOperacao.ConfiguracaoCarga.AcordoFaturamento != TipoAcordoFaturamento.NaoInformado)
                    {
                        if (cargaPedido.Carga.TipoOperacao.ConfiguracaoCarga.AcordoFaturamento == TipoAcordoFaturamento.FreteLongoCurso)
                        {
                            if (acordoCliente.LongoCursoGerarFaturamentoAVista)
                            {
                                gerarFaturamentoAVista = true;
                                return true;
                            }
                        }
                        if (cargaPedido.Carga.TipoOperacao.ConfiguracaoCarga.AcordoFaturamento == TipoAcordoFaturamento.CustoExtra)
                        {
                            if (acordoCliente.CustoExtraGerarFaturamentoAVista)
                            {
                                gerarFaturamentoAVista = true;
                                return true;
                            }
                        }
                    }

                    if (cargaPedido.TipoPropostaMultimodal == TipoPropostaMultimodal.VAS)
                    {
                        if (acordoCliente.LongoCursoGerarFaturamentoAVista)
                        {
                            gerarFaturamentoAVista = true;
                            return true;
                        }
                    }
                    else if (cargaPedido.TipoPropostaMultimodal == TipoPropostaMultimodal.CargaFechada || cargaPedido.TipoPropostaMultimodal == TipoPropostaMultimodal.CargaFracionada || cargaPedido.TipoPropostaMultimodal == TipoPropostaMultimodal.Feeder)
                    {
                        if (acordoCliente.CabotagemGerarFaturamentoAVista)
                        {
                            gerarFaturamentoAVista = true;
                            return true;
                        }
                    }
                    else if (acordoCliente.CustoExtraGerarFaturamentoAVista)
                    {
                        gerarFaturamentoAVista = true;
                        return true;
                    }
                }
            }

            if (cargaPedido != null && cargaPedido.Pedido != null && cargaPedido.Pedido.PedidoTipoPagamento != null && cargaPedido.Pedido.PedidoTipoPagamento.FormaPagamento.HasValue)
            {
                if (cargaPedido.Pedido.PedidoTipoPagamento.FormaPagamento.Value == Dominio.ObjetosDeValor.Embarcador.Enumeradores.FormaPagamento.Avista)
                {
                    gerarFaturamentoAVista = true;
                    return true;
                }
                else if (cargaPedido.Pedido.PedidoTipoPagamento.FormaPagamento.Value == Dominio.ObjetosDeValor.Embarcador.Enumeradores.FormaPagamento.GerarTituloAutomaticamente)
                    return true;

            }

            if (tomador != null)
            {
                if (carga.TipoOperacao?.UsarConfiguracaoFaturaPorTipoOperacao ?? false && carga.TipoOperacao?.ConfiguracaoTipoOperacaoFatura != null)
                {
                    enviarBoletoPorEmailAutomaticamente = carga.TipoOperacao?.ConfiguracaoTipoOperacaoFatura?.EnviarBoletoPorEmailAutomaticamente ?? false;
                    enviarDocumentacaoFaturamentoCTe = carga.TipoOperacao?.ConfiguracaoTipoOperacaoFatura?.EnviarDocumentacaoFaturamentoCTe ?? false;
                    gerarBoletoAutomaticamente = carga.TipoOperacao?.ConfiguracaoTipoOperacaoFatura?.GerarBoletoAutomaticamente ?? false;
                    codigoBoletoConfiguracao = carga.TipoOperacao?.ConfiguracaoTipoOperacaoFatura?.BoletoConfiguracao?.Codigo ?? 0;
                    if (carga.TipoOperacao?.ConfiguracaoTipoOperacaoFatura?.GerarFaturamentoAVista ?? false)
                    {
                        gerarFaturamentoAVista = true;
                        return true;
                    }
                    else
                        return carga.TipoOperacao?.ConfiguracaoTipoOperacaoFatura?.GerarTituloAutomaticamente ?? false
                            || (carga.TipoOperacao?.ConfiguracaoTipoOperacaoFatura?.GerarTituloAutomaticamenteComAdiantamentoSaldo ?? false);
                }
                else if (tomador.NaoUsarConfiguracaoFaturaGrupo || tomador.GrupoPessoas == null)
                {
                    enviarBoletoPorEmailAutomaticamente = tomador.EnviarBoletoPorEmailAutomaticamente;
                    enviarDocumentacaoFaturamentoCTe = tomador.EnviarDocumentacaoFaturamentoCTe;
                    gerarBoletoAutomaticamente = tomador.GerarBoletoAutomaticamente;
                    codigoBoletoConfiguracao = tomador.BoletoConfiguracao?.Codigo ?? 0;
                    if (tomador.GerarFaturamentoAVista)
                    {
                        gerarFaturamentoAVista = true;
                        return true;
                    }
                    else
                        return tomador.GerarTituloAutomaticamente || (tomador.ConfiguracaoFatura?.GerarTituloAutomaticamenteComAdiantamentoSaldo ?? false);
                }
                else
                {
                    gerarBoletoAutomaticamente = tomador.GrupoPessoas.GerarBoletoAutomaticamente;
                    enviarBoletoPorEmailAutomaticamente = tomador.GrupoPessoas.EnviarBoletoPorEmailAutomaticamente;
                    enviarDocumentacaoFaturamentoCTe = tomador.GrupoPessoas.EnviarDocumentacaoFaturamentoCTe;
                    codigoBoletoConfiguracao = tomador.GrupoPessoas.BoletoConfiguracao?.Codigo ?? 0;
                    if (tomador.GrupoPessoas.GerarFaturamentoAVista)
                    {
                        gerarFaturamentoAVista = true;
                        return true;
                    }
                    else
                        return tomador.GrupoPessoas.GerarTituloAutomaticamente || (tomador.GrupoPessoas.ConfiguracaoFatura?.GerarTituloAutomaticamenteComAdiantamentoSaldo ?? false);
                }
            }
            else
            {
                if (cargaPedido.Pedido.GrupoPessoas != null)
                {
                    gerarBoletoAutomaticamente = cargaPedido.Pedido.GrupoPessoas.GerarBoletoAutomaticamente;
                    enviarBoletoPorEmailAutomaticamente = cargaPedido.Pedido.GrupoPessoas.EnviarBoletoPorEmailAutomaticamente;
                    enviarDocumentacaoFaturamentoCTe = cargaPedido.Pedido.GrupoPessoas.EnviarDocumentacaoFaturamentoCTe;
                    codigoBoletoConfiguracao = cargaPedido.Pedido.GrupoPessoas.BoletoConfiguracao?.Codigo ?? 0;
                    if (cargaPedido.Pedido.GrupoPessoas.GerarFaturamentoAVista)
                    {
                        gerarFaturamentoAVista = true;
                        return true;
                    }
                    else
                        return cargaPedido.Pedido.GrupoPessoas.GerarTituloAutomaticamente || (cargaPedido.Pedido.GrupoPessoas.ConfiguracaoFatura?.GerarTituloAutomaticamenteComAdiantamentoSaldo ?? false);
                }
            }

            return false;
        }

        public static void ProcessarCargaSVMEmProcessamentoDocumentosFiscais(Repositorio.UnitOfWork unitOfWork, string stringConexao, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Servicos.Embarcador.Carga.CTe serCTe = new Servicos.Embarcador.Carga.CTe(unitOfWork);

            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repositorioConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = repositorioConfiguracaoTMS.BuscarConfiguracaoPadrao();

            List<int> codigosCargas = repCarga.BuscarCargasSVMEmProcessamentoDocumentosFiscais();

            for (int i = 0; i < codigosCargas.Count; i++)
            {
                Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigo(codigosCargas[i]);

                carga.DataInicioEmissaoDocumentos = DateTime.Now;
                carga.DataEnvioUltimaNFe = DateTime.Now;
                carga.problemaAverbacaoCTe = false;
                carga.problemaEmissaoNFeRemessa = false;
                if (serCTe.VerificarSePodeEmitirAutomaticamente(tipoServicoMultisoftware, carga, configuracaoEmbarcador.AtivarAutorizacaoAutomaticaDeTodasCargas))
                    carga.CTesEmDigitacao = false;
                else
                    carga.CTesEmDigitacao = true;
                carga.DataInicioGeracaoCTes = DateTime.Now;

                repCarga.Atualizar(carga);

                unitOfWork.FlushAndClear();
            }
        }

        public void ProcessarCargaParaAvancoAutomaticoEtapaFrete(Repositorio.UnitOfWork unitOfWork, string stringConexao, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, string webServiceConsultaCTe, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repositorioConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);

            Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = repositorioConfiguracaoTMS.BuscarConfiguracaoPadrao();

            List<int> codigosCargas = repCarga.BuscarCargasParaAvancoAutomaticoEtapaFrete(configuracaoEmbarcador.ExigirCargaRoteirizada);

            for (int i = 0; i < codigosCargas.Count; i++)
            {
                Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigo(codigosCargas[i]);

                string mensagem = null;

                if (!ValidarInicioEmissaoDocumentosMultiModal(carga, configuracaoEmbarcador, unitOfWork) ||
                    !serCarga.IniciarEmissaoDocumentosCarga(out mensagem, out object retorno, carga, carga.Operador, auditado, configuracaoEmbarcador, tipoServicoMultisoftware, unitOfWork, webServiceConsultaCTe))
                {
                    unitOfWork.Clear();

                    carga = repCarga.BuscarPorCodigo(carga.Codigo);

                    carga.NaoAvancarAutomaticamenteEtapaFretePorPendencia = true;
                    carga.MotivoPendencia = mensagem;

                    repCarga.Atualizar(carga);
                }

                unitOfWork.FlushAndClear();
            }
        }

        public static void EncerrarMDFeRodoviarioAutomaticamente(Repositorio.UnitOfWork unitOfWork, string stringConexao, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado)
        {
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repositorioConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = repositorioConfiguracaoTMS.BuscarConfiguracaoPadrao();

            if (!configuracaoEmbarcador.EncerrarMDFeAutomaticamente)
                return;

            Repositorio.ManifestoEletronicoDeDocumentosFiscais repMDFe = new Repositorio.ManifestoEletronicoDeDocumentosFiscais(unitOfWork);
            List<Dominio.Entidades.ManifestoEletronicoDeDocumentosFiscais> mdfes = repMDFe.BuscarMDFesPendentesEncerramento();
            foreach (Dominio.Entidades.ManifestoEletronicoDeDocumentosFiscais mdfe in mdfes)
            {
                unitOfWork.Start();
                if (Auditado != null)
                    Servicos.Auditoria.Auditoria.Auditar(Auditado, mdfe, null, "Gerou Encerramento do MDF-e a partir da Data de Previsão", unitOfWork);

                if (mdfe.MunicipiosDescarregamento != null && mdfe.MunicipiosDescarregamento.Count > 0)
                {
                    int codigoUltimoMunicipio = mdfe.MunicipiosDescarregamento[mdfe.MunicipiosDescarregamento.Count - 1]?.Municipio?.Codigo ?? 0;
                    if (codigoUltimoMunicipio > 0)
                        Servicos.Embarcador.Carga.MDFe.EncerrarMDFe(out string erro, mdfe.Codigo, codigoUltimoMunicipio, DateTime.Now, "", null, unitOfWork, stringConexao, Auditado);
                }
                unitOfWork.CommitChanges();
            }

        }

        public static void EncerrarMDFeAquaviarioAutomaticamente(Repositorio.UnitOfWork unitOfWork, string stringConexao, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado)
        {
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repositorioConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = repositorioConfiguracaoTMS.BuscarConfiguracaoPadrao();

            Repositorio.Embarcador.Pedidos.PedidoViagemNavioSchedule repPedidoViagemNavioSchedule = new Repositorio.Embarcador.Pedidos.PedidoViagemNavioSchedule(unitOfWork);
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoViagemNavioSchedule> schedulesConfirmado = repPedidoViagemNavioSchedule.BuscarPorETSConfirmadAguardandoEncerramento();
            if (configuracaoEmbarcador.EncerrarMDFeAutomaticamente && schedulesConfirmado != null && schedulesConfirmado.Count > 0)
            {
                unitOfWork.Start();
                foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoViagemNavioSchedule schedule in schedulesConfirmado)
                {
                    Servicos.Embarcador.Carga.MDFe.EncerrarMDFePeloETSConfirmado(out string erro, null, "", schedule.PedidoViagemNavio.Codigo, schedule.PortoAtracacao.Codigo, unitOfWork, stringConexao, Auditado);
                }
                unitOfWork.CommitChanges();
            }

        }

        public void ProcessarCargaParaAvancoAutomaticoDocumentosFiscais(Repositorio.UnitOfWork unitOfWork, string stringConexao, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);
            Servicos.Embarcador.Carga.CTe serCTe = new Servicos.Embarcador.Carga.CTe(unitOfWork);

            Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao repPedidoCTeParaSubContratacao = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repositorioConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = repositorioConfiguracaoTMS.BuscarConfiguracaoPadrao();

            List<int> codigosCargas = repCarga.BuscarCargasParaAvancoAutomaticoDocumentosFiscais();
            List<int> codigosCargasSub = repCarga.BuscarCargasParaAvancoAutomaticoCTeDocumentosFiscais();

            codigosCargas.AddRange(codigosCargasSub);

            for (int i = 0; i < codigosCargas.Count; i++)
            {
                bool contemDestinatario = true;

                Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigo(codigosCargas[i]);
                contemDestinatario = !repCargaPedido.NaoContemDestinatarioPedido(carga.Codigo);
                if (carga.Pedidos != null && carga.Pedidos.Count > 0 && contemDestinatario)
                {
                    bool enviouTodosDocumentos = true;
                    foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido pedido in carga.Pedidos)
                    {
                        if (pedido.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro
                            && pedido.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada
                            && pedido.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho
                            && pedido.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario)
                        {
                            int numeroNotasFiscais = repPedidoXMLNotaFiscal.ContarPorCargaPedido(pedido.Codigo);

                            if (numeroNotasFiscais == 0)
                            {
                                enviouTodosDocumentos = false;
                                break;
                            }
                        }
                        else if (pedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro
                            || pedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada
                            || pedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho
                            || pedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario
                            || pedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.NormalESubContratada)
                        {
                            if (!repPedidoCTeParaSubContratacao.ExistePorCargaPedido(pedido.Codigo))
                            {
                                enviouTodosDocumentos = false;
                                break;
                            }
                        }

                        if (enviouTodosDocumentos)
                        {
                            bool exigirInformarNCM = carga.TipoOperacao?.ExigirInformarNCM ?? false;
                            bool contemNotaSemNCM = false;
                            if (exigirInformarNCM)
                            {
                                if (!carga.CargaSVMTerceiro && carga.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMProprio && carga.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho && carga.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario
                                    && carga.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro && carga.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada)
                                {
                                    if (exigirInformarNCM && repPedidoXMLNotaFiscal.ContemDocumentoSemNCM(carga.Codigo))
                                        contemNotaSemNCM = true;
                                    else
                                        contemNotaSemNCM = false;
                                }
                                else if (carga.CargaSVMTerceiro || carga.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMProprio || carga.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho || carga.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario
                                    || carga.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro || carga.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada)
                                {
                                    bool contemNotaEletronica = repPedidoCTeParaSubContratacao.ContemNotaEletronicaNaCarga(carga.Codigo);

                                    if (contemNotaEletronica && exigirInformarNCM && repPedidoCTeParaSubContratacao.ContemDocumentoSemNCM(carga.Codigo))
                                        contemNotaSemNCM = true;
                                    else if (!contemNotaEletronica && exigirInformarNCM && repPedidoCTeParaSubContratacao.ContemOutroDocumentoSemNCM(carga.Codigo))
                                        contemNotaSemNCM = true;
                                    else
                                        contemNotaSemNCM = false;
                                }
                            }

                            bool exigirInformarPeso = carga.TipoOperacao?.ExigirInformarPeso ?? false;
                            bool contemNotaSemPeso = false;
                            if (exigirInformarPeso)
                            {
                                if (!carga.CargaSVMTerceiro && carga.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMProprio && carga.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho && carga.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario
                                    && carga.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro && carga.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada)
                                {
                                    if (exigirInformarPeso && repPedidoXMLNotaFiscal.ContemDocumentoSemPeso(carga.Codigo))
                                        contemNotaSemPeso = true;
                                    else
                                        contemNotaSemPeso = false;
                                }
                                else if (carga.CargaSVMTerceiro || carga.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMProprio || carga.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho || carga.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario
                                    || carga.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro || carga.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada)
                                {
                                    bool contemNotaEletronica = repPedidoCTeParaSubContratacao.ContemNotaEletronicaNaCarga(carga.Codigo);

                                    if (contemNotaEletronica && exigirInformarPeso && repPedidoCTeParaSubContratacao.ContemDocumentoSemPeso(carga.Codigo))
                                        contemNotaSemPeso = true;
                                    else
                                        contemNotaSemPeso = false;
                                }
                            }

                            bool contemPedidoSemProduto = false;
                            bool exgirInformarProduto = carga.TipoOperacao?.ExigeProdutoEmbarcadorPedido ?? false;
                            if (exgirInformarProduto && (pedido.Pedido.Produtos == null || pedido.Pedido.Produtos.Count == 0))
                                contemPedidoSemProduto = true;

                            bool contemPedidoMesmaLocalidade = false;
                            bool bloquearEmisssaoComMesmoLocalDeOrigemEDestino = carga.TipoOperacao?.BloquearEmisssaoComMesmoLocalDeOrigemEDestino ?? false;
                            if (bloquearEmisssaoComMesmoLocalDeOrigemEDestino && pedido.Destino != null && pedido.Origem != null && pedido.Destino.CodigoIBGE == pedido.Origem.CodigoIBGE)
                                contemPedidoMesmaLocalidade = true;

                            if (contemNotaSemNCM && pedido.Pedido.Produtos != null && pedido.Pedido.Produtos.Count > 0)
                                contemNotaSemNCM = pedido.Pedido.Produtos.Any(p => p.Produto.CodigoNCM == "" || p.Produto.CodigoNCM == null);

                            if (!contemNotaSemNCM && !contemNotaSemPeso && !contemPedidoSemProduto && !contemPedidoMesmaLocalidade)
                            {
                                carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe;
                                carga.NaoGerarMDFe = true;
                                if (!carga.CargaDestinadaCTeComplementar)
                                    carga.NaoExigeVeiculoParaEmissao = true;
                                carga.ProcessandoDocumentosFiscais = true;
                                carga.DataInicioConfirmacaoDocumentosFiscais = DateTime.Now;
                            }
                            else
                                carga.NaoAvancarAutomaticamenteEtapaDocumentoPorPendencia = true;

                            repCarga.Atualizar(carga);
                        }
                    }
                }

                unitOfWork.FlushAndClear();
            }

            serCarga.VerificarHorasParaAvancoEtapaDadosTransporte(unitOfWork);
        }

        public void ProcessarCargaEmProcessamentoDocumentosFiscais(Repositorio.UnitOfWork unitOfWork, string stringConexao, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, AdminMultisoftware.Dominio.Entidades.Pessoas.Cliente clienteMultisoftware)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracao = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao = repConfiguracao.BuscarConfiguracaoPadrao();

            List<int> codigosCargas = repCarga.BuscarCargasEmProcessamentoDocumentosFiscais(configuracao.ProcessarFilaDocumentosEmLote);

            for (int i = 0; i < codigosCargas.Count; i++)
            {
                try
                {
                    Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigoFetch(codigosCargas[i]);
                    configuracao = repConfiguracao.BuscarConfiguracaoPadrao();

                    carga.PosicaoFilaProcessamento++;

                    repCarga.Atualizar(carga);

                    ConfirmarEnvioDosDocumentos(carga, unitOfWork, stringConexao, tipoServicoMultisoftware, configuracao, auditado, clienteMultisoftware);

                    unitOfWork.FlushAndClear();
                }
                catch (Exception ex)
                {
                    unitOfWork.Rollback();
                    Log.TratarErro($"Erro ao processar documentos fiscais carga {codigosCargas[i]}: {ex.Message}", "ConfirmarEnvioDosDocumentos");
                    Log.TratarErro(ex, "ConfirmarEnvioDosDocumentos");
                }

            }
        }

        public void ProcessarCargaEmProcessamentoDocumentosFiscaisEmLote(Repositorio.UnitOfWork unitOfWork, string stringConexao, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, AdminMultisoftware.Dominio.Entidades.Pessoas.Cliente clienteMultisoftware)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracao = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao = repConfiguracao.BuscarConfiguracaoPadrao();
            bool processarFilaDocumentosEmLote = configuracao.ProcessarFilaDocumentosEmLote;

            if (processarFilaDocumentosEmLote)
            {
                List<int> codigosCargasLote = repCarga.BuscarCargasEmProcessamentoDocumentosFiscaisEmLote();

                for (int i = 0; i < codigosCargasLote.Count; i++)
                {
                    Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigo(codigosCargasLote[i]);
                    configuracao = repConfiguracao.BuscarConfiguracaoPadrao();
                    ConfirmarEnvioDosDocumentos(carga, unitOfWork, stringConexao, tipoServicoMultisoftware, configuracao, auditado, clienteMultisoftware);

                    unitOfWork.FlushAndClear();
                }
            }
        }

        public void ConfirmarEnvioDosDocumentos(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork, string stringConexao, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, AdminMultisoftware.Dominio.Entidades.Pessoas.Cliente clienteMultisoftware, bool utilizarInsertEmMassa = false)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao repPedidoCTeParaSubContratacao = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscalProduto repXMLNotaFiscalProduto = new Repositorio.Embarcador.Pedidos.XMLNotaFiscalProduto(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repxMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntregaPedido repCargaEntregaPedido = new Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntregaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.RetiradaContainer repositorioRetiradaContainer = new Repositorio.Embarcador.Pedidos.RetiradaContainer(unitOfWork);
            Repositorio.Embarcador.Configuracoes.IntegracaoIntercab repIntegracaoIntercab = new Repositorio.Embarcador.Configuracoes.IntegracaoIntercab(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoQuantidades repCargaPedidoQuantidade = new Repositorio.Embarcador.Cargas.CargaPedidoQuantidades(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoEmissaoDocumentoEmbarcador repConfiguracaoEmissaoDocumentoEmbarcador = new Repositorio.Embarcador.Configuracoes.ConfiguracaoEmissaoDocumentoEmbarcador(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoPedido repConfiguracaoPedido = new Repositorio.Embarcador.Configuracoes.ConfiguracaoPedido(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoControleEntrega repConfiguracaoControleEntrega = new Repositorio.Embarcador.Configuracoes.ConfiguracaoControleEntrega(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoAprovacao repositorioConfiguracaoAprovacao = new Repositorio.Embarcador.Configuracoes.ConfiguracaoAprovacao(unitOfWork);

            Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);
            Servicos.Embarcador.Carga.CargaDadosSumarizados serCargaDadosSumarizados = new Servicos.Embarcador.Carga.CargaDadosSumarizados(unitOfWork);
            Servicos.Embarcador.Carga.CargaLocaisPrestacao serCargaLocaisPrestacao = new Servicos.Embarcador.Carga.CargaLocaisPrestacao(unitOfWork);
            Servicos.Embarcador.Carga.CTe serCargaCTe = new Servicos.Embarcador.Carga.CTe(unitOfWork);
            Servicos.Embarcador.Carga.CTeSubContratacao serCTeSubContratacao = new Servicos.Embarcador.Carga.CTeSubContratacao(unitOfWork);
            Servicos.Embarcador.Carga.CargaPedido serCargaPedido = new Servicos.Embarcador.Carga.CargaPedido(unitOfWork);
            Servicos.Embarcador.Carga.Rota serCargaRota = new Servicos.Embarcador.Carga.Rota(unitOfWork);
            Servicos.Embarcador.Carga.RateioFormula serRateioFormula = new Servicos.Embarcador.Carga.RateioFormula(unitOfWork);
            Servicos.Embarcador.Carga.FreteCliente serFreteCliente = new Servicos.Embarcador.Carga.FreteCliente(unitOfWork);
            Servicos.Embarcador.CTe.CTEsImportados serCTEsImportados = new Servicos.Embarcador.CTe.CTEsImportados(unitOfWork);
            Servicos.Embarcador.Carga.Frete serCargaFrete = new Servicos.Embarcador.Carga.Frete(unitOfWork, tipoServicoMultisoftware);
            Servicos.Embarcador.Seguro.Seguro serSeguro = new Servicos.Embarcador.Seguro.Seguro(unitOfWork);
            Servicos.Embarcador.NFe.NFe serNFe = new Servicos.Embarcador.NFe.NFe(unitOfWork);
            Servicos.Embarcador.Carga.RateioFrete serRateioFrete = new Servicos.Embarcador.Carga.RateioFrete(unitOfWork);
            Servicos.Embarcador.Carga.ComponetesFrete svcComponenteFrete = new Servicos.Embarcador.Carga.ComponetesFrete(unitOfWork);
            Servicos.Embarcador.Carga.Frete serFrete = new Servicos.Embarcador.Carga.Frete(unitOfWork, tipoServicoMultisoftware);
            Servicos.Embarcador.Carga.MensagemAlertaCarga servicoMensagemAlerta = new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork);
            Servicos.Embarcador.Financeiro.Pagamento servicoPagamento = new Financeiro.Pagamento(unitOfWork);
            Servicos.Embarcador.Frota.OrdemServicoManutencao servicoOrdemServicoManutencao = new Frota.OrdemServicoManutencao(unitOfWork);
            Servicos.Embarcador.Veiculo.Veiculo servicoVeiculo = new Veiculo.Veiculo(unitOfWork);
            Servicos.Embarcador.NotaFiscal.NaoConformidade servicoNaoConformidade = new Servicos.Embarcador.NotaFiscal.NaoConformidade(unitOfWork, clienteMultisoftware);
            Servicos.Embarcador.Hubs.Carga servicoNotificacaoCarga = new Hubs.Carga();
            Servicos.Embarcador.Carga.ControleEntrega.PrevisaoControleEntrega servicoPrevisaoControleEntrega = new Servicos.Embarcador.Carga.ControleEntrega.PrevisaoControleEntrega(unitOfWork, configuracao);
            Servicos.Embarcador.Carga.MensagemAlertaCarga servisoMensagemAlerta = new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork);

            Dominio.ObjetosDeValor.Embarcador.GestaoPatio.ConfiguracaoFluxoGestaoPatio configuracaoFluxoGestaoPatio = new Dominio.ObjetosDeValor.Embarcador.GestaoPatio.ConfiguracaoFluxoGestaoPatio()
            {
                LiberarComMensagemSemComfirmacao = true
            };
            Servicos.Embarcador.GestaoPatio.FluxoGestaoPatio servicoFluxoGestaoPatio = new Servicos.Embarcador.GestaoPatio.FluxoGestaoPatio(unitOfWork, configuracaoFluxoGestaoPatio);

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoPedido configuracaoPedido = repConfiguracaoPedido.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab = repIntegracaoIntercab.BuscarIntegracao();
            Dominio.ObjetosDeValor.Embarcador.Frete.RetornoDadosFrete retorno = null;

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo, TipoPedido.Entrega, true, configuracao.RatearFretePedidosAposLiberarEmissaoSemNFe);

            Dominio.Entidades.Embarcador.Rateio.RateioFormula formulaRateio = serRateioFormula.ObterFormulaDeRateio(carga, unitOfWork);
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork).BuscarPrimeiroRegistro();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoControleEntrega configuracaoControleEntrega = repConfiguracaoControleEntrega.BuscarPrimeiroRegistro();

            Dominio.ObjetosDeValor.Embarcador.Carga.RetornoProcessamentoDocumentosFiscais retornoProcessamento = new Dominio.ObjetosDeValor.Embarcador.Carga.RetornoProcessamentoDocumentosFiscais();

            List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedidoNotaFiscal> cargaPedidoNotaFiscals = repPedidoXMLNotaFiscal.BuscarPedidoXMLNotaFiscal(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoQuantidades> cargaPedidoQuantidadesExitentes = repCargaPedidoQuantidade.BuscarPorCarga(carga.Codigo);

            decimal valorFreteNota = repPedidoXMLNotaFiscal.BuscarValorTotalFretePorCarga(carga.Codigo);

            if (!servicoNaoConformidade.Validar(carga))
            {
                retornoProcessamento.Mensagem = "Existem notas com não conformidade.";
                repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);
                servicoNotificacaoCarga.InformarRetornoProcessamentoDocumentosFiscais(carga.Codigo, retornoProcessamento, clienteMultisoftware);
                servicoNaoConformidade.EnviarNotificacaoMobile(carga);
                return;
            }
            else
                servicoNaoConformidade.EnviarNotificacaoMobile(carga);

            try
            {
                Log.TratarErro($"Iniciou a confirmação da carga {carga.Codigo}", "ConfirmarEnvioDosDocumentos");

                unitOfWork.Start();

                if (carga.TipoOperacao?.ConfiguracaoCalculoFrete?.ImportarVeiculoMDFEEmbarcador ?? false)
                {
                    string erro = string.Empty;
                    Dominio.Entidades.Veiculo veiculoMDFE = new Dominio.Entidades.Veiculo();
                    veiculoMDFE = BuscaVeiculoMDFECarga(carga, out erro, unitOfWork);
                    if (veiculoMDFE != null)
                    {
                        carga.Veiculo = veiculoMDFE;
                    }
                    else if (!string.IsNullOrEmpty(erro))
                    {
                        servicoMensagemAlerta.Adicionar(carga, TipoMensagemAlerta.CargaSemVeiculoInformado, erro);
                        Servicos.Log.TratarErro("VeiculoNaoCadastrado Carga: " + carga.Codigo, "ConfirmarEnvioDosDocumentos");
                        repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);
                        unitOfWork.CommitChanges();
                        return;
                    }
                }

                if (configuracaoGeralCarga.ValidarValorLimiteApoliceComValorNFe && !carga.NaoValidarValorLimiteApolice)
                {
                    Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repApoliceSeguro = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);

                    Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro apolice = repApoliceSeguro.BuscarPorCarga(carga.Codigo).FirstOrDefault()?.ApoliceSeguro ?? null;
                    decimal valorTotalNFs = repPedidoXMLNotaFiscal.BuscarValorTotalPorCarga(carga.Codigo);

                    if (apolice != null && apolice.ValorLimiteApolice < valorTotalNFs)
                    {
                        servicoMensagemAlerta.AdicionarNaoDuplicado(carga, TipoMensagemAlerta.DivergenciaValorLimiteApolice, $"Valor limite da apólice (R${apolice.ValorLimiteApolice.ToString("n2")}) é menor que o valor total das notas (R${valorTotalNFs.ToString("n2")}). Verifique o cadastro da apólice.", true);
                        Servicos.Log.TratarErro("ValorLimiteApoliceMenorQueNFsTotal Carga: " + carga.Codigo, "ConfirmarEnvioDosDocumentos");
                        repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);
                        carga.PendenciaValorLimiteApolice = true;
                        carga.PossuiPendencia = true;
                        carga.MotivoPendencia = "Valor limite da apólice é menor que o valor das notas.";
                        repCarga.Atualizar(carga);
                        unitOfWork.CommitChanges();
                        return;
                    }
                }

                if ((carga.TipoOperacao?.ObrigatorioVincularContainerCarga ?? false) && tipoServicoMultisoftware != TipoServicoMultisoftware.MultiTMS)
                {
                    if (new Pedido.ConferenciaContainer(unitOfWork).PossuiConferenciaSemAprovacao(carga))
                    {
                        servicoMensagemAlerta.Adicionar(carga, TipoMensagemAlerta.CargaSemInformacaoContainer, "Carga possui conferência container sem aprovação.");
                        Servicos.Log.TratarErro("PossuiConferenciaSemAprovacao Carga: " + carga.Codigo, "ConfirmarEnvioDosDocumentos");
                        repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);
                        unitOfWork.CommitChanges();
                        return;
                    }
                }
                else
                {
                    Dominio.Entidades.Embarcador.Pedidos.RetiradaContainer retiradaContainer = repositorioRetiradaContainer.BuscarPorCarga(carga.Codigo);
                    Dominio.Entidades.Embarcador.Pedidos.ContainerTipo containerTipo = retiradaContainer?.ContainerTipo ?? carga.ModeloVeicularCarga?.ContainerTipo ?? carga.Carregamento?.ModeloVeicularCarga?.ContainerTipo;

                    if (containerTipo != null)
                    {
                        if (retiradaContainer?.ColetaContainer?.Container == null)
                        {
                            if (!carga.LiberadaSemRetiradaContainer)
                            {
                                servicoMensagemAlerta.Adicionar(carga, TipoMensagemAlerta.CargaSemInformacaoContainer, "Carga aguardando informar retirada de container.");
                                Servicos.Log.TratarErro("SemRetiradaContainer Carga: " + carga.Codigo, "ConfirmarEnvioDosDocumentos");
                                repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);
                                unitOfWork.CommitChanges();
                                return;
                            }
                        }
                        //Removido para o inicio de viagem tarefa #55552
                        //else if (carga.SituacaoCarga == SituacaoCarga.AgTransportador || carga.SituacaoCarga == SituacaoCarga.AgNFe)
                        //{
                        //    servicoColetaContainer.AtualizarSituacaoColetaContainerEGerarHistorico(new Dominio.ObjetosDeValor.Embarcador.Pedido.AtualizarColetaContainerParametro()
                        //    {
                        //        coletaContainer = retiradaContainer.ColetaContainer,
                        //        DataAtualizacao = DateTime.Now,
                        //        Status = StatusColetaContainer.EmDeslocamentoCarregado,
                        //        OrigemMonimentacaoContainer = OrigemMovimentacaoContainer.Sistema,
                        //        InformacaoOrigemMonimentacaoContainer = InformacaoOrigemMovimentacaoContainer.AutomaticamenteConfirmarDocumentos

                        //    });
                        //}
                    }
                }

                if ((carga.TipoOperacao?.ConfiguracaoCarga?.PermitirSelecionarPreCargaNaCarga ?? false) && !carga.LiberadoSemCargaOrganizacao)
                {
                    Repositorio.Embarcador.Cargas.CargaCargaOrganizacao repositorioCargaOrganizacao = new Repositorio.Embarcador.Cargas.CargaCargaOrganizacao(unitOfWork);

                    List<Dominio.Entidades.Embarcador.Cargas.CargaCargaOrganizacao> listaCargasOrganizacao = repositorioCargaOrganizacao.BuscarPorCarga(carga.Codigo);
                    if (listaCargasOrganizacao.Count == 0)
                    {
                        servicoMensagemAlerta.Adicionar(carga, TipoMensagemAlerta.CargaSemCargaOrganizacaoVinculada, "Para esse tipo de operação é necessário vincular uma Pré Carga");
                        Servicos.Log.TratarErro("SemCargaOrganizacaoVinculada Carga: " + carga.Codigo, "ConfirmarEnvioDosDocumentos");
                        repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);
                        unitOfWork.CommitChanges();
                        return;
                    }
                }

                if (configuracao.SolicitarValorFretePorTonelada)
                {
                    carga.ValorFreteNegociado = repCargaPedido.BuscarValorFreteToneladaNegociadoCarga(carga.Codigo);
                    if (carga.ValorFreteNegociado > 0)
                    {
                        decimal pesoNotas = repPedidoXMLNotaFiscal.BuscarPesoPorCarga(carga.Codigo);
                        if (pesoNotas > 0)
                            carga.ValorFreteNegociado = (carga.ValorFreteNegociado * (pesoNotas / 1000));
                    }
                }
                else
                    carga.ValorFreteNegociado = repCargaPedido.BuscarValorFreteNegociadoCarga(carga.Codigo);

                if (carga.Rota?.FinalizarViagemAutomaticamente ?? false)
                {
                    carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada;
                    carga = serCarga.AtualizarStatusCustoExtra(carga, servicoNotificacaoCarga, repCarga);
                    carga.DataEncerramentoCarga = DateTime.Now;
                    repCarga.Atualizar(carga);
                    Servicos.Auditoria.Auditoria.Auditar(auditado, carga, $"Alterou carga para situação {Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada.ObterDescricao()}", unitOfWork);

                    retorno = new Dominio.ObjetosDeValor.Embarcador.Frete.RetornoDadosFrete()
                    {

                    };
                }
                else
                {
                    if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS && carga.TipoFreteEscolhido != TipoFreteEscolhido.Operador)
                        svcComponenteFrete.RemoverComponentesCarga(carga, unitOfWork);

                    if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS && carga.ProblemaIntegracaoGrMotoristaVeiculo && !carga.LiberadoComProblemaIntegracaoGrMotoristaVeiculo)
                    {
                        Servicos.Log.TratarErro("ProblemaIntegracaoGrMotoristaVeiculo Carga: " + carga.Codigo, "ConfirmarEnvioDosDocumentos");

                        unitOfWork.Rollback();

                        repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);

                        retornoProcessamento.Mensagem = "Não é possível avançar com a emissão da carga até que a GR aprove ou que a carga seja liberada.";
                        servicoNotificacaoCarga.InformarRetornoProcessamentoDocumentosFiscais(carga.Codigo, retornoProcessamento, clienteMultisoftware);
                        return;
                    }

                    List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> pedidosXmlNotaFiscalCarga = repPedidoXMLNotaFiscal.BuscarPorCarga(carga.Codigo);
                    bool enviouTodosDocumentos = true;
                    bool cTesEmitidosEmbarcador = false;
                    bool freteInformadoPeloContaEmbarcador = false;
                    bool contemSubcontratacao = false;
                    List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeDocumentos> tiposEmissaoCTeDocumentos = new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeDocumentos>();
                    List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeParticipantes> tipoEmissaoCTeParticipantes = new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeParticipantes>();
                    Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacao = carga.TipoOperacao;
                    bool validarRelevanciaNotasPrechekin = (tipoOperacao?.ConfiguracaoEmissaoDocumento?.ValidarRelevanciaNotasPrechekin ?? false);
                    bool possuiPedidoDevolucaoPacote = cargaPedidos.Exists(p => p.Pedido.DevolucaoPacote) && carga.CargaEspelho == null;
                    bool desconsiderarNotaPalletEmissaoCTE = tipoOperacao?.ConfiguracaoDocumentoEmissao?.DesconsiderarNotaPalletEmissaoCTE ?? false;

                    List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedidoSumarizadorQuantidadeNotasFiscais> sumarizadorQuantidadesCargasPedidos = repPedidoXMLNotaFiscal.ObterSumarizacaoQuantidadesPorCarga(carga);
                    List<Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoEmissaoDocumentoEmbarcador> cacheConfiguracaoEmissaoDocumentoEmbarcador = repConfiguracaoEmissaoDocumentoEmbarcador.BuscaConfiguracaoEmissaoDocumentoEmbarcadorPorClientesDaCarga(cargaPedidos);

                    foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoLista in cargaPedidos)
                    {
                        Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido = cargaPedidoLista;

                        if (validarRelevanciaNotasPrechekin && (cargaPedido.StageRelevanteCusto == null))
                        {
                            cargaPedido.PedidoSemNFe = true;
                            cargaPedido.CTesEmitidos = true;
                            cargaPedido.SituacaoEmissao = SituacaoNF.NFEnviada;
                            repCargaPedido.Atualizar(cargaPedido);

                            if (carga.DadosSumarizados?.CargaTrecho == CargaTrechoSumarizada.SubCarga)
                            {
                                Repositorio.Embarcador.Pedidos.StageAgrupamento repStageAgrupamento = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);
                                Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento agrupamentoStageCarga = repStageAgrupamento.BuscarPrimeiroPorCargaGerada(carga.Codigo);

                                SetarPesoCargaPedidosCargaFilhoConsolidadoSemIrrelevancia(cargaPedido, cargaPedido.Peso, cargaPedido.PesoLiquido, unitOfWork);

                                if (agrupamentoStageCarga != null && agrupamentoStageCarga.CargaDT != null)
                                {
                                    //setar cargapedido mae como situacao emissao = enviada
                                    Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoDT = repCargaPedido.BuscarPorCargaEPedido(agrupamentoStageCarga.CargaDT.Codigo, cargaPedido.Pedido.Codigo);
                                    cargaPedidoDT.CTesEmitidos = true;
                                    cargaPedidoDT.PedidoSemNFe = true;
                                    cargaPedidoDT.SituacaoEmissao = SituacaoNF.NFEnviada;
                                    repCargaPedido.Atualizar(cargaPedidoDT);
                                }
                            }
                        }

                        if (possuiPedidoDevolucaoPacote)
                        {
                            cargaPedido.PedidoSemNFe = true;
                            repCargaPedido.Atualizar(cargaPedido);
                        }

                        Log.GravarInfo($"Carga: {carga.Codigo}. desconsiderarNotaPalletEmissaoCTE: {desconsiderarNotaPalletEmissaoCTE}", "ConfirmarEnvioDosDocumentos");

                        if (desconsiderarNotaPalletEmissaoCTE && pedidosXmlNotaFiscalCarga.Exists(o => o.CargaPedido.Codigo == cargaPedido.Codigo && o.XMLNotaFiscal.TipoNotaFiscalIntegrada == TipoNotaFiscalIntegrada.RemessaPallet))
                        {
                            cargaPedido.PedidoPallet = true;
                            cargaPedido.PedidoSemNFe = true;
                            cargaPedido.CTesEmitidos = true;
                            cargaPedido.SituacaoEmissao = SituacaoNF.NFEnviada;
                            repCargaPedido.Atualizar(cargaPedido);

                            Log.GravarInfo($"Carga: {carga.Codigo}. cargaPedido.SituacaoEmissao = SituacaoNF.NFEnviada", "ConfirmarEnvioDosDocumentos");
                        }

                        if (cargaPedido.PedidoSemNFe)
                            continue;

                        if (configuracaoPedido.AjustarParticipantesPedidoCTeEmitidoEmbarcador && cargaPedido.CTeEmitidoNoEmbarcador)
                            AjustarParticipantesPedidoCTeEmitidoEmbarcador(cargaPedido, unitOfWork);

                        Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeDocumentos tipoEmissaoCTeDocumento = serCargaCTe.BuscarTipoEmissaoDocumentosCTe(cargaPedido, tipoServicoMultisoftware, unitOfWork);
                        Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeParticipantes tipoEmissaoCTeParticipante = serCargaCTe.BuscarTipoEmissaoCTeParticipantes(cargaPedido, tipoServicoMultisoftware, unitOfWork, configuracao.UtilizarParticipantesDaCargaPeloPedido);


                        if (configuracao.UtilizaEmissaoMultimodal)
                        {
                            List<Dominio.Entidades.Cliente> clientesBloquearEmissaoDosDestinatarios = carga.TipoOperacao?.ClientesBloquearEmissaoDosDestinatario.ToList();
                            serCargaPedido.BuscarConfiguracoesMultimodal(carga, unitOfWork, ref cargaPedido, integracaoIntercab, clientesBloquearEmissaoDosDestinatarios);
                        }

                        if (tipoEmissaoCTeDocumento == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeDocumentos.EmitePorPedidoIndividual && repPedidoXMLNotaFiscal.ContarPorCargaPedido(cargaPedido.Codigo) > 2000)
                        {
                            Servicos.Log.TratarErro("EmitePorPedidoIndividual mais que 2000 Carga: " + carga.Codigo, "ConfirmarEnvioDosDocumentos");

                            unitOfWork.Rollback();

                            repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);

                            retornoProcessamento.Mensagem = "A quantidade de notas fiscais do pedido " + cargaPedido.Pedido.Numero + " excede o limite de 2000. Crie outro pedido e vincule as notas excedentes, pois não é possível emitir um CT-e com esta quantidade de notas.";
                            servicoNotificacaoCarga.InformarRetornoProcessamentoDocumentosFiscais(carga.Codigo, retornoProcessamento, clienteMultisoftware);
                            return;
                        }

                        if (VerificarSeObrigatorioInformarMDFeEmitidoPeloEmbarcador(cargaPedidoLista, unitOfWork) && VerificarSeCTeEmitidoNoEmbarcador(cargaPedidoLista, unitOfWork, cacheConfiguracaoEmissaoDocumentoEmbarcador) && cargaPedidoLista.CargaPedidoDocumentosMDFe?.Count <= 0)
                        {
                            Servicos.Log.TratarErro("VerificarSeObrigatorioInformarMDFeEmitidoPeloEmbarcador Carga: " + carga.Codigo, "ConfirmarEnvioDosDocumentos");

                            unitOfWork.Rollback();

                            repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);

                            retornoProcessamento.Mensagem = $"É necessário informar um MDF-e no pedido {cargaPedido.Pedido.Numero} para avançar a etapa.";
                            servicoNotificacaoCarga.InformarRetornoProcessamentoDocumentosFiscais(carga.Codigo, retornoProcessamento, clienteMultisoftware);
                            return;
                        }

                        if (cargaPedido.Pedido.PedidoTransbordo)
                        {
                            if (!serCTEsImportados.VincularNotasFiscaisDaCargaTransbordada(out string mensagemErro, cargaPedido, tipoServicoMultisoftware, unitOfWork))
                            {
                                unitOfWork.Rollback();

                                repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);

                                retornoProcessamento.Mensagem = mensagemErro;
                                servicoNotificacaoCarga.InformarRetornoProcessamentoDocumentosFiscais(carga.Codigo, retornoProcessamento, clienteMultisoftware);
                                return;
                            }

                            valorFreteNota = repPedidoXMLNotaFiscal.BuscarValorTotalFretePorCarga(carga.Codigo);
                        }
                        else if (cargaPedido.Carga.CargaSVM)
                        {
                            GerarSubContratacaoSVM(cargaPedido, tipoServicoMultisoftware, stringConexao, unitOfWork);
                            cargaPedido = repCargaPedido.BuscarPorCodigo(cargaPedidoLista.Codigo);
                        }
                        else if (cargaPedido.CTeEmitidoNoEmbarcador && !cargaPedido.PedidoSemNFe)
                        {
                            string ret = serCTEsImportados.CriarNotasFiscaisDaCarga(cargaPedido, tipoServicoMultisoftware, unitOfWork, true, null, configuracao);

                            if (!string.IsNullOrWhiteSpace(ret))
                            {
                                Servicos.Log.TratarErro("ret Carga: " + carga.Codigo, "ConfirmarEnvioDosDocumentos");

                                unitOfWork.Rollback();

                                repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);

                                retornoProcessamento.Mensagem = ret;
                                servicoNotificacaoCarga.InformarRetornoProcessamentoDocumentosFiscais(carga.Codigo, retornoProcessamento, clienteMultisoftware);
                                return;
                            }

                            valorFreteNota = repPedidoXMLNotaFiscal.BuscarValorTotalFretePorCarga(carga.Codigo);

                            cTesEmitidosEmbarcador = true;
                            freteInformadoPeloContaEmbarcador = true;
                        }

                        decimal peso = 0m;
                        decimal pesoLiquido = 0m;

                        if (cargaPedido.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro &&
                            cargaPedido.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada &&
                            cargaPedido.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho &&
                            cargaPedido.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMProprio &&
                            cargaPedido.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario)
                        {
                            int numeroNotasFiscais = cargaPedidoNotaFiscals.Where(o => o.CargaPedido == cargaPedido.Codigo).Count();

                            if (numeroNotasFiscais <= 0)
                                numeroNotasFiscais = repPedidoXMLNotaFiscal.ContarPorCargaPedido(cargaPedido.Codigo);

                            if (numeroNotasFiscais == 0)
                            {
                                enviouTodosDocumentos = false;

                                if (configuracao.PermiteEmitirCargaDiferentesOrigensParcialmente || (tipoOperacao?.PermiteEmitirCargaDiferentesOrigensParcialmente ?? false))
                                    continue;

                                break;
                            }
                            else
                            {
                                if (!(carga.TipoOperacao?.ConfiguracaoCalculoFrete?.MesclarValorEmbarcadorComTabelaFrete ?? false))
                                {
                                    if (valorFreteNota > 0)
                                    {
                                        decimal valorPorNota = repPedidoXMLNotaFiscal.NotasPossuemValorFretePorXMLNotaFiscal(cargaPedido.Codigo);
                                        if (valorPorNota > 0m && !carga.CargaTransbordo)
                                        {
                                            //todo: ver melhor forma aqui a idéia é que se a nota foi usada em outra carga e tenha valor de frete não deve aplicar esse valor na nova carga
                                            bool notasTransbordadas = carga.TipoOperacao?.PermitirTransbordarNotasDeOutrasCargas ?? false;
                                            if (!notasTransbordadas)
                                            {
                                                if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS &&
                                                    repPedidoXMLNotaFiscal.PossuiValorFreteEmbarcadorZerado(cargaPedido.Codigo))
                                                {
                                                    Servicos.Log.TratarErro("PossuiValorFreteEmbarcadorZerado Carga: " + carga.Codigo, "ConfirmarEnvioDosDocumentos");

                                                    unitOfWork.Rollback();

                                                    repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);

                                                    retornoProcessamento.Mensagem = "Existem notas com o valor do frete do embarcador zerado, não sendo possível prosseguir.";
                                                    servicoNotificacaoCarga.InformarRetornoProcessamentoDocumentosFiscais(carga.Codigo, retornoProcessamento, clienteMultisoftware);
                                                    return;
                                                }

                                                cargaPedido.ValorFrete = valorPorNota;
                                                cargaPedido.ValorFreteAPagar = valorPorNota;
                                                cargaPedido.IncluirICMSBaseCalculo = true;
                                                cargaPedido.PercentualIncluirBaseCalculo = 100;
                                                freteInformadoPeloContaEmbarcador = true;
                                                repCargaPedido.Atualizar(cargaPedido);
                                            }
                                        }
                                    }
                                }

                                serCargaPedido.AdicionarCargaPedidoQuantidades(cargaPedido, null, null, tipoServicoMultisoftware, configuracao, ref peso, ref pesoLiquido, configuracao.NaoAtualizarPesoPedidoPelaNFe, unitOfWork, sumarizadorQuantidadesCargasPedidos, cargaPedidoQuantidadesExitentes);

                                if (cargaPedido.Pedido.Remetente == null)
                                {
                                    cargaPedido.Pedido.Remetente = repPedidoXMLNotaFiscal.BuscarRemetentePorCargaPedido(cargaPedido.Codigo);

                                    if (cargaPedido.Pedido.Remetente != null)
                                        cargaPedido.Pedido.Origem = cargaPedido.Pedido.Remetente.Localidade;

                                    repCargaPedido.Atualizar(cargaPedido);
                                }
                            }
                        }

                        if (cargaPedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro ||
                            cargaPedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada ||
                            cargaPedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho ||
                            cargaPedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMProprio ||
                            cargaPedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario ||
                            cargaPedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.NormalESubContratada)
                        {
                            if (!cargaPedido.PedidoEncaixado)
                                contemSubcontratacao = true;

                            if (!repPedidoCTeParaSubContratacao.ExistePorCargaPedido(cargaPedido.Codigo))
                            {
                                enviouTodosDocumentos = false;

                                if (configuracao.PermiteEmitirCargaDiferentesOrigensParcialmente || (tipoOperacao?.PermiteEmitirCargaDiferentesOrigensParcialmente ?? false))
                                    continue;

                                break;
                            }
                            else
                                peso += repPedidoCTeParaSubContratacao.ObterPesoPorCargaPedido(cargaPedido.Codigo);
                        }

                        if (carga.ExigeNotaFiscalParaCalcularFrete)
                        {
                            if (!tiposEmissaoCTeDocumentos.Contains(tipoEmissaoCTeDocumento))
                                tiposEmissaoCTeDocumentos.Add(tipoEmissaoCTeDocumento);

                            if (!tipoEmissaoCTeParticipantes.Contains(tipoEmissaoCTeParticipante))
                                tipoEmissaoCTeParticipantes.Add(tipoEmissaoCTeParticipante);

                            if (cargaPedido.Pedido.PedidoTotalmenteCarregado && !configuracao.NaoAtualizarPesoPedidoPelaNFe && !configuracao.UtilizarPesoPedidoParaRatearPesoNFeRepetida)
                            {
                                cargaPedido.Pedido.PesoTotal = cargaPedido.Peso;
                                cargaPedido.Pedido.PesoLiquidoTotal = cargaPedido.PesoLiquido;
                            }

                            if (cargaPedido.FormulaRateio == null)
                            {
                                cargaPedido.FormulaRateio = formulaRateio;

                                if (cargaPedido.FormulaRateio?.ParametroRateioFormula == ParametroRateioFormula.PorPesoUtilizandoFatorCubagem)
                                {
                                    if (cargaPedido.TipoUsoFatorCubagemRateioFormula == null)
                                        cargaPedido.TipoUsoFatorCubagemRateioFormula = carga.TipoOperacao?.ConfiguracaoEmissao?.TipoUsoFatorCubagemRateioFormula ?? null;

                                    if ((cargaPedido.FatorCubagemRateioFormula ?? 0) == 0)
                                        cargaPedido.FatorCubagemRateioFormula = carga.TipoOperacao?.ConfiguracaoEmissao?.FatorCubagemRateioFormula ?? null;
                                }
                            }

                            cargaPedido.TipoRateio = tipoEmissaoCTeDocumento;
                            cargaPedido.TipoEmissaoCTeParticipantes = tipoEmissaoCTeParticipante;

                            if (!carga.CargaTransbordo)
                            {
                                if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
                                {
                                    if (tipoEmissaoCTeParticipante == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeParticipantes.ComRecebedor || tipoEmissaoCTeParticipante == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeParticipantes.ComExpedidorERecebedor)
                                    {
                                        if (cargaPedido.Recebedor == null)
                                        {
                                            cargaPedido.Recebedor = cargaPedido.Pedido.Recebedor ?? cargaPedido?.Pedido?.Destinatario;

                                            if (cargaPedido.Recebedor != null)
                                                cargaPedido.Destino = cargaPedido.Recebedor.Localidade;
                                        }
                                    }
                                    else
                                    {
                                        cargaPedido.Recebedor = null;
                                    }

                                    if (tipoEmissaoCTeParticipante == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeParticipantes.ComExpedidor || tipoEmissaoCTeParticipante == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeParticipantes.ComExpedidorERecebedor)
                                    {
                                        cargaPedido.Expedidor = cargaPedido.Pedido.Expedidor ?? cargaPedido.Pedido.Remetente;
                                        if (cargaPedido.Pedido?.EnderecoExpedidor != null && cargaPedido.Pedido?.EnderecoExpedidor?.Localidade != null)
                                            cargaPedido.Origem = cargaPedido.Pedido.EnderecoExpedidor.Localidade;
                                        else if (cargaPedido.Expedidor != null)
                                            cargaPedido.Origem = cargaPedido.Expedidor.Localidade;
                                    }
                                    else
                                    {
                                        cargaPedido.Expedidor = null;
                                    }
                                }

                                if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                                    serFreteCliente.ValidarSeUsaTabelaDestinatario(cargaPedido, tipoServicoMultisoftware, configuracao);

                                //quando o pedido é cadastrado no sistema, não tem a informação do expedidor/recebedor na cargapedido até esse momento, então fica como subcontratação se não fizer essa tratativa
                                if ((cargaPedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro ||
                                    cargaPedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada ||
                                    cargaPedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho ||
                                    cargaPedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMProprio ||
                                    cargaPedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario)
                                    && !carga.EmitirCTeComplementar && !(integracaoIntercab?.BuscarTipoServicoModeloDocumentoVinculadoCarga ?? false))
                                {
                                    if (cargaPedido.Expedidor != null && cargaPedido.Recebedor != null)
                                    {
                                        if (cargaPedido.Carga.GrupoPessoaPrincipal != null && cargaPedido.Carga.GrupoPessoaPrincipal.EmitirSempreComoRedespacho)
                                            cargaPedido.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho;
                                        else
                                            cargaPedido.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario;
                                    }
                                    else if (cargaPedido.Expedidor != null || cargaPedido.Recebedor != null)
                                        cargaPedido.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho;
                                    else
                                        cargaPedido.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada;

                                    if ((configuracao.UtilizaEmissaoMultimodal && cargaPedido.TipoServicoMultimodal == TipoServicoMultimodal.Subcontratacao) || (cargaPedido.Carga.TipoOperacao?.SempreEmitirSubcontratacao ?? false))
                                        cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.SubContratada;
                                }

                                if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                                    Servicos.Embarcador.Carga.CargaPedido.SetarModeloDocumentoEmitir(cargaPedido, unitOfWork);
                            }

                            repPedido.Atualizar(cargaPedido.Pedido);

                            cargaPedido.SituacaoEmissao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoNF.NFEnviada;
                            //Configuração Portal Retira.. produtos parciais do pedido.. se estiver marcado.. irá controlar as quantidades do produto faturado.
                            if (!configuracao.AtualizarProdutosCarregamentoPorNota)
                            {
                                //TODO: PPC - Adicionado log temporário para identificar problema no cargaPedido.Peso.
                                //Servicos.Log.TratarErro($"Pedido {cargaPedido.Pedido.NumeroPedidoEmbarcador} - CargaPedido.Codigo = {cargaPedido.Codigo} - Peso Total De.: {cargaPedido.Peso} - Para.: {peso}. Carga.ConfirmarEnvioDosDocumentos", "PesoCargaPedido");
                                cargaPedido.Peso = peso;
                            }

                            if (pesoLiquido > 0m)
                                cargaPedido.PesoLiquido = pesoLiquido;

                            repCargaPedido.Atualizar(cargaPedido);

                        }
                        else
                        {
                            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosPedido = repCargaPedido.BuscarPorPedido(cargaPedido.Pedido.Codigo);

                            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoPedido in cargaPedidosPedido)
                            {
                                cargaPedidoPedido.SituacaoEmissao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoNF.NFEnviada;
                                repCargaPedido.Atualizar(cargaPedidoPedido);
                            }
                        }
                    }

                    carga.CargaEmitidaParcialmente = !enviouTodosDocumentos && (configuracao.PermiteEmitirCargaDiferentesOrigensParcialmente || (tipoOperacao?.PermiteEmitirCargaDiferentesOrigensParcialmente ?? false)) && ExisteOrigemComTodasNotasRecebidas(carga, cargaPedidos, unitOfWork);
                    carga.SituacaoCarga = SituacaoCarga.AgNFe;

                    //carga do consolidado sempre sera parcial até confirmar todos os documentos.
                    if (carga.TipoOperacao?.TipoConsolidacao == EnumTipoConsolidacao.PreCheckIn)
                        carga.CargaEmitidaParcialmente = true;

                    Log.GravarInfo($"Confirmar Envio Documentos CARGA EMITDA PARCIALMENTE - {carga.Codigo.ToString()} - {carga.CargaEmitidaParcialmente.ObterDescricao()} - {DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff")}", "ConfirmarEnvioDosDocumentos");

                    if (configuracao.PermiteEmitirCargaDiferentesOrigensParcialmente || (tipoOperacao?.PermiteEmitirCargaDiferentesOrigensParcialmente ?? false))
                    {
                        carga.DataInicioGeracaoCTes = null;
                        carga.PossuiPendencia = false;
                    }

                    if (!enviouTodosDocumentos && !carga.CargaEmitidaParcialmente)
                    {
                        Servicos.Log.GravarAdvertencia("!enviouTodosDocumentos Carga: " + carga.Codigo, "ConfirmarEnvioDosDocumentos");

                        unitOfWork.Rollback();

                        repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);

                        retornoProcessamento.Mensagem = "Antes de iniciar a emissão é necessário informar as notas da carga.";
                        servicoNotificacaoCarga.InformarRetornoProcessamentoDocumentosFiscais(carga.Codigo, retornoProcessamento, clienteMultisoftware);
                        return;
                    }

                    DefinirRelevanciaParaFreteNotasFiscais(carga, pedidosXmlNotaFiscalCarga, unitOfWork);

                    if (!serCarga.VerificarSeCargaEstaNaLogistica(carga, tipoServicoMultisoftware) && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        Servicos.Log.GravarAdvertencia("VerificarSeCargaEstaNaLogistica Carga: " + carga.Codigo, "ConfirmarEnvioDosDocumentos");

                        unitOfWork.Rollback();

                        repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);

                        retornoProcessamento.Mensagem = "Não é possível confirmar o envio das notas na atual situação da carga (" + carga.DescricaoSituacaoCarga + ").";
                        servicoNotificacaoCarga.InformarRetornoProcessamentoDocumentosFiscais(carga.Codigo, retornoProcessamento, clienteMultisoftware);
                        return;
                    }

                    if (contemSubcontratacao && !carga.CargaTransbordo)
                    {
                        if (!carga.EmitirCTeComplementar)
                            serCTeSubContratacao.CriarNotasFiscaisDaCarga(cargaPedidos, tipoServicoMultisoftware, configuracao, unitOfWork, utilizarInsertEmMassa);

                        carga = repCarga.BuscarPorCodigo(carga.Codigo);
                        cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo);

                        serCarga.SetarTipoContratacaoCarga(carga, unitOfWork);

                        if ((carga.TipoContratacaoCarga == TipoContratacaoCarga.SVMTerceiro || carga.TipoContratacaoCarga == TipoContratacaoCarga.SubContratada) && (carga.TipoOperacao?.UtilizarValorFreteOriginalSubcontratacao ?? false))
                        {
                            freteInformadoPeloContaEmbarcador = true;

                            if (!serCTeSubContratacao.ValidarComponentesCTesSubcontratacao(out string erro, carga, cargaPedidos, unitOfWork, tipoServicoMultisoftware))
                            {
                                Servicos.Log.GravarAdvertencia("ValidarComponentesCTesSubcontratacao Carga: " + carga.Codigo, "ConfirmarEnvioDosDocumentos");

                                unitOfWork.Rollback();

                                repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);

                                retornoProcessamento.Mensagem = erro;
                                servicoNotificacaoCarga.InformarRetornoProcessamentoDocumentosFiscais(carga.Codigo, retornoProcessamento, clienteMultisoftware);
                                return;
                            }
                        }
                    }

                    if (!carga.ExigeNotaFiscalParaCalcularFrete)
                    {
                        if (!(carga.TipoOperacao?.TipoConsolidacao == EnumTipoConsolidacao.PreCheckIn) || (carga.TipoOperacao?.TipoConsolidacao == EnumTipoConsolidacao.PreCheckIn && repPedidoXMLNotaFiscal.ContemNotaNaCarga(carga.Codigo)))
                        {
                            carga.DataInicioEmissaoDocumentos = DateTime.Now;
                            carga.DataEnvioUltimaNFe = DateTime.Now;
                        }
                    }

                    if (carga.ExigeNotaFiscalParaCalcularFrete)
                    {
                        bool controlarTransacao = false;
                        if (!unitOfWork.IsActiveTransaction())
                        {
                            controlarTransacao = true;
                            unitOfWork.Start();
                        }

                        Servicos.Embarcador.Carga.RotaFrete.SetarRotaFreteCarga(carga, cargaPedidos, configuracao, unitOfWork, tipoServicoMultisoftware);

                        if ((cargaPedidos.Any(x => x.TipoRateio == TipoEmissaoCTeDocumentos.EmitePorNotaFiscalAgrupada || x.TipoRateio == TipoEmissaoCTeDocumentos.EmitePorNotaFiscalIndividual)
                            && (carga.Rota == null || (carga.Rota != null && carga.Rota.SituacaoDaRoteirizacao != SituacaoRoteirizacao.Concluido))) ||
                            (carga.TipoOperacao?.ConfiguracaoControleEntrega?.RecriarControleDeEntregasAoConfirmarEnvioDocumentos ?? false))
                            Servicos.Embarcador.Carga.CargaRotaFrete.GerarIntegracoesRoteirizacaoCarga(carga, unitOfWork, configuracao, tipoServicoMultisoftware);

                        if (controlarTransacao)
                            unitOfWork.CommitChanges();
                    }


                    if (cargaPedidos.Count > 0)
                    {
                        Dominio.ObjetosDeValor.Embarcador.Carga.RetornoRotasCarga retornoRotas = serCargaLocaisPrestacao.VerificarEAjustarLocaisPrestacao(carga, cargaPedidos, unitOfWork, tipoServicoMultisoftware, configuracaoPedido);

                        if (retornoRotas != null && retornoRotas.situacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoRetornoRotas.NaoEncontrada)
                        {
                            if (!carga.ExigeNotaFiscalParaCalcularFrete)
                            {
                                carga.DataInicioConfirmacaoDocumentosFiscais = null;
                                carga.ProcessandoDocumentosFiscais = false;
                                carga.PossuiPendencia = true;
                                carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete;
                                retorno = serCargaRota.retornarDadosRotaNaoEncontrada(retornoRotas);
                                repCarga.Atualizar(carga);

                                if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete)
                                    Servicos.Log.GravarInfo("Atualizou a situação para calculo frete 44 Carga " + carga.CodigoCargaEmbarcador, "AtualizouSituacaoCalculoFrete");

                                Servicos.Embarcador.Carga.Ocorrencia.RefazerComplementacaoValorFreteCarga(carga, unitOfWork, stringConexao, tipoServicoMultisoftware, false);
                                if (carga.EmpresaFilialEmissora != null)
                                    Servicos.Embarcador.Carga.Ocorrencia.RefazerComplementacaoValorFreteCarga(carga, unitOfWork, stringConexao, tipoServicoMultisoftware, true);

                                unitOfWork.CommitChanges();

                                dynamic dynCargaD = serCarga.ObterDetalhesDaCarga(carga, tipoServicoMultisoftware, unitOfWork);

                                retornoProcessamento.Carga = dynCargaD;
                                retornoProcessamento.RetornoDadosFrete = retorno;
                                retornoProcessamento.Sucesso = true;
                                servicoNotificacaoCarga.InformarRetornoProcessamentoDocumentosFiscais(carga.Codigo, retornoProcessamento, clienteMultisoftware);

                                return;
                            }
                            else
                            {
                                Servicos.Log.GravarAdvertencia("Não foi possível localizar uma rota para a viagem, Carga: " + carga.Codigo, "ConfirmarEnvioDosDocumentos");

                                unitOfWork.Rollback();

                                repCarga.AtualizarProcessamentoDocumentosFiscais(carga.Codigo, false);

                                retornoProcessamento.Mensagem = "Não foi possível localizar uma rota para a viagem, por favor, insira a rota e tente novamente.";
                                servicoNotificacaoCarga.InformarRetornoProcessamentoDocumentosFiscais(carga.Codigo, retornoProcessamento, clienteMultisoftware);
                                return;
                            }
                        }
                    }

                    if (carga.ExigeNotaFiscalParaCalcularFrete)
                    {
                        Servicos.Embarcador.Carga.FreteSubcontratacaoTerceiro svcFreteSubcontratacaoTerceiro = new Servicos.Embarcador.Carga.FreteSubcontratacaoTerceiro(unitOfWork);

                        if (carga.TipoOperacao?.ConfiguracaoCalculoFrete?.NecessarioAguardarVinculoNotadeRemessaIndustrializador ?? false)
                        {
                            List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> notasCargas = repxMLNotaFiscal.BuscarPorCarga(carga.Codigo);
                            bool possuiNotaRemessa = notasCargas.Any(nota => nota.TipoNotaFiscalIntegrada == TipoNotaFiscalIntegrada.OrdemVenda) && notasCargas.Count > 0;

                            if (!possuiNotaRemessa)
                            {
                                List<Dominio.ObjetosDeValor.Embarcador.Alertas.MensagemAlerta> existeMensagems = servisoMensagemAlerta.ObterMensagensPorEntidades(new List<int> { carga.Codigo });

                                if ((existeMensagems == null || existeMensagems.Count == 0) || !existeMensagems.Any(m => m.Tipo == TipoMensagemAlerta.NotaVendaNaoRecebida))
                                    servisoMensagemAlerta.Adicionar(carga, TipoMensagemAlerta.NotaVendaNaoRecebida, $"Para a carga avançar é necessário inserir as notas de venda e de remessa");

                                carga.DataInicioConfirmacaoDocumentosFiscais = null;
                                carga.ProcessandoDocumentosFiscais = false;
                                carga.PossuiPendencia = true;
                                repCarga.Atualizar(carga);

                                unitOfWork.CommitChanges();
                                Servicos.Log.GravarAdvertencia("Nota de remessa ainda nao foi vinculada, Carga: " + carga.Codigo, "ConfirmarEnvioDosDocumentos");

                                retornoProcessamento.Mensagem = "Nota de remessa ainda não foi vinculada!.";
                                retornoProcessamento.Sucesso = false;
                                servicoNotificacaoCarga.InformarRetornoProcessamentoDocumentosFiscais(carga.Codigo, retornoProcessamento, clienteMultisoftware);

                                return;
                            }
                            else
                                new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork).Confirmar(carga, TipoMensagemAlerta.NotaVendaNaoRecebida);
                        }

                        carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete;

                        if (carga.Mercosul && !carga.EmitindoCRT && tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador)
                            carga.DataInicioCalculoFrete = DateTime.Now;

                        if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete)
                            Servicos.Log.GravarInfo("Atualizou a situação para calculo frete 42 Carga " + carga.CodigoCargaEmbarcador, "AtualizouSituacaoCalculoFrete");

                        if (!carga.CargaTransbordo)
                        {
                            if (carga.TipoFreteEscolhido != TipoFreteEscolhido.Cliente && (carga.TipoFreteEscolhido != TipoFreteEscolhido.Operador || carga.SituacaoAlteracaoFreteCarga == SituacaoAlteracaoFreteCarga.AguardandoAprovacao) && (carga.TipoContratacaoCarga != TipoContratacaoCarga.SubContratada || !(carga.TipoOperacao?.UtilizarValorFreteOriginalSubcontratacao ?? false)))
                            {
                                carga.DataInicioCalculoFrete = DateTime.Now;
                                carga.CalculandoFrete = true;
                                retorno = new Dominio.ObjetosDeValor.Embarcador.Frete.RetornoDadosFrete() { situacao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoRetornoDadosFrete.CalculandoFrete };
                            }
                        }

                        if (tipoServicoMultisoftware != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS && carga.TipoFreteEscolhido == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Embarcador)
                            freteInformadoPeloContaEmbarcador = true;

                        if (!freteInformadoPeloContaEmbarcador)
                        {
                            if (!carga.CargaTransbordo)
                            {
                                if (carga.TipoFreteEscolhido != TipoFreteEscolhido.Cliente && carga.TipoFreteEscolhido != TipoFreteEscolhido.Operador)
                                {
                                    if (configuracao.AjustarTipoOperacaoPeloPeso)
                                        Servicos.Embarcador.Carga.Carga.AjustarTipoOperacao(carga, tipoServicoMultisoftware, unitOfWork);

                                    Servicos.Embarcador.Carga.Ocorrencia.RefazerComplementacaoValorFreteCarga(carga, unitOfWork, stringConexao, tipoServicoMultisoftware, false);

                                    if (carga.EmpresaFilialEmissora != null)
                                        Servicos.Embarcador.Carga.Ocorrencia.RefazerComplementacaoValorFreteCarga(carga, unitOfWork, stringConexao, tipoServicoMultisoftware, true);

                                    carga.TipoFreteEscolhido = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Tabela;
                                }
                                else
                                {
                                    if (carga.TipoFreteEscolhido == TipoFreteEscolhido.Operador)
                                    {
                                        if (configuracao.UtilizaEmissaoMultimodal)
                                        {
                                            carga.DataInicioCalculoFrete = DateTime.Now;
                                            carga.CalculandoFrete = true;
                                            carga.TipoFreteEscolhido = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Tabela;
                                        }
                                        else
                                        {
                                            carga.TipoFreteEscolhido = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Operador;
                                            new Servicos.Embarcador.Carga.CargaAprovacaoFrete(unitOfWork, configuracao).CriarAprovacao(carga, TipoRegraAutorizacaoCarga.InformadoManualmente, tipoServicoMultisoftware);
                                        }

                                        carga.PossuiPendencia = false;
                                        carga.MotivoPendenciaFrete = Dominio.ObjetosDeValor.Embarcador.Enumeradores.MotivoPendenciaFrete.NenhumPendencia;
                                        Repositorio.Embarcador.Cargas.CargaComponentesFrete repCargaComponentesFrete = new Repositorio.Embarcador.Cargas.CargaComponentesFrete(unitOfWork);
                                        List<Dominio.Entidades.Embarcador.Cargas.CargaComponentesFrete> cargaComponentesFretes = repCargaComponentesFrete.BuscarPorCarga(carga.Codigo);

                                        foreach (Dominio.Entidades.Embarcador.Cargas.CargaComponentesFrete componente in cargaComponentesFretes)
                                        {
                                            if ((componente.TipoValor == TipoCampoValorTabelaFrete.PercentualSobreValorNotaFiscal || componente.TipoComponenteFrete == TipoComponenteFrete.ADVALOREM) && componente.Percentual > 0)
                                            {
                                                decimal valorTotalProdutos = repPedidoXMLNotaFiscal.ObterValorTotalPorCarga(carga.Codigo, componente.ComponenteFrete?.NaoDeveIncidirSobreNotasFiscaisPateles ?? false);
                                                decimal valorinicio = componente.ValorComponente;

                                                componente.ValorComponente = ((componente.Percentual / 100) * valorTotalProdutos);

                                                if (valorinicio != componente.ValorComponente)
                                                    repCargaComponentesFrete.Atualizar(componente);
                                            }
                                        }

                                        serRateioFrete.RatearValorDoFrenteEntrePedidos(carga, cargaPedidos, configuracao, false, unitOfWork, tipoServicoMultisoftware);

                                        if (carga.CargaRetornadaEtapaNFeManualmente)
                                            svcFreteSubcontratacaoTerceiro.CalcularFreteSubcontratacao(carga, carga.TipoFreteEscolhido, unitOfWork, false, tipoServicoMultisoftware, stringConexao);
                                    }
                                }
                            }
                            else
                            {
                                carga.PossuiPendencia = false;
                                carga.MotivoPendenciaFrete = Dominio.ObjetosDeValor.Embarcador.Enumeradores.MotivoPendenciaFrete.NenhumPendencia;
                                carga.TipoFreteEscolhido = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Operador;

                                svcFreteSubcontratacaoTerceiro.CalcularFreteSubcontratacao(carga, carga.TipoFreteEscolhido, unitOfWork, false, tipoServicoMultisoftware, stringConexao);

                                retorno = serCargaFrete.VerificarFrete(ref carga, unitOfWork, configuracaoPedido);

                                serCargaDadosSumarizados.AlterarDadosSumarizadosCarga(ref carga, cargaPedidos, configuracao, unitOfWork, tipoServicoMultisoftware);
                            }
                        }
                        else
                        {
                            if (carga.TipoOperacao?.TipoConsolidacao != EnumTipoConsolidacao.AutorizacaoEmissao)
                            {
                                carga.ValorFrete = cargaPedidos.Sum(obj => obj.ValorFrete);
                                carga.ValorFreteAPagar = cargaPedidos.Sum(obj => obj.ValorFreteAPagar);
                                carga.ValorFreteLiquido = carga.ValorFrete;
                                carga.ValorFreteEmbarcador = cargaPedidos.Sum(obj => obj.ValorFreteAPagar);
                            }

                            carga.TipoFreteEscolhido = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Embarcador;
                            carga.PossuiPendencia = false;

                            if (!cTesEmitidosEmbarcador)
                            {
                                Servicos.Embarcador.Carga.ComponetesFrete.AdicionarComponentesObrigatoriosNotaFiscal(carga, unitOfWork, stringConexao, tipoServicoMultisoftware);

                                serRateioFrete.RatearValorDoFrenteEntrePedidos(carga, cargaPedidos, configuracao, false, unitOfWork, tipoServicoMultisoftware);

                                if (carga.EmpresaFilialEmissora != null)
                                    serRateioFrete.RatearValorDoFrenteEntrePedidos(carga, cargaPedidos, configuracao, true, unitOfWork, tipoServicoMultisoftware);

                                if (cargaPedidos.Any(obj => obj.PedidoEncaixado))
                                    Servicos.Embarcador.Carga.PedidoVinculado.AjustarCargaEncaixada(carga, configuracao, unitOfWork, tipoServicoMultisoftware);

                                if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
                                {
                                    carga.CalculandoFrete = true;
                                    carga.DataInicioCalculoFrete = DateTime.Now;
                                }
                                else
                                {
                                    carga.CalculandoFrete = false;
                                    carga.DataInicioCalculoFrete = null;
                                }
                            }
                            else
                            {
                                carga.ValorICMS = cargaPedidos.Sum(obj => obj.ValorICMS);
                                carga.CalculandoFrete = true;
                                carga.DataInicioCalculoFrete = DateTime.Now;
                            }

                            repCarga.Atualizar(carga);

                            Servicos.Embarcador.Carga.Ocorrencia.RefazerComplementacaoValorFreteCarga(carga, unitOfWork, stringConexao, tipoServicoMultisoftware, false);

                            if (carga.EmpresaFilialEmissora != null)
                                Servicos.Embarcador.Carga.Ocorrencia.RefazerComplementacaoValorFreteCarga(carga, unitOfWork, stringConexao, tipoServicoMultisoftware, true);

                            svcFreteSubcontratacaoTerceiro.CalcularFreteSubcontratacao(carga, carga.TipoFreteEscolhido, unitOfWork, false, tipoServicoMultisoftware, stringConexao);
                        }


                        bool exigeConfirmacaoFreteAntesEmissao = carga.Filial?.ExigeConfirmacaoFreteAntesEmissao ?? false;
                        if (!exigeConfirmacaoFreteAntesEmissao)
                            exigeConfirmacaoFreteAntesEmissao = carga.TipoOperacao?.ExigeConformacaoFreteAntesEmissao ?? true;

                        if ((tipoServicoMultisoftware != TipoServicoMultisoftware.MultiTMS) && ((carga.TipoFreteEscolhido == TipoFreteEscolhido.Operador && carga.SituacaoAlteracaoFreteCarga.IsPermiteAvancarEtapa()) || carga.TipoFreteEscolhido == TipoFreteEscolhido.Cliente) && !exigeConfirmacaoFreteAntesEmissao)
                        {
                            carga.DataEnvioUltimaNFe = DateTime.Now;
                            carga.DataInicioEmissaoDocumentos = DateTime.Now;
                        }

                        servicoPagamento.VerificarSeNecessariaAutorizacaoValorMaximoPendentePagamento(carga, configuracao);
                        servicoOrdemServicoManutencao.VerificarSeNecessariaAutorizacaoServicoVeiculo(carga, configuracao);
                        servicoVeiculo.VerificarSeNecessariaAutorizacaoPeso(carga, configuracao);
                        serFrete.ValidarMensagemAlertaGrupoPessoa(carga, unitOfWork, configuracao);
                        serFrete.ValidarConfiguracaoFaturamentoTomador(carga, unitOfWork, configuracao);
                        serFrete.ValidarEntidadesSemCadastro(carga, unitOfWork, configuracao);
                        serFrete.ValidarEntidadesSemCodigoDocumentacao(carga, unitOfWork, configuracao);

                        serSeguro.VerificarSeNecessariaAutorizacaoSeguro(carga, cargaPedidos, unitOfWork);
                        serNFe.VerificarSeNecessariaAutorizacaoModalidadePagamento(carga, cargaPedidos, unitOfWork);
                    }
                    else
                    {
                        if (carga.CargaEspelho != null && (carga.TipoOperacao?.ConfiguracaoCarga?.AvancarCargaQuandoPedidoZeroPacotes ?? false) && cargaPedidos.Exists(o => o.PedidoSemNFe))
                            serRateioFrete.RatearValorDoFrenteEntrePedidos(carga, cargaPedidos, configuracao, false, unitOfWork, tipoServicoMultisoftware);

                        Servicos.Embarcador.Carga.Ocorrencia.RefazerComplementacaoValorFreteCarga(carga, unitOfWork, stringConexao, tipoServicoMultisoftware, false);
                        if (carga.EmpresaFilialEmissora != null)
                            Servicos.Embarcador.Carga.Ocorrencia.RefazerComplementacaoValorFreteCarga(carga, unitOfWork, stringConexao, tipoServicoMultisoftware, true);

                        retorno = serCargaFrete.VerificarFrete(ref carga, unitOfWork, configuracaoPedido);
                    }

                    if ((carga.TipoOperacao?.GerarEntregaPorNotaFiscalCarga ?? false) && carga.Carregamento != null)
                        carga.SituacaoRoteirizacaoCarga = SituacaoRoteirizacao.Aguardando;
                    else
                    {
                        List<Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntregaPedido> cargaEntregaPedidos = repCargaEntregaPedido.BuscarPorCarga(carga.Codigo);
                        List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscalProduto> xmlNotaFiscalProdutos = null;

                        if (cargaEntregaPedidos.Count > 0)
                            xmlNotaFiscalProdutos = repXMLNotaFiscalProduto.BuscarPorNotaFiscais(carga.Codigo);
                        Servicos.Embarcador.Carga.ControleEntrega.ControleEntrega.VincularNotasNaCargaEntrega(carga, cargaEntregaPedidos.DistinctBy(x => x.CargaPedido.Codigo).ToList(), pedidosXmlNotaFiscalCarga, xmlNotaFiscalProdutos, tipoServicoMultisoftware, unitOfWork);
                    }

                    Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota.ValidarCompraValePedagioComIntegracaoValorPedagioEmbarcador(carga, unitOfWork, stringConexao, configuracao, tipoServicoMultisoftware);

                    bool possuiIntegracaoArcelorMittal = repTipoIntegracao.ExistePorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.ArcelorMittal);
                    if (possuiIntegracaoArcelorMittal)
                    {
                        new Servicos.Embarcador.Integracao.IntegracaoCargaEvento(unitOfWork, tipoServicoMultisoftware).AdicionarIntegracaoIndividual(carga, EtapaCarga.NotaFiscal, $"NFes processadas", new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao>() { Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.ArcelorMittal }, true); ;
                        Servicos.Auditoria.Auditoria.Auditar(auditado, carga, "Processou todas as notas fiscais", unitOfWork);
                    }

                    if (enviouTodosDocumentos && carga.DadosSumarizados?.CargaTrecho == CargaTrechoSumarizada.SubCarga)
                    {
                        //quando pre-chekin vamos replicar as notas da carga filho para as cargas de proximo trecho (transferencias)
                        Servicos.Embarcador.Pedido.NotaFiscal serCargaNotaFiscal = new Servicos.Embarcador.Pedido.NotaFiscal(unitOfWork);
                        Repositorio.Embarcador.Pedidos.StageAgrupamento repStageAgrupamento = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);
                        Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento agrupamentoStageCarga = repStageAgrupamento.BuscarPrimeiroPorCargaGerada(carga.Codigo);

                        if (agrupamentoStageCarga != null)
                        {
                            if (agrupamentoStageCarga.CargaDT != null && agrupamentoStageCarga.CargaDT.TipoOperacao?.TipoConsolidacao == EnumTipoConsolidacao.PreCheckIn)
                            {
                                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoLista in cargaPedidos)
                                {
                                    if (cargaPedidoLista.CargaPedidoProximoTrecho != null && !cargaPedidoLista.PedidoSemNFe)
                                    {
                                        List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> PedidoxMLNotaFiscais = repPedidoXMLNotaFiscal.BuscarPorCarga(carga.Codigo);

                                        foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedxmlNotaFiscal in PedidoxMLNotaFiscais)
                                        {
                                            Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoProximoTrecho = repCargaPedido.BuscarPorCodigoComFetch(cargaPedidoLista.CargaPedidoProximoTrecho.Codigo);

                                            if (pedxmlNotaFiscal.XMLNotaFiscal != null && pedxmlNotaFiscal.XMLNotaFiscal.SituacaoEntregaNotaFiscal != SituacaoNotaFiscal.Entregue && pedxmlNotaFiscal.XMLNotaFiscal.SituacaoEntregaNotaFiscal != SituacaoNotaFiscal.EntregueParcial)
                                                serCargaNotaFiscal.InformarDadosNotaCarga(pedxmlNotaFiscal.XMLNotaFiscal, cargaPedidoProximoTrecho, tipoServicoMultisoftware, out string msgAlerta);

                                            if (cargaPedidoProximoTrecho.NotasFiscais?.Count > 0)//validar se pode ser assim.
                                            {
                                                cargaPedidoProximoTrecho.SituacaoEmissao = SituacaoNF.NFEnviada;
                                                repCargaPedido.Atualizar(cargaPedidoProximoTrecho);
                                            }
                                        }

                                        decimal pesoProximoTrecho = 0;
                                        decimal pesoLiquidoProximoTrecho = 0;

                                        serCargaPedido.AdicionarCargaPedidoQuantidades(cargaPedidoLista.CargaPedidoProximoTrecho, null, null, tipoServicoMultisoftware, configuracao, ref pesoProximoTrecho, ref pesoLiquidoProximoTrecho, configuracao.NaoAtualizarPesoPedidoPelaNFe, unitOfWork, sumarizadorQuantidadesCargasPedidos, cargaPedidoQuantidadesExitentes);

                                        cargaPedidoLista.CargaPedidoProximoTrecho.Peso = pesoProximoTrecho;
                                        cargaPedidoLista.CargaPedidoProximoTrecho.PesoLiquido = pesoLiquidoProximoTrecho;

                                        repCargaPedido.Atualizar(cargaPedidoLista.CargaPedidoProximoTrecho);
                                    }
                                }
                            }
                        }
                    }
                }

                AjustarMoedaCotacaoCarga(carga, cargaPedidos, configuracao, unitOfWork);

                Servicos.Embarcador.Carga.Carga svcCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);
                if (!svcCarga.AtualizarPedidosRecebimentoNFe(carga, configuracao, tipoServicoMultisoftware, unitOfWork))
                    svcCarga.AtualizarProdutosPorNota(carga, cargaPedidos, unitOfWork, auditado);

                //if (configuracao.UtilizaEmissaoMultimodal || configuracaoAprovacao.CriarAprovacaoCargaAoConfirmarDocumentos)
                //    new Servicos.Embarcador.Carga.CargaAprovacaoFrete(unitOfWork).CriarAprovacao(carga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoRegraAutorizacaoCarga.Outros, tipoServicoMultisoftware);

                carga.DataInicioConfirmacaoDocumentosFiscais = null;
                carga.ProcessandoDocumentosFiscais = false;
                carga.DataFinalizacaoProcessamentoDocumentosFiscais = DateTime.Now;

                CriarIntegracaoesCargaFrete(ref carga, unitOfWork);

                if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador)
                {
                    Dominio.Entidades.Embarcador.GestaoPatio.FluxoGestaoPatio fluxoGestaoPatio = servicoFluxoGestaoPatio.ObterFluxoGestaoPatio(carga);

                    if ((fluxoGestaoPatio != null) && (fluxoGestaoPatio.EtapaFluxoGestaoPatioAtual == EtapaFluxoGestaoPatio.DocumentoFiscal))
                    {
                        Repositorio.Embarcador.Filiais.ConfiguracaoGestaoPatio repositorioConfiguracaoGestaoPatio = new Repositorio.Embarcador.Filiais.ConfiguracaoGestaoPatio(unitOfWork);
                        Dominio.Entidades.Embarcador.Filiais.ConfiguracaoGestaoPatio configuracaoGestaoPatio = repositorioConfiguracaoGestaoPatio.BuscarConfiguracao();

                        if (configuracaoGestaoPatio?.DocumentoFiscalPermiteAvancarAutomaticamenteAposNotasFiscaisInseridas ?? false)
                            servicoFluxoGestaoPatio.LiberarProximaEtapa(fluxoGestaoPatio, EtapaFluxoGestaoPatio.DocumentoFiscal);
                    }
                }

                if (configuracaoControleEntrega?.CalcularDataAgendamentoAutomaticamenteDataFaturamento ?? false)
                    servicoPrevisaoControleEntrega.CalcularDataAgendamentoColetaEntregaAutomatico(carga, unitOfWork);

                if (!(carga.TipoOperacao?.ExigeConformacaoFreteAntesEmissao ?? true) && carga.ValorFrete >= 0m)
                    if (ValidacaoConfiguracaoCargaFrete(carga, unitOfWork))
                        ProcessarIntegracaoCargaFretePendentes(carga, unitOfWork);

                repCarga.Atualizar(carga);

                unitOfWork.CommitChanges();

                Log.GravarInfo($"Finalizou a confirmação da carga {carga.Codigo}", "ConfirmarEnvioDosDocumentos");

                dynamic dynCarga = serCarga.ObterDetalhesDaCarga(carga, tipoServicoMultisoftware, unitOfWork);

                retornoProcessamento.Carga = dynCarga;
                retornoProcessamento.RetornoDadosFrete = retorno;
                retornoProcessamento.Sucesso = true;

                servicoNotificacaoCarga.InformarRetornoProcessamentoDocumentosFiscais(carga.Codigo, retornoProcessamento, clienteMultisoftware);

                if (configuracaoGeralCarga.NotificarNovaCargaAposConfirmacaoDocumentos && carga.SituacaoCarga == SituacaoCarga.CalculoFrete)
                {
                    Servicos.Embarcador.Notificacao.NotificacaoMTrack serNotificacaoMTrack = new Servicos.Embarcador.Notificacao.NotificacaoMTrack(unitOfWork);
                    serNotificacaoMTrack.NotificarMudancaCarga(carga, carga.Motoristas.ToList(), AdminMultisoftware.Dominio.Enumeradores.MobileHubs.NovaCargaMotorista);
                }
            }
            catch (ServicoException ex)
            {
                unitOfWork.Rollback();

                Log.TratarErro($"Finalizou a confirmação da carga {carga.Codigo} com erro: {ex.Message}", "ConfirmarEnvioDosDocumentos");

                List<Dominio.ObjetosDeValor.Embarcador.Alertas.MensagemAlerta> existeMensagems = servisoMensagemAlerta.ObterMensagensPorEntidades(new List<int> { carga.Codigo });

                if ((existeMensagems == null || existeMensagems.Count == 0) || !existeMensagems.Exists(m => m.Tipo == TipoMensagemAlerta.ProblemaConfirmarEnvioDosDocumentos))
                    servisoMensagemAlerta.Adicionar(carga, TipoMensagemAlerta.ProblemaConfirmarEnvioDosDocumentos, true, ex.Message);

                retornoProcessamento.Mensagem = ex.Message;
                retornoProcessamento.Sucesso = false;
                servicoNotificacaoCarga.InformarRetornoProcessamentoDocumentosFiscais(carga.Codigo, retornoProcessamento, clienteMultisoftware);
            }
        }

        public static void AjustarMoedaCotacaoCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, Repositorio.UnitOfWork unitOfWork)
        {
            Dominio.ObjetosDeValor.Embarcador.Enumeradores.MoedaCotacaoBancoCentral? moeda = null;

            if (configuracaoTMS.UtilizaMoedaEstrangeira && !cargaPedidos.Any(o => o.CTeEmitidoNoEmbarcador) && (carga.TipoOperacao?.UtilizarMoedaEstrangeira ?? false))
                moeda = carga.TipoOperacao.Moeda;

            DateTime? dataBaseCRT = cargaPedidos.FirstOrDefault()?.Pedido?.DataBaseCRT;

            ConfigurarMoedaCotacaoCarga(carga, moeda, dataBaseCRT, unitOfWork);
        }

        public static void ConfigurarMoedaCotacaoCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.MoedaCotacaoBancoCentral? moeda, DateTime? dataBaseCRT, Repositorio.UnitOfWork unitOfWork)
        {
            carga.Moeda = null;
            carga.ValorCotacaoMoeda = null;
            carga.ValorTotalMoeda = null;

            if (moeda.HasValue && moeda != MoedaCotacaoBancoCentral.Real && dataBaseCRT.HasValue)
            {
                carga.Moeda = moeda;

                Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoCotacaoFreteInternacional tipoCotacao = carga.TipoOperacao?.ConfiguracaoCalculoFrete?.TipoCotacao ?? TipoCotacaoFreteInternacional.CotacaoCorrente;
                decimal valorCotacao = carga.TipoOperacao?.ConfiguracaoCalculoFrete?.ValorMoedaCotacao ?? 0m;

                if (tipoCotacao == TipoCotacaoFreteInternacional.CotacaoFixa)
                {
                    carga.ValorCotacaoMoeda = carga.TipoOperacao.ConfiguracaoCalculoFrete.ValorMoedaCotacao ?? 0m;
                    return;
                }

                Repositorio.Embarcador.Moedas.Cotacao repCotacao = new Repositorio.Embarcador.Moedas.Cotacao(unitOfWork);

                Dominio.Entidades.Embarcador.Moedas.Cotacao cotacao = repCotacao.BuscarCotacao(moeda.Value, dataBaseCRT.Value);

                if (cotacao != null)
                {
                    if (cotacao.CotacaoAutomaticaViaWS && cotacao.UtilizarCotacaoRetroativa)
                    {
                        Servicos.Embarcador.Moedas.Cotacao servicoCotacao = new Servicos.Embarcador.Moedas.Cotacao(unitOfWork);
                        cotacao.ValorMoeda = servicoCotacao.ObterValoMoedaDiaria(moeda.Value, dataBaseCRT.Value, unitOfWork);
                    }

                    carga.ValorCotacaoMoeda = cotacao.ValorMoeda;
                }

                if (tipoCotacao == TipoCotacaoFreteInternacional.CotacaoMinima && valorCotacao > carga.ValorCotacaoMoeda)
                    carga.ValorCotacaoMoeda = valorCotacao;
            }
        }

        public void CriarRegistroIntegracaoCargaFrete(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao tipoIntegracao, Dominio.Entidades.Embarcador.Pedidos.Stage stage, List<string> chavesNotasPorStage, bool aguardandoIntegracaoFrete = false)
        {
            Repositorio.Embarcador.Cargas.TipoIntegracao repositorioTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaFreteIntegracao repositorioCargaFreteIntegracao = new Repositorio.Embarcador.Cargas.CargaFreteIntegracao(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.TipoIntegracao existeTipoIntegracao = repositorioTipoIntegracao.BuscarPorTipo(tipoIntegracao);

            if (existeTipoIntegracao == null)
                return;

            //#68808 cargas de entregas e transferencias nao geram integracao de trava para unilever
            if (tipoIntegracao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Unilever && carga.DadosSumarizados?.CargaTrecho == CargaTrechoSumarizada.SubCarga && (stage.TipoPercurso == Vazio.PercursoSubSeQuente || stage.TipoPercurso == Vazio.PercursoPrincipal))
                return;

            Dominio.Entidades.Embarcador.Cargas.CargaFreteIntegracao novoCargaFreteIntegracao = new Dominio.Entidades.Embarcador.Cargas.CargaFreteIntegracao()
            {
                TipoIntegracao = existeTipoIntegracao,
                Carga = carga,
                Stage = stage,
                NumeroTentativas = 0,
                SituacaoIntegracao = SituacaoIntegracao.AgIntegracao,
                DataIntegracao = DateTime.Now,
                ProblemaIntegracao = "",
                ChavesNotasIntegradas = new List<string>()
            };

            carga.AguardandoIntegracaoFrete = aguardandoIntegracaoFrete;

            repositorioCargaFreteIntegracao.Inserir(novoCargaFreteIntegracao);

            if (chavesNotasPorStage?.Count > 0)
                foreach (string chaveNota in chavesNotasPorStage)
                {
                    novoCargaFreteIntegracao.ChavesNotasIntegradas.Add(chaveNota);
                }

            repositorioCargaFreteIntegracao.Atualizar(novoCargaFreteIntegracao);
        }

        public void VerificarHorasParaAvancoEtapaDadosTransporte(Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.TipoOperacao repTipoOperacao = new Repositorio.Embarcador.Pedidos.TipoOperacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.ConfiguracaoTipoOperacaoCarga repConfiguracaoTipoOperacaoCarga = new Repositorio.Embarcador.Pedidos.ConfiguracaoTipoOperacaoCarga(unitOfWork);
            Repositorio.Embarcador.Logistica.Monitoramento repMonitoramento = new Repositorio.Embarcador.Logistica.Monitoramento(unitOfWork);
            Repositorio.Embarcador.Logistica.PermanenciaCliente repPermanenciaCliente = new Repositorio.Embarcador.Logistica.PermanenciaCliente(unitOfWork);

            if (repTipoOperacao.ExisteTipoDeOperacaoManterCargaNaEtapaUmAntesDataCarregamento())
            {
                List<int> codigosCarga = repositorioCarga.BuscarCargasAguardandoSalvarDadosTransporteComRegraAvancoDataCarregamento();
                if (codigosCarga.Count == 0) return;

                List<Dominio.Entidades.Embarcador.Cargas.Carga> cargas = repositorioCarga.BuscarTodasPorCodigo(codigosCarga, true);
                if (cargas.Count == 0) return;

                List<Dominio.Entidades.Embarcador.Logistica.Monitoramento> monitoramentosPorPlaca = repMonitoramento.BuscarMonitoramentoEmAbertoPorVeiculoPlacas(cargas.Select(carga => carga.Veiculo.Placa).ToList());
                List<Tuple<int, DateTime>> dataColetaPorCarga = repositorioCargaPedido.BuscarDataInicialColetaPedidoPorCarga(codigosCarga);

                foreach (Dominio.Entidades.Embarcador.Cargas.Carga carga in cargas)
                {
                    try
                    {
                        bool avancar = true;
                        if (carga.TipoOperacao.ConfiguracaoCarga?.NaoAvancarEtapaSePlacaEstiverEmMonitoramento ?? false)
                        {
                            string placa = carga.Veiculo.Placa;
                            Dominio.Entidades.Embarcador.Logistica.Monitoramento monitoramento = monitoramentosPorPlaca.FirstOrDefault(monitoramento => monitoramento.Veiculo.Placa == placa);
                            if (monitoramento != null)
                            {
                                Dominio.Entidades.Embarcador.Logistica.PermanenciaCliente permanenciaCliente = repPermanenciaCliente.BuscarAbertaPorCarga(monitoramento.Carga);
                                avancar = permanenciaCliente != null;
                            }

                            if (!avancar)
                            {
                                DateTime? dataColetaDaCarga = dataColetaPorCarga.Find(t => t.Item1 == carga.Codigo)?.Item2;
                                avancar = dataColetaDaCarga.HasValue && dataColetaDaCarga.Value <= DateTime.Now;
                            }
                        }

                        if (avancar)
                        {
                            carga.SituacaoCarga = SituacaoCarga.AgNFe;
                            repositorioCarga.Atualizar(carga);
                        }
                    }
                    catch (Exception ex)
                    {
                        /* Enterra exceção para seguir outras cargas */
                        Servicos.Log.TratarErro(ex);
                    }
                    finally
                    {
                        unitOfWork.Flush();
                    }
                }
            }
        }

        public static void AjustarTipoOperacao(Dominio.Entidades.Embarcador.Cargas.Carga carga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {
            if (carga.GrupoPessoaPrincipal == null)
                return;

            Repositorio.Embarcador.Pedidos.TipoOperacao repTipoOperacao = new Repositorio.Embarcador.Pedidos.TipoOperacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);

            Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacao = repTipoOperacao.BuscarPorGrupoPessoasEPeso(carga.GrupoPessoaPrincipal.Codigo, repPedidoXMLNotaFiscal.BuscarPesoPorCarga(carga.Codigo));

            if (tipoOperacao != null)
                carga.TipoOperacao = tipoOperacao;
        }

        public static void AtualizarInicioTrajetoCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaTrajetoCarga repositorioCargaTrajetoCarga = new Repositorio.Embarcador.Cargas.CargaTrajetoCarga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaTrajeto repositorioCargaTrajeto = new Repositorio.Embarcador.Cargas.CargaTrajeto(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.CargaTrajetoCarga cargaTrajetoCarga = repositorioCargaTrajetoCarga.BuscarPorCarga(carga.Codigo);
            Dominio.Entidades.Embarcador.Cargas.CargaTrajeto cargaTrajeto = repositorioCargaTrajeto.BuscarPorCarga(carga.Codigo);

            if (cargaTrajetoCarga == null)
                return;

            cargaTrajetoCarga.SituacaoTrajetoCarga = SituacaoTrajetoCarga.EmTransporte;

            repositorioCargaTrajetoCarga.Atualizar(cargaTrajetoCarga);

            if (cargaTrajetoCarga.Ordem == 1)
                cargaTrajeto.SituacaoTrajeto = SituacaoTrajeto.TransitoOrigem;
            else
                cargaTrajeto.SituacaoTrajeto = SituacaoTrajeto.TransitoDestino;

            repositorioCargaTrajeto.Atualizar(cargaTrajeto);
        }

        public static void AtualizarFimTrajetoCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaTrajetoCarga repositorioCargaTrajetoCarga = new Repositorio.Embarcador.Cargas.CargaTrajetoCarga(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.CargaTrajetoCarga cargaTrajetoCarga = repositorioCargaTrajetoCarga.BuscarPorCarga(carga.Codigo);

            if (cargaTrajetoCarga == null)
                return;

            cargaTrajetoCarga.SituacaoTrajetoCarga = SituacaoTrajetoCarga.Finalizada;

            repositorioCargaTrajetoCarga.Atualizar(cargaTrajetoCarga);
        }

        public static void VincularNotasFiscaisParciaisDosPedidos(AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado)
        {
            unitOfWork.FlushAndClear();

            Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalParcial repCargaPedidoXMLNotaFiscalParcial = new Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalParcial(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);

            Servicos.Embarcador.Pedido.NotaFiscal serCargaNotaFiscal = new Servicos.Embarcador.Pedido.NotaFiscal(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoXMLNotaFiscalParcial> cargaPedidoXMLNotasFiscaisParciais = repCargaPedidoXMLNotaFiscalParcial.BuscarParaVincularPorProcesso(50);

            if (cargaPedidoXMLNotasFiscaisParciais.Count > 0)
            {
                Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = repConfiguracaoTMS.BuscarConfiguracaoPadrao();

                Servicos.Log.TratarErro("Vinculando notas parciais dos pedidos: " + cargaPedidoXMLNotasFiscaisParciais.Count, "VincularNotasFiscaisParciaisDosPedidos");

                List<int> codigosCargas = new List<int>();

                bool possuiIntegracaoCargoX = repTipoIntegracao.ExistePorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.CargoX);

                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoXMLNotaFiscalParcial cargaPedidoXMLNotaFiscalParcial in cargaPedidoXMLNotasFiscaisParciais)
                {
                    Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xmlNotaFiscal = repXMLNotaFiscal.BuscarPorNumeroOuNumeroPedidoSemCarga(cargaPedidoXMLNotaFiscalParcial.Numero, "", cargaPedidoXMLNotaFiscalParcial.CargaPedido.Pedido.Remetente.CPF_CNPJ);

                    if (xmlNotaFiscal == null && possuiIntegracaoCargoX)
                        xmlNotaFiscal = Servicos.Embarcador.Integracao.CargoX.IntegracaoCargoX.ConsultarNotaFiscal(cargaPedidoXMLNotaFiscalParcial.CargaPedido.Carga.CodigoCargaEmbarcador, cargaPedidoXMLNotaFiscalParcial.Chave, unitOfWork);

                    if (xmlNotaFiscal == null)
                        xmlNotaFiscal = Servicos.Embarcador.Documentos.DocumentoDestinadoEmpresa.ObterXMLNotaFiscal(cargaPedidoXMLNotaFiscalParcial.CargaPedido.Pedido.Remetente.CPF_CNPJ_SemFormato, cargaPedidoXMLNotaFiscalParcial.Numero, unitOfWork, tipoServicoMultisoftware);

                    unitOfWork.Start();

                    cargaPedidoXMLNotaFiscalParcial.NumeroTentativasVinculo++;
                    cargaPedidoXMLNotaFiscalParcial.DataUltimaTentativaVinculo = DateTime.Now;

                    repCargaPedidoXMLNotaFiscalParcial.Atualizar(cargaPedidoXMLNotaFiscalParcial);

                    if (xmlNotaFiscal != null)
                    {
                        string retorno = string.Empty;

                        if (cargaPedidoXMLNotaFiscalParcial.CargaPedido.Pedido.Destinatario != null || (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS && cargaPedidoXMLNotaFiscalParcial.CargaPedido.Pedido.Destinatario == null))
                        {
                            bool msgAlertaObservacao = false;
                            bool notaFiscalEmOutraCarga = false;
                            retorno = serCargaNotaFiscal.ValidarRegrasNota(xmlNotaFiscal, cargaPedidoXMLNotaFiscalParcial.CargaPedido, tipoServicoMultisoftware, out msgAlertaObservacao, out notaFiscalEmOutraCarga);
                            if (msgAlertaObservacao && !string.IsNullOrWhiteSpace(retorno))
                                retorno = "";
                        }

                        if (string.IsNullOrWhiteSpace(retorno))
                        {
                            //TODO: PPC - Adicionado log temporário para identificar problema no cargaPedido.Peso.
                            Servicos.Log.TratarErro($"Pedido {cargaPedidoXMLNotaFiscalParcial.CargaPedido.Pedido.NumeroPedidoEmbarcador} - CargaPedido.Codigo = {cargaPedidoXMLNotaFiscalParcial.CargaPedido.Codigo} - Peso Total De.: {cargaPedidoXMLNotaFiscalParcial.CargaPedido.Peso} - Para.: {(cargaPedidoXMLNotaFiscalParcial.CargaPedido.Peso + xmlNotaFiscal.Peso)}. Carga.VincularNotasFiscaisParciaisDosPedidos", "PesoCargaPedido");
                            cargaPedidoXMLNotaFiscalParcial.CargaPedido.Peso += xmlNotaFiscal.Peso;
                            cargaPedidoXMLNotaFiscalParcial.CargaPedido.PesoLiquido += xmlNotaFiscal.PesoLiquido;
                            cargaPedidoXMLNotaFiscalParcial.XMLNotaFiscal = xmlNotaFiscal;
                            cargaPedidoXMLNotaFiscalParcial.VincularNotaFiscalPorProcesso = false;
                            xmlNotaFiscal.TipoNotaFiscalIntegrada = cargaPedidoXMLNotaFiscalParcial.TipoNotaFiscalIntegrada;

                            repCargaPedidoXMLNotaFiscalParcial.Atualizar(cargaPedidoXMLNotaFiscalParcial);
                            repXMLNotaFiscal.Atualizar(xmlNotaFiscal);

                            serCargaNotaFiscal.InserirNotaCargaPedido(xmlNotaFiscal, cargaPedidoXMLNotaFiscalParcial.CargaPedido, tipoServicoMultisoftware, TipoNotaFiscal.Venda, configuracaoTMS, false, out bool alteradoTipoDeCarga, auditado);

                            if (auditado != null)
                                Servicos.Auditoria.Auditoria.Auditar(auditado, xmlNotaFiscal, "Adicionado pelo vínculo de notas fiscais parciais", unitOfWork);

                            if (configuracaoTMS.AvancarEtapaDocumentosEmissaoAoVincularTodasNotasParciaisCarga && !codigosCargas.Contains(cargaPedidoXMLNotaFiscalParcial.CargaPedido.Carga.Codigo))
                                codigosCargas.Add(cargaPedidoXMLNotaFiscalParcial.CargaPedido.Carga.Codigo);
                        }
                        else
                            Servicos.Log.TratarErro(retorno, "VincularNotasFiscaisParciaisDosPedidos");
                    }
                    //else
                    //{
                    //    if (!possuiIntegracaoCargoX)
                    //    {
                    //        cargaPedidoXMLNotaFiscalParcial.VincularNotaFiscalPorProcesso = false;

                    //        repCargaPedidoXMLNotaFiscalParcial.Atualizar(cargaPedidoXMLNotaFiscalParcial);
                    //    }
                    //}

                    unitOfWork.CommitChanges();
                }

                if (configuracaoTMS.AvancarEtapaDocumentosEmissaoAoVincularTodasNotasParciaisCarga)
                {
                    foreach (int codigoCarga in codigosCargas)
                    {
                        if (repCargaPedidoXMLNotaFiscalParcial.VerificarSeExisteNotaParcialSemNota(codigoCarga))
                            continue;

                        unitOfWork.FlushAndClear();

                        unitOfWork.Start();

                        if (!Servicos.Embarcador.Carga.Carga.AvancarEtapaDocumentosEmissaoCarga(out string erro, codigoCarga, false, configuracaoTMS, tipoServicoMultisoftware, unitOfWork))
                            Servicos.Log.TratarErro($"Não foi possível avançar automaticamente a etapa de documentos para emissão da carga (código {codigoCarga}), motivo: {erro}");

                        unitOfWork.CommitChanges();
                    }
                }
            }
        }

        public static bool PermiteVincularCTeComplementoCarga(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido)
        {
            bool permiteCTeComplementar = true;

            if (cargaPedido.Carga.TipoOperacao?.UsarConfiguracaoEmissao ?? false)
                permiteCTeComplementar = !cargaPedido.Carga.TipoOperacao.NaoPermitirVincularCTeComplementarEmCarga;
            else
            {
                Dominio.Entidades.Cliente tomador = cargaPedido.ObterTomador();

                if (tomador?.NaoUsarConfiguracaoEmissaoGrupo ?? false)
                    permiteCTeComplementar = !tomador.NaoPermitirVincularCTeComplementarEmCarga;
                else if (tomador?.GrupoPessoas != null)
                    permiteCTeComplementar = !tomador.GrupoPessoas.NaoPermitirVincularCTeComplementarEmCarga;
            }

            return permiteCTeComplementar;
        }

        public static void AtualizarIntegracaoConsultaCalculoValePedagio(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            Frota.ValePedagio servicoValePedagio = new Frota.ValePedagio(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.ValePedagio.CargaConsultaValorPedagioIntegracao repCargaConsultaValoresPedagio = new Repositorio.Embarcador.Cargas.ValePedagio.CargaConsultaValorPedagioIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio repCargaIntegracaoValoresPedagio = new Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.CargaPracaPedagio repCargaPracaPedagio = new Repositorio.CargaPracaPedagio(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.TipoIntegracao integracao = repTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.SemParar);
            if (integracao == null)
                return;

            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoSemParar integracaoSemParar = servicoValePedagio.ObterIntegracaoSemParar(carga, tipoServicoMultisoftware);
            List<Dominio.Entidades.CargaPracaPedagio> cargaPracasPedagio = repCargaPracaPedagio.BuscarPorCarga(carga.Codigo);
            bool gerarPedagioValorZerado = cargaPracasPedagio.Count == 0 && (integracaoSemParar?.GerarRegistroMesmoSeRotaNaoPossuirPracaPedagio ?? false);

            if (integracao != null && (!string.IsNullOrWhiteSpace(carga.Rota?.CodigoIntegracaoValePedagio) || (integracaoSemParar?.BuscarPracasNaGeracaoDaCarga ?? false) ||
                (carga.TipoOperacao?.PermitirConsultaDeValoresPedagioSemParar ?? false) || gerarPedagioValorZerado)) //Sem Parar só compra se tiver praças de vale pedágio ou rota com código de integração
            {
                //validacao #39686, se ja removeu os componentes de pedagio nao devemos deixar alterar veiculo ou transportador
                List<Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio> listaIntegracaoValePedagioValidacao = repCargaIntegracaoValoresPedagio.BuscarPorCarga(carga.Codigo);
                if (listaIntegracaoValePedagioValidacao.Any(x => x.ValidaCompraRemoveuComponentes))
                    throw new ServicoException($"Não é possível alterar os dados do transportador ou veículo. A consulta do pedágio ja foi efetuada e foram feitas alterações no frete e componentes do frete desta carga.");

                //vamos sempre remover o registro de integracao para carga e zerar o valor vale pedagio dos pedidos;
                repCargaPedido.ZerarValorValePedagioPorCarga(carga.Codigo);

                //caso o veiculo nao possui tag e deve consultar valor pedagio, criar entidade e consultar posteriormente na thread IntegracaoCarga -> ConsultarValoresPedagioPendente
                if (integracaoSemParar != null && (carga.Veiculo != null && carga.Veiculo.PossuiTagValePedagio == false) && integracaoSemParar.NaoComprarValePedagioVeiculoSemTag)
                {
                    if (integracaoSemParar.ConsultarValorPedagioParaRota || (carga.TipoOperacao?.PermitirConsultaDeValoresPedagioSemParar ?? false))
                    {
                        List<Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio> listaIntegracaoValePedagio = repCargaIntegracaoValoresPedagio.BuscarPorCargaAgIntegracao(carga.Codigo);
                        foreach (Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio integracaoValePedagio in listaIntegracaoValePedagio)
                        {
                            if (integracaoValePedagio.TipoIntegracao == integracao)
                                repCargaIntegracaoValoresPedagio.Deletar(integracaoValePedagio);

                        }

                        repCargaConsultaValoresPedagio.RemoverIntegracaoPorCarga(carga.Codigo);

                        //criar classe para consulta de valores pedagio posteriormente na thread IntegracaoCarga -> ConsultarValoresPedagioPendente;
                        Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaConsultaValorPedagioIntegracao cargaConsultaValoresPedagio = new Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaConsultaValorPedagioIntegracao();
                        cargaConsultaValoresPedagio.Carga = carga;
                        cargaConsultaValoresPedagio.TipoIntegracao = integracao;
                        cargaConsultaValoresPedagio.ProblemaIntegracao = "";
                        cargaConsultaValoresPedagio.DataIntegracao = DateTime.Now;
                        cargaConsultaValoresPedagio.SituacaoIntegracao = SituacaoIntegracao.AgIntegracao;
                        cargaConsultaValoresPedagio.TipoRota = integracaoSemParar.TipoRota;

                        bool eixosSuspensos = false;
                        if (carga.TipoOperacao != null && carga.Rota != null)
                        {
                            if (carga.Rota.TipoRota == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoRotaFrete.Ida && carga.TipoOperacao.TipoCarregamento.HasValue && carga.TipoOperacao.TipoCarregamento.Value == Dominio.ObjetosDeValor.Embarcador.Enumeradores.RetornoCargaTipo.Vazio)
                                eixosSuspensos = true;
                        }

                        int numeroEixos = 0;
                        if (!integracaoSemParar.UtilizarModeoVeicularCarga)
                        {
                            if (carga.Veiculo?.ModeloVeicularCarga != null)
                            {
                                numeroEixos = carga.Veiculo.ModeloVeicularCarga.NumeroEixos ?? 0;
                                if (eixosSuspensos)
                                    numeroEixos -= carga.Veiculo.ModeloVeicularCarga.NumeroEixosSuspensos ?? 0;
                            }

                            if (carga.VeiculosVinculados != null)
                            {
                                foreach (Dominio.Entidades.Veiculo reboque in carga.VeiculosVinculados.ToList())
                                {
                                    if (reboque.ModeloVeicularCarga != null && carga.Veiculo?.ModeloVeicularCarga != null && reboque.ModeloVeicularCarga != carga.Veiculo.ModeloVeicularCarga)
                                    {
                                        numeroEixos += reboque.ModeloVeicularCarga.NumeroEixos ?? 0;

                                        if (eixosSuspensos)
                                            numeroEixos -= reboque.ModeloVeicularCarga.NumeroEixosSuspensos ?? 0;
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (carga.ModeloVeicularCarga != null)
                            {
                                numeroEixos = carga.ModeloVeicularCarga.NumeroEixos ?? 0;
                                if (eixosSuspensos)
                                    numeroEixos -= carga.ModeloVeicularCarga.NumeroEixosSuspensos ?? 0;
                            }
                        }

                        cargaConsultaValoresPedagio.QuantidadeEixos = numeroEixos;

                        if (cargaConsultaValoresPedagio.TipoRota == TipoRotaSemParar.RotaFixa)
                            cargaConsultaValoresPedagio.CodigoIntegracaoValePedagio = carga.Rota?.CodigoIntegracaoValePedagio;

                        repCargaConsultaValoresPedagio.Inserir(cargaConsultaValoresPedagio);

                        if (gerarPedagioValorZerado)
                        {
                            cargaConsultaValoresPedagio.SituacaoIntegracao = SituacaoIntegracao.Integrado;
                            cargaConsultaValoresPedagio.ProblemaIntegracao = "Rota não possui vale pedágio. Informação do Embarcador";
                            cargaConsultaValoresPedagio.NumeroTentativas++;
                            repCargaConsultaValoresPedagio.Atualizar(cargaConsultaValoresPedagio);
                        }
                        else
                            carga.IntegrandoValePedagio = true;

                        if (!carga.ExigeNotaFiscalParaCalcularFrete && (carga.SituacaoCarga == SituacaoCarga.AgTransportador || carga.SituacaoCarga == SituacaoCarga.CalculoFrete))
                            carga.CalculandoFrete = true;

                        repCarga.Atualizar(carga);
                    }
                }
            }
        }

        public async Task AtualizarIntegracaoConsultaCalculoValePedagioAsync(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            Frota.ValePedagio servicoValePedagio = new Frota.ValePedagio(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.ValePedagio.CargaConsultaValorPedagioIntegracao repCargaConsultaValoresPedagio = new Repositorio.Embarcador.Cargas.ValePedagio.CargaConsultaValorPedagioIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio repCargaIntegracaoValoresPedagio = new Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.CargaPracaPedagio repCargaPracaPedagio = new Repositorio.CargaPracaPedagio(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.TipoIntegracao integracao = repTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.SemParar);
            if (integracao == null)
                return;

            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoSemParar integracaoSemParar = servicoValePedagio.ObterIntegracaoSemParar(carga, tipoServicoMultisoftware);
            List<Dominio.Entidades.CargaPracaPedagio> cargaPracasPedagio = repCargaPracaPedagio.BuscarPorCarga(carga.Codigo);
            bool gerarPedagioValorZerado = cargaPracasPedagio.Count == 0 && (integracaoSemParar?.GerarRegistroMesmoSeRotaNaoPossuirPracaPedagio ?? false);

            if (integracao != null && (!string.IsNullOrWhiteSpace(carga.Rota?.CodigoIntegracaoValePedagio) || (integracaoSemParar?.BuscarPracasNaGeracaoDaCarga ?? false) ||
                (carga.TipoOperacao?.PermitirConsultaDeValoresPedagioSemParar ?? false) || gerarPedagioValorZerado)) //Sem Parar só compra se tiver praças de vale pedágio ou rota com código de integração
            {
                //validacao #39686, se ja removeu os componentes de pedagio nao devemos deixar alterar veiculo ou transportador
                List<Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio> listaIntegracaoValePedagioValidacao = repCargaIntegracaoValoresPedagio.BuscarPorCarga(carga.Codigo);
                if (listaIntegracaoValePedagioValidacao.Any(x => x.ValidaCompraRemoveuComponentes))
                    throw new ServicoException($"Não é possível alterar os dados do transportador ou veículo. A consulta do pedágio ja foi efetuada e foram feitas alterações no frete e componentes do frete desta carga.");

                //vamos sempre remover o registro de integracao para carga e zerar o valor vale pedagio dos pedidos;
                repCargaPedido.ZerarValorValePedagioPorCarga(carga.Codigo);

                //caso o veiculo nao possui tag e deve consultar valor pedagio, criar entidade e consultar posteriormente na thread IntegracaoCarga -> ConsultarValoresPedagioPendente
                if (integracaoSemParar != null && (carga.Veiculo != null && carga.Veiculo.PossuiTagValePedagio == false) && integracaoSemParar.NaoComprarValePedagioVeiculoSemTag)
                {
                    if (integracaoSemParar.ConsultarValorPedagioParaRota || (carga.TipoOperacao?.PermitirConsultaDeValoresPedagioSemParar ?? false))
                    {
                        List<Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio> listaIntegracaoValePedagio = repCargaIntegracaoValoresPedagio.BuscarPorCargaAgIntegracao(carga.Codigo);
                        foreach (Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio integracaoValePedagio in listaIntegracaoValePedagio)
                        {
                            if (integracaoValePedagio.TipoIntegracao == integracao)
                                await repCargaIntegracaoValoresPedagio.DeletarAsync(integracaoValePedagio);

                        }

                        repCargaConsultaValoresPedagio.RemoverIntegracaoPorCarga(carga.Codigo);

                        //criar classe para consulta de valores pedagio posteriormente na thread IntegracaoCarga -> ConsultarValoresPedagioPendente;
                        Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaConsultaValorPedagioIntegracao cargaConsultaValoresPedagio = new Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaConsultaValorPedagioIntegracao();
                        cargaConsultaValoresPedagio.Carga = carga;
                        cargaConsultaValoresPedagio.TipoIntegracao = integracao;
                        cargaConsultaValoresPedagio.ProblemaIntegracao = "";
                        cargaConsultaValoresPedagio.DataIntegracao = DateTime.Now;
                        cargaConsultaValoresPedagio.SituacaoIntegracao = SituacaoIntegracao.AgIntegracao;
                        cargaConsultaValoresPedagio.TipoRota = integracaoSemParar.TipoRota;

                        bool eixosSuspensos = false;
                        if (carga.TipoOperacao != null && carga.Rota != null)
                        {
                            if (carga.Rota.TipoRota == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoRotaFrete.Ida && carga.TipoOperacao.TipoCarregamento.HasValue && carga.TipoOperacao.TipoCarregamento.Value == Dominio.ObjetosDeValor.Embarcador.Enumeradores.RetornoCargaTipo.Vazio)
                                eixosSuspensos = true;
                        }

                        int numeroEixos = 0;
                        if (!integracaoSemParar.UtilizarModeoVeicularCarga)
                        {
                            if (carga.Veiculo?.ModeloVeicularCarga != null)
                            {
                                numeroEixos = carga.Veiculo.ModeloVeicularCarga.NumeroEixos ?? 0;
                                if (eixosSuspensos)
                                    numeroEixos -= carga.Veiculo.ModeloVeicularCarga.NumeroEixosSuspensos ?? 0;
                            }

                            if (carga.VeiculosVinculados != null)
                            {
                                foreach (Dominio.Entidades.Veiculo reboque in carga.VeiculosVinculados.ToList())
                                {
                                    if (reboque.ModeloVeicularCarga != null && carga.Veiculo?.ModeloVeicularCarga != null && reboque.ModeloVeicularCarga != carga.Veiculo.ModeloVeicularCarga)
                                    {
                                        numeroEixos += reboque.ModeloVeicularCarga.NumeroEixos ?? 0;

                                        if (eixosSuspensos)
                                            numeroEixos -= reboque.ModeloVeicularCarga.NumeroEixosSuspensos ?? 0;
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (carga.ModeloVeicularCarga != null)
                            {
                                numeroEixos = carga.ModeloVeicularCarga.NumeroEixos ?? 0;
                                if (eixosSuspensos)
                                    numeroEixos -= carga.ModeloVeicularCarga.NumeroEixosSuspensos ?? 0;
                            }
                        }

                        cargaConsultaValoresPedagio.QuantidadeEixos = numeroEixos;

                        if (cargaConsultaValoresPedagio.TipoRota == TipoRotaSemParar.RotaFixa)
                            cargaConsultaValoresPedagio.CodigoIntegracaoValePedagio = carga.Rota?.CodigoIntegracaoValePedagio;

                        await repCargaConsultaValoresPedagio.InserirAsync(cargaConsultaValoresPedagio);

                        if (gerarPedagioValorZerado)
                        {
                            cargaConsultaValoresPedagio.SituacaoIntegracao = SituacaoIntegracao.Integrado;
                            cargaConsultaValoresPedagio.ProblemaIntegracao = "Rota não possui vale pedágio. Informação do Embarcador";
                            cargaConsultaValoresPedagio.NumeroTentativas++;
                            await repCargaConsultaValoresPedagio.AtualizarAsync(cargaConsultaValoresPedagio);
                        }
                        else
                            carga.IntegrandoValePedagio = true;

                        if (!carga.ExigeNotaFiscalParaCalcularFrete && (carga.SituacaoCarga == SituacaoCarga.AgTransportador || carga.SituacaoCarga == SituacaoCarga.CalculoFrete))
                            carga.CalculandoFrete = true;

                        await repCarga.AtualizarAsync(carga);
                    }
                }
            }
        }

        public bool IniciarEmissaoDocumentosCarga(out string mensagem, out object retorno, Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Usuario usuario, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, string webServiceConsultaCTe, List<AdminMultisoftware.Dominio.Enumeradores.PermissaoPersonalizada> permissoesPersonalizadas = null)
        {
            mensagem = null;
            retorno = null;

            try
            {
                Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
                Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
                Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaPedidoComponentesFrete repCargaPedidoComponentesFrete = new Repositorio.Embarcador.Cargas.CargaPedidoComponentesFrete(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaMDFe repCargaMDFe = new Repositorio.Embarcador.Cargas.CargaMDFe(unitOfWork);
                Repositorio.Embarcador.Seguros.ApoliceSeguraAutorizacaoCarga repApoliceSeguraAutorizacaoCarga = new Repositorio.Embarcador.Seguros.ApoliceSeguraAutorizacaoCarga(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaPedidoModalidadePagamentoNFAprovacao repCargaPedidoModalidadePagamentoNFAprovacao = new Repositorio.Embarcador.Cargas.CargaPedidoModalidadePagamentoNFAprovacao(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaComponentesFrete repCargaComponenteFrete = new Repositorio.Embarcador.Cargas.CargaComponentesFrete(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaLacre repCargaLacre = new Repositorio.Embarcador.Cargas.CargaLacre(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaValePedagio repCargaValePedagio = new Repositorio.Embarcador.Cargas.CargaValePedagio(unitOfWork);
                Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio repCargaIntegracaoValePedagio = new Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio(unitOfWork);
                Repositorio.Embarcador.Terceiros.ContratoFrete repContratoFreteTerceiro = new Repositorio.Embarcador.Terceiros.ContratoFrete(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaPedidoRotaFrete repCargaPedidoRotaFrete = new Repositorio.Embarcador.Cargas.CargaPedidoRotaFrete(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe repCargaPedidoDocumentoCTe = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe(unitOfWork);
                Repositorio.Embarcador.Terceiros.ContratoFrete repContratoFrete = new Repositorio.Embarcador.Terceiros.ContratoFrete(unitOfWork);
                Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao repPedidoCTeParaSubcontratacao = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao(unitOfWork);
                Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repApoliceSeguroAverbacao = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);
                Repositorio.Embarcador.Filiais.ConfiguracaoGestaoPatio repositorioConfiguracaoGestaoPatio = new Repositorio.Embarcador.Filiais.ConfiguracaoGestaoPatio(unitOfWork);
                Repositorio.Embarcador.Pedidos.PedidoAverbacao repPedidoAverbacao = new Repositorio.Embarcador.Pedidos.PedidoAverbacao(unitOfWork);
                Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unitOfWork);
                Repositorio.Embarcador.Configuracoes.ConfiguracaoCargaEmissaoDocumento repConfiguracaoCargaEmissaoDocumento = new Repositorio.Embarcador.Configuracoes.ConfiguracaoCargaEmissaoDocumento(unitOfWork);
                Repositorio.Embarcador.Configuracoes.ConfiguracaoCargaCalculoFrete repConfiguracaoCargaCalculoFrete = new Repositorio.Embarcador.Configuracoes.ConfiguracaoCargaCalculoFrete(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoGuarita repositorioGuarita = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoGuarita(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaMotorista repositorioCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);
                Repositorio.Embarcador.Pedidos.ColetaContainer repositorioColetaContainer = new Repositorio.Embarcador.Pedidos.ColetaContainer(unitOfWork);
                Repositorio.Embarcador.Pedidos.RetiradaContainer repositorioRetiradaContainer = new Repositorio.Embarcador.Pedidos.RetiradaContainer(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaFreteIntegracao repositorioCargaFreteIntegracao = new Repositorio.Embarcador.Cargas.CargaFreteIntegracao(unitOfWork);
                Repositorio.Empresa repositorioEmpresa = new Repositorio.Empresa(unitOfWork);
                Repositorio.Embarcador.Pessoas.PessoaLicenca repPessoaLicenca = new Repositorio.Embarcador.Pessoas.PessoaLicenca(unitOfWork);
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unitOfWork);
                Repositorio.Embarcador.Veiculos.LicencaVeiculo repLicencaVeiculo = new Repositorio.Embarcador.Veiculos.LicencaVeiculo(unitOfWork);
                Repositorio.Embarcador.Transportadores.MotoristaLicenca repMotoristaLicenca = new Repositorio.Embarcador.Transportadores.MotoristaLicenca(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaCancelamento repCargaCancelamento = new Repositorio.Embarcador.Cargas.CargaCancelamento(unitOfWork);

                Servicos.Embarcador.Pedido.NotaFiscal serPedidoNotaFiscal = new Servicos.Embarcador.Pedido.NotaFiscal(unitOfWork);
                Servicos.Embarcador.Carga.CTe serCTe = new Servicos.Embarcador.Carga.CTe(unitOfWork);
                Servicos.Embarcador.Seguro.Seguro serSerguro = new Servicos.Embarcador.Seguro.Seguro(unitOfWork);
                Servicos.Embarcador.NFSe.NFSe serNFSe = new Servicos.Embarcador.NFSe.NFSe(unitOfWork);
                Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);
                Servicos.Embarcador.Carga.Frete serFrete = new Servicos.Embarcador.Carga.Frete(unitOfWork, tipoServicoMultisoftware);
                Servicos.Embarcador.Carga.RateioFormula serRateioFormula = new Servicos.Embarcador.Carga.RateioFormula();
                Servicos.Embarcador.GestaoPatio.FluxoGestaoPatio servicoFluxoGestaoPatio = new Servicos.Embarcador.GestaoPatio.FluxoGestaoPatio(unitOfWork);
                Servicos.Embarcador.Pedido.ColetaContainer servicoColetaContainer = new Servicos.Embarcador.Pedido.ColetaContainer(unitOfWork);

                Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoCargaEmissaoDocumento configuracaoCargaEmissaoDocumento = repConfiguracaoCargaEmissaoDocumento.BuscarConfiguracaoPadrao();
                Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoCargaCalculoFrete configuracaoCargaCalculoFrete = repConfiguracaoCargaCalculoFrete.BuscarConfiguracaoPadrao();

                bool cteEmitidoNoEmbarcador = repCargaPedido.ExisteCTeEmitidoNoEmbarcador(carga.Codigo);

                if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe && usuario != null && carga.Empresa.Codigo != usuario.Empresa.Codigo && !(carga.TipoOperacao?.PermiteTransportadorAvancarEtapaEmissao ?? false))
                    throw new ServicoException("Você não possui permissões para executar esta ação.");

                Dominio.Entidades.Embarcador.Cargas.CargaCancelamento cargaCancelamento = repCargaCancelamento.BuscarPorCarga(carga.Codigo);

                SituacaoCancelamentoCarga[] situacoesQuePermitemAvancar =
                {
                    SituacaoCancelamentoCarga.SolicitacaoReprovada,
                    SituacaoCancelamentoCarga.Reprovada,
                    SituacaoCancelamentoCarga.RejeicaoCancelamento
                };

                if (cargaCancelamento != null && !situacoesQuePermitemAvancar.Contains(cargaCancelamento.Situacao))
                    throw new ServicoException("A carga já está cancelada ou em processo de cancelamento");


                if (!carga.CargaTransbordo &&
                    configuracaoCargaCalculoFrete != null &&
                    configuracaoCargaCalculoFrete.ValorMaximoCalculoFrete > 0m &&
                    carga.ValorFreteAPagar > configuracaoCargaCalculoFrete.ValorMaximoCalculoFrete)
                    throw new ServicoException($"O valor do frete excede {configuracaoCargaCalculoFrete.ValorMaximoCalculoFrete}, não sendo possível iniciar a emissão dos documentos.");

                if (!carga.CargaTransbordo &&
                    configuracaoCargaCalculoFrete != null &&
                    (carga.TipoOperacao?.ConfiguracaoCalculoFrete?.ValorMaximoCalculoFrete ?? 0m) > 0m &&
                    carga.ValorFreteAPagar > carga.TipoOperacao.ConfiguracaoCalculoFrete.ValorMaximoCalculoFrete)
                    throw new ServicoException($"O valor do frete excede {carga.TipoOperacao.ConfiguracaoCalculoFrete.ValorMaximoCalculoFrete}, não sendo possível iniciar a emissão dos documentos.");

                if (((carga.TipoOperacao?.InserirDadosContabeisXCampoXTextCTe ?? false) || configuracaoTMS.CentroResultadoPedidoObrigatorio) && carga.PossuiPendenciaConfiguracaoContabil)
                    throw new ServicoException("Não é possível emitir a carga pois não foram localizadas configurações contábeis compativeis com e mesma, por favor ajuste as configurações de centro de custo ou conta contábil e calcule o frete novamente para aplicar as novas configurações na carga.");

                if (carga.SituacaoCarga != SituacaoCarga.CalculoFrete)
                    throw new ServicoException($"A atual situação da carga {carga.DescricaoSituacaoCarga} não permite que a emissão seja iniciada.");

                if (carga.CalculandoFrete)
                    throw new ServicoException("A carga está em processo de cálculo de valores do frete, não sendo possível iniciar a emissão dos documentos.");

                if (!carga.SituacaoAlteracaoFreteCarga.IsPermiteAvancarEtapa())
                    throw new ServicoException("Não é possível iniciar a emissão antes de aprovar a alçada pendente da carga.");

                if (carga.CargaAgrupamento != null || carga.CargaVinculada != null)
                    throw new ServicoException("A carga foi agrupada, sendo assim não é possível alterá-la.");

                if (configuracaoTMS.BloquearEmissaoCargaSemTempoRota && (carga.Rota?.TempoDeViagemEmMinutos ?? 0) <= 0)
                    throw new ServicoException("Não há tempo de viagem configurado na rota.");

                if ((carga.TipoOperacao?.ConfiguracaoCarga?.NaoPermitirAvancarCargaComTracaoSemReboque ?? false) && (carga.VeiculosVinculados == null || carga.VeiculosVinculados.Count() == 0 || !carga.VeiculosVinculados.Any(x => x.ModeloVeicularCarga.Tipo == TipoModeloVeicularCarga.Reboque)))
                    throw new ServicoException("Obrigatório que a carga possua reboques vinculados");

                if (carga.ValorFreteOperador == 0 && carga.ObrigatorioInformarValorFreteOperador)
                    throw new ServicoException("Não há valor de frete para a carga");

                //VICTOR O DEFAULT DE TODA EMPRESA É ESTAR SETADO PARA FALSE RecusarIntegracaoPODUnilever... (LEMBRE-SE ARCELOR TAMBEM USA CargaGeradaViaDocumentoTransporte)
                //if ((carga?.CargaGeradaViaDocumentoTransporte ?? false) && !(carga?.Empresa?.RecusarIntegracaoPODUnilever ?? false) && carga.CodigoCargaEmbarcador.StartsWith("0"))
                //    throw new ServicoException("Esta carga não pode ser avançada pois transportador não esta habilitado para o projeto.");

                if (carga.Rota == null && (
                    (carga.GrupoPessoaPrincipal != null && carga.GrupoPessoaPrincipal.ExigirRotaParaEmissaoDocumentos) ||
                    (
                        (!carga.TipoOperacao?.NaoComprarValePedagio ?? false) &&
                        configuracaoTMS.ExigirRotaParaEmissaoDocumentos && Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota.IsComprarValePedagio(carga, unitOfWork) &&
                        !carga.Pedidos.Any(o => o.ValorPedagio > 0) &&
                        !repCargaValePedagio.ExistePorCarga(carga.Codigo)
                    )
                ))
                    throw new ServicoException("É necessário selecionar uma rota de frete antes de iniciar a emissão dos documentos.");

                if (carga.Operador == null)
                    carga.Operador = usuario;

                if (carga.CargaAgrupada)
                {
                    List<Dominio.Entidades.Empresa> empresas = repCarga.BuscarEmpresasCargasOriginais(carga.Codigo);
                    if (empresas.Count > 1)
                    {
                        string raiz = empresas.FirstOrDefault().RaizCnpj;
                        foreach (Dominio.Entidades.Empresa empresaRaiz in empresas)
                        {
                            if (!empresaRaiz.CNPJ_SemFormato.Contains(raiz))
                                throw new ServicoException("Não é possível emitir cargas agrupadas para transportadoras diferentes.");
                        }
                    }

                    if ((carga.TipoOperacao?.ObrigatorioVincularContainerCarga ?? false) && tipoServicoMultisoftware != TipoServicoMultisoftware.MultiTMS)
                    {
                        Dominio.Entidades.Embarcador.Pedidos.ColetaContainer coletaContainer;

                        if (carga.TipoOperacao?.OperacaoTransferenciaContainer ?? false)
                            coletaContainer = repositorioColetaContainer.BuscarPorCargaAtual(carga.Codigo);
                        else
                            coletaContainer = repositorioColetaContainer.BuscarPorCargaDeColeta(carga.Codigo);

                        if (coletaContainer?.Container == null)
                            throw new ServicoException("É obrigatório informar o container para poder avançar essa etapa");

                        if (new Pedido.ConferenciaContainer(unitOfWork).PossuiConferenciaSemAprovacao(carga))
                            throw new ServicoException("É obrigatório realizar a conferência do container para poder avançar essa etapa");
                    }
                    else
                    {
                        Dominio.Entidades.Embarcador.Pedidos.RetiradaContainer retiradaContainer = repositorioRetiradaContainer.BuscarPorCarga(carga.Codigo);
                        Dominio.Entidades.Embarcador.Pedidos.ContainerTipo containerTipo = retiradaContainer?.ContainerTipo ?? carga.ModeloVeicularCarga?.ContainerTipo ?? carga.Carregamento?.ModeloVeicularCarga?.ContainerTipo;

                        if (containerTipo != null)
                        {
                            if (retiradaContainer?.ColetaContainer?.Container == null)
                            {
                                if (!carga.LiberadaSemRetiradaContainer)
                                    throw new ServicoException($"O container do tipo {containerTipo.Descricao} ainda não foi informado para esta carga, não sendo possível prosseguir.");
                            }
                            //else // nao temos certeza se realmente tem q atualizar o status para essa carga neste local..
                            //{
                            //    servicoColetaContainer.AtualizarSituacaoColetaContainerEGerarHistorico(new Dominio.ObjetosDeValor.Embarcador.Pedido.AtualizarColetaContainerParametro()
                            //    {
                            //        coletaContainer = retiradaContainer.ColetaContainer,
                            //        DataAtualizacao = DateTime.Now,
                            //        Status = StatusColetaContainer.EmDeslocamentoCarregado,
                            //        Usuario = usuario
                            //    });
                            //}
                        }
                    }

                }

                if (carga.GrupoPessoaPrincipal != null && carga.GrupoPessoaPrincipal.ExigirRotaCalculoFreteParaEmissaoDocumentos && !repCargaPedidoRotaFrete.ExistePorCarga(carga.Codigo))
                    throw new ServicoException("É necessário adicionar ao menos uma rota para iniciar a emissão dos documentos.");

                if (carga.AguardandoEmissaoDocumentoAnterior)
                {
                    List<Dominio.Entidades.Embarcador.Cargas.Carga> cargasAnteriores = repCargaPedido.ObterTodasCargasTrechosAnteriores(carga.Codigo);
                    bool podeLiberar = true;

                    foreach (Dominio.Entidades.Embarcador.Cargas.Carga cargaAnterior in cargasAnteriores)
                    {
                        if (serCarga.VerificarSeCargaEstaNaLogistica(cargaAnterior, tipoServicoMultisoftware) ||
                                   cargaAnterior.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe ||
                                  cargaAnterior.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.PendeciaDocumentos)
                        {
                            podeLiberar = false;
                        }
                    }

                    if (podeLiberar)
                    {
                        carga.AguardandoEmissaoDocumentoAnterior = false;
                        repCarga.Atualizar(carga);
                    }
                    else
                        throw new ServicoException("Não é possível iniciar a emissão antes que os CT-es do Trecho anterior sejam emitidos.");

                }


                if (carga.AgValorRedespacho)
                    throw new ServicoException("Não é possível iniciar a emissão antes o cálculo do frete de segundo trecho seja concluído.");

                if ((configuracaoTMS.ExigirCargaRoteirizada || (carga.TipoOperacao?.ExigirCargaRoteirizada ?? false)) && carga.SituacaoRoteirizacaoCarga != SituacaoRoteirizacao.Concluido)
                    throw new ServicoException($"A situação da roteirização da carga ({carga.SituacaoRoteirizacaoCarga.ObterDescricao()}) não permite que os documentos sejam emitidos.");

                if (!carga.CargaTransbordo && !cteEmitidoNoEmbarcador)
                {
                    Dominio.Entidades.Embarcador.Rateio.RateioFormula formulaRateio = serRateioFormula.ObterFormulaDeRateio(carga, unitOfWork);

                    if ((formulaRateio == null || formulaRateio.ParametroRateioFormula == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ParametroRateioFormula.peso) && repPedidoXMLNotaFiscal.VerificarSeAlgumaNaoPossuiPeso(carga.Codigo))
                    {
                        if (configuracaoTMS.UtilizaEmissaoMultimodal && carga.Pedidos.Any(o => o.TipoPropostaMultimodal != TipoPropostaMultimodal.VAS))
                            throw new ServicoException("Existem notas fiscais sem peso. Informe o peso para prosseguir.");
                        else if (!configuracaoTMS.UtilizaEmissaoMultimodal)
                            throw new ServicoException("Existem notas fiscais sem peso. Informe o peso para prosseguir.");
                    }
                    else if (formulaRateio?.ParametroRateioFormula == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ParametroRateioFormula.PorPesoUtilizandoFatorCubagem)
                    {
                        if (repPedidoXMLNotaFiscal.VerificarSeAlgumaNaoPossuiMetrosCubicos(carga.Codigo))
                        {
                            throw new ServicoException("Existem notas fiscais sem metros cúbicos. Informe o metro cúbico para prosseguir.");
                        }
                    }
                }

                string msgAlerta = serCarga.BuscarPendenciaConfiguracaoFaturamentoTomador(carga, unitOfWork, configuracaoTMS);
                if (!string.IsNullOrWhiteSpace(msgAlerta))
                    throw new ServicoException(msgAlerta);

                msgAlerta = serFrete.ValidarEntidadesSemCodigoDocumentacao(carga, unitOfWork, configuracaoTMS);
                if (!string.IsNullOrWhiteSpace(msgAlerta))
                    throw new ServicoException(msgAlerta);

                List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeDocumentos> tiposRateioDocumentos = repCargaPedido.BuscarTipoRateioPorCarga(carga.Codigo, true);
                if (tiposRateioDocumentos.Count > 1 && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    throw new ServicoException("Existe mais de um rateio de documentos configurado nos pedidos, somente sendo permitido um por carga. Ajuste o rateio dos documentos para os pedidos na aba Configurações da etapa de frete da carga.");

                if (configuracaoTMS.PermiteEmissaoCargaSomenteComTracao)
                {
                    if (carga.Veiculo != null || carga.VeiculosVinculados.Count > 0)
                    {
                        if ((carga.Veiculo == null || carga.Veiculo.TipoVeiculo != "0") && !carga.VeiculosVinculados.Any(o => o.TipoVeiculo == "0"))
                            throw new ServicoException("É obrigatório informar um veículo do tipo tração para emitir os documentos.");
                    }
                }

                //if (carga.Carregamento != null)
                //{
                //    foreach (Dominio.Entidades.Embarcador.Cargas.Carga cargaCarregamento in carga.Carregamento.CargasFrete.ToList())
                //    {
                //        if (cargaCarregamento.Codigo != carga.Codigo)
                //        {
                //            if (cargaCarregamento.CalculandoFrete)
                //                throw new ServicoException("Não possível iniciar a emissão pois existem cargas deste carregamento que ainda estão em processo de cálculo de frete.");
                //        }
                //    }
                //}

                if (carga.FreteDeTerceiro)
                {
                    Dominio.Entidades.Embarcador.Terceiros.ContratoFrete contratoFrete = repContratoFrete.BuscarPorCarga(carga.Codigo);

                    if (configuracaoTMS.BloquearEmissaoComContratoFreteZerado)
                    {
                        if (contratoFrete != null && contratoFrete.ValorFreteSubcontratacao <= 0m)
                            throw new ServicoException("É necessário informar um valor para o contrato de frete antes de iniciar a emissão dos documentos.");
                    }

                    if (configuracaoCargaEmissaoDocumento.BloquearEmissaoCargaTerceirosSemValePedagio && !repCargaValePedagio.ExistePorCarga(carga.Codigo) && !repCargaIntegracaoValePedagio.ExistePorCarga(carga.Codigo))
                        throw new ServicoException("Vale pedágio é obrigatório para esta carga, não sendo possível prosseguir com a emissão dos documentos.");

                    if (contratoFrete != null)
                    {
                        if (contratoFrete.ValorFreteSubcontratacao < 0m)
                            throw new ServicoException($"O valor do contrato de frete é negativo ({contratoFrete.ValorFreteSubcontratacao:n2}), não sendo possível prosseguir com a emissão dos documentos.");

                        if (contratoFrete.ValorAbastecimento < 0m)
                            throw new ServicoException($"O valor de abastecimento do contrato de frete é negativo ({contratoFrete.ValorAbastecimento:n2}), não sendo possível prosseguir com a emissão dos documentos.");

                        if (contratoFrete.ValorAdiantamento < 0m)
                            throw new ServicoException($"O valor de adiantamento do contrato de frete é negativo ({contratoFrete.ValorAdiantamento:n2}), não sendo possível prosseguir com a emissão dos documentos.");

                        if (contratoFrete.SaldoAReceber < 0m)
                            throw new ServicoException($"O saldo do contrato de frete é negativo ({contratoFrete.SaldoAReceber:n2}), não sendo possível prosseguir com a emissão dos documentos.");
                    }
                }

                if (carga.BloqueadaDiferencaValorFrete)
                    throw new ServicoException("É necessária a autorização da diferença de valor do frete para prosseguir com a emissão dos documentos.");

                if (repCargaComponenteFrete.ContarComponentesInvalidosPorCarga(carga.Codigo) > 0)
                    throw new ServicoException("Existem componentes inválidos na carga, não sendo possível a emissão.");

                if (Servicos.Embarcador.Carga.Carga.VerificarSePossuiValePedagioObrigatorio(carga, unitOfWork) && !repCargaValePedagio.ExistePorCarga(carga.Codigo))
                    throw new ServicoException("É obrigatório informar um vale pedágio para esta carga.");

                if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                {
                    if (repCargaComponenteFrete.ContarComponentesSemConfiguracaoFinanceira(carga.Codigo) > 0)
                        throw new ServicoException("Existem componentes sem configuração para geração de movimentos financeiros, não sendo possível prosseguir com a emissão dos documentos.");

                    if (carga.Empresa == null)
                        throw new ServicoException("É necessário informar a empresa emissora dos documentos.");

                    if (usuario != null && usuario.LimitarOperacaoPorEmpresa && !usuario.Empresas.Any(o => o.Codigo == carga.Empresa.Codigo))
                        throw new ServicoException("Você não possui permissão para avançar essa etapa da carga da empresa " + carga.Empresa.RazaoSocial);

                    if (carga.TipoOperacao != null && carga.GrupoPessoaPrincipal != null)
                    {
                        Repositorio.Embarcador.Pedidos.TipoOperacaoGrupoTomadorBloqueado repTipoOperacaoGrupoTomadorBloqueado = new Repositorio.Embarcador.Pedidos.TipoOperacaoGrupoTomadorBloqueado(unitOfWork);
                        List<Dominio.Entidades.Embarcador.Pedidos.TipoOperacaoGrupoTomadorBloqueado> grupoTomadoresBloqueados = repTipoOperacaoGrupoTomadorBloqueado.BuscarPorTipoOperacao(carga.TipoOperacao.Codigo);

                        if (grupoTomadoresBloqueados.Count > 0 && grupoTomadoresBloqueados.Any(o => o.GrupoPessoas.Codigo == carga.GrupoPessoaPrincipal.Codigo))
                            throw new ServicoException("Grupo de Pessoas da carga está bloqueado para esse Tipo de Operação");
                    }

                    if (repCargaPedidoDocumentoCTe.ExisteCTeNaoAutorizadoPorCarga(carga.Codigo))
                        throw new ServicoException("É necessário que todos os CT-es emitidos pelo Embarcador estejam Autorizados.");

                    Dominio.Entidades.DocumentosCTE documentoCTe = ValidarCTeEmitidoEmbarcadorOuTransbordoFaltandoNotaFiscalCTe(carga, unitOfWork);

                    if (documentoCTe != null)
                        throw new ServicoException($"CT-e nro {documentoCTe.CTE.Numero} sem nota fiscal informada no pedido.");
                }

                ValidarEmissaoCargaComValorZerado(carga, configuracaoTMS, unitOfWork);

                if (ValidacaoConfiguracaoCargaFrete(carga, unitOfWork))
                {
                    if (!(carga.TipoOperacao?.FretePorContadoCliente ?? false) && carga.ValorFrete <= 0m)
                        throw new ServicoException("Não pode ser enviado as integrações porque os valores do frete estão zerados");

                    if (carga.ValorFrete > 0m && !carga.LiberadaComPendenciaIntegracaoFrete)
                    {
                        if (ProcessarIntegracaoCargaFretePendentes(carga, unitOfWork))
                            return true;
                    }
                }

                if ((carga.TipoOperacao?.ConfiguracaoCarga?.PermitirAlterarDataRetornoCDCarga ?? false) && (carga.Empresa?.EmpresaPropria ?? false) && !carga.DataRetornoCD.HasValue)
                    throw new ServicoException("É necessário informar a Data de Retorno do CD para transportadores de frota própria");

                if (carga.CargaTransbordo && !carga.NaoGerarMDFe)
                {
                    Repositorio.ManifestoEletronicoDeDocumentosFiscais repMDFe = new Repositorio.ManifestoEletronicoDeDocumentosFiscais(unitOfWork);

                    Dominio.Entidades.DocumentoMunicipioDescarregamentoMDFe documentoMunicipioDescarregamentoMDFe = repMDFe.BuscarPorCargaPedidoDocumentoCTeEStatus(carga.Codigo, new Dominio.Enumeradores.StatusMDFe[] { Dominio.Enumeradores.StatusMDFe.Enviado, Dominio.Enumeradores.StatusMDFe.Autorizado });

                    if (documentoMunicipioDescarregamentoMDFe != null)
                        throw new ServicoException($"Existe um MDF-e [{documentoMunicipioDescarregamentoMDFe.MunicipioDescarregamento.MDFe.Chave}] autorizado para o CT-e [{documentoMunicipioDescarregamentoMDFe.CTe.Chave}].");
                }

                if (repCargaPedido.VerificarPorCargaSePossuiComplementoAEmitirPornota(carga.Codigo))
                    throw new ServicoException("Não é possível emitir a carga pois os complementos da filial emissora exigem que a emissão seja por pedido e não por nota fiscal.");

                Dominio.Entidades.Embarcador.Filiais.ConfiguracaoGestaoPatio configuracaoGestaoPatio = repositorioConfiguracaoGestaoPatio.BuscarConfiguracao();
                Dominio.Entidades.Embarcador.GestaoPatio.FluxoGestaoPatio fluxoGestaoPatio = servicoFluxoGestaoPatio.ObterFluxoGestaoPatio(carga);

                bool faturamentoPermiteSolicitarNotasFiscaisEtapaBloqueada = configuracaoGestaoPatio?.FaturamentoPermiteSolicitarNotasFiscaisEtapaBloqueada ?? false;
                bool etapaFaturamentoBloqueada = (fluxoGestaoPatio != null) && fluxoGestaoPatio.Etapas.Any(obj => obj.EtapaFluxoGestaoPatio == EtapaFluxoGestaoPatio.Faturamento) && !carga.EtapaFaturamentoLiberado;

                if (!faturamentoPermiteSolicitarNotasFiscaisEtapaBloqueada && etapaFaturamentoBloqueada)
                    throw new ServicoException("Ainda não foi liberado o faturamento para esta carga.");

                if (!configuracaoTMS.PermiteAdicionarNFeRepetidaParaOutroPedidoCarga && !(carga.TipoOperacao?.PermiteConsultarPorPacotesLoggi ?? false) && (!carga.Empresa?.IgnorarDocumentosDuplicadosNaEmissaoCTe ?? false))
                {
                    IList<string> listaChaveNFeDuplicada = repPedidoXMLNotaFiscal.BuscarListaChaveNFeDuplicadaPorCarga(carga.Codigo);

                    if (listaChaveNFeDuplicada.Count > 0)
                        throw new ServicoException("Existem NF-es duplicadas na carga.");
                }

                Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoGuarita guarita = repositorioGuarita.BuscarPorCarga(carga.Codigo);

                if (guarita?.ChegadaDenegada ?? false)
                    throw new ServicoException("A chegada na guarita foi denegada.");

                if (carga.TipoOperacao?.ConfiguracaoCarga?.NaoPermitirInformarMotoristaComCNHVencida ?? false)
                {
                    List<Dominio.Entidades.Usuario> motoristas = repositorioCargaMotorista.BuscarMotoristasPorCarga(carga.Codigo);
                    foreach (Dominio.Entidades.Usuario motorista in motoristas)
                    {
                        if (!motorista.DataVencimentoHabilitacao.HasValue || motorista.DataVencimentoHabilitacao.Value.AddDays(30) < DateTime.Now.Date)
                            throw new ServicoException($"O motorista {motorista.Nome} informado na carga possui a CNH vencida a mais de 30 dias ou a data não está preenchida no cadastro dele, não sendo possível prosseguir.");
                    }
                }

                unitOfWork.Start();

                if (configuracaoTMS.UtilizaEmissaoMultimodal)
                    carga.NaoGerarMDFe = true;

                if (carga.Carregamento != null)
                {
                    Repositorio.Embarcador.Cargas.MontagemCarga.Carregamento repCarregamento = new Repositorio.Embarcador.Cargas.MontagemCarga.Carregamento(unitOfWork);
                    carga.Carregamento.SituacaoCarregamento = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarregamento.Fechado;
                    repCarregamento.Atualizar(carga.Carregamento);
                }

                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = null;

                if (!cteEmitidoNoEmbarcador && !carga.CargaTransbordo && !carga.EmitirCTeComplementar && (configuracaoTMS.NaoPermiteEmitirCargaSemAverbacao && !(carga.TipoOperacao?.PermitirCargaSemAverbacao ?? false)) && carga.TipoFreteEscolhido != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Cliente)
                {
                    Dominio.Entidades.Empresa empresa = carga.ObterEmpresaEmissora;

                    if (!empresa.LiberarEmissaoSemAverbacao)
                    {
                        if (!carga.DadosSumarizados.PossuiAverbacaoCTe)
                        {
                            cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo, null, true, configuracaoTMS.RatearFretePedidosAposLiberarEmissaoSemNFe);
                            Servicos.Embarcador.Seguro.Seguro.SetarDadosSeguroCarga(carga, cargaPedidos, configuracaoTMS, tipoServicoMultisoftware, unitOfWork);
                        }

                        if (!carga.DadosSumarizados.PossuiAverbacaoCTe && carga.Pedidos.Any(o => o.ModeloDocumentoFiscal == null || o.ModeloDocumentoFiscal.AverbarDocumento))
                        {
                            IList<Dominio.ObjetosDeValor.Embarcador.Carga.Averbacao> listaAverbacaoPedidos = repPedidoAverbacao.BuscarPorCarga(carga.Codigo);

                            if (listaAverbacaoPedidos == null || listaAverbacaoPedidos.Count == 0)
                                throw new ServicoException("Não é possível confirmar a emissão dos documentos desta carga pois não existe uma averbação de CT-e configurada.");
                        }
                    }
                }

                if (!cteEmitidoNoEmbarcador && !carga.CargaTransbordo && !carga.EmitirCTeComplementar && configuracaoTMS.NaoPermiteEmitirCargaSemSeguro && !repApoliceSeguroAverbacao.ExistePorCarga(carga.Codigo))
                    throw new ServicoException("Não é possível confirmar a emissão dos documentos desta carga pois não existe uma apólice se seguro configurada.");

                if (!cteEmitidoNoEmbarcador && configuracaoTMS.ExigirRotaRoteirizadaNaCarga && !(carga.TipoOperacao?.NaoExigeRotaRoteirizada ?? false) && (carga.Rota == null || carga.Rota.SituacaoDaRoteirizacao != SituacaoRoteirizacao.Concluido))
                    throw new ServicoException("Necessário que a rota frete esteja roteirizada, favor verificar o cadastro da rota.");

                string retornoCIOT = Servicos.Embarcador.CIOT.CIOT.ObterCIOTCarga(carga, configuracaoTMS, tipoServicoMultisoftware, unitOfWork);

                if (!string.IsNullOrWhiteSpace(retornoCIOT))
                    throw new ServicoException(retornoCIOT);

                if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS && repCargaPedidoModalidadePagamentoNFAprovacao.BuscarQuantidadePorCargaESituacao(carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoAutorizacaoModalidadePagamento.AgLiberacao) > 0)
                    throw new ServicoException("Antes de emitir os documentos é necessária a autorização da modalidade de pagamento da nota, pois existem diferentes modalidades para a mesma carga.");

                string codigoCargaAberto = "";
                bool precisaAutorizacao = false, mdfeEmAberto = false;

                string retornoApolice = serSerguro.VeririficarSeEnecessarioAutorizacaoApolice(carga, unitOfWork, out precisaAutorizacao);

                if (precisaAutorizacao)
                    throw new ServicoException(retornoApolice);

                if (Servicos.Embarcador.Veiculo.Veiculo.VerificarSeEnecessarioAutorizacaoPeso(carga, unitOfWork, out string mensagemAutorizacaoPeso))
                    throw new ServicoException(mensagemAutorizacaoPeso);

                if (Servicos.Embarcador.Frota.OrdemServicoManutencao.VerificarSeEnecessarioAutorizacaoServicoVeiculo(carga, unitOfWork, out string mensagemAutorizacaoServicoVeiculo))
                    throw new ServicoException(mensagemAutorizacaoServicoVeiculo);

                if (cargaPedidos == null)
                    cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo, null, true, configuracaoTMS.RatearFretePedidosAposLiberarEmissaoSemNFe);

                if (!cargaPedidos.Any(o => o.CTeEmitidoNoEmbarcador) && !carga.CargaTransbordo && (configuracaoCargaEmissaoDocumento?.NaoPermitirEmissaoComMesmaOrigemEDestino ?? false) && (carga?.TipoOperacao?.ConfiguracaoEmissaoDocumento?.NaoPermitirEmissaoComMesmaOrigemEDestino ?? false) && serCarga.PossuiMesmaOrigemEDestino(carga, cargaPedidos, unitOfWork))
                    throw new ServicoException("Não é possível prosseguir, pois a carga irá gerar documentos com a mesma origem e destino.");

                if (!cargaPedidos.Any(o => o.CTeEmitidoNoEmbarcador) && serPedidoNotaFiscal.VerificarSeCargaPossuiNotaCanceladaPeloEmitente(carga.Codigo))
                    throw new ServicoException("Existem notas fiscais canceladas pelo emitente na carga, por favor remova as notas cancelada antes de emitir os documentos.");

                if ((configuracaoCargaEmissaoDocumento?.ValidarDataPrevisaoSaidaPedidoMenorDataAtual ?? false) && cargaPedidos.Any(o => !o.Pedido.DataPrevisaoSaida.HasValue || o.Pedido.DataPrevisaoSaida <= DateTime.Now))
                    throw new ServicoException("A data de previsão de saída dos pedidos é menor que a data atual, não sendo possível iniciar a emissão dos documentos.");

                if ((configuracaoCargaEmissaoDocumento?.ValidarDataPrevisaoEntregaPedidoMenorDataAtual ?? false) && cargaPedidos.Any(o => !o.Pedido.PrevisaoEntrega.HasValue || o.Pedido.PrevisaoEntrega <= DateTime.Now))
                    throw new ServicoException("A data de previsão de entrega/retorno dos pedidos é menor que a data atual, não sendo possível iniciar a emissão dos documentos.");

                if (carga.TipoDeCarga != null && carga.TipoDeCarga.ValidarLicencasNCM && carga.TipoDeCarga.TiposLicenca != null && carga.TipoDeCarga.TiposLicenca.Count > 0)
                {
                    StringBuilder mensagemErroLicenca = new StringBuilder();
                    bool possuiPendenciaLicenca = false;

                    Dominio.Entidades.Cliente pessoaTransportador = carga.Empresa != null ? repCliente.BuscarPorCPFCNPJ(carga.Empresa.CNPJ.ToDouble()) : null;
                    foreach (Dominio.Entidades.Embarcador.Configuracoes.Licenca licenca in carga.TipoDeCarga.TiposLicenca)
                    {
                        foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
                        {
                            if (licenca.Tipo == TipoLicenca.Geral || licenca.Tipo == TipoLicenca.Pessoa)
                            {
                                if (cargaPedido.Pedido.Remetente != null && !repPessoaLicenca.ContemLicencaValida(licenca.Codigo, DateTime.Now, cargaPedido.Pedido.Remetente.CPF_CNPJ))
                                {
                                    possuiPendenciaLicenca = true;
                                    mensagemErroLicenca.AppendLine($"O remetente {cargaPedido.Pedido.Remetente.Descricao} não possui a licença {licenca.Descricao} válida.</br>");
                                }
                                if (cargaPedido.Pedido.Destinatario != null && !repPessoaLicenca.ContemLicencaValida(licenca.Codigo, DateTime.Now, cargaPedido.Pedido.Destinatario.CPF_CNPJ))
                                {
                                    possuiPendenciaLicenca = true;
                                    mensagemErroLicenca.AppendLine($"O destinatário {cargaPedido.Pedido.Destinatario.Descricao} não possui a licença {licenca.Descricao} válida.</br>");
                                }
                                if (cargaPedido.Pedido.Recebedor != null && !repPessoaLicenca.ContemLicencaValida(licenca.Codigo, DateTime.Now, cargaPedido.Pedido.Recebedor.CPF_CNPJ))
                                {
                                    possuiPendenciaLicenca = true;
                                    mensagemErroLicenca.AppendLine($"O recebedor {cargaPedido.Pedido.Recebedor.Descricao} não possui a licença {licenca.Descricao} válida.</br>");
                                }
                                if (cargaPedido.Pedido.Expedidor != null && !repPessoaLicenca.ContemLicencaValida(licenca.Codigo, DateTime.Now, cargaPedido.Pedido.Expedidor.CPF_CNPJ))
                                {
                                    possuiPendenciaLicenca = true;
                                    mensagemErroLicenca.AppendLine($"O expedidor {cargaPedido.Pedido.Expedidor.Descricao} não possui a licença {licenca.Descricao} válida.</br>");
                                }
                                if (cargaPedido.ObterTomador() != null && !repPessoaLicenca.ContemLicencaValida(licenca.Codigo, DateTime.Now, cargaPedido.ObterTomador().CPF_CNPJ))
                                {
                                    possuiPendenciaLicenca = true;
                                    mensagemErroLicenca.AppendLine($"O tomador {cargaPedido.ObterTomador().Descricao} não possui a licença {licenca.Descricao} válida.</br>");
                                }
                            }
                        }

                        // feito o codigo preservando o funcionamento anterior (com TipoLicenca.Geral) e adicionando as novas validações
                        if (licenca.Tipo == TipoLicenca.Motorista)
                        {
                            foreach (Dominio.Entidades.Usuario motorista in carga.Motoristas)
                            {
                                if (!repMotoristaLicenca.ContemLicencaValida(licenca.Codigo, DateTime.Now, motorista.CPF))
                                {
                                    possuiPendenciaLicenca = true;
                                    mensagemErroLicenca.AppendLine($"O motorista {motorista.Nome} não possui a licença {licenca.Descricao} válida.</br>");
                                }
                            }
                        }

                        if (licenca.Tipo == TipoLicenca.Veiculo || licenca.Tipo == TipoLicenca.Tracao)
                        {
                            if (carga.Veiculo != null && !repLicencaVeiculo.ContemLicencaValida(licenca.Codigo, DateTime.Now, carga.Veiculo.Codigo))
                            {
                                possuiPendenciaLicenca = true;
                                mensagemErroLicenca.AppendLine($"O veículo {carga.Veiculo.Placa} não possui a licença {licenca.Descricao} válida.</br>");
                            }
                        }

                        if (licenca.Tipo == TipoLicenca.Geral || licenca.Tipo == TipoLicenca.Pessoa)
                        {
                            if (pessoaTransportador != null && !repPessoaLicenca.ContemLicencaValida(licenca.Codigo, DateTime.Now, pessoaTransportador.CPF_CNPJ))
                            {
                                possuiPendenciaLicenca = true;
                                mensagemErroLicenca.AppendLine($"A transportadora {pessoaTransportador.Descricao} não possui a licença {licenca.Descricao} válida.</br>");
                            }
                        }

                        if (licenca.Tipo == TipoLicenca.Reboque)
                        {
                            if (carga.Veiculo.VeiculosVinculados != null
                                && carga.Veiculo.VeiculosVinculados.Any(veiculo => !repLicencaVeiculo.ContemLicencaValida(licenca.Codigo, DateTime.Now, veiculo.Codigo, true))
                                && carga.Veiculo.TipoVeiculo == "1")
                            {
                                possuiPendenciaLicenca = true;
                                mensagemErroLicenca.AppendLine($"O veículo {carga.Veiculo.Placa} não possui a licença {licenca.Descricao} válida.</br>");
                            }

                        }
                    }
                    if (possuiPendenciaLicenca)
                    {
                        if (permissoesPersonalizadas != null && !permissoesPersonalizadas.Contains(AdminMultisoftware.Dominio.Enumeradores.PermissaoPersonalizada.Carga_PermitirLiberarSemLicencaValida))
                            throw new ServicoException(mensagemErroLicenca.ToString());
                        else
                            Servicos.Auditoria.Auditoria.Auditar(auditado, carga, null, $"Operador liberou carga com licenças vinculadas no Tipo da Carga inválidas.", unitOfWork);
                    }

                }

                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
                {
                    Dominio.Entidades.Cliente tomador = cargaPedido.ObterTomador();

                    if (!carga.CargaTakeOrPay && (configuracaoCargaEmissaoDocumento?.BloquearEmissaoTomadorSemEmail ?? false) && !Servicos.Embarcador.Carga.CargaPedido.ValidarEmailTomador(out string erro, tomador))
                        throw new ServicoException(erro);

                    if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS && !carga.EmitirCTeComplementar && !repPedidoXMLNotaFiscal.VerificarSeExistePorCargaPedido(cargaPedido.Codigo))
                        throw new ServicoException($"Não foram encontrados documentos para o pedido {cargaPedido.Pedido.Numero}. Retorne para a etapa anterior e informe os documentos.");

                    if (!Servicos.Embarcador.Carga.CargaPedido.ValidarNumeroPedidoEmbarcador(out erro, cargaPedido.Pedido.NumeroPedidoEmbarcador, tomador, carga.TipoOperacao))
                        throw new ServicoException(erro);

                    if (carga.TipoOperacao != null && carga.TipoOperacao.NaoPermitirAvancarCargaSemRegraICMS && cargaPedido.RegraICMS == null)
                        throw new ServicoException("O tipo de operação exige que a carga possua Regra de ICMS vinculada a esta carga.");

                    if (cargaPedido.Pedido.UsarTipoPagamentoNF)
                    {
                        if (cargaPedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada)
                            throw new ServicoException("Não é permitido buscar a forma de pagamento das notas em um frete de subcontratação.");

                        if ((cargaPedido.TipoTomador != Dominio.Enumeradores.TipoTomador.Outros) && ((cargaPedido.TipoContratacaoCarga == TipoContratacaoCarga.Normal) || (cargaPedido.TipoContratacaoCarga == TipoContratacaoCarga.NormalESubContratada)))
                        {
                            Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscalSemModalidade = repPedidoXMLNotaFiscal.BuscarPrimeroXMLPorCargaPedidoEModalidade(cargaPedido.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalidadePagamentoFrete.NaoDefinido);

                            if (pedidoXMLNotaFiscalSemModalidade != null)
                                throw new ServicoException("As notas fiscais não contém a informação do tipo do pagamento, por isso não é possível utilizar essa opção.");
                        }

                        Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscalOutroPagador = repPedidoXMLNotaFiscal.BuscarPrimeroXMLPorCargaPedidoEModalidade(cargaPedido.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalidadePagamentoFrete.Outros);

                        if (pedidoXMLNotaFiscalOutroPagador != null)
                        {
                            bool outros = true;

                            if (cargaPedido.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.NormalESubContratada)
                            {
                                Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscalNotas = repPedidoXMLNotaFiscal.BuscarPrimeroXMLPorCargaPedidoEModalidadeDiferenciandoTipoNota(cargaPedido.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalidadePagamentoFrete.Outros, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoNotaFiscal.NotaDeSubcontratacao);
                                if (pedidoXMLNotaFiscalNotas == null)
                                    outros = false;
                            }

                            if (outros)
                            {
                                if (cargaPedido.Tomador == null)
                                {
                                    cargaPedido.Pedido.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Outros;

                                    repPedido.Atualizar(cargaPedido.Pedido);

                                    unitOfWork.CommitChanges();

                                    retorno = new
                                    {
                                        RecarregarDadosEmissao = true,
                                        PercursoMDFeValido = false
                                    };

                                    mensagem = "De acordo com as notas fiscais o pagamento será realizado por outro tomador. Por favor, informe o tomador.";

                                    return false;
                                }
                            }
                        }
                    }

                    if (cargaPedido.ModeloDocumentoFiscal != null)
                    {
                        if (cargaPedido.ModeloDocumentoFiscal.TipoDocumentoEmissao != Dominio.Enumeradores.TipoDocumento.CTe)
                        {
                            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete> cargaPedidoComponentesFrete = repCargaPedidoComponentesFrete.BuscarPorCargaPedido(cargaPedido.Codigo, true, cargaPedido.ModeloDocumentoFiscal);
                            if (cargaPedidoComponentesFrete.Count > 0 && cargaPedidoComponentesFrete.Any(obj => obj.ModeloDocumentoFiscal != null && obj.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.CTe))
                                throw new ServicoException("Não é permitido informar um componente para CT-e se a carga não será cobrada por um CT-e, por favor, modifique o tipo de documento dos componentes para outros e tente novamente.");
                        }

                        if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS && !cargaPedido.ModeloDocumentoFiscal.GerarMovimentoAutomatico)
                            throw new ServicoException($"O modelo de documento ({cargaPedido.ModeloDocumentoFiscal.Abreviacao}) não possui configuração de movimento financeiro, não sendo possível iniciar a emissão dos documentos.");
                    }
                    else
                    {
                        Dominio.Entidades.ModeloDocumentoFiscal modeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorTipoDocumento(Dominio.Enumeradores.TipoDocumento.CTe);

                        if (modeloDocumentoFiscal == null)
                            throw new ServicoException($" Não possui modelo de documento fiscal do tipo ({Dominio.Enumeradores.TipoDocumento.CTe.ObterDescricao()}) cadastrado, não sendo possível iniciar a emissão dos documentos.");

                        if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS && !modeloDocumentoFiscal.GerarMovimentoAutomatico)
                            throw new ServicoException($"O modelo de documento ({modeloDocumentoFiscal.Abreviacao}) não possui configuração de movimento financeiro, não sendo possível iniciar a emissão dos documentos.");
                    }

                    if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete> cargaPedidoComponentesFrete = repCargaPedidoComponentesFrete.BuscarPorCargaPedidoQuePossuiModeloDocumentoSemMovimentacaoConfigurada(cargaPedido.Codigo);

                        if (cargaPedidoComponentesFrete.Count > 0)
                        {
                            string descricaoModelos = string.Join(", ", from obj in cargaPedidoComponentesFrete select obj.ModeloDocumentoFiscal.Abreviacao);

                            throw new ServicoException($"Os modelos de documentos '{descricaoModelos}' não possuem configuração de movimento financeiro, não sendo possível iniciar a emissão dos documentos.");
                        }
                    }

                    if (!cargaPedido.PedidoSemNFe && cargaPedido.PossuiNFS && !cargaPedido.CTeEmitidoNoEmbarcador)
                    {
                        Dominio.Entidades.Embarcador.Transportadores.TransportadorConfiguracaoNFSe configNFSe = serNFSe.BuscarConfiguracaoEmissaoNFSe(carga.Empresa.Codigo, cargaPedido.Destino.Codigo, tomador?.Localidade?.Estado?.Sigla ?? "", tomador?.GrupoPessoas?.Codigo ?? 0, tomador?.Localidade?.Codigo ?? 0, carga.TipoOperacao?.Codigo ?? 0, tomador?.CPF_CNPJ ?? 0, 0, unitOfWork);

                        if (configNFSe == null)
                            throw new ServicoException($"O transportador informado não está apto a emitir notas fiscais de serviço em {cargaPedido.Destino.DescricaoCidadeEstado}.");
                        else if (carga.PendenciaEmissaoAutomatica)
                            throw new ServicoException("Antes de liberar a carga para emissão é necessário recalcular seu frete, pois as regras para geração de NFS-e foram configuradas recentemente para esse transportador.");
                    }


                    //Configuracao utilizada pela ARCELOR onde, ao emitir documentos, os pedidos são removidos da montagem e caso existir carga origem dos pedidos, essa carga tambem deve ser removida (carga fechada = 0)
                    if (carga.TipoOperacao?.ConfiguracaoMontagemCarga?.ExibirPedidosMontagemIntegracao ?? false)
                    {
                        Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntrega repCargaEntrega = new Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntrega(unitOfWork);

                        cargaPedido.Pedido.PedidoTotalmenteCarregado = true;
                        repPedido.Atualizar(cargaPedido.Pedido);

                        //encontrar a carga origem para remover da lista de cargas
                        Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntrega cargaEntrega = repCargaEntrega.BuscarPrimeiroPorCarga(carga.Codigo);
                        if (cargaEntrega?.CargaOrigem != null)
                        {
                            cargaEntrega.CargaOrigem.CargaFechada = false;
                            repCarga.Atualizar(cargaEntrega.CargaOrigem);
                        }
                    }


                    //#64867 - PAM - Quando o tipo de operação permite montagem de carga no segundo trecho,
                    // a carga possuir um recebedor informado e o recebedor for um transportador,
                    // os pedidos devem ser definidos como TotalmenteCarregado = false para o transportador poder montar a carga de segundo treco no portal do transportador
                    if ((carga.TipoOperacao?.ConfiguracaoTransportador?.PermitirTransportadorAjusteCargaSegundoTrecho ?? false) && cargaPedido.Recebedor != null)
                    {
                        Dominio.Entidades.Empresa transportadorRecebedor = repositorioEmpresa.BuscarPorCNPJ(cargaPedido.Recebedor.CPF_CNPJ_SemFormato);

                        if (transportadorRecebedor != null)
                        {
                            cargaPedido.Pedido.Initialize();
                            cargaPedido.Pedido.PedidoTotalmenteCarregado = false;
                            cargaPedido.Pedido.Empresa = transportadorRecebedor;
                            cargaPedido.Pedido.GerarAutomaticamenteCargaDoPedido = false;
                            cargaPedido.Pedido.Recebedor = null;
                            cargaPedido.Pedido.NotasFiscais = repXMLNotaFiscal.BuscarXMLNotaFiscalPorCargaPedido(cargaPedido.Codigo);  //cargaPedido.NotasFiscais.Select(o => o.XMLNotaFiscal).ToList();
                            List<Dominio.Entidades.Auditoria.HistoricoPropriedade> alteracoes = cargaPedido.Pedido.GetChanges();
                            Servicos.Auditoria.Auditoria.Auditar(auditado, cargaPedido.Pedido, alteracoes, $"Pedido alterado para permitir montagem da carga de segundo trecho.", unitOfWork);
                            repPedido.Atualizar(cargaPedido.Pedido);
                        }
                    }
                }

                if (!cargaPedidos.Any(o => o.CTeEmitidoNoEmbarcador) && !carga.NaoGerarMDFe && (carga.Filial == null || !carga.Filial.EmitirMDFeManualmente) && (carga.TipoOperacao == null || !carga.TipoOperacao.NaoEmitirMDFe) && carga.Veiculo != null && cargaPedidos.Any(obj => obj.Pedido.SituacaoPedido == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoPedido.Aberto))
                {
                    List<Dominio.Entidades.Embarcador.Cargas.CargaMDFe> cargasMDFe = repCargaMDFe.BuscarPorCargaVeiculosMDFeNaoEncerrados(carga.Veiculo.Placa);

                    foreach (Dominio.Entidades.Embarcador.Cargas.CargaMDFe cargaMDFe in cargasMDFe)
                    {
                        if (cargaMDFe.Carga.Codigo != carga.Codigo)
                        {
                            if (cargaMDFe.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Autorizado && cargaMDFe.SistemaEmissor == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SistemaEmissor.MultiCTe)
                            {
                                if (!configuracaoTMS.EncerrarMDFesDeOutrasViagensAutomaticamente || (cargaMDFe.Carga.TipoOperacao?.EncerrarMDFeManualmente ?? false))
                                {
                                    mdfeEmAberto = true;
                                    codigoCargaAberto = cargaMDFe.Carga.RetornarCodigoCargaParaVisualizacao.ToString();
                                    break;
                                }
                                else
                                {
                                    Servicos.Auditoria.Auditoria.Auditar(auditado, cargaMDFe.Carga, null, $"Solicitou o encerramento do MDF-e, ao confirmar a placa na carga {carga.CodigoCargaEmbarcador}.", unitOfWork);
                                    serCarga.SolicitarEncerramentoMDFeAutomaticamente(cargaMDFe.Carga, unitOfWork, tipoServicoMultisoftware, webServiceConsultaCTe, auditado, usuario);
                                }
                            }
                        }
                    }
                }

                bool subcontratada = false;

                if (carga.Pedidos.All(obj => obj.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada || obj.TipoContratacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMTerceiro))
                    subcontratada = true;

                if (!mdfeEmAberto || subcontratada)
                {
                    if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete)
                    {
                        if (!carga.PossuiPendencia)
                        {
                            Servicos.Embarcador.Carga.CargaLocaisPrestacao serCargaLocaisPrestacao = new Servicos.Embarcador.Carga.CargaLocaisPrestacao(unitOfWork);

                            if (cargaPedidos.Any(o => !o.CTeEmitidoNoEmbarcador && o.Pedido.SituacaoPedido != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoPedido.Finalizado) &&
                                !carga.NaoGerarMDFe &&
                                (carga.TipoOperacao == null || !carga.TipoOperacao.NaoEmitirMDFe) &&
                                (!subcontratada && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS) &&
                                !serCargaLocaisPrestacao.ValidarPassagensMDFe(carga, unitOfWork))
                            {
                                {
                                    unitOfWork.Rollback();

                                    retorno = new
                                    {
                                        RecarregarDadosEmissao = false,
                                        PercursoMDFeValido = false
                                    };

                                    mensagem = "";
                                    return false;
                                }
                            }
                            else
                            {
                                if (cargaPedidos.Any(o => !o.CTeEmitidoNoEmbarcador && o.Pedido.SituacaoPedido != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoPedido.Finalizado) && !carga.NaoGerarMDFe && Servicos.Embarcador.Carga.Carga.VerificarSePossuiEDIFiscal(carga, subcontratada, unitOfWork) && !repCargaLacre.ExistePorCarga(carga.Codigo))
                                    throw new ServicoException("A carga possui passagem pelo Mato Grosso, sendo obrigatória a informação do lacre.");

                                List<Dominio.Entidades.Embarcador.Cargas.CargaFreteIntegracao> possuiIntegracao = repositorioCargaFreteIntegracao.ExisteIntegracoesCargaFreteParaEstaCarga(carga.Codigo);
                                if ((carga.AguardandoIntegracaoFrete || carga.PendenciaIntegracaoFrete || (possuiIntegracao != null && possuiIntegracao.Count > 0)) && !((carga?.LiberadaComPendenciaIntegracaoFrete) ?? false))
                                    throw new ServicoException("Não poder ser avançada a etapa porque tem integrações pendentes ou com falhas.");

                                if ((carga.TipoOperacao?.EmiteCTeFilialEmissora ?? false) && carga.UtilizarCTesAnterioresComoCTeFilialEmissora)
                                {
                                    carga.EmEmissaoCTeSubContratacaoFilialEmissora = false;
                                    carga.SituacaoCarga = SituacaoCarga.PendeciaDocumentos;
                                    repCargaPedido.InformarCTesEmitidos(carga.Codigo);
                                }

                                carga.DataInicioEmissaoDocumentos = DateTime.Now;
                                carga.DataEnvioUltimaNFe = DateTime.Now;
                                carga.problemaAverbacaoCTe = false;
                                carga.LiberadaEtapaFaturamentoBloqueada = etapaFaturamentoBloqueada;
                                carga.CTesEmDigitacao = !serCTe.VerificarSePodeEmitirAutomaticamente(tipoServicoMultisoftware, carga, configuracaoTMS.AtivarAutorizacaoAutomaticaDeTodasCargas);
                                carga.DataInicioGeracaoCTes = DateTime.Now;
                                AlterarStatusCustoExtra(carga, TipoDirecionamentoCustoExtra.Faturar);

                                repCarga.Atualizar(carga);

                                Servicos.Auditoria.Auditoria.Auditar(auditado, carga, null, $"Confirmou o valor do frete {(etapaFaturamentoBloqueada ? " sem a etapa de faturamento estar liberada" : "")}.", unitOfWork);

                                Servicos.Embarcador.Carga.CargaDatas servicoCargaDatas = new CargaDatas(configuracaoTMS, unitOfWork);
                                servicoCargaDatas.SalvarDataConfirmacaoValorFrete(carga);

                                if (carga.TipoOperacao != null && carga.TipoOperacao.TipoConsolidacao == EnumTipoConsolidacao.AutorizacaoEmissao)
                                    serCarga.AutorizarGeracaoCargaStageAgrupamento(carga, unitOfWork);

                                //ao confirmar o frete da carga filho, vamos emitir o documento da carga pai. (isso fara a emissao dos documentos dos carga pedidos com notas ainda nao emitidos ctes)
                                if (carga.DadosSumarizados?.CargaTrecho == CargaTrechoSumarizada.SubCarga)
                                    EmitirDocumentosParciaisNotaPreCheckin(carga, tipoServicoMultisoftware, configuracaoTMS, unitOfWork);

                                GerarAtendimentoDivergenciaValorFreteCTeEmitidoEmbarcador(carga, unitOfWork);

                                unitOfWork.CommitChanges();

                                return true;
                            }
                        }
                        else
                            throw new ServicoException("Não é possível iniciar a emissão pois existem pendências no calculo do Frete");
                    }
                    else
                        throw new ServicoException($"A atual situação da carga ({carga.DescricaoSituacaoCarga}) não permite iniciar a emissão dos documentos.");
                }
                else
                    throw new ServicoException($"Não é possível iniciar a emissão pois o veículo está alocado em uma carga em que o MDF-e ainda não foi encerrado (carga: {codigoCargaAberto}), por favor verifique.");
            }
            catch (ServicoException exception)
            {
                Servicos.Log.TratarErro(mensagem, "IniciarEmissaoDocumentosCarga");

                unitOfWork.Rollback();

                mensagem = exception.Message;
                Servicos.Log.TratarErro("EX: " + mensagem, "IniciarEmissaoDocumentosCarga");

                return false;
            }
            catch
            {
                throw;
            }
        }
        public void GerarOperacaoContainer(ref Dominio.Entidades.Embarcador.Cargas.Carga carga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Repositorio.UnitOfWork unitOfWork)
        {
            if ((carga.TipoOperacao?.ConfiguracaoContainer?.GestaoViagemContainerFluxoUnico ?? false) && PermitirEmitirCTe(carga, configuracaoTMS))
            {
                Repositorio.Embarcador.Cargas.ComprovanteCarga.ComprovanteCarga repComprovante = new Repositorio.Embarcador.Cargas.ComprovanteCarga.ComprovanteCarga(unitOfWork);
                Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
                Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio repCargaIntegracaoValePedagio = new Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio(unitOfWork);
                Servicos.Embarcador.Carga.CTe serCargaCTe = new Servicos.Embarcador.Carga.CTe(unitOfWork);
                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosNaoEmitidos = (from obj in cargaPedidos where !obj.CTesEmitidos select obj).ToList();
                Servicos.Embarcador.Carga.Documentos svcDocumentos = new Servicos.Embarcador.Carga.Documentos(unitOfWork);

                carga.PossuiOperacaoContainer = true;
                carga.RealizandoOperacaoContainer = true;
                carga.SituacaoCarga = SituacaoCarga.PendeciaDocumentos;

                string retorno = serCargaCTe.EmitirCTE(cargaPedidosNaoEmitidos, carga, unitOfWork, tipoServicoMultisoftware, null, 0);

                if ((carga.TipoOperacao?.ConfiguracaoContainer?.ComprarValePedagioEtapaContainer ?? false))
                {
                    Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota.CriarCargaValePedagioPorRotaFrete(carga, cargaPedidos, configuracaoTMS, unitOfWork, tipoServicoMultisoftware);
                    List<Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio> listaCargaPedagio = repCargaIntegracaoValePedagio.BuscarPorCarga(carga.Codigo);
                    foreach (var item in listaCargaPedagio)
                    {
                        item.OperacaoContainer = true;
                        repCargaIntegracaoValePedagio.Atualizar(item);
                    }
                }

                if ((carga.TipoOperacao?.ConfiguracaoContainer?.ExigirComprovanteColetaContainerParaSeguir ?? false))
                {
                    if (carga.TipoOperacao?.ConfiguracaoContainer?.TipoComprovanteColetaContainer != null)
                    {
                        svcDocumentos.GerarComprovantesContainerCarga(carga, carga.TipoOperacao?.ConfiguracaoContainer?.TipoComprovanteColetaContainer, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoComprovanteCarga.Pendente, unitOfWork);
                    }
                }
            }
            else
            {
                carga.PossuiOperacaoContainer = false;
                carga.RealizandoOperacaoContainer = false;
            }

        }
        public static void TrocarCarga(Dominio.Entidades.Embarcador.Cargas.Carga cargaAtual, Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, AdminMultisoftware.Dominio.Entidades.Pessoas.Cliente ClienteMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, Repositorio.UnitOfWork unitOfWork, bool trocarCargaAgrupada)
        {
            Auditoria.Auditoria.TrocarAuditoria(cargaAtual, cargaNova, unitOfWork);
            new GestaoPatio.FluxoGestaoPatio(unitOfWork).TrocarCarga(cargaAtual, cargaNova);
            new Logistica.CargaJanelaCarregamento(unitOfWork).TrocarCarga(cargaAtual, cargaNova, tipoServicoMultisoftware);
            new Logistica.CargaJanelaDescarregamento(unitOfWork).TrocarCarga(cargaAtual, cargaNova);
            new Logistica.FilaCarregamentoVeiculo(unitOfWork, OrigemAlteracaoFilaCarregamento.Sistema).TrocarCarga(cargaAtual, cargaNova);
            new Pedido.ColetaContainer(unitOfWork).TrocarCarga(cargaAtual, cargaNova);
            new Pedido.ConferenciaContainer(unitOfWork).TrocarCarga(cargaAtual, cargaNova);

            if (trocarCargaAgrupada)
                new CargaAgrupada(unitOfWork).TrocarCarga(cargaAtual, cargaNova, tipoServicoMultisoftware, ClienteMultisoftware);

            Integracao.IntegracaoCarga.TrocarCarga(cargaAtual, cargaNova, tipoServicoMultisoftware, unitOfWork);
            Monitoramento.Monitoramento.TrocarCarga(cargaAtual, cargaNova, "Troca de pré-carga", configuracaoEmbarcador, unitOfWork);

            cargaAtual.CargaFechada = false;
            cargaNova.EtapaFaturamentoLiberado = cargaAtual.EtapaFaturamentoLiberado;
            cargaNova.NumeroDoca = cargaAtual.NumeroDoca;
            cargaNova.NumeroDocaEncosta = cargaAtual.NumeroDocaEncosta;
            cargaNova.OcultarNoPatio = cargaAtual.OcultarNoPatio;
            cargaNova.DataInicioViagemPrevista = cargaAtual.DataInicioViagemPrevista;
            cargaNova.DataFimViagemPrevista = cargaAtual.DataFimViagemPrevista;

            if (cargaAtual.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Concluido)
            {
                cargaNova.SituacaoRoteirizacaoCarga = SituacaoRoteirizacao.Concluido;
                ControleEntrega.ControleEntrega.TrocarCarga(cargaAtual, cargaNova, tipoServicoMultisoftware, configuracaoEmbarcador, unitOfWork);
                CargaRotaFrete.TrocarCarga(cargaAtual, cargaNova, tipoServicoMultisoftware, configuracaoEmbarcador, unitOfWork);
            }

            new Repositorio.Embarcador.Cargas.Carga(unitOfWork).Atualizar(cargaAtual);
        }
        public async static Task TrocarCargaAsync(Dominio.Entidades.Embarcador.Cargas.Carga cargaAtual, Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, AdminMultisoftware.Dominio.Entidades.Pessoas.Cliente ClienteMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, Repositorio.UnitOfWork unitOfWork, bool trocarCargaAgrupada)
        {
            Auditoria.Auditoria.TrocarAuditoria(cargaAtual, cargaNova, unitOfWork);
            new GestaoPatio.FluxoGestaoPatio(unitOfWork).TrocarCarga(cargaAtual, cargaNova);
            new Logistica.CargaJanelaCarregamento(unitOfWork).TrocarCarga(cargaAtual, cargaNova, tipoServicoMultisoftware);
            new Logistica.CargaJanelaDescarregamento(unitOfWork).TrocarCarga(cargaAtual, cargaNova);
            new Logistica.FilaCarregamentoVeiculo(unitOfWork, OrigemAlteracaoFilaCarregamento.Sistema).TrocarCarga(cargaAtual, cargaNova);
            new Pedido.ColetaContainer(unitOfWork).TrocarCarga(cargaAtual, cargaNova);
            new Pedido.ConferenciaContainer(unitOfWork).TrocarCarga(cargaAtual, cargaNova);

            if (trocarCargaAgrupada)
                new CargaAgrupada(unitOfWork).TrocarCarga(cargaAtual, cargaNova, tipoServicoMultisoftware, ClienteMultisoftware);

            Integracao.IntegracaoCarga.TrocarCarga(cargaAtual, cargaNova, tipoServicoMultisoftware, unitOfWork);
            Monitoramento.Monitoramento.TrocarCarga(cargaAtual, cargaNova, "Troca de pré-carga", configuracaoEmbarcador, unitOfWork);

            cargaAtual.CargaFechada = false;
            cargaNova.EtapaFaturamentoLiberado = cargaAtual.EtapaFaturamentoLiberado;
            cargaNova.NumeroDoca = cargaAtual.NumeroDoca;
            cargaNova.NumeroDocaEncosta = cargaAtual.NumeroDocaEncosta;
            cargaNova.OcultarNoPatio = cargaAtual.OcultarNoPatio;
            cargaNova.DataInicioViagemPrevista = cargaAtual.DataInicioViagemPrevista;
            cargaNova.DataFimViagemPrevista = cargaAtual.DataFimViagemPrevista;

            if (cargaAtual.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Concluido)
            {
                cargaNova.SituacaoRoteirizacaoCarga = SituacaoRoteirizacao.Concluido;
                ControleEntrega.ControleEntrega.TrocarCarga(cargaAtual, cargaNova, tipoServicoMultisoftware, configuracaoEmbarcador, unitOfWork);
                CargaRotaFrete.TrocarCarga(cargaAtual, cargaNova, tipoServicoMultisoftware, configuracaoEmbarcador, unitOfWork);
            }

            await new Repositorio.Embarcador.Cargas.Carga(unitOfWork).AtualizarAsync(cargaAtual);
        }
        public static bool IsCargaBloqueada(Dominio.Entidades.Embarcador.Cargas.Carga carga, UnitOfWork unitOfWork)
        {
            Servicos.Embarcador.Carga.MensagemAlertaCarga servicoMensagemAlerta = new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork);

            return servicoMensagemAlerta.IsBloquearEntidade(carga.Codigo);
        }

        public static bool IsCargaComClienteSemLocalidade(Dominio.Entidades.Embarcador.Cargas.Carga carga, UnitOfWork unitOfWork)
        {
            Servicos.Embarcador.Carga.MensagemAlertaCarga servicoMensagemAlerta = new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork);

            return servicoMensagemAlerta.IsMensagemSemConfirmacao(carga, TipoMensagemAlerta.ClienteSemLocalidade);
        }

        /// <summary>
        /// Verifica se essa carga tem alguma pendência de produtos, já que ela deve ter pelo menos um
        /// </summary>
        public static bool IsCargaComPedidosSemProdutos(Dominio.Entidades.Embarcador.Cargas.Carga carga, UnitOfWork unitOfWork)
        {
            Servicos.Embarcador.Carga.MensagemAlertaCarga servicoMensagemAlerta = new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork);

            return servicoMensagemAlerta.IsMensagemSemConfirmacao(carga, TipoMensagemAlerta.CargaSemProdutos);
        }

        public static bool ConfirmarCargaComClienteSemLocalidade(Dominio.Entidades.Embarcador.Cargas.Carga carga, UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);

            string codigoLocalidadeNaoCadastrada = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoAmbiente()?.CodigoLocalidadeNaoCadastrada ?? string.Empty;

            if (string.IsNullOrWhiteSpace(codigoLocalidadeNaoCadastrada) || repositorioCargaPedido.PossuiPedidoComClienteSemLocalidade(carga.Codigo, codigoLocalidadeNaoCadastrada.ToInt()))
                return false;

            new MensagemAlertaCarga(unitOfWork).Confirmar(carga, TipoMensagemAlerta.ClienteSemLocalidade);
            Servicos.Embarcador.Carga.CargaPedido.AtualizarLocalidadesCargaPedido(carga, unitOfWork);

            return true;
        }

        public void AtualizarDataEstufagemDadosTransporteMaritimo(Dominio.Entidades.Embarcador.Cargas.Carga carga, UnitOfWork unitOfWork, bool estaAdicionandoCarga)
        {
            if (carga == null)
                return;

            if (!carga.DataCarregamentoCarga.HasValue)
                return;

            Servicos.Embarcador.Integracao.Marfrig.IntegracaoPedidoDadosTransporteMaritimo servIntegracaoPedidoDadosTransporteMaritimo = new Servicos.Embarcador.Integracao.Marfrig.IntegracaoPedidoDadosTransporteMaritimo(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoDadosTransporteMaritimo repositorioPedidoDadosTransporteMaritimo = new Repositorio.Embarcador.Pedidos.PedidoDadosTransporteMaritimo(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);

            if (!repositorioPedidoDadosTransporteMaritimo.ExistePedidoDadosTransporteMaritimo())
                return;

            repositorioPedidoDadosTransporteMaritimo.InformarDataEstufagemDadosTransporteMaritimoSQL(carga.DataCarregamentoCarga.Value, carga.Codigo);

            if (!estaAdicionandoCarga)
            {
                //para cada dadostransporteMaritimo dos pedidos da carga gerar integracao do booking.
                List<int> pedidosCarga = repPedido.BuscarCodigosPedidosPorCarga(carga.Codigo);
                List<Dominio.Entidades.Embarcador.Pedidos.PedidoDadosTransporteMaritimo> listaBookings = repositorioPedidoDadosTransporteMaritimo.BuscarPorPedidos(pedidosCarga);

                foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoDadosTransporteMaritimo booking in listaBookings)
                {
                    Dominio.Entidades.Embarcador.Pedidos.PedidoDadosTransporteMaritimo dadosTransporteMaritimoClonado = booking.Clonar();
                    dadosTransporteMaritimoClonado.DataPrevisaoEstufagem = carga.DataCarregamentoCarga.Value;

                    dadosTransporteMaritimoClonado.CodigoOriginal = booking.Codigo;
                    dadosTransporteMaritimoClonado.BookingTemporario = true;

                    repositorioPedidoDadosTransporteMaritimo.Inserir(dadosTransporteMaritimoClonado);
                    servIntegracaoPedidoDadosTransporteMaritimo.AdicionarPedidoDadosTransporteMaritimoIntegracao(dadosTransporteMaritimoClonado);
                }
            }
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga GerarCargaPorStageAgrupadaDT(Dominio.Entidades.Embarcador.Cargas.Carga cargaDT, Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento agrupamentoStage, List<Dominio.Entidades.Embarcador.Pedidos.Stage> stagesdoAgrupamento, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado)
        {
            Servicos.Log.TratarErro("Iniciou Geracao Carga Stage DT: " + cargaDT.CodigoCargaEmbarcador + " em " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "CargaPorStageAgrupada");

            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.StageAgrupamento repStageAgrupado = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoStage repPedidoStage = new Repositorio.Embarcador.Pedidos.PedidoStage(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoProduto repCargaPedidoProduto = new Repositorio.Embarcador.Cargas.CargaPedidoProduto(unitOfWork);

            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe repCargaPedidoXMLNotaFiscalCTe = new Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe(unitOfWork);
            Repositorio.Embarcador.Financeiro.DocumentoFaturamento repDocumentoFaturamento = new Repositorio.Embarcador.Financeiro.DocumentoFaturamento(unitOfWork);
            Repositorio.Embarcador.Veiculos.VeiculoMotorista repVeiculoMotorista = new Repositorio.Embarcador.Veiculos.VeiculoMotorista(unitOfWork);

            Servicos.Embarcador.Carga.Carga serCarga = new Embarcador.Carga.Carga(unitOfWork);
            Servicos.Embarcador.Carga.CargaDadosSumarizados serCargaDadosSumarizados = new Servicos.Embarcador.Carga.CargaDadosSumarizados(unitOfWork);
            Servicos.Embarcador.Carga.CargaMotorista servicoCargaMotorista = new Servicos.Embarcador.Carga.CargaMotorista(unitOfWork);
            Servicos.Embarcador.Carga.CargaPedido serCargaPedido = new Servicos.Embarcador.Carga.CargaPedido(unitOfWork);
            Servicos.Embarcador.Pedido.NotaFiscal serCargaNotaFiscal = new Servicos.Embarcador.Pedido.NotaFiscal(unitOfWork);

            Random rnd = new Random();

            List<int> codigosCargaPedidoLiberarPagamento = new List<int>();
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoStage> pedidosStage = repPedidoStage.BuscarPedidoStages(stagesdoAgrupamento.Select(x => x.Codigo).ToList());

            List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos = pedidosStage.Select(obj => obj.Pedido).Distinct().ToList();

            Dominio.Entidades.Embarcador.Filiais.Filial filial = pedidos?.FirstOrDefault()?.Filial != null ? pedidos.FirstOrDefault().Filial : cargaDT.Filial;
            Dominio.Entidades.Embarcador.Filiais.Filial filialOrigem = cargaDT.FilialOrigem;

            Servicos.Log.TratarErro("Iniciou Criar Carga" + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "CargaPorStageAgrupada");

            Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipOperacaoCargaFilho = cargaDT.TipoOperacao?.TipoOperacaoPrecheckinTransferencia ?? cargaDT.TipoOperacao;

            if (cargaDT.TipoOperacao?.TipoConsolidacao == EnumTipoConsolidacao.PreCheckIn && stagesdoAgrupamento.Any(x => x.TipoPercurso == Vazio.PercursoPreliminar))
                tipOperacaoCargaFilho = cargaDT.TipoOperacao?.TipoOperacaoPrecheckin ?? cargaDT.TipoOperacao;

            Dominio.Entidades.Embarcador.Cargas.Carga novaCarga = new Dominio.Entidades.Embarcador.Cargas.Carga()
            {
                AgConfirmacaoUtilizacaoCredito = cargaDT.AgConfirmacaoUtilizacaoCredito,

                AgImportacaoCTe = false,
                AgImportacaoMDFe = false,
                AguardandoEmissaoDocumentoAnterior = false,
                AutorizouTodosCTes = false,
                CargaCancelamento = cargaDT.CargaCancelamento,
                CargaFechada = true,
                CargaIntegradaEmbarcador = cargaDT.CargaIntegradaEmbarcador,
                CargaTransbordo = false,
                CalcularFreteLote = cargaDT.CalcularFreteLote,
                ControleNumeracao = rnd.Next(),
                CodigoCargaEmbarcador = cargaDT.CodigoCargaEmbarcador,
                ControlaTempoParaEmissao = cargaDT.ControlaTempoParaEmissao,
                DataCarregamentoCarga = cargaDT.DataCarregamentoCarga,
                DataEnvioUltimaNFe = cargaDT.DataEnvioUltimaNFe.HasValue ? System.DateTime.Now : cargaDT.DataEnvioUltimaNFe,
                DataFinalPrevisaoCarregamento = cargaDT.DataFinalPrevisaoCarregamento,
                DataInicialPrevisaoCarregamento = cargaDT.DataInicialPrevisaoCarregamento,
                DataPrevisaoTerminoCarga = cargaDT.DataPrevisaoTerminoCarga,
                Distancia = stagesdoAgrupamento.Sum(x => x.Distancia),
                Empresa = cargaDT.Empresa,
                ExigeNotaFiscalParaCalcularFrete = tipOperacaoCargaFilho.ExigeNotaFiscalParaCalcularFrete,
                Filial = filial,
                FilialOrigem = filialOrigem,
                FreteDeTerceiro = cargaDT.FreteDeTerceiro,
                GrupoPessoaPrincipal = cargaDT.GrupoPessoaPrincipal,
                MotivoPendencia = cargaDT.MotivoPendencia,
                MotivoPendenciaFrete = cargaDT.MotivoPendenciaFrete,
                NaoExigeVeiculoParaEmissao = tipOperacaoCargaFilho.NaoExigeVeiculoParaEmissao,
                Operador = cargaDT.Operador,
                PossuiPendencia = cargaDT.PossuiPendencia,
                PrioridadeEnvioIntegracao = cargaDT.PrioridadeEnvioIntegracao,
                problemaCTE = cargaDT.problemaCTE,
                problemaAverbacaoCTe = cargaDT.problemaAverbacaoCTe,
                problemaMDFe = cargaDT.problemaMDFe,
                NaoGerarMDFe = tipOperacaoCargaFilho.NaoEmitirMDFe,
                problemaNFS = cargaDT.problemaNFS,
                Rota = cargaDT.Rota,
                OrdemRoteirizacaoDefinida = true,
                SegmentoGrupoPessoas = cargaDT.SegmentoGrupoPessoas,
                SegmentoModeloVeicularCarga = cargaDT.SegmentoModeloVeicularCarga,
                SituacaoCarga = SituacaoCarga.Nova,
                TabelaFrete = cargaDT.TabelaFrete,
                TipoDeCarga = cargaDT.TipoDeCarga,
                TipoFreteEscolhido = TipoFreteEscolhido.Tabela,
                TipoOperacao = tipOperacaoCargaFilho,
                ValorFrete = agrupamentoStage.ValorFreteTotal,
                ValorFreteAPagar = 0,
                ValorFreteEmbarcador = 0,
                ValorFreteLeilao = 0,
                ValorFreteLiquido = 0,
                ValorFreteOperador = 0,
                ValorFreteTabelaFrete = 0,
                ValorICMS = 0,
                ValorISS = 0,
                ValorRetencaoISS = 0m,
                VeiculoIntegradoEmbarcador = cargaDT.VeiculoIntegradoEmbarcador,
                Veiculo = agrupamentoStage.Veiculo,
                LiberadaParaEmissaoCTeSubContratacaoFilialEmissora = false,
                EmpresaFilialEmissora = null,
                Redespacho = null,
                ModeloVeicularCarga = stagesdoAgrupamento.FirstOrDefault()?.ModeloVeicularCarga ?? cargaDT.ModeloVeicularCarga,
                TipoDocumentoTransporte = cargaDT.TipoDocumentoTransporte
            };

            bool aguardandoEmissaoDocumentoAnterior = false;

            if (novaCarga.VeiculosVinculados == null)
                novaCarga.VeiculosVinculados = new List<Dominio.Entidades.Veiculo>();

            if (agrupamentoStage.Reboque != null)
                novaCarga.VeiculosVinculados.Add(agrupamentoStage.Reboque);

            if (agrupamentoStage.SegundoReboque != null)
                novaCarga.VeiculosVinculados.Add(agrupamentoStage.SegundoReboque);

            repCarga.Inserir(novaCarga);

            // Replicar as fronteiras da carga antiga pra nova
            Repositorio.Embarcador.Cargas.CargaFronteira repCargaFronteira = new Repositorio.Embarcador.Cargas.CargaFronteira(unitOfWork);
            CargaFronteira serCargaFronteira = new Servicos.Embarcador.Carga.CargaFronteira(unitOfWork);
            List<Dominio.Entidades.Embarcador.Cargas.CargaFronteira> fronteirascargaDT = serCargaFronteira.ObterFronteirasPorCarga(cargaDT);
            repCargaFronteira.CopiarFronteirasParaCarga(fronteirascargaDT, novaCarga);

            if (agrupamentoStage.Motorista != null)
                servicoCargaMotorista.AdicionarMotorista(novaCarga, agrupamentoStage.Motorista);

            Servicos.Log.TratarErro("7 - Fechou Carga (" + novaCarga.Codigo + ") " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "CargaPorStageAgrupada");

            novaCarga.Protocolo = novaCarga.Codigo;

            Servicos.Log.TratarErro("Finalizou Criar Carga" + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "CargaPorStageAgrupada");


            string retorno = serCarga.CriarCargaPedidosPorPedidos(ref novaCarga, pedidos, tipoServicoMultisoftware, null, unitOfWork, configuracaoTMS, auditado, false, NumeroReboque.SemReboque, TipoCarregamentoPedido.Normal, null, false, pedidosStage);

            //as notas estao no cargaPedido da DT. por isso precisamos buscar o cargaPedido dos pedidos e da DT e repassar para o cargaPedido da carga nova.
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosCargaNova = repCargaPedido.BuscarPorCarga(novaCarga.Codigo);
            foreach (Dominio.Entidades.Embarcador.Pedidos.Pedido pedido in pedidos)
            {
                // encontrar o cargaPedido de cada pedido do agrupamento
                Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoDt = repCargaPedido.BuscarPorCargaEPedido(cargaDT.Codigo, pedido.Codigo);
                if (cargaPedidoDt != null && cargaPedidoDt.NotasFiscais?.Count > 0)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo = cargaPedidosCargaNova.Where(x => x.Pedido.Codigo == pedido.Codigo).FirstOrDefault();
                    if (cargaPedidoNovo != null)
                    {
                        foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal notaFiscal in cargaPedidoDt.NotasFiscais)
                        {
                            bool alteradoTipoCarga = false;
                            serCargaNotaFiscal.InserirNotaCargaPedido(notaFiscal.XMLNotaFiscal, cargaPedidoNovo, tipoServicoMultisoftware, TipoNotaFiscal.Venda, configuracaoTMS, false, out alteradoTipoCarga);
                        }
                    }
                }
            }

            if (cargaDT.TipoOperacao?.TipoConsolidacao != EnumTipoConsolidacao.PreCheckIn)
            {
                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidosCargaNova)
                {
                    cargaPedido.CTesEmitidos = true;
                    cargaPedido.PedidoSemNFe = true;
                    repCargaPedido.Atualizar(cargaPedido);
                }
            }

            if (!string.IsNullOrWhiteSpace(retorno))
                throw new ServicoException(retorno);

            agrupamentoStage.Processado = false;
            repStageAgrupado.Atualizar(agrupamentoStage);

            if (configuracaoTMS.GerarPagamentoBloqueado && codigosCargaPedidoLiberarPagamento.Count > 0)
            {
                List<int> ctes = repCargaPedidoXMLNotaFiscalCTe.BuscarCodigosCTePorCargaPedidos(codigosCargaPedidoLiberarPagamento);
                if (ctes.Count > 0)
                    repDocumentoFaturamento.LiberarPagamentosPorCTes(ctes, DateTime.Now);
            }

            if ((serCarga.VerificarSeCargaEstaNaLogistica(cargaDT, tipoServicoMultisoftware) ||
                cargaDT.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe ||
                cargaDT.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.PendeciaDocumentos) && aguardandoEmissaoDocumentoAnterior)
            {
                novaCarga.AguardandoEmissaoDocumentoAnterior = true;
                repCarga.Atualizar(novaCarga);
            }

            if (configuracaoTMS.SistemaIntegracaoPadraoCarga > 0)
            {
                Servicos.Embarcador.Integracao.IntegracaoCarga serIntegracaoCarga = new Embarcador.Integracao.IntegracaoCarga(unitOfWork);
                serIntegracaoCarga.InformarIntegracaoCarga(novaCarga, configuracaoTMS.SistemaIntegracaoPadraoCarga, unitOfWork);
            }

            Servicos.Log.TratarErro("Iniciou Alterar Dados Sumarizados" + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "CargaPorStageAgrupada");

            serCargaDadosSumarizados.AlterarDadosSumarizadosCarga(ref novaCarga, cargaPedidosCargaNova, configuracaoTMS, unitOfWork, tipoServicoMultisoftware);

            novaCarga.DadosSumarizados.CargaTrecho = CargaTrechoSumarizada.SubCarga;

            Servicos.Embarcador.Carga.Carga svcCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);

            Servicos.Log.TratarErro("Iniciou Fechar Carga" + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "CargaPorStageAgrupada");

            svcCarga.FecharCarga(novaCarga, unitOfWork, tipoServicoMultisoftware, ClienteMultisoftware: null, recriarRotas: true);

            Servicos.Log.TratarErro("Finalizou Fechar Carga" + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "CargaPorStageAgrupada");

            return novaCarga;
        }

        public void ControleDisponibilidadeVeiculo(Dominio.Entidades.Embarcador.GestaoPatio.FluxoGestaoPatio fluxoGestaoPatio, Dominio.Entidades.Veiculo veiculoDaCarga, Repositorio.UnitOfWork unitOfWork)
        {
            if (fluxoGestaoPatio?.Carga?.Veiculo == null)
                return;

            Repositorio.Embarcador.GestaoPatio.FluxoGestaoPatio repositorioFluxoGestaoPatio = new Repositorio.Embarcador.GestaoPatio.FluxoGestaoPatio(unitOfWork);

            fluxoGestaoPatio.Veiculo = fluxoGestaoPatio.Carga.Veiculo;

            if ((veiculoDaCarga != null) && (fluxoGestaoPatio.Carga.Veiculo.Codigo != veiculoDaCarga.Codigo))
                GestaoPatio.DisponibilidadeVeiculo.SetaVeiculoDisponivel(veiculoDaCarga.Codigo, unitOfWork);

            GestaoPatio.DisponibilidadeVeiculo.GeraControleDisponibilidadeVeiculo(fluxoGestaoPatio, unitOfWork);
            repositorioFluxoGestaoPatio.Atualizar(fluxoGestaoPatio);
        }

        public void PreencherDadosAdicionaisUnilever(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, Dominio.ObjetosDeValor.WebService.Carga.CargaIntegracao cargaIntegracao, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.FaixaTemperatura repositorioFaixaTemperatura = new Repositorio.Embarcador.Cargas.FaixaTemperatura(unitOfWork);

            Repositorio.Embarcador.Configuracoes.ConfiguracaoWebService repConfiguracaoWebService = new Repositorio.Embarcador.Configuracoes.ConfiguracaoWebService(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoWebService configuracaoWebService = repConfiguracaoWebService.BuscarConfiguracaoPadrao();

            cargaPedido.Carga.CategoriaCargaEmbarcador = cargaIntegracao.CategoriaCargaEmbarcador ?? string.Empty;
            cargaPedido.Carga.SetPointVeiculo = cargaIntegracao.SetPointVeiculo ?? string.Empty;

            if (configuracaoWebService.PermitirUsarDescricaoFaixaTemperatura)
            {
                if (!string.IsNullOrEmpty(cargaIntegracao.FaixaTemperatura?.CodigoIntegracao) || !string.IsNullOrEmpty(cargaIntegracao.FaixaTemperatura?.Descricao))
                {
                    if (!string.IsNullOrEmpty(cargaIntegracao.FaixaTemperatura.CodigoIntegracao))
                    {
                        cargaPedido.Carga.FaixaTemperatura = repositorioFaixaTemperatura.BuscarPorCodigoIntegracao(cargaIntegracao.FaixaTemperatura.CodigoIntegracao);

                        if (cargaPedido.Carga.FaixaTemperatura == null)
                            return;
                    }
                    else
                    {
                        int codigoTipoOperacao = cargaPedido.Carga.TipoOperacao?.Codigo ?? 0;
                        if (codigoTipoOperacao == 0)
                            codigoTipoOperacao = cargaPedido.Pedido.PreCarga?.TipoOperacao?.Codigo ?? 0;

                        cargaPedido.Carga.IntegracaoTemperatura = cargaIntegracao.FaixaTemperatura.Descricao;
                        cargaPedido.Carga.FaixaTemperatura = repositorioFaixaTemperatura.BuscarPorDescricao(cargaIntegracao.FaixaTemperatura.Descricao, cargaPedido.Carga.Filial?.Codigo ?? 0, codigoTipoOperacao);

                        if (cargaPedido.Carga.FaixaTemperatura == null)
                        {
                            Regex regex = new Regex(@"-?[0-9]\d*((\.|,)\d+)?");
                            List<decimal> temperaturas = new List<decimal>();

                            foreach (Match match in regex.Matches(cargaIntegracao.FaixaTemperatura.Descricao))
                                temperaturas.Add(match.Value.ToDecimal());

                            if (temperaturas.Count == 2)
                            {
                                Dominio.Entidades.Embarcador.Cargas.FaixaTemperatura faixaTemp = new Dominio.Entidades.Embarcador.Cargas.FaixaTemperatura
                                {
                                    Descricao = cargaIntegracao.FaixaTemperatura.Descricao,
                                    FaixaInicial = temperaturas[0],
                                    FaixaFinal = temperaturas[1]
                                };

                                repositorioFaixaTemperatura.Inserir(faixaTemp);

                                cargaPedido.Carga.FaixaTemperatura = faixaTemp;
                            }
                            else
                            {
                                return;
                            }
                        }
                    }
                }
                else
                    cargaPedido.Carga.FaixaTemperatura = null;
            }

            repCarga.Atualizar(cargaPedido.Carga);
        }

        public Dominio.Entidades.Embarcador.Pedidos.TipoOperacao ObterTipoOperacaoPorRegra(Repositorio.UnitOfWork unitOfWork, Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, List<Dominio.Entidades.Embarcador.Pedidos.RegraTipoOperacao> listaTodasRegra)
        {
            Repositorio.Embarcador.Pedidos.RegraTipoOperacaoFilial repRegraTipoOperacaoFilial = new Repositorio.Embarcador.Pedidos.RegraTipoOperacaoFilial(unitOfWork);
            Repositorio.Embarcador.Pedidos.RegraTipoOperacaoCanalEntrega repRegraTipoOperacaoCanalEntrega = new Repositorio.Embarcador.Pedidos.RegraTipoOperacaoCanalEntrega(unitOfWork);
            Repositorio.Embarcador.Pedidos.RegraTipoOperacaoCanalVenda repRegraTipoOperacaoCanalVenda = new Repositorio.Embarcador.Pedidos.RegraTipoOperacaoCanalVenda(unitOfWork);
            Repositorio.Embarcador.Pedidos.RegraTipoOperacaoExpedidor repRegraTipoOperacaoExpedidor = new Repositorio.Embarcador.Pedidos.RegraTipoOperacaoExpedidor(unitOfWork);
            Repositorio.Embarcador.Pedidos.RegraTipoOperacaoRecebedor repRegraTipoOperacaoRecebedor = new Repositorio.Embarcador.Pedidos.RegraTipoOperacaoRecebedor(unitOfWork);
            Repositorio.Embarcador.Pedidos.RegraTipoOperacaoDestinatario repRegraTipoOperacaoDestinatario = new Repositorio.Embarcador.Pedidos.RegraTipoOperacaoDestinatario(unitOfWork);
            Repositorio.Embarcador.Pedidos.RegraTipoOperacaoTiposOperacao repositorioRegraTipoOperacaoTiposOperacao = new Repositorio.Embarcador.Pedidos.RegraTipoOperacaoTiposOperacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.Stage repositorioStage = new Repositorio.Embarcador.Pedidos.Stage(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoStage repositorioPedidosStage = new Repositorio.Embarcador.Pedidos.PedidoStage(unitOfWork);

            List<Dominio.ObjetosDeValor.Embarcador.Pedido.RegraTipoOperacao> listaDeRegrasValida = new List<Dominio.ObjetosDeValor.Embarcador.Pedido.RegraTipoOperacao>();
            List<Dominio.ObjetosDeValor.Embarcador.Pedido.RegraTipoOperacao> listaRegrasParecidas = new List<Dominio.ObjetosDeValor.Embarcador.Pedido.RegraTipoOperacao>();

            int codigoCategoriaRemetente = cargaPedidos.Where(p => p.Pedido.Remetente.Categoria != null).Select(p => p.Pedido.Remetente.Categoria.Codigo).FirstOrDefault();

            List<double> codigosDestinatarios = cargaPedidos.Select(p => p.Pedido.Destinatario.CPF_CNPJ).Distinct().ToList();

            List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos = (from obj in cargaPedidos select obj.Pedido).ToList();
            Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacaoRetornar = null;
            List<Dominio.Entidades.Embarcador.Pedidos.Stage> stages = repositorioPedidosStage.BuscarStagesPorPedidoECargaStage(pedidos.Select(x => x.Codigo).ToList(), carga.Codigo);

            Dominio.ObjetosDeValor.Embarcador.Pedido.RegraTipoOperacao regraAProcurar = new Dominio.ObjetosDeValor.Embarcador.Pedido.RegraTipoOperacao()
            {
                CodigoTipoDocumeto = carga?.TipoDocumentoTransporte?.Codigo ?? 0,
                QuantidadeEtapas = repositorioStage.BuscarQuantidadeStageNumaCarga(carga.Codigo) > 1 ? SimNao.Sim : SimNao.Nao,
                CodigoCategoria = codigoCategoriaRemetente,
                Expedidores = pedidos.Where(p => p.Expedidor != null).Select(p => p.Expedidor.CPF_CNPJ).ToList(),
                Recebedores = pedidos.Where(p => p.Recebedor != null).Select(p => p.Recebedor.CPF_CNPJ).ToList(),
                Filiais = new List<int>() { carga.Filial.Codigo },
                CanaisEntrega = (from obj in stages where obj.CanalEntrega != null select obj.CanalEntrega?.CodigoIntegracao).Distinct().ToList(),
                CanaisVenda = (from obj in stages where obj.CanalVenda != null select obj.CanalVenda?.CodigoIntegracao).Distinct().ToList(),
                Destinatario = codigosDestinatarios,
                CteGlobalizado = carga.CteGlobalizado,
                TipoModal = (from obj in stages select obj.TipoModal).Distinct().ToList(),
                TiposOperacao = pedidos.Where(p => p.TipoOperacao != null).Select(p => p.TipoOperacao.CodigoIntegracao).ToList(),
            };

            List<int> codigosRegras = listaTodasRegra.Select(x => x.Codigo).ToList();
            List<RetornoRegraTipoOperacao> codigosFiliais = repRegraTipoOperacaoFilial.BuscarCodigoFiliaisPorRegra(codigosRegras);
            List<RetornoRegraTipoOperacao> codigosCanalEntrega = repRegraTipoOperacaoCanalEntrega.BuscarCodigoCanalEntregaPorRegra(codigosRegras);
            List<RetornoRegraTipoOperacao> codigosCanalVendas = repRegraTipoOperacaoCanalVenda.BuscarCodigosCanalVendaPorRegra(codigosRegras);
            List<RetornoRegraTipoOperacao> codigosExpedidor = repRegraTipoOperacaoExpedidor.BuscarCodigosExpedidorPorRegra(codigosRegras);
            List<RetornoRegraTipoOperacao> codigosRecebedor = repRegraTipoOperacaoRecebedor.BuscarCodigosRecebedorPorRegra(codigosRegras);
            List<RetornoRegraTipoOperacao> codigosDestinatario = repRegraTipoOperacaoDestinatario.BuscarCodigosDestinatarioPorRegra(codigosRegras);
            List<RetornoRegraTipoOperacao> codigosTiposOperacao = repositorioRegraTipoOperacaoTiposOperacao.BuscarCodigosTiposOperacaoPorRegra(codigosRegras);

            foreach (Dominio.Entidades.Embarcador.Pedidos.RegraTipoOperacao regraAtual in listaTodasRegra)
            {
                List<RetornoRegraTipoOperacao> codigosFiliaisAtual = codigosFiliais.Where(x => x.CodigoRegra == regraAtual.Codigo).ToList();
                List<RetornoRegraTipoOperacao> codigosCanalEntregaAtual = codigosCanalEntrega.Where(x => x.CodigoRegra == regraAtual.Codigo).ToList();
                List<RetornoRegraTipoOperacao> codigosCanalVendasAtual = codigosCanalVendas.Where(x => x.CodigoRegra == regraAtual.Codigo).ToList();
                List<RetornoRegraTipoOperacao> codigosExpedidorAtual = codigosExpedidor.Where(x => x.CodigoRegra == regraAtual.Codigo).ToList();
                List<RetornoRegraTipoOperacao> codigosRecebedorAtual = codigosRecebedor.Where(x => x.CodigoRegra == regraAtual.Codigo).ToList();
                List<RetornoRegraTipoOperacao> codigosDestinatarioAtual = codigosDestinatario.Where(x => x.CodigoRegra == regraAtual.Codigo).ToList();
                List<RetornoRegraTipoOperacao> codigosTiposOperacaoAtual = codigosTiposOperacao.Where(x => x.CodigoRegra == regraAtual.Codigo).ToList();

                List<TipoModal> tipoModal = regraAtual.TipoModal != TipoModal.Todos ? new List<TipoModal> { regraAtual.TipoModal } : new List<TipoModal>();

                RegraTipoOperacao regraTipoOperacao = new Dominio.ObjetosDeValor.Embarcador.Pedido.RegraTipoOperacao()
                {
                    CodigoTipoDocumeto = regraAtual?.TipoDocumentoTransporte?.Codigo ?? 0,
                    CodigoRegra = regraAtual.Codigo,
                    CteGlobalizado = regraAtual.CteGlobalizado,
                    QuantidadeEtapas = regraAtual.QuantidadeEtapas,
                    CodigoCategoria = regraAtual?.Categoria?.Codigo ?? 0,
                    Filiais = codigosFiliaisAtual.Select(x => x.CodigoCampo).ToList(),
                    CanaisEntrega = codigosCanalEntregaAtual.Select(x => x.CodigoCampoS).ToList(),
                    CanaisVenda = codigosCanalVendasAtual.Select(x => x.CodigoCampoS).ToList(),
                    Expedidores = codigosExpedidorAtual.Select(x => x.CodigoCampoD).ToList(),
                    Recebedores = codigosRecebedorAtual.Select(x => x.CodigoCampoD).ToList(),
                    Destinatario = codigosDestinatarioAtual.Select(x => x.CodigoCampoD).ToList(),
                    TiposOperacao = codigosTiposOperacaoAtual.Select(x => x.CodigoCampoS).ToList(),
                    TipoModal = tipoModal
                };

                listaDeRegrasValida.Add(regraTipoOperacao);
            }

            foreach (Dominio.ObjetosDeValor.Embarcador.Pedido.RegraTipoOperacao possivelRegra in listaDeRegrasValida)
                if (possivelRegra.Equals(regraAProcurar))
                    listaRegrasParecidas.Add(possivelRegra);

            if (listaRegrasParecidas.Count == 0)
            {
                CriarPendenciaTipoOperacaoNaCarga(carga, unitOfWork);
                return tipoOperacaoRetornar;
            }

            new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork).Confirmar(carga, TipoMensagemAlerta.ProblemaComTipoOperacao);

            if (listaRegrasParecidas.Count == 1)
            {
                Dominio.ObjetosDeValor.Embarcador.Pedido.RegraTipoOperacao referenciaRegraParecida = listaRegrasParecidas.FirstOrDefault();
                Dominio.Entidades.Embarcador.Pedidos.RegraTipoOperacao regraADefinir = listaTodasRegra.Where(r => r.Codigo == referenciaRegraParecida.CodigoRegra).FirstOrDefault();

                return regraADefinir.TipoOperacao;
            }

            Dictionary<int, int> regrasESimilitudes = new Dictionary<int, int>();

            foreach (Dominio.ObjetosDeValor.Embarcador.Pedido.RegraTipoOperacao possivelRegra in listaRegrasParecidas)
                regrasESimilitudes.Add(possivelRegra.CodigoRegra, possivelRegra.EqualsExpecifica(regraAProcurar));

            int codigoRegra = regrasESimilitudes.OrderByDescending(x => x.Value).First().Key;
            tipoOperacaoRetornar = listaTodasRegra.Where(r => r.Codigo == codigoRegra).FirstOrDefault().TipoOperacao;

            if (tipoOperacaoRetornar == null)
                CriarPendenciaTipoOperacaoNaCarga(carga, unitOfWork);

            return tipoOperacaoRetornar;
        }

        public void ValidarCargaRedespachoJaGeradaCarregamentoStage(Dominio.Entidades.Embarcador.Cargas.Carga cargaDT, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.Redespacho repositorioRedespacho = new Repositorio.Embarcador.Cargas.Redespacho(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.Redespacho> redespachos = repositorioRedespacho.BuscarAtivasPorCargaOrigem(cargaDT.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.Redespacho redespacho in redespachos)
            {
                Dominio.Entidades.Embarcador.Cargas.Carga cargaExiste = redespacho.CargaGerada;
                if (cargaExiste != null)
                {
                    cargaExiste.SituacaoCarga = SituacaoCarga.Cancelada;
                    cargaExiste.CargaFechada = false;
                    repCarga.Atualizar(cargaExiste);
                }

            }

        }

        public void GerarCargaRedespachoOutrasEtapasCarregamentoStages(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Pedidos.PedidoStage> listaStagesPedidoCarga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosCarga, List<Dominio.ObjetosDeValor.WebService.Rest.Unilever.Pedido> objPedidos, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacaoRedespacho, Repositorio.UnitOfWork unitOfWork)
        {
            //separar stages por numero, para cada numero de stage buscar os cargaPedidos equivalentes e gerar uma carga de redespacho;
            Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado = new Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado();
            auditado.TipoAuditado = Dominio.ObjetosDeValor.Enumerador.TipoAuditado.Sistema;

            Repositorio.Embarcador.Cargas.Redespacho repositorioRedespacho = new Repositorio.Embarcador.Cargas.Redespacho(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaEntregaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);

            List<string> numeroStages = listaStagesPedidoCarga.Where(x => x.Stage.NumeroStage.ToInt() > 1).Select(obj => obj.Stage.NumeroStage).Distinct().ToList();

            foreach (string numstage in numeroStages)
            {
                List<Dominio.Entidades.Embarcador.Pedidos.PedidoStage> listaStages = listaStagesPedidoCarga.Where(obj => obj.Stage.NumeroStage == numstage).ToList();
                List<int> codigoPedidos = listaStages.Select(obj => obj.Pedido.Codigo).Distinct().ToList();
                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = cargaPedidosCarga.Where(x => codigoPedidos.Contains(x.Pedido.Codigo)).ToList();

                Dominio.Entidades.Cliente expedidor = listaStages.Select(x => x.Stage.Expedidor).FirstOrDefault();
                Dominio.Entidades.Cliente recebedor = listaStages.Select(x => x.Stage.Recebedor).FirstOrDefault();
                Dominio.Entidades.Empresa empresa = listaStages.Select(x => x.Stage.EmpresaEmitente).FirstOrDefault();
                Dominio.Entidades.Veiculo veiculo = listaStages.Select(x => x.Stage.Veiculo).FirstOrDefault();

                Dominio.Entidades.Embarcador.Cargas.ModeloVeicularCarga modeloVeicularCarga = listaStages.Where(x => x.Stage.NumeroStage.Equals(numstage)).Select(x => x.Stage.ModeloVeicularCarga).FirstOrDefault();

                if (modeloVeicularCarga == null)
                    modeloVeicularCarga = listaStages.Select(x => x.Stage.ModeloVeicularCarga).FirstOrDefault();

                List<Dominio.Entidades.Cliente> destinosDistintos = cargaPedidos.Select(x => x.Pedido.Destinatario).Distinct().ToList();
                List<int> protocoloPedidosDistintos = cargaPedidos.Where(x => destinosDistintos.Contains(x.Pedido.Destinatario)).Select(obj => obj.Pedido.Protocolo).Distinct().ToList();

                decimal distancia = 0m;
                foreach (Dominio.Entidades.Cliente destinatario in destinosDistintos)
                {
                    int protocoloPedido = cargaPedidos.Where(obj => obj.Pedido.Destinatario == destinatario).FirstOrDefault().Pedido.Protocolo;

                    List<Dominio.ObjetosDeValor.WebService.Rest.Unilever.Stage> stagesPedido = objPedidos.Where(obj => obj.ProtocoloPedido.ToInt() == protocoloPedido).SelectMany(obj => obj.Stage).ToList();

                    distancia += stagesPedido.Where(obj => obj.NumeroStage.ToInt() > 1).FirstOrDefault().Distancia;
                }

                //List<Dominio.ObjetosDeValor.WebService.Rest.Unilever.Pedido> pedidosprotocolo = objPedidos.Where(obj => protocoloPedidosDistintos.Contains(obj.ProtocoloPedido.ToInt())).ToList();

                //decimal distancia = pedidosprotocolo.SelectMany(x => x.Stage)?.Where(obj => obj.NumeroStage.ToInt() > 1)?.FirstOrDefault()?.Distancia ?? 0;

                Dominio.Entidades.Embarcador.Cargas.Redespacho redespacho = new Dominio.Entidades.Embarcador.Cargas.Redespacho()
                {
                    DataRedespacho = DateTime.Now,
                    Carga = carga,
                    NumeroRedespacho = repositorioRedespacho.BuscarProximoCodigo(),
                    TipoOperacao = tipoOperacaoRedespacho,
                    Expedidor = expedidor
                };

                repositorioRedespacho.Inserir(redespacho);

                Dominio.Entidades.Embarcador.Cargas.Carga CargaGerada = CargaDistribuidor.GerarCargaProximoTrecho(carga, tipoOperacaoRedespacho, distancia, true, expedidor, cargaPedidos, empresa, configuracaoEmbarcador, true, redespacho, veiculo, tipoServicoMultisoftware, unitOfWork, false, modeloVeicularCarga, recebedor);

                if (CargaGerada == null)
                    return;

                Auditoria.Auditoria.Auditar(auditado, CargaGerada, "Carga criada via integracao SalvarDocumentoTransporte", unitOfWork);

                redespacho.CargaGerada = CargaGerada;

                repositorioRedespacho.Atualizar(redespacho);
            }
        }

        public dynamic ValidarInicioEmissaoDocumentos(int codigoCarga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, List<AdminMultisoftware.Dominio.Enumeradores.PermissaoPersonalizada> permissoesPersonalizadas = null)
        {
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repositorioConfiguracaoEmbarcador = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaRotaFrete repositorioRotaCargaFrete = new Repositorio.Embarcador.Cargas.CargaRotaFrete(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoFinanceiraGNRE repositorioGNRE = new Repositorio.Embarcador.Configuracoes.ConfiguracaoFinanceiraGNRE(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoContaContabilContabilizacao repositorioCargaPedidoContaContabilContabilizacao = new Repositorio.Embarcador.Cargas.CargaPedidoContaContabilContabilizacao(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoCargaDadosTransporte repositorioConfiguracaoCargaDadosTransporte = new Repositorio.Embarcador.Configuracoes.ConfiguracaoCargaDadosTransporte(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoTransportador reposotorioConfiguracaoTransportador = new Repositorio.Embarcador.Configuracoes.ConfiguracaoTransportador(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaValePedagio repCargaValePedagio = new Repositorio.Embarcador.Cargas.CargaValePedagio(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoVeiculo repConfiguracaoVeiculo = new Repositorio.Embarcador.Configuracoes.ConfiguracaoVeiculo(unitOfWork);
            Repositorio.MDFeCIOT repMDFeCIOT = new Repositorio.MDFeCIOT(unitOfWork);
            Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaTabelaFreteCliente repCargaTabelaFreteCliente = new Repositorio.Embarcador.Cargas.CargaTabelaFreteCliente(unitOfWork);
            Repositorio.Embarcador.Terceiros.ContratoFrete repContratoFrete = new Repositorio.Embarcador.Terceiros.ContratoFrete(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoTransportador configuracaoTransportador = reposotorioConfiguracaoTransportador.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoCargaDadosTransporte configuracaoCargaDadosTransporte = repositorioConfiguracaoCargaDadosTransporte.BuscarPrimeiroRegistro();
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = repositorioConfiguracaoEmbarcador.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Cargas.Carga carga = repositorioCarga.BuscarPorCodigo(codigoCarga);
            Dominio.Entidades.Embarcador.Cargas.CargaRotaFrete cargaRotaFrete = repositorioRotaCargaFrete.BuscarPorCarga(carga.Codigo);
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoFinanceiraGNRE configuracaoGNRE = repositorioGNRE.BuscarPrimeiroRegistro();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoVeiculo configuracaoVeiculo = repConfiguracaoVeiculo.BuscarConfiguracaoPadrao();
            bool roteirizacaoPendente = (configuracaoEmbarcador.ExigirRotaRoteirizadaNaCarga || configuracaoEmbarcador.ExigirCargaRoteirizada || (carga.TipoOperacao?.ExigirCargaRoteirizada ?? false)) && cargaRotaFrete == null && (carga.TipoOperacao == null || !carga.TipoOperacao.NaoExigeRotaRoteirizada);

            StringBuilder mensagem = new StringBuilder();

            bool possuiPendencia = false;
            bool permiteGerarGNRE = true;

            List<Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoFinanceiraGNRERegistro> configuracoresGNRERegistros = new List<Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoFinanceiraGNRERegistro>();

            if (configuracaoGNRE != null && configuracaoGNRE.GerarGNREParaCTesEmitidos && configuracaoGNRE.AlertarDisponibilidadeGNREParaCarga)
            {
                Repositorio.Embarcador.Configuracoes.ConfiguracaoFinanceiraGNRERegistro repositorioConfiguracaoFinanceiraGNRERegistro = new Repositorio.Embarcador.Configuracoes.ConfiguracaoFinanceiraGNRERegistro(unitOfWork);
                configuracoresGNRERegistros = repositorioConfiguracaoFinanceiraGNRERegistro.BuscarPorConfiguracao(configuracaoGNRE.Codigo);
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repositorioCargaPedido.BuscarPorCarga(codigoCarga);
            bool utilizaContaRazao = carga.TipoOperacao?.TipoOperacaoUtilizaContaRazao ?? false;
            if (utilizaContaRazao)
            {

                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedidoContaContabilContabilizacao contaContabil = repositorioCargaPedidoContaContabilContabilizacao.BuscarFirstOrDefaultPorCargaPedido(cargaPedido.Codigo);
                    if (contaContabil == null || contaContabil.PlanoConta == null)
                        throw new ServicoException("É necessário informar uma conta contábil.");
                }
            }

            bool naoPermitirAvancarCargaSemRegraICMS = carga.TipoOperacao?.NaoPermitirAvancarCargaSemRegraICMS ?? false;
            if (naoPermitirAvancarCargaSemRegraICMS)
            {
                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
                {
                    if (cargaPedido.RegraICMS == null)
                        throw new ServicoException("O tipo de operação exige que a carga possua Regra de ICMS vinculada a esta carga.");
                }
            }

            bool pedidoComNotaCobertura = tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS && cargaPedidos.Any(o => !string.IsNullOrWhiteSpace(o.Pedido.NumeroControle));
            if (pedidoComNotaCobertura)
            {
                Dominio.Entidades.Cliente remetente = cargaPedidos.Select(o => o.Pedido.Remetente).Where(o => o != null).FirstOrDefault();
                if (remetente != null)
                {
                    Dominio.Entidades.Cliente destinatarioNotaCobertura = (from obj in cargaPedidos select obj.Pedido.Destinatario).Where(o => o.Localidade != remetente.Localidade).FirstOrDefault();

                    if (destinatarioNotaCobertura == null)
                        throw new ServicoException("Nenhum destinatário com localidade diferente do remetente foi encontrado.");
                }
            }


            if (configuracaoCargaDadosTransporte?.ExigirQueVeiculoCavaloTenhaReboqueVinculado ?? false)
            {
                if (tipoServicoMultisoftware != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                {
                    if (carga.Veiculo != null && carga.Veiculo.TipoVeiculo == "0" && (carga.Veiculo.VeiculosVinculados == null || carga.Veiculo.VeiculosVinculados.Count == 0))
                        throw new ServicoException($"Não é possível selecionar um veículo do tipo Tração que não tenha nenhum Reboque atrelado.");
                }
                else if (carga.Veiculo != null && carga.Veiculo.ModeloVeicularCarga != null && carga.Veiculo.ModeloVeicularCarga.Tipo == TipoModeloVeicularCarga.Tracao && (carga.Veiculo.VeiculosVinculados == null || carga.Veiculo.VeiculosVinculados.Count == 0))
                    throw new ServicoException($"Não é possível selecionar um veículo do tipo Tração que não tenha nenhum Reboque atrelado.");
            }

            if (roteirizacaoPendente)
            {
                if (carga.Rota == null)
                    mensagem.Append("Para emitir essa carga é necessário que ela tenha uma rota.");
                else
                {
                    if (carga.Rota.SituacaoDaRoteirizacao == SituacaoRoteirizacao.Aguardando)
                        mensagem.Append("A rota da carga está em processo de roteirização, por favor, aguarde alguns instantes e tente novamente.");
                    else
                    {
                        mensagem.Append("Não foi possível roteirizar a rota da carga.");

                        if (!string.IsNullOrWhiteSpace(carga.Rota.MotivoFalhaRoteirizacao))
                            mensagem.Append($" Motivo ({carga.Rota.MotivoFalhaRoteirizacao}).");

                        mensagem.Append($" Por favor, acesse o cadastro de rotas e conclua a roteirização da rota {carga.Rota.Descricao} manualmente.");
                    }
                }

                return new
                {
                    RoteirizacaoPendente = roteirizacaoPendente,
                    Mensagem = mensagem.ToString()
                };
            }

            if (configuracaoTransportador.AtivarControleCarregamentoNavio && carga.PedidoViagemNavio != null && carga.TipoOperacao != null && carga.TipoOperacao.TipoCobrancaMultimodal == TipoCobrancaMultimodal.CTEAquaviario)
            {
                List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos = repCargaPedido.BuscarPedidosPorCarga(carga.Codigo);

                if (pedidos != null && pedidos.Count > 0)
                {
                    decimal qtdPlugs = 0m;
                    decimal qtdTEUS = 0m;
                    decimal qtdTONS = 0m;

                    qtdTEUS = pedidos.Where(c => c.Container != null && c.Container.ContainerTipo != null && (c.Container.ContainerTipo.TipoPes == TipoPes.vintepes || c.Container.ContainerTipo.TipoPes == TipoPes.quarentapes))?.Sum(c => c.Container.ContainerTipo.TEU.ToInt()) ?? 0m;
                    qtdPlugs = pedidos.Where(c => c.Container != null && c.Container.TipoCarregamentoNavio == TipoCarregamentoNavio.Reefer)?.Count() ?? 0m;
                    qtdTONS = carga.DadosSumarizados.PesoTotal / 1000;
                    if (qtdTONS < 0)
                        qtdTONS = 0;

                    if ((carga.PedidoViagemNavio.ConsumoPlugs + qtdPlugs) > 0 && carga.PedidoViagemNavio.Navio.CapacidadePlug > 0 && (carga.PedidoViagemNavio.ConsumoPlugs + qtdPlugs) > carga.PedidoViagemNavio.Navio.CapacidadePlug)
                        mensagem.Append("Capacidade de PLUGS do navio (" + carga.PedidoViagemNavio.Navio.CapacidadePlug.ToString("n4") + ") excedida para esta viagem (" + (carga.PedidoViagemNavio.ConsumoPlugs + qtdPlugs).ToString("n4") + ").<br/>");
                    if ((carga.PedidoViagemNavio.ConsumoTeus + qtdTEUS) > 0 && carga.PedidoViagemNavio.Navio.CapacidadeTeus > 0 && (carga.PedidoViagemNavio.ConsumoTeus + qtdTEUS) > carga.PedidoViagemNavio.Navio.CapacidadeTeus)
                        mensagem.Append("Capacidade de TEUS do navio (" + carga.PedidoViagemNavio.Navio.CapacidadeTeus.ToString("n4") + ") excedida para esta viagem (" + (carga.PedidoViagemNavio.ConsumoTeus + qtdTEUS).ToString("n4") + ").<br/>");
                    if ((carga.PedidoViagemNavio.ConsumoTons + qtdTONS) > 0 && carga.PedidoViagemNavio.Navio.CapacidadeTons > 0 && (carga.PedidoViagemNavio.ConsumoTons + qtdTONS) > carga.PedidoViagemNavio.Navio.CapacidadeTons)
                        mensagem.Append("Capacidade de TONS do navio (" + carga.PedidoViagemNavio.Navio.CapacidadeTons.ToString("n4") + ") excedida para esta viagem (" + (carga.PedidoViagemNavio.ConsumoTons + qtdTONS).ToString("n4") + ").<br/>");

                    if (mensagem.Length > 0)
                    {
                        return new
                        {
                            RoteirizacaoPendente = true,
                            Mensagem = mensagem.ToString()
                        };
                    }
                }
            }

            Repositorio.Embarcador.Filiais.ConfiguracaoGestaoPatio repositorioConfiguracaoGestaoPatio = new Repositorio.Embarcador.Filiais.ConfiguracaoGestaoPatio(unitOfWork);
            Dominio.Entidades.Embarcador.Filiais.ConfiguracaoGestaoPatio configuracaoGestaoPatio = repositorioConfiguracaoGestaoPatio.BuscarConfiguracao();
            Servicos.Embarcador.GestaoPatio.FluxoGestaoPatio servicoFluxoGestaoPatio = new Servicos.Embarcador.GestaoPatio.FluxoGestaoPatio(unitOfWork);
            Dominio.Entidades.Embarcador.GestaoPatio.FluxoGestaoPatio fluxoGestaoPatio = servicoFluxoGestaoPatio.ObterFluxoGestaoPatio(carga);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga repConfiguracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork);
            bool faturamentoPermiteSolicitarNotasFiscaisEtapaBloqueada = configuracaoGestaoPatio?.FaturamentoPermiteSolicitarNotasFiscaisEtapaBloqueada ?? false;
            bool etapaFaturamentoBloqueada = (fluxoGestaoPatio != null) && fluxoGestaoPatio.Etapas.Any(obj => obj.EtapaFluxoGestaoPatio == EtapaFluxoGestaoPatio.Faturamento) && !carga.EtapaFaturamentoLiberado;
            bool possuiEtapaFaturamentoBloqueada = false;
            bool AlertarCapacidadeModeloVeicularExcedido = false;

            if (!faturamentoPermiteSolicitarNotasFiscaisEtapaBloqueada && etapaFaturamentoBloqueada)
            {
                possuiEtapaFaturamentoBloqueada = true;
                mensagem.Append("Ainda não foi liberado o faturamento para esta carga.");
            }

            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repositorioPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            bool possuiValorFreteZerado = false;

            if (!carga.CargaTransbordo)
            {
                Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoTomador = carga.TipoOperacao?.GrupoTomador;

                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in carga.Pedidos)
                {
                    if (permiteGerarGNRE && (cargaPedido.TipoEmissaoCTeParticipantes == TipoEmissaoCTeParticipantes.ComExpedidorERecebedor || cargaPedido.TipoEmissaoCTeParticipantes == TipoEmissaoCTeParticipantes.ComExpedidor) && cargaPedido.Expedidor != null)
                        permiteGerarGNRE = !configuracoresGNRERegistros.Any(r => r.CFOP == cargaPedido.CFOP && r.Estado != null && r.Estado.Sigla == cargaPedido.Expedidor.Localidade.Estado.Sigla);
                    else if (permiteGerarGNRE && cargaPedido.Pedido.Remetente != null)
                        permiteGerarGNRE = !configuracoresGNRERegistros.Any(r => r.CFOP == cargaPedido.CFOP && r.Estado != null && r.Estado.Sigla == cargaPedido.Pedido.Remetente.Localidade.Estado.Sigla);

                    if (!cargaPedido.CTeEmitidoNoEmbarcador)
                    {
                        TipoEmissaoCTeDocumentos tipoEmissaoCTeDocumento = cargaPedido.TipoRateio;

                        if (tipoEmissaoCTeDocumento == TipoEmissaoCTeDocumentos.EmitePorPedidoAgrupado || tipoEmissaoCTeDocumento == TipoEmissaoCTeDocumentos.EmitePorPedidoIndividual)
                        {
                            if (cargaPedido.ValorFreteAPagar <= 0m)
                            {
                                possuiValorFreteZerado = true;
                                mensagem.Append($"O pedido {cargaPedido.Pedido.NumeroPedidoEmbarcador} está sem valor de frete, podendo gerar CT-e com valor zerado. ");
                            }
                        }
                        else
                        {
                            List<int> numeroNotas = repositorioPedidoXMLNotaFiscal.NotasPossuemValorFreteZeradoPorPedido(cargaPedido.Codigo);

                            if (numeroNotas.Count > 0)
                            {
                                possuiValorFreteZerado = true;
                                mensagem.Append($"As notas fiscais {string.Join(", ", numeroNotas)} estão sem valor de frete, podendo gerar CT-e com valor zerado. ");
                            }
                        }
                    }

                    //if (cargaPedido.Pedido.NecessitaAverbacaoAutomatica && (cargaPedido.ApoliceSeguroAverbacao == null || cargaPedido.ApoliceSeguroAverbacao.Count == 0))
                    //    return new JsonpResult(false, true, "O pedido necessita da averbação automática, favor informe a apólice do seguro na aba Seguro.");

                    if (grupoTomador != null)
                    {
                        Dominio.Entidades.Cliente tomador = cargaPedido.ObterTomador();

                        if ((tomador != null) && (tomador.GrupoPessoas?.Codigo != grupoTomador.Codigo))
                            throw new ServicoException($"O tomador {tomador.Descricao} não pertence ao grupo de pessoas {grupoTomador.Descricao}");
                    }

                    if (cargaPedido.Tomador == null && cargaPedido.TipoTomador == Dominio.Enumeradores.TipoTomador.Outros && !cargaPedido.Pedido.UsarTipoPagamentoNF)
                        throw new ServicoException($"O tomador não foi informado, favor verifique o tipo do tomador.");

                    if (cargaPedido.Pedido.Destinatario == null)
                        throw new ServicoException($"Não existe nenhum destinatário informado no Pedido, favor retorne a etapa e informe o mesmo corretamente.");

                }
            }

            if (!permiteGerarGNRE)
                mensagem.Append("Esta carga irá gerar GNRE.");

            if (!(carga.TipoOperacao?.NaoExigirQueEntregasSejamAgendadasComCliente ?? false))
            {
                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
                {
                    if ((cargaPedido.ObterDestinatario()?.ExigeQueEntregasSejamAgendadas ?? false) && !cargaPedido.Pedido.DataAgendamento.HasValue && (!cargaPedido.Pedido.ObterDestinatario()?.PermiteAgendarComViagemIniciada ?? false))
                        throw new ServicoException($"O destinatário {cargaPedido.ObterDestinatario().NomeCNPJ} exige que suas entregas sejam agendadas.");
                }
            }

            if (carga.TipoOperacao != null && carga.TipoOperacao.PermiteInformarIscaNaCarga && carga.TipoOperacao.ExigeInformarIscaNaCarga)
            {
                Repositorio.Embarcador.Cargas.CargaIsca repositorioCargaIsca = new Repositorio.Embarcador.Cargas.CargaIsca(unitOfWork);
                if (!(repositorioCargaIsca.BuscarPorCarga(carga.Codigo).Count > 0))
                    throw new ServicoException("É obrigatório informar pelo menos uma isca para a carga.");
            }

            if (possuiValorFreteZerado && carga.TipoOperacao != null && carga.TipoOperacao.ExigirValorFreteAvancarCarga)
                throw new ServicoException("Para emitir esta carga é necessário que ela tenha valor de frete");

            if (configuracaoEmbarcador.AvisarDivergenciaValoresCTeEmitidoEmbarcador && carga.Pedidos.Any(o => o.CTeEmitidoNoEmbarcador) && carga.ValorFreteTabelaFrete != carga.ValorFreteAPagar)
            {
                possuiPendencia = true;
                mensagem.AppendLine($"O valor do frete calculado pela tabela de frete ({carga.ValorFreteTabelaFrete:n2}) difere do valor do frete dos CT-es emitidos pelo embarcador ({carga.ValorFreteAPagar:n2}).");
            }

            if (carga.SituacaoCarga == SituacaoCarga.CalculoFrete && repConfiguracaoGeralCarga.ExisteModeloVeicularVeiculoCargaEtapaFrete())
                VerificarModeloVeicularDiferenteDoSolicitado(carga, validarModeloVeicularVeiculoCargaEtapaFrete: true);

            //validacao peso carga e capacidade modelo veicular;
            if (carga.ModeloVeicularCarga != null && carga.ModeloVeicularCarga.AlertarOperadorPesoExcederCapacidade)
            {
                decimal PesoCarga = carga.DadosSumarizados != null ? carga.DadosSumarizados.PesoLiquidoTotal : 0;
                decimal capacidadeModeloVeicular = carga.ModeloVeicularCarga.CapacidadePesoTransporte + carga.ModeloVeicularCarga.ToleranciaPesoExtra;
                if (PesoCarga > capacidadeModeloVeicular)
                {
                    //deve alertar o usuario; se confirmar armazenar na auditoria da carga q liberou a emissao;
                    AlertarCapacidadeModeloVeicularExcedido = true;
                    mensagem.Append($"O peso da carga {PesoCarga.ToString("n2")} excede a capacidade do modelo veicular {capacidadeModeloVeicular.ToString("n2")}. ");
                }
            }

            Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteCliente cargaTabelaFretesCliente = repCargaTabelaFreteCliente.BuscarPorCarga(codigoCarga).FirstOrDefault();

            bool ValePedagioInformado = repCargaValePedagio.ExistePorCarga(carga.Codigo);
            if (((carga.TipoOperacao?.ConfiguracaoCarga?.ObrigarInformarValePedagio ?? false) || (cargaTabelaFretesCliente?.TabelaFreteCliente?.ObrigatorioInformarValePedagioCarga ?? false)) && !ValePedagioInformado)
                throw new ServicoException("É obrigatório informar os dados do Vale Pedagio para a carga.");


            if (carga.FreteDeTerceiro && (configuracaoVeiculo?.ValidarExisteCargaMesmoNumeroCIOT ?? false) && carga.Veiculo != null)
            {
                if ((configuracaoVeiculo?.RemoverNumeroCIOTEncerrado ?? false) && repMDFeCIOT.ExisteEncerradoPorVeiculoENumeroCiot(carga.Veiculo.Placa, carga.Veiculo.CIOT))
                {
                    carga.Veiculo.CIOT = "";
                    repVeiculo.Atualizar(carga.Veiculo);
                }

                if (string.IsNullOrWhiteSpace(carga.Veiculo.CIOT))
                    throw new ServicoException("Veículo não possui número de CIOT vinculado");
            }

            bool erroAoIntegrarAcrescimoDescontoComPermissao = false;
            if (!(repContratoFrete.BuscarPorCarga(carga.Codigo)?.IntegrouValoresAcrescimoDesconto ?? true))
            {
                bool permissao = permissoesPersonalizadas != null && permissoesPersonalizadas.Contains(AdminMultisoftware.Dominio.Enumeradores.PermissaoPersonalizada.Carga_PermitirEmissaoDocumentosComFalhaIntegracaoAcrescimoDesconto);
                if (permissao)
                {
                    erroAoIntegrarAcrescimoDescontoComPermissao = true;
                    mensagem.Append("Ocorreu erro ao integrar os acréscimos e descontos!");
                }
                else
                    throw new ServicoException("Ocorreu problemas ao integrar os acréscimo e descontos, tente recalcular");

            }

            return new
            {
                OcorreuErroEPossuiPermissao = erroAoIntegrarAcrescimoDescontoComPermissao,
                PermiteGerarGNRE = permiteGerarGNRE,
                PossuiPendencia = (possuiEtapaFaturamentoBloqueada || roteirizacaoPendente || possuiPendencia || AlertarCapacidadeModeloVeicularExcedido),
                Mensagem = mensagem.ToString()
            };
        }

        public dynamic AvancarACargaSomenteComTipoDeCargaEModeloVeicular(Dominio.ObjetosDeValor.Embarcador.Carga.DadosCarga dadosCarga, Repositorio.UnitOfWork unitOfWork)
        {
            if (dadosCarga.Carga == null)
                throw new ServicoException("Carga não encontrada");

            if (dadosCarga.Carga.CargaAgrupamento != null || dadosCarga.Carga.CargaVinculada != null)
                throw new ServicoException("A carga foi agrupada, sendo assim não é possível alterá-la.");

            Repositorio.Embarcador.WMS.MontagemContainer repositorioMontagemContainer = new Repositorio.Embarcador.WMS.MontagemContainer(unitOfWork);
            Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);

            if (serCarga.RecebeuNumeroCargaEmbarcador(dadosCarga.Carga, unitOfWork))
                throw new ServicoException("A carga já recebeu o número de carga do Embarcador e não permite essa alteração.");

            string retornoVerificarOperador = serCarga.VerificarOperadorPodeConfigurarCarga(dadosCarga.Usuario, dadosCarga.Carga, dadosCarga.TipoServicoMultisoftware);

            if (!string.IsNullOrWhiteSpace(retornoVerificarOperador))
                throw new ServicoException(retornoVerificarOperador);

            List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga> situacaoCarga = new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga>() { Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgTransportador };

            if (!situacaoCarga.Contains(dadosCarga.Carga.SituacaoCarga))
                throw new ServicoException("Não é possível alterar os dados da carga na atual situação (" + dadosCarga.Carga.DescricaoSituacaoCarga + ").");

            Repositorio.Embarcador.Cargas.TipoDeCarga repositorioTipoCarga = new Repositorio.Embarcador.Cargas.TipoDeCarga(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoCargaModeloVeicular repositorioaModeloVeicular = new Repositorio.Embarcador.Cargas.TipoCargaModeloVeicular(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.TipoDeCarga tipoCarga = repositorioTipoCarga.BuscarPorCodigo(dadosCarga.CodigoTipoCarga);
            List<Dominio.Entidades.Embarcador.Cargas.TipoCargaModeloVeicular> listaCargaModeloVeicular = repositorioaModeloVeicular.ConsultarPorTipoCarga(tipoCarga.Codigo);
            Dominio.Entidades.Embarcador.Cargas.ModeloVeicularCarga modeloVeicularCarga = (from obj in listaCargaModeloVeicular where obj.ModeloVeicularCarga.Codigo == dadosCarga.CodigoModeloVeiculo select obj.ModeloVeicularCarga).FirstOrDefault();

            if (!(modeloVeicularCarga != null || dadosCarga.Carga.NaoExigeVeiculoParaEmissao))
                throw new ServicoException("Por favor informe um Modelo Veicular compatível com o Tipo de Carga.");

            unitOfWork.Start();
            Repositorio.Embarcador.Cargas.TipoCargaModeloVeicularAutoConfig repositorioTipoCargaModeloVeicularAutoConfig = new Repositorio.Embarcador.Cargas.TipoCargaModeloVeicularAutoConfig(unitOfWork);
            Repositorio.Embarcador.Cargas.LogAlteracaoTipoCargaModeloVeicular repositorioLogAlteracaoTipoCargaModeloVeicular = new Repositorio.Embarcador.Cargas.LogAlteracaoTipoCargaModeloVeicular(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repositorioConfiguracaoEmbarcador = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoGeral repositorioConfiguracaoGeral = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeral(unitOfWork);
            Repositorio.Empresa repositorioEmpresa = new Repositorio.Empresa(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga repositorioConfiguracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork);
            Repositorio.Usuario repUsuario = new(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoMotorista repositorioConfiguracaoMotorista = new(unitOfWork);
            Repositorio.Embarcador.Veiculos.VeiculoMotorista repVeiculoMotorista = new(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaMotorista repCargaMotorista = new(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = repositorioConfiguracaoEmbarcador.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeral configuracaoGeral = repositorioConfiguracaoGeral.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga = repositorioConfiguracaoGeralCarga.BuscarPrimeiroRegistro();

            Servicos.Embarcador.Carga.CargaPallets serCargaPallets = new Servicos.Embarcador.Carga.CargaPallets(unitOfWork, configuracaoEmbarcador);
            Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota servicoCargaValePedagioRota = new Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota(unitOfWork);
            Servicos.Embarcador.Integracao.OneTrust.IntegracaoOneTrust servicoIntegracaoOneTrust = new(configuracaoEmbarcador, unitOfWork);
            Servicos.Embarcador.Carga.CargaMotorista servicoCargaMotorista = new(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.TipoCargaModeloVeicularAutoConfig tipoCargaModeloVeicularAutoConfig = repositorioTipoCargaModeloVeicularAutoConfig.Buscar();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoMotorista configuracaoConfiguracaoMotorista = repositorioConfiguracaoMotorista.BuscarPrimeiroRegistro();

            if (!dadosCarga.AvancoAutomatico && modeloVeicularCarga != null && tipoCargaModeloVeicularAutoConfig != null && (tipoCargaModeloVeicularAutoConfig.AutoModeloVeicularHabilitado || tipoCargaModeloVeicularAutoConfig.TipoAutomatizacaoTipoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoAutomatizacaoTipoCarga.Desabilitado))
            {
                Dominio.Entidades.Embarcador.Cargas.LogAlteracaoTipoCargaModeloVeicular logAlteracaoTipoCargaModeloVeicular = new Dominio.Entidades.Embarcador.Cargas.LogAlteracaoTipoCargaModeloVeicular();
                logAlteracaoTipoCargaModeloVeicular.DataRegistroLog = DateTime.Now;
                logAlteracaoTipoCargaModeloVeicular.Carga = dadosCarga.Carga;
                logAlteracaoTipoCargaModeloVeicular.Usuario = dadosCarga.Usuario;
                logAlteracaoTipoCargaModeloVeicular.ModeloVeicularCarga = dadosCarga.Carga.ModeloVeicularCarga;
                logAlteracaoTipoCargaModeloVeicular.TipoDeCarga = dadosCarga.Carga.TipoDeCarga;
                logAlteracaoTipoCargaModeloVeicular.ModeloVeicularCargaAtual = modeloVeicularCarga;
                logAlteracaoTipoCargaModeloVeicular.TipoDeCargaAtual = tipoCarga;

                if (dadosCarga.Carga.PossuiPendencia && dadosCarga.Carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova)
                {
                    logAlteracaoTipoCargaModeloVeicular.SistemaNaoGerouTipoCargaEModelo = true;
                    logAlteracaoTipoCargaModeloVeicular.Justificativa = dadosCarga.Carga.MotivoPendencia;
                    repositorioLogAlteracaoTipoCargaModeloVeicular.Inserir(logAlteracaoTipoCargaModeloVeicular);
                }
                else
                {
                    if (((dadosCarga.Carga.ModeloVeicularCarga != null && dadosCarga.Carga.ModeloVeicularCarga.Codigo != modeloVeicularCarga.Codigo) && tipoCargaModeloVeicularAutoConfig.AutoModeloVeicularHabilitado) ||
                        ((dadosCarga.Carga.TipoDeCarga != null && dadosCarga.Carga.TipoDeCarga.Codigo != tipoCarga.Codigo) && tipoCargaModeloVeicularAutoConfig.TipoAutomatizacaoTipoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoAutomatizacaoTipoCarga.Desabilitado))
                    {
                        logAlteracaoTipoCargaModeloVeicular.SistemaNaoGerouTipoCargaEModelo = false;
                        logAlteracaoTipoCargaModeloVeicular.Justificativa = dadosCarga.Justificativa;
                        repositorioLogAlteracaoTipoCargaModeloVeicular.Inserir(logAlteracaoTipoCargaModeloVeicular);
                    }
                }
            }

            bool alterouModeloVeicular = dadosCarga.Carga.ModeloVeicularCarga != null && modeloVeicularCarga != null && (dadosCarga.Carga.ModeloVeicularCarga.Codigo != modeloVeicularCarga.Codigo);

            if (dadosCarga.Carga.CargaAgrupada)
                dadosCarga.Carga.AgIntegracaoAgrupamentoCarga = true;

            dadosCarga.Carga.TipoDeCarga = tipoCarga;
            dadosCarga.Carga.ModeloVeicularCarga = modeloVeicularCarga;
            dadosCarga.Carga.PossuiPendencia = false;
            dadosCarga.Carga.MotivoPendencia = "";

            new Servicos.Embarcador.Carga.CargaOperador(unitOfWork).Atualizar(dadosCarga.Carga, dadosCarga.Usuario, dadosCarga.TipoServicoMultisoftware);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repositorioCargaPedido.BuscarPorCarga(dadosCarga.Carga.Codigo);

            serCargaPallets.RatearPaletesModeloVeicularCargaEntreOsPedidos(dadosCarga.Carga, cargaPedidos);

            bool possuiMontagemContainer = repositorioMontagemContainer.BuscarSeExisteCadastrado();

            Servicos.Embarcador.Carga.Frete serFrete = new Servicos.Embarcador.Carga.Frete(unitOfWork, dadosCarga.TipoServicoMultisoftware);
            serFrete.LimparTabelaFreteRotaParaCarga(dadosCarga.Carga, unitOfWork);

            Dominio.ObjetosDeValor.Embarcador.Frete.RetornoDadosFrete retorno = new Dominio.ObjetosDeValor.Embarcador.Frete.RetornoDadosFrete() { situacao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoRetornoDadosFrete.CalculandoFrete };
            dadosCarga.Carga.DataInicioCalculoFrete = DateTime.Now;
            dadosCarga.Carga.CalculandoFrete = true;
            dadosCarga.Carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete;
            dadosCarga.Carga.PendenciaEmissaoAutomatica = false;

            if (dadosCarga.Carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete)
                Servicos.Log.TratarErro("Atualizou a situação para calculo frete 41 Carga " + dadosCarga.Carga.CodigoCargaEmbarcador, "AtualizouSituacaoCalculoFrete");

            if (possuiMontagemContainer && (dadosCarga.Carga.TipoOperacao?.CargaTipoConsolidacao ?? false))
            {
                Repositorio.Embarcador.Pedidos.ContainerTipo repositorioTipoContainer = new Repositorio.Embarcador.Pedidos.ContainerTipo(unitOfWork);

                dadosCarga.Carga.Empresa = repositorioEmpresa.BuscarEmpresaPadraoRetirada();
                dadosCarga.Carga.TipoContainer = repositorioTipoContainer.BuscarPorCodigo(dadosCarga.CodigoTipoContainer);
            }

            if (dadosCarga.CodigoTransportador > 0 && (dadosCarga.Carga.TipoOperacao?.ConfiguracaoCarga?.PermiteInformarTransportadorEtapaUmQuandoNotaFiscalNaoRecebidaAntesCalculoFrete ?? false))
                dadosCarga.Carga.Empresa = repositorioEmpresa.BuscarPorCodigo(dadosCarga.CodigoTransportador);


            if (dadosCarga.CodigoVeiculo > 0 && (dadosCarga.Carga.TipoOperacao?.ConfiguracaoCarga?.PermiteInformarTransportadorEtapaUmQuandoNotaFiscalNaoRecebidaAntesCalculoFrete ?? false))
            {
                Dominio.Entidades.Veiculo veiculo = null;
                veiculo = repVeiculo.BuscarPorCodigo(dadosCarga.CodigoVeiculo);
                if ((dadosCarga.Carga.TipoOperacao?.ExigirVeiculoComRastreador ?? false) && (veiculo != null && !(veiculo?.PossuiRastreador ?? false)))
                    throw new ServicoException($"Para o tipo de operação '{dadosCarga.Carga.TipoOperacao.Descricao}' é obrigatório informar um veiculo com o rastreador cadastrado.");

                if (veiculo.TipoVeiculo == "1")
                {
                    if (veiculo.VeiculosTracao != null && veiculo.VeiculosTracao.Count > 0)
                        veiculo = veiculo.VeiculosTracao.FirstOrDefault();
                }
                dadosCarga.Carga.Veiculo = veiculo;
            }

            if (dadosCarga.CodigoReboque > 0 && (dadosCarga.Carga.TipoOperacao?.ConfiguracaoCarga?.PermiteInformarTransportadorEtapaUmQuandoNotaFiscalNaoRecebidaAntesCalculoFrete ?? false))
            {
                if (dadosCarga.Carga.VeiculosVinculados == null)
                    dadosCarga.Carga.VeiculosVinculados = new List<Dominio.Entidades.Veiculo>();

                bool veiculoAlterado = dadosCarga.Carga.IsChangedByPropertyName("Veiculo");

                if (dadosCarga.Carga.TipoOperacao?.ExigePlacaTracao ?? false)
                {
                    dadosCarga.Carga.VeiculosVinculados.Clear();

                    Dominio.Entidades.Veiculo reboque = repVeiculo.BuscarPorCodigo(dadosCarga.CodigoReboque);

                    if (reboque != null && !dadosCarga.Carga.VeiculosVinculados.Contains(reboque))
                        dadosCarga.Carga.VeiculosVinculados.Add(reboque);

                    if (dadosCarga.CodigoSegundoReboque > 0)
                    {
                        reboque = repVeiculo.BuscarPorCodigo(dadosCarga.CodigoSegundoReboque);

                        if (reboque != null && !dadosCarga.Carga.VeiculosVinculados.Contains(reboque))
                            dadosCarga.Carga.VeiculosVinculados.Add(reboque);
                    }

                    if (dadosCarga.CodigoTerceiroReboque > 0)
                    {
                        reboque = repVeiculo.BuscarPorCodigo(dadosCarga.CodigoTerceiroReboque);

                        if (reboque != null && !dadosCarga.Carga.VeiculosVinculados.Contains(reboque))
                            dadosCarga.Carga.VeiculosVinculados.Add(reboque);
                    }
                }
                else if (dadosCarga.Carga.Veiculo != null)
                {
                    Servicos.Embarcador.Logistica.FilaCarregamentoVeiculo servicoFilaCarregamentoVeiculo = new Servicos.Embarcador.Logistica.FilaCarregamentoVeiculo(unitOfWork, dadosCarga.Auditado.Usuario, Logistica.FilaCarregamentoVeiculo.ObterOrigemAlteracaoFilaCarregamento(dadosCarga.TipoServicoMultisoftware));
                    bool atualizarVeiculosVinculados = veiculoAlterado || !configuracaoGeralCarga.UtilizarProgramacaoCarga || !servicoFilaCarregamentoVeiculo.ExisteFilaCarregamentoVeiculoPorCarga(dadosCarga.Carga.Codigo);

                    if (atualizarVeiculosVinculados)
                    {
                        dadosCarga.Carga.VeiculosVinculados.Clear();

                        foreach (Dominio.Entidades.Veiculo veiculoVinculado in dadosCarga.Carga.Veiculo.VeiculosVinculados)
                            dadosCarga.Carga.VeiculosVinculados.Add(veiculoVinculado);
                    }
                }
                else
                    dadosCarga.Carga.VeiculosVinculados.Clear();

                if (dadosCarga.Carga.Veiculo != null)
                {
                    Repositorio.Embarcador.GestaoPatio.FluxoPatioCancelamento repositorioFluxoPatioCancelamento = new Repositorio.Embarcador.GestaoPatio.FluxoPatioCancelamento(unitOfWork);
                    bool possuiVeiculoBloqueado = repositorioFluxoPatioCancelamento.BuscarSeVeiculoEstaBloqueadoPorCargaVeiculo(dadosCarga.Carga.Codigo, dadosCarga.Carga.Veiculo.Codigo);

                    if (possuiVeiculoBloqueado)
                        throw new ServicoException("Esse veículo está bloqueado para está carga.");
                }
            }

            if (dadosCarga.Carga.Veiculo != null)
            {
                AtualizarVinculoVeiculoMotorista(dadosCarga.Carga.Veiculo, dadosCarga.CodigosMotoristas, configuracaoEmbarcador, unitOfWork, dadosCarga.Auditado);
            }

            Dominio.ObjetosDeValor.Embarcador.GR.RetornoGR retornoGR = null;
            List<Dominio.Entidades.Usuario> motoristas = new List<Dominio.Entidades.Usuario>();

            foreach (int codigoMotorista in dadosCarga.CodigosMotoristas)
            {
                Dominio.Entidades.Usuario motorista = repUsuario.BuscarPorCodigo(codigoMotorista);
                servicoIntegracaoOneTrust.VerificarSituacaoMotorista(motorista);

                if (configuracaoEmbarcador.ValidarDataLiberacaoSeguradora && !motorista.DataValidadeLiberacaoSeguradora.HasValue)
                    throw new ServicoException("O motorista não possui uma data de limite da seguradora configurada, por isso não é possível informar este motorista para transportar essa carga, verifique e tente novamente.");

                if (configuracaoEmbarcador.ValidarDataLiberacaoSeguradora && (motorista.DataValidadeLiberacaoSeguradora.HasValue && motorista.DataValidadeLiberacaoSeguradora.Value.AddDays(1).AddMinutes(-1) < DateTime.Now))
                    throw new ServicoException($"A data de limite do motorista na seguradora está válido até {motorista.DataValidadeLiberacaoSeguradora.Value.ToString("dd/MM/yyyy")}, por isso não é possível informar este motorista para transportar essa carga, verifique e tente novamente.");

                if (motorista.Bloqueado)
                {
                    string mensagemMotoristaVeiculo = $"O motorista {motorista.Descricao} está bloqueado";

                    if (dadosCarga.TipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador)
                        mensagemMotoristaVeiculo += $" pelo motivo {motorista.MotivoBloqueio}.";
                    else
                        mensagemMotoristaVeiculo += $". Entre em contato com o embarcador para entender o motivo.";

                    if (!string.IsNullOrWhiteSpace(configuracaoConfiguracaoMotorista.MensagemPersonalizadaMotoristaBloqueado))
                        mensagemMotoristaVeiculo = configuracaoConfiguracaoMotorista.MensagemPersonalizadaMotoristaBloqueado;

                    throw new ServicoException(mensagemMotoristaVeiculo);
                }

                if (dadosCarga.Carga.TipoOperacao?.ConfiguracaoCarga?.NaoPermitirInformarMotoristaComCNHVencida ?? false)
                {
                    if (!motorista.DataVencimentoHabilitacao.HasValue)
                        throw new ServicoException("O motorista não possui a data de validade da CNH preenchida, por isso não é possível informar este motorista para transportar a carga, verifique e tente novamente.");
                    if (motorista.DataVencimentoHabilitacao.Value.AddDays(30) < DateTime.Now.Date)
                        throw new ServicoException($"A data de validade da CNH do motorista estava valida até {motorista.DataVencimentoHabilitacao.Value.ToDateString()} e já excedeu os 30 dias permitidos, por isso não é possível informar este motorista para transportar a carga, verifique e tente novamente.");
                }

                retornoGR = ValidarMotoristaGR(configuracaoEmbarcador.NaoBloquearCargaComProblemaIntegracaoGrMotoristaVeiculo, dadosCarga.Carga, motorista, dadosCarga.TipoServicoMultisoftware, unitOfWork);
                VerificarErroAdagio(retornoGR, configuracaoEmbarcador.NaoBloquearCargaComProblemaIntegracaoGrMotoristaVeiculo);

                Dominio.Entidades.Usuario veiculoMotorista = null;
                if (dadosCarga.Carga.Veiculo != null)
                    veiculoMotorista = repVeiculoMotorista.BuscarMotoristaPrincipal(dadosCarga.Carga.Veiculo.Codigo);

                if (configuracaoEmbarcador.PreencherMotoristaAutomaticamenteAoInformarVeiculo && dadosCarga.Carga.Veiculo != null && veiculoMotorista == null)
                {
                    Dominio.Entidades.Embarcador.Veiculos.VeiculoMotorista VeiculoMotoristaPrincipal = new Dominio.Entidades.Embarcador.Veiculos.VeiculoMotorista
                    {
                        CPF = motorista.CPF,
                        Motorista = motorista,
                        Nome = motorista.Nome,
                        Veiculo = dadosCarga.Carga.Veiculo,
                        Principal = true
                    };

                    repVeiculoMotorista.Inserir(VeiculoMotoristaPrincipal);
                }

                motoristas.Add(motorista);
            }

            bool atualizouMotorista = servicoCargaMotorista.AtualizarMotoristas(dadosCarga.Carga, motoristas);

            List<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> cargaMotoristas = repCargaMotorista.BuscarPorCarga(dadosCarga.Carga.Codigo);

            //irá adicionar as integrações antes de mudar a situação, pois estava avançando a etapa de Dados Transporte antes de efetuar a integração
            Servicos.Embarcador.Integracao.IntegracaoCarga.AdicionarIntegracoesCarga(dadosCarga.Carga, cargaPedidos, dadosCarga.TipoServicoMultisoftware, unitOfWork, false);
            Servicos.Embarcador.Integracao.IntegracaoCarga.AdicionarIntegracoesCargaDadosTransporte(dadosCarga.Carga, cargaPedidos, cargaMotoristas, configuracaoEmbarcador, dadosCarga.TipoServicoMultisoftware, unitOfWork, atualizouMotorista, alterouModeloVeicular);
            Servicos.Embarcador.Integracao.MercadoLivre.IntegracaoMercadoLivre svcIntegracaoMercadoLivre = new Integracao.MercadoLivre.IntegracaoMercadoLivre(unitOfWork);
            svcIntegracaoMercadoLivre.VerificarConsultaRotaEFacilityAutomatizada(dadosCarga.Carga, dadosCarga.Carga.Pedidos.ToList(), dadosCarga.TipoServicoMultisoftware, unitOfWork);

            if (configuracaoGeral.PermiteRealizarConsultaVPUtilizandoModeloVeicularCarga && (dadosCarga.Carga.TipoOperacao?.ExigeQueVeiculoIgualModeloVeicularDaCarga ?? false))
                Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota.CriarCargaValePedagioPorRotaFrete(dadosCarga.Carga, cargaPedidos, configuracaoEmbarcador, unitOfWork, dadosCarga.TipoServicoMultisoftware);

            if (configuracaoGeral.PermiteRealizarConsultaVPUtilizandoModeloVeicularCarga && alterouModeloVeicular)
                servicoCargaValePedagioRota.AtualizarConsultaValePedagio(dadosCarga.Carga);

            if (alterouModeloVeicular)
                new Servicos.Embarcador.Integracao.IntegracaoCarga(unitOfWork).AdicionarIntegracoesCargaFrete(dadosCarga.Carga, unitOfWork);

            repCarga.Atualizar(dadosCarga.Carga, dadosCarga.Auditado);

            dynamic dynCargaD = serCarga.ObterDetalhesDaCarga(dadosCarga.Carga, dadosCarga.TipoServicoMultisoftware, unitOfWork);

            Repositorio.Embarcador.Cargas.CargaJanelaCarregamento repCargaJanelaCarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamento(unitOfWork);
            Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento = repCargaJanelaCarregamento.BuscarPorCarga(dadosCarga.Carga.Codigo);

            if (cargaJanelaCarregamento != null)
            {
                Servicos.Embarcador.Logistica.CargaJanelaCarregamento servicoCargaJanelaCarregamento = new Servicos.Embarcador.Logistica.CargaJanelaCarregamento(unitOfWork);
                servicoCargaJanelaCarregamento.AtualizarPorCarga(cargaJanelaCarregamento, dadosCarga.TipoServicoMultisoftware);
            }

            if (cargaJanelaCarregamento != null)
                new Servicos.Embarcador.Hubs.JanelaCarregamento().InformarJanelaCarregamentoAtualizada(cargaJanelaCarregamento);

            unitOfWork.CommitChanges();

            return new
            {
                Frete = retorno,
                Carga = dynCargaD
            };
        }

        public void VerificarSalvarDadostransporteCargaAutomaticamente(Repositorio.UnitOfWork unitOfWork)
        {
            try
            {
                Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
                Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repositorioConfiguracaoEmbarcador = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);

                List<int> codigosCarga = repositorioCarga.BuscarCodigosPorCargaAguardandoSalvarDadosTransporte();

                foreach (int codigoCarga in codigosCarga)
                {
                    Dominio.Entidades.Embarcador.Cargas.Carga carga = repositorioCarga.BuscarPorCodigo(codigoCarga);

                    try
                    {
                        List<int> codigosMotoristas = carga.Motoristas?.Select(motorista => motorista.Codigo).ToList() ?? new List<int>();
                        string mensagemErro = string.Empty;

                        Dominio.ObjetosDeValor.Embarcador.Carga.CargaDadosTransporte dadosTransporte = new Dominio.ObjetosDeValor.Embarcador.Carga.CargaDadosTransporte()
                        {
                            Carga = carga,
                            CodigoEmpresa = carga.Empresa?.Codigo ?? 0,
                            CodigoModeloVeicular = carga.ModeloVeicularCarga?.Codigo ?? 0,
                            CodigoReboque = (carga.VeiculosVinculados?.Count > 0) ? carga.VeiculosVinculados.ElementAt(0).Codigo : 0,
                            CodigoSegundoReboque = (carga.VeiculosVinculados?.Count > 1) ? carga.VeiculosVinculados.ElementAt(1).Codigo : 0,
                            CodigoTerceiroReboque = (carga.VeiculosVinculados?.Count > 2) ? carga.VeiculosVinculados.ElementAt(2).Codigo : 0,
                            CodigoTipoCarga = carga.TipoDeCarga?.Codigo ?? 0,
                            CodigoTipoOperacao = carga.TipoOperacao?.Codigo ?? 0,
                            CodigoTracao = carga.Veiculo?.Codigo ?? 0,
                            NumeroPager = carga.NumeroPager,
                            ObservacaoTransportador = carga.ObservacaoTransportador,
                        };

                        if (codigosMotoristas.Count > 0)
                            dadosTransporte.ListaCodigoMotorista.AddRange(codigosMotoristas);

                        Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado = new Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado()
                        {
                            OrigemAuditado = OrigemAuditado.Sistema,
                            TipoAuditado = TipoAuditado.Sistema
                        };

                        SalvarDadosTransporteCarga(dadosTransporte, out mensagemErro, usuario: null, liberarComProblemaIntegracaoGrMotoristaVeiculo: false, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador, webServiceConsultaCTe: string.Empty, cliente: null, auditado, unitOfWork);

                        if (!string.IsNullOrWhiteSpace(mensagemErro))
                            throw new ServicoException(mensagemErro);
                    }
                    catch (Exception excecao)
                    {
                        Log.TratarErro(excecao);
                    }
                    finally
                    {
                        carga.AguardandoSalvarDadosTransporteCarga = false;
                        repositorioCarga.Atualizar(carga);
                    }
                }
            }
            catch (Exception excecao)
            {
                Log.TratarErro(excecao);
            }
        }

        public void VerificarAlertaInicioViagemMotorista(Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Configuracoes.ConfiguracaoMobile repConfiguracaoMobile = new Repositorio.Embarcador.Configuracoes.ConfiguracaoMobile(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoMobile configMobile = repConfiguracaoMobile.BuscarConfiguracaoPadrao();
            if (!configMobile.HabilitarAlertaMotorista)
                return;

            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            List<Dominio.Entidades.Embarcador.Cargas.Carga> cargas = repositorioCarga.BuscarPorCargasComAlertaViagemPendente(configMobile.MinutosNotificarAlertaMotoristaViagem);

            foreach (Dominio.Entidades.Embarcador.Cargas.Carga carga in cargas)
            {
                Servicos.Embarcador.Notificacao.NotificacaoMTrack serAlerta = new Servicos.Embarcador.Notificacao.NotificacaoMTrack(unitOfWork);
                foreach (Dominio.Entidades.Usuario motorista in carga.Motoristas)
                {
                    string msg = $"{string.Format(Localization.Resources.Cargas.Carga.AlertaInicioViagemMotorista)}. {string.Format(Localization.Resources.Gerais.Geral.Carga)}: {carga.CodigoCargaEmbarcador}. {string.Format(Localization.Resources.Gerais.Geral.Cliente)}: {carga.DadosSumarizados.Remetentes} ";
                    serAlerta.NotificarPushGenerica(motorista, msg);
                }
                ;

                carga.JaEnviouAlertaMotoristaViagem = true;
                repositorioCarga.Atualizar(carga);
                Servicos.Auditoria.Auditoria.Auditar(auditado, carga, carga.GetChanges(), string.Format(Localization.Resources.Cargas.Carga.EnviouNotificaoAlertaViagemMotorista), unitOfWork);
            }
        }

        public void VerificarCalculoFretePeloBIDPedidoOrigem(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            if (!(carga.TipoOperacao?.ConfiguracaoCalculoFrete?.CalcularFretePeloBIDPedidoOrigem ?? false))
                return;

            if (carga.SituacaoCarga != SituacaoCarga.CalculoFrete)
                return;

            Repositorio.Embarcador.Pedidos.PedidoAdicional repositorioPedidoAdicional = new Repositorio.Embarcador.Pedidos.PedidoAdicional(unitOfWork);
            Repositorio.Embarcador.CotacaoPedido.CotacaoPedido repositorioCotacaoPedido = new Repositorio.Embarcador.CotacaoPedido.CotacaoPedido(unitOfWork);

            int codigoPedido = cargaPedidos.Select(o => o.Pedido.Codigo).FirstOrDefault();

            Dominio.Entidades.Embarcador.Pedidos.PedidoAdicional pedidoAdicional = repositorioPedidoAdicional.BuscarPorPedido(codigoPedido);

            if (!carga.PossuiPendencia)
            {
                carga.TipoFreteEscolhido = TipoFreteEscolhido.Embarcador;
                carga.CalculandoFrete = false;
                carga.DataInicioCalculoFrete = null;
            }

            if (pedidoAdicional.PedidoOrigem == null)
            {
                carga.PossuiPendencia = true;
                carga.MotivoPendencia = "Não foi possível realizar o cálculo de frete. Necessário informar o Pedido de Origem.";

                return;
            }

            if (!repositorioCotacaoPedido.ExisteCotacaoPorPedidoTransportador(pedidoAdicional.PedidoOrigem.Codigo, carga.Empresa.Codigo))
            {
                carga.PossuiPendencia = true;
                carga.MotivoPendencia = "Não foi possível realizar o cálculo de frete, pois o Transportador da carga não possui BID cadastrado no Pedido de Origem.";

                return;
            }

            carga.PossuiPendencia = false;
            carga.MotivoPendencia = string.Empty;
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga AtualizarStatusCustoExtra(Dominio.Entidades.Embarcador.Cargas.Carga carga, Hubs.Carga svcHubCarga, Repositorio.Embarcador.Cargas.Carga repCarga)
        {
            bool utilizarDirecionamentoCustoExtra = repCarga.CargaUtilizaDirecionamentoCustoExtra(carga.Codigo);
            if (utilizarDirecionamentoCustoExtra)
            {
                carga = repCarga.BuscarPorCodigo(carga.Codigo);
                AlterarStatusCustoExtra(carga, carga.TipoOperacao?.ConfiguracaoCarga?.DirecionamentoCustoExtra ?? TipoDirecionamentoCustoExtra.Nenhum);
                repCarga.Atualizar(carga);
                svcHubCarga.InformarCargaAtualizada(carga.Codigo, TipoAcaoCarga.Alterada, string.Empty);
            }

            return carga;
        }

        public void SetarPedidoCritico(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.Pedido repositorioPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);

            if (!(cargaPedido.Pedido.PedidoCritico ?? false))
                cargaPedido.Pedido.PedidoCritico = true;
            else
                cargaPedido.Pedido.PedidoCritico = false;

            repositorioPedido.Atualizar(cargaPedido.Pedido);

            SetarCargaCriticaSePossuirPedidoCritico(cargaPedido.Carga, auditado, unitOfWork);
        }

        public void SetarCargaCriticaSePossuirPedidoCritico(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Logistica.Monitoramento repositorioMonitoramento = new Repositorio.Embarcador.Logistica.Monitoramento(unitOfWork);

            bool cargaPossuiAlgumPedidoCritico = carga.Pedidos.Any(pedido => pedido.Pedido.PedidoCritico ?? false);
            Dominio.Entidades.Embarcador.Logistica.Monitoramento monitoramento = repositorioMonitoramento.BuscarUltimoPorCarga(carga.Codigo);

            if (cargaPossuiAlgumPedidoCritico && (!carga.CargaCritica ?? false))
            {
                carga.CargaCritica = true;
                Servicos.Auditoria.Auditoria.Auditar(auditado, carga, null, $"Carga marcada como crítica porque contém algum pedido crítico.", unitOfWork);
            }
            else if ((!cargaPossuiAlgumPedidoCritico) && (carga.CargaCritica ?? false))
                carga.CargaCritica = false;

            if (monitoramento != null)
            {
                monitoramento.Critico = carga.CargaCritica ?? false;
                repositorioMonitoramento.Atualizar(monitoramento);
            }

            repositorioCarga.Atualizar(carga);
        }

        #endregion Métodos Públicos Estáticos

        #region Métodos Privados

        private void AjustarParticipantesPedidoCTeEmitidoEmbarcador(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe repCargaPedidoDocumentoCTe = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe(unitOfWork);
            Servicos.Embarcador.Pedido.Pedido serPedido = new Servicos.Embarcador.Pedido.Pedido(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe> cargaPedidoDocumentosCTe = repCargaPedidoDocumentoCTe.BuscarPorCargaPedidoParaVinculoCarga(cargaPedido);

            if (cargaPedidoDocumentosCTe.Count() > 0)
            {
                Dominio.Entidades.Embarcador.Pedidos.Pedido pedido = cargaPedido.Pedido;
                Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = cargaPedidoDocumentosCTe.FirstOrDefault().CTe;

                pedido.Remetente = cte.Remetente?.Cliente;
                pedido.Destinatario = cte.Destinatario?.Cliente;
                pedido.Recebedor = cte.Recebedor?.Cliente;
                pedido.Expedidor = cte.Expedidor?.Cliente;
                pedido.Tomador = cte.Tomador?.Cliente;

                Dominio.Entidades.Embarcador.Pedidos.PedidoEndereco pedidoEnderecoOrigem = new Dominio.Entidades.Embarcador.Pedidos.PedidoEndereco();
                if (pedido.Expedidor != null)
                    serPedido.PreecherEnderecoPedido(ref pedidoEnderecoOrigem, pedido.Expedidor);
                else if (pedido.Remetente != null)
                    serPedido.PreecherEnderecoPedido(ref pedidoEnderecoOrigem, pedido.Remetente);
                else
                    pedidoEnderecoOrigem = null;

                pedido.EnderecoOrigem = pedidoEnderecoOrigem;

                Dominio.Entidades.Embarcador.Pedidos.PedidoEndereco pedidoEnderecoDestino = new Dominio.Entidades.Embarcador.Pedidos.PedidoEndereco();
                if (pedido.Recebedor != null)
                    serPedido.PreecherEnderecoPedido(ref pedidoEnderecoDestino, pedido.Recebedor);
                else if (pedido.Destinatario != null)
                    serPedido.PreecherEnderecoPedido(ref pedidoEnderecoDestino, pedido.Destinatario);
                else
                    pedidoEnderecoDestino = null;

                pedido.EnderecoDestino = pedidoEnderecoDestino;

                Dominio.Entidades.Embarcador.Pedidos.PedidoEndereco pedidoEnderecoExpedidor = new Dominio.Entidades.Embarcador.Pedidos.PedidoEndereco();
                if (pedido.Expedidor != null)
                    serPedido.PreecherEnderecoPedido(ref pedidoEnderecoExpedidor, pedido.Expedidor);
                else
                    pedidoEnderecoExpedidor = null;

                pedido.EnderecoExpedidor = pedidoEnderecoExpedidor;

                Dominio.Entidades.Embarcador.Pedidos.PedidoEndereco pedidoEnderecoRecebedor = new Dominio.Entidades.Embarcador.Pedidos.PedidoEndereco();
                if (pedido.Recebedor != null)
                    serPedido.PreecherEnderecoPedido(ref pedidoEnderecoRecebedor, pedido.Recebedor);
                else
                    pedidoEnderecoRecebedor = null;
                pedido.EnderecoRecebedor = pedidoEnderecoRecebedor;

                repPedido.Atualizar(pedido);
            }
        }

        private void SetarPesoCargaPedidosCargaFilhoConsolidadoSemIrrelevancia(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, decimal peso, decimal pesoLiquido, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);

            if (peso > 0)
                cargaPedido.Peso = peso;

            if (pesoLiquido > 0)
                cargaPedido.PesoLiquido = pesoLiquido;

            repCargaPedido.Atualizar(cargaPedido);

            if (cargaPedido.CargaPedidoProximoTrecho != null)
                SetarPesoCargaPedidosCargaFilhoConsolidadoSemIrrelevancia(cargaPedido.CargaPedidoProximoTrecho, peso, pesoLiquido, unitOfWork);
        }

        private bool PermitirEmitirCTe(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS)
        {
            //quando o frete é de responsabilidade do cliente não faz a emissão dos documento
            return ((carga.TipoFreteEscolhido != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Cliente) && !configuracaoTMS.NaoEmitirDocumentoNasCargas);
        }

        private void ValidarEmissaoCargaComValorZerado(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, Repositorio.UnitOfWork unitOfWork)
        {
            if (carga.CargaTransbordo)
                return;

            if (!PermitirEmitirCTe(carga, configuracaoTMS))
                return;

            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);

            if (repositorioCargaPedido.ExisteCTeEmitidoNoEmbarcador(carga.Codigo))
                return;

            if ((configuracaoTMS.NaoPermitirValorFreteLiquidoZerado || (carga.TipoOperacao?.NaoPermitirValorFreteLiquidoZerado ?? false)) && (carga.ValorFreteLiquido <= 0m) && (repositorioCargaPedido.VerificarSeNaoPossuiPedidoLiberadoSemNFe(carga.Codigo) > 0))
                throw new ServicoException("Não é permitido emitir uma carga com o valor do frete líquido zerado.");

            if (configuracaoTMS.NaoEmitirCargaComValorZerado || configuracaoTMS.NaoGerarCTesComValoresZerados || (carga.TipoOperacao?.NaoEmitirCargaComValorZerado ?? false))
            {
                if (!carga.EmitirCTeComplementar)
                {
                    if (repositorioCargaPedido.VerificarSePossuiValorZerado(carga.Codigo) > 0)
                        throw new ServicoException("Não é possível emitir a carga enquanto seus pedidos estiverem sem valor de frete, por favor verifique a tabela de frete pois ele não deve conter valores cadastrados.");
                }
                else
                {
                    Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao repositorioPedidoCTeParaSubcontratacao = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao(unitOfWork);

                    if (repositorioPedidoCTeParaSubcontratacao.VerificarPorCargaSePossuiValorZerado(carga.Codigo) > 0)
                        throw new ServicoException("O valor do rateio entre os complementos ficou muito baixo e alguns ct-es não tem valor, desta forma não é permitido emitir, ajuste o valor do frete ou remova os CT-es de menor peso para que sejam ignorados no rateio.");
                }

                if (carga.EmpresaFilialEmissora != null && carga.TabelaFreteFilialEmissora == null && carga.ValorFreteTabelaFreteFilialEmissora == 0 && carga.ValorFreteFilialEmissora == 0 && carga.ValorFreteAPagarFilialEmissora == 0)
                    throw new ServicoException("Não encontrou tabela de frete filial emissora. Favor verificar.");
            }
        }

        private void DefinirRelevanciaParaFreteNotasFiscais(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> pedidosXmlNotaFiscal, Repositorio.UnitOfWork unitOfWork)
        {
            if (!(carga.TipoOperacao?.ConfiguracaoCarga?.ExecutarCalculoRelevanciaDeCustoNFePorCFOP ?? false))
                return;

            Repositorio.CFOP repositorioCFOP = new Repositorio.CFOP(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoStage repositorioPedidoStage = new Repositorio.Embarcador.Pedidos.PedidoStage(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repositorioXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoStage> pedidosStage = repositorioPedidoStage.BuscarComRelevanciaCustoPorCargaDT(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Pedidos.Stage> stages = pedidosStage.Select(pedidoStage => pedidoStage.Stage).Distinct().ToList();
            List<int> codigosCFOP = pedidosXmlNotaFiscal.Select(notaPorPedido => notaPorPedido.XMLNotaFiscal.CFOP.ToInt()).Distinct().ToList();
            List<Dominio.Entidades.CFOP> listaCfop = repositorioCFOP.BuscarPorNumeros(codigosCFOP);

            foreach (Dominio.Entidades.Embarcador.Pedidos.Stage stage in stages)
            {
                List<int> codigosPedidosPorStage = pedidosStage.Where(pedidoStage => pedidoStage.Stage.Codigo == stage.Codigo).Select(pedidoStage => pedidoStage.Pedido.Codigo).ToList();
                List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> pedidosXmlNotaFiscalPorStage = pedidosXmlNotaFiscal.Where(notaPorPedido => codigosPedidosPorStage.Contains(notaPorPedido.CargaPedido.Pedido.Codigo)).ToList();
                List<int> listaCodigosCfopNotasFiscais = pedidosXmlNotaFiscalPorStage.Select(notaPorPedido => notaPorPedido.XMLNotaFiscal.CFOP.ToInt()).ToList();
                int grupoPrioridadeRelevante = listaCfop.Where(cfop => listaCodigosCfopNotasFiscais.Contains(cfop.CodigoCFOP) && cfop.GrupoPrioridade > 0).Min(cfop => (int?)cfop.GrupoPrioridade) ?? 0;

                foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscal in pedidosXmlNotaFiscalPorStage)
                {
                    Dominio.Entidades.CFOP cfopNotaFiscal = listaCfop.Where(cfop => cfop.CodigoCFOP == pedidoXMLNotaFiscal.XMLNotaFiscal.CFOP.ToInt()).FirstOrDefault();

                    pedidoXMLNotaFiscal.XMLNotaFiscal.IrrelevanteParaFrete = !stage.RelevanciaCusto || ((grupoPrioridadeRelevante > 0) && (cfopNotaFiscal?.GrupoPrioridade != grupoPrioridadeRelevante));

                    repositorioXMLNotaFiscal.Atualizar(pedidoXMLNotaFiscal.XMLNotaFiscal);
                }
            }

            if (stages?.Count <= 0 && carga.DadosSumarizados?.CargaTrecho == CargaTrechoSumarizada.SubCarga)//para cargas do consolidado
            {
                foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedxml in pedidosXmlNotaFiscal)
                {
                    pedxml.XMLNotaFiscal.IrrelevanteParaFrete = false;
                    repositorioXMLNotaFiscal.Atualizar(pedxml.XMLNotaFiscal);
                }
            }

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = pedidosXmlNotaFiscal.Select(notaPorPedido => notaPorPedido.CargaPedido).Distinct().ToList();

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
            {
                List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> xmlNotasFiscaisIrrelevantesParaFrete = pedidosXmlNotaFiscal.Where(notaPorPedido => notaPorPedido.XMLNotaFiscal.IrrelevanteParaFrete && notaPorPedido.CargaPedido.Codigo == cargaPedido.Codigo).Select(notaPorPedido => notaPorPedido.XMLNotaFiscal).ToList();

                cargaPedido.PesoMercadoriaDescontar = xmlNotasFiscaisIrrelevantesParaFrete.Sum(notaFiscal => notaFiscal.PesoLiquido);
                cargaPedido.ValorMercadoriaDescontar = xmlNotasFiscaisIrrelevantesParaFrete.Sum(notaFiscal => notaFiscal.ValorTotalProdutos);

                repositorioCargaPedido.Atualizar(cargaPedido);
            }
        }

        private bool ExisteOrigemComTodasNotasRecebidas(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            List<double> cpfCnpjRemetentes = cargaPedidos.Where(o => o.Expedidor == null).Select(o => o.Pedido.Remetente.CPF_CNPJ).ToList();
            List<double> cpfCnpjExpedidores = cargaPedidos.Where(o => o.Expedidor != null).Select(o => o.Expedidor.CPF_CNPJ).ToList();

            foreach (double cpfCnpjRemetente in cpfCnpjRemetentes)
            {
                if (repositorioCargaPedido.VerificarSeTodosPedidosEstaoAutorizadosPorCargaRemetente(carga.Codigo, cpfCnpjRemetente))
                    return true;
            }

            foreach (double cpfCnpjExpedidor in cpfCnpjExpedidores)
            {
                if (repositorioCargaPedido.VerificarSeTodosPedidosEstaoAutorizadosPorCargaExpedidor(carga.Codigo, cpfCnpjExpedidor))
                    return true;
            }

            return false;
        }

        private void VisibilidadeDosPedidosNaMontagemCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos, Repositorio.UnitOfWork unitOfWork, bool diponivel)
        {
            Repositorio.Embarcador.Pedidos.Pedido repositorioPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            foreach (Dominio.Entidades.Embarcador.Pedidos.Pedido pedido in pedidos)
            {
                pedido.PedidoTotalmenteCarregado = diponivel;
                repositorioPedido.Atualizar(pedido);
            }
        }

        public void AutorizarGeracaoCargaStageAgrupamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.StageAgrupamento repStageAgrupamento = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);
            Repositorio.Embarcador.Pedidos.Stage repStage = new Repositorio.Embarcador.Pedidos.Stage(unitOfWork);

            repStageAgrupamento.AutorizarGeracaoCarga(carga.Codigo);
            repStage.AtualizarStageProcessadoPorCargaDT(carga.Codigo, true);
        }

        public void AutorizarGeracaoCargaStageAgrupamentoPreChekin(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.StageAgrupamento repStageAgrupamento = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);
            Repositorio.Embarcador.Pedidos.Stage repStage = new Repositorio.Embarcador.Pedidos.Stage(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            carga.StagesGeradas = false;
            repCarga.Atualizar(carga);

            repStageAgrupamento.AutorizarGeracaoCargaPrecheckin(carga.Codigo);
            repStage.AtualizarStageProcessadoPorCargaDT(carga.Codigo, true);

        }

        public string ValidarPreCalculoCargasFilho(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.StageAgrupamento repStageAgrupamento = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento> stageAgrupamentosDT = repStageAgrupamento.BuscarPorCargaDt(carga.Codigo);

            string retorno = "";
            if (stageAgrupamentosDT != null && stageAgrupamentosDT.Count() > 0 && stageAgrupamentosDT.Any(obj => !string.IsNullOrEmpty(obj.MensagemRetornoDadosFrete)))
                retorno = stageAgrupamentosDT.Where(obj => !string.IsNullOrEmpty(obj.MensagemRetornoDadosFrete)).Select(obj => obj.MensagemRetornoDadosFrete).FirstOrDefault();

            return retorno;
        }

        public void CriarValoresFreteCargaFilhoConsolidacaoAutorizacaoEmissao(Dominio.Entidades.Embarcador.Cargas.Carga cargaDT, Dominio.Entidades.Embarcador.Cargas.Carga cargaGerada, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.StageAgrupamento repStageAgrupamento = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            Servicos.Embarcador.Carga.ICMS serCargaICMS = new Servicos.Embarcador.Carga.ICMS(unitOfWork);
            Servicos.Embarcador.Carga.ComponetesFrete svcComponenteFrete = new Servicos.Embarcador.Carga.ComponetesFrete(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento> stageAgrupamentosDT = repStageAgrupamento.BuscarPorCargaDt(cargaDT.Codigo);

            if (cargaDT != null && cargaDT.TipoOperacao?.TipoConsolidacao == EnumTipoConsolidacao.AutorizacaoEmissao)
            {
                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidoCarga = repCargaPedido.BuscarPorCarga(cargaDT.Codigo);
                List<int> codigosPedido = cargaPedidoCarga.Select(x => x.Pedido.Codigo).ToList();

                svcComponenteFrete.RemoverComponentesCarga(cargaGerada, unitOfWork);

                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidoCargaGerada = repCargaPedido.BuscarPorCargaEPedidos(cargaGerada.Codigo, codigosPedido);
                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoGerado in cargaPedidoCargaGerada)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidosDoPedido = repCargaPedido.BuscarPorCargaEPedido(cargaDT.Codigo, cargaPedidoGerado.Pedido.Codigo);

                    cargaPedidoGerado.ValorFrete = cargaPedidosDoPedido.ValorFrete;
                    cargaPedidoGerado.ValorBaseFrete = cargaPedidosDoPedido.ValorBaseFrete;
                    cargaPedidoGerado.ValorFreteAPagar = cargaPedidosDoPedido.ValorFreteAPagar;
                    cargaPedidoGerado.Peso = cargaPedidosDoPedido.Peso;
                    cargaPedidoGerado.PesoLiquido = cargaPedidosDoPedido.PesoLiquido;

                    //criar/validar os componentes do frete do cargaPedidoPai para o cargaPedidoFilho
                    RecriarComponentesFreteCargaPedidoConsolidadoEmissao(cargaPedidosDoPedido, cargaPedidoGerado, unitOfWork);
                }

                // RecriarComponentesFreteCargaConsolidadoEmissao(cargaDT, stageAgrupamentosDT.Select(x => x.CargaGerada.Codigo).ToList(), unitOfWork);

                ////quando todos estao calculados calcular imposto da carga mae
                //bool NaoPodeCalcularImpostoCargaMae = agrupamentosDemaisCargas.Any(x => x.CargaGerada == null || x.CargaGerada.ValorFrete <= 0);
                //if (!NaoPodeCalcularImpostoCargaMae)
                //{
                //    List<Dominio.Entidades.Embarcador.Cargas.Carga> cargasOrigemMae = Servicos.Embarcador.Carga.Carga.ObterCargasOrigem(cargaPai, unitOfWork);
                //    List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> pedidosAgrupados = repCargaPedido.BuscarPorCarga(cargaPai.Codigo);
                //    List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete> cargaPedidosComponentesFreteCarga = repCargaPedidoComponenteFrete.BuscarPorCarga(cargaPai.Codigo, false);
                //    List<Dominio.Entidades.Embarcador.ICMS.PedagioEstadoBaseCalculo> pedagioEstadosBaseCalculo = repPedagioEstadoBaseCalculo.BuscarPorEstados((from obj in pedidosAgrupados select obj.Origem.Estado.Sigla).Distinct().ToList());
                //    List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoProduto> cargaPedidoProdutos = serCargaICMS.ObterProdutosCargaContidosEmRegras(cargaPai, unitOfWork);
                //    List<Dominio.ObjetosDeValor.Embarcador.ICMS.TabelaAliquota> tabelaAliquotas = new List<Dominio.ObjetosDeValor.Embarcador.ICMS.TabelaAliquota>();
                //    List<Dominio.Entidades.Cliente> tomadoresFilialEmissora = Servicos.Embarcador.Carga.FilialEmissora.ObterTomadoresFilialEmissora((from obj in pedidosAgrupados where obj.CargaPedidoFilialEmissora select obj.CargaOrigem.EmpresaFilialEmissora.CNPJ_SemFormato).Distinct().ToList(), unitOfWork);
                //    List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedido> cargaPedidosValoresNotas = repPedidoXMLNotaFiscal.BuscarTotalSumarizadoPorCarga(cargaPai.Codigo);
                //    Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoTabelaFrete configuracaoTabelaFrete = repositorioConfiguracaoTabelaFrete.BuscarPrimeiroRegistro();

                //    serCargaRateio.CalcularImpostosAgrupados(ref cargaPai, cargasOrigemMae, pedidosAgrupados, false, TipoServicoMultisoftware, unitOfWork, configuracaoEmbarcador, cargaPedidosComponentesFreteCarga, pedagioEstadosBaseCalculo, cargaPedidoProdutos, tabelaAliquotas, tomadoresFilialEmissora, cargaPedidosValoresNotas, configuracaoTabelaFrete);
                //}


                repCarga.Atualizar(cargaGerada);

            }


        }

        public List<Dominio.ObjetosDeValor.Embarcador.Pedido.ProdutoDivergente> VerificarDivergenciaProdutosEsperadoVSRecebidos(int codigoCarga)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(_unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoProduto repCargaPedidoProduto = new Repositorio.Embarcador.Cargas.CargaPedidoProduto(_unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoProduto repPedidoProduto = new Repositorio.Embarcador.Pedidos.PedidoProduto(_unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(_unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoProdutoLote repositorioPedidoProdutoLote = new Repositorio.Embarcador.Pedidos.PedidoProdutoLote(_unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscalProdutoLote repositorioXMLNotaFiscalProdutoLote = new Repositorio.Embarcador.Pedidos.XMLNotaFiscalProdutoLote(_unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscalProduto repositorioXMLNotaFiscalProduto = new Repositorio.Embarcador.Pedidos.XMLNotaFiscalProduto(_unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repositorioPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(_unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repositorioConfiguracaoGeral = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(_unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = repositorioConfiguracaoGeral.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigo(codigoCarga);

            List<Dominio.ObjetosDeValor.Embarcador.Pedido.ProdutoDivergente> produtosDivergentes = new List<Dominio.ObjetosDeValor.Embarcador.Pedido.ProdutoDivergente>();

            if (!configuracaoTMS.AtualizarProdutosPedidoPorIntegracao)
                return produtosDivergentes;

            bool permiteValidarLoteProdutoVersusLoteNotaFiscal = carga.TipoOperacao?.ConfiguracaoCarga?.ValidarLoteProdutoVersusLoteNotaFiscal ?? false;

            if (!permiteValidarLoteProdutoVersusLoteNotaFiscal)
                return produtosDivergentes;

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoProduto> cargaPedidosProduto = repCargaPedidoProduto.BuscarPorCarga(codigoCarga);
            List<int> codigosPedidosCarga = repCargaPedido.BuscarCodigosPedidoPorCarga(codigoCarga);
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoProduto> pedidosProduto = repPedidoProduto.BuscarPorPedidos(codigosPedidosCarga);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> listaCargaPedido = repCargaPedido.BuscarPorPedido(pedidosProduto.Select(o => o.Pedido.Codigo).Distinct().ToList());
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> listaPedidoXMLNotaFiscal = repositorioPedidoXMLNotaFiscal.BuscarPorCargaPedido(listaCargaPedido.Select(o => o.Codigo).Distinct().ToList());
            List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscalProduto> listaXMLNotaFiscalProduto = repositorioXMLNotaFiscalProduto.BuscarPorNotaFiscal(listaPedidoXMLNotaFiscal.Select(o => o.XMLNotaFiscal.Codigo).Distinct().ToList());

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoProduto pedidoProduto in pedidosProduto)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaPedidoProduto cargaPedidoProduto = (from obj in cargaPedidosProduto where obj.CargaPedido.Pedido.Codigo == pedidoProduto.Pedido.Codigo && pedidoProduto.Produto.Codigo == obj.Produto.Codigo select obj).FirstOrDefault();

                string numeroLotePedidoProdutoLoteRecebido = string.Empty;
                string numeroLotePedidoProdutoLoteEsperado = string.Empty;

                if (permiteValidarLoteProdutoVersusLoteNotaFiscal)
                {
                    Dominio.Entidades.Embarcador.Pedidos.PedidoProdutoLote pedidoProdutoLote = repositorioPedidoProdutoLote.BuscarPedidoProdutosLotesPorPedidoProduto(pedidoProduto.Codigo);
                    numeroLotePedidoProdutoLoteEsperado = pedidoProdutoLote?.NumeroLote ?? string.Empty;

                    Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscalProdutoLote xmlNotaFiscalProdutoLote = repositorioXMLNotaFiscalProdutoLote.BuscarXMLNotaFiscalProdutoLotePorXMLNotaFiscalProduto(
                        listaXMLNotaFiscalProduto.Where(o => o.Produto.Codigo == pedidoProduto.Produto.Codigo).Select(a => a.Codigo).FirstOrDefault());

                    numeroLotePedidoProdutoLoteRecebido = xmlNotaFiscalProdutoLote?.NumeroLote ?? string.Empty;
                }

                if (cargaPedidoProduto == null)
                    produtosDivergentes.Add(GerarProdutoDivergente(pedidoProduto.Produto, pedidoProduto.Pedido.NumeroPedidoEmbarcador, pedidoProduto.Quantidade, 0, numeroLotePedidoProdutoLoteEsperado, numeroLotePedidoProdutoLoteRecebido));
                else if (cargaPedidoProduto.Quantidade != pedidoProduto.Quantidade)
                    produtosDivergentes.Add(GerarProdutoDivergente(pedidoProduto.Produto, pedidoProduto.Pedido.NumeroPedidoEmbarcador, pedidoProduto.Quantidade, cargaPedidoProduto.Quantidade, numeroLotePedidoProdutoLoteEsperado, numeroLotePedidoProdutoLoteRecebido));
                else if (numeroLotePedidoProdutoLoteEsperado != numeroLotePedidoProdutoLoteRecebido)
                    produtosDivergentes.Add(GerarProdutoDivergente(pedidoProduto.Produto, pedidoProduto.Pedido.NumeroPedidoEmbarcador, pedidoProduto.Quantidade, cargaPedidoProduto.Quantidade, numeroLotePedidoProdutoLoteEsperado, numeroLotePedidoProdutoLoteRecebido));
            }

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoProduto cargaPedidoProduto in cargaPedidosProduto)
            {
                Dominio.Entidades.Embarcador.Pedidos.PedidoProduto pedidoProduto = (from obj in pedidosProduto where obj.Pedido.Codigo == cargaPedidoProduto.CargaPedido.Pedido.Codigo && obj.Produto.Codigo == cargaPedidoProduto.Produto.Codigo select obj).FirstOrDefault();

                string numeroLotePedidoProdutoLoteRecebido = string.Empty;
                string numeroLotePedidoProdutoLoteEsperado = string.Empty;

                if (permiteValidarLoteProdutoVersusLoteNotaFiscal)
                {
                    Dominio.Entidades.Embarcador.Pedidos.PedidoProdutoLote pedidoProdutoLote = repositorioPedidoProdutoLote.BuscarPedidoProdutosLotesPorPedidoProduto(pedidoProduto.Codigo);
                    numeroLotePedidoProdutoLoteEsperado = pedidoProdutoLote?.NumeroLote ?? string.Empty;

                    Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscalProdutoLote xmlNotaFiscalProdutoLote = repositorioXMLNotaFiscalProdutoLote.BuscarXMLNotaFiscalProdutoLotePorXMLNotaFiscalProduto(
                        listaXMLNotaFiscalProduto.Where(o => o.Produto.Codigo == pedidoProduto.Produto.Codigo).Select(a => a.Codigo).FirstOrDefault());
                    numeroLotePedidoProdutoLoteRecebido = xmlNotaFiscalProdutoLote?.NumeroLote ?? string.Empty;
                }

                if (pedidoProduto == null)
                    produtosDivergentes.Add(GerarProdutoDivergente(cargaPedidoProduto.Produto, cargaPedidoProduto.CargaPedido.Pedido.NumeroPedidoEmbarcador, 0, cargaPedidoProduto.Quantidade, numeroLotePedidoProdutoLoteEsperado, numeroLotePedidoProdutoLoteRecebido));
            }

            return produtosDivergentes;
        }

        public Dominio.ObjetosDeValor.Embarcador.Pedido.ProdutoDivergente GerarProdutoDivergente(Dominio.Entidades.Embarcador.Produtos.ProdutoEmbarcador produto, string pedido, decimal quantidadeEsperada, decimal quantidadeRecebida, string numeroLotePedidoProdutoLoteEsperado, string numeroLotePedidoProdutoLoteRecebido)
        {
            Dominio.ObjetosDeValor.Embarcador.Pedido.ProdutoDivergente produtoDivergente = new Dominio.ObjetosDeValor.Embarcador.Pedido.ProdutoDivergente();
            produtoDivergente.Produto = produto.CodigoProdutoEmbarcador + " - " + produto.Descricao;
            produtoDivergente.Pedido = pedido;
            produtoDivergente.QuantidadeEsperada = quantidadeEsperada.ToString("n2");
            produtoDivergente.QuantidadeRecebida = quantidadeRecebida.ToString("n2");
            produtoDivergente.NumeroLotePedidoProdutoLoteEsperado = numeroLotePedidoProdutoLoteEsperado;
            produtoDivergente.NumeroLotePedidoProdutoLoteRecebido = numeroLotePedidoProdutoLoteRecebido;
            return produtoDivergente;
        }

        public object ConfirmarEnvioDosDocumentos(Dominio.Entidades.Embarcador.Cargas.Carga carga, bool naoValidarApolice, bool liberouProdutosDivergentes, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, List<AdminMultisoftware.Dominio.Enumeradores.PermissaoPersonalizada> permissoesPersonalizadas, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, string webServiceConsultaCTe, Dominio.Entidades.Usuario usuario, UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaMDFe repCargaMDFe = new Repositorio.Embarcador.Cargas.CargaMDFe(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.TipoOperacao repTipoOperacao = new Repositorio.Embarcador.Pedidos.TipoOperacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga repConfigGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork);
            Repositorio.Embarcador.Configuracoes.IntegracaoIntercab repIntegracaoIntercab = new Repositorio.Embarcador.Configuracoes.IntegracaoIntercab(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab = repIntegracaoIntercab.BuscarIntegracao();
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao(); ;


            bool validarApoliceConfig = repConfigGeralCarga.BuscarPrimeiroRegistro().ValidarValorLimiteApoliceComValorNFe;

            if (carga?.CargaBloqueadaParaEdicaoIntegracao ?? false)
                throw new ServicoException("Não é possível avançar a etapa a carga está bloqueada.");

            if (!permissoesPersonalizadas.Contains(AdminMultisoftware.Dominio.Enumeradores.PermissaoPersonalizada.Carga_InformarDocumentosFiscais))
            {
                if (tipoServicoMultisoftware != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe || (!(carga?.TipoOperacao?.PermitirTransportadorEnviarNotasFiscais ?? false)))
                    throw new ServicoException("Você não possui permissões para executar esta ação.");
            }

            if (carga.ProblemaIntegracaoGrMotoristaVeiculo && !string.IsNullOrWhiteSpace(carga.MensagemProblemaIntegracaoGrMotoristaVeiculo))
            {
                if (!permissoesPersonalizadas.Contains(AdminMultisoftware.Dominio.Enumeradores.PermissaoPersonalizada.Carga_PermiteLiberarSemIntegracaoGR))
                    throw new ServicoException("Seu usuário não possui permissão para liberar a carga sem a integração da GR. Último retorno da gerenciadora: " + carga.MensagemProblemaIntegracaoGrMotoristaVeiculo);
            }

            if (validarApoliceConfig && !naoValidarApolice)
            {
                Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repApoliceSeguro = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);

                decimal valorTotalNFs = repPedidoXMLNotaFiscal.BuscarTotalPorCarga(carga.Codigo);
                Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro apolice = repApoliceSeguro.BuscarPorCarga(carga.Codigo).FirstOrDefault()?.ApoliceSeguro ?? null;

                if (apolice != null && apolice.ValorLimiteApolice < valorTotalNFs)
                {
                    Servicos.Embarcador.Carga.MensagemAlertaCarga servicoMensagemAlerta = new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork);
                    Dominio.Entidades.Embarcador.Cargas.MensagemAlertaCarga alerta = servicoMensagemAlerta.AdicionarNaoDuplicado(carga, TipoMensagemAlerta.DivergenciaValorLimiteApolice, $"Valor limite da apólice (R${apolice.ValorLimiteApolice.ToString("n2")}) é menor que o valor total das notas (R${valorTotalNFs.ToString("n2")}). Verifique o cadastro da apólice.", true);

                    carga.PendenciaValorLimiteApolice = true;
                    repositorioCarga.Atualizar(carga);
                    unitOfWork.CommitChanges();

                    return (new
                    {
                        ErroApolice = true,
                        MensagemAlerta = servicoMensagemAlerta.ObterMensagemAlertaBase(alerta),
                    }, true, "Valor limite da apólice é menor que o valor das notas. Verifique o cadastro da apólice.");
                }
            }

            if ((carga.TipoOperacao?.ObrigatorioVincularContainerCarga ?? false) && tipoServicoMultisoftware != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
            {
                List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedidoNotaFiscal> cargaPedidoNotaFiscals = repPedidoXMLNotaFiscal.BuscarPedidoXMLNotaFiscal(carga.Codigo);
                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo);

                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
                {
                    if (cargaPedidoNotaFiscals.Where(o => o.CargaPedido == cargaPedido.Codigo).Count() == 0)
                    {
                        cargaPedido.PedidoSemNFe = true;
                        repCargaPedido.Atualizar(cargaPedido);
                    }
                }
            }

            if (carga?.TipoOperacao?.ConfiguracaoCarga?.ValidarPesoDasNotasRelevantes ?? false)
            {
                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosDaCarga = carga.Pedidos.ToList();
                Repositorio.Embarcador.Pedidos.PedidoStage repositorioPedidoStage = new Repositorio.Embarcador.Pedidos.PedidoStage(unitOfWork);
                List<Dominio.Entidades.Embarcador.Pedidos.PedidoStage> pedidosStage = repositorioPedidoStage.BuscarComRelevanciaCustoPorCargaDT(carga.Codigo);
                List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> pedidoXmlNotaFiscal = repPedidoXMLNotaFiscal.BuscarPorPedidos(pedidosStage.Select(x => x.Pedido.Codigo).Distinct().ToList());

                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidosDaCarga)
                {
                    Dominio.Entidades.Embarcador.Cargas.ModeloVeicularCarga modeloVeicularCarga = pedidosStage.Where(x => x.Pedido.Codigo == cargaPedido.Pedido.Codigo && x.Stage.ModeloVeicularCarga != null).Select(x => x.Stage.ModeloVeicularCarga).FirstOrDefault();

                    if (modeloVeicularCarga == null)
                        modeloVeicularCarga = carga.ModeloVeicularCarga;

                    decimal pesoTotalPedido = pedidoXmlNotaFiscal.Where(x => x.CargaPedido.Codigo == cargaPedido.Codigo && x.XMLNotaFiscal != null).Select(x => x.XMLNotaFiscal.PesoLiquido).Sum();

                    if (modeloVeicularCarga.UnidadeCapacidade != UnidadeCapacidade.Peso)
                        continue;

                    if (pesoTotalPedido < modeloVeicularCarga.ToleranciaPesoMenor || pesoTotalPedido > modeloVeicularCarga.ToleranciaPesoExtra)
                        throw new ServicoException("Tolerância fora das permitidas pelo modelo veicular.");
                }
            }

            if (carga.TipoOperacao?.ConfiguracaoCalculoFrete?.ImportarVeiculoMDFEEmbarcador ?? false)
            {
                string erroMDFE = string.Empty;
                Dominio.Entidades.Veiculo veiculoMDFE = new Dominio.Entidades.Veiculo();
                veiculoMDFE = BuscaVeiculoMDFECarga(carga, out erroMDFE, unitOfWork);
                if (veiculoMDFE != null)
                {
                    carga.Veiculo = veiculoMDFE;
                    repositorioCarga.Atualizar(carga);
                }
                else if (!string.IsNullOrEmpty(erroMDFE))
                {
                    throw new ServicoException(erroMDFE);
                }
            }

            if ((carga?.TipoOperacao?.ConfiguracaoCalculoFrete?.NecessarioAguardarVinculoNotadeRemessaIndustrializador ?? false))
            {
                List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> notasCargas = repPedidoXMLNotaFiscal.BuscarNotasFiscaisPorCarga(carga.Codigo);
                bool possuiNotaRemessa = notasCargas.Any(nota => nota.ClassificacaoNFe.HasValue || nota.TipoNotaFiscalIntegrada == TipoNotaFiscalIntegrada.OrdemVenda) && notasCargas.Count > 1;

                if (!possuiNotaRemessa)
                {
                    Servicos.Embarcador.Carga.MensagemAlertaCarga servisoMensagemAlerta = new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork);
                    List<Dominio.ObjetosDeValor.Embarcador.Alertas.MensagemAlerta> existeMensagems = servisoMensagemAlerta.ObterMensagensPorEntidades(new List<int> { carga.Codigo });

                    if ((existeMensagems == null || existeMensagems.Count == 0) || !existeMensagems.Any(m => m.Tipo == TipoMensagemAlerta.NotaVendaNaoRecebida))
                        servisoMensagemAlerta.Adicionar(carga, TipoMensagemAlerta.NotaVendaNaoRecebida, $"Para a carga avançar é necessário inserir as notas de venda e de remessa");

                    throw new ServicoException($"Para a carga avançar é necessário inserir as notas de venda e de remessa");
                }
                else
                    new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork).Confirmar(carga, TipoMensagemAlerta.NotaVendaNaoRecebida);
            }

            if (!Servicos.Embarcador.Carga.Carga.AvancarEtapaDocumentosEmissaoCarga(out string erro, carga.Codigo, liberouProdutosDivergentes, configuracaoTMS, tipoServicoMultisoftware, unitOfWork, permissoesPersonalizadas, usuario, auditado, true, naoValidarApolice))
            {
                AtualizarPendenciaDocumentoPortoPorto(carga, true, erro, unitOfWork);
                throw new ServicoException(erro);
            }
            else
                AtualizarPendenciaDocumentoPortoPorto(carga, false, "", unitOfWork);

            if (configuracaoTMS.EncerrarMDFesDeOutrasViagensAutomaticamente && !carga.NaoGerarMDFe && carga.Veiculo != null && !carga.ExigeConfirmacaoAntesEmissao)
            {
                List<Dominio.Entidades.Embarcador.Cargas.CargaMDFe> cargasMDFe = repCargaMDFe.BuscarPorCargaVeiculosMDFeNaoEncerrados(carga.Veiculo.Placa);

                foreach (Dominio.Entidades.Embarcador.Cargas.CargaMDFe cargaMDFe in cargasMDFe)
                {
                    if (
                        cargaMDFe.Carga.Codigo != carga.Codigo &&
                        cargaMDFe.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Autorizado &&
                        cargaMDFe.SistemaEmissor == SistemaEmissor.MultiCTe &&
                        !(cargaMDFe.Carga.TipoOperacao?.EncerrarMDFeManualmente ?? false)
                    )
                    {
                        Servicos.Auditoria.Auditoria.Auditar(auditado, cargaMDFe.Carga, null, $"Solicitou o encerramento do MDF-e, ao confirmar a placa na carga {carga.CodigoCargaEmbarcador}.", unitOfWork);
                        SolicitarEncerramentoMDFeAutomaticamente(cargaMDFe.Carga, unitOfWork, tipoServicoMultisoftware, webServiceConsultaCTe, auditado, usuario);
                    }
                }
            }

            AdicionarIntegracaoCargaFinalizada(carga, unitOfWork);

            bool encontrouTipoOperacao = false;
            bool alterouExpedidor = false;
            bool alterouRecebedor = false;

            Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoCarga = carga.Pedidos.FirstOrDefault();
            Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacao = null;

            if (integracaoIntercab != null && integracaoIntercab.PossuiIntegracaoIntercab && integracaoIntercab.SelecionarTipoOperacao && cargaPedidoCarga.Pedido.TipoPropostaCabotagem != TipoPropostaCabotagem.Feeder && !(cargaPedidoCarga.Carga?.CargaRecebidaDeIntegracao ?? false))
            {
                tipoOperacao = repTipoOperacao.BuscarTipoOperacaoIntegracaoIntercab(cargaPedidoCarga.Pedido.TipoTomadorCabotagem, cargaPedidoCarga.Pedido.TipoModalPropostaCabotagem, cargaPedidoCarga.Pedido.TipoPropostaCabotagem);

                if (tipoOperacao == null)
                    throw new ServicoException($"O Tipo de Operação informado ({cargaPedidoCarga.Pedido.TipoTomadorCabotagem.ObterDescricao()}/{cargaPedidoCarga.Pedido.TipoModalPropostaCabotagem.ObterDescricao()}/{cargaPedidoCarga.Pedido.TipoPropostaCabotagem.ObterDescricao()}) não está cadastrado no sistema.");

                if (cargaPedidoCarga.Pedido.TipoOperacao != null && cargaPedidoCarga.Pedido.TerminalOrigem != null && cargaPedidoCarga.Pedido.TerminalOrigem.Terminal != null
                    && (cargaPedidoCarga.Pedido.TipoOperacao.ImportarTerminalOrigemComoExpedidor || cargaPedidoCarga.Pedido.TipoOperacao.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortoPorta || cargaPedidoCarga.Pedido.TipoOperacao.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortoPorto))
                {
                    cargaPedidoCarga.Pedido.Expedidor = cargaPedidoCarga.Pedido.TerminalOrigem?.Terminal;
                    alterouExpedidor = true;
                }

                if (cargaPedidoCarga.Pedido.TipoOperacao != null && cargaPedidoCarga.Pedido.TerminalDestino != null && cargaPedidoCarga.Pedido.TerminalDestino.Terminal != null
                    && (cargaPedidoCarga.Pedido.TipoOperacao.ImportarTerminalDestinoComoRecebedor || cargaPedidoCarga.Pedido.TipoOperacao.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortaPorto || cargaPedidoCarga.Pedido.TipoOperacao.ModalPropostaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalPropostaMultimodal.PortoPorto))
                {
                    cargaPedidoCarga.Pedido.Recebedor = cargaPedidoCarga.Pedido.TerminalDestino?.Terminal;
                    alterouRecebedor = true;
                }

                if (alterouExpedidor && cargaPedidoCarga.Pedido.Expedidor == null)
                    throw new ServicoException($"O Tipo de Operação ({tipoOperacao.Descricao}) não permite avançar porque não foram encontradas informações de terminal portuário para o expedidor.");

                if (alterouRecebedor && cargaPedidoCarga.Pedido.Recebedor == null)
                    throw new ServicoException($"O Tipo de Operação ({tipoOperacao.Descricao}) não permite avançar porque não foram encontradas informações de terminal portuário para o recebedor.");
                encontrouTipoOperacao = true;

                carga.TipoOperacao = tipoOperacao;
                repositorioCarga.Atualizar(carga);

                repPedido.Atualizar(cargaPedidoCarga.Pedido);
            }

            if (encontrouTipoOperacao)
            {
                string mensagemTipoOperacao = $"Tipo de Operação ({tipoOperacao.Descricao}) vinculado à carga.";

                return
                    new
                    {
                        EncontrouTipoOperacao = true,
                        MensagemTipoOperacao = mensagemTipoOperacao
                    };
            }
            else
                return true;
        }

        public bool AdicionarIntegracaoCargaFinalizada(Dominio.Entidades.Embarcador.Cargas.Carga carga, UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaIntegracaoHUBOfertas repositorioCargaIntegracaoHUB = new Repositorio.Embarcador.Cargas.CargaIntegracaoHUBOfertas(unitOfWork);
            Dominio.Entidades.Embarcador.Cargas.TipoIntegracao tipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork).BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.HUB);

            if (tipoIntegracao == null)
                return false;

            try
            {
                Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoHUBOfertas integracao = repositorioCargaIntegracaoHUB.ConsultarIntegracaoCargaEnviadaHUB(carga.Codigo).GetAwaiter().GetResult();

                if (integracao == null)
                    return false;


                Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoHUBOfertas integracaoFinalizada = new Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoHUBOfertas
                {
                    SituacaoIntegracao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoIntegracao.AgIntegracao,
                    DataIntegracao = DateTime.Now,
                    TipoEnvioHUBOfertas = TipoEnvioHUBOfertas.FinalizacaoDemandaOferta,
                    NumeroTentativas = 0,
                    TipoIntegracao = tipoIntegracao,
                    Carga = carga,
                    ProblemaIntegracao = ""
                };

                repositorioCargaIntegracaoHUB.Inserir(integracaoFinalizada);
            }
            catch (Exception excecao)
            {
                Servicos.Log.GravarInfo($"Erro Adicionar Status Finalizado: {excecao.Message}", "HUBOfertas");
                return false;
            }
            return true;
        }

        private void RecriarComponentesFreteCargaPedidoConsolidadoEmissao(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoPai, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoFilho, Repositorio.UnitOfWork unitOfWork)
        {
            //com o carga Pedido da carga Pai, vamos buscar os compontenes dos cargapedidos da filho e atualizar ou criar o componente para a carga pai
            Repositorio.Embarcador.Cargas.CargaPedidoComponentesFrete repCargaPedidoComponenteFrete = new Repositorio.Embarcador.Cargas.CargaPedidoComponentesFrete(unitOfWork);
            Servicos.Embarcador.Carga.ComponetesFrete svcComponenteFrete = new ComponetesFrete(unitOfWork);

            svcComponenteFrete.RemoverComponentesCargaPedido(cargaPedidoFilho, unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete> cargaPedidoComponentesFretesOutrasCargas = repCargaPedidoComponenteFrete.BuscarPorCargaPedido(cargaPedidoPai.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete cargaPedidoComponenteFreteOutraCarga in cargaPedidoComponentesFretesOutrasCargas)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete componenteCargaPedidoFreteCargafilho = repCargaPedidoComponenteFrete.BuscarPorCompomente(cargaPedidoFilho.Codigo, cargaPedidoComponenteFreteOutraCarga.TipoComponenteFrete, null, false);

                if (componenteCargaPedidoFreteCargafilho != null)
                {
                    componenteCargaPedidoFreteCargafilho.ValorComponente += cargaPedidoComponenteFreteOutraCarga.ValorComponente;
                    componenteCargaPedidoFreteCargafilho.ValorComponenteComICMSIncluso += cargaPedidoComponenteFreteOutraCarga.ValorComponenteComICMSIncluso;
                    repCargaPedidoComponenteFrete.Atualizar(componenteCargaPedidoFreteCargafilho);
                }
                else
                {
                    componenteCargaPedidoFreteCargafilho = cargaPedidoComponenteFreteOutraCarga.Clonar(); //new Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete();
                    componenteCargaPedidoFreteCargafilho.CargaPedido = cargaPedidoFilho;
                    repCargaPedidoComponenteFrete.Inserir(componenteCargaPedidoFreteCargafilho);
                }
            }
        }

        private bool ValidarInicioEmissaoDocumentosMultiModal(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, Repositorio.UnitOfWork unitOfWork)
        {
            if (!configuracaoTMS.UtilizaEmissaoMultimodal)
                return true;

            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);

            decimal diferencaPesoMaximoContainer = 0m;
            bool contemDestinatario = true;

            List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeDocumentos> tiposRateioDocumentos = repCargaPedido.BuscarTipoRateioPorCarga(carga.Codigo);
            contemDestinatario = !repCargaPedido.NaoContemDestinatarioPedido(carga.Codigo);

            if (carga != null && carga.Pedidos != null && carga.SituacaoAlteracaoFreteCarga != SituacaoAlteracaoFreteCarga.Aprovada && carga.SituacaoAlteracaoFreteCarga != SituacaoAlteracaoFreteCarga.NaoInformada && carga.SituacaoAlteracaoFreteCarga != SituacaoAlteracaoFreteCarga.Reprovada)
            {
                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido pedido in carga.Pedidos)
                {
                    if (diferencaPesoMaximoContainer >= 0 && pedido.Pedido != null && pedido.Pedido.Container != null && pedido.Pedido.Container.ContainerTipo != null && pedido.Pedido.Container.ContainerTipo.PesoMaximo > 0 && pedido.NotasFiscais != null && pedido.NotasFiscais.Count > 0)
                    {
                        decimal pesoInformadoDasNotas = pedido.NotasFiscais.Sum(n => n.XMLNotaFiscal.Peso);

                        if (pesoInformadoDasNotas > 0)
                            diferencaPesoMaximoContainer = pesoInformadoDasNotas - pedido.Pedido.Container.ContainerTipo.PesoMaximo;
                    }
                }
            }

            if (diferencaPesoMaximoContainer < 0)
                diferencaPesoMaximoContainer = 0;

            decimal pesoTotalNota = repPedidoXMLNotaFiscal.ObterPesoTotalPorCarga(carga.Codigo);

            if (!(contemDestinatario && (tiposRateioDocumentos == null || tiposRateioDocumentos.Count <= 1) && pesoTotalNota <= 41999999m))
                return false;

            if (!((diferencaPesoMaximoContainer <= 0) || (carga.SituacaoAlteracaoFreteCarga == SituacaoAlteracaoFreteCarga.Aprovada) || (carga.SituacaoAlteracaoFreteCarga == SituacaoAlteracaoFreteCarga.NaoInformada) || (carga.SituacaoAlteracaoFreteCarga == SituacaoAlteracaoFreteCarga.Reprovada)))
                return false;

            return true;
        }

        private Dominio.Entidades.DocumentosCTE ValidarCTeEmitidoEmbarcadorOuTransbordoFaltandoNotaFiscalCTe(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Servicos.Embarcador.CTe.CTEsImportados svcCTesImportados = new Servicos.Embarcador.CTe.CTEsImportados(unitOfWork);

            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe repCargaPedidoDocumentoCTe = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCTe repCargaCTe = new Repositorio.Embarcador.Cargas.CargaCTe(unitOfWork);
            Repositorio.DocumentosCTE repDocumentoCTe = new Repositorio.DocumentosCTE(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargasPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargasPedidos)
            {
                if (!cargaPedido.CTeEmitidoNoEmbarcador && !cargaPedido.Pedido.PedidoTransbordo)
                    continue;

                List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe> cargaPedidoDocumentosCTe = repCargaPedidoDocumentoCTe.BuscarPorCargaPedidoParaVinculoCarga(cargaPedido);
                List<Dominio.Entidades.DocumentosCTE> documentosCTesGeral = repDocumentoCTe.BuscarPorCTe(cargaPedidoDocumentosCTe.Select(o => o.CTe.Codigo));

                //Não validar quando possuir mais de 500 documentos por questões de performance.
                if ((documentosCTesGeral?.Count() ?? 0) > 500)
                    continue;

                List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> pedidoXMLNotasFiscais = repPedidoXMLNotaFiscal.BuscarPorCargaPedido(cargaPedido.Codigo);
                List<int> codigosCTesExistentesNaCarga = repCargaCTe.BuscarCodigosCTesPorCarga(carga);

                for (int i = 0; i < cargaPedidoDocumentosCTe.Count; i++)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe cargaPedidoDocumentoCTe = cargaPedidoDocumentosCTe[i];

                    if (codigosCTesExistentesNaCarga.Exists(codigoCTe => codigoCTe == cargaPedidoDocumentoCTe.CTe.Codigo))
                        continue;

                    List<Dominio.Entidades.DocumentosCTE> documentosCTes = documentosCTesGeral.FindAll(o => o.CTE.Codigo == cargaPedidoDocumentoCTe.CTe.Codigo);

                    foreach (Dominio.Entidades.DocumentosCTE docCTe in documentosCTes)
                    {
                        Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal PedidoXMLNotaFiscal = svcCTesImportados.ObterPedidoXMLNotaFiscalPorDocumentoCTe(docCTe, pedidoXMLNotasFiscais);

                        if (PedidoXMLNotaFiscal == null)
                            return docCTe;
                    }
                }

            }

            return null;
        }

        private void AlternarEmiteCTeFilialEmissora(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Servicos.Embarcador.Carga.CargaPedido serCargaPedido = new Servicos.Embarcador.Carga.CargaPedido(unitOfWork);

            Repositorio.Embarcador.Cargas.CargaDadosTipoOperacaoSemFilialEmissora repCargaDadosTipoOperacaoSemFilialEmissora = new Repositorio.Embarcador.Cargas.CargaDadosTipoOperacaoSemFilialEmissora(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork).BuscarPrimeiroRegistro();

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(carga.Codigo);

            if (carga.TipoOperacao.EmiteCTeFilialEmissora)
            {
                if (!repCargaDadosTipoOperacaoSemFilialEmissora.ExistePorCarga(carga.Codigo))
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaDadosTipoOperacaoSemFilialEmissora dadosOriginais = new Dominio.Entidades.Embarcador.Cargas.CargaDadosTipoOperacaoSemFilialEmissora
                    {
                        Carga = carga,
                        TipoContratacaoCarga = cargaPedidos.FirstOrDefault()?.TipoContratacaoCarga ?? TipoContratacaoCarga.Normal,
                        TipoContratacaoCargaSubContratacaoFilialEmissora = cargaPedidos.FirstOrDefault()?.TipoContratacaoCargaSubContratacaoFilialEmissora ?? TipoContratacaoCarga.Normal,
                    };
                    repCargaDadosTipoOperacaoSemFilialEmissora.Inserir(dadosOriginais);
                }

                for (int i = 0; i < cargaPedidos.Count; i++)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedido temp = cargaPedidos[i];
                    serCargaPedido.VerificarFilialEmissaoCargaPedido(temp, configuracaoGeralCarga);
                    cargaPedidos[i] = temp;
                    repCargaPedido.Atualizar(cargaPedidos[i]);
                }

                if (carga.Filial != null && carga.Filial.EmpresaEmissora != null && carga.TipoOperacao.EmiteCTeFilialEmissora)
                {
                    carga.EmpresaFilialEmissora = carga.Filial.EmpresaEmissora;
                    carga.EmiteMDFeFilialEmissora = carga.Filial.EmiteMDFeFilialEmissora;

                    if (carga.Filial.UtilizarCtesAnterioresComoCteFilialEmissora)
                        carga.UtilizarCTesAnterioresComoCTeFilialEmissora = true;
                }
            }
            else
            {
                if (repCargaDadosTipoOperacaoSemFilialEmissora.ExistePorCarga(carga.Codigo))
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaDadosTipoOperacaoSemFilialEmissora dadosOriginais = repCargaDadosTipoOperacaoSemFilialEmissora.BuscarPorCarga(carga.Codigo);

                    foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
                    {
                        cargaPedido.CargaPedidoFilialEmissora = false;
                        cargaPedido.TipoContratacaoCarga = dadosOriginais.TipoContratacaoCarga;
                        cargaPedido.TipoContratacaoCargaSubContratacaoFilialEmissora = dadosOriginais.TipoContratacaoCargaSubContratacaoFilialEmissora;
                        repCargaPedido.Atualizar(cargaPedido);
                    }
                }
                else
                {
                    foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
                    {
                        cargaPedido.CargaPedidoFilialEmissora = false;
                        cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.Normal;
                        cargaPedido.TipoContratacaoCargaSubContratacaoFilialEmissora = TipoContratacaoCarga.Normal;
                        repCargaPedido.Atualizar(cargaPedido);
                    }
                }

                carga.EmpresaFilialEmissora = null;
            }

            repCarga.Atualizar(carga);
        }

        private dynamic ObterDadosDetalheCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer> cargaVeiculosContainer, List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainerAnexo> cargaVeiculosContainerAnexo, List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedido> cargaPedidos, Dominio.Entidades.Embarcador.Cargas.CargaCancelamento cargaCancelamento, List<Dominio.ObjetosDeValor.WebService.Carga.Carga> cargasOrigem, List<string> codigosAgrupamento, List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro> apolicesSeguroAverbacao, bool possuiRotaDefinida, Dominio.Entidades.Embarcador.Cargas.TipoCargaModeloVeicularAutoConfig tipoCargaModeloVeicularAutoConfig, dynamic ContratoTerceiro, List<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> motoristas, List<Dominio.ObjetosDeValor.Embarcador.Carga.PedidoTransbordo> cargaPedidosTransbordos, Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento, Dominio.Entidades.Embarcador.Cargas.CargaJanelaDescarregamento cargaJanelaDescarregamento, List<Dominio.ObjetosDeValor.Embarcador.Alertas.MensagemAlerta> mensagensAlerta, bool permitirLiberarComProblemaIntegracaoGrMotoristaVeiculo, Dominio.Entidades.Embarcador.Logistica.AgendamentoColeta agendamentoColeta, List<Dominio.Entidades.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarque> ordensEmbarque, Dominio.Entidades.Embarcador.Cargas.OrdemEmbarque.CargaOrdemEmbarqueIntegracao cargaOrdemEmbarqueIntegracao, List<string> codigosIntegracaoSituacaoOrdemCancelada, Dominio.Entidades.Usuario motoristaVeiculo, bool possuiMontagemContainer, Dominio.Entidades.Embarcador.Pedidos.RetiradaContainer retiradaContainer, List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoTransportadorTermoAceite> termosAceite, List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoTransportador> janelasTransportador, decimal quantidadePallets, bool possuiSimulacaoFrete, List<Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntrega> EntregasParqueamento, Dominio.Entidades.Embarcador.Cargas.CargaPreCalculo cargaPreCalculo, Dominio.Entidades.Embarcador.Cargas.CargaDadosParaProcessamentoDt dadoDocumentoCarga, Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab, bool contemFaturamento, bool todosCTesForamFaturados, bool existePacote, Dominio.Entidades.Embarcador.Cargas.MontagemCarga.SimulacaoFrete simulacaoFrete, UnitOfWork unitOfWork, bool? recebeuNotasFilhas, Dominio.Entidades.Usuario usuario = null, List<(int CodigoCarga, string DescricaoLinhaSeparacao)> listaLinhaSeparacaoDescricaoComCodigoCarga = null, List<Dominio.Entidades.Usuario> ajudantes = null, List<Dominio.Entidades.Embarcador.Transportadores.MotoristaIntegracao> integracoesMotoristas = null, List<Dominio.Entidades.Embarcador.Veiculos.VeiculoIntegracao> integracoesVeiculos = null, List<Dominio.ObjetosDeValor.Embarcador.Monitoramento.MonitoramentoDadosDetalhesCarga> monitoramentos = null, Dominio.Entidades.Embarcador.PreCargas.PreCarga preCarga = null, List<Dominio.Entidades.Embarcador.Cargas.CargaCIOT> cargaCIOTList = null, bool possuiIntegracaoHUBOfertas = false)
        {
            Repositorio.Embarcador.Configuracoes.ConfiguracaoJanelaCarregamento repositorioConfiguracaoJanelaCarregamento = new Repositorio.Embarcador.Configuracoes.ConfiguracaoJanelaCarregamento(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoFinanceiro repositorioConfiguracaoFinanceiro = new Repositorio.Embarcador.Configuracoes.ConfiguracaoFinanceiro(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaIntegracaoHUBOfertas respositorioIntegracaoHUBOfertas = new Repositorio.Embarcador.Cargas.CargaIntegracaoHUBOfertas(unitOfWork);

            Servicos.Embarcador.Carga.CargaDadosSumarizados serCargaDadosSumarizados = new Servicos.Embarcador.Carga.CargaDadosSumarizados(unitOfWork);
            Servicos.Embarcador.Carga.OcultarInformacoesCarga.OcultarInformacoesCarga serOcultarInformacoesCarga = new OcultarInformacoesCarga.OcultarInformacoesCarga(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoJanelaCarregamento configuracaoJanelaCarregamento = repositorioConfiguracaoJanelaCarregamento.BuscarPrimeiroRegistro();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoFinanceiro configuracaoFinanceiro = repositorioConfiguracaoFinanceiro.BuscarConfiguracaoPadrao();

            bool possuiOcultarInformacoesCarga = usuario != null ? serOcultarInformacoesCarga.PossuiOcultarInformacoesCarga(usuario.Codigo) : false;
            Dominio.Entidades.Embarcador.Cargas.OcultarInformacoesCarga.OcultarInformacoesCarga ocultarInformacoesCarga = null;
            if (possuiOcultarInformacoesCarga)
                ocultarInformacoesCarga = serOcultarInformacoesCarga.ObterOcultarInformacoesCarga(usuario.Codigo);

            bool aguardandoCTEs = false;

            Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacaoCarga = carga.SituacaoCarga;
            if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada || carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada)
                situacaoCarga = cargaCancelamento?.SituacaoCargaNoCancelamento ?? carga.SituacaoCarga;

            if (situacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.PendeciaDocumentos && ((!carga.AutorizouTodosCTes && !carga.PossuiPendencia) || carga.EmitindoCTes))
                aguardandoCTEs = true;

            string clientes = configuracaoEmbarcador.Pais == TipoPais.Exterior ? string.Join(", ", (from o in cargaPedidos where o.Destinatario != null select o.Destinatario.Nome).Distinct()) : "";
            string ordem = string.Join(", ", (from o in cargaPedidos where !string.IsNullOrWhiteSpace(o.Ordem) select o.Ordem));
            string OrigemDestinos = serCargaDadosSumarizados.ObterOrigemDestinos(carga, true, tipoServicoMultisoftware);
            string filiais = carga.Filial?.Descricao ?? "";
            string tiposOperacao = carga.TipoOperacao?.Descricao ?? "";
            string TipoTrecho = carga.TipoTrecho?.Descricao ?? "";
            bool possuiNFs = false;
            bool possuiCTe = false;
            bool possuiNFSManual = false;
            bool possuiAverbacaoCTe = false;
            bool possuiAverbacaoMDFe = false;
            bool possuiIntegracaoValePedagio = false;
            bool possuiRedespacho = false;
            bool possuiCTeAnteriorFilialEmissora = false;
            bool utilizarCTesAnterioresComoCTeFilialEmissora = false;
            string subContratante = "";
            string filiaisVenda = "";
            decimal pesoTotal = 0;
            decimal pesoPallet = 0;
            decimal pesoLiquidoTotal = 0;
            decimal pesoTotalNF = 0;
            decimal pesoCubadoNF = 0;
            decimal valorMercadoria = 0;
            decimal valorTotalProdutos = 0;
            int quantidadeNFEs = 0;
            int volumesCaixasNFEs = 0;
            bool possuiGenset = cargaPedidos?.Any(o => o.PossuiGenset == true) ?? false;
            decimal pesoTotalReentrega = 0;
            string termoAceite = string.Empty;
            string regiao = string.Join(", ", (from o in cargaPedidos where o.Destinatario != null select o.Destinatario.Regiao).Distinct());
            string mesorregiao = string.Join(", ", (from o in cargaPedidos where o.Destinatario != null select o.Destinatario.Mesorregiao).Distinct());
            string NumeroPreCarga = preCarga?.NumeroPreCarga ?? "";


            bool estaEmParqueamento;
            bool exigePlacaTracao = carga.TipoOperacao?.ExigePlacaTracao ?? false;

            if (exigePlacaTracao)
            {
                //Caso a flag Exige que a placa da Tração seja informada na carga estiver marcada desconsidera a DataInicio
                estaEmParqueamento = EntregasParqueamento?.Any(o => (o.Situacao == SituacaoEntrega.NaoEntregue || o.Situacao == SituacaoEntrega.EmCliente || o.Situacao == SituacaoEntrega.AgAtendimento)) ?? false;
            }
            else
            {
                // DEFINE SE ESTA EM PARQUEAMENTO PELA ENTREGA, ISSO SIGNIFICA QUE O USUARIO CASO A CARGA ESTA EM TRANSPORTE PODE ALTARAR O VEICULO TRACAO.
                estaEmParqueamento = EntregasParqueamento?.Any(o => (o.Situacao == SituacaoEntrega.NaoEntregue || o.Situacao == SituacaoEntrega.EmCliente || o.Situacao == SituacaoEntrega.AgAtendimento) && o.DataInicio.HasValue) ?? false;
            }

            if (!string.IsNullOrWhiteSpace(carga.TipoOperacao?.TermoAceite))
                termoAceite = carga.TipoOperacao.TermoAceite;
            else if (!string.IsNullOrWhiteSpace(cargaJanelaCarregamento?.CentroCarregamento?.TermoAceite))
                termoAceite = cargaJanelaCarregamento.CentroCarregamento.TermoAceite;

            bool permitirAtualizarContainerVeiculo = (
                configuracaoEmbarcador.PermitirInformarAnexoContainerCarga ||
                configuracaoEmbarcador.PermitirInformarDataRetiradaCtrnCarga ||
                configuracaoEmbarcador.PermitirInformarNumeroContainerCarga ||
                configuracaoEmbarcador.PermitirInformarTaraContainerCarga ||
                configuracaoEmbarcador.PermitirInformarMaxGrossCarga ||
                possuiGenset
            );

            if (carga.DadosSumarizados != null)
            {
                possuiCTeAnteriorFilialEmissora = carga.DadosSumarizados.PossuiCTeAnteriorFilialEmissora;
                utilizarCTesAnterioresComoCTeFilialEmissora = carga.DadosSumarizados.UtilizarCTesAnterioresComoCTeFilialEmissora;
                possuiCTe = carga.DadosSumarizados.PossuiCTe;
                possuiNFs = carga.DadosSumarizados.PossuiNFS;
                possuiNFSManual = carga.DadosSumarizados.PossuiNFSManual;
                possuiAverbacaoCTe = carga.DadosSumarizados.PossuiAverbacaoCTe;
                possuiAverbacaoMDFe = carga.DadosSumarizados.PossuiAverbacaoMDFe;
                possuiIntegracaoValePedagio = carga.DadosSumarizados.PossuiIntegracaoValePedagio;
                possuiRedespacho = carga.DadosSumarizados.PossuiRedespacho;
                subContratante = carga.DadosSumarizados.SubContratantes;
                pesoTotal = carga.DadosSumarizados.PesoTotal;
                pesoLiquidoTotal = carga.DadosSumarizados.PesoLiquidoTotal;
                valorTotalProdutos = carga.DadosSumarizados.ValorTotalProdutos;
                volumesCaixasNFEs = carga.DadosSumarizados?.QuantidadeVolumesNF ?? 0;
                pesoTotalReentrega = carga.DadosSumarizados.PesoTotalReentrega;
                filiaisVenda = carga.DadosSumarizados.FiliaisVenda;

                if (!string.IsNullOrWhiteSpace(carga.DadosSumarizados.Filiais))
                {
                    filiais = carga.DadosSumarizados.Filiais;
                    if (carga.FilialOrigem != null && carga.FilialOrigem.Codigo != carga.Filial?.Codigo)
                        filiais += " <i style='font-size:10px;'> (" + carga.FilialOrigem.Descricao + "). </i>";
                }

                if (!string.IsNullOrWhiteSpace(carga.DadosSumarizados.TiposDeOperacao))
                    tiposOperacao = carga.DadosSumarizados.TiposDeOperacao;
            }

            string NumeroCargaOriginais = "";

            bool cargaAgrupada = true;
            if (carga.CargaDeVinculo || carga.CargaPossuiOutrosNumerosEmbarcador)
                NumeroCargaOriginais = string.Join(", ", codigosAgrupamento);
            else if (carga.CargaAgrupada)
            {
                List<string> filiaisOrigem = (from obj in cargasOrigem select obj.FilialOrigem).OrderByDescending(obj => obj).Distinct().ToList();
                foreach (string filialOrigem in filiaisOrigem)
                {

                    List<Dominio.ObjetosDeValor.WebService.Carga.Carga> cargasOrigemFilial = (from obj in cargasOrigem where obj.FilialOrigem == filialOrigem select obj).ToList();

                    for (int i = 0; i < cargasOrigemFilial.Count; i++)
                    {
                        Dominio.ObjetosDeValor.WebService.Carga.Carga cargaOrigem = cargasOrigemFilial[i];
                        if (carga.CargaDePreCarga && !cargaOrigem.CargaDePreCarga)
                            NumeroCargaOriginais += "<b style='color: #2d982d;'>" + cargaOrigem.NumeroCarga + "</b>";
                        else
                            NumeroCargaOriginais += cargaOrigem.NumeroCarga;

                        if (i < cargasOrigemFilial.Count - 1)
                            NumeroCargaOriginais += ", ";
                        else
                        {
                            if (!string.IsNullOrWhiteSpace(filialOrigem))
                                NumeroCargaOriginais += " <i style='font-size:10px;'>(" + filialOrigem + "). </i>";
                            else
                                NumeroCargaOriginais += ". ";
                        }
                    }
                }

            }
            else
                cargaAgrupada = false;

            if (possuiRedespacho && carga.EmitirCTeComplementar)
                possuiRedespacho = false;

            if (!possuiCTe && !possuiNFs && !possuiNFSManual)
                possuiCTe = true;

            bool aguardandoNFS = false;

            if (possuiNFs)
            {
                if (situacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.PendeciaDocumentos && !carga.AutorizouTodosCTes && !carga.PossuiPendencia)
                    aguardandoNFS = true;
            }

            Dominio.Entidades.Veiculo tracao = null;
            bool exigeConfirmacaoTracao = carga.TipoOperacao?.ExigePlacaTracao ?? false;

            if (exigeConfirmacaoTracao && (carga.Veiculo != null) && (carga.Veiculo.TipoVeiculo == "0"))
                tracao = carga.Veiculo;

            //temporario para exibir as cargas antigas da danone, após um tempo podemos remover isso 17/01/2020
            string numeroCarregamento = "";
            int codigoCarregamento = 0;
            if (carga.Carregamento != null && carga.Carregamento.TipoMontagemCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoMontagemCarga.AgruparCargas)
            {
                numeroCarregamento = carga.Carregamento.NumeroCarregamento;
                codigoCarregamento = carga.Carregamento.Codigo;
            }

            string modeloVeicularCarregamento = (carga.Carregamento?.ModeloVeicularCarga?.Codigo != carga.ModeloVeicularCarga?.Codigo) ? carga.Carregamento?.ModeloVeicularCarga?.Descricao : "";
            Dominio.Entidades.Embarcador.Cargas.FaixaTemperatura faixaTemperatura = carga.FaixaTemperatura;

            if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS && faixaTemperatura == null)
                faixaTemperatura = carga.TipoDeCarga?.FaixaDeTemperatura;

            string numeroDocaCarga = string.Empty;
            if (!string.IsNullOrWhiteSpace(carga.NumeroDoca) && !string.IsNullOrWhiteSpace(carga.NumeroDocaEncosta) && carga.NumeroDoca != carga.NumeroDocaEncosta)
                numeroDocaCarga = string.Concat(carga.NumeroDoca, " / ", carga.NumeroDocaEncosta);
            else if (!string.IsNullOrWhiteSpace(carga.NumeroDoca) && !string.IsNullOrWhiteSpace(carga.NumeroDocaEncosta) && carga.NumeroDoca == carga.NumeroDocaEncosta)
                numeroDocaCarga = carga.NumeroDoca;
            else if (string.IsNullOrWhiteSpace(carga.NumeroDoca) && !string.IsNullOrWhiteSpace(carga.NumeroDocaEncosta))
                numeroDocaCarga = carga.NumeroDocaEncosta;
            else
                numeroDocaCarga = carga.NumeroDoca;

            Dominio.Entidades.Embarcador.GestaoPatio.DocaCarregamento docaCarregamento = null;


            if (new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork).BuscarPrimeiroRegistro().InformarDocaNaEtapaUmDaCarga)
            {
                Repositorio.Embarcador.GestaoPatio.DocaCarregamento repositorioDocaCarregamento = new Repositorio.Embarcador.GestaoPatio.DocaCarregamento(unitOfWork);
                docaCarregamento = repositorioDocaCarregamento.BuscarPorCarga(carga.Codigo);
            }

            Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer containerVeiculo = (from cargaVeiculoContainer in cargaVeiculosContainer where cargaVeiculoContainer.Veiculo.Codigo == carga.Veiculo?.Codigo select cargaVeiculoContainer).FirstOrDefault();
            Dominio.Entidades.Embarcador.Pedidos.ContainerTipo containerTipo = retiradaContainer?.ContainerTipo ?? carga.ModeloVeicularCarga?.ContainerTipo ?? carga.Carregamento?.ModeloVeicularCarga?.ContainerTipo;

            bool situacaoPermitirAlterarDataCarregamentoCarga = carga.SituacaoCarga.IsSituacaoCargaNaoFaturada() && carga.SituacaoCarga != SituacaoCarga.PendeciaDocumentos;
            bool tipoOperacaoPermiteAlterarDataCarregamento = !(carga.TipoOperacao?.BloquearAlteracaoHorarioCarregamentoCarga ?? false);
            bool centroCarregamentoPermiteAlterarDataCarregamento = !(cargaJanelaCarregamento?.CentroCarregamento?.NaoPermitirAlterarDataCarregamentoCarga ?? false);
            bool permitirAlterarDataCarregamentoCarga = (carga.TipoOperacao?.PermiteAlterarHorarioCarregamentoCargasFaturadas ?? false) || (centroCarregamentoPermiteAlterarDataCarregamento && situacaoPermitirAlterarDataCarregamentoCarga && tipoOperacaoPermiteAlterarDataCarregamento);
            bool exigirInformarContainerCarga = (carga.TipoOperacao?.ObrigatorioVincularContainerCarga ?? false);
            bool exigirInformarRetiradaContainer = (containerTipo != null && !exigirInformarContainerCarga);
            bool possuiIntegracaoTelerisco = integracoesMotoristas.Any(obj => obj.TipoIntegracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Telerisco); //repMotoristaIntegracao.PossuiIntegracaoPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Telerisco);
            bool possuiIntegracaoBrasilRiskGestao = integracoesMotoristas.Any(obj => obj.TipoIntegracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.BrasilRiskGestao) || integracoesVeiculos.Any(obj => obj.TipoIntegracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.BrasilRiskGestao); //repMotoristaIntegracao.PossuiIntegracaoPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.BrasilRiskGestao);
            bool motoristaValidadoBrasilRisk = true;
            bool placaValidadoBrasilRisk = true;
            bool falhaIntegracaoHUB = false;
            bool enviadoAoHUBOferta = false;
            string integracaoBRKPlaca = string.Empty;
            string integracaoBRKMotorista = string.Empty;

            if (possuiIntegracaoHUBOfertas)
            {
                enviadoAoHUBOferta = respositorioIntegracaoHUBOfertas.ConsultaCargaFoiEnviadoAoHUB(carga.Codigo);
                if (enviadoAoHUBOferta)
                    falhaIntegracaoHUB = respositorioIntegracaoHUBOfertas.ConsultarIntegracaoCargaComFalha(carga.Codigo);
            }

            if (possuiIntegracaoBrasilRiskGestao)
            {
                if (integracoesMotoristas.Count() > 0 && (integracoesMotoristas.Where(obj => obj.TipoIntegracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.BrasilRiskGestao).FirstOrDefault()?.SituacaoIntegracao == SituacaoIntegracao.Integrado))
                {
                    integracaoBRKMotorista = "Validado na Brasil Risk";
                    motoristaValidadoBrasilRisk = true;
                }
                else if (integracoesMotoristas.Count() > 0 && (integracoesMotoristas.Where(obj => obj.TipoIntegracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.BrasilRiskGestao).FirstOrDefault()?.SituacaoIntegracao == SituacaoIntegracao.ProblemaIntegracao))
                {
                    integracaoBRKMotorista = "Não validado na Brasil Risk";
                    motoristaValidadoBrasilRisk = false;
                }
                else
                {
                    integracaoBRKMotorista = string.Empty;
                    motoristaValidadoBrasilRisk = true;
                }
            }

            if (possuiIntegracaoBrasilRiskGestao)
            {
                if (integracoesVeiculos.Count() > 0 && (integracoesVeiculos.Where(obj => obj.TipoIntegracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.BrasilRiskGestao).FirstOrDefault()?.SituacaoIntegracao == SituacaoIntegracao.Integrado))
                {
                    integracaoBRKPlaca = "Placa validada na Brasil Risk";
                    placaValidadoBrasilRisk = true;
                }
                else if (integracoesVeiculos.Count() > 0 && (integracoesVeiculos.Where(obj => obj.TipoIntegracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.BrasilRiskGestao).FirstOrDefault()?.SituacaoIntegracao == SituacaoIntegracao.ProblemaIntegracao))
                {
                    integracaoBRKPlaca = "Placa não validada na Brasil Risk";
                    placaValidadoBrasilRisk = false;
                }
                else
                {
                    integracaoBRKPlaca = string.Empty;
                    placaValidadoBrasilRisk = true;
                }
            }

            if (cargaPedidos?.Count > 0)
            {
                pesoPallet = cargaPedidos.Sum(x => x.PesoPallet);
                IEnumerable<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedidoXMLNotaFiscal> notasFiscais = cargaPedidos.SelectMany(cargaPedido => cargaPedido.NotasFiscais).Distinct();

                pesoTotalNF = notasFiscais.Sum(notaFiscal => notaFiscal.Peso);
                if (cargaPedidos.Any(p => p.TipoPropostaMultimodal == TipoPropostaMultimodal.Feeder))
                    pesoTotalNF = pesoTotal;
                pesoCubadoNF = notasFiscais.Sum(notaFiscal => notaFiscal.PesoCubado);

                if (carga.Internacional)
                {
                    valorMercadoria = notasFiscais.Where(notaFiscal => !notaFiscal.TipoFatura).Sum(notaFiscal => notaFiscal.Valor);
                    quantidadeNFEs = notasFiscais.Where(notaFiscal => !notaFiscal.TipoFatura).Count();
                }
                else
                {
                    valorMercadoria = notasFiscais.Sum(notaFiscal => notaFiscal.Valor);
                    quantidadeNFEs = notasFiscais.Count();
                }

                if ((carga.TipoOperacao?.ConfiguracaoEmissaoDocumento?.ClassificacaoNFeRemessaVenda ?? false) && cargaPedidos.Exists(o => o.IndicadorRemessaVenda))
                {
                    if (carga.TipoOperacao.ConfiguracaoEmissaoDocumento?.EnviarParaObservacaoCTeNFeRemessa ?? false)
                        valorMercadoria = notasFiscais.Where(notaFiscal => notaFiscal.ClassificacaoNFe != Dominio.ObjetosDeValor.Embarcador.Enumeradores.ClassificacaoNFe.Remessa).Sum(notaFiscal => notaFiscal.Valor);
                    else if (carga.TipoOperacao.ConfiguracaoEmissaoDocumento?.EnviarParaObservacaoCTeNFeVenda ?? false)
                        valorMercadoria = notasFiscais.Where(notaFiscal => notaFiscal.ClassificacaoNFe != Dominio.ObjetosDeValor.Embarcador.Enumeradores.ClassificacaoNFe.Venda).Sum(notaFiscal => notaFiscal.Valor);
                }
            }

            string idMontagemContainer = string.Join(", ", cargaPedidos?.Where(obj => !string.IsNullOrWhiteSpace(obj.IdMontagemContainer)).Select(obj => obj.IdMontagemContainer).Distinct());
            string numeroContainerCarga = string.Join(", ", cargaPedidos?.Where(obj => !string.IsNullOrWhiteSpace(obj.NumeroContainerCarga)).Select(obj => obj.NumeroContainerCarga).Distinct());
            string tipoCobrancaMultimodal = string.Join(", ", cargaPedidos?.Select(cargaPedido => cargaPedido.TipoCobrancaMultimodal.ObterDescricao()).Distinct());
            string transportadoraManual = string.IsNullOrWhiteSpace(carga.DadosSumarizados?.PortalRetiraEmpresa) ? string.IsNullOrWhiteSpace(agendamentoColeta?.TransportadorManual) ? $"{carga.Empresa?.CodigoIntegracao ?? string.Empty} {carga.Empresa?.RazaoSocial} ({carga.Empresa?.Localidade.DescricaoCidadeEstado})" : agendamentoColeta.TransportadorManual : carga.DadosSumarizados.PortalRetiraEmpresa;
            DateTime? dataAvancouSegundaEtapa = carga.DataSalvouDadosCarga.HasValue && carga.TipoOperacao?.ConfiguracaoCarga?.TempoParaRecebimentoDosPacotes > 0 ? carga.DataSalvouDadosCarga.Value.AddHours(carga.TipoOperacao.ConfiguracaoCarga.TempoParaRecebimentoDosPacotes) : null;

            int? codigoCargaJanelaCarregamentoTransportador = null;
            if (configuracaoJanelaCarregamento.PermitirLiberarCargaParaTransportadoresTerceiros)
                codigoCargaJanelaCarregamentoTransportador = (from obj in janelasTransportador where obj?.Terceiro?.Codigo == carga.Terceiro?.CPF_CNPJ select obj.Codigo).FirstOrDefault();
            else
                codigoCargaJanelaCarregamentoTransportador = (from obj in janelasTransportador where obj?.Transportador?.Codigo == carga.Empresa?.Codigo select obj.Codigo).FirstOrDefault();

            (int CodigoCarga, string DescricaoLinhaSeparacao) descricaoLinhaSeparacao = (0, null);

            if (listaLinhaSeparacaoDescricaoComCodigoCarga != null && listaLinhaSeparacaoDescricaoComCodigoCarga.Count > 0)
                descricaoLinhaSeparacao = listaLinhaSeparacaoDescricaoComCodigoCarga.Where(o => o.CodigoCarga == carga.Codigo).FirstOrDefault();

            Dominio.ObjetosDeValor.Embarcador.Monitoramento.MonitoramentoDadosDetalhesCarga monitoramentosDados = new Dominio.ObjetosDeValor.Embarcador.Monitoramento.MonitoramentoDadosDetalhesCarga();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork).BuscarPrimeiroRegistro();
            Dominio.Entidades.Embarcador.Cargas.CargaCIOT cargaCIOT = new Dominio.Entidades.Embarcador.Cargas.CargaCIOT();

            if (monitoramentos != null && monitoramentos.Count > 0)
                monitoramentosDados = monitoramentos.Where(o => o.CodigoCarga == carga.Codigo).FirstOrDefault();

            if (cargaCIOTList != null && cargaCIOTList.Count > 0)
                cargaCIOT = cargaCIOTList.Where(x => x.Carga.Codigo == carga.Codigo).FirstOrDefault();

            var dynCarga = new
            {
                Configuracoes = ObterConfiguracoesDetalhesCarga(carga, tipoServicoMultisoftware),
                carga.Codigo,
                carga.CodigoCargaEmbarcador,
                PreCalculodeFrete = ObterDadosIntegracaoPrecalculo(carga, unitOfWork),
                ObrigatoriedadeCIOTEmissaoMDFe = (configuracaoGeralCarga?.ObrigatoriedadeCIOTEmissaoMDFe ?? false) || (carga.Empresa?.Configuracao?.ObrigatoriedadeCIOTEmissaoMDFe ?? false),
                PossuiCIOT = cargaCIOT != null,
                VeiculoPropriedadeTerceiro = (carga.Veiculo?.Tipo ?? "P") == "T",
                carga.FreteDeTerceiro,
                ProprietarioTAC = carga.Veiculo?.Proprietario != null && (carga.Veiculo.TipoProprietario == Dominio.Enumeradores.TipoProprietarioVeiculo.TACIndependente || carga.Veiculo.TipoProprietario == Dominio.Enumeradores.TipoProprietarioVeiculo.TACAgregado),
                CIOTGeradoAutomaticamente = cargaCIOT?.CIOT?.CIOTGeradoAutomaticamente ?? false,
                CodigoJanelaCarregamento = cargaJanelaCarregamento?.Codigo ?? 0,
                CodigoJanelaDescarregamento = cargaJanelaDescarregamento?.Codigo ?? 0,
                CodigoCargaVeiculoContainer = containerVeiculo?.Codigo ?? 0,
                NumeroDocaCarga = !string.IsNullOrWhiteSpace(numeroDocaCarga) ? " - Doca:" + numeroDocaCarga : string.Empty,
                Tracao = tracao != null ? new { Codigo = tracao.Codigo, Descricao = tracao.Placa } : new { Codigo = 0, Descricao = "" },
                Filial = filiais,
                FilialVenda = filiaisVenda,
                DataCriacaoCarga = carga.DataCriacaoCarga.ToString("dd/MM/yyyy HH:mm"),
                DataInicioEmissao = carga.DataEnvioUltimaNFe?.ToString("dd/MM/yyyy HH:mm") ?? "",
                DataAvancouSegundaEtapa = dataAvancouSegundaEtapa?.ToString("dd/MM/yyyy HH:mm") ?? "",
                SituacaoCarga = carga.SituacaoCarga,
                carga.SituacaoAutorizacaoIntegracaoCTe,
                DescricaoSituacaoCarga = carga.DescricaoSituacaoCarga,
                carga.SituacaoAlteracaoFreteCarga,
                Operador = carga.Operador != null ? carga.Operador.Nome : "",
                OperadorInsercao = carga.OperadorInsercao != null ? carga.OperadorInsercao.Nome : "",
                OrigemDestinos = OrigemDestinos,
                KM = (carga?.TipoOperacao?.ConfiguracaoCarga?.ConsiderarKMRecibidoDoEmbarcador ?? false) && carga.Distancia > -1 ? carga.Distancia : -1,
                Origem = serCargaDadosSumarizados.ObterOrigem(carga, true, tipoServicoMultisoftware),
                Destino = serCargaDadosSumarizados.ObterDestino(carga, true, tipoServicoMultisoftware, configuracaoEmbarcador.NaoExibirCodigoIntegracaoDoDestinatarioResumoCarga),
                ValorFrete = ObterValorFretePorCarga(carga, configuracaoEmbarcador, serOcultarInformacoesCarga, possuiOcultarInformacoesCarga, ocultarInformacoesCarga),
                ValorFreteTabelaFrete = carga.ValorFreteTabelaFrete,
                ValorFreteOperador = carga.ValorFreteOperador,
                carga.TipoFreteEscolhido,
                Solicitante = agendamentoColeta?.EmailSolicitante ?? "",
                TipoContratacaoCarga = !carga.EmitirCTeComplementar ? carga.TipoContratacaoCarga : Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Normal,
                Cliente = clientes,
                PercentualSeparacaoMercadoria = carga.PercentualSeparacaoMercadoria.ToString() + "%",
                MensagensAlerta = mensagensAlerta,
                ValorCustoFrete = cargaPedidos?.Sum(o => o.ValorCustoFrete) ?? 0,
                PrevisaoEntregaTransportador = cargaPedidos?.OrderByDescending(o => o.PrevisaoEntregaTransportador)?.FirstOrDefault()?.PrevisaoEntregaTransportador?.ToString("dd/MM/yyyy HH:mm"),
                Ordem = string.IsNullOrWhiteSpace(ordem) ? "" : ordem,
                FaixaTemperatura = new
                {
                    Codigo = faixaTemperatura?.Codigo ?? 0,
                    Descricao = faixaTemperatura?.Descricao ?? string.Empty
                },
                NumeroCargaOriginais,
                carga.MotivoPendencia,
                NumeroBooking = cargaPedidos.FirstOrDefault()?.NumeroBooking ?? "",
                Terceiro = new
                {
                    Codigo = carga.Terceiro?.CPF_CNPJ_SemFormato,
                    Descricao = carga.Terceiro != null ? (carga.Terceiro.Nome + " (" + carga.Terceiro.Localidade.DescricaoCidadeEstado + ")") : string.Empty
                },
                Redespacho = carga.Redespacho?.NumeroRedespacho.ToString() ?? string.Empty,
                SubContratante = subContratante,
                ContratoFreteTerceiro = ContratoTerceiro != null ? ContratoTerceiro : string.Empty,
                MotivoPendenciaFrete = carga.MotivoPendenciaFrete,
                Carregamento = new { Codigo = codigoCarregamento, Descricao = numeroCarregamento },
                ModeloVeicularCarregamento = modeloVeicularCarregamento ?? "",
                TipoTrecho = TipoTrecho,
                Mesorregiao = mesorregiao,
                Regiao = regiao,
                ObservacaoCarregamento = carga.Carregamento?.Observacao ?? "",
                OrdemEmbarque = string.Join(", ", (from o in ordensEmbarque where o.Situacao != null && !codigosIntegracaoSituacaoOrdemCancelada.Contains(o.Situacao.CodigoIntegracao) select o.Descricao)) ?? "",
                OrdemEmbarquePendente = (ordensEmbarque.Count == 0 && cargaOrdemEmbarqueIntegracao != null && cargaOrdemEmbarqueIntegracao.SituacaoIntegracao != SituacaoIntegracao.Integrado) ? cargaOrdemEmbarqueIntegracao.SituacaoIntegracao.ObterDescricao() : "",
                OrdemEmbarqueSituacaoIntegracao = cargaOrdemEmbarqueIntegracao?.SituacaoIntegracao,
                DataCarregamento = carga.DataCarregamentoCarga != null ? carga.DataCarregamentoCarga.Value.ToString("dd/MM/yyyy HH:mm") : "",
                ApoliceSeguro = ObterDadosDetalheCargaApoliceSeguro(apolicesSeguroAverbacao),
                PesoTotal = pesoTotal,
                PesoTotalComPallet = pesoTotal + pesoPallet,
                PesoLiquidoTotal = pesoLiquidoTotal,
                PreCalculoFrete = cargaPreCalculo != null ? cargaPreCalculo.Situacao.ObterDescricao() : string.Empty,
                PesoTotalNF = pesoTotalNF,
                PesoCubadoNF = pesoCubadoNF,
                ValorMercadoria = possuiOcultarInformacoesCarga ? serOcultarInformacoesCarga.ValidarOcultarValor(ocultarInformacoesCarga, TipoValorOcultarInformacoesCarga.ValorNotaFiscal, valorMercadoria) : valorMercadoria,
                ValorTotalProdutos = possuiOcultarInformacoesCarga ? serOcultarInformacoesCarga.ValidarOcultarValor(ocultarInformacoesCarga, TipoValorOcultarInformacoesCarga.ValorProdutos, valorTotalProdutos) : valorTotalProdutos,
                CodigoCargaOrigemCancelada = carga.CargaCancelamento != null ? carga.CargaCancelamento.Carga.Codigo : 0,
                PesoTotalReentrega = pesoTotalReentrega,
                NumeroCarregamento = carga.Carregamento?.NumeroCarregamento ?? "",
                DivisoriaIntegracao = carga != null ? (carga.DivisoriaIntegracaoLeilao ? "Sim" : "Não") : string.Empty,
                CargaPerigosaIntegracao = carga != null ? (carga.CargaPerigosaIntegracaoLeilao ? "Sim" : "Não") : string.Empty,
                Motoristas = ObterDadosDetalheCargaMotorista(motoristas, configuracaoEmbarcador),
                Ajudantes = ObterDadosDetalheCargaAjudante(ajudantes, configuracaoEmbarcador),
                Veiculo = ObterDadosDetalheCargaVeiculo(carga, cargaVeiculosContainer, cargaVeiculosContainerAnexo, estaEmParqueamento),
                Container = ObterDadosDetalheCargaContainer(carga),
                UltimaPosicao = ObterDadosDetalheCargaUltimaPosicao(carga, monitoramentosDados, configuracaoEmbarcador),
                CodigoMotoristaVeiculo = motoristaVeiculo?.Codigo ?? 0,
                NomeMotoristaVeiculo = motoristaVeiculo?.Nome ?? string.Empty,
                TipoOperacao = ObterDadosDetalheCargaTipoOperacao(carga, tiposOperacao),
                GrupoPessoa = new
                {
                    Codigo = carga.GrupoPessoaPrincipal?.Codigo ?? 0,
                    Descricao = carga.GrupoPessoaPrincipal?.Descricao ?? string.Empty,
                    ControlaPallets = carga.GrupoPessoaPrincipal?.ControlaPallets ?? false
                },
                CodigoContainerVeiculo = containerVeiculo != null ? containerVeiculo.Codigo.ToString() : Guid.NewGuid().ToString(),
                GensetVeiculo = containerVeiculo?.Genset,
                DataRetiradaCtrnVeiculo = containerVeiculo?.DataRetiradaCtrn?.ToString("dd/MM/yyyy HH:mm"),
                MaxGrossVeiculo = containerVeiculo?.MaxGross > 0 ? containerVeiculo.MaxGross.ToString("n0") : string.Empty,
                NumeroContainerVeiculo = containerVeiculo?.NumeroContainer,
                TaraContainerVeiculo = containerVeiculo?.TaraContainer > 0 ? containerVeiculo.TaraContainer.ToString("n0") : string.Empty,
                AnexosVeiculo = ObterDadosDetalheCargaAnexoVeiculo(containerVeiculo, cargaVeiculosContainerAnexo),
                Pedidos = ObterDadosDetalheCargaPedido(cargaPedidos),
                Transbordos = ObterDadosDetalheCargaTransbordo(cargaPedidosTransbordos),
                CargaCancelamento = ObterDadosDetalheCargaCancelamento(cargaCancelamento),
                carga.PercentualDesistencia,
                ObservacaoEmissaoCarga = carga.DadosSumarizados?.ObservacaoEmissaoCarga ?? string.Empty,
                ObservacaoEmissaoCargaTomador = carga.DadosSumarizados?.ObservacaoEmissaoCargaTomador ?? string.Empty,
                ObservacaoEmissaoCargaTipoOperacao = carga.DadosSumarizados?.ObservacaoEmissaoCargaTipoOperacao ?? string.Empty,
                Rota = possuiOcultarInformacoesCarga ?
                            serOcultarInformacoesCarga.ValidarOcultarValor(ocultarInformacoesCarga, TipoValorOcultarInformacoesCarga.Rota, new
                            {
                                Codigo = carga.Rota?.Codigo ?? 0,
                                Descricao = (!string.IsNullOrWhiteSpace(carga.Rota?.CodigoIntegracao) ? $"({carga.Rota?.CodigoIntegracao}) " : "") + carga.Rota?.Descricao ?? string.Empty
                            }) : new
                            {
                                Codigo = carga.Rota?.Codigo ?? 0,
                                Descricao = (!string.IsNullOrWhiteSpace(carga.Rota?.CodigoIntegracao) ? $"({carga.Rota?.CodigoIntegracao}) " : "") + carga.Rota?.Descricao ?? string.Empty
                            },
                QtdContainerCarga = cargaPedidos != null ? cargaPedidos.Count().ToString("D") : "",
                ModalCarga = carga.TipoOperacao != null ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoCobrancaMultimodalHelper.ObterDescricaoModal(carga.TipoOperacao.TipoCobrancaMultimodal) : "",
                PortoOrigemCarga = carga.PortoOrigem != null ? carga.PortoOrigem.Descricao : "",
                PortoDestinoCarga = carga.PortoDestino != null ? carga.PortoDestino.Descricao : "",
                RecebedorCarga = carga.DadosSumarizados?.Recebedores ?? "", //cargaPedidos != null && cargaPedidos.Count > 0 ? string.Join(", ", cargaPedidos.Where ob.Select(o => o.NomeRecebedor).Distinct().ToList()) : "",
                Moeda = carga.Moeda ?? MoedaCotacaoBancoCentral.Real,
                ValorCotacaoMoeda = carga.ValorCotacaoMoeda ?? 0m,
                ValorTotalMoeda = carga.ValorTotalMoeda ?? 0m,
                DataInicioViagem = carga.DataInicioViagem?.ToString("dd/MM/yyyy HH:mm"),
                Onda = carga.DadosSumarizados?.Onda ?? string.Empty,
                ClusterRota = carga.DadosSumarizados?.ClusterRota ?? string.Empty,
                QuantidadeVolumes = carga.DadosSumarizados?.VolumesTotal ?? 0,
                ExternalDT1 = carga.ExternalID1 ?? string.Empty,
                ExternalDT2 = carga.ExternalID2 ?? string.Empty,
                QuantidadeVolumesNF = configuracaoEmbarcador.ExibirQuantidadeVolumesNF ? (carga.DadosSumarizados?.QuantidadeVolumesNF ?? 0) : 0,
                DataPrevisaoInicioViagem = carga.DadosSumarizados?.DataPrevisaoInicioViagem?.ToString("dd/MM/yyyy HH:mm") ?? string.Empty,
                MensagemProblemaIntegracaoGrMotoristaVeiculo = !string.IsNullOrWhiteSpace(carga.MensagemProblemaIntegracaoGrMotoristaVeiculo) ? "Retorno GR: " + carga.MensagemProblemaIntegracaoGrMotoristaVeiculo.Replace("\n", "") : string.Empty,
                carga.ProtocoloIntegracaoGR,
                RotaEmbarcador = carga.DadosSumarizados?.RotaEmbarcador ?? string.Empty,
                DataUltimaLiberacao = carga.DadosSumarizados?.DataUltimaLiberacao ?? string.Empty,
                UsuarioCriacaoRemessa = carga.DadosSumarizados?.UsuarioCriacaoRemessa ?? string.Empty,
                NumeroOrdem = carga.DadosSumarizados?.NumeroOrdem ?? string.Empty,
                Cubagem = (cargaPedidos != null && cargaPedidos.Where(obj => obj.Cubagem > 0).ToList().Count > 0) ? cargaPedidos.Sum(obj => obj.Cubagem).ToString("n2") : "",
                RegiaoDestino = carga.DadosSumarizados?.RegiaoDestino ?? string.Empty,
                NumeroEntregasFinais = carga.DadosSumarizados?.NumeroEntregasFinais ?? 0,
                ObservacaoLocalEntrega = carga.ObservacaoLocalEntrega ?? string.Empty,
                PLPsCorreios = carga.DadosSumarizados?.PLPsCorreios ?? "",
                ProvedoresOS = carga.DadosSumarizados?.ProvedoresOS ?? "",
                ZonaTransporte = carga.DadosSumarizados?.ZonasTransporte ?? "",
                NumerosEtiquetasCorreios = carga.DadosSumarizados?.NumerosEtiquetasCorreios ?? "",
                LocalParqueamento = carga.DadosSumarizados?.LocalParqueamento ?? string.Empty,
                ObservacaoTransportador = carga.ObservacaoTransportador ?? string.Empty,
                ObservacaoCarregamentoRoteirizacao = carga.ObservacaoCarregamentoRoteirizacao ?? string.Empty,
                TipoServicoCarga = carga.TipoServicoCarga.HasValue ? carga.TipoServicoCarga.Value : TipoServicoCarga.NaoInformado,
                IdMontagemContainer = idMontagemContainer,
                NumeroContainerCarga = numeroContainerCarga,
                CodigoCargaJanelaCarregamentoTransportador = codigoCargaJanelaCarregamentoTransportador,
                TermoAceite = termoAceite,
                DadosTransporte = ObterDadosDetalheCargaDadosTransporte(carga, cargaPedidos, transportadoraManual, quantidadePallets, mensagensAlerta, unitOfWork),
                RemetenteTrasferencia = cargaPedidos != null ? cargaPedidos.Select(x => x.Remetente?.Codigo).FirstOrDefault() : 0d,
                DataRetornoCD = carga.DataRetornoCD?.ToString("dd/MM/yyyy HH:mm") ?? string.Empty,
                ValorTotalMercadoriaPedidos = carga.DadosSumarizados?.ValorTotalMercadoriaPedidos ?? 0,
                ObservacaoInformadaPeloTransportador = carga.DadosSumarizados?.ObservacaoInformadaPeloTransportador ?? string.Empty,
                ExcecaoCab = (carga.DadosSumarizados?.ExcecaoCab.HasValue ?? false) ? carga.DadosSumarizados.ExcecaoCab.Value ? "Sim" : "Não" : string.Empty,
                DadosIntercab = ObterDadosDetalheCargaIntercab(carga, cargaPedidos, integracaoIntercab, unitOfWork),
                NotasFilhasRecibidas = recebeuNotasFilhas.HasValue ? recebeuNotasFilhas.Value ? "SIM" : "NÃO" : string.Empty,
                CategoriaCargaEmbarcador = carga?.CategoriaCargaEmbarcador ?? string.Empty,
                SetPointVeiculo = carga?.SetPointVeiculo ?? string.Empty,
                RangeTempCarga = carga.FaixaTemperatura != null ? $"{carga.FaixaTemperatura.FaixaInicial} até {carga.FaixaTemperatura.FaixaFinal}" : string.Empty,
                DadosMercosul = ObterDadosMercosulCarga(carga),
                ObservacaoRelatorioDeEmbarque = carga.DadosSumarizados?.ObservacaoRelatorioDeEmbarque ?? string.Empty,
                CargaTrechoSumarizada = carga?.DadosSumarizados?.CargaTrecho?.ObterDescricao() ?? string.Empty,
                QuantidadeNFEs = quantidadeNFEs,
                VolumesCaixasNFEs = volumesCaixasNFEs,
                ValidarMotoristaTelerisco = integracoesMotoristas.Count() > 0 && possuiIntegracaoTelerisco ? (integracoesMotoristas.Where(obj => obj.TipoIntegracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Telerisco).FirstOrDefault()?.SituacaoIntegracao == SituacaoIntegracao.Integrado ? "Validado na Telerisco" : "Não validado na Telerisco") : string.Empty,
                ValidarMotoristaBRK = integracaoBRKMotorista,
                ValidarIntegracaoPlacaBRK = integracaoBRKPlaca,
                PlacaValidadoBrasilRisk = placaValidadoBrasilRisk,
                MotoristaValidadoBrasilRisk = motoristaValidadoBrasilRisk,
                LegendaCargaAcordoTipoOperacao = carga?.TipoOperacao?.TipoServicoMultimodal ?? TipoServicoMultimodal.Normal,
                ValorFreteSimulacao = simulacaoFrete?.ValorFrete.ToString("n4") ?? string.Empty,
                NumeroOT = carga?.NumeroOT ?? string.Empty,
                LinhaSeparacao = descricaoLinhaSeparacao.DescricaoLinhaSeparacao != "" ? descricaoLinhaSeparacao.DescricaoLinhaSeparacao : string.Empty,
                SituacaoRecebimentoNotas = configuracaoEmbarcador.UtilizaEmissaoMultimodal ? carga.FormaIntegracao.HasValue ? carga.FormaIntegracao.Value.ObterDescricao() : string.Empty : string.Empty,
                RetornoAE = carga.DescricaoSituacaoAE ?? string.Empty,
                CategoriaOS = carga.CategoriaOS?.ObterDescricao() ?? string.Empty,
                TipoOSConvertido = carga.TipoOSConvertido?.ObterDescricao() ?? string.Empty,
                TipoOS = carga.TipoOS?.ObterDescricao() ?? string.Empty,
                DirecionamentoCustoExtra = carga.TipoOperacao?.ConfiguracaoCarga?.DirecionamentoCustoExtra.ObterDescricao() ?? string.Empty,
                StatusCustoExtra = carga.StatusCustoExtra?.ObterDescricao() ?? string.Empty,
                UtilizarDirecionamentoCustoExtra = carga.TipoOperacao?.ConfiguracaoCarga?.UtilizarDirecionamentoCustoExtra ?? false,
                CanalVenda = carga.DadosSumarizados?.CanalVenda ?? string.Empty,
                TipoCobrancaMultimodal = tipoCobrancaMultimodal,
                CentroDeResultado = (configuracaoFinanceiro?.EfetuarVinculoCentroResultadoCTeSubstituto ?? false) ? new { Codigo = carga.TipoOperacao?.ConfiguracaoPagamentos?.CentroResultado?.Codigo ?? 0, Descricao = carga.TipoOperacao?.ConfiguracaoPagamentos?.CentroResultado?.Descricao ?? "" } : null,
                IdentificadorDeRota = carga.IdentificadorDeRota ?? string.Empty,

                // Se o seu campo é um simples booleano, por favor adicionar aqui ou na propriedade 'Configuracoes'
                Validacoes = new
                {
                    PermitirAlterarDataRetornoCDCarga = (carga.TipoOperacao?.ConfiguracaoCarga?.PermitirAlterarDataRetornoCDCarga ?? false) && situacaoPermitirAlterarDataCarregamentoCarga,
                    EscolherHorarioCarregamentoPorLista = cargaJanelaCarregamento?.CentroCarregamento?.EscolherHorarioCarregamentoPorLista ?? false,
                    NaoPermitirAlterarDataCarregamentoCarga = !permitirAlterarDataCarregamentoCarga,
                    ExigeConfirmacaoTracao = exigeConfirmacaoTracao,
                    PossuiRotaDefinida = possuiRotaDefinida,
                    PossuiGenset = possuiGenset,
                    PermitirAtualizarContainerVeiculo = permitirAtualizarContainerVeiculo,
                    CargaAgrupada = cargaAgrupada,
                    CargaRedespacho = possuiRedespacho,
                    PossuiCTeAnteriorFilialEmissora = possuiCTeAnteriorFilialEmissora,
                    PossuiIntegracaoValePedagio = possuiIntegracaoValePedagio,
                    AutoTipoCarga = tipoCargaModeloVeicularAutoConfig != null && (tipoCargaModeloVeicularAutoConfig.TipoAutomatizacaoTipoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoAutomatizacaoTipoCarga.Desabilitado),
                    AutoModeloVeicular = tipoCargaModeloVeicularAutoConfig != null && tipoCargaModeloVeicularAutoConfig.AutoModeloVeicularHabilitado,
                    ExigirInformarContainer = exigirInformarContainerCarga,
                    ExigirInformarRetiradaContainer = exigirInformarRetiradaContainer,
                    PossuiNFs = possuiNFs,
                    possuiCTe = possuiCTe,
                    possuiNFSManual = possuiNFSManual,
                    possuiAverbacaoCTe = possuiAverbacaoCTe,
                    PossuiAverbacaoMDFe = possuiAverbacaoMDFe,
                    PossuiOrdemEmbarque = (ordensEmbarque?.Count ?? 0) > 0,
                    AguardandoNFs = aguardandoNFS,
                    configuracaoEmbarcador.PermitirInformarAnexoContainerCarga,
                    AguardandoCTEs = aguardandoCTEs,
                    PermitirLiberarComProblemaIntegracaoGrMotoristaVeiculo = permitirLiberarComProblemaIntegracaoGrMotoristaVeiculo,
                    PossuiMontagemContainer = possuiMontagemContainer,
                    ExigeTermoAceiteTransportador = ((carga.TipoOperacao?.ExigirTermoAceite ?? false) || (cargaJanelaCarregamento?.CentroCarregamento?.ExigirTermoAceiteTransporte ?? false)) && ((from o in termosAceite where o.Carga.Codigo == carga.Codigo select o).ToList().Count <= 0),
                    PossuiSimulacaoFrete = possuiSimulacaoFrete,
                    ContemFaturamento = contemFaturamento,
                    TodosCTesForamFaturados = todosCTesForamFaturados,
                    ExistePacote = existePacote,
                    VisualizarLegendaCargaAcordoTipoOperacao = configuracaoGeralCarga?.VisualizarLegendaCargaAcordoTipoOperacao ?? false,
                    PossuiOcultarInformacoesCarga = possuiOcultarInformacoesCarga && (ocultarInformacoesCarga?.ValorFrete ?? false),
                    ValorToneladaSimulado = (simulacaoFrete?.ValorPorPeso ?? 0) > 0 ? (simulacaoFrete.ValorPorPeso * 1000).ToString("n4") : string.Empty,
                    PermitirBuscarNFesEmillenium = repTipoIntegracao.ExistePorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Emillenium) && carga.Pedidos != null && carga.Pedidos.Count > 0 && carga.Pedidos.Any(obj => obj.NotasFiscais == null || obj.NotasFiscais.Count == 0),
                    OcultarVisualizarRotaMapa = possuiOcultarInformacoesCarga && (ocultarInformacoesCarga?.VisualizarRota ?? false),
                    QuebraContainer = carga.CargaComQuebraDeContainer,
                    Transbordo = new
                    {
                        Pendencia = false, //(from obj in carga.Transbordos where (obj.SituacaoTransbordo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoTransbordo.EmEmissao || obj.SituacaoTransbordo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoTransbordo.AgContratoFrete) select obj).Any(),
                        Problemas = false, //(from obj in carga.Transbordos where (obj.SituacaoTransbordo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoTransbordo.CancelamentoRejeitado || obj.SituacaoTransbordo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoTransbordo.Rejeicao) select obj).Any(),
                        Completos = false, //(from obj in carga.Transbordos where (obj.SituacaoTransbordo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoTransbordo.EmTransporte || obj.SituacaoTransbordo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoTransbordo.Finalizado) select obj).Any(),
                    },
                    CargaCritica = carga?.CargaCritica == true ? true : monitoramentosDados?.CodigoCarga > 0 ? monitoramentosDados?.MonitoramentoCritico ?? false : false,
                    InformarDocaNaEtapaUmDaCarga = (docaCarregamento != null)
                },
                NumeroPreCarga = NumeroPreCarga,
                LocalCarregamento = docaCarregamento?.LocalCarregamento != null ? new { Codigo = docaCarregamento.LocalCarregamento.Codigo, Descricao = docaCarregamento.LocalCarregamento.Descricao } : new { Codigo = 0, Descricao = "" },
                carga.PossuiOperacaoContainer,
                carga.RealizandoOperacaoContainer
            };

            return dynCarga;
        }

        private static decimal ObterValorFretePorCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, ConfiguracaoTMS configuracaoEmbarcador, OcultarInformacoesCarga.OcultarInformacoesCarga serOcultarInformacoesCarga, bool possuiOcultarInformacoesCarga, Dominio.Entidades.Embarcador.Cargas.OcultarInformacoesCarga.OcultarInformacoesCarga ocultarInformacoesCarga)
        {
            bool naoIncluirValorICMSBasecalculoQuandoValorFreteInformadoOperador = carga.TipoOperacao?.ConfiguracaoCalculoFrete?.NaoIncluirValorICMSBasecalculoQuandoValorFreteInformadoOperador ?? false;

            if (naoIncluirValorICMSBasecalculoQuandoValorFreteInformadoOperador && carga.TipoFreteEscolhido == TipoFreteEscolhido.Operador)
                return carga.ValorFreteLiquido;

            return (possuiOcultarInformacoesCarga ? serOcultarInformacoesCarga.ValidarOcultarValor(ocultarInformacoesCarga, TipoValorOcultarInformacoesCarga.ValorFrete, (configuracaoEmbarcador.VisualizarValorNFSeDescontandoISSRetido ? carga.ValorFreteAPagar - (carga.ValorRetencaoISS > 0 ? carga.ValorRetencaoISS : carga.ValorISS) : carga.ValorFreteAPagar))
                                        : (configuracaoEmbarcador.VisualizarValorNFSeDescontandoISSRetido ? carga.ValorFreteAPagar - (carga.ValorRetencaoISS > 0 ? carga.ValorRetencaoISS : carga.ValorISS) : carga.ValorFreteAPagar));
        }

        private dynamic ObterDadosDetalheCargaIntercab(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedido> cargaPedidos, Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab, UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaMDFeManual repCargaMDFeManual = new Repositorio.Embarcador.Cargas.CargaMDFeManual(unitOfWork);
            Repositorio.Embarcador.CTe.CTeSVMMultimodal repCTeSVMMultimodal = new Repositorio.Embarcador.CTe.CTeSVMMultimodal(unitOfWork);

            bool cargaPedidoMercante = cargaPedidos?.Any(o => o.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto || o.TipoServicoMultimodal == TipoServicoMultimodal.VinculadoMultimodalTerceiro) ?? false;
            bool cargaComEtapaFaturamento = cargaPedidos?.Any(o => o.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorta || o.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorta
                                                                || o.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto || o.TipoPropostaMultimodal == TipoPropostaMultimodal.Feeder) ?? false;
            bool cargaComMDFeAquaviario = cargaPedidos?.Any(o => o.TipoCobrancaMultimodal == TipoCobrancaMultimodal.CTEAquaviario) ?? false;
            bool cargaPortoPorto = cargaPedidos?.Any(o => o.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto) ?? false;
            bool cargaPortaPorta = cargaPedidos?.Any(o => o.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorta) ?? false;
            bool cargaFeeder = cargaPedidos?.Any(o => o.TipoPropostaMultimodal == TipoPropostaMultimodal.Feeder) ?? false;

            bool possuiMDFeAquaviarioRejeitado = false;
            bool possuiMDFeAquaviarioPendente = false;
            bool possuiMDFeAquaviarioAutorizado = false;

            bool possuiCTePendenteSVM = false;
            bool possuiSVMPendenteAutorizacao = false;
            bool habilitarTimelineSVMProprio = false;

            if (!(integracaoIntercab?.HabilitarTimelineCargaPortoPorto ?? false))
                cargaPortoPorto = false;

            if ((integracaoIntercab?.HabilitarTimelineCargaSVMProprio ?? false) && carga.CargaSVM)
                habilitarTimelineSVMProprio = true;

            if (cargaComMDFeAquaviario || habilitarTimelineSVMProprio)
            {
                possuiMDFeAquaviarioRejeitado = repCargaMDFeManual.PossuiMFDePorCargaPorSituacao(carga.Codigo, Dominio.Enumeradores.StatusMDFe.Rejeicao);
                possuiMDFeAquaviarioPendente = repCargaMDFeManual.PossuiMFDePendentePorCarga(carga.Codigo);
                possuiMDFeAquaviarioAutorizado = repCargaMDFeManual.PossuiMFDeAutorizadoPorCarga(carga.Codigo);
            }

            if (cargaPortaPorta && (integracaoIntercab?.HabilitarTimelineCargaPorta ?? false))
            {
                possuiCTePendenteSVM = repCTeSVMMultimodal.PossuiCTePendenteSVM(carga.Codigo);
                possuiSVMPendenteAutorizacao = repCTeSVMMultimodal.PossuiSVMPendenteAutorizacao(carga.Codigo);
            }

            return new
            {
                Mercante = (integracaoIntercab?.HabilitarTimelineMercanteCarga ?? false) && (cargaPedidoMercante || habilitarTimelineSVMProprio),
                Faturamento = (integracaoIntercab?.HabilitarTimelineFaturamentoCarga ?? false) && cargaComEtapaFaturamento && !habilitarTimelineSVMProprio,
                IntegracaoFaturamento = (integracaoIntercab?.HabilitarTimelineIntegracaoFaturaCarga ?? false) && cargaComEtapaFaturamento && !habilitarTimelineSVMProprio,
                MDFeAquaviario = (integracaoIntercab?.HabilitarTimelineMDFeAquaviario ?? false) && (cargaComMDFeAquaviario || habilitarTimelineSVMProprio),
                OcultarMDFeRodoviario = integracaoIntercab?.HabilitarTimelineMDFeAquaviario ?? false,
                ModificarTimelineIntegracaoCarga = integracaoIntercab?.ModificarTimelineIntegracaoCarga ?? false,
                AtivarNovosFiltrosConsultaCarga = integracaoIntercab?.AtivarNovosFiltrosConsultaCarga ?? false,
                carga.TodosCTesComMercante,
                carga.TodosCTesComManifesto,
                PossuiMDFeAquaviarioGeradoMasNaoVinculado = carga.MDFeAquaviarioGeradoMasNaoVinculado,
                PossuiMDFeAquaviarioRejeitado = possuiMDFeAquaviarioRejeitado,
                PossuiMDFeAquaviarioPendente = possuiMDFeAquaviarioPendente,
                PossuiMDFeAquaviarioAutorizado = possuiMDFeAquaviarioAutorizado,
                CargaPortoPortoTimelineHabilitado = cargaPortoPorto && (integracaoIntercab?.HabilitarTimelineCargaPortoPorto ?? false),
                CargaPortoPorto = cargaPortoPorto,
                carga.CargaPortoPortoPendenciaDocumento,
                CargaPortaPorta = cargaPortaPorta,
                CargaPortaPortaTimelineHabilitado = cargaPortaPorta && (integracaoIntercab?.HabilitarTimelineCargaPorta ?? false),
                PossuiCTePendenteSVM = possuiCTePendenteSVM,
                PossuiSVMPendenteAutorizacao = possuiSVMPendenteAutorizacao,
                CargaSVMProprioTimelineHabilitado = habilitarTimelineSVMProprio,
                HabilitarTimelineCargaFeeder = cargaFeeder && (integracaoIntercab?.HabilitarTimelineCargaFeeder ?? false),
                HabilitarTimelineCargaParaFeeder = integracaoIntercab?.HabilitarTimelineCargaFeeder ?? false,
            };
        }

        private dynamic ObterDadosMercosulCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga)
        {
            return new
            {
                carga.Mercosul,
                carga.PossuiFacturaFake,
                carga.EmitindoCRT,
                carga.Internacional
            };
        }

        private dynamic ObterDadosDetalheCargaAnexoVeiculo(Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer containerVeiculo, List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainerAnexo> cargaVeiculosContainerAnexo)
        {
            return cargaVeiculosContainerAnexo
                   .Where(anexo => anexo.EntidadeAnexo.Codigo == containerVeiculo?.Codigo)
                   .Select(anexo => new
                   {
                       anexo.Codigo,
                       anexo.Descricao,
                       anexo.NomeArquivo,
                       TipoAnexo = anexo.TipoAnexo?.Codigo ?? 0
                   }).ToList();
        }

        private dynamic ObterDadosDetalheCargaTransbordo(List<Dominio.ObjetosDeValor.Embarcador.Carga.PedidoTransbordo> cargaPedidosTransbordos)
        {
            return cargaPedidosTransbordos?.Select(obj => new
            {
                obj.Sequencia,
                obj.Navio,
                obj.Porto
            }).ToList();
        }

        private dynamic ObterDadosDetalheCargaDadosTransporte(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedido> cargaPedidos, string transportadoraManual, decimal quantidadePallets, List<Dominio.ObjetosDeValor.Embarcador.Alertas.MensagemAlerta> MensagensAlerta, Repositorio.UnitOfWork unitOfWork)
        {
            return new
            {
                DataBaseCRT = cargaPedidos.FirstOrDefault()?.DataBaseCRT?.ToString("dd/MM/yyyy HH:mm") ?? string.Empty,
                carga.NumeroPager,
                ModeloVeicularCarga = carga.ModeloVeicularCarga != null ? new { Codigo = carga.ModeloVeicularCarga.Codigo, Descricao = "(" + carga.ModeloVeicularCarga.CodigoIntegracao + ")" + " " + carga.ModeloVeicularCarga.Descricao, NumeroReboques = carga.ModeloVeicularCarga.NumeroReboques ?? 0 } : new { Codigo = 0, Descricao = "", NumeroReboques = 0 },
                TipoCarga = carga.TipoDeCarga != null ? new { Codigo = carga.TipoDeCarga.Codigo, Descricao = carga.TipoDeCarga.Descricao } : new { Codigo = 0, Descricao = "" },
                Empresa = carga.Empresa != null ? new { carga.Empresa.Codigo, Descricao = transportadoraManual } : new { Codigo = 0, Descricao = "" },
                PedidoViagemNavio = carga.PedidoViagemNavio != null ? new { Codigo = carga.PedidoViagemNavio.Codigo, Descricao = carga.PedidoViagemNavio.Descricao } : new { Codigo = 0, Descricao = "" },
                PortoOrigem = carga.PortoOrigem != null ? new { Codigo = carga.PortoOrigem.Codigo, Descricao = carga.PortoOrigem.Descricao } : new { Codigo = 0, Descricao = "" },
                PortoDestino = carga.PortoDestino != null ? new { Codigo = carga.PortoDestino.Codigo, Descricao = carga.PortoDestino.Descricao } : new { Codigo = 0, Descricao = "" },
                TerminalOrigem = carga.TerminalOrigem != null ? new { Codigo = carga.TerminalOrigem.Codigo, Descricao = carga.TerminalOrigem.Descricao } : new { Codigo = 0, Descricao = "" },
                TerminalDestino = carga.TerminalDestino != null ? new { Codigo = carga.TerminalDestino.Codigo, Descricao = carga.TerminalDestino.Descricao } : new { Codigo = 0, Descricao = "" },
                TipoContainerDescricao = carga.TipoContainer?.Descricao ?? "",
                TipoContainer = new { Codigo = carga.TipoContainer?.Codigo ?? 0, Descricao = carga.TipoContainer?.Descricao ?? "" },
                InicioCarregamento = carga.DataCarregamentoCarga.HasValue ? carga.DataCarregamentoCarga.Value.ToString("dd/MM/yyyy HH:mm") : carga.Carregamento?.DataCarregamentoCarga?.ToString("dd/MM/yyyy HH:mm") ?? "",
                TerminoCarregamento = carga.DataPrevisaoTerminoCarga.HasValue ? carga.DataPrevisaoTerminoCarga.Value.ToString("dd/MM/yyyy HH:mm") : SugerirDataTerminoCarregamento(carga, unitOfWork) ?? "",
                QuantidadePaletes = quantidadePallets.ToString(),
                HorarioLimiteConfirmacaoMotorista = carga.DataLimiteConfirmacaoMotorista.HasValue ? carga.DataLimiteConfirmacaoMotorista.Value.ToString("dd/MM/yyyy HH:mm:ss") : "",
                MotoristaRecusouCarga = MensagensAlerta.Any(x => x.Tipo == TipoMensagemAlerta.CargaRecusadaMotorista),
                TipoCarregamento = carga.TipoCarregamento != null ? new { Codigo = carga.TipoCarregamento.Codigo, Descricao = carga.TipoCarregamento.Descricao } : new { Codigo = 0, Descricao = "" },
                CentroResultado = new { Codigo = carga.Pedidos?.FirstOrDefault()?.Pedido?.CentroResultado?.Codigo ?? 0, Descricao = carga.Pedidos?.FirstOrDefault()?.Pedido?.CentroResultado?.Descricao ?? "" },
                PossuiInformacoesIMO = carga.Empresa != null ? (!string.IsNullOrEmpty(carga.Empresa.IMO) && (carga.Empresa.DataValidadeIMO.HasValue && carga.Empresa.DataValidadeIMO.Value > DateTime.Now)) : false,
                Navio = carga.Navio != null ? new { Codigo = carga.Navio.Codigo, Descricao = carga.Navio.Descricao } : new { Codigo = 0, Descricao = "" },
                Balsa = carga.Balsa != null ? new { Codigo = carga.Balsa.Codigo, Descricao = carga.Balsa.Descricao } : new { Codigo = 0, Descricao = "" },
                JustificativaAutorizacaoCarga = carga.JustificativaAutorizacaoCarga != null ? new { Codigo = carga.JustificativaAutorizacaoCarga.Codigo, Descricao = carga.JustificativaAutorizacaoCarga.Descricao } : new { Codigo = 0, Descricao = "" },
                TransportadorSubcontratado = carga.EmpresaSubcontrada != null ? new { Codigo = carga.EmpresaSubcontrada.Codigo, Descricao = carga.EmpresaSubcontrada.Descricao } : new { Codigo = 0, Descricao = "" },
                Setor = carga.Setor != null ? new { Codigo = carga.Setor.Codigo, Descricao = carga.Setor.Descricao } : new { Codigo = 0, Descricao = "" },
                ObservacaoCarga = carga.Observacao
            };
        }

        private string SugerirDataTerminoCarregamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaJanelaCarregamento repositorioCargaJanelaCarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamento(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento = repositorioCargaJanelaCarregamento.BuscarPorCarga(carga.Codigo);
            Dominio.ObjetosDeValor.Embarcador.Carga.CargaDadosTransporte dadosTransporte = new Dominio.ObjetosDeValor.Embarcador.Carga.CargaDadosTransporte();

            Repositorio.Embarcador.Logistica.TempoCarregamento reposiotioTempoCarregamento = new Repositorio.Embarcador.Logistica.TempoCarregamento(unitOfWork);
            List<Dominio.Entidades.Embarcador.Logistica.TempoCarregamento> listaTempoCarregamento = reposiotioTempoCarregamento.BuscarPorCentroCarregamento(cargaJanelaCarregamento?.CentroCarregamento?.Codigo ?? 0);


            if (cargaJanelaCarregamento == null && (listaTempoCarregamento?.Count() == 0) && carga.ModeloVeicularCarga == null)
                return "";

            Dominio.Entidades.Embarcador.Logistica.TempoCarregamento tempoCarregamento = listaTempoCarregamento.Where(a => a.ModeloVeicular.Codigo == carga?.ModeloVeicularCarga?.Codigo && a?.TipoCarga == carga?.TipoDeCarga).FirstOrDefault();
            string dataTerminoCarregamento = "";

            if (tempoCarregamento != null && carga?.DataPrevisaoTerminoCarga == null)
                dataTerminoCarregamento = carga?.DataCarregamentoCarga?.AddMinutes(tempoCarregamento.Tempo).ToString("dd/MM/yyyy HH:mm") ?? "";

            return dataTerminoCarregamento;

        }

        private dynamic ObterDadosDetalheCargaPedido(List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaPedido> cargaPedidos)
        {
            return cargaPedidos.Select(obj => new
            {
                CodigoCargaPedido = obj.Codigo,
                obj.NumeroPedidoEmbarcador,
                obj.CienciaDoEnvioDaNotaInformado,
                obj.ReentregaSolicitada,
                obj.PedidoTransbordo,
                obj.AgInformarRecebedor,
                obj.CTeEmitidoNoEmbarcador,
                obj.TipoContratacaoCarga,
                obj.AdicionadaManualmente,
                obj.NumeroBooking,
                obj.NumeroContainer,
                obj.NumeroPedido,
                obj.PossuiNFePesoZerado,
                obj.PossuiNFeLancada,
                obj.CodigoPedidoCliente,
                obj.CanceladoAposVinculoCarga
            }).ToList();
        }

        private dynamic ObterDadosDetalheCargaCancelamento(Dominio.Entidades.Embarcador.Cargas.CargaCancelamento cargaCancelamento)
        {
            if (cargaCancelamento != null)
            {
                return new
                {
                    MensagemRejeicaoCancelamento = cargaCancelamento.MensagemRejeicaoCancelamento,
                    MotivoDoCancelamento = cargaCancelamento.MotivoCancelamento,
                    SituacaoCargaNoCancelamento = cargaCancelamento.SituacaoCargaNoCancelamento,
                    UsuarioERPSolicitouCancelamento = cargaCancelamento.UsuarioERPSolicitouCancelamento,
                    DataCancelamento = cargaCancelamento.DataCancelamento.Value.ToString("dd/MM/yyyy HH:mm")
                };
            }

            return new
            {
                MensagemRejeicaoCancelamento = "",
                MotivoDoCancelamento = "",
                SituacaoCargaNoCancelamento = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.NaLogistica,
                UsuarioERPSolicitouCancelamento = "",
                DataCancelamento = ""
            };
        }

        private dynamic ObterDadosDetalheCargaTipoOperacao(Dominio.Entidades.Embarcador.Cargas.Carga carga, string tiposOperacao)
        {
            return new
            {
                Codigo = carga.TipoOperacao?.Codigo ?? 0,
                Descricao = carga.TipoOperacao != null ? tiposOperacao : "",
                TipoImpressaoDiarioBordo = carga.TipoOperacao?.TipoImpressaoDiarioBordo ?? TipoImpressaoDiarioBordo.Nenhum,
                ExigeChaveVenda = carga.TipoOperacao?.ExigeChaveVendaAntesConfirmarNotas ?? false,
                SolicitarNotasFiscaisAoSalvarDadosTransportador = carga.TipoOperacao?.SolicitarNotasFiscaisAoSalvarDadosTransportador ?? false,
                PermitirValorFreteInformadoPeloEmbarcadorZerado = carga.TipoOperacao?.PermitirValorFreteInformadoPeloEmbarcadorZerado ?? false,
                NaoExibirDetalhesDoFretePortalTransportador = carga.TipoOperacao?.NaoExibirDetalhesDoFretePortalTransportador ?? false,
                ImprimirRelatorioRomaneioEtapaImpressaoCarga = carga.TipoOperacao?.ImprimirRelatorioRomaneioEtapaImpressaoCarga ?? false,
                NaoPermiteAvancarCargaSemDataPrevisaoDeEntrega = carga.TipoOperacao?.NaoPermiteAvancarCargaSemDataPrevisaoDeEntrega ?? false,
                ImprimirCRT = carga.TipoOperacao?.ImprimirCRT ?? false,
                UtilizarPlanoViagem = carga.TipoOperacao?.UtilizarPlanoViagem ?? false,
                PermiteRealizarImpressaoCarga = carga.TipoOperacao?.PermiteRealizarImpressaoCarga ?? false,
                PermitirAlterarVolumesNaCarga = carga.TipoOperacao?.PermitirAlterarVolumesNaCarga ?? false,
                PossuiConsolidacao = carga.CargaGeradaViaDocumentoTransporte,
                PermitirConsultaDeValoresPedagioSemParar = carga.TipoOperacao?.PermitirConsultaDeValoresPedagioSemParar ?? false,
                ValidarSeCargaPossuiVinculoComPreCarga = carga.TipoOperacao?.ValidarSeCargaPossuiVinculoComPreCarga ?? false,
                ExibirOperadorInsercaoCargaNoPortalTransportador = carga.TipoOperacao?.ConfiguracaoCarga?.ExibirOperadorInsercaoCargaNoPortalTransportador ?? false,
                PermitirAdicionarObservacaoNaEtapaUmDaCarga = carga.TipoOperacao?.ConfiguracaoCarga?.PermitirAdicionarObservacaoNaEtapaUmDaCarga ?? false,
                ExibirFiltroDePedidosEtapaNotaFiscal = carga.TipoOperacao?.ConfiguracaoCarga?.ExibirFiltroDePedidosEtapaNotaFiscal ?? false,
                ObrigarInformarRICnaColetaDeConteiner = carga.TipoOperacao?.ObrigarInformarRICnaColetaDeConteiner ?? false,
                TipoPrechekin = carga.TipoOperacao != null
                                                   ? carga.TipoOperacao.TipoConsolidacao == EnumTipoConsolidacao.PreCheckIn
                                                   : false,
                TipoMilkrun = carga.TipoOperacao != null
                                                 ? carga.TipoOperacao.TipoConsolidacao == EnumTipoConsolidacao.NaoConsolida && !carga.TipoOperacao.ExigeNotaFiscalParaCalcularFrete
                                                 : false,
                AlertarTransportadorNaoIMOCargasPerigosas = carga.TipoOperacao?.ConfiguracaoTransportador?.AlertarTransportadorNaoIMOCargasPerigosas ?? false,
                PossuiIntegracaoLogiun = carga.TipoOperacao?.PossuiIntegracaoLogiun ?? false,
                PermitirTransportadorInformeNotasCompativeis = carga.TipoOperacao?.PermitirTransportadorInformeNotasCompativeis ?? false,
                PermiteInformarTransportadorEtapaUmQuandoNotaFiscalNaoRecebidaAntesCalculoFrete = carga.TipoOperacao?.ConfiguracaoCarga?.PermiteInformarTransportadorEtapaUmQuandoNotaFiscalNaoRecebidaAntesCalculoFrete ?? false,
                PermiteInformarMotoristasSomenteEtapaUmQuandoNotasFiscaisNaoSaoRecebidasAntesCalcularFrete = carga.TipoOperacao?.ConfiguracaoCarga?.PermiteInformarMotoristasSomenteEtapaUmQuandoNotasFiscaisNaoSaoRecebidasAntesCalcularFrete ?? false,
                TipoCobrancaMultimodal = carga.TipoOperacao?.TipoCobrancaMultimodal ?? TipoCobrancaMultimodal.Nenhum,
                PermiteEscolherDestinacaoDoComplementoDeFrete = carga.TipoOperacao?.ConfiguracaoCalculoFrete?.PermiteEscolherDestinacaoDoComplementoDeFrete ?? false,
                CalcularFretePeloBIDPedidoOrigem = carga.TipoOperacao?.ConfiguracaoCalculoFrete?.CalcularFretePeloBIDPedidoOrigem ?? false,
                InformarValorFreteTerceiroManualmente = carga.TipoOperacao?.ConfiguracaoCalculoFrete?.InformarValorFreteTerceiroManualmente ?? false,
                PermitirSelecionarPreCargaNaCarga = carga.TipoOperacao?.ConfiguracaoCarga?.PermitirSelecionarPreCargaNaCarga ?? false,
                ObrigatorioInformarAliquotaImpostoSuspensoeValor = carga.TipoOperacao?.ConfiguracaoCarga?.ObrigatorioInformarAliquotaImpostoSuspensoeValor ?? false,
                IncrementaCodigoPorTipoOperacao = carga.TipoOperacao?.ConfiguracaoCarga?.IncrementaCodigoPorTipoOperacao ?? false,
                AdicionaPrefixoCodigoCarga = carga.TipoOperacao?.ConfiguracaoCarga?.AdicionaPrefixoCodigoCarga ?? string.Empty,
                ObrigatorioJustificarCustoExtra = carga.TipoOperacao?.ConfiguracaoCarga?.ObrigatorioJustificarCustoExtra ?? false,
                LiberarCargaSemPlanejamento = carga.TipoOperacao?.ConfiguracaoCarga?.LiberarCargaSemPlanejamento ?? false,
                HabilitarTipoPagamentoValePedagio = carga.TipoOperacao?.HabilitarTipoPagamentoValePedagio ?? false,
                TipoPagamentoValePedagio = carga.TipoPagamentoValePedagio,
                InformarTransportadorSubcontratadoEtapaUm = carga.TipoOperacao?.ConfiguracaoCarga?.InformarTransportadorSubcontratadoEtapaUm ?? false,
                PermiteConsultarPorPacotesLoggi = carga.TipoOperacao?.PermiteConsultarPorPacotesLoggi ?? false,
                NecessitaInformarPlacaCarregamento = carga.TipoOperacao?.ConfiguracaoCarga?.NecessitaInformarPlacaCarregamento ?? false,
                ExigeConformacaoFreteAntesEmissao = carga.TipoOperacao?.ExigeConformacaoFreteAntesEmissao ?? false,
                ImprimirMinuta = carga.TipoOperacao?.ConfiguracaoImpressao?.ImprimirMinuta ?? false,
                GerarPagamentoMotoristaAutomaticamenteComValorAdiantamentoContainer = carga.TipoOperacao?.ConfiguracaoContainer?.GerarPagamentoMotoristaAutomaticamenteComValorAdiantamentoContainer ?? false,
                ComprarValePedagioEtapaContainer = carga.TipoOperacao?.ConfiguracaoContainer?.ComprarValePedagioEtapaContainer ?? false,
                AverbarContainerComAverbacaoCarga = carga.TipoOperacao?.ConfiguracaoEmissaoDocumento?.AverbarContainerComAverbacaoCarga ?? false

            };
        }

        private dynamic ObterDadosDetalheCargaMotorista(List<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> motoristas, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador)
        {
            return motoristas.Select(p => new
            {
                Codigo = p.Motorista.Codigo,
                Descricao = p.Motorista.DescricaoTelefone,
                CPF = configuracaoEmbarcador.Pais != TipoPais.Exterior ? p.Motorista.CPF_Formatado : p.Motorista.CPF,
                PercentualExecucao = (p.PercentualExecucao ?? 100).ToString("n2")
            }).ToList();
        }

        private dynamic ObterDadosDetalheCargaAjudante(List<Dominio.Entidades.Usuario> ajudantes, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador)
        {
            return ajudantes.Select(p => new
            {
                Codigo = p.Codigo,
                Descricao = p.DescricaoTelefone,
                CPF = configuracaoEmbarcador.Pais != TipoPais.Exterior ? p.CPF_Formatado : p.CPF
            }).ToList();
        }

        private dynamic ObterDadosDetalheCargaVeiculo(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer> cargaVeiculosContainer, List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainerAnexo> cargaVeiculosContainerAnexo, bool estaEmParqueamento)
        {
            return new
            {
                Codigo = carga.Veiculo?.Codigo ?? 0,
                Descricao = carga.Veiculo?.Placa ?? "",
                ModeloVeicularCarga = carga.Veiculo?.ModeloVeicularCarga?.Descricao ?? "",
                NumeroFrota = carga.Veiculo?.NumeroFrota,
                TipoVeiculo = carga.Veiculo?.TipoVeiculo ?? "",
                VeiculosVinculados = ObterDadosDetalheCargaVeiculosVinculados(carga, cargaVeiculosContainer, cargaVeiculosContainerAnexo),
                EstaEmParqueamento = estaEmParqueamento
            };
        }

        private dynamic ObterDadosDetalheCargaContainer(Dominio.Entidades.Embarcador.Cargas.Carga carga)
        {
            return new
            {
                Codigo = carga.Container?.Codigo ?? 0,
                Descricao = carga.Container?.Descricao ?? "",
                NumeroContainer = carga.Container?.Numero ?? ""
            };
        }

        private dynamic ObterDadosDetalheCargaUltimaPosicao(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.ObjetosDeValor.Embarcador.Monitoramento.MonitoramentoDadosDetalhesCarga dadosMonitoramento, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador)
        {
            return new
            {
                Data = dadosMonitoramento?.DataPosicao.ToString("dd/MM/yyyy HH:mm") ?? string.Empty,
                RastreadorOnlineOffline = dadosMonitoramento?.DataPosicao == null ? 1 : dadosMonitoramento.DataPosicao == DateTime.MinValue ? 1 : (DateTime.Now - dadosMonitoramento.DataPosicao).TotalMinutes <= configuracaoEmbarcador.TempoSemPosicaoParaVeiculoPerderSinal ? 3 : 4,
                StatusMonitoramento = dadosMonitoramento?.StatusMonitoramento.ObterDescricao() ?? "Sem Situação"
            };
        }

        private dynamic ObterDadosDetalheCargaVeiculosVinculados(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer> cargaVeiculosContainer, List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainerAnexo> cargaVeiculosContainerAnexo)
        {
            if ((carga.VeiculosVinculados == null) || (carga.VeiculosVinculados.Count == 0))
                return null;

            List<dynamic> veiculosRetornar = new List<dynamic>();
            List<Dominio.Entidades.Veiculo> veiculosOrdenados = new List<Dominio.Entidades.Veiculo>();
            List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer> cargaVeiculosContainerReboques = (cargaVeiculosContainer != null) ? cargaVeiculosContainer.Where(o => carga.VeiculosVinculados.Any(v => v.Codigo == o.Veiculo.Codigo)).OrderBy(o => o.NumeroReboque).ToList() : new List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer>();
            bool possuiDadosContainer = (cargaVeiculosContainerReboques.Count > 0);

            if (possuiDadosContainer)
            {
                foreach (Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer cargaVeiculoContainer in cargaVeiculosContainerReboques)
                    veiculosOrdenados.Add(cargaVeiculoContainer.Veiculo);
            }
            else
            {
                foreach (Dominio.Entidades.Veiculo reboque in carga.VeiculosVinculados)
                    veiculosOrdenados.Add(reboque);
            }

            foreach (Dominio.Entidades.Veiculo reboque in veiculosOrdenados)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer cargaVeiculoContainer = possuiDadosContainer ? cargaVeiculosContainer.Where(o => o.Veiculo.Codigo == reboque.Codigo).FirstOrDefault() : null;

                veiculosRetornar.Add(new
                {
                    reboque.Codigo,
                    Descricao = reboque.Placa,
                    ModeloVeicularCarga = reboque.ModeloVeicularCarga != null ? reboque.ModeloVeicularCarga.Descricao : "",
                    reboque.NumeroFrota,
                    reboque.TipoVeiculo,
                    CodigoContainer = cargaVeiculoContainer?.Codigo.ToString() ?? Guid.NewGuid().ToString(),
                    DataRetiradaCtrn = cargaVeiculoContainer?.DataRetiradaCtrn?.ToString("dd/MM/yyyy") ?? string.Empty,
                    Genset = cargaVeiculoContainer?.Genset ?? string.Empty,
                    MaxGross = (cargaVeiculoContainer?.MaxGross ?? 0) > 0 ? cargaVeiculoContainer.MaxGross.ToString("n0") : string.Empty,
                    NumeroContainer = cargaVeiculoContainer?.NumeroContainer ?? string.Empty,
                    TaraContainer = (cargaVeiculoContainer?.TaraContainer ?? 0) > 0 ? cargaVeiculoContainer.TaraContainer.ToString("n0") : string.Empty,
                    Anexos = (
                        from anexo in cargaVeiculosContainerAnexo
                        where anexo.EntidadeAnexo.Veiculo.Codigo == reboque.Codigo
                        select new
                        {
                            anexo.Codigo,
                            anexo.Descricao,
                            anexo.NomeArquivo
                        }
                    ).ToList()
                });
            }

            return veiculosRetornar;
        }

        private dynamic ObterDadosDetalheCargaApoliceSeguro(List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro> apolicesSeguroAverbacao)
        {
            return apolicesSeguroAverbacao.Select(apolice => new
            {
                apolice.Codigo,
                Descricao = apolice.DescricaoComSeguradora
            }).ToList();
        }

        private void AtualizarApoliceSeguro(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Dominio.ObjetosDeValor.Embarcador.Carga.CargaDadosTransporte dadosTransporte, UnitOfWork unitOfWork)
        {
            if (dadosTransporte.CodigosApoliceSeguro == null)
                return;

            Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repositorioApoliceSeguroAverbacao = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);

            if (dadosTransporte.CodigosApoliceSeguro.Count == 0)
            {
                Servicos.Log.TratarErro($"AtualizarApoliceSeguro - Removido CarCodigo: {carga.Codigo} - Embarcador: {carga.CodigoCargaEmbarcador}", "RemoveAverbacao");

                repositorioApoliceSeguroAverbacao.DeletarPorCarga(carga.Codigo);
                return;
            }

            if (!(carga.EmpresaFilialEmissora == null || !carga.EmpresaFilialEmissora.UsarTipoOperacaoApolice || (carga.TipoOperacao?.AverbarDocumentoDaSubcontratacao ?? false)))
            {
                Servicos.Log.TratarErro($"AtualizarApoliceSeguroFilialEmissora - Removido CarCodigo: {carga.Codigo} - Embarcador: {carga.CodigoCargaEmbarcador}", "RemoveAverbacao");

                repositorioApoliceSeguroAverbacao.DeletarPorCarga(carga.Codigo);
                return;
            }

            Repositorio.Embarcador.Seguros.ApoliceSeguro repositorioApoliceSeguro = new Repositorio.Embarcador.Seguros.ApoliceSeguro(unitOfWork);

            List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro> apolicesSeguro = repositorioApoliceSeguro.BuscarPorCodigo(dadosTransporte.CodigosApoliceSeguro);
            List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao> apolicesSeguroAverbacao = repositorioApoliceSeguroAverbacao.BuscarPorCarga(carga.Codigo);

            List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao> apolicesSeguroAverbacaoRemover = apolicesSeguroAverbacao.Where(x => !dadosTransporte.CodigosApoliceSeguro.Contains(x.ApoliceSeguro.Codigo)).ToList();
            foreach (Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao apoliceRemover in apolicesSeguroAverbacaoRemover)
                repositorioApoliceSeguroAverbacao.Deletar(apoliceRemover);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
            {
                List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao> apolicesSeguroAverbacaoCargaPedido = apolicesSeguroAverbacao.Where(o => o.CargaPedido.Codigo == cargaPedido.Codigo).ToList();

                foreach (Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro apoliceSeguro in apolicesSeguro)
                {
                    if (apolicesSeguroAverbacaoCargaPedido.Exists(o => o.ApoliceSeguro.Codigo == apoliceSeguro.Codigo))
                        continue;

                    Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao apoliceSeguroAverbacao = new Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao()
                    {
                        ApoliceSeguro = apoliceSeguro,
                        CargaPedido = cargaPedido
                    };

                    repositorioApoliceSeguroAverbacao.Inserir(apoliceSeguroAverbacao);
                }
            }
        }

        private void AtualizarDatasCarregamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento, Dominio.ObjetosDeValor.Embarcador.Carga.CargaDadosTransporte dadosTransporte, TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, Repositorio.UnitOfWork unitOfWork)
        {
            if ((!configuracaoEmbarcador.PermitirInformarDatasCarregamentoCarga && !carga.RejeitadaPeloTransportador) || carga.CargaDeComplemento)
                return;

            DateTime? dataCompararAlteracaoHorario = null;
            bool atualizarCarga = false;
            bool atualizarCarregamento = false;

            if (dadosTransporte.InicioCarregamento.HasValue)
            {
                atualizarCarga = true;
                dataCompararAlteracaoHorario = carga.DataCarregamentoCarga.HasValue ? carga.DataCarregamentoCarga : carga.Carregamento?.DataCarregamentoCarga;
                carga.DataCarregamentoCarga = dadosTransporte.InicioCarregamento.Value;

                if (carga.Carregamento != null)
                {
                    atualizarCarregamento = true;
                    carga.Carregamento.DataCarregamentoCarga = dadosTransporte.InicioCarregamento.Value;
                }
            }

            if (dadosTransporte.TerminoCarregamento.HasValue)
            {
                if (tipoServicoMultisoftware != TipoServicoMultisoftware.MultiTMS)
                {
                    carga.DataPrevisaoTerminoCarga = dadosTransporte.TerminoCarregamento.Value;
                    atualizarCarga = true;
                }

                if (carga.Carregamento != null)
                {
                    carga.Carregamento.DataDescarregamentoCarga = dadosTransporte.TerminoCarregamento.Value;
                    atualizarCarregamento = true;
                }

                if (configuracaoEmbarcador.CopiarDataTerminoCarregamentoCargaParaPrevisaoEntregaPedidos)
                {
                    Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
                    List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = carga.Pedidos.ToList();
                    int total = cargaPedidos.Count();
                    for (int i = 0; i < total; i++)
                    {
                        cargaPedidos[i].Pedido.PrevisaoEntrega = dadosTransporte.TerminoCarregamento;
                        repPedido.Atualizar(cargaPedidos[i].Pedido);
                    }
                }

            }

            if (atualizarCarga)
            {
                new Repositorio.Embarcador.Cargas.Carga(unitOfWork).Atualizar(carga);
                AtualizarDataEstufagemDadosTransporteMaritimo(carga, unitOfWork, false);
            }


            if (atualizarCarregamento)
                new Repositorio.Embarcador.Cargas.MontagemCarga.Carregamento(unitOfWork).Atualizar(carga.Carregamento);

            if ((cargaJanelaCarregamento != null) && dadosTransporte.InicioCarregamento.HasValue && (cargaJanelaCarregamento.Excedente || !dataCompararAlteracaoHorario.HasValue || (dataCompararAlteracaoHorario.Value.ToString("dd/MM/yyyy HH:mm") != dadosTransporte.InicioCarregamento.Value.ToString("dd/MM/yyyy HH:mm"))))
            {
                cargaJanelaCarregamento.Initialize();

                Dominio.ObjetosDeValor.Embarcador.JanelaCarregamento.ConfiguracaoDisponibilidadeCarregamento configuracaoDisponibilidadeCarregamento = new Dominio.ObjetosDeValor.Embarcador.JanelaCarregamento.ConfiguracaoDisponibilidadeCarregamento()
                {
                    PermitirHorarioCarregamentoComLimiteAtingido = true
                };
                Logistica.CargaJanelaCarregamentoDisponibilidade servicoDisponibilidadeCarregamento = new Logistica.CargaJanelaCarregamentoDisponibilidade(unitOfWork, configuracaoEmbarcador, configuracaoDisponibilidadeCarregamento);
                servicoDisponibilidadeCarregamento.AlterarHorarioCarregamento(cargaJanelaCarregamento, dadosTransporte.InicioCarregamento.Value, tipoServicoMultisoftware);
                Servicos.Auditoria.Auditoria.AuditarComAlteracoesRealizadas(auditado, cargaJanelaCarregamento, cargaJanelaCarregamento.GetChanges(), $"Data de carregamento alterada{(cargaJanelaCarregamento.Excedente ? "" : $" para {cargaJanelaCarregamento.InicioCarregamento.ToString("dd/MM/yyyy")}")}", unitOfWork);
            }
        }

        private void AtualizarDadosCarregamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento, Dominio.Entidades.Usuario usuario, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, Repositorio.UnitOfWork unitOfWork)
        {
            Dominio.ObjetosDeValor.Embarcador.JanelaCarregamento.ConfiguracaoCarregamento configuracaoCarregamento = new Dominio.ObjetosDeValor.Embarcador.JanelaCarregamento.ConfiguracaoCarregamento()
            {
                PermitirHorarioCarregamentoInferiorAoAtual = !carga.IsChangedByPropertyName("DataCarregamentoCarga") && !cargaJanelaCarregamento.Excedente && cargaJanelaCarregamento.CentroCarregamento != null
            };
            Servicos.Embarcador.Logistica.CargaJanelaCarregamento servicoCargaJanelaCarregamento = new Servicos.Embarcador.Logistica.CargaJanelaCarregamento(unitOfWork, configuracaoEmbarcador, configuracaoCarregamento);
            Servicos.Embarcador.Logistica.CargaJanelaCarregamentoTransportador servicoCargaJanelaCarregamentoTransportador = new Servicos.Embarcador.Logistica.CargaJanelaCarregamentoTransportador(unitOfWork, configuracaoEmbarcador);
            Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportador repCargaJanelaCarregamentoTransportador = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportador(unitOfWork);

            servicoCargaJanelaCarregamento.AtualizarPorCarga(cargaJanelaCarregamento, tipoServicoMultisoftware);

            List<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoTransportador> cargaJanelaCarregamentoTransportadores = repCargaJanelaCarregamentoTransportador.BuscarPorCargaJanelaCarregamentoESituacao(cargaJanelaCarregamento.Codigo, new SituacaoCargaJanelaCarregamentoTransportador[] { SituacaoCargaJanelaCarregamentoTransportador.AgAceite, SituacaoCargaJanelaCarregamentoTransportador.AgConfirmacao, SituacaoCargaJanelaCarregamentoTransportador.Confirmada });

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoTransportador cargaJanelaCarregamentoTransportador in cargaJanelaCarregamentoTransportadores)
            {
                if (cargaJanelaCarregamentoTransportador.Transportador.Codigo != carga.Empresa.Codigo)
                {
                    cargaJanelaCarregamentoTransportador.HorarioLimiteConfirmarCarga = null;
                    cargaJanelaCarregamentoTransportador.Situacao = SituacaoCargaJanelaCarregamentoTransportador.Rejeitada;

                    repCargaJanelaCarregamentoTransportador.Atualizar(cargaJanelaCarregamentoTransportador);
                    servicoCargaJanelaCarregamentoTransportador.SalvarHistoricoAlteracao(cargaJanelaCarregamentoTransportador, "Carga rejeitada ao salvar os dados de transporte na carga", usuario);
                }
            }

            new Servicos.Embarcador.Hubs.JanelaCarregamento().InformarJanelaCarregamentoAtualizada(cargaJanelaCarregamento);
        }

        private void VincularCtesParciaisDosPedido(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, List<Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParcial> ctesParciaisPedidos)
        {
            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repositorioPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.CTe.CTeTerceiro repositorioCTeTerceiro = new Repositorio.Embarcador.CTe.CTeTerceiro(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoGeral repositorioConfiguracaoGeral = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeral(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeral configuracaoGeral = repositorioConfiguracaoGeral.BuscarConfiguracaoPadrao();

            bool enviarCTeApenasParaTomador = (configuracaoGeral?.EnviarCTeApenasParaTomador ?? false);
            Canhotos.Canhoto servicoCanhoto = new Canhotos.Canhoto(unitOfWork);
            CTeSubContratacao servicoCTeSubContratacao = new CTeSubContratacao(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParcial> ctesParciais = ctesParciaisPedidos.Where(o => o.Pedido.Codigo == cargaPedido.Pedido.Codigo).ToList();

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParcial cteParcial in ctesParciais)
            {
                Dominio.Entidades.Embarcador.CTe.CTeTerceiro cteTerceiro = repositorioCTeTerceiro.BuscarPorNumeroERemetente(cteParcial.Numero, cteParcial.Pedido.Remetente.CPF_CNPJ_SemFormato);

                if (cteTerceiro == null)
                {
                    Repositorio.ConhecimentoDeTransporteEletronico repositorioCte = new ConhecimentoDeTransporteEletronico(unitOfWork);
                    Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repositorioCte.BuscarPorNumeroERemetente(cteParcial.Numero, cteParcial.Pedido.Remetente.CPF_CNPJ_SemFormato);

                    if (cte != null)
                    {
                        string mensagemErroCriacaoCTeTerceiro = string.Empty;
                        Embarcador.CTe.CTe servicoCte = new Embarcador.CTe.CTe(unitOfWork);
                        Dominio.ObjetosDeValor.Embarcador.CTe.CTe cteIntegracao = servicoCte.ConverterEntidadeCTeParaObjeto(cte, enviarCTeApenasParaTomador, unitOfWork);
                        string descricaoItemPeso = servicoCTeSubContratacao.ObterDescricaoItemPeso(cargaPedido, unitOfWork, out bool utilizarPrimeiraUnidadeMedidaPeso);

                        cteTerceiro = servicoCTeSubContratacao.CriarCTeTerceiro(unitOfWork, ref mensagemErroCriacaoCTeTerceiro, null, cteIntegracao, descricaoItemPeso, utilizarPrimeiraUnidadeMedidaPeso);
                    }
                }

                if (cteTerceiro != null)
                {
                    string retorno = servicoCTeSubContratacao.ValidarRegrasCTeParaSubContratacao(cteTerceiro, cargaPedido, unitOfWork, tipoServicoMultisoftware);

                    if (string.IsNullOrEmpty(retorno))
                    {
                        if (cargaPedido.Pedido.Destinatario != null && cteTerceiro.Destinatario.Cliente != null && cargaPedido.Pedido.Destinatario.CPF_CNPJ != cteTerceiro.Destinatario.Cliente.CPF_CNPJ)
                        {
                            cargaPedido.Pedido.Destinatario = cteTerceiro.Destinatario.Cliente;
                            if (cargaPedido.Recebedor == null)
                                cargaPedido.Destino = cargaPedido.Pedido.Destinatario.Localidade;
                        }

                        cteTerceiro.Ativo = true;

                        servicoCTeSubContratacao.InserirCTeSubContratacaoCargaPedido(cteTerceiro, cargaPedido, tipoServicoMultisoftware, unitOfWork);

                        repositorioPedido.Atualizar(cargaPedido.Pedido);
                        repositorioCarga.Atualizar(cargaPedido.Carga);
                        repositorioCTeTerceiro.Atualizar(cteTerceiro);

                        servicoCanhoto.SalvarCanhotoCTe(cteTerceiro, cargaPedido, cargaPedido.Carga.FreteDeTerceiro && cargaPedido.Carga.Veiculo != null ? cargaPedido.Carga.Veiculo.Proprietario : cargaPedido.Carga.ProvedorOS, cargaPedido.Carga.Motoristas != null ? cargaPedido.Carga.Motoristas.ToList() : new List<Dominio.Entidades.Usuario>(), tipoServicoMultisoftware, unitOfWork);
                    }
                }
            }
        }

        private string VincularNotasParciaisDosPedido(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, List<Dominio.Entidades.Embarcador.Pedidos.PedidoNotaParcial> notasParciais)
        {
            Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalParcial repCargaPedidoXMLNotaFiscalParcial = new Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalParcial(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Servicos.Embarcador.Pedido.NotaFiscal serCargaNotaFiscal = new Servicos.Embarcador.Pedido.NotaFiscal(unitOfWork);
            Servicos.Embarcador.NFe.NFe serNFe = new Servicos.Embarcador.NFe.NFe(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoNotaParcial repPedidoNotaParcial = new Repositorio.Embarcador.Pedidos.PedidoNotaParcial(unitOfWork);

            string retorno = "";

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoNotaParcial> pedidosNotaParcial = notasParciais.Where(o => o.Pedido.Codigo == cargaPedido.Pedido.Codigo).ToList();

            bool encontrouTodas = true;

            if (pedidosNotaParcial.Count > 0)
            {
                cargaPedido.Peso = 0;
                cargaPedido.PesoLiquido = 0;

                Servicos.Log.TratarErro($"1 Adicionando Pedidos Parciais {DateTime.Now.ToString("dd/MM/yyyy hh:mm:ss")} {string.Join(", ", pedidosNotaParcial.Select(x => x.Pedido.Codigo))}");
                foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoNotaParcial pedidoNotaParcial in pedidosNotaParcial)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedidoXMLNotaFiscalParcial cargaPedidoXMLNotaFiscalParcial = new Dominio.Entidades.Embarcador.Cargas.CargaPedidoXMLNotaFiscalParcial
                    {
                        CargaPedido = cargaPedido,
                        Numero = pedidoNotaParcial.Numero,
                        Pedido = "",
                        VincularNotaFiscalPorProcesso = configuracaoTMS.VincularNotasParciaisPedidoPorProcesso
                    };

                    repCargaPedidoXMLNotaFiscalParcial.Inserir(cargaPedidoXMLNotaFiscalParcial);

                    if (!configuracaoTMS.VincularNotasParciaisPedidoPorProcesso)
                    {
                        Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xmlNotaFiscal = null;
                        if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
                            xmlNotaFiscal = repXMLNotaFiscal.BuscarPorNumeroOuNumeroPedidoSemCarga(pedidoNotaParcial.Numero, "", cargaPedido.Pedido.Remetente.CPF_CNPJ);
                        else
                            xmlNotaFiscal = repXMLNotaFiscal.BuscarPorNumeroSemCarga(pedidoNotaParcial.Numero, cargaPedido.Pedido.Remetente.CPF_CNPJ);

                        if (xmlNotaFiscal == null)
                            xmlNotaFiscal = Servicos.Embarcador.Documentos.DocumentoDestinadoEmpresa.ObterXMLNotaFiscal(cargaPedido.Pedido.Remetente.CPF_CNPJ_SemFormato, pedidoNotaParcial.Numero, unitOfWork, tipoServicoMultisoftware);

                        if (xmlNotaFiscal == null && tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
                            xmlNotaFiscal = serNFe.CriarXMLNotaFiscal(cargaPedido.Pedido.Remetente, cargaPedido.Pedido.Destinatario, cargaPedido.Pedido.Filial, "", pedidoNotaParcial.Numero, unitOfWork);

                        if (xmlNotaFiscal != null)
                        {
                            if (cargaPedido.Pedido.Destinatario != null || (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS && cargaPedido.Pedido.Destinatario == null))
                            {
                                bool msgAlertaObservacao = false;
                                bool notaFiscalEmOutraCarga = false;
                                retorno = serCargaNotaFiscal.ValidarRegrasNota(xmlNotaFiscal, cargaPedido, tipoServicoMultisoftware, out msgAlertaObservacao, out notaFiscalEmOutraCarga);
                                if (msgAlertaObservacao && !string.IsNullOrWhiteSpace(retorno))
                                    retorno = "";
                            }

                            if (string.IsNullOrWhiteSpace(retorno))
                            {
                                //TODO: PPC - Adicionado log temporário para identificar problema no cargaPedido.Peso.
                                Servicos.Log.TratarErro($"Pedido {cargaPedido.Pedido.NumeroPedidoEmbarcador} - CargaPedido.Codigo = {cargaPedido.Codigo} - Peso Total De.: {cargaPedido.Peso} - Para.: {(cargaPedido.Peso + xmlNotaFiscal.Peso)}. Carga.VincularNotasParciaisDosPedido", "PesoCargaPedido");
                                cargaPedido.Peso += xmlNotaFiscal.Peso;
                                cargaPedido.PesoLiquido += xmlNotaFiscal.PesoLiquido;
                                cargaPedidoXMLNotaFiscalParcial.XMLNotaFiscal = xmlNotaFiscal;
                                xmlNotaFiscal.TipoNotaFiscalIntegrada = cargaPedidoXMLNotaFiscalParcial.TipoNotaFiscalIntegrada;

                                repCargaPedidoXMLNotaFiscalParcial.Atualizar(cargaPedidoXMLNotaFiscalParcial);
                                repXMLNotaFiscal.Atualizar(xmlNotaFiscal);

                                serCargaNotaFiscal.InserirNotaCargaPedido(xmlNotaFiscal, cargaPedido, tipoServicoMultisoftware, TipoNotaFiscal.Venda, configuracaoTMS, false, out bool alteradoTipoDeCarga, Auditado);

                                if (Auditado != null)
                                    Servicos.Auditoria.Auditoria.Auditar(Auditado, xmlNotaFiscal, "Adicionado pelo vínculo de notas parciais", unitOfWork);
                            }
                        }
                        else
                            encontrouTodas = false;
                    }
                }
            }

            if (!configuracaoTMS.VincularNotasParciaisPedidoPorProcesso)
            {
                if (encontrouTodas && pedidosNotaParcial.Count > 0)
                {
                    cargaPedido.CienciaDoEnvioDaNotaInformado = true;
                    repCargaPedido.Atualizar(cargaPedido);
                }
            }

            return retorno;
        }

        private async Task<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> VincularNotasFiscaisDosPedidoAsync(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, List<int> notasUtilizadas, List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> xMLNotaFiscals, List<Dominio.ObjetosDeValor.Embarcador.Carga.TotalizadorModeloDocumento> notasPedidos, List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> listaCarregamentoPedidoNotaFiscal, List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> listasNotasJaEnviadas, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS)
        {
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);

            Servicos.Embarcador.Pedido.NotaFiscal serCargaNotaFiscal = new Servicos.Embarcador.Pedido.NotaFiscal(unitOfWork);

            int count = notasPedidos.Count(o => o.Codigo == cargaPedido.Pedido.Codigo);

            Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscal = null;

            if (count > 0)
            {
                List<Dominio.ObjetosDeValor.Embarcador.Carga.TotalizadorModeloDocumento> notasPedidosPedidos = notasPedidos.Where(o => o.Codigo == cargaPedido.Pedido.Codigo).ToList();
                Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal carregamentoPedidoNotaFiscalPedido = (from obj in listaCarregamentoPedidoNotaFiscal where obj.CarregamentoPedido.Pedido.Codigo == cargaPedido.Pedido.Codigo select obj).FirstOrDefault();
                List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> listaCarregamentoPedidoNotaFiscalPedidoJaUtilizadas = (from obj in listasNotasJaEnviadas where obj.CarregamentoPedido.Pedido.Codigo == cargaPedido.Pedido.Codigo select obj).ToList();
                List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> listaNotasEnviadasXML = new List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal>();

                foreach (Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal carregamentoPedidoNf in listaCarregamentoPedidoNotaFiscalPedidoJaUtilizadas)
                    listaNotasEnviadasXML.AddRange(carregamentoPedidoNf.NotasFiscais);

                bool contemNotaJaUtilizada = false;
                bool contemNovaNota = false;

                foreach (Dominio.ObjetosDeValor.Embarcador.Carga.TotalizadorModeloDocumento notaFiscalPedido in notasPedidosPedidos)
                {
                    if (configuracaoTMS.RatearFretePedidosAposLiberarEmissaoSemNFe && notasUtilizadas.Contains(notaFiscalPedido.Total))
                        contemNotaJaUtilizada = true;
                    else
                    {
                        Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xMLNotaFiscal = xMLNotaFiscals.FirstOrDefault(o => o.Codigo == notaFiscalPedido.Total);

                        bool adiciona = true;
                        if (carregamentoPedidoNotaFiscalPedido != null)
                        {
                            if (!carregamentoPedidoNotaFiscalPedido.NotasFiscais.Contains(xMLNotaFiscal))
                                adiciona = false;
                        }
                        else
                        {
                            if (listaNotasEnviadasXML.Contains(xMLNotaFiscal))
                                adiciona = false;
                        }

                        if (xMLNotaFiscal != null && adiciona)
                        {
                            pedidoXMLNotaFiscal = new Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal
                            {
                                XMLNotaFiscal = xMLNotaFiscal,
                                ObservacaoNotaFiscal = "",
                                CargaPedido = cargaPedido,
                                TipoNotaFiscal = TipoNotaFiscal.Venda
                            };

                            notasUtilizadas.Add(notaFiscalPedido.Total);
                            contemNovaNota = true;
                        }
                    }
                }

                if (contemNotaJaUtilizada && !contemNovaNota)
                {
                    cargaPedido.PedidoSemNFe = true;
                    cargaPedido.Peso = 0;
                    cargaPedido.PesoLiquido = 0;
                }


                cargaPedido.CienciaDoEnvioDaNotaInformado = true;
            }
            else
            {
                if ((cargaPedido.Carga.TipoOperacao?.DeslocamentoVazio ?? false) && cargaPedido.Pedido.Remetente != null && cargaPedido.Pedido.Destinatario != null && !repPedidoXMLNotaFiscal.VerificarSeExistePorCargaPedido(cargaPedido.Codigo))
                {
                    Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xmlNotaFiscal = new Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal()
                    {
                        CNPJTranposrtador = "",
                        DataEmissao = DateTime.Now,
                        Descricao = "Outros",
                        Destinatario = cargaPedido.Pedido.Destinatario,
                        Emitente = cargaPedido.Pedido.Remetente,
                        Modelo = "99",
                        nfAtiva = true,
                        Numero = 1,
                        PlacaVeiculoNotaFiscal = "",
                        Serie = "",
                        TipoDocumento = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoDocumento.Outros,
                        TipoOperacaoNotaFiscal = TipoOperacaoNotaFiscal.Saida,
                        XML = "",
                        DataRecebimento = DateTime.Now,
                        Peso = 1m,
                        Valor = 1m
                    };

                    await repXMLNotaFiscal.InserirAsync(xmlNotaFiscal);

                    await serCargaNotaFiscal.InserirNotaCargaPedidoAsync(xmlNotaFiscal, cargaPedido, tipoServicoMultisoftware, TipoNotaFiscal.Venda, configuracaoTMS, false, false, Auditado);

                    if (Auditado != null)
                        Servicos.Auditoria.Auditoria.Auditar(Auditado, xmlNotaFiscal, "Adicionado pelo vínculo de notas fiscais dos pedidos", unitOfWork);
                }
            }

            return pedidoXMLNotaFiscal;
        }

        private string VincularNotasFiscaisDosPedido(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, List<int> notasUtilizadas, List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> xMLNotaFiscals, List<Dominio.ObjetosDeValor.Embarcador.Carga.TotalizadorModeloDocumento> notasPedidos, List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> listaCarregamentoPedidoNotaFiscal, List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> listasNotasJaEnviadas, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);

            Servicos.Embarcador.Pedido.NotaFiscal serCargaNotaFiscal = new Servicos.Embarcador.Pedido.NotaFiscal(unitOfWork);

            string retorno = "";

            int count = notasPedidos.Count(o => o.Codigo == cargaPedido.Pedido.Codigo);

            Servicos.Log.TratarErro($"Quantidade Notas {count}.", "VincularNotasFiscaisDosPedido");

            if (count > 0)
            {
                List<Dominio.ObjetosDeValor.Embarcador.Carga.TotalizadorModeloDocumento> notasPedidosPedidos = notasPedidos.Where(o => o.Codigo == cargaPedido.Pedido.Codigo).ToList();
                Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal carregamentoPedidoNotaFiscalPedido = (from obj in listaCarregamentoPedidoNotaFiscal where obj.CarregamentoPedido.Pedido.Codigo == cargaPedido.Pedido.Codigo select obj).FirstOrDefault();
                List<Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal> listaCarregamentoPedidoNotaFiscalPedidoJaUtilizadas = (from obj in listasNotasJaEnviadas where obj.CarregamentoPedido.Pedido.Codigo == cargaPedido.Pedido.Codigo select obj).ToList();
                List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> listaNotasEnviadasXML = new List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal>();

                foreach (Dominio.Entidades.Embarcador.Cargas.MontagemCarga.CarregamentoPedidoNotaFiscal carregamentoPedidoNf in listaCarregamentoPedidoNotaFiscalPedidoJaUtilizadas)
                    listaNotasEnviadasXML.AddRange(carregamentoPedidoNf.NotasFiscais);

                bool contemNotaJaUtilizada = false;
                bool contemNovaNota = false;

                foreach (Dominio.ObjetosDeValor.Embarcador.Carga.TotalizadorModeloDocumento notaFiscalPedido in notasPedidosPedidos) // Insert em lote
                {
                    if (configuracaoTMS.RatearFretePedidosAposLiberarEmissaoSemNFe && notasUtilizadas.Contains(notaFiscalPedido.Total))
                        contemNotaJaUtilizada = true;
                    else
                    {
                        Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xMLNotaFiscal = xMLNotaFiscals.FirstOrDefault(o => o.Codigo == notaFiscalPedido.Total);

                        bool adiciona = true;
                        if (carregamentoPedidoNotaFiscalPedido != null)
                        {
                            if (!carregamentoPedidoNotaFiscalPedido.NotasFiscais.Contains(xMLNotaFiscal))
                                adiciona = false;
                        }
                        else
                        {
                            if (listaNotasEnviadasXML.Contains(xMLNotaFiscal))
                                adiciona = false;
                        }

                        if (xMLNotaFiscal != null && adiciona)
                        {
                            Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscal = new Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal
                            {
                                XMLNotaFiscal = xMLNotaFiscal,
                                ObservacaoNotaFiscal = "",
                                CargaPedido = cargaPedido,
                                TipoNotaFiscal = TipoNotaFiscal.Venda
                            };

                            repPedidoXMLNotaFiscal.Inserir(pedidoXMLNotaFiscal);

                            notasUtilizadas.Add(notaFiscalPedido.Total);
                            contemNovaNota = true;
                        }
                    }
                }

                if (contemNotaJaUtilizada && !contemNovaNota)
                {
                    cargaPedido.PedidoSemNFe = true;
                    cargaPedido.Peso = 0;
                    cargaPedido.PesoLiquido = 0;
                }


                cargaPedido.CienciaDoEnvioDaNotaInformado = true;
                repCargaPedido.Atualizar(cargaPedido);
            }
            else
            {
                if ((cargaPedido.Carga.TipoOperacao?.DeslocamentoVazio ?? false) && cargaPedido.Pedido.Remetente != null && cargaPedido.Pedido.Destinatario != null && !repPedidoXMLNotaFiscal.VerificarSeExistePorCargaPedido(cargaPedido.Codigo))
                {
                    Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xmlNotaFiscal = new Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal()
                    {
                        CNPJTranposrtador = "",
                        DataEmissao = DateTime.Now,
                        Descricao = "Outros",
                        Destinatario = cargaPedido.Pedido.Destinatario,
                        Emitente = cargaPedido.Pedido.Remetente,
                        Modelo = "99",
                        nfAtiva = true,
                        Numero = 1,
                        PlacaVeiculoNotaFiscal = "",
                        Serie = "",
                        TipoDocumento = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoDocumento.Outros,
                        TipoOperacaoNotaFiscal = TipoOperacaoNotaFiscal.Saida,
                        XML = "",
                        DataRecebimento = DateTime.Now,
                        Peso = 1m,
                        Valor = 1m
                    };

                    repXMLNotaFiscal.Inserir(xmlNotaFiscal);

                    serCargaNotaFiscal.InserirNotaCargaPedido(xmlNotaFiscal, cargaPedido, tipoServicoMultisoftware, TipoNotaFiscal.Venda, configuracaoTMS, false, out bool alteradoTipoDeCarga, Auditado);

                    if (Auditado != null)
                        Servicos.Auditoria.Auditoria.Auditar(Auditado, xmlNotaFiscal, "Adicionado pelo vínculo de notas fiscais dos pedidos", unitOfWork);
                }
            }

            return retorno;
        }

        private string VincularCTeTerceiroDosPedido(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao repPedidoCTeParaSubContratacao = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao(unitOfWork);
            Repositorio.Embarcador.Configuracoes.IntegracaoIntercab repIntegracaoIntercab = new Repositorio.Embarcador.Configuracoes.IntegracaoIntercab(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab = repIntegracaoIntercab.BuscarIntegracao();

            Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);

            string retorno = "";
            if (cargaPedido.Pedido.CTesTerceiro != null && cargaPedido.Pedido.CTesTerceiro.Count > 0)
            {
                foreach (Dominio.Entidades.Embarcador.CTe.CTeTerceiro cteTerceiro in cargaPedido.Pedido.CTesTerceiro)
                {
                    Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao pedidoCTeParaSubContratacao = new Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao()
                    {
                        BaseCalculoICMS = 0,
                        BaseCalculoISS = 0,
                        CargaPedido = cargaPedido,
                        CFOP = cteTerceiro.CFOP,
                        CST = "",
                        CTeTerceiro = cteTerceiro,
                        DocsParaEmissaoNFSManual = null,
                        IncluirICMSBaseCalculo = false,
                        IncluirISSBaseCalculo = false,
                        ModeloDocumentoFiscal = null,
                        ObservacaoRegraICMSCTe = "",
                        PercentualAliquota = 0,
                        PercentualAliquotaInternaDifal = 0,
                        PercentualAliquotaISS = 0,
                        PercentualIncluirBaseCalculo = 0,
                        PercentualPagamentoAgregado = 0,
                        PercentualReducaoBC = 0,
                        PercentualRetencaoISS = 0,
                        PossuiCTe = true,
                        PossuiNFS = false,
                        PossuiNFSManual = false,
                        ValorFrete = 0,
                        ValorFreteTabelaFrete = 0,
                        ValorICMS = 0,
                        ValorISS = 0,
                        ValorRetencaoISS = 0,
                        ValorTotalComponentes = 0
                    };

                    repPedidoCTeParaSubContratacao.Inserir(pedidoCTeParaSubContratacao);

                    if (integracaoIntercab?.BuscarTipoServicoModeloDocumentoVinculadoCarga ?? false)
                    {
                        if (!serCarga.AtualizarTipoServicoCargaMultimodal(cteTerceiro, cargaPedido, unitOfWork, out string msgRetornoTipoServico))
                            return msgRetornoTipoServico;
                    }
                }

                if (!(integracaoIntercab?.BuscarTipoServicoModeloDocumentoVinculadoCarga ?? false))
                {
                    cargaPedido.Redespacho = false;
                    if (cargaPedido.TipoServicoMultimodal == TipoServicoMultimodal.Subcontratacao || (cargaPedido.Carga.TipoOperacao?.SempreEmitirSubcontratacao ?? false))
                        cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.SubContratada;
                    else if (cargaPedido.Recebedor != null && cargaPedido.Expedidor != null)
                    {
                        cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.RedespachoIntermediario;
                        cargaPedido.Redespacho = true;
                    }
                    else if (cargaPedido.Recebedor != null)
                    {
                        cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.Redespacho;
                        cargaPedido.Redespacho = true;
                    }
                    else
                        cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.SubContratada;

                    repCargaPedido.Atualizar(cargaPedido);

                    cargaPedido.Carga.CargaColeta = false;
                    if (cargaPedido.TipoServicoMultimodal == TipoServicoMultimodal.Subcontratacao || (cargaPedido.Carga.TipoOperacao?.SempreEmitirSubcontratacao ?? false))
                        cargaPedido.Carga.TipoContratacaoCarga = TipoContratacaoCarga.SubContratada;
                    else if (cargaPedido.Recebedor != null && cargaPedido.Expedidor != null)
                        cargaPedido.Carga.TipoContratacaoCarga = TipoContratacaoCarga.RedespachoIntermediario;
                    else if (cargaPedido.Recebedor != null)
                        cargaPedido.Carga.TipoContratacaoCarga = TipoContratacaoCarga.Redespacho;
                    else
                        cargaPedido.Carga.TipoContratacaoCarga = TipoContratacaoCarga.SubContratada;

                    repCarga.Atualizar(cargaPedido.Carga);
                }
            }

            return retorno;
        }

        private void AdicionarIntegracaoTrafegus(Dominio.Entidades.Embarcador.Cargas.Carga carga, UnitOfWork unitOfWork)
        {
            if (!(carga.TipoOperacao?.PossuiIntegracaoTrafegus ?? false))
                return;

            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaIntegracao repCargaIntegracao = new Repositorio.Embarcador.Cargas.CargaIntegracao(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.TipoIntegracao tipoIntegracao = repTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Trafegus, false);

            if (tipoIntegracao != null &&
                repCargaIntegracao.ContarPorCargaETipoIntegracao(carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Trafegus) <= 0)
            {
                Servicos.Embarcador.Integracao.IntegracaoCarga svcIntegracaoCarga = new Integracao.IntegracaoCarga(unitOfWork);

                svcIntegracaoCarga.InformarIntegracaoCarga(carga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Trafegus, unitOfWork);
            }
        }

        private void AtualizarContainerVeiculo(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.ObjetosDeValor.Embarcador.Carga.CargaDadosTransporte dadosTransporte, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, bool possuiGenset, UnitOfWork unidadeTrabalho)
        {
            Anexo.Anexo<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainerAnexo, Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer> servicoAnexo = new Anexo.Anexo<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainerAnexo, Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer>(unidadeTrabalho);
            Repositorio.Embarcador.Cargas.CargaVeiculoContainer repositorioCargaVeiculoContainer = new Repositorio.Embarcador.Cargas.CargaVeiculoContainer(unidadeTrabalho);
            Repositorio.Embarcador.Cargas.CargaVeiculoContainerAnexo repositorioCargaVeiculoContainerAnexo = new Repositorio.Embarcador.Cargas.CargaVeiculoContainerAnexo(unidadeTrabalho);
            Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unidadeTrabalho);

            List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer> veiculosContainer = repositorioCargaVeiculoContainer.BuscarPorCarga(carga.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer> veiculosContainerAdicionadosOuAtualizados = new List<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer>();

            bool permitirAtualizarContainerVeiculo = (
                configuracaoEmbarcador.PermitirInformarAnexoContainerCarga ||
                configuracaoEmbarcador.PermitirInformarDataRetiradaCtrnCarga ||
                configuracaoEmbarcador.PermitirInformarNumeroContainerCarga ||
                configuracaoEmbarcador.PermitirInformarTaraContainerCarga ||
                configuracaoEmbarcador.PermitirInformarMaxGrossCarga ||
                possuiGenset
            );

            if (permitirAtualizarContainerVeiculo)
            {
                if (dadosTransporte.CodigoTracao > 0)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer containerVeiculo = (from o in veiculosContainer where o.Veiculo.Codigo == carga.Veiculo.Codigo select o).FirstOrDefault();

                    if (containerVeiculo == null)
                        containerVeiculo = new Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer();

                    containerVeiculo.Carga = carga;
                    containerVeiculo.Veiculo = carga.Veiculo;
                    containerVeiculo.DataRetiradaCtrn = dadosTransporte.DataRetiradaCtrnVeiculo;
                    containerVeiculo.Genset = dadosTransporte.GensetVeiculo;
                    containerVeiculo.MaxGross = dadosTransporte.MaxGrossVeiculo;
                    containerVeiculo.NumeroContainer = dadosTransporte.NumeroContainerVeiculo;
                    containerVeiculo.NumeroReboque = NumeroReboque.SemReboque;
                    containerVeiculo.TaraContainer = dadosTransporte.TaraContainerVeiculo;

                    if (containerVeiculo.Codigo > 0)
                        repositorioCargaVeiculoContainer.Atualizar(containerVeiculo);
                    else
                        repositorioCargaVeiculoContainer.Inserir(containerVeiculo);

                    veiculosContainerAdicionadosOuAtualizados.Add(containerVeiculo);
                }
                ;

                if (dadosTransporte.CodigoReboque > 0)
                {
                    Dominio.Entidades.Veiculo reboque = (from veiculos in carga.VeiculosVinculados where veiculos.Codigo == dadosTransporte.CodigoReboque select veiculos).FirstOrDefault();
                    if (reboque == null)
                        reboque = repVeiculo.BuscarPorCodigo(dadosTransporte.CodigoReboque);
                    if (reboque != null)
                    {
                        Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer containerReboque = (from o in veiculosContainer where o.Veiculo.Codigo == reboque?.Codigo select o).FirstOrDefault();

                        if (containerReboque == null)
                            containerReboque = new Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer();

                        containerReboque.Carga = carga;
                        containerReboque.Veiculo = reboque;
                        containerReboque.DataRetiradaCtrn = dadosTransporte.DataRetiradaCtrnReboque ?? DateTime.Now;
                        containerReboque.Genset = dadosTransporte.GensetReboque;
                        containerReboque.MaxGross = dadosTransporte.MaxGrossReboque;
                        containerReboque.NumeroContainer = dadosTransporte.NumeroContainerReboque;
                        containerReboque.NumeroReboque = NumeroReboque.ReboqueUm;
                        containerReboque.TaraContainer = dadosTransporte.TaraContainerReboque;

                        if (containerReboque.Codigo > 0)
                            repositorioCargaVeiculoContainer.Atualizar(containerReboque);
                        else
                            repositorioCargaVeiculoContainer.Inserir(containerReboque);

                        veiculosContainerAdicionadosOuAtualizados.Add(containerReboque);
                    }
                }

                if (dadosTransporte.CodigoSegundoReboque > 0)
                {
                    Dominio.Entidades.Veiculo segundoReboque = (from veiculos in carga.VeiculosVinculados where veiculos.Codigo == dadosTransporte.CodigoSegundoReboque select veiculos).FirstOrDefault();
                    Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer containerSegundoReboque = (from o in veiculosContainer where o.Veiculo.Codigo == segundoReboque.Codigo select o).FirstOrDefault();

                    if (containerSegundoReboque == null)
                        containerSegundoReboque = new Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer();

                    containerSegundoReboque.Carga = carga;
                    containerSegundoReboque.Veiculo = segundoReboque;
                    containerSegundoReboque.DataRetiradaCtrn = dadosTransporte.DataRetiradaCtrnSegundoReboque ?? DateTime.Now;
                    containerSegundoReboque.Genset = dadosTransporte.GensetSegundoReboque;
                    containerSegundoReboque.MaxGross = dadosTransporte.MaxGrossSegundoReboque;
                    containerSegundoReboque.NumeroContainer = dadosTransporte.NumeroContainerSegundoReboque;
                    containerSegundoReboque.NumeroReboque = NumeroReboque.ReboqueDois;
                    containerSegundoReboque.TaraContainer = dadosTransporte.TaraContainerSegundoReboque;

                    if (containerSegundoReboque.Codigo > 0)
                        repositorioCargaVeiculoContainer.Atualizar(containerSegundoReboque);
                    else
                        repositorioCargaVeiculoContainer.Inserir(containerSegundoReboque);

                    veiculosContainerAdicionadosOuAtualizados.Add(containerSegundoReboque);
                }

                if (dadosTransporte.CodigoTerceiroReboque > 0)
                {
                    Dominio.Entidades.Veiculo terceiroReboque = (from veiculos in carga.VeiculosVinculados where veiculos.Codigo == dadosTransporte.CodigoTerceiroReboque select veiculos).FirstOrDefault();
                    Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer containerTerceiroReboque = (from o in veiculosContainer where o.Veiculo.Codigo == terceiroReboque.Codigo select o).FirstOrDefault();

                    if (containerTerceiroReboque == null)
                        containerTerceiroReboque = new Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer();

                    containerTerceiroReboque.Carga = carga;
                    containerTerceiroReboque.Veiculo = terceiroReboque;
                    containerTerceiroReboque.DataRetiradaCtrn = dadosTransporte.DataRetiradaCtrnTerceiroReboque ?? DateTime.Now;
                    containerTerceiroReboque.Genset = dadosTransporte.GensetTerceiroReboque;
                    containerTerceiroReboque.MaxGross = dadosTransporte.MaxGrossTerceiroReboque;
                    containerTerceiroReboque.NumeroContainer = dadosTransporte.NumeroContainerTerceiroReboque;
                    containerTerceiroReboque.NumeroReboque = NumeroReboque.ReboqueDois;
                    containerTerceiroReboque.TaraContainer = dadosTransporte.TaraContainerTerceiroReboque;

                    if (containerTerceiroReboque.Codigo > 0)
                        repositorioCargaVeiculoContainer.Atualizar(containerTerceiroReboque);
                    else
                        repositorioCargaVeiculoContainer.Inserir(containerTerceiroReboque);

                    veiculosContainerAdicionadosOuAtualizados.Add(containerTerceiroReboque);
                }
            }

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer veiculoContainer in veiculosContainer)
            {
                if ((from o in veiculosContainerAdicionadosOuAtualizados where o.Codigo == veiculoContainer.Codigo select o).Any())
                    continue;

                Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer veiculoContainerNovo = (from o in veiculosContainerAdicionadosOuAtualizados where o.NumeroReboque == veiculoContainer.NumeroReboque select o).FirstOrDefault();
                if (veiculoContainerNovo != null)
                    servicoAnexo.TrocarAnexos(veiculoContainer, veiculoContainerNovo);
                else
                    servicoAnexo.ExcluirAnexos(veiculoContainer);

                repositorioCargaVeiculoContainer.Deletar(veiculoContainer);
            }
        }

        private void AjustarCargasOriginais(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacao, Dominio.Entidades.Empresa empresa, Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga, Repositorio.UnitOfWork unitOfWork)
        {
            if (!carga.CargaAgrupada)
                return;

            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Canhotos.Canhoto repositorioCanhoto = new Repositorio.Embarcador.Canhotos.Canhoto(unitOfWork);
            CargaMotorista servicoCargaMotorista = new CargaMotorista(unitOfWork);

            foreach (Dominio.Entidades.Embarcador.Cargas.Carga cargaOriginal in carga.CargasAgrupamento)
            {
                if (tipoOperacao?.Codigo != carga.TipoOperacao?.Codigo)
                    cargaOriginal.TipoOperacao = carga.TipoOperacao;

                if (configuracaoGeralCarga.ManterTransportadorUnicoEmCargasAgrupadas || (empresa?.Codigo != carga.Empresa?.Codigo))
                    cargaOriginal.Empresa = carga.Empresa;

                cargaOriginal.Veiculo = carga.Veiculo;
                cargaOriginal.VeiculosVinculados = carga.VeiculosVinculados.ToList();

                servicoCargaMotorista.AtualizarMotoristas(cargaOriginal, carga.Motoristas.ToList());
                repositorioCarga.Atualizar(cargaOriginal);
                repositorioCanhoto.SetarTransportadorCanhotos(cargaOriginal.Codigo, cargaOriginal.Empresa?.Codigo ?? carga.Empresa.Codigo);
            }
        }

        private void ControleDisponibilidadeVeiculo(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Veiculo veiculoDaCarga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.GestaoPatio.FluxoGestaoPatio repositorioFluxoGestaoPatio = new Repositorio.Embarcador.GestaoPatio.FluxoGestaoPatio(unitOfWork);
            Dominio.Entidades.Embarcador.GestaoPatio.FluxoGestaoPatio fluxoGestaoPatio = repositorioFluxoGestaoPatio.BuscarAbertoPorCarga(carga.Codigo);

            ControleDisponibilidadeVeiculo(fluxoGestaoPatio, veiculoDaCarga, unitOfWork);
        }

        private string ObterPlacas(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador)
        {
            if (carga.Veiculo == null)
                return string.Empty;

            if (!configuracaoEmbarcador.PermiteEmissaoCargaSomenteComTracao && (carga.TipoOperacao?.ExigePlacaTracao ?? false))
            {
                if (carga.Veiculo.IsTipoVeiculoReboque())
                    return carga.Veiculo.Placa;

                List<string> placas = new List<string>() { carga.Veiculo.Placa };

                if (carga.VeiculosVinculados?.Count > 0)
                    placas.AddRange(from o in carga.VeiculosVinculados select o.Placa);

                return string.Join(", ", placas);
            }

            List<string> placasComModeloVeicularCarga = new List<string>() { carga.Veiculo.DescricaoComModeloVeicularCarga };

            if (carga.VeiculosVinculados?.Count > 0)
                placasComModeloVeicularCarga.AddRange(from o in carga.VeiculosVinculados select o.DescricaoComModeloVeicularCarga);

            return string.Join(", ", placasComModeloVeicularCarga);
        }

        private void AtualizarSituacaoJanelaCarregamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Usuario usuario, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador, Repositorio.UnitOfWork unitOfWork)
        {
            if (carga == null)
                return;

            Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportador repositorioCargaJanelaCarregamentoTransportador = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamentoTransportador(unitOfWork);
            Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoTransportador cargaJanelaCarregamentoTransportador = repositorioCargaJanelaCarregamentoTransportador.BuscarPorCargaETransportador(carga.Codigo, carga.Empresa?.Codigo ?? 0);

            if (cargaJanelaCarregamentoTransportador == null)
                return;

            if (cargaJanelaCarregamentoTransportador.Situacao == SituacaoCargaJanelaCarregamentoTransportador.AgConfirmacao)
                return;

            Servicos.Embarcador.Logistica.CargaJanelaCarregamentoNotificacao servicoCargaJanelaCarregamentoNotificacao = new Servicos.Embarcador.Logistica.CargaJanelaCarregamentoNotificacao(unitOfWork, configuracaoEmbarcador, null);
            Servicos.Embarcador.Logistica.CargaJanelaCarregamentoTransportador servicoCargaJanelaCarregamentoTransportador = new Servicos.Embarcador.Logistica.CargaJanelaCarregamentoTransportador(unitOfWork, configuracaoEmbarcador);

            cargaJanelaCarregamentoTransportador.Situacao = SituacaoCargaJanelaCarregamentoTransportador.AgConfirmacao;
            repositorioCargaJanelaCarregamentoTransportador.Atualizar(cargaJanelaCarregamentoTransportador);
            servicoCargaJanelaCarregamentoTransportador.SalvarHistoricoAlteracao(cargaJanelaCarregamentoTransportador, "Carga disponibilizada para o transportador confirmar os dados de transporte", usuario);
            servicoCargaJanelaCarregamentoNotificacao.EnviarEmailCargaDisponibilizadaParaTransportador(cargaJanelaCarregamentoTransportador);
        }

        private void AtualizarCargaPorPedido(Dominio.Entidades.Embarcador.Pedidos.Pedido pedido, Dominio.Entidades.Embarcador.Cargas.Carga carga, TipoServicoMultisoftware tipoServicoMultisoftware, UnitOfWork unitOfWork, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao, Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga)
        {
            DateTime dataInicialPrevisaoCarregamento = new DateTime();
            DateTime dataFinalPrevisaoCarregamento = new DateTime();
            DateTime dataCarregamento = new DateTime();

            if (pedido.DataInicialColeta.HasValue && (pedido.DataInicialColeta < dataInicialPrevisaoCarregamento || dataInicialPrevisaoCarregamento == DateTime.MinValue))
                dataInicialPrevisaoCarregamento = pedido.DataInicialColeta.Value;

            if (pedido.DataFinalColeta.HasValue && (pedido.DataFinalColeta > dataFinalPrevisaoCarregamento || dataFinalPrevisaoCarregamento == DateTime.MinValue))
                dataFinalPrevisaoCarregamento = pedido.DataFinalColeta.Value;

            if (pedido.DataCarregamentoPedido.HasValue && (pedido.DataCarregamentoPedido < dataCarregamento || dataCarregamento == DateTime.MinValue))
                dataCarregamento = pedido.DataCarregamentoPedido.Value;

            Repositorio.Embarcador.Pedidos.PedidoFronteira repositorioPedidoFronteira = new Repositorio.Embarcador.Pedidos.PedidoFronteira(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaFronteira repositorioCargaFronteira = new Repositorio.Embarcador.Cargas.CargaFronteira(unitOfWork);

            List<Dominio.Entidades.Cliente> listaFronteirasCarga = repositorioCargaFronteira.BuscarFronteirasPorCarga(carga.Codigo);
            List<Dominio.Entidades.Cliente> listaFronteirasPedidoValidar = repositorioPedidoFronteira.BuscarFronteirasPorPedido(pedido.Codigo);

            if (listaFronteirasPedidoValidar.Count == 0 && pedido.Fronteira != null)
            {
                listaFronteirasPedidoValidar.Add(pedido.Fronteira);
            }

            bool fronteirasPedidoIguais = true;

            if (listaFronteirasCarga.Count != listaFronteirasPedidoValidar.Count)
            {
                fronteirasPedidoIguais = false;
            }
            else
            {
                List<double> cpfsOriginal = listaFronteirasCarga.Select(c => c.CPF_CNPJ).OrderBy(c => c).ToList();
                List<double> cpfsValidar = listaFronteirasPedidoValidar.Select(c => c.CPF_CNPJ).OrderBy(c => c).ToList();
                if (cpfsOriginal?.Count > 0)
                    fronteirasPedidoIguais = cpfsOriginal.SequenceEqual(cpfsValidar);
            }

            if (fronteirasPedidoIguais || carga.Pedidos?.Count == 1)
            {
                listaFronteirasCarga = listaFronteirasPedidoValidar;
            }
            else
                throw new ServicoException("Não é possível atualizar, as fronteiras da carga são diferentes.");

            Repositorio.Embarcador.Pedidos.PedidoProduto repositorioPedidoProduto = new Repositorio.Embarcador.Pedidos.PedidoProduto(unitOfWork);
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoProduto> listaPedidoProduto = repositorioPedidoProduto.BuscarPorPedido(pedido.Codigo);

            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido = repositorioCargaPedido.BuscarPorCargaEPedido(carga.Codigo, pedido.Codigo);

            Servicos.Embarcador.Carga.CargaPedido servicoCargaPedido = new Servicos.Embarcador.Carga.CargaPedido(unitOfWork);
            string mensagemErroSetarDadosCargaPedido = servicoCargaPedido.SetarDadosCargaPedido(ref cargaPedido, carga, pedido, tipoServicoMultisoftware, unitOfWork, configuracao, configuracaoGeralCarga);

            if (!string.IsNullOrWhiteSpace(mensagemErroSetarDadosCargaPedido))
                throw new ServicoException(mensagemErroSetarDadosCargaPedido);

            repositorioCargaPedido.Atualizar(cargaPedido);

            servicoCargaPedido.AdicionarProdutosCargaPedido(cargaPedido, listaPedidoProduto, configuracao.UsarPesoProdutoSumarizacaoCarga, unitOfWork);

            CargaFronteira serCargaFronteira = new Servicos.Embarcador.Carga.CargaFronteira(unitOfWork);
            if (!serCargaFronteira.TemFronteira(carga) && listaFronteirasCarga.Count > 0)
            {
                // Adicionar fronteira na carga
                Repositorio.Embarcador.Cargas.CargaFronteira repCargaFronteira = new Repositorio.Embarcador.Cargas.CargaFronteira(unitOfWork);
                foreach (Dominio.Entidades.Cliente itemFronteira in listaFronteirasCarga)
                {
                    repCargaFronteira.Inserir(new Dominio.Entidades.Embarcador.Cargas.CargaFronteira
                    {
                        Carga = carga,
                        Fronteira = itemFronteira
                    });
                }
            }

            if (dataInicialPrevisaoCarregamento != DateTime.MinValue)
                carga.DataInicialPrevisaoCarregamento = dataInicialPrevisaoCarregamento;

            if (dataFinalPrevisaoCarregamento != DateTime.MinValue)
                carga.DataFinalPrevisaoCarregamento = dataFinalPrevisaoCarregamento;

            if (dataCarregamento != DateTime.MinValue)
                carga.DataCarregamentoCarga = dataCarregamento;

            if (carga.PortoOrigem?.Codigo != pedido.Porto?.Codigo && pedido.Porto != null)
                carga.PortoOrigem = pedido.Porto;

            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            repositorioCarga.Atualizar(carga);
        }

        private void DisponibilizarMotoristasFilaCarregamento(Dominio.Entidades.Embarcador.Cargas.Carga carga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, UnitOfWork unitOfWork)
        {
            Logistica.FilaCarregamentoVeiculo servicoFila = new Logistica.FilaCarregamentoVeiculo(unitOfWork, OrigemAlteracaoFilaCarregamento.Sistema);

            servicoFila.FinalizarPorCarga(carga.Codigo, tipoServicoMultisoftware);
        }


        public Dominio.Entidades.Embarcador.Pedidos.TipoOperacao ProcessarRegrasTipoOperacao(ref Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.RegraTipoOperacao repRegraTipoOperacao = new Repositorio.Embarcador.Pedidos.RegraTipoOperacao(unitOfWork);
            List<Dominio.Entidades.Embarcador.Pedidos.RegraTipoOperacao> listaTodasRegra = repRegraTipoOperacao.BuscarTodosAtivos();

            Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacao = carga.TipoOperacao;

            if (listaTodasRegra.Count > 0)
                tipoOperacao = ObterTipoOperacaoPorRegra(unitOfWork, carga, cargaPedidos, listaTodasRegra);

            return tipoOperacao;
        }

        public async Task<Dominio.Entidades.Embarcador.Pedidos.TipoOperacao> ProcessarRegrasTipoOperacaoAsync(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.RegraTipoOperacao repRegraTipoOperacao = new Repositorio.Embarcador.Pedidos.RegraTipoOperacao(unitOfWork);
            List<Dominio.Entidades.Embarcador.Pedidos.RegraTipoOperacao> listaTodasRegra = await repRegraTipoOperacao.BuscarTodosAtivosAsync();

            Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacao = carga.TipoOperacao;

            if (listaTodasRegra.Count > 0)
                tipoOperacao = ObterTipoOperacaoPorRegra(unitOfWork, carga, cargaPedidos, listaTodasRegra);

            return tipoOperacao;
        }

        public void ObterTipoTrecho(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Repositorio.UnitOfWork unitOfWork, bool criarLog, ref List<string> Logs)
        {
            Logs = new List<string>();

            List<Dominio.ObjetosDeValor.MemoryCache.TipoTrecho> tiposTrecho = CacheProvider.Instance.GetOrCreate("TipoTrechos",
                () =>
                {
                    var repo = new Repositorio.Embarcador.Cargas.TipoTrecho(unitOfWork);
                    return repo.ObterDadosTiposTrechoAtivos();
                });

            List<double> clientesOrigem = new List<double>();
            List<double> clientesDestino = new List<double>();
            List<int> categoriasDestino = new List<int>();
            List<int> categoriasOrigem = new List<int>();
            List<int> categoriasRecebedor = new List<int>();
            List<int> categoriasExpedidor = new List<int>();

            // melhoar consulta apenas validar o conceito depois melhorar consulta
            if (criarLog)
                Logs.Add("Adicionando Categorias:");
            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cp in cargaPedidos)
            {
                if (cp.Pedido?.Destinatario != null)
                {
                    clientesDestino.Add(cp.Pedido.Destinatario.CPF_CNPJ);
                    if (criarLog)
                        Logs.Add("Add Clientes Destino: " + cp.Pedido.Destinatario.Descricao);
                    if (cp.Pedido.Destinatario.Categoria != null)
                    {
                        categoriasDestino.Add(cp.Pedido.Destinatario.Categoria.Codigo);
                        if (criarLog)
                            Logs.Add("Add Categorias Destino: " + cp.Pedido.Destinatario.Categoria.Descricao);
                    }
                }
                if (cp.Pedido?.Remetente != null)
                {
                    clientesOrigem.Add(cp.Pedido.Remetente.CPF_CNPJ);
                    if (criarLog)
                        Logs.Add("Add Clientes Origem: " + cp.Pedido.Remetente.Descricao);
                    if (cp.Pedido.Remetente.Categoria != null)
                    {
                        categoriasOrigem.Add(cp.Pedido.Remetente.Categoria.Codigo);
                        if (criarLog)
                            Logs.Add("Add Categorias Origem: " + cp.Pedido.Remetente.Categoria.Descricao);
                    }
                }
                if (cp.Pedido?.Recebedor?.Categoria != null)
                {
                    categoriasRecebedor.Add(cp.Pedido.Recebedor.Categoria.Codigo);
                    if (criarLog)
                        Logs.Add("Add Categorias Recebedor: " + cp.Pedido.Recebedor.Categoria.Descricao);
                }
                if (cp.Pedido?.Expedidor?.Categoria != null)
                {
                    categoriasExpedidor.Add(cp.Pedido.Expedidor.Categoria.Codigo);
                    if (criarLog)
                        Logs.Add("Add Categorias Expedidor: " + cp.Pedido.Expedidor.Categoria.Descricao);
                }
            }


            if (criarLog)
                Logs.Add("Comparando trechos:");
            // encontra TipoTrecho
            int TipoTrechoBest = -1;
            List<int> TipoTrechoEleitos = new List<int>();
            foreach (Dominio.ObjetosDeValor.MemoryCache.TipoTrecho tt in tiposTrecho)
            {
                if (criarLog)
                    Logs.Add("Trecho " + tt.Codigo + " - " + tt.Descricao);
                List<double> elementosComunsClientesOrigem = tt.ClientesOrigem.Intersect(clientesOrigem).ToList();
                List<double> elementosComunsClientesDestino = tt.ClientesDestino.Intersect(clientesDestino).ToList();
                if (elementosComunsClientesOrigem == null || elementosComunsClientesOrigem.Count == 0 || elementosComunsClientesDestino == null || elementosComunsClientesDestino.Count == 0)
                {
                    if (criarLog)
                        Logs.Add("Nao compativel com Cliente Origem/Destino");
                    if (carga.TipoOperacao == null || !(tt.TiposOperacao.Contains(carga.TipoOperacao.Codigo)))
                    {
                        if (criarLog)
                            Logs.Add("Nao compativel com tipo operacao" + carga.TipoOperacao?.Descricao ?? "");
                        continue;
                    }
                    else
                    {
                        if (criarLog)
                            Logs.Add("Compativel com tipo operacao" + carga.TipoOperacao.Descricao);
                    }
                    if (carga.ModeloVeicularCarga == null || !(tt.ModelosVeiculares.Contains(carga.ModeloVeicularCarga.Codigo)))
                    {
                        if (criarLog)
                            Logs.Add("Nao compativel com modelo veicular " + carga.ModeloVeicularCarga?.Descricao ?? "");
                        continue;
                    }
                    else
                    {
                        if (criarLog)
                            Logs.Add("Compativel com modelo veicular" + carga.ModeloVeicularCarga.Descricao);
                    }

                    List<int> elementosComunsCategoriaDestino = tt.CategoriasDestino.Intersect(categoriasDestino).ToList();
                    List<int> elementosComunsCategoriaOrigem = tt.CategoriasOrigem.Intersect(categoriasOrigem).ToList();
                    List<int> elementosComunsCategoriaExpedidor = tt.CategoriasExpedidor.Intersect(categoriasExpedidor).ToList();
                    List<int> elementosComunsCategoriaRecebedor = tt.CategoriasRecebedor.Intersect(categoriasRecebedor).ToList();

                    if ((elementosComunsCategoriaDestino?.Any() == true && elementosComunsCategoriaOrigem?.Any() == true) ||
                        (elementosComunsCategoriaExpedidor?.Any() == true && elementosComunsCategoriaRecebedor?.Any() == true))
                    {
                        if (criarLog)
                        {
                            if (elementosComunsCategoriaDestino?.Any() == true && elementosComunsCategoriaOrigem?.Any() == true)
                                Logs.Add("Compativel com Categoria Destino e Origem");

                            if (elementosComunsCategoriaExpedidor?.Any() == true && elementosComunsCategoriaRecebedor?.Any() == true)
                                Logs.Add("Compativel com Categoria Expedidor e Recebedor");
                        }
                        if (elementosComunsCategoriaDestino?.Any() == true && elementosComunsCategoriaOrigem?.Any() == true &&
                        elementosComunsCategoriaExpedidor?.Any() == true && elementosComunsCategoriaRecebedor?.Any() == true)
                            TipoTrechoBest = tt.Codigo;
                    }
                    else
                    {
                        if (criarLog)
                            Logs.Add("Nao compativel com Categoria Destino, Origem, Expedidor e Recebedor");
                        continue;
                    }
                }
                else
                {
                    if (criarLog)
                        Logs.Add("Compativel com Cliente Origem");
                }
                if (criarLog)
                    Logs.Add("Trecho " + tt.Codigo + " - " + tt.Descricao + " ELEITO");

                TipoTrechoEleitos.Add(tt.Codigo);
            }
            if (TipoTrechoEleitos != null)
            {
                Repositorio.Embarcador.Cargas.TipoTrecho repositorioTipoTrecho = new Repositorio.Embarcador.Cargas.TipoTrecho(unitOfWork);
                carga.TipoTrecho = repositorioTipoTrecho.BuscarPorCodigo((TipoTrechoBest == -1 ? TipoTrechoEleitos.FirstOrDefault() : TipoTrechoBest), false);
            }

        }

        public async Task ObterTipoTrechoAsync(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Repositorio.UnitOfWork unitOfWork, bool criarLog, List<string> Logs)
        {
            Logs = new List<string>();

            List<Dominio.ObjetosDeValor.MemoryCache.TipoTrecho> tiposTrecho = CacheProvider.Instance.GetOrCreate("TipoTrechos",
                () =>
                {
                    var repo = new Repositorio.Embarcador.Cargas.TipoTrecho(unitOfWork);
                    return repo.ObterDadosTiposTrechoAtivos();
                });

            List<double> clientesOrigem = new List<double>();
            List<double> clientesDestino = new List<double>();
            List<int> categoriasDestino = new List<int>();
            List<int> categoriasOrigem = new List<int>();
            List<int> categoriasRecebedor = new List<int>();
            List<int> categoriasExpedidor = new List<int>();

            // melhoar consulta apenas validar o conceito depois melhorar consulta
            if (criarLog)
                Logs.Add("Adicionando Categorias:");
            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cp in cargaPedidos)
            {
                if (cp.Pedido?.Destinatario != null)
                {
                    clientesDestino.Add(cp.Pedido.Destinatario.CPF_CNPJ);
                    if (criarLog)
                        Logs.Add("Add Clientes Destino: " + cp.Pedido.Destinatario.Descricao);
                    if (cp.Pedido.Destinatario.Categoria != null)
                    {
                        categoriasDestino.Add(cp.Pedido.Destinatario.Categoria.Codigo);
                        if (criarLog)
                            Logs.Add("Add Categorias Destino: " + cp.Pedido.Destinatario.Categoria.Descricao);
                    }
                }
                if (cp.Pedido?.Remetente != null)
                {
                    clientesOrigem.Add(cp.Pedido.Remetente.CPF_CNPJ);
                    if (criarLog)
                        Logs.Add("Add Clientes Origem: " + cp.Pedido.Remetente.Descricao);
                    if (cp.Pedido.Remetente.Categoria != null)
                    {
                        categoriasOrigem.Add(cp.Pedido.Remetente.Categoria.Codigo);
                        if (criarLog)
                            Logs.Add("Add Categorias Origem: " + cp.Pedido.Remetente.Categoria.Descricao);
                    }
                }
                if (cp.Pedido?.Recebedor?.Categoria != null)
                {
                    categoriasRecebedor.Add(cp.Pedido.Recebedor.Categoria.Codigo);
                    if (criarLog)
                        Logs.Add("Add Categorias Recebedor: " + cp.Pedido.Recebedor.Categoria.Descricao);
                }
                if (cp.Pedido?.Expedidor?.Categoria != null)
                {
                    categoriasExpedidor.Add(cp.Pedido.Expedidor.Categoria.Codigo);
                    if (criarLog)
                        Logs.Add("Add Categorias Expedidor: " + cp.Pedido.Expedidor.Categoria.Descricao);
                }
            }


            if (criarLog)
                Logs.Add("Comparando trechos:");
            // encontra TipoTrecho
            int TipoTrechoBest = -1;
            List<int> TipoTrechoEleitos = new List<int>();
            foreach (Dominio.ObjetosDeValor.MemoryCache.TipoTrecho tt in tiposTrecho)
            {
                if (criarLog)
                    Logs.Add("Trecho " + tt.Codigo + " - " + tt.Descricao);
                List<double> elementosComunsClientesOrigem = tt.ClientesOrigem.Intersect(clientesOrigem).ToList();
                List<double> elementosComunsClientesDestino = tt.ClientesDestino.Intersect(clientesDestino).ToList();
                if (elementosComunsClientesOrigem == null || elementosComunsClientesOrigem.Count == 0 || elementosComunsClientesDestino == null || elementosComunsClientesDestino.Count == 0)
                {
                    if (criarLog)
                        Logs.Add("Nao compativel com Cliente Origem/Destino");
                    if (carga.TipoOperacao == null || !(tt.TiposOperacao.Contains(carga.TipoOperacao.Codigo)))
                    {
                        if (criarLog)
                            Logs.Add("Nao compativel com tipo operacao" + carga.TipoOperacao?.Descricao ?? "");
                        continue;
                    }
                    else
                    {
                        if (criarLog)
                            Logs.Add("Compativel com tipo operacao" + carga.TipoOperacao.Descricao);
                    }
                    if (carga.ModeloVeicularCarga == null || !(tt.ModelosVeiculares.Contains(carga.ModeloVeicularCarga.Codigo)))
                    {
                        if (criarLog)
                            Logs.Add("Nao compativel com modelo veicular " + carga.ModeloVeicularCarga?.Descricao ?? "");
                        continue;
                    }
                    else
                    {
                        if (criarLog)
                            Logs.Add("Compativel com modelo veicular" + carga.ModeloVeicularCarga.Descricao);
                    }

                    List<int> elementosComunsCategoriaDestino = tt.CategoriasDestino.Intersect(categoriasDestino).ToList();
                    List<int> elementosComunsCategoriaOrigem = tt.CategoriasOrigem.Intersect(categoriasOrigem).ToList();
                    List<int> elementosComunsCategoriaExpedidor = tt.CategoriasExpedidor.Intersect(categoriasExpedidor).ToList();
                    List<int> elementosComunsCategoriaRecebedor = tt.CategoriasRecebedor.Intersect(categoriasRecebedor).ToList();

                    if ((elementosComunsCategoriaDestino?.Any() == true && elementosComunsCategoriaOrigem?.Any() == true) ||
                        (elementosComunsCategoriaExpedidor?.Any() == true && elementosComunsCategoriaRecebedor?.Any() == true))
                    {
                        if (criarLog)
                        {
                            if (elementosComunsCategoriaDestino?.Any() == true && elementosComunsCategoriaOrigem?.Any() == true)
                                Logs.Add("Compativel com Categoria Destino e Origem");

                            if (elementosComunsCategoriaExpedidor?.Any() == true && elementosComunsCategoriaRecebedor?.Any() == true)
                                Logs.Add("Compativel com Categoria Expedidor e Recebedor");
                        }
                        if (elementosComunsCategoriaDestino?.Any() == true && elementosComunsCategoriaOrigem?.Any() == true &&
                        elementosComunsCategoriaExpedidor?.Any() == true && elementosComunsCategoriaRecebedor?.Any() == true)
                            TipoTrechoBest = tt.Codigo;
                    }
                    else
                    {
                        if (criarLog)
                            Logs.Add("Nao compativel com Categoria Destino, Origem, Expedidor e Recebedor");
                        continue;
                    }
                }
                else
                {
                    if (criarLog)
                        Logs.Add("Compativel com Cliente Origem");
                }
                if (criarLog)
                    Logs.Add("Trecho " + tt.Codigo + " - " + tt.Descricao + " ELEITO");

                TipoTrechoEleitos.Add(tt.Codigo);
            }
            if (TipoTrechoEleitos != null)
            {
                Repositorio.Embarcador.Cargas.TipoTrecho repositorioTipoTrecho = new Repositorio.Embarcador.Cargas.TipoTrecho(unitOfWork);
                carga.TipoTrecho = repositorioTipoTrecho.BuscarPorCodigo((TipoTrechoBest == -1 ? TipoTrechoEleitos.FirstOrDefault() : TipoTrechoBest), false);
            }

        }

        public bool VerificarSeCTeEmitidoNoEmbarcador(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, Repositorio.UnitOfWork unitOfWork, List<Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoEmissaoDocumentoEmbarcador> CacheConfiguracaoEmissaoDocumentoEmbarcador)
        {
            Dominio.Entidades.Cliente tomador = cargaPedido.ObterTomador();

            if (tomador != null && cargaPedido.Carga.TipoOperacao != null)
            {
                Repositorio.Embarcador.Configuracoes.ConfiguracaoEmissaoDocumentoEmbarcador repConfiguracaoEmissaoDocumentoEmbarcador = new Repositorio.Embarcador.Configuracoes.ConfiguracaoEmissaoDocumentoEmbarcador(unitOfWork);

                bool configuradoParaEmissaoDocumentoEmbarcador = repConfiguracaoEmissaoDocumentoEmbarcador.ExistePorClienteETipoOperacao(tomador, cargaPedido.Carga.TipoOperacao, CacheConfiguracaoEmissaoDocumentoEmbarcador);

                if (configuradoParaEmissaoDocumentoEmbarcador)
                    return true;
            }

            if (cargaPedido.Carga.TipoOperacao != null && cargaPedido.Carga.TipoOperacao.UsarConfiguracaoEmissao)
                return cargaPedido.Carga.TipoOperacao.CTeEmitidoNoEmbarcador;
            else
            {
                if (tomador != null && tomador.CTeEmitidoNoEmbarcador)
                {
                    if (tomador.GrupoPessoas != null)
                        return tomador.GrupoPessoas.CTeEmitidoNoEmbarcador;
                    else
                        return false;
                }
                else if (cargaPedido.Pedido.GrupoPessoas != null)
                {
                    return cargaPedido.Pedido.GrupoPessoas.CTeEmitidoNoEmbarcador;
                }
                else
                {
                    return false;
                }
            }
        }

        private bool VerificarSeObrigatorioInformarMDFeEmitidoPeloEmbarcador(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, Repositorio.UnitOfWork unitOfWork)
        {
            Dominio.Entidades.Cliente tomador = cargaPedido.ObterTomador();

            if (cargaPedido.Carga.TipoOperacao != null && cargaPedido.Carga.TipoOperacao.UsarConfiguracaoEmissao)
                return cargaPedido.Carga.TipoOperacao.ObrigatorioInformarMDFeEmitidoPeloEmbarcador;
            else
            {
                if (tomador != null && tomador.ObrigatorioInformarMDFeEmitidoPeloEmbarcador)
                {
                    if (tomador.GrupoPessoas != null)
                        return tomador.GrupoPessoas.ObrigatorioInformarMDFeEmitidoPeloEmbarcador;
                    else
                        return false;
                }
                else if (cargaPedido.Pedido.GrupoPessoas != null)
                {
                    return cargaPedido.Pedido.GrupoPessoas.ObrigatorioInformarMDFeEmitidoPeloEmbarcador;
                }
                else
                {
                    return false;
                }
            }
        }

        public bool VerificarSePossuiDocumentoVinculado(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe repCargaPedidoDocumentoCTe = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoDocumentoMDFe repCargaPedidoDocumentoMDFe = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoMDFe(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao repPedidoCTeParaSubcontratacao = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);

            return repCargaPedidoDocumentoCTe.ExistePorCarga(carga.Codigo) ||
                   repCargaPedidoDocumentoMDFe.ExistePorCarga(carga.Codigo) ||
                   repPedidoXMLNotaFiscal.VerificarSeExistePorCarga(carga.Codigo) ||
                   repPedidoCTeParaSubcontratacao.VerificarSeExistePorCarga(carga.Codigo);
        }


        private void TransferirDadosCargaAntiga(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {
            cargaNova.Veiculo = cargaAntiga.Veiculo;
            cargaNova.Empresa = cargaAntiga.Empresa;
            cargaNova.Motoristas = cargaAntiga.Motoristas.ToList();
            cargaNova.ValorFrete = cargaAntiga.ValorFrete;
            cargaNova.ValorFreteOperador = cargaAntiga.ValorFreteOperador;
            cargaNova.ValorFreteAPagar = cargaAntiga.ValorFrete;
            cargaNova.TipoFreteEscolhido = TipoFreteEscolhido.Operador;

            string mensagem = "";

            Dominio.Entidades.Embarcador.Operacional.OperadorLogistica operadorLogistica = new Repositorio.Embarcador.Operacional.OperadorLogistica(unitOfWork).BuscarPorUsuario(cargaAntiga.Operador.Codigo);

            SalvarValorFreteManual(cargaAntiga.Operador, operadorLogistica, tipoServicoMultisoftware, cargaNova.Codigo, cargaAntiga.ValorFreteOperador, unitOfWork);
        }

        //private void enviarEmailSolicitaCancelamentoNFs(List<Dominio.Entidades.Embarcador.Cargas.CargaNFS> cargaNFSs)
        //{
        //    //todo: isso é uma gambi das pior que existe, tirar o sleep e chamar o método somente depois de dar commit na unidade de trabalho anterior, ver isso no metodo enviarEmailSolicitacaoCancelamentoCTe também.
        //    System.Threading.Thread.Sleep(5000);
        //    Repositorio.UnitOfWork unitOfWork = new Repositorio.UnitOfWork(StringConexao);

        //    Repositorio.Embarcador.Cargas.CargaNFS repCargaNFS = new Repositorio.Embarcador.Cargas.CargaNFS(unitOfWork);

        //    Repositorio.Embarcador.Email.ConfigEmailDocTransporte repConfigEmailDocTransporte = new Repositorio.Embarcador.Email.ConfigEmailDocTransporte(unitOfWork);
        //    Dominio.Entidades.Embarcador.Email.ConfigEmailDocTransporte email = repConfigEmailDocTransporte.BuscarEmailAtivo();
        //    if (email != null)
        //    {
        //        Servicos.Email serEmail = new Email(StringConexao);

        //        Dominio.Entidades.Empresa empresa = cargaNFSs.FirstOrDefault().Carga.Empresa;

        //        Servicos.Embarcador.Carga.NFS serCargaNFS = new Servicos.Embarcador.Carga.NFS(StringConexao);
        //        if (cargaNFSs.Exists(obj => obj.NotaFiscalServico != null))
        //        {
        //            System.Text.StringBuilder stBuilder = new StringBuilder();

        //            stBuilder.Append("Olá " + empresa.RazaoSocial + ", solicitamos que faça o cancelamento da(s) NFS(s).").AppendLine().AppendLine();

        //            foreach (Dominio.Entidades.Embarcador.Cargas.CargaNFS cargaNFs in cargaNFSs)
        //            {
        //                stBuilder.Append("<b>DADOS PARA EMISSÃO</b>").AppendLine();
        //                stBuilder.Append("Emissor:" + cargaNFs.Carga.Empresa.RazaoSocial).AppendLine();
        //                stBuilder.Append("Localidade da prestação:" + cargaNFs.LocalidadePrestacao.DescricaoCidadeEstado).AppendLine();
        //                stBuilder.Append("Valor do Serviço:" + cargaNFs.ValorFrete.ToString("n2")).AppendLine().AppendLine();
        //                serCargaNFS.PreencherRemetenteNFs(ref stBuilder, cargaNFs, unitOfWork);
        //                serCargaNFS.PreencherDestinatarioNFs(ref stBuilder, cargaNFs);
        //                stBuilder.Append("<hr/>"); ;
        //            }

        //            if (!string.IsNullOrWhiteSpace(email.MensagemRodape))
        //            {
        //                stBuilder.Append(email.MensagemRodape.Replace("#qLinha#", "<br/>"));
        //            }

        //            if (!string.IsNullOrWhiteSpace(empresa.Email))
        //                serEmail.EnviarEmail(email.Email, email.Email, email.Senha, empresa.Email, "", "", "Solicitação de Cancelamento da(s) NFS(s)", stBuilder.ToString(), email.Smtp, null, "", email.RequerAutenticacaoSmtp, "", email.PortaSmtp);
        //        }
        //        else
        //        {
        //            System.Text.StringBuilder stBuilder = new StringBuilder();

        //            stBuilder.Append("Olá " + empresa.RazaoSocial + ", solicitamos que não faça a emissão da(s) NFS(s) solicitado(s) anteriormente, caso tenha emitido por gentileza faça o cancelamento da(s) mesma(s).").AppendLine().AppendLine();


        //            foreach (Dominio.Entidades.Embarcador.Cargas.CargaNFS cargaNFs in cargaNFSs)
        //            {
        //                stBuilder.Append("<b>DADOS PARA EMISSÃO</b>").AppendLine();
        //                stBuilder.Append("Emissor:" + cargaNFs.Carga.Empresa.RazaoSocial).AppendLine();
        //                stBuilder.Append("Localidade da prestação:" + cargaNFs.LocalidadePrestacao.DescricaoCidadeEstado).AppendLine();
        //                stBuilder.Append("Valor do Serviço:" + cargaNFs.ValorFrete.ToString("n2")).AppendLine().AppendLine();
        //                serCargaNFS.PreencherRemetenteNFs(ref stBuilder, cargaNFs, unitOfWork);
        //                serCargaNFS.PreencherDestinatarioNFs(ref stBuilder, cargaNFs);
        //                stBuilder.Append("<hr/>"); ;
        //            }

        //            if (!string.IsNullOrWhiteSpace(email.MensagemRodape))
        //            {
        //                stBuilder.Append(email.MensagemRodape.Replace("#qLinha#", "<br/>"));
        //            }

        //            if (!string.IsNullOrWhiteSpace(empresa.Email))
        //                serEmail.EnviarEmail(email.Email, email.Email, email.Senha, empresa.Email, "", "", "Cancelar emissão da(s) NFS(s)", stBuilder.ToString(), email.Smtp, null, "", email.RequerAutenticacaoSmtp, "", email.PortaSmtp);

        //        }
        //    }
        //    unitOfWork.Dispose();
        //}

        //private void enviarEmailSolicitacaoCancelamentoCTe(List<Dominio.Entidades.Embarcador.Cargas.CargaCTe> cargaCTEs)
        //{
        //    System.Threading.Thread.Sleep(5000);
        //    Repositorio.UnitOfWork unitOfWork = new Repositorio.UnitOfWork(StringConexao);

        //    Repositorio.Embarcador.Cargas.CargaNFS repCargaNFS = new Repositorio.Embarcador.Cargas.CargaNFS(unitOfWork);

        //    Repositorio.Embarcador.Email.ConfigEmailDocTransporte repConfigEmailDocTransporte = new Repositorio.Embarcador.Email.ConfigEmailDocTransporte(unitOfWork);
        //    Dominio.Entidades.Embarcador.Email.ConfigEmailDocTransporte email = repConfigEmailDocTransporte.BuscarEmailAtivo();
        //    if (email != null)
        //    {
        //        Servicos.Email serEmail = new Email(StringConexao);

        //        Dominio.Entidades.Empresa empresa = cargaCTEs.FirstOrDefault().Carga.Empresa;

        //        if (cargaCTEs.Exists(obj => obj.CTe != null))
        //        {
        //            System.Text.StringBuilder stBuilder = new StringBuilder();

        //            stBuilder.Append("Olá " + empresa.RazaoSocial + ", solicitamos que faça o cancelamento do(s) CT-e(s).").AppendLine().AppendLine();

        //            foreach (Dominio.Entidades.Embarcador.Cargas.CargaCTe cargaCTe in cargaCTEs)
        //            {
        //                if (cargaCTe.CTe != null)
        //                {
        //                    stBuilder.Append("<b>Chave: </b>" + cargaCTe.CTe.Chave).AppendLine();
        //                    stBuilder.Append("<b>Número: </b>" + cargaCTe.CTe.Numero).AppendLine();
        //                    stBuilder.Append("<b>Série: </b>" + cargaCTe.CTe.Serie.Numero).AppendLine();
        //                    stBuilder.Append("<hr/>").AppendLine().AppendLine();
        //                }
        //            }

        //            if (!string.IsNullOrWhiteSpace(email.MensagemRodape))
        //            {
        //                stBuilder.Append(email.MensagemRodape.Replace("#qLinha#", "<br/>"));
        //            }

        //            if (!string.IsNullOrWhiteSpace(empresa.Email))
        //                serEmail.EnviarEmail(email.Email, email.Email, email.Senha, empresa.Email, "", "", "Solicitação de Cancelamento do(s) CT-e(s)", stBuilder.ToString(), email.Smtp, null, "", email.RequerAutenticacaoSmtp, "", email.PortaSmtp);
        //        }

        //        if (cargaCTEs.Exists(obj => obj.CTe == null && obj.PreCTe != null))
        //        {
        //            Servicos.Embarcador.Carga.PreCTe serCargaPreCTe = new Servicos.Embarcador.Carga.PreCTe(StringConexao);
        //            Servicos.PreCTe serPreCte = new Servicos.PreCTe(StringConexao);
        //            System.Text.StringBuilder stBuilder = new StringBuilder();

        //            stBuilder.Append("Olá " + empresa.RazaoSocial + ", solicitamos que não faça a emissão do(s) CT-e(s) solicitado(s) anteriormente, caso tenha emitido por gentileza faça o cancelamento do(s) mesmo(s).").AppendLine().AppendLine();

        //            List<System.Net.Mail.Attachment> anexos = new List<System.Net.Mail.Attachment>();

        //            foreach (Dominio.Entidades.Embarcador.Cargas.CargaCTe cargaCTe in cargaCTEs)
        //            {
        //                if (cargaCTe.CTe == null && cargaCTe.PreCTe != null)
        //                {
        //                    stBuilder.Append("<b> <span> PRÉ CT-E NÚMERO: " + cargaCTe.PreCTe.Codigo + "</span></b>").AppendLine().AppendLine();
        //                    serCargaPreCTe.preencherTransportador(ref stBuilder, cargaCTe.PreCTe);
        //                    serCargaPreCTe.preencherRemetente(ref stBuilder, cargaCTe.PreCTe);
        //                    serCargaPreCTe.preencherDestinatario(ref stBuilder, cargaCTe.PreCTe);
        //                    serCargaPreCTe.preencherTomador(ref stBuilder, cargaCTe.PreCTe);
        //                    serCargaPreCTe.preencherRecebedor(ref stBuilder, cargaCTe.PreCTe);
        //                    serCargaPreCTe.preencherExpedidor(ref stBuilder, cargaCTe.PreCTe);
        //                    stBuilder.Append("<hr/>").AppendLine();

        //                    string xml = serPreCte.BuscarXMLPreCte(cargaCTe.PreCTe, unitOfWork);
        //                    MemoryStream stream = new MemoryStream(System.Text.Encoding.Unicode.GetBytes(xml));
        //                    System.Net.Mail.Attachment anexo = new System.Net.Mail.Attachment(stream, string.Concat("pre_cte_" + cargaCTe.PreCTe.Codigo, ".xml"));
        //                    anexos.Add(anexo);
        //                }
        //            }

        //            stBuilder.Append("Segue em anexos o(s) pré CT-e(s) que não deve(m) mais ser(em) emitido(s)").AppendLine().AppendLine();

        //            if (!string.IsNullOrWhiteSpace(email.MensagemRodape))
        //            {
        //                stBuilder.Append(email.MensagemRodape.Replace("#qLinha#", "<br/>"));
        //            }

        //            if (!string.IsNullOrWhiteSpace(empresa.Email))
        //                serEmail.EnviarEmail(email.Email, email.Email, email.Senha, empresa.Email, "", "", "Cancelar emissão do(s) CT-e(s)", stBuilder.ToString(), email.Smtp, anexos, "", email.RequerAutenticacaoSmtp, "", email.PortaSmtp);
        //        }
        //    }
        //    unitOfWork.Dispose();
        //}

        private dynamic ObterDadosContratoFrete(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Servicos.Embarcador.Terceiros.ContratoFrete serContratoFrete = new Terceiros.ContratoFrete(unitOfWork);
            Repositorio.Embarcador.Terceiros.ContratoFrete repContratoFrete = new Repositorio.Embarcador.Terceiros.ContratoFrete(unitOfWork);
            Dominio.Entidades.Embarcador.Terceiros.ContratoFrete contratoFrete = repContratoFrete.BuscarPorCarga(carga.Codigo);
            return serContratoFrete.ObterDetalhescontratoFrete(contratoFrete, unitOfWork);
        }

        private void AdicionarIntegracaoOpenTech(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Repositorio.Embarcador.Configuracoes.Integracao repConfiguracaoIntegracao = new Repositorio.Embarcador.Configuracoes.Integracao(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaIntegracao repCargaIntegracao = new Repositorio.Embarcador.Cargas.CargaIntegracao(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.TipoIntegracao tipoIntegracao = repTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.OpenTech, false);
            Dominio.Entidades.Embarcador.Configuracoes.Integracao configuracaoIntegracao = repConfiguracaoIntegracao.Buscar();

            Servicos.Embarcador.Carga.Carga servicoCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);
            List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao> integracoesPorTipoOperacaoETipoCarga = servicoCarga.ObterTipoIntegracoesPorTipoOperacaoETipoCarga(carga, unitOfWork);

            bool cargaPossuiIntegracaoOpentech = integracoesPorTipoOperacaoETipoCarga.Any(o => o == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.OpenTech);

            if (tipoIntegracao != null && carga.Empresa.IntegrarComGerenciadoraDeRisco && cargaPossuiIntegracaoOpentech &&
                configuracaoIntegracao != null && !(carga.TipoOperacao?.NaoIntegrarOpentech ?? false) && !(carga.Veiculo?.NaoIntegrarOpentech ?? false) &&
                ((carga.TipoDeCarga?.ControlaTemperatura ?? false) || carga.Pedidos.Sum(o => repPedidoXMLNotaFiscal.BuscarTotalPorCargaPedido(o.Codigo)) >= configuracaoIntegracao.ValorBaseOpenTech) &&
                repCargaIntegracao.ContarPorCargaETipoIntegracao(carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.OpenTech) <= 0)
            {
                Servicos.Embarcador.Integracao.IntegracaoCarga svcIntegracaoCarga = new Integracao.IntegracaoCarga(unitOfWork);

                svcIntegracaoCarga.InformarIntegracaoCarga(carga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.OpenTech, unitOfWork);
            }
        }

        private void AdicionarIntegracaoCargaTipoTransportador(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao tipo, bool naoAvancarRejeicaoIntegracaoTranspoortador, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Repositorio.Embarcador.Configuracoes.Integracao repConfiguracaoIntegracao = new Repositorio.Embarcador.Configuracoes.Integracao(unitOfWork);

            if ((carga.TipoOperacao?.NaoIntegrarOpentech ?? false) || (carga.Veiculo?.NaoIntegrarOpentech ?? false))
                return;

            Dominio.Entidades.Embarcador.Configuracoes.Integracao configuracaoIntegracao = repConfiguracaoIntegracao.Buscar();
            Dominio.Entidades.Embarcador.Cargas.TipoIntegracao tipoIntegracao = repTipoIntegracao.BuscarPorTipo(tipo, true);

            if (tipoIntegracao == null)
                return;

            Servicos.Embarcador.Integracao.IntegracaoCarga.AdicionarCargaParaIntegracao(carga, tipoIntegracao, unitOfWork, false, false);

            if (naoAvancarRejeicaoIntegracaoTranspoortador)
            {
                carga.AguardarIntegracaoEtapaTransportador = true;
                repCarga.Atualizar(carga);
            }
        }

        private void AdicionarCargaDadosTransporteIntegracaoTipoTransportador(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao tipo, bool naoAvancarRejeicaoIntegracaoTranspoortador, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Repositorio.Embarcador.Configuracoes.Integracao repConfiguracaoIntegracao = new Repositorio.Embarcador.Configuracoes.Integracao(unitOfWork);

            if ((carga.TipoOperacao?.NaoIntegrarOpentech ?? false) || (carga.Veiculo?.NaoIntegrarOpentech ?? false))
                return;

            Dominio.Entidades.Embarcador.Configuracoes.Integracao configuracaoIntegracao = repConfiguracaoIntegracao.Buscar();
            Dominio.Entidades.Embarcador.Cargas.TipoIntegracao tipoIntegracao = repTipoIntegracao.BuscarPorTipo(tipo, true);

            if (tipoIntegracao == null)
                return;

            Servicos.Embarcador.Integracao.IntegracaoCarga.AdicionarCargaDadosTransporteIntegracao(carga, tipoIntegracao, unitOfWork, false, false);

            if (naoAvancarRejeicaoIntegracaoTranspoortador)
            {
                carga.AguardarIntegracaoEtapaTransportador = true;
                repCarga.Atualizar(carga);
            }
        }


        private bool VerificarAlteracoesDadosOrdemEmbarque(Dominio.Entidades.Embarcador.Cargas.Carga carga)
        {
            if (carga.IsChangedByPropertyName("Veiculo"))
                return true;

            if (carga.IsChangedByPropertyName("Empresa"))
                return true;

            if (carga.IsChangedByPropertyName("VeiculosVinculados"))
                return true;

            if (carga.IsChangedByPropertyName("Motoristas"))
                return true;

            return false;
        }

        private void NotificarAppMotoristas(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Usuario> motoristas, List<int> codigosMotoristasAntesDaAtualizacao, AdminMultisoftware.Dominio.Entidades.Pessoas.Cliente cliente)
        {
            foreach (Dominio.Entidades.Usuario motorista in motoristas)
            {
                if (motorista.CodigoMobile <= 0 || codigosMotoristasAntesDaAtualizacao.Contains(motorista.Codigo))
                {
                    continue;
                }

                dynamic conteudo = new
                {
                    pt = $"Você foi escolhido para fazer a carga {carga.CodigoCargaEmbarcador}",
                    en = $"You have been chosen to do the cargo {carga.CodigoCargaEmbarcador}",
                    es = $"Has sido elegido para hacer la carga {carga.CodigoCargaEmbarcador}",
                };

                Dominio.MSMQ.Notification notification = new Dominio.MSMQ.Notification(
                    conteudo,
                    cliente?.Codigo ?? 0,
                    motorista.CodigoMobile,
                    Dominio.MSMQ.MSMQQueue.SGTMobile,
                    Dominio.SignalR.Hubs.Mobile,
                    Servicos.SignalR.Mobile.GetHub(MobileHubs.PushNotificationGenerica)
                );

                MSMQ.MSMQ.SendPrivateMessage(notification);
            }
        }

        private void AtualizarAgendamentoColeta(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Logistica.AgendamentoColeta repositorioAgendamentoColeta = new Repositorio.Embarcador.Logistica.AgendamentoColeta(unitOfWork);

            Dominio.Entidades.Embarcador.Logistica.AgendamentoColeta agendamentoColeta = repositorioAgendamentoColeta.BuscarPorCarga(carga.Codigo);

            if (agendamentoColeta != null)
            {
                if (agendamentoColeta.Transportador?.Codigo != carga.Empresa?.Codigo)
                {
                    agendamentoColeta.Transportador = carga.Empresa;

                    repositorioAgendamentoColeta.Atualizar(agendamentoColeta, auditado, null, "Alteração na carga.");
                }
            }
        }

        public bool CenarioIntegracaoConfigurado(ref Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao tipoIntegracao)
        {
            Repositorio.Embarcador.Configuracoes.IntegracaoUnilever repositorioIntegracaoUnilever = new Repositorio.Embarcador.Configuracoes.IntegracaoUnilever(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoUnilever integracaoUnilever = repositorioIntegracaoUnilever.BuscarPrimeiroRegistro();

            if (integracaoUnilever == null || !integracaoUnilever.PossuiIntegracaoUnilever || !integracaoUnilever.IntegrarAvancoParaEmissao ||
               carga.TipoOperacao == null || carga.TipoOperacao.ConfiguracaoIntegracao == null || !carga.TipoOperacao.ConfiguracaoIntegracao.HabilitarIntegracaoAvancoParaEmissao)
                return false;

            bool possuiIntegracao = carga.TipoOperacao.Integracoes.Any(t => t.Tipo == tipoIntegracao);

            return possuiIntegracao;
        }

        public bool ValidacaoConfiguracaoCargaFrete(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.TipoIntegracao repositorioTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);

            List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao> tiposPermitidos = new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao>()
            {
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Unilever,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.UnileverLinkNotas,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Vector
            };

            bool cenarioValido = false;
            foreach (Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao tipoIntegracao in tiposPermitidos)
            {

                if (!CenarioIntegracaoConfigurado(ref carga, unitOfWork, tipoIntegracao))
                    continue;

                cenarioValido = true;
                break;
            }

            return cenarioValido;
        }

        public bool ProcessarIntegracaoCargaFretePendentes(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaFreteIntegracao repositorioCargaFreteIntegracao = new Repositorio.Embarcador.Cargas.CargaFreteIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repositoriCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaFreteIntegracao> cargaIntegracaoPendentes = repositorioCargaFreteIntegracao.ExisteIntegracoesCargaFreteParaEstaCarga(carga.Codigo);
            bool processouCargaIntegracaoPendente = false;

            if (cargaIntegracaoPendentes.Count > 0)
            {
                carga.AguardandoIntegracaoFrete = true;
                processouCargaIntegracaoPendente = true;
                repositoriCarga.Atualizar(carga);
            }

            return processouCargaIntegracaoPendente;
        }

        private void handler(DeliveryReport<Null, string> deliveryReport)
        {
            Repositorio.UnitOfWork unitOfWork = new Repositorio.UnitOfWork(StringConexao);

            Repositorio.Embarcador.Integracao.IntegracaoEMPLog repIntegracaoEMPLog = new Repositorio.Embarcador.Integracao.IntegracaoEMPLog(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoArquivo repositorioConfiguracaoAquivo = new Repositorio.Embarcador.Configuracoes.ConfiguracaoArquivo(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoArquivo configuracaoArquivo = repositorioConfiguracaoAquivo.BuscarPrimeiroRegistro();
            string caminho = Utilidades.IO.FileStorageService.Storage.Combine(configuracaoArquivo.CaminhoArquivosIntegracao, "IntegracaoEMPLog");

            string caminhoArquivoEnvio = Utilidades.IO.FileStorageService.Storage.Combine(caminho, Guid.NewGuid().ToString());
            Utilidades.IO.FileStorageService.Storage.WriteAllText(caminhoArquivoEnvio + ".json", deliveryReport.Message.Value);

            string caminhoArquivoRetorno = Utilidades.IO.FileStorageService.Storage.Combine(caminho, Guid.NewGuid().ToString());
            Utilidades.IO.FileStorageService.Storage.WriteAllText(caminhoArquivoRetorno + ".json", deliveryReport.Value);

            Dominio.Entidades.Embarcador.Integracao.IntegracaoEMPLog integracaoEMPLog = new Dominio.Entidades.Embarcador.Integracao.IntegracaoEMPLog()
            {
                ArquivoEnvio = caminhoArquivoEnvio,
                ArquivoRetorno = caminhoArquivoRetorno,
                DataEnvio = DateTime.Now,
                MensageRetorno = deliveryReport.Error?.Reason,
                StatusIntegracaoEMP = deliveryReport.Status == PersistenceStatus.NotPersisted ? StatusIntegracaoEMP.NotPersisted : deliveryReport.Status == PersistenceStatus.Persisted ? StatusIntegracaoEMP.Persisted : StatusIntegracaoEMP.PossiblyPersisted,
                Topic = deliveryReport.Topic
            };

            repIntegracaoEMPLog.Inserir(integracaoEMPLog);
        }

        public void EmitirDocumentosParciaisNotaPreCheckin(Dominio.Entidades.Embarcador.Cargas.Carga carga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, Repositorio.UnitOfWork unitOfWork)
        {
            //quando pre-chekin vamos replicar as notas da carga filho para a carga pai e assim emitir o CT-e para a carga pai (processo do milkRun emite quando tem notas)
            Servicos.Embarcador.Pedido.NotaFiscal serCargaNotaFiscal = new Servicos.Embarcador.Pedido.NotaFiscal(unitOfWork);
            Servicos.Embarcador.Carga.Carga svcCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);

            Repositorio.Embarcador.Pedidos.StageAgrupamento repStageAgrupamento = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento agrupamentoStageCarga = repStageAgrupamento.BuscarPrimeiroPorCargaGerada(carga.Codigo);

            if (agrupamentoStageCarga == null)
                return;

            Dominio.Entidades.Embarcador.Cargas.Carga cargaPai = agrupamentoStageCarga.CargaDT;

            if (cargaPai != null && cargaPai.TipoOperacao?.TipoConsolidacao == EnumTipoConsolidacao.PreCheckIn)
            {
                if ((cargaPai.SituacaoCarga == SituacaoCarga.PendeciaDocumentos) || ((cargaPai.SituacaoCarga == SituacaoCarga.AgNFe) && (cargaPai.ProcessandoDocumentosFiscais || cargaPai.DataEnvioUltimaNFe.HasValue)))
                    throw new ServicoException("A carga agrupadora de trechos está em processo de emissão. Por favor, aguarde alguns instantes e tente novamente.");

                List<Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento> agupamentosCargas = repStageAgrupamento.BuscarPorCargaDt(cargaPai.Codigo);
                //percorrer carga pedido da pai dos pedidos da filho e validar se tem valor de frete pra esses pedidos, caso negativo devemos abortar a operacao e avisar que outros trechos ainda nao estao calculados

                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidoCarga = repCargaPedido.BuscarPorCarga(carga.Codigo);
                List<int> codigosPedido = cargaPedidoCarga.Select(x => x.Pedido.Codigo).ToList();
                bool cargaFrutifera = cargaPedidoCarga.Any(o => o.StageRelevanteCusto != null);

                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidoCargaPai = repCargaPedido.BuscarPorCargaEPedidos(cargaPai.Codigo, codigosPedido);
                if (cargaPedidoCargaPai.Any(x => x.ValorFrete <= 0))
                    throw new ServicoException("Existem outros trechos dos pedidos da carga que ainda não estão com frete calculado, verifique os demais trechos antes de confirmar a emissao desta carga.");

                //validar se cargas filhos estao com pendencia frete
                if (agupamentosCargas.Any(x => x.CargaGerada?.MotivoPendenciaFrete == MotivoPendenciaFrete.ProblemaCalculoFrete))
                    throw new ServicoException("Existem outros trechos dos pedidos da carga que ainda não estão com frete calculado, verifique os demais trechos antes de confirmar a emissao desta carga.");

                //vamos transferir as notas para a carga pai
                List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> PedidoxMLNotaFiscais = repPedidoXMLNotaFiscal.BuscarPorCarga(carga.Codigo);
                foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedxmlNotaFiscal in PedidoxMLNotaFiscais)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoPai = repCargaPedido.BuscarPorCargaEPedido(cargaPai.Codigo, pedxmlNotaFiscal.CargaPedido.Pedido.Codigo);
                    serCargaNotaFiscal.InformarDadosNotaCarga(pedxmlNotaFiscal.XMLNotaFiscal, cargaPedidoPai, tipoServicoMultisoftware, out string msgAlerta);

                    if (cargaPedidoPai.NotasFiscais?.Count() > 0)//validar se pode ser assim, ou teremos mais de uma nota para o mesmo carga pedido (mas é necessario estar como NFEnviada para emitir cte na pai
                    {
                        cargaPedidoPai.SituacaoEmissao = SituacaoNF.NFEnviada;
                        repCargaPedido.Atualizar(cargaPedidoPai);
                    }
                }

                //essa flag garante que essa carga nao vai avançar emissao ate a carga pai emitir o seu cte. (caso a carga for infrutifera deve avançar)
                if (cargaFrutifera)
                    carga.AguardandoEmissaoDocumentoAnterior = true;

                repCarga.Atualizar(carga);

                unitOfWork.Flush();

                //vamos setar a carga pai para emitir os ctes dos cargapedidos ja com notas. (processo do milRun by Naty)
                cargaPai.ProcessandoDocumentosFiscais = true;
                cargaPai.DataInicioConfirmacaoDocumentosFiscais = DateTime.Now;
                cargaPai.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe;
                cargaPai.PossuiPendencia = false;
                cargaPai.MotivoPendencia = "";
                cargaPai.CargaEmitidaParcialmente = true;

                Log.TratarErro($"CARGA EMITIDA PARCIALMENTE - {cargaPai.Codigo.ToString()} - {cargaPai.CargaEmitidaParcialmente.ObterDescricao()} - {DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff")}");

                repCarga.Atualizar(cargaPai);
            }

        }

        private void SetarCTEEmitidoCargaFilho(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);

            cargaPedido.CTesEmitidos = true;
            repCargaPedido.Atualizar(cargaPedido);

            if (cargaPedido.CargaPedidoProximoTrecho != null)
                SetarCTEEmitidoCargaFilho(cargaPedido.CargaPedidoProximoTrecho, unitOfWork);
        }

        private List<string> SeparaStringAlfanumericaEmLetraseNumeros(string input)
        {
            List<string> partes = new List<string>();

            for (int i = 1; i < input.Length; i++)
            {
                if (Char.IsLetter(input[i - 1]) && Char.IsDigit(input[i]))
                {
                    partes.Add(input.Substring(0, i));
                    partes.Add(input.Substring(i));
                    break;
                }
            }
            return partes;
        }

        private char GetProximaLetra(char letra)
        {
            if (letra == 'Z')
                return 'A';
            else
                return (char)(letra + 1);
        }

        private bool VerificarDadosFrete(bool liberadaComCargaSemPlanejamento, Dominio.Entidades.Embarcador.Cargas.Carga carga, bool possuiMotoristas)
        {
            return (
                        (liberadaComCargaSemPlanejamento || (possuiMotoristas && carga.ModeloVeicularCarga != null && carga.Veiculo != null)) &&
                        (carga.TipoDeCarga != null) &&
                        (!(carga.TipoOperacao?.ExigePlacaTracao ?? false) || (carga.VeiculosVinculados.Count == carga.ModeloVeicularCarga.NumeroReboques))
                    );
        }

        private void GerarIntegracaoBrasilRiskCargaVazia(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Dominio.Entidades.Embarcador.Cargas.TipoIntegracao tipoIntegracao = repTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.BrasilRiskSML);
            if (tipoIntegracao == null)
                return;

            Repositorio.Embarcador.Cargas.CargaDadosTransporteIntegracao repCargaDadosTransporteIntegracao = new Repositorio.Embarcador.Cargas.CargaDadosTransporteIntegracao(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.CargaDadosTransporteIntegracao cargaDadosTransporteIntegracao = repCargaDadosTransporteIntegracao.BuscarPorCargaETipoIntegracao(carga.Codigo, tipoIntegracao.Codigo, false);

            if (cargaDadosTransporteIntegracao == null)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaDadosTransporteIntegracao cargaIntegracao = new Dominio.Entidades.Embarcador.Cargas.CargaDadosTransporteIntegracao();

                cargaIntegracao.Carga = carga;
                cargaIntegracao.DataIntegracao = DateTime.Now;
                cargaIntegracao.NumeroTentativas = 0;
                cargaIntegracao.ProblemaIntegracao = "";
                cargaIntegracao.SituacaoIntegracao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoIntegracao.AgIntegracao;
                cargaIntegracao.TipoIntegracao = tipoIntegracao;

                repCargaDadosTransporteIntegracao.Inserir(cargaIntegracao);
            }
            else
            {
                cargaDadosTransporteIntegracao.SituacaoIntegracao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoIntegracao.AgIntegracao;
                repCargaDadosTransporteIntegracao.Atualizar(cargaDadosTransporteIntegracao);
            }
        }

        public void EnviarEmailNotificacaoAutomaticamenteTransportadorDaCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado)
        {
            try
            {
                if (carga.Empresa == null)
                    return;

                if (carga.Pedidos == null || carga.Pedidos.Count == 0 || !carga.Pedidos.ToList().TrueForAll(cp => cp.Pedido.DataAgendamento != null && cp.Pedido.DataeHoraEnvioEmailNotificacaoAgendamentoTransportador == null))
                    return;

                Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoAgendamentoColeta configuracaoAgendamentoColeta = new Repositorio.Embarcador.Configuracoes.ConfiguracaoAgendamentoColeta(unitOfWork).BuscarPrimeiroRegistro();
                if (!(configuracaoAgendamentoColeta?.EnviarEmailDeNotificacaoAutomaticamenteAoTransportadorDaCarga ?? false) || configuracaoAgendamentoColeta.ModeloEmail == null)
                    return;

                Servicos.Embarcador.Logistica.AgendamentoEntregaPedido servicoAgendamentoEntregaPedido = new Servicos.Embarcador.Logistica.AgendamentoEntregaPedido(unitOfWork, auditado);

                Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoModeloEmail modeloEmail = configuracaoAgendamentoColeta.ModeloEmail;
                List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos = carga.Pedidos.Select(cp => cp.Pedido).ToList();
                List<string> emailTransportador = new List<string>() { carga.Empresa.Email };
                List<string> emails = new List<string>();
                foreach (var email in emailTransportador)
                {
                    if (email.Contains(";"))
                        emails.AddRange(email.Split(';'));
                    else
                        emails.Add(email);
                }
                List<Dominio.ObjetosDeValor.Email.Mensagem> mensagens = new();

                string corpoEmailAgendamento = servicoAgendamentoEntregaPedido.BuscarCorpoEmailPorModelo(pedidos, modeloEmail, new List<Dominio.Entidades.Embarcador.Cargas.Carga>() { carga }, unitOfWork);

                mensagens.Add(new Dominio.ObjetosDeValor.Email.Mensagem()
                {
                    Destinatarios = emails,
                    Assunto = !string.IsNullOrEmpty(modeloEmail?.Assunto) ? modeloEmail.Assunto : $"Notificação de Agendamento - Carga {carga.CodigoCargaEmbarcador}",
                    Corpo = corpoEmailAgendamento
                });

                Servicos.Email.EnviarMensagensAsync(mensagens, unitOfWork);

                servicoAgendamentoEntregaPedido.GravarDataEnvioEmailNotificacaoTransportador(pedidos, DateTime.Now, unitOfWork, auditado);
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro(ex);
            }
        }

        private Dominio.Entidades.Veiculo BuscaVeiculoMDFECarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, out string erro, UnitOfWork unitOfWork)
        {
            Repositorio.ReboqueMDFe repReboqueMDFE = new Repositorio.ReboqueMDFe(unitOfWork);
            Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unitOfWork);
            erro = "";

            foreach (string placaMDFE in repReboqueMDFE.BuscarPlacasPorCarga(carga.Codigo))
            {
                if (!(carga.Veiculo?.Placa.Equals(placaMDFE) ?? false))
                {
                    Dominio.Entidades.Veiculo veiculoMDFE = repVeiculo.BuscarPorPlaca(placaMDFE);
                    if (veiculoMDFE == null)
                    {
                        erro += $"Veículo {placaMDFE} do MDFE não está cadastrado no sistema";
                    }
                    else
                    {
                        return veiculoMDFE;
                    }

                }
            }
            return null;
        }

        public void AvancarEtapaGestaoDevolucao(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, AdminMultisoftware.Dominio.Entidades.Pessoas.Cliente clienteMultisoftware)
        {
            AvancarEtapaGestaoDevolucao(carga, _unitOfWork, auditado, clienteMultisoftware);
        }

        private void AvancarEtapaGestaoDevolucao(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, AdminMultisoftware.Dominio.Entidades.Pessoas.Cliente clienteMultisoftware)
        {
            if (!IsDadosTransporteinformados(carga, unitOfWork))
                return;

            Dominio.Entidades.Embarcador.Devolucao.GestaoDevolucao gestaoDevolucao = new Repositorio.Embarcador.Devolucao.GestaoDevolucao(unitOfWork).BuscarPorCodigoCarga(carga.Codigo);
            if (gestaoDevolucao != null && gestaoDevolucao.EtapaAtual.Etapa == EtapaGestaoDevolucao.GeracaoCargaDevolucao)
                new Servicos.Embarcador.GestaoDevolucao.GestaoDevolucao(unitOfWork, auditado, clienteMultisoftware).AvancarEtapaGestaoDevolucao(gestaoDevolucao, "Finalizado ao salvar dados transporte.");
        }

        private void GerarAtendimentoDivergenciaValorFreteCTeEmitidoEmbarcador(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoAtendimentoAutomatico repConfiguracaoAtendimentoAutomatico = new Repositorio.Embarcador.Configuracoes.ConfiguracaoAtendimentoAutomatico(unitOfWork);
            Repositorio.Embarcador.Chamados.MotivoChamado repositorioChamado = new Repositorio.Embarcador.Chamados.MotivoChamado(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = repConfiguracaoTMS.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoAtendimentoAutomatico configuracaoAtendimentoAutomatico = repConfiguracaoAtendimentoAutomatico.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Chamados.MotivoChamado motivoChamado;

            if (configuracaoTMS.AvisarDivergenciaValoresCTeEmitidoEmbarcador && configuracaoAtendimentoAutomatico.GerarAtendimentoDivergenciaValorTabelaCTeEmitidoEmbarcador)
            {

                if (carga.Pedidos.Any(o => o.CTeEmitidoNoEmbarcador) && carga.ValorFreteTabelaFrete > carga.ValorFreteAPagar)
                {
                    motivoChamado = repositorioChamado.BuscarPorCodigo(configuracaoAtendimentoAutomatico.MotivoChamado.Codigo);
                    decimal valorDiferencaCTeXTabelaFrete = (carga.ValorFreteTabelaFrete - carga.ValorFreteAPagar);

                    Dominio.ObjetosDeValor.Embarcador.Chamado.ObjetoChamado objetoChamado = new Dominio.ObjetosDeValor.Embarcador.Chamado.ObjetoChamado()
                    {
                        MotivoChamado = motivoChamado,
                        Carga = carga,
                        Empresa = carga.Empresa,
                        Cliente = carga.Pedidos?.FirstOrDefault()?.Pedido?.Remetente,
                        Valor = valorDiferencaCTeXTabelaFrete,
                        TipoCliente = configuracaoTMS.ChamadoOcorrenciaUsaRemetente ? Dominio.Enumeradores.TipoTomador.Remetente : Dominio.Enumeradores.TipoTomador.Destinatario
                    };

                    Dominio.Entidades.Usuario usuario = carga.Motoristas.FirstOrDefault();

                    if (usuario == null)
                        return;

                    Dominio.Entidades.Embarcador.Chamados.Chamado chamado = Servicos.Embarcador.Chamado.Chamado.AbrirChamado(objetoChamado, usuario, 0, null, unitOfWork);
                }
            }

        }
        #endregion Métodos Privados

        #region Métodos Privados Duplicar Carga

        private void AtualizarDadosCargaRecebimentoNFe(Dominio.Entidades.Embarcador.Cargas.Carga carga, TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao, Repositorio.UnitOfWork unitOfWork)
        {
            if (carga == null)
                return;

            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);

            Servicos.Embarcador.Carga.CargaLocaisPrestacao serCargaLocaisPrestacao = new Servicos.Embarcador.Carga.CargaLocaisPrestacao(unitOfWork);
            Servicos.Embarcador.Carga.CargaDadosSumarizados serCargaDadosSumarizados = new Servicos.Embarcador.Carga.CargaDadosSumarizados(unitOfWork);
            Servicos.Embarcador.Carga.Rota serRota = new Servicos.Embarcador.Carga.Rota(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidosCarga = repCargaPedido.BuscarPorCarga(carga.Codigo);
            Servicos.Embarcador.Carga.CargaPedido serCargaPedido = new Servicos.Embarcador.Carga.CargaPedido(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoPedido configuracaoPedido = new Repositorio.Embarcador.Configuracoes.ConfiguracaoPedido(unitOfWork).BuscarConfiguracaoPadrao();

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidosCarga)
            {
                decimal peso = 0m;
                decimal pesoLiquido = 0m;

                serCargaPedido.AdicionarCargaPedidoQuantidades(cargaPedido, null, null, tipoServicoMultisoftware, configuracao, ref peso, ref pesoLiquido, configuracao.NaoAtualizarPesoPedidoPelaNFe, unitOfWork);

                cargaPedido.Pedido.PesoTotal = peso;

                if (pesoLiquido > 0m)
                    cargaPedido.Pedido.PesoLiquidoTotal = pesoLiquido;
                else
                    cargaPedido.Pedido.PesoLiquidoTotal = peso;

                repPedido.Atualizar(cargaPedido.Pedido);
                repCargaPedido.Atualizar(cargaPedido);
            }

            AtualizarProdutosPorNota(carga, cargaPedidosCarga, unitOfWork, null);

            Servicos.Embarcador.Carga.RotaFrete.SetarRotaFreteCarga(carga, cargaPedidosCarga, configuracao, unitOfWork, tipoServicoMultisoftware);

            serRota.DeletarPercursoDestinosCarga(carga, unitOfWork);
            serCargaLocaisPrestacao.VerificarEAjustarLocaisPrestacao(carga, cargaPedidosCarga, unitOfWork, tipoServicoMultisoftware, configuracaoPedido);
            serCargaDadosSumarizados.AlterarDadosSumarizadosCarga(ref carga, cargaPedidosCarga, configuracao, unitOfWork, tipoServicoMultisoftware);
        }

        public void AtualizarProdutosPorNota(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado)
        {
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscalProduto repXMLNotaFiscalProduto = new Repositorio.Embarcador.Pedidos.XMLNotaFiscalProduto(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoProduto repCargaPedidoProduto = new Repositorio.Embarcador.Cargas.CargaPedidoProduto(unitOfWork);

            Servicos.Embarcador.Pedido.Produto serProduto = new Servicos.Embarcador.Pedido.Produto(unitOfWork);

            if (!(carga.TipoOperacao?.AtualizarProdutosPorXmlNotaFiscal ?? false))
                return;

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> pedidosXmlNotaFiscalCarga = repPedidoXMLNotaFiscal.BuscarPorCarga(carga.Codigo);
            if (pedidosXmlNotaFiscalCarga.Count == 0)
                return;

            List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscalProduto> xmlNotaFiscalProdutosCarga = repXMLNotaFiscalProduto.BuscarPorCarga(carga);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoProduto> cargaPedidosProdutosCarga = repCargaPedidoProduto.BuscarPorCarga(carga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
            {
                List<Dominio.ObjetosDeValor.Embarcador.NFe.Produtos> produtos = new List<Dominio.ObjetosDeValor.Embarcador.NFe.Produtos>();
                List<int> xmlNotasFiscais = (from obj in pedidosXmlNotaFiscalCarga where obj.CargaPedido.Codigo == cargaPedido.Codigo select obj.XMLNotaFiscal.Codigo).ToList();

                List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscalProduto> xMLNotaFiscalProdutos = xmlNotaFiscalProdutosCarga.Where(o => xmlNotasFiscais.Contains(o.XMLNotaFiscal.Codigo)).ToList();

                foreach (Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscalProduto produtoNotaFiscal in xMLNotaFiscalProdutos)
                {
                    Dominio.ObjetosDeValor.Embarcador.NFe.Produtos produto = (from obj in produtos where obj.Codigo == produtoNotaFiscal.Produto.CodigoProdutoEmbarcador select obj).FirstOrDefault();

                    decimal quantidade = produtoNotaFiscal.QuantidadeUtilizar;

                    if (produto == null)
                    {
                        produto = new Dominio.ObjetosDeValor.Embarcador.NFe.Produtos
                        {
                            Descricao = produtoNotaFiscal.Produto.Descricao,
                            Codigo = produtoNotaFiscal.Produto.CodigoProdutoEmbarcador,
                            QuantidadeComercial = quantidade,
                            ValorUnitarioComercial = produtoNotaFiscal.ValorProduto
                        };

                        produtos.Add(produto);
                    }
                    else
                    {
                        produto.QuantidadeComercial += quantidade;
                        produto.ValorUnitarioComercial += produtoNotaFiscal.ValorProduto;
                    }
                }

                serProduto.AtualizarProdutosCargaPedidoPorNotaFiscal(produtos, cargaPedido, unitOfWork, auditado, cargaPedidosProdutosCarga);
            }
        }

        private bool AtualizarPedidosRecebimentoNFe(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao, TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {
            if (!carga?.TipoOperacao?.GerarPedidoNoRecebientoNFe ?? true)
                return false;

            if (carga.Pedidos.Count > 1)
                return false;

            if (!carga.Pedidos.FirstOrDefault().Pedido.DestinatarioNaoInformado)
                return false;

            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalParcial repositorioCargaPedidoXMLNotaFiscalParcial = new Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalParcial(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoEndereco repPedidoEndereco = new Repositorio.Embarcador.Pedidos.PedidoEndereco(unitOfWork);
            List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> pedidosXMLNotaFiscal = repPedidoXMLNotaFiscal.BuscarPorCarga(carga.Codigo);
            List<int> numerosParciais = repositorioCargaPedidoXMLNotaFiscalParcial.BuscarNumerosPorCarga(carga.Codigo);

            Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal primeiroPedidoXMLNotaFiscal = pedidosXMLNotaFiscal.FirstOrDefault();

            Dominio.Entidades.Embarcador.Pedidos.Pedido primeiroPedido;
            primeiroPedido = primeiroPedidoXMLNotaFiscal.CargaPedido.Pedido;
            primeiroPedido.Destinatario = primeiroPedidoXMLNotaFiscal?.XMLNotaFiscal?.Destinatario;
            primeiroPedido.Destino = primeiroPedidoXMLNotaFiscal?.XMLNotaFiscal?.Destinatario?.Localidade;

            Dominio.Entidades.Embarcador.Cargas.CargaPedido primeiraCargaPedido = null;
            primeiraCargaPedido = primeiroPedidoXMLNotaFiscal.CargaPedido;
            primeiraCargaPedido.Destino = primeiroPedidoXMLNotaFiscal?.XMLNotaFiscal?.Destinatario?.Localidade;

            Servicos.WebService.Carga.Pedido serWSPedido = new WebService.Carga.Pedido(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.CargaPedido primeiraCargaPedidoColeta = repCargaPedido.BuscarCargasPedidoDeColetaPorPedidos(new List<int> { primeiroPedido.Codigo }).FirstOrDefault();

            List<Dominio.ObjetosDeValor.Embarcador.Pedido.PedidoParaDuplicacao> listaDados = new List<Dominio.ObjetosDeValor.Embarcador.Pedido.PedidoParaDuplicacao>();

            //ordena de acordo com os números parciais, para criar os pedidos na ordem que a Danone importou no pedido original
            if (numerosParciais.Count > 0 && numerosParciais.Count == pedidosXMLNotaFiscal.Count)
                pedidosXMLNotaFiscal = pedidosXMLNotaFiscal.OrderBy(o => numerosParciais.IndexOf(o.XMLNotaFiscal.Numero)).ToList();

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscal in pedidosXMLNotaFiscal)
            {
                if (primeiroPedidoXMLNotaFiscal.Codigo == pedidoXMLNotaFiscal.Codigo)
                    continue;

                if (pedidoXMLNotaFiscal.CargaPedido.Codigo != primeiraCargaPedido.Codigo)
                    continue;

                Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido = pedidoXMLNotaFiscal.CargaPedido.Clonar();
                Utilidades.Object.DefinirListasGenericasComoNulas(cargaPedido);


                Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoColeta = null;
                if (primeiraCargaPedidoColeta != null)
                {
                    cargaPedidoColeta = primeiraCargaPedidoColeta.Clonar();
                    Utilidades.Object.DefinirListasGenericasComoNulas(cargaPedidoColeta);
                }

                Dominio.Entidades.Embarcador.Pedidos.Pedido pedido = pedidoXMLNotaFiscal.CargaPedido.Pedido.Clonar();
                Utilidades.Object.DefinirListasGenericasComoNulas(pedido);

                Dominio.ObjetosDeValor.Embarcador.Pedido.PedidoParaDuplicacao pedidoParaDuplicacao = new Dominio.ObjetosDeValor.Embarcador.Pedido.PedidoParaDuplicacao()
                {
                    Pedido = pedido,
                    CargaPedido = cargaPedido,
                    CargaPedidoColeta = cargaPedidoColeta,
                    PedidoNotaFiscal = pedidoXMLNotaFiscal,
                    Destinatario = pedidoXMLNotaFiscal?.XMLNotaFiscal?.Destinatario,
                    Destino = pedidoXMLNotaFiscal?.XMLNotaFiscal?.Destinatario?.Localidade
                };

                listaDados.Add(pedidoParaDuplicacao);
            }

            Dominio.Entidades.Cliente primeiroDestinatario = primeiroPedidoXMLNotaFiscal?.XMLNotaFiscal?.Destinatario;
            string numeroPedido = primeiroPedido.NumeroPedidoEmbarcador;

            Dominio.Entidades.Embarcador.Pedidos.PedidoEndereco primeiroPedidoEndereco = new Dominio.Entidades.Embarcador.Pedidos.PedidoEndereco();
            serWSPedido.PreecherEnderecoPedidoPorCliente(primeiroPedidoEndereco, primeiroDestinatario);
            repPedidoEndereco.Inserir(primeiroPedidoEndereco);

            primeiroPedido.NumeroPedidoEmbarcador = numeroPedido + "_1";
            primeiroPedido.EnderecoDestino = primeiroPedidoEndereco;
            repPedido.Atualizar(primeiroPedido);


            if (primeiraCargaPedido != null)
                repCargaPedido.Atualizar(primeiraCargaPedido);

            List<double> listaDestinatarios = (from obj in listaDados where obj.Destinatario?.CPF_CNPJ != primeiroDestinatario?.CPF_CNPJ select obj.Destinatario.CPF_CNPJ).Distinct().ToList();
            int seq = 2;

            foreach (double codigoDestinatario in listaDestinatarios)
            {
                List<PedidoParaDuplicacao> infoPedido = listaDados.Where(o => o.Destinatario.CPF_CNPJ == codigoDestinatario).ToList();
                PedidoParaDuplicacao dadosDestinatario = infoPedido.FirstOrDefault();

                Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoDestinatario = dadosDestinatario.Pedido;
                Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoDestinatario = dadosDestinatario.CargaPedido;
                Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoDestinatarioColeta = dadosDestinatario.CargaPedidoColeta;

                pedidoDestinatario.NumeroPedidoEmbarcador = numeroPedido + "_" + seq.ToString();
                seq++;

                Dominio.Entidades.Embarcador.Pedidos.PedidoEndereco pedidoEndereco = new Dominio.Entidades.Embarcador.Pedidos.PedidoEndereco();
                serWSPedido.PreecherEnderecoPedidoPorCliente(pedidoEndereco, dadosDestinatario?.PedidoNotaFiscal?.XMLNotaFiscal?.Destinatario);

                repPedidoEndereco.Inserir(pedidoEndereco);

                pedidoDestinatario.Destinatario = dadosDestinatario.Destinatario;
                pedidoDestinatario.Destino = dadosDestinatario.Destino;
                pedidoDestinatario.EnderecoDestino = pedidoEndereco;
                pedidoDestinatario.SituacaoAcompanhamentoPedido = SituacaoAcompanhamentoPedido.AgColeta;

                repPedido.Inserir(pedidoDestinatario);


                cargaPedidoDestinatario.Carga = carga;
                cargaPedidoDestinatario.Pedido = pedidoDestinatario;
                cargaPedidoDestinatario.Destino = dadosDestinatario.Destino;

                repCargaPedido.Inserir(cargaPedidoDestinatario);


                if (cargaPedidoDestinatarioColeta != null)
                {
                    cargaPedidoDestinatarioColeta.Pedido = pedidoDestinatario;

                    if (cargaPedidoDestinatarioColeta.Recebedor == null)
                        cargaPedidoDestinatarioColeta.Destino = dadosDestinatario.Destino;

                    repCargaPedido.Inserir(cargaPedidoDestinatarioColeta);
                }

                foreach (PedidoParaDuplicacao dado in infoPedido)
                {
                    dado.PedidoNotaFiscal.CargaPedido = dadosDestinatario.CargaPedido;
                    repPedidoXMLNotaFiscal.Atualizar(dado.PedidoNotaFiscal);
                }
            }


            AtualizarDadosCargaRecebimentoNFe(carga, tipoServicoMultisoftware, configuracao, unitOfWork);

            if (primeiraCargaPedidoColeta != null)
                AtualizarDadosCargaRecebimentoNFe(primeiraCargaPedidoColeta?.Carga, tipoServicoMultisoftware, configuracao, unitOfWork);

            return true;
        }

        private void DuplicarIntegracaoValePedagio(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio repCargaIntegracaoValePedagio = new Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio> cargaIntegracoesValePedagioAntigo = repCargaIntegracaoValePedagio.BuscarPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio cargaIntegracaoValePedagioAntigo in cargaIntegracoesValePedagioAntigo)
            {
                Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio cargaIntegracaoValePedagioNovo = cargaIntegracaoValePedagioAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaIntegracaoValePedagioNovo);

                cargaIntegracaoValePedagioNovo.Carga = cargaNova;
                cargaIntegracaoValePedagioNovo.SituacaoIntegracao = SituacaoIntegracao.AgIntegracao;
                cargaIntegracaoValePedagioNovo.SituacaoValePedagio = SituacaoValePedagio.Pendete;
                cargaIntegracaoValePedagioNovo.ProblemaIntegracao = "";
                cargaIntegracaoValePedagioNovo.DataIntegracao = DateTime.Now;
                cargaIntegracaoValePedagioNovo.NumeroTentativas = 0;

                repCargaIntegracaoValePedagio.Inserir(cargaIntegracaoValePedagioNovo);

                DuplicarRotasIntegracaoValePedagio(cargaIntegracaoValePedagioNovo, cargaIntegracaoValePedagioAntigo, unitOfWork);
            }
        }

        private void DuplicarRotasIntegracaoValePedagio(Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio cargaIntegracaoValePedagioNovo, Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio cargaIntegracaoValePedagioAntigo, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.ValePedagio.CargaValePedagioRota repCargaValePedagioRota = new Repositorio.Embarcador.Cargas.ValePedagio.CargaValePedagioRota(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaValePedagioRota> rotasIntegracaoValePedagio = repCargaValePedagioRota.BuscarPorCargaValePedagio(cargaIntegracaoValePedagioAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaValePedagioRota rotaAntiga in rotasIntegracaoValePedagio)
            {
                Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaValePedagioRota rotaNova = rotaAntiga.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(rotaNova);

                rotaNova.CargaValePedagio = cargaIntegracaoValePedagioNovo;

                repCargaValePedagioRota.Inserir(rotaNova);
            }
        }

        private void DuplicarContratoFrete(Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Terceiros.ContratoFrete repContratoFrete = new Repositorio.Embarcador.Terceiros.ContratoFrete(unitOfWork);

            Dominio.Entidades.Embarcador.Terceiros.ContratoFrete contratoFreteAntigo = repContratoFrete.BuscarPorCarga(cargaAntiga.Codigo);

            if (contratoFreteAntigo != null)
            {
                Dominio.Entidades.Embarcador.Terceiros.ContratoFrete contratoFreteNovo = contratoFreteAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(contratoFreteNovo);

                contratoFreteNovo.SituacaoContratoFrete = SituacaoContratoFrete.Aberto;
                contratoFreteNovo.Carga = cargaNova;

                if (configuracaoTMS.ObterNovaNumeracaoAoDuplicarContratoFreteTerceiro)
                {
                    contratoFreteNovo.NumeroContrato = repContratoFrete.BuscarProximoCodigo();
                }
                else
                    contratoFreteNovo.NumeroControle = repContratoFrete.ContarPorNumeroContrato(contratoFreteNovo.NumeroContrato);

                repContratoFrete.Inserir(contratoFreteNovo);

                DuplicarValoresContratoFrete(contratoFreteNovo, contratoFreteAntigo, unitOfWork);
            }
        }

        private void DuplicarValoresContratoFrete(Dominio.Entidades.Embarcador.Terceiros.ContratoFrete contratoFreteNovo, Dominio.Entidades.Embarcador.Terceiros.ContratoFrete contratoFreteAntigo, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Terceiros.ContratoFreteValor repContratoFreteValor = new Repositorio.Embarcador.Terceiros.ContratoFreteValor(unitOfWork);

            List<Dominio.Entidades.Embarcador.Terceiros.ContratoFreteValor> valores = repContratoFreteValor.BuscarPorContratoFrete(contratoFreteAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Terceiros.ContratoFreteValor valorAntigo in valores)
            {
                Dominio.Entidades.Embarcador.Terceiros.ContratoFreteValor valorNovo = valorAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(valorNovo);

                valorNovo.ContratoFrete = contratoFreteNovo;

                repContratoFreteValor.Inserir(valorNovo);
            }
        }

        private void AdicionarSaldoContratoPrestacaoServico(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Servicos.Embarcador.Frete.ContratoPrestacaoServicoSaldo servicoSaldo = new Servicos.Embarcador.Frete.ContratoPrestacaoServicoSaldo(unitOfWork);

            if (servicoSaldo.IsUtilizaContratoPrestacaoServico())
            {
                Embarcador.Carga.Carga servicoCarga = new Embarcador.Carga.Carga(unitOfWork);

                Dominio.ObjetosDeValor.Embarcador.Frete.ContratoPrestacaoServicoSaldoDados dados = new Dominio.ObjetosDeValor.Embarcador.Frete.ContratoPrestacaoServicoSaldoDados()
                {
                    CodigoFilial = carga.Filial?.Codigo ?? 0,
                    CodigoTransportador = carga.Empresa?.Codigo ?? 0,
                    Descricao = $"Saldo referente a carga {servicoCarga.ObterNumeroCarga(carga, unitOfWork)}",
                    TipoLancamento = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoLancamento.Automatico,
                    TipoMovimentacao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoMovimentacaoContratoPrestacaoServico.Saida,
                    Valor = carga.ValorFrete + carga.ValorFreteContratoFreteTotal
                };

                servicoSaldo.AdicionarSemValidacao(dados);
            }
        }

        private void DuplicarCargaIntegracaoNatura(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo, List<Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoNatura> cargaIntegracoesNaturaAntigo, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaIntegracaoNatura repCargaIntegracaoNatura = new Repositorio.Embarcador.Cargas.CargaIntegracaoNatura(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoNatura> cargaPedidoIntegracoesNatura = cargaIntegracoesNaturaAntigo.FindAll(o => o.CargaPedido.Codigo == cargaPedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoNatura cargaIntegracaoNaturaAntigo in cargaPedidoIntegracoesNatura)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoNatura cargaIntegracaoNaturaNova = cargaIntegracaoNaturaAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaIntegracaoNaturaNova);

                cargaIntegracaoNaturaNova.Carga = cargaPedidoNovo.Carga;
                cargaIntegracaoNaturaNova.CargaPedido = cargaPedidoNovo;

                repCargaIntegracaoNatura.Inserir(cargaIntegracaoNaturaNova);
            }
        }

        private void DuplicarCargaIntegracaoAvon(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaIntegracaoAvon repCargaIntegracaoAvon = new Repositorio.Embarcador.Cargas.CargaIntegracaoAvon(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoAvon cargaIntegracaoAvonAntiga = repCargaIntegracaoAvon.BuscarPorCarga(cargaAntiga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoMinutaAvon.Sucesso);

            if (cargaIntegracaoAvonAntiga != null)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaIntegracaoAvon cargaIntegracaoAvonNova = cargaIntegracaoAvonAntiga.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaIntegracaoAvonNova);

                cargaIntegracaoAvonNova.Carga = cargaNova;

                repCargaIntegracaoAvon.Inserir(cargaIntegracaoAvonNova);
            }
        }

        private void DuplicarCargaMotorista(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaMotorista repCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> cargaMotoristas = repCargaMotorista.BuscarPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaMotorista cargaMotoristaAntigo in cargaMotoristas)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaMotorista cargaMotoristaNovo = cargaMotoristaAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaMotoristaNovo);

                cargaMotoristaNovo.Carga = cargaNova;

                repCargaMotorista.Inserir(cargaMotoristaNovo);
            }
        }

        private void DuplicarCargaComponenteFrete(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaComponentesFrete repCargaComponenteFrete = new Repositorio.Embarcador.Cargas.CargaComponentesFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaComplementoFrete repCargaComplementoFrete = new Repositorio.Embarcador.Cargas.CargaComplementoFrete(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaComponentesFrete> cargaComponentesFrete = repCargaComponenteFrete.BuscarTodosPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaComponentesFrete cargaComponenteFreteAntigo in cargaComponentesFrete)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaComponentesFrete cargaComponenteFreteNovo = cargaComponenteFreteAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaComponenteFreteNovo);

                if (cargaComponenteFreteAntigo.CargaComplementoFrete != null)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaComplementoFrete cargaComplementoFreteNovo = cargaComponenteFreteAntigo.CargaComplementoFrete.Clonar();

                    Utilidades.Object.DefinirListasGenericasComoNulas(cargaComplementoFreteNovo);

                    cargaComplementoFreteNovo.Carga = cargaNova;
                    cargaComplementoFreteNovo.SolicitacaoCredito = DuplicarSolicitacaoCredito(cargaComponenteFreteAntigo.CargaComplementoFrete.SolicitacaoCredito, cargaNova, unitOfWork);

                    repCargaComplementoFrete.Inserir(cargaComplementoFreteNovo);

                    cargaComponenteFreteNovo.CargaComplementoFrete = cargaComplementoFreteNovo;
                }

                cargaComponenteFreteNovo.Carga = cargaNova;

                repCargaComponenteFrete.Inserir(cargaComponenteFreteNovo);
            }
        }

        private void DuplicarCargaComplementoFrete(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaComplementoFrete repCargaComplementoFrete = new Repositorio.Embarcador.Cargas.CargaComplementoFrete(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaComplementoFrete> cargaComplementosFrete = repCargaComplementoFrete.BuscarPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaComplementoFrete cargaComplementoFreteAntigo in cargaComplementosFrete)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaComplementoFrete cargaComplementoFreteNovo = cargaComplementoFreteAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaComplementoFreteNovo);

                cargaComplementoFreteNovo.Carga = cargaNova;
                cargaComplementoFreteNovo.SolicitacaoCredito = DuplicarSolicitacaoCredito(cargaComplementoFreteAntigo.SolicitacaoCredito, cargaNova, unitOfWork);

                repCargaComplementoFrete.Inserir(cargaComplementoFreteNovo);
            }
        }

        private Dominio.Entidades.Embarcador.Creditos.SolicitacaoCredito DuplicarSolicitacaoCredito(Dominio.Entidades.Embarcador.Creditos.SolicitacaoCredito solicitacaoCreditoAntiga, Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Repositorio.UnitOfWork unitOfWork)
        {
            if (solicitacaoCreditoAntiga == null)
                return null;

            Repositorio.Embarcador.Creditos.SolicitacaoCredito repSolicitacaoCredito = new Repositorio.Embarcador.Creditos.SolicitacaoCredito(unitOfWork);

            Dominio.Entidades.Embarcador.Creditos.SolicitacaoCredito solicitacaoCreditoNova = solicitacaoCreditoAntiga.Clonar();

            Utilidades.Object.DefinirListasGenericasComoNulas(solicitacaoCreditoNova);

            solicitacaoCreditoNova.Carga = cargaNova;

            repSolicitacaoCredito.Inserir(solicitacaoCreditoNova);

            return solicitacaoCreditoNova;
        }

        private void DuplicarCargaLocaisPrestacao(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaLocaisPrestacao repCargaLocalPrestacao = new Repositorio.Embarcador.Cargas.CargaLocaisPrestacao(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacao> cargaLocaisPrestacao = repCargaLocalPrestacao.BuscarPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacao cargaLocalPrestacaoAntigo in cargaLocaisPrestacao)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacao cargaLocalPrestacaoNovo = cargaLocalPrestacaoAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaLocalPrestacaoNovo);

                cargaLocalPrestacaoNovo.Carga = cargaNova;

                repCargaLocalPrestacao.Inserir(cargaLocalPrestacaoNovo);

                DuplicarCargaLocalPrestacaoPassagem(cargaLocalPrestacaoNovo, cargaLocalPrestacaoAntigo, unitOfWork);
            }
        }

        private void DuplicarCargaLocalPrestacaoPassagem(Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacao cargaLocalPrestacaoNovo, Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacao cargaLocalPrestacaoAntigo, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaLocaisPrestacaoPassagens repCargaLocalPrestacaoPassagem = new Repositorio.Embarcador.Cargas.CargaLocaisPrestacaoPassagens(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacaoPassagens> passagens = repCargaLocalPrestacaoPassagem.BuscarPorLocalPrestacao(cargaLocalPrestacaoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacaoPassagens passagemAntiga in passagens)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaLocaisPrestacaoPassagens passagemNova = passagemAntiga.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(passagemNova);

                passagemNova.CargaLocaisPrestacao = cargaLocalPrestacaoNovo;

                repCargaLocalPrestacaoPassagem.Inserir(passagemNova);
            }
        }

        private void DuplicarCargaTabelaFreteSubcontratacao(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaTabelaFreteSubContratacao repCargaTabelaFreteSubcontratacao = new Repositorio.Embarcador.Cargas.CargaTabelaFreteSubContratacao(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteSubContratacao cargaTabelaFreteSubContratacaoAntiga = repCargaTabelaFreteSubcontratacao.BuscarPorCarga(cargaAntiga.Codigo);

            if (cargaTabelaFreteSubContratacaoAntiga != null)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteSubContratacao cargaTabelaFreteSubcontratacaoNova = cargaTabelaFreteSubContratacaoAntiga.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaTabelaFreteSubcontratacaoNova);

                cargaTabelaFreteSubcontratacaoNova.Carga = cargaNova;

                repCargaTabelaFreteSubcontratacao.Inserir(cargaTabelaFreteSubcontratacaoNova);
            }
        }

        private void DuplicarCargaTabelaFreteRota(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaTabelaFreteRota repCargaTabelaFreteRota = new Repositorio.Embarcador.Cargas.CargaTabelaFreteRota(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteRota> cargaTabelasFreteRotas = repCargaTabelaFreteRota.BuscarPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteRota cargaTabelaFreteRotaAntiga in cargaTabelasFreteRotas)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteRota cargaTabelaFreteRotaNova = cargaTabelaFreteRotaAntiga.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaTabelaFreteRotaNova);

                cargaTabelaFreteRotaNova.Carga = cargaNova;

                repCargaTabelaFreteRota.Inserir(cargaTabelaFreteRotaNova);
            }
        }

        private void DuplicarCargaTabelaFreteCliente(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaTabelaFreteCliente repCargaTabelaFreteCliente = new Repositorio.Embarcador.Cargas.CargaTabelaFreteCliente(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteCliente> cargaTabelasFreteClientes = repCargaTabelaFreteCliente.BuscarPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteCliente cargaTabelaFreteClienteAntiga in cargaTabelasFreteClientes)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaTabelaFreteCliente cargaTabelaFreteClienteNova = cargaTabelaFreteClienteAntiga.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaTabelaFreteClienteNova);

                cargaTabelaFreteClienteNova.Carga = cargaNova;

                repCargaTabelaFreteCliente.Inserir(cargaTabelaFreteClienteNova);
            }
        }

        private void DuplicarCargaIntegracao(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaIntegracao repCargaIntegracao = new Repositorio.Embarcador.Cargas.CargaIntegracao(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaIntegracao> cargaIntegracoes = repCargaIntegracao.BuscarPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaIntegracao cargaIntegracao in cargaIntegracoes)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaIntegracao cargaIntegracaoNova = cargaIntegracao.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaIntegracaoNova);

                cargaIntegracaoNova.Carga = cargaNova;
                repCargaIntegracao.Inserir(cargaIntegracaoNova);

            }
        }

        private void AlterarMonitoramento(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Logistica.Monitoramento repMonitoramento = new Repositorio.Embarcador.Logistica.Monitoramento(unitOfWork);

            List<Dominio.Entidades.Embarcador.Logistica.Monitoramento> monitoramentos = repMonitoramento.BuscarTodosPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Logistica.Monitoramento monitoramento in monitoramentos)
            {
                monitoramento.Carga = cargaNova;

                repMonitoramento.Atualizar(monitoramento);
            }
        }

        private void AlterarAlertaMonitor(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Logistica.AlertaMonitor repAlertaMonitor = new Repositorio.Embarcador.Logistica.AlertaMonitor(unitOfWork);
            Repositorio.Embarcador.TorreControle.AlertaAcompanhamentoCarga repAlertasAcompanhamentoCarga = new Repositorio.Embarcador.TorreControle.AlertaAcompanhamentoCarga(unitOfWork);

            List<Dominio.Entidades.Embarcador.Logistica.AlertaMonitor> alertas = repAlertaMonitor.BuscarPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Logistica.AlertaMonitor alerta in alertas)
            {
                alerta.Carga = cargaNova;

                repAlertaMonitor.Atualizar(alerta);
            }

            List<Dominio.Entidades.Embarcador.TorreControle.AlertasAcompanhamentoCarga> alertasAcompanhamentoCarga = repAlertasAcompanhamentoCarga.BuscarPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.TorreControle.AlertasAcompanhamentoCarga alertaAcompanhamentoCarga in alertasAcompanhamentoCarga)
            {
                alertaAcompanhamentoCarga.Carga = cargaNova;

                repAlertasAcompanhamentoCarga.Atualizar(alertaAcompanhamentoCarga);
            }
        }

        private void AlterarCargaEntrega(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntrega repCargaEntrega = new Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntrega(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntrega> cargaEntregas = repCargaEntrega.BuscarPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntrega cargaEntrega in cargaEntregas)
            {
                cargaEntrega.Carga = cargaNova;

                repCargaEntrega.Atualizar(cargaEntrega);
            }
        }

        private void AlterarCargaEntregaPedido(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo, List<Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntregaPedido> cargaEntregaPedidos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntregaPedido repCargaEntregaPedido = new Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntregaPedido(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntregaPedido cargaEntregaPedido = cargaEntregaPedidos.Find(o => o.CargaPedido.Codigo == cargaPedidoAntigo.Codigo);

            if (cargaEntregaPedido != null)
            {
                cargaEntregaPedido.CargaPedido = cargaPedidoNovo;

                repCargaEntregaPedido.Atualizar(cargaEntregaPedido);
            }
        }

        private void AlterarCargaEntregaNotaFiscal(Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscalNovo, Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscalAntigo, List<Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntregaNotaFiscal> cargaEntregasNotasFiscaisAntigas, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntregaNotaFiscal repCargaEntregaNotaFiscal = new Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntregaNotaFiscal(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntregaNotaFiscal cargaEntregaNotaFiscal = cargaEntregasNotasFiscaisAntigas.Find(o => o.PedidoXMLNotaFiscal.Codigo == pedidoXMLNotaFiscalAntigo.Codigo);

            if (cargaEntregaNotaFiscal != null)
            {
                cargaEntregaNotaFiscal.PedidoXMLNotaFiscal = pedidoXMLNotaFiscalNovo;

                repCargaEntregaNotaFiscal.Atualizar(cargaEntregaNotaFiscal);
            }
        }

        private void DuplicarCargaPedidos(Dominio.Entidades.Embarcador.Cargas.CargaCancelamento cargaCancelamento, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado)
        {
            Servicos.Log.TratarErro("1 - Carga (" + cargaNova.CodigoCargaEmbarcador + ") " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "DuplicarCargaPedidos");

            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.Carga> cargasOriginais = new List<Dominio.Entidades.Embarcador.Cargas.Carga>();
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCargaDuplicarCargaPedidos(cargaAntiga.Codigo);

            bool possuiPedidoTransbordo = cargaPedidos.Exists(x => x.Pedido.PedidoTransbordo);
            bool possuiNaoCTeEmitidoNoEmbarcador = cargaPedidos.Exists(x => !x.CTeEmitidoNoEmbarcador);

            Dominio.ObjetosDeValor.Embarcador.Carga.Cancelamento.ParametrosDuplicarCargaPedido parametrosDuplicarCargaPedido = ObterParametrosDuplicarCargaPedido(cargaAntiga.Codigo, cargaNova.Codigo, possuiPedidoTransbordo, possuiNaoCTeEmitidoNoEmbarcador, cargaCancelamento, tipoServicoMultisoftware, configuracaoTMS, unitOfWork);
            Dominio.ObjetosDeValor.Embarcador.Carga.Cancelamento.ParametrosDuplicarPedido parametrosDuplicarPedido = ObterParametrosDuplicarPedido(cargaAntiga.Codigo, unitOfWork);

            cargaPedidos = cargaPedidos.OrderBy(x => x.OrdemEntrega).ThenBy(z => z.OrdemColeta).ToList();

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo in cargaPedidos)
            {
                cargaPedidoAntigo.Pedido.ControleNumeracao = cargaPedidoAntigo.Pedido.Codigo;

                Servicos.Log.TratarErro("cargaPedidoAntigo.Pedido.ControleNumeracao: " + cargaPedidoAntigo.Pedido.ControleNumeracao.ToString());

                repPedido.SetarControleNumeracaoPorPedido(cargaPedidoAntigo.Pedido.Codigo);

                Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo = cargaPedidoAntigo.Clonar(false);

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaPedidoNovo);

                cargaPedidoNovo.CTesEmitidos = false;
                cargaPedidoNovo.CTesFilialEmissoraEmitidos = false;
                cargaPedidoNovo.PedidoSemNFe = false;

                Dominio.Entidades.Embarcador.Cargas.Carga cargaOrigem = null;
                if (cargaAntiga.CargaAgrupada)
                {
                    cargaOrigem = (from obj in cargasOriginais where obj.Protocolo == cargaPedidoAntigo.CargaOrigem.Protocolo select obj).FirstOrDefault();
                    if (cargaOrigem == null)
                    {
                        cargaOrigem = GerarCargaDuplicada(cargaPedidoAntigo.CargaOrigem, cargaCancelamento, cargaPedidoAntigo.CargaOrigem.SituacaoCarga, cargaNova, true, unitOfWork, tipoServicoMultisoftware);
                        cargasOriginais.Add(cargaOrigem);
                    }
                }
                else
                    cargaOrigem = cargaNova;

                cargaPedidoNovo.Carga = cargaNova;
                cargaPedidoNovo.CargaOrigem = cargaOrigem;
                cargaPedidoNovo.Pedido = DuplicarPedido(cargaPedidoAntigo.Pedido, parametrosDuplicarPedido, unitOfWork, auditado);
                cargaPedidoNovo.OrdemEntrega = cargaPedidoAntigo.OrdemEntrega;

                if (cargaPedidoNovo.OrdemEntrega > 0 && (cargaNova.TipoOperacao?.ManterOrdemAoRoteirizarAgendaEntrega ?? false))
                    cargaNova.OrdemRoteirizacaoDefinida = true;

                if (cargaCancelamento.CancelarDocumentosEmitidosNoEmbarcador && cargaPedidoNovo.SituacaoEmissao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoNF.NFEnviada)
                {
                    cargaPedidoNovo.SituacaoEmissao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoNF.AgEnvioNF;
                    cargaPedidoNovo.CienciaDoEnvioDaNotaInformado = false;
                }

                repCargaPedido.Inserir(cargaPedidoNovo);

                cargaPedidoNovo.Pedido.PedidoDePreCarga = cargaAntiga.CargaDePreCargaFechada || cargaAntiga.CargaDePreCargaEmFechamento;
                cargaPedidoAntigo.Pedido.Protocolo = 0;

                repPedido.Atualizar(cargaPedidoNovo.Pedido);
                repPedido.Atualizar(cargaPedidoAntigo.Pedido);

                AlterarCargaEntregaPedido(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido.CargaEntregasPedidosAntigas, unitOfWork);

                DuplicarCargaIntegracaoNatura(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido.CargaIntegracoesNaturaAntiga, unitOfWork);
                DuplicarApoliceSeguroCargaPedido(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido.ApolicesSegurosAntigas, unitOfWork);
                DuplicarCargaPedidoRotaFrete(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido.CargaPedidoRotasFreteAntigas, unitOfWork);
                DuplicarCargaPedidoComponenteFrete(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido.CargaPedidoComponentesFreteAntigos, unitOfWork);
                DuplicarCargaPedidoProduto(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido.CargaPedidoProdutosAntigos, unitOfWork);
                DuplicarCargaPedidoQuantidade(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido.CargaPedidoQuantidadesAntigos, unitOfWork);
                DuplicarCargaPedidoRota(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido.CargaPedidoRotasAntigas, unitOfWork);
                DuplicarCargaPedidoEspelhoIntercement(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido.PedidosEspelhosAntigos, unitOfWork);

                AjustarDevolucoesPallets(cargaPedidoNovo, cargaPedidoAntigo, unitOfWork, tipoServicoMultisoftware);

                Servicos.Log.TratarErro("2 - Carga (" + cargaNova.CodigoCargaEmbarcador + ") " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "DuplicarCargaPedidos");

                DuplicarDocumentosCargaPedido(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido, cargaCancelamento, cargaNova, configuracaoTMS, tipoServicoMultisoftware, unitOfWork);
            }
        }

        private void LiberarPedidosParaMontagemCarga(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado)
        {
            Servicos.Log.TratarErro("1 - Carga (" + cargaNova.CodigoCargaEmbarcador + ") " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff") + " - LiberarParaMontagem", "DuplicarCargaPedidos");

            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoComponentesFrete repCargaPedidoComponentesFrete = new Repositorio.Embarcador.Cargas.CargaPedidoComponentesFrete(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoComponenteFrete repPedidoComponenteFrete = new Repositorio.Embarcador.Pedidos.PedidoComponenteFrete(unitOfWork);

            Dominio.ObjetosDeValor.Embarcador.Carga.Cancelamento.ParametrosDuplicarPedido parametrosDuplicarPedido = ObterParametrosDuplicarPedido(cargaAntiga.Codigo, unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(cargaAntiga.Codigo);

            cargaPedidos = cargaPedidos.OrderBy(x => x.OrdemEntrega).ThenBy(z => z.OrdemColeta).ToList();

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo in cargaPedidos)
            {
                cargaPedidoAntigo.Pedido.ControleNumeracao = cargaPedidoAntigo.Pedido.Codigo;

                Servicos.Log.TratarErro("cargaPedidoAntigo.Pedido.ControleNumeracao: " + cargaPedidoAntigo.Pedido.ControleNumeracao.ToString());

                repPedido.SetarControleNumeracaoPorPedido(cargaPedidoAntigo.Pedido.Codigo);

                Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoNovo = DuplicarPedido(cargaPedidoAntigo.Pedido, parametrosDuplicarPedido, unitOfWork, auditado);

                Utilidades.Object.DefinirListasGenericasComoNulas(pedidoNovo);

                cargaPedidoAntigo.Pedido.Protocolo = 0;
                cargaPedidoAntigo.Pedido.SituacaoPedido = SituacaoPedido.Cancelado;

                pedidoNovo.GerarAutomaticamenteCargaDoPedido = false;
                pedidoNovo.PedidoTotalmenteCarregado = false;
                pedidoNovo.PedidoRedespachoTotalmenteCarregado = false;

                //TODO: PPC - Adicionado log temporário para identificar problema de retorno de saldo de pedido.
                Servicos.Log.TratarErro($"Pedido {pedidoNovo.NumeroPedidoEmbarcador} - Liberou saldo pedido {pedidoNovo.PesoSaldoRestante} - Peso Total.: {pedidoNovo.PesoTotal} - Totalmente carregado.: {pedidoNovo.PedidoTotalmenteCarregado}. Carga.DuplicarCargaPedidos", "SaldoPedido");

                if (pedidoNovo.ValorTaxaFeeder > 0)
                {
                    pedidoNovo.ValorFreteNegociado = pedidoNovo.ValorTaxaFeeder > 0 ? (pedidoNovo.ValorFreteNegociado / pedidoNovo.ValorTaxaFeeder) : pedidoNovo.ValorFreteNegociado;

                    List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete> cargaPedidoComponentesFretes = repCargaPedidoComponentesFrete.BuscarPorPedido(pedidoNovo.Codigo);
                    foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete componente in cargaPedidoComponentesFretes)
                    {
                        componente.ValorComponente = pedidoNovo.ValorTaxaFeeder > 0 ? (componente.ValorComponente / pedidoNovo.ValorTaxaFeeder) : componente.ValorComponente;
                        repCargaPedidoComponentesFrete.Atualizar(componente);
                    }
                    List<Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete> pedidoComponenteFretes = repPedidoComponenteFrete.BuscarPorPedido(pedidoNovo.Codigo);
                    foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete componente in pedidoComponenteFretes)
                    {
                        componente.ValorComponente = pedidoNovo.ValorTaxaFeeder > 0 ? (componente.ValorComponente / pedidoNovo.ValorTaxaFeeder) : componente.ValorComponente;
                        repPedidoComponenteFrete.Atualizar(componente);
                    }

                    if (!string.IsNullOrWhiteSpace(pedidoNovo.ObservacaoCTe) && pedidoNovo.ObservacaoCTe.Contains("Conversão de valor em dólar:") && pedidoNovo.ObservacaoCTe.Contains("//"))
                    {
                        int posInicial = pedidoNovo.ObservacaoCTe.IndexOf("Conversão de valor em dólar:");
                        int posFinal = pedidoNovo.ObservacaoCTe.IndexOf("//") + 1;
                        if ((posFinal - posInicial) > 0 && posInicial > (posFinal - posInicial))
                            pedidoNovo.ObservacaoCTe = pedidoNovo.ObservacaoCTe.Remove(posInicial, posFinal - posInicial);
                    }

                    pedidoNovo.ValorTaxaFeeder = 0;
                }

                repPedido.Atualizar(pedidoNovo);
                repPedido.Atualizar(cargaPedidoAntigo.Pedido);
            }
        }

        private void AjustarDevolucoesPallets(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            if (tipoServicoMultisoftware != TipoServicoMultisoftware.MultiTMS)
                return;

            Repositorio.Embarcador.Pallets.DevolucaoPallet repDevolucaoPallets = new Repositorio.Embarcador.Pallets.DevolucaoPallet(unitOfWork);
            Repositorio.Embarcador.Pallets.DevolucaoPalletAnexo repositorioDevolucaoPalletAnexo = new Repositorio.Embarcador.Pallets.DevolucaoPalletAnexo(unitOfWork);
            Repositorio.Embarcador.Pallets.EstoquePallet repEstoquePallets = new Repositorio.Embarcador.Pallets.EstoquePallet(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pallets.DevolucaoPallet> devolucoes = repDevolucaoPallets.BuscarPorCargaPedido(cargaPedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pallets.DevolucaoPallet devolucao in devolucoes)
            {
                List<Dominio.Entidades.Embarcador.Pallets.EstoquePallet> estoquePallets = repEstoquePallets.BuscarPorDevolucao(devolucao.Codigo);

                foreach (Dominio.Entidades.Embarcador.Pallets.EstoquePallet estoque in estoquePallets)
                    repEstoquePallets.Deletar(estoque);

                List<Dominio.Entidades.Embarcador.Pallets.DevolucaoPalletAnexo> anexos = repositorioDevolucaoPalletAnexo.BuscarPorDevolucao(devolucao.Codigo);
                foreach (Dominio.Entidades.Embarcador.Pallets.DevolucaoPalletAnexo anexo in anexos)
                    repositorioDevolucaoPalletAnexo.Deletar(anexo);

                repDevolucaoPallets.Deletar(devolucao);
            }
        }

        private void DuplicarCargaPedidoRota(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo, List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoRotas> cargaPedidoRotasAntigas, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedidoRotas repCargaPedidoRota = new Repositorio.Embarcador.Cargas.CargaPedidoRotas(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoRotas> cargaPedidoRotas = cargaPedidoRotasAntigas.FindAll(o => o.CargaPedido.Codigo == cargaPedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoRotas cargaPedidoRotaAntiga in cargaPedidoRotas)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaPedidoRotas cargaPedidoRotaNova = cargaPedidoRotaAntiga.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaPedidoRotaNova);

                cargaPedidoRotaNova.CargaPedido = cargaPedidoNovo;

                repCargaPedidoRota.Inserir(cargaPedidoRotaNova);
            }
        }

        private void DuplicarCargaPedidoEspelhoIntercement(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo, List<Dominio.Entidades.Embarcador.Pedidos.PedidoEspelhoIntercement> pedidosEspelhosAntigos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.PedidoEspelhoIntercement repPedidoEspelhoIntercement = new Repositorio.Embarcador.Pedidos.PedidoEspelhoIntercement(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoEspelhoIntercement> pedidoEspelho = pedidosEspelhosAntigos.FindAll(o => o.CargaPedido.Codigo == cargaPedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoEspelhoIntercement espelho in pedidoEspelho)
            {
                Dominio.Entidades.Embarcador.Pedidos.PedidoEspelhoIntercement espelhoNovo = espelho.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(espelhoNovo);

                espelhoNovo.CargaPedido = cargaPedidoNovo;

                repPedidoEspelhoIntercement.Inserir(espelhoNovo);
            }
        }

        private void DuplicarCargaPedidoQuantidade(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo, List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoQuantidades> cargaPedidoQuantidadesAntigos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedidoQuantidades repCargaPedidoQuantidade = new Repositorio.Embarcador.Cargas.CargaPedidoQuantidades(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoQuantidades> cargaPedidoQuantidades = cargaPedidoQuantidadesAntigos.FindAll(o => o.CargaPedido.Codigo == cargaPedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoQuantidades cargaPedidoQuantidadeAntigo in cargaPedidoQuantidades)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaPedidoQuantidades cargaPedidoQuantidadeNovo = cargaPedidoQuantidadeAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaPedidoQuantidadeNovo);

                cargaPedidoQuantidadeNovo.CargaPedido = cargaPedidoNovo;

                repCargaPedidoQuantidade.Inserir(cargaPedidoQuantidadeNovo);
            }
        }

        private void DuplicarCargaPedidoProduto(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo, List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoProduto> cargaPedidoProdutosAntigos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedidoProduto repCargaPedidoProduto = new Repositorio.Embarcador.Cargas.CargaPedidoProduto(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoProduto> cargaPedidoProdutos = cargaPedidoProdutosAntigos.FindAll(o => o.CargaPedido.Codigo == cargaPedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoProduto cargaPedidoProdutoAntigo in cargaPedidoProdutos)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaPedidoProduto cargaPedidoProdutoNovo = cargaPedidoProdutoAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaPedidoProdutoNovo);

                cargaPedidoProdutoNovo.CargaPedido = cargaPedidoNovo;

                repCargaPedidoProduto.Inserir(cargaPedidoProdutoNovo);
            }
        }

        private void DuplicarCargaPedidoComponenteFrete(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo, List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete> cargaPedidoComponentesFreteAntigos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedidoComponentesFrete repCargaPedidoComponenteFrete = new Repositorio.Embarcador.Cargas.CargaPedidoComponentesFrete(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete> cargaPedidoComponentesFrete = cargaPedidoComponentesFreteAntigos.FindAll(o => o.CargaPedido.Codigo == cargaPedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete cargaPedidoComponenteFreteAntigo in cargaPedidoComponentesFrete)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaPedidoComponentesFrete cargaPedidoComponenteFreteNovo = cargaPedidoComponenteFreteAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaPedidoComponenteFreteNovo);

                cargaPedidoComponenteFreteNovo.CargaPedido = cargaPedidoNovo;

                repCargaPedidoComponenteFrete.Inserir(cargaPedidoComponenteFreteNovo);
            }
        }

        private void DuplicarCargaPedidoRotaFrete(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo, List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoRotaFrete> cargaPedidoRotasFreteAntigas, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedidoRotaFrete repCargaPedidoRotaFrete = new Repositorio.Embarcador.Cargas.CargaPedidoRotaFrete(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoRotaFrete> cargaPedidoRotasFrete = cargaPedidoRotasFreteAntigas.FindAll(o => o.CargaPedido.Codigo == cargaPedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoRotaFrete cargaPedidoRotaFreteAntiga in cargaPedidoRotasFrete)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaPedidoRotaFrete cargaPedidoRotaFreteNova = cargaPedidoRotaFreteAntiga.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaPedidoRotaFreteNova);

                cargaPedidoRotaFreteNova.CargaPedido = cargaPedidoNovo;

                repCargaPedidoRotaFrete.Inserir(cargaPedidoRotaFreteNova);
            }
        }

        private void DuplicarCargaPedidoDocumentoMDFe(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo, List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoMDFe> cargaPedidoDocumentoMDFesAntigos, Repositorio.UnitOfWork unitOfWork)
        {
            if (cargaPedidoNovo.Pedido.PedidoTransbordo)
                return;

            Repositorio.Embarcador.Cargas.CargaPedidoDocumentoMDFe repCargaPedidoDocumentoMDFe = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoMDFe(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoMDFe> cargaPedidoDocumentoMDFes = cargaPedidoDocumentoMDFesAntigos.FindAll(o => o.CargaPedido.Codigo == cargaPedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoMDFe cargaPedidoDocumentoMDFeAntigo in cargaPedidoDocumentoMDFes)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoMDFe cargaPedidoDocumentoMDFeNovo = cargaPedidoDocumentoMDFeAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaPedidoDocumentoMDFeNovo);

                cargaPedidoDocumentoMDFeNovo.CargaPedido = cargaPedidoNovo;

                repCargaPedidoDocumentoMDFe.Inserir(cargaPedidoDocumentoMDFeNovo);
            }
        }

        private void DuplicarCargaPedidoDocumentoCTe(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo, Dominio.ObjetosDeValor.Embarcador.Carga.Cancelamento.ParametrosDuplicarCargaPedido parametrosDuplicarCargaPedido, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe repCargaPedidoDocumentoCTe = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe(unitOfWork);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new ConhecimentoDeTransporteEletronico(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe> cargaPedidoDocumentoCTes = parametrosDuplicarCargaPedido.CargaPedidoDocumentoCTesAntigos.FindAll(o => o.CargaPedido.Codigo == cargaPedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe cargaPedidoDocumentoCTeAntigo in cargaPedidoDocumentoCTes)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe cargaPedidoDocumentoCTeNovo = cargaPedidoDocumentoCTeAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaPedidoDocumentoCTeNovo);

                cargaPedidoDocumentoCTeNovo.CargaPedido = cargaPedidoNovo;

                repCargaPedidoDocumentoCTe.Inserir(cargaPedidoDocumentoCTeNovo);

                if (!cargaPedidoNovo.Pedido.PedidoTransbordo)
                {
                    if (cargaPedidoDocumentoCTeNovo.CTe.XMLNotaFiscais != null)
                    {
                        cargaPedidoDocumentoCTeNovo.CTe.XMLNotaFiscais.Clear();

                        repCTe.Atualizar(cargaPedidoDocumentoCTeNovo.CTe);
                    }

                    DuplicarCargaPedidoDocumentoCTeComponenteFrete(cargaPedidoDocumentoCTeNovo, cargaPedidoDocumentoCTeAntigo, parametrosDuplicarCargaPedido.CargaPedidoDocumentoCTeComponentesFreteAntigos, unitOfWork);
                }
            }
        }

        private void DuplicarCargaPedidoDocumentoCTeComponenteFrete(Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe cargaPedidoDocumentoCTeNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe cargaPedidoDocumentoCTeAntigo, List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTeComponenteFrete> cargaPedidoDocumentoCTeComponentesFreteAntigos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTeComponenteFrete repCargaPedidoDocumentoCTeComponenteFrete = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTeComponenteFrete(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTeComponenteFrete> cargaPedidoDocumentoCTeComponentesFrete = repCargaPedidoDocumentoCTeComponenteFrete.BuscarPorCargaPedidoDocumentoCTe(cargaPedidoDocumentoCTeAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTeComponenteFrete cargaPedidoDocumentoCTeComponenteFreteAntigo in cargaPedidoDocumentoCTeComponentesFrete)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTeComponenteFrete cargaPedidoDocumentoCTeComponenteFreteNovo = cargaPedidoDocumentoCTeComponenteFreteAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaPedidoDocumentoCTeComponenteFreteNovo);

                cargaPedidoDocumentoCTeComponenteFreteNovo.CargaPedidoDocumentoCTe = cargaPedidoDocumentoCTeNovo;

                repCargaPedidoDocumentoCTeComponenteFrete.Inserir(cargaPedidoDocumentoCTeComponenteFreteNovo);
            }
        }

        private void DuplicarPedidoCTeParaSubcontratacao(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo, Dominio.ObjetosDeValor.Embarcador.Carga.Cancelamento.ParametrosDuplicarCargaPedido parametrosDuplicarCargaPedido, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            Servicos.Embarcador.Canhotos.Canhoto svcCanhoto = new Canhotos.Canhoto(unitOfWork);

            Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao repPedidoCTeParaSubcontratacao = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacaoPedidoNotaFiscal repPedidoCTeParaSubContratacaoPedidoNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacaoPedidoNotaFiscal(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao> pedidoCTesParaSubcontratacao = parametrosDuplicarCargaPedido.PedidoCTesParaSubcontratacaoAntigos.FindAll(o => o.CargaPedido.Codigo == cargaPedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao pedidoCTeParaSubcontratacaoAntigo in pedidoCTesParaSubcontratacao)
            {
                Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao pedidoCTeParaSubcontratacaoNovo = pedidoCTeParaSubcontratacaoAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(pedidoCTeParaSubcontratacaoNovo);

                pedidoCTeParaSubcontratacaoNovo.CargaPedido = cargaPedidoNovo;

                repPedidoCTeParaSubcontratacao.Inserir(pedidoCTeParaSubcontratacaoNovo);

                List<Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacaoPedidoNotaFiscal> notasFiscais = parametrosDuplicarCargaPedido.PedidoCTeParaSubContratacaoPedidoNotaFiscalAntigos.FindAll(o => o.PedidoCTeParaSubContratacao.Codigo == pedidoCTeParaSubcontratacaoAntigo.Codigo);

                foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacaoPedidoNotaFiscal notaFiscal in notasFiscais)
                {
                    Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscal = parametrosDuplicarCargaPedido.PedidosXMLNotasFiscaisNovas.Find(o => o.XMLNotaFiscal.Codigo == notaFiscal.PedidoXMLNotaFiscal.XMLNotaFiscal.Codigo && o.CargaPedido.Codigo == cargaPedidoNovo.Codigo);

                    if (pedidoXMLNotaFiscal != null)
                    {
                        Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacaoPedidoNotaFiscal notaFiscalNova = new Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacaoPedidoNotaFiscal()
                        {
                            PedidoCTeParaSubContratacao = pedidoCTeParaSubcontratacaoNovo,
                            PedidoXMLNotaFiscal = pedidoXMLNotaFiscal
                        };

                        repPedidoCTeParaSubContratacaoPedidoNotaFiscal.Inserir(notaFiscalNova);
                    }
                }

                DuplicarPedidoCTeParaSubcontratacaoComponenteFrete(pedidoCTeParaSubcontratacaoNovo, pedidoCTeParaSubcontratacaoAntigo, parametrosDuplicarCargaPedido.PedidoCteParaSubContratacaoComponenteFretesAntigos, unitOfWork);

                svcCanhoto.SalvarCanhotoCTe(pedidoCTeParaSubcontratacaoNovo.CTeTerceiro, cargaPedidoNovo, cargaPedidoNovo.Carga.Terceiro, parametrosDuplicarCargaPedido.Motoristas, tipoServicoMultisoftware, unitOfWork);
            }
        }

        private void DuplicarPedidoCTeParaSubcontratacaoComponenteFrete(Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao pedidoCTeParaSubcontratacaoNovo, Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao pedidoCTeParaSubcontratacaoAntigo, List<Dominio.Entidades.Embarcador.Pedidos.PedidoCteParaSubContratacaoComponenteFrete> pedidoSubContratacaoComponentesAntigos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.PedidoCteParaSubContratacaoComponenteFrete repPedidoCteParaSubContratacaoComponenteFrete = new Repositorio.Embarcador.Pedidos.PedidoCteParaSubContratacaoComponenteFrete(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoCteParaSubContratacaoComponenteFrete> componentesAntigos = pedidoSubContratacaoComponentesAntigos.FindAll(o => o.PedidoCTeParaSubContratacao.Codigo == pedidoCTeParaSubcontratacaoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoCteParaSubContratacaoComponenteFrete componenteAntigo in componentesAntigos)
            {
                Dominio.Entidades.Embarcador.Pedidos.PedidoCteParaSubContratacaoComponenteFrete componenteNovo = componenteAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(componenteNovo);

                componenteNovo.PedidoCTeParaSubContratacao = pedidoCTeParaSubcontratacaoNovo;

                repPedidoCteParaSubContratacaoComponenteFrete.Inserir(componenteNovo);
            }
        }

        private void DuplicarPedidoXMLNotaFiscal(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo, Dominio.ObjetosDeValor.Embarcador.Carga.Cancelamento.ParametrosDuplicarCargaPedido parametrosDuplicarCargaPedido, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            Servicos.Embarcador.Canhotos.Canhoto svcCanhoto = new Canhotos.Canhoto(unitOfWork);

            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> pedidoXMLNotasFiscais = parametrosDuplicarCargaPedido.PedidosXMLNotasFiscaisAntigas.FindAll(o => o.CargaPedido.Codigo == cargaPedidoAntigo.Codigo);

            if (SempreDuplicarCargaCancelada(tipoServicoMultisoftware, configuracaoTMS))
            {
                foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscalAntiga in pedidoXMLNotasFiscais)
                {
                    Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscalNovo = pedidoXMLNotaFiscalAntiga.Clonar();

                    Utilidades.Object.DefinirListasGenericasComoNulas(pedidoXMLNotaFiscalNovo);

                    pedidoXMLNotaFiscalNovo.CargaPedido = cargaPedidoNovo;

                    repPedidoXMLNotaFiscal.Inserir(pedidoXMLNotaFiscalNovo);

                    if (parametrosDuplicarCargaPedido.PedidosXMLNotasFiscaisNovas == null)
                        parametrosDuplicarCargaPedido.PedidosXMLNotasFiscaisNovas = new List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal>();

                    parametrosDuplicarCargaPedido.PedidosXMLNotasFiscaisNovas.Add(pedidoXMLNotaFiscalNovo);

                    AlterarCargaEntregaNotaFiscal(pedidoXMLNotaFiscalNovo, pedidoXMLNotaFiscalAntiga, parametrosDuplicarCargaPedido.CargaEntregasNotasFiscaisAntigas, unitOfWork);

                    DuplicarPedidoXMLNotaFiscalComponenteFrete(pedidoXMLNotaFiscalNovo, pedidoXMLNotaFiscalAntiga, parametrosDuplicarCargaPedido.PedidosXMLsComponenteAntigos, unitOfWork);

                    Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoCanhoto configuracaoCanhoto = new Repositorio.Embarcador.Configuracoes.ConfiguracaoCanhoto(unitOfWork).BuscarConfiguracaoPadrao();
                    svcCanhoto.SalvarCanhotoNota(pedidoXMLNotaFiscalNovo.XMLNotaFiscal, cargaPedidoNovo, cargaPedidoNovo.Carga.Terceiro, parametrosDuplicarCargaPedido.Motoristas, tipoServicoMultisoftware, configuracaoTMS, unitOfWork, configuracaoCanhoto, "", tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS);
                }
            }
            else if (cargaPedidoNovo.SituacaoEmissao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoNF.NFEnviada)
            {
                cargaPedidoNovo.SituacaoEmissao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoNF.AgEnvioNF;
                cargaPedidoNovo.CienciaDoEnvioDaNotaInformado = false;
                repCargaPedido.Inserir(cargaPedidoNovo);
            }
        }

        private void DuplicarPedidoXMLNotaFiscalComponenteFrete(Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscalNovo, Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscalAntigo, List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscalComponenteFrete> pedidosXMLsComponenteAntigos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscalComponenteFrete repPedidoXMLNotaFiscalComponenteFrete = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscalComponenteFrete(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscalComponenteFrete> componentesAntigos = pedidosXMLsComponenteAntigos.FindAll(o => o.PedidoXMLNotaFiscal.Codigo == pedidoXMLNotaFiscalAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscalComponenteFrete componenteAntigo in componentesAntigos)
            {
                Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscalComponenteFrete componenteNovo = componenteAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(componenteNovo);

                componenteNovo.PedidoXMLNotaFiscal = pedidoXMLNotaFiscalNovo;

                repPedidoXMLNotaFiscalComponenteFrete.Inserir(componenteNovo);
            }
        }

        private void DuplicarApoliceSeguroCargaPedido(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo, List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao> apolicesSegurosAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repApoliceSeguroAverbacao = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);

            List<Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao> apolicesSeguros = apolicesSegurosAntiga.FindAll(o => o.CargaPedido.Codigo == cargaPedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao apoliceSeguroAntiga in apolicesSeguros)
            {
                Dominio.Entidades.Embarcador.Seguros.ApoliceSeguroAverbacao apoliceSeguroNova = apoliceSeguroAntiga.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(apoliceSeguroNova);

                apoliceSeguroNova.SeguroFilialEmissora = apoliceSeguroAntiga.SeguroFilialEmissora;
                apoliceSeguroNova.CargaPedido = cargaPedidoNovo;

                repApoliceSeguroAverbacao.Inserir(apoliceSeguroNova);
            }
        }

        private void DuplicarDocumentosCargaPedido(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoNovo, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedidoAntigo, Dominio.ObjetosDeValor.Embarcador.Carga.Cancelamento.ParametrosDuplicarCargaPedido parametrosDuplicarCargaPedido, Dominio.Entidades.Embarcador.Cargas.CargaCancelamento cargaCancelamento, Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {
            if (!cargaPedidoAntigo.Pedido.PedidoTransbordo)
            {
                if (!cargaPedidoAntigo.CTeEmitidoNoEmbarcador)
                {
                    Servicos.Log.TratarErro("3 - Carga (" + cargaNova.CodigoCargaEmbarcador + ") " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "DuplicarCargaPedidos");
                    DuplicarPedidoXMLNotaFiscal(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido, configuracaoTMS, unitOfWork, tipoServicoMultisoftware);
                    DuplicarPedidoCTeParaSubcontratacao(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido, unitOfWork, tipoServicoMultisoftware);
                }
                else
                {
                    if (!cargaCancelamento.CancelarDocumentosEmitidosNoEmbarcador) //se cancela os documentos emitidos no embarcador, a nova carga deve ficar sem vinculo dos mesmos (pois estão na carga antiga)
                    {
                        DuplicarPedidoXMLNotaFiscal(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido, configuracaoTMS, unitOfWork, tipoServicoMultisoftware);
                        DuplicarCargaPedidoDocumentoMDFe(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido.CargaPedidoDocumentoMDFesAntigos, unitOfWork);
                        DuplicarCargaPedidoDocumentoCTe(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido, unitOfWork);
                    }
                }
            }
            else
            {
                Servicos.Log.TratarErro("4 - Carga (" + cargaNova.CodigoCargaEmbarcador + ") " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "DuplicarCargaPedidos");
                //if (cargaPedidoAntigo.CTeEmitidoNoEmbarcador)
                //{
                DuplicarCargaPedidoDocumentoCTe(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido, unitOfWork);
                DuplicarPedidoXMLNotaFiscal(cargaPedidoNovo, cargaPedidoAntigo, parametrosDuplicarCargaPedido, configuracaoTMS, unitOfWork, tipoServicoMultisoftware);
                //}
            }
        }

        private Dominio.Entidades.Embarcador.Pedidos.Pedido DuplicarPedido(Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoAntigo, Dominio.ObjetosDeValor.Embarcador.Carga.Cancelamento.ParametrosDuplicarPedido parametrosDuplicarPedido, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado)
        {
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.WMS.MontagemContainer repMontagemContainer = new Repositorio.Embarcador.WMS.MontagemContainer(unitOfWork);

            pedidoAntigo.SituacaoPedido = SituacaoPedido.Cancelado;
            repPedido.Atualizar(pedidoAntigo);

            Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoNovo = pedidoAntigo.Clonar();

            Utilidades.Object.DefinirListasGenericasComoNulas(pedidoNovo);

            pedidoNovo.SituacaoPedido = SituacaoPedido.Aberto;
            pedidoNovo.Veiculos = pedidoAntigo.Veiculos.ToList();
            pedidoNovo.Motoristas = pedidoAntigo.Motoristas.ToList();
            pedidoNovo.NotasFiscais = pedidoAntigo.NotasFiscais.ToList();
            pedidoNovo.SituacaoAcompanhamentoPedido = SituacaoAcompanhamentoPedido.AgColeta;
            pedidoNovo.ControleNumeracao = 0;
            if (pedidoNovo.MontagemContainer != null)
            {
                pedidoAntigo.MontagemContainer.Status = StatusMontagemContainer.Finalizado;
                repMontagemContainer.Atualizar(pedidoAntigo.MontagemContainer);
                pedidoNovo.MontagemContainer = null;
            }

            Servicos.Log.TratarErro("pedidoNovo.ControleNumeracao: " + pedidoNovo.ControleNumeracao.ToString());

            repPedido.Inserir(pedidoNovo);

            DuplicarImportacoesPedido(pedidoNovo, pedidoAntigo, parametrosDuplicarPedido.PedidoImportacoesAntigos, unitOfWork);
            DuplicarProdutosPedido(pedidoNovo, pedidoAntigo, parametrosDuplicarPedido, unitOfWork);
            DuplicarTransbordoPedido(pedidoNovo, pedidoAntigo, parametrosDuplicarPedido.PedidoTransbordosAntigos, unitOfWork);
            DuplicarComponentePedido(pedidoNovo, pedidoAntigo, parametrosDuplicarPedido.PedidoComponentesFreteAntigos, unitOfWork);
            DuplicarAutorizacoesPedido(pedidoNovo, pedidoAntigo, parametrosDuplicarPedido.PedidoAutorizacoesAntigos, unitOfWork);
            DuplicarAnexoPedido(pedidoNovo, pedidoAntigo, parametrosDuplicarPedido.PedidoAnexosAntigos, unitOfWork, auditado);
            DuplicarAdicionalPedido(pedidoNovo, pedidoAntigo, parametrosDuplicarPedido.PedidoAdicionalAntigos, unitOfWork, auditado);

            return pedidoNovo;
        }

        private void DuplicarAutorizacoesPedido(Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoNovo, Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoAntigo, List<Dominio.Entidades.Embarcador.Pedidos.PedidoAutorizacao> pedidoAutorizacoesAntigos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.PedidoAutorizacao repPedidoAutorizacao = new Repositorio.Embarcador.Pedidos.PedidoAutorizacao(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoAutorizacao> pedidoAutorizacoes = pedidoAutorizacoesAntigos.FindAll(o => o.Pedido.Codigo == pedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoAutorizacao pedidoAutorizacaoAntigo in pedidoAutorizacoes)
            {
                Dominio.Entidades.Embarcador.Pedidos.PedidoAutorizacao pedidoAutorizacaoNovo = pedidoAutorizacaoAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(pedidoAutorizacaoNovo);

                pedidoAutorizacaoNovo.Pedido = pedidoNovo;

                repPedidoAutorizacao.Inserir(pedidoAutorizacaoNovo);
            }
        }

        private void DuplicarImportacoesPedido(Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoNovo, Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoAntigo, List<Dominio.Entidades.Embarcador.Pedidos.PedidoImportacao> pedidosImportacoesAntigos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.PedidoImportacao repPedidoImportacao = new Repositorio.Embarcador.Pedidos.PedidoImportacao(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoImportacao> pedidosImportacoes = pedidosImportacoesAntigos.FindAll(o => o.Pedido.Codigo == pedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoImportacao pedidoImportacao in pedidosImportacoes)
            {
                Dominio.Entidades.Embarcador.Pedidos.PedidoImportacao pedidoImportacaoNovo = pedidoImportacao.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(pedidoImportacaoNovo);

                pedidoImportacaoNovo.Pedido = pedidoNovo;

                repPedidoImportacao.Inserir(pedidoImportacaoNovo);
            }
        }

        private void DuplicarProdutosPedido(Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoNovo, Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoAntigo, Dominio.ObjetosDeValor.Embarcador.Carga.Cancelamento.ParametrosDuplicarPedido parametrosDuplicarPedido, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.PedidoProduto repPedidoProduto = new Repositorio.Embarcador.Pedidos.PedidoProduto(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoProduto> produtos = parametrosDuplicarPedido.PedidoProdutosAntigos.FindAll(o => o.Pedido.Codigo == pedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoProduto produtoAntigo in produtos)
            {
                Dominio.Entidades.Embarcador.Pedidos.PedidoProduto produtoNovo = produtoAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(produtoNovo);

                produtoNovo.Pedido = pedidoNovo;

                repPedidoProduto.Inserir(produtoNovo);

                DuplicarONUProdutoPedido(produtoNovo, produtoAntigo, parametrosDuplicarPedido.PedidoProdutosONUAntigos, unitOfWork);
            }
        }

        private void DuplicarComponentePedido(Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoNovo, Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoAntigo, List<Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete> pedidoComponentesFreteAntigos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.PedidoComponenteFrete repPedidoComponenteFrete = new Repositorio.Embarcador.Pedidos.PedidoComponenteFrete(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete> componentes = pedidoComponentesFreteAntigos.FindAll(o => o.Pedido.Codigo == pedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete componenteAntigo in componentes)
            {
                Dominio.Entidades.Embarcador.Pedidos.PedidoComponenteFrete componenteNovo = componenteAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(componenteNovo);

                componenteNovo.Pedido = pedidoNovo;

                repPedidoComponenteFrete.Inserir(componenteNovo);
            }
        }

        private void DuplicarTransbordoPedido(Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoNovo, Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoAntigo, List<Dominio.Entidades.Embarcador.Pedidos.PedidoTransbordo> pedidosTransbordosAntigos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.PedidoTransbordo repPedidoTransbordo = new Repositorio.Embarcador.Pedidos.PedidoTransbordo(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoTransbordo> transbordos = pedidosTransbordosAntigos.FindAll(o => o.Pedido.Codigo == pedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoTransbordo transbordoAntigo in transbordos)
            {
                Dominio.Entidades.Embarcador.Pedidos.PedidoTransbordo transbordoNovo = transbordoAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(transbordoNovo);

                transbordoNovo.Pedido = pedidoNovo;

                repPedidoTransbordo.Inserir(transbordoNovo);
            }
        }

        private void DuplicarAnexoPedido(Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoNovo, Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoAntigo, List<Dominio.Entidades.Embarcador.Pedidos.PedidoAnexo> pedidoAnexosAntigos, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado)
        {
            Repositorio.Embarcador.Pedidos.PedidoAnexo repPedidoAnexo = new Repositorio.Embarcador.Pedidos.PedidoAnexo(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoAnexo> anexos = pedidoAnexosAntigos.FindAll(o => o.EntidadeAnexo.Codigo == pedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoAnexo anexoAntigo in anexos)
            {
                Dominio.Entidades.Embarcador.Pedidos.PedidoAnexo anexoNovo = anexoAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(anexoNovo);

                anexoNovo.EntidadeAnexo = pedidoNovo;

                repPedidoAnexo.Inserir(anexoNovo);

                if (auditado != null)
                    Servicos.Auditoria.Auditoria.Auditar(auditado, anexoNovo, $"Anexo recebido da carga duplicada.", unitOfWork);
            }
        }

        private void DuplicarAdicionalPedido(Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoNovo, Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoAntigo, List<Dominio.Entidades.Embarcador.Pedidos.PedidoAdicional> pedidoAdicionalAntigos, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado)
        {
            Repositorio.Embarcador.Pedidos.PedidoAdicional repositorioPedidoAdicional = new Repositorio.Embarcador.Pedidos.PedidoAdicional(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoAdicional> pedidosAdicionais = pedidoAdicionalAntigos.FindAll(o => o.Pedido.Codigo == pedidoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoAdicional pedidoAdicional in pedidosAdicionais)
            {
                Dominio.Entidades.Embarcador.Pedidos.PedidoAdicional adicionalNovo = pedidoAdicional.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(adicionalNovo);

                adicionalNovo.Pedido = pedidoNovo;

                repositorioPedidoAdicional.Inserir(adicionalNovo);
            }
        }

        private void DuplicarONUProdutoPedido(Dominio.Entidades.Embarcador.Pedidos.PedidoProduto produtoNovo, Dominio.Entidades.Embarcador.Pedidos.PedidoProduto produtoAntigo, List<Dominio.Entidades.Embarcador.Pedidos.PedidoProdutoONU> pedidoProdutosONUAntigos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.PedidoProdutoONU repPedidoProdutoONU = new Repositorio.Embarcador.Pedidos.PedidoProdutoONU(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.PedidoProdutoONU> produtoONUs = pedidoProdutosONUAntigos.FindAll(o => o.PedidoProduto.Codigo == produtoAntigo.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoProdutoONU produtoONUAntigo in produtoONUs)
            {
                Dominio.Entidades.Embarcador.Pedidos.PedidoProdutoONU produtoONUNovo = produtoONUAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(produtoONUNovo);

                produtoONUNovo.PedidoProduto = produtoNovo;

                repPedidoProdutoONU.Inserir(produtoONUNovo);
            }
        }

        private void DuplicarCargaPercurso(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPercurso repCargaPercurso = new Repositorio.Embarcador.Cargas.CargaPercurso(unitOfWork);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPercurso> listaCargaPercursoAntiga = repCargaPercurso.ConsultarPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPercurso cargaPercursoAntigo in listaCargaPercursoAntiga)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaPercurso cargaPercursoNovo = cargaPercursoAntigo.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaPercursoNovo);

                cargaPercursoNovo.Carga = cargaNova;

                repCargaPercurso.Inserir(cargaPercursoNovo);
            }
        }

        private void DuplicarCargaDadosAverbacao(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaDadosAverbacao repCargaDadosAverbacao = new Repositorio.Embarcador.Cargas.CargaDadosAverbacao(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaDadosAverbacao> cargaDadosAverbacaoAntigas = repCargaDadosAverbacao.BuscarPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaDadosAverbacao cargaDadosAverbacao in cargaDadosAverbacaoAntigas)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaDadosAverbacao cargaDadosAverbacaoNova = cargaDadosAverbacao.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaDadosAverbacaoNova);

                cargaDadosAverbacaoNova.Carga = cargaNova;

                repCargaDadosAverbacao.Inserir(cargaDadosAverbacaoNova);
            }
        }

        private void DuplicarCargaFronteira(Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaFronteira repCargaFronteira = new Repositorio.Embarcador.Cargas.CargaFronteira(unitOfWork);

            List<Dominio.Entidades.Embarcador.Cargas.CargaFronteira> cargaFronteirasAntigas = repCargaFronteira.BuscarPorCarga(cargaAntiga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaFronteira cargaFronteiraAntiga in cargaFronteirasAntigas)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaFronteira cargaFronteiraNova = cargaFronteiraAntiga.Clonar();

                Utilidades.Object.DefinirListasGenericasComoNulas(cargaFronteiraNova);

                cargaFronteiraNova.Carga = cargaNova;

                repCargaFronteira.Inserir(cargaFronteiraNova);
            }
        }

        private void AlterarStatusCustoExtra(Dominio.Entidades.Embarcador.Cargas.Carga carga, TipoDirecionamentoCustoExtra novoTipo)
        {
            switch (novoTipo)
            {
                case TipoDirecionamentoCustoExtra.Faturar:
                    carga.StatusCustoExtra = StatusCustoExtra.Faturado;
                    break;
                case TipoDirecionamentoCustoExtra.Abonar:
                    carga.StatusCustoExtra = StatusCustoExtra.Abonado;
                    break;
                case TipoDirecionamentoCustoExtra.PassThrought:
                    carga.StatusCustoExtra = StatusCustoExtra.PassThrough;
                    break;
                default:
                    break;
            }
        }

        private Dominio.Entidades.Embarcador.Cargas.Carga GerarCargaDuplicada(Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Dominio.Entidades.Embarcador.Cargas.CargaCancelamento cargaCancelamento, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacaoCarga, Dominio.Entidades.Embarcador.Cargas.Carga cargaAgrupamento, bool cargaGeradaSeraANova, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaDadosSumarizados repCargaDadosSumarizados = new Repositorio.Embarcador.Cargas.CargaDadosSumarizados(unitOfWork);
            Repositorio.Embarcador.Configuracoes.IntegracaoIntercab repIntegracaoIntercab = new Repositorio.Embarcador.Configuracoes.IntegracaoIntercab(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab = repIntegracaoIntercab.BuscarIntegracao();

            new Servicos.Embarcador.Logistica.RestricaoRodagem(unitOfWork).ValidaAtualizaZonaExclusaoRota(cargaAntiga?.Rota ?? null);

            Dominio.Entidades.Embarcador.Cargas.Carga novaCarga = new Dominio.Entidades.Embarcador.Cargas.Carga()
            {
                PossuiComponenteFreteComImpostoIncluso = cargaAntiga.PossuiComponenteFreteComImpostoIncluso,
                RegraInclusaoICMS = cargaAntiga.RegraInclusaoICMS,
                CargaFechada = !cargaCancelamento.LiberarPedidosParaMontagemCarga ? cargaAntiga.CargaFechada : false,
                CargaDePreCargaFechada = cargaAntiga.CargaDePreCargaFechada,
                CargaTransbordo = cargaAntiga.CargaTransbordo,
                CodigoCargaEmbarcador = cargaAntiga.CodigoCargaEmbarcador,
                ControlaTempoParaEmissao = cargaAntiga.ControlaTempoParaEmissao,
                DataCarregamentoCarga = cargaAntiga.DataCarregamentoCarga,
                DataCriacaoCarga = cargaAntiga.DataCriacaoCarga,
                DataFechamentoCarga = cargaAntiga.DataFechamentoCarga,
                DataFinalPrevisaoCarregamento = cargaAntiga.DataFinalPrevisaoCarregamento,
                DataInicialPrevisaoCarregamento = cargaAntiga.DataInicialPrevisaoCarregamento,
                DataPrevisaoTerminoCarga = cargaAntiga.DataPrevisaoTerminoCarga,
                Empresa = cargaAntiga.Empresa,
                ExigeNotaFiscalParaCalcularFrete = cargaAntiga.ExigeNotaFiscalParaCalcularFrete,
                Filial = cargaAntiga.Filial,
                FreteDeTerceiro = cargaAntiga.FreteDeTerceiro,
                GrupoPessoaPrincipal = cargaAntiga.GrupoPessoaPrincipal,
                ModeloVeicularCarga = cargaAntiga.ModeloVeicularCarga,
                MotivoPendencia = cargaAntiga.MotivoPendencia,
                MotivoPendenciaFrete = cargaAntiga.MotivoPendenciaFrete,
                NaoExigeVeiculoParaEmissao = cargaAntiga.NaoExigeVeiculoParaEmissao,
                Operador = cargaAntiga.Operador,
                PrioridadeEnvioIntegracao = cargaAntiga.PrioridadeEnvioIntegracao,
                Rota = cargaAntiga.Rota,
                SegmentoGrupoPessoas = cargaAntiga.SegmentoGrupoPessoas,
                SegmentoModeloVeicularCarga = cargaAntiga.SegmentoModeloVeicularCarga,
                SituacaoCarga = situacaoCarga,
                TabelaFrete = cargaAntiga.TabelaFrete,
                TabelaFreteFilialEmissora = cargaAntiga.TabelaFreteFilialEmissora,
                TipoContratacaoCarga = cargaAntiga.TipoContratacaoCarga,
                TipoDeCarga = cargaAntiga.TipoDeCarga,
                TipoFreteEscolhido = cargaAntiga.TipoFreteEscolhido,
                TipoOperacao = cargaAntiga.TipoOperacao,
                ValorFrete = cargaAntiga.ValorFrete,
                ValorFreteAPagar = cargaAntiga.ValorFreteAPagar,
                ValorFreteEmbarcador = cargaAntiga.ValorFreteEmbarcador,
                ValorFreteLeilao = cargaAntiga.ValorFreteLeilao,
                ValorFreteLiquido = cargaAntiga.ValorFreteLiquido,
                ValorFreteOperador = cargaAntiga.ValorFreteOperador,
                ValorFreteTabelaFrete = cargaAntiga.ValorFreteTabelaFrete,
                ValorICMS = cargaAntiga.ValorICMS,
                ValorISS = cargaAntiga.ValorISS,
                ValorRetencaoISS = cargaAntiga.ValorRetencaoISS,
                ValorIBSEstadual = cargaAntiga.ValorIBSEstadual,
                ValorIBSMunicipal = cargaAntiga.ValorIBSMunicipal,
                ValorCBS = cargaAntiga.ValorCBS,
                VeiculoIntegradoEmbarcador = cargaAntiga.VeiculoIntegradoEmbarcador,
                Veiculo = cargaAntiga.Veiculo,
                ControleNumeracao = repCarga.BuscarUltimoControleNumeracao(cargaAntiga.CodigoCargaEmbarcador) + 1,
                Protocolo = cargaAntiga.Protocolo,
                VeiculosVinculados = cargaAntiga.VeiculosVinculados.ToList(),
                Terceiro = cargaAntiga.Terceiro,
                PedidoViagemNavio = cargaAntiga.PedidoViagemNavio,
                TerminalOrigem = cargaAntiga.TerminalOrigem,
                TerminalDestino = cargaAntiga.TerminalDestino,
                CargaDestinadaCTeComplementar = cargaAntiga.CargaDestinadaCTeComplementar,
                EmitirCTeComplementar = cargaAntiga.EmitirCTeComplementar,
                PortoOrigem = cargaAntiga.PortoOrigem,
                PortoDestino = cargaAntiga.PortoDestino,
                ProvedorOS = cargaAntiga.ProvedorOS,
                TipoServicoCarga = cargaAntiga.TipoServicoCarga,
                CargaSVMTerceiro = cargaAntiga.CargaSVMTerceiro,
                Moeda = cargaAntiga.Moeda,
                ValorCotacaoMoeda = cargaAntiga.ValorCotacaoMoeda,
                ValorTotalMoeda = cargaAntiga.ValorTotalMoeda,
                NumeroSequenciaCarga = cargaAntiga.NumeroSequenciaCarga,
                FaixaTemperatura = cargaAntiga.FaixaTemperatura,
                ProcedimentoEmbarque = cargaAntiga.ProcedimentoEmbarque,
                OrdemRoteirizacaoDefinida = cargaAntiga.OrdemRoteirizacaoDefinida,
                OrigemFretePelaJanelaTransportador = cargaAntiga.OrigemFretePelaJanelaTransportador,
                CargaAgrupada = cargaAntiga.CargaAgrupada,
                CargaAgrupamento = cargaAgrupamento,
                CalcularFreteLote = cargaAntiga.CalcularFreteLote,
                SituacaoRoteirizacaoCarga = SituacaoRoteirizacao.Aguardando,
                DataInicioViagem = cargaAntiga.DataInicioViagem,
                DataInicioViagemPrevista = cargaAntiga.DataInicioViagemPrevista,
                DataInicioViagemReprogramada = cargaAntiga.DataInicioViagemReprogramada,
                DataFimViagem = cargaAntiga.DataFimViagem,
                DataFimViagemPrevista = cargaAntiga.DataFimViagemPrevista,
                DataFimViagemReprogramada = cargaAntiga.DataFimViagemReprogramada,
                InicioDeViagemNoRaio = cargaAntiga.InicioDeViagemNoRaio,
                LatitudeInicioViagem = cargaAntiga.LatitudeInicioViagem,
                LongitudeInicioViagem = cargaAntiga.LongitudeInicioViagem,
                CargaPossuiOutrosNumerosEmbarcador = cargaAntiga.CargaPossuiOutrosNumerosEmbarcador,
                CargaBloqueadaParaEdicaoIntegracao = cargaAntiga.CargaBloqueadaParaEdicaoIntegracao,
                ProtocoloIntegracaoGR = cargaAntiga.ProtocoloIntegracaoGR,
                CategoriaOS = cargaAntiga.CategoriaOS,
                IndicLiberacaoOk = cargaAntiga.IndicLiberacaoOk,
                LiberarPagamento = cargaAntiga.LiberarPagamento,
                ValorTotalProvedor = cargaAntiga.ValorTotalProvedor,
                StatusCustoExtra = StatusCustoExtra.EmAberto,
            };

            if (!string.IsNullOrWhiteSpace(cargaAntiga.IdentificadorDeRota))
            {
                novaCarga.CargaRotaFreteInformadaViaIntegracao = cargaAntiga.CargaRotaFreteInformadaViaIntegracao;
                novaCarga.Distancia = cargaAntiga.Distancia;
                novaCarga.SituacaoRoteirizacaoCarga = SituacaoRoteirizacao.Concluido;
            }

            bool trocarTipoIntegracaoPadraoIntercab = ((integracaoIntercab?.PossuiIntegracaoIntercab ?? false) && (integracaoIntercab?.TipoOperacao != null) && (integracaoIntercab?.SelecionarTipoOperacao ?? false));

            if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS)
            {
                novaCarga.DataInicioViagem = null;
                novaCarga.DataFimViagem = null;

                if (trocarTipoIntegracaoPadraoIntercab)
                    novaCarga.TipoOperacao = integracaoIntercab.TipoOperacao;
            }

            if (cargaAntiga.CodigosAgrupados != null)
                novaCarga.CodigosAgrupados = cargaAntiga.CodigosAgrupados.ToList();

            if (cargaGeradaSeraANova)
            {
                if (cargaAntiga.DadosSumarizados != null)
                {
                    Dominio.Entidades.Embarcador.Cargas.CargaDadosSumarizados cargaDadosSumarizados = cargaAntiga.DadosSumarizados.Clonar();

                    Utilidades.Object.DefinirListasGenericasComoNulas(cargaDadosSumarizados);

                    cargaDadosSumarizados.ClientesRemetentes = cargaAntiga.DadosSumarizados.ClientesRemetentes.ToList();
                    cargaDadosSumarizados.ClientesDestinatarios = cargaAntiga.DadosSumarizados.ClientesDestinatarios.ToList();

                    repCargaDadosSumarizados.Inserir(cargaDadosSumarizados);

                    novaCarga.DadosSumarizados = cargaDadosSumarizados;

                    if (trocarTipoIntegracaoPadraoIntercab)
                    {
                        novaCarga.DadosSumarizados.TiposDeOperacao = integracaoIntercab.TipoOperacao.Descricao;
                        repCargaDadosSumarizados.Atualizar(novaCarga.DadosSumarizados);
                    }
                }
                repCarga.Inserir(novaCarga);
            }
            else
            {
                novaCarga.AgConfirmacaoUtilizacaoCredito = cargaAntiga.AgConfirmacaoUtilizacaoCredito;
                novaCarga.AgImportacaoCTe = cargaAntiga.AgImportacaoCTe;
                novaCarga.LiberadaParaEmissaoCTeSubContratacaoFilialEmissora = cargaAntiga.LiberadaParaEmissaoCTeSubContratacaoFilialEmissora;
                novaCarga.EmEmissaoCTeSubContratacaoFilialEmissora = cargaAntiga.EmEmissaoCTeSubContratacaoFilialEmissora;
                novaCarga.AgImportacaoMDFe = cargaAntiga.AgImportacaoMDFe;
                novaCarga.AguardandoEmissaoDocumentoAnterior = cargaAntiga.AguardandoEmissaoDocumentoAnterior;
                novaCarga.AutorizouTodosCTes = cargaAntiga.AutorizouTodosCTes;
                novaCarga.CargaCancelamento = cargaAntiga.CargaCancelamento;
                novaCarga.CargaIntegradaEmbarcador = cargaAntiga.CargaIntegradaEmbarcador;
                novaCarga.DadosSumarizados = cargaAntiga.DadosSumarizados;
                novaCarga.DataEnvioUltimaNFe = cargaAntiga.DataEnvioUltimaNFe;
                novaCarga.DataRecebimentoUltimaNFe = cargaAntiga.DataRecebimentoUltimaNFe;
                novaCarga.DataFinalizacaoEmissao = cargaAntiga.DataFinalizacaoEmissao;
                novaCarga.PossuiPendencia = cargaAntiga.PossuiPendencia;
                novaCarga.problemaCTE = cargaAntiga.problemaCTE;
                novaCarga.problemaAverbacaoCTe = cargaAntiga.problemaAverbacaoCTe;
                novaCarga.problemaEmissaoNFeRemessa = cargaAntiga.problemaEmissaoNFeRemessa;
                novaCarga.ProblemaAverbacaoMDFe = cargaAntiga.ProblemaAverbacaoMDFe;
                novaCarga.LiberarComProblemaAverbacao = cargaAntiga.LiberarComProblemaAverbacao;
                novaCarga.LiberadoComProblemaValePedagio = cargaAntiga.LiberadoComProblemaValePedagio;
                novaCarga.LiberarComProblemaAverbacaoMDFe = cargaAntiga.LiberarComProblemaAverbacaoMDFe;
                novaCarga.problemaMDFe = cargaAntiga.problemaMDFe;
                novaCarga.problemaNFS = cargaAntiga.problemaNFS;
                novaCarga.GerouTituloAutorizacao = cargaAntiga.GerouTituloAutorizacao;
                novaCarga.GerouControleFaturamento = cargaAntiga.GerouControleFaturamento;
                novaCarga.GerouMovimentacaoAutorizacao = cargaAntiga.GerouMovimentacaoAutorizacao;
                novaCarga.Protocolo = (int)repCarga.Inserir(novaCarga);

                repCarga.Atualizar(novaCarga);
            }

            return novaCarga;
        }

        private Dominio.ObjetosDeValor.Embarcador.Importacao.RetonoLinha RetornarFalhaLinha(string mensagem, int indice)
        {
            Dominio.ObjetosDeValor.Embarcador.Importacao.RetonoLinha retorno = new Dominio.ObjetosDeValor.Embarcador.Importacao.RetonoLinha() { indice = indice, mensagemFalha = mensagem, processou = false };
            return retorno;
        }

        private Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeParticipantes ValidarTipoEmissaoCTeParticipantes(Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeralCarga configuracaoGeralCarga, Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacao)
        {
            if (configuracaoGeralCarga.ConsiderarConfiguracaoNoTipoDeOperacaoParaParticipantesDosDocumentosAoGerarCargaEspelho)
                return tipoOperacao.TipoEmissaoCTeParticipantes;

            return Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeParticipantes.Normal;
        }

        private Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga ValidarTipoContratacaoCarga(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeParticipantes tipoEmissaoCTeParticipantes)
        {
            if (tipoEmissaoCTeParticipantes == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeParticipantes.ComExpedidorERecebedor)
                return Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario;

            return Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho;
        }

        private Dominio.ObjetosDeValor.Embarcador.Carga.Cancelamento.ParametrosDuplicarCargaPedido ObterParametrosDuplicarCargaPedido(int codigoCargaAntiga, int codigoCargaNova, bool possuiPedidoTransbordo, bool possuiNaoCTeEmitidoNoEmbarcador, Dominio.Entidades.Embarcador.Cargas.CargaCancelamento cargaCancelamento, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedidoComponentesFrete repCargaPedidoComponentesFrete = new Repositorio.Embarcador.Cargas.CargaPedidoComponentesFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntregaPedido repCargaEntregaPedido = new Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntregaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaIntegracaoNatura repCargaIntegracaoNatura = new Repositorio.Embarcador.Cargas.CargaIntegracaoNatura(unitOfWork);
            Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao repApoliceSeguroAverbacao = new Repositorio.Embarcador.Seguros.ApoliceSeguroAverbacao(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoRotaFrete repCargaPedidoRotaFrete = new Repositorio.Embarcador.Cargas.CargaPedidoRotaFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoProduto repCargaPedidoProduto = new Repositorio.Embarcador.Cargas.CargaPedidoProduto(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoQuantidades repCargaPedidoQuantidade = new Repositorio.Embarcador.Cargas.CargaPedidoQuantidades(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoRotas repCargaPedidoRota = new Repositorio.Embarcador.Cargas.CargaPedidoRotas(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoEspelhoIntercement repPedidoEspelhoIntercement = new Repositorio.Embarcador.Pedidos.PedidoEspelhoIntercement(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaMotorista repCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);
            Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntregaNotaFiscal repCargaEntregaNotaFiscal = new Repositorio.Embarcador.Cargas.ControleEntrega.CargaEntregaNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscalComponenteFrete repPedidoXMLNotaFiscalComponenteFrete = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscalComponenteFrete(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao repPedidoCTeParaSubcontratacao = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacaoPedidoNotaFiscal repPedidoCTeParaSubContratacaoPedidoNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacaoPedidoNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCteParaSubContratacaoComponenteFrete repPedidoCteParaSubContratacaoComponenteFrete = new Repositorio.Embarcador.Pedidos.PedidoCteParaSubContratacaoComponenteFrete(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoDocumentoMDFe repCargaPedidoDocumentoMDFe = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoMDFe(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe repCargaPedidoDocumentoCTe = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTeComponenteFrete repCargaPedidoDocumentoCTeComponenteFrete = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTeComponenteFrete(unitOfWork);

            bool buscouPedidosXMLNotasFiscaisAntigas = false;

            Dominio.ObjetosDeValor.Embarcador.Carga.Cancelamento.ParametrosDuplicarCargaPedido parametrosDuplicarCargaPedido = new Dominio.ObjetosDeValor.Embarcador.Carga.Cancelamento.ParametrosDuplicarCargaPedido();

            parametrosDuplicarCargaPedido.CargaEntregasPedidosAntigas = repCargaEntregaPedido.BuscarPorCargaEntregaCodigoCarga(codigoCargaAntiga);
            parametrosDuplicarCargaPedido.CargaIntegracoesNaturaAntiga = repCargaIntegracaoNatura.BuscarPorCarga(codigoCargaAntiga);
            parametrosDuplicarCargaPedido.ApolicesSegurosAntigas = repApoliceSeguroAverbacao.BuscarPorCargaSemFetch(codigoCargaAntiga);
            parametrosDuplicarCargaPedido.CargaPedidoRotasFreteAntigas = repCargaPedidoRotaFrete.BuscarPorCarga(codigoCargaAntiga);
            parametrosDuplicarCargaPedido.CargaPedidoComponentesFreteAntigos = repCargaPedidoComponentesFrete.BuscarPorCarga(codigoCargaAntiga);
            parametrosDuplicarCargaPedido.CargaPedidoProdutosAntigos = repCargaPedidoProduto.BuscarPorCargaSemFetch(codigoCargaAntiga);
            parametrosDuplicarCargaPedido.CargaPedidoQuantidadesAntigos = repCargaPedidoQuantidade.BuscarPorCarga(codigoCargaAntiga);
            parametrosDuplicarCargaPedido.CargaPedidoRotasAntigas = repCargaPedidoRota.BuscarPorCarga(codigoCargaAntiga);
            parametrosDuplicarCargaPedido.PedidosEspelhosAntigos = repPedidoEspelhoIntercement.BuscarPorCarga(codigoCargaAntiga);
            parametrosDuplicarCargaPedido.Motoristas = repCargaMotorista.BuscarMotoristasPorCarga(codigoCargaNova);

            if (SempreDuplicarCargaCancelada(tipoServicoMultisoftware, configuracaoTMS))
            {
                parametrosDuplicarCargaPedido.PedidosXMLNotasFiscaisAntigas = repPedidoXMLNotaFiscal.BuscarPorCargaSemFetch(codigoCargaAntiga);
                parametrosDuplicarCargaPedido.CargaEntregasNotasFiscaisAntigas = repCargaEntregaNotaFiscal.BuscarPorCargaSemFetch(codigoCargaAntiga);
                parametrosDuplicarCargaPedido.PedidosXMLsComponenteAntigos = repPedidoXMLNotaFiscalComponenteFrete.BuscarPorCargaSemFetch(codigoCargaAntiga);

                buscouPedidosXMLNotasFiscaisAntigas = true;
            }

            if (possuiPedidoTransbordo || !cargaCancelamento.CancelarDocumentosEmitidosNoEmbarcador)
            {
                parametrosDuplicarCargaPedido.CargaPedidoDocumentoMDFesAntigos = repCargaPedidoDocumentoMDFe.BuscarPorCarga(codigoCargaAntiga);
                parametrosDuplicarCargaPedido.CargaPedidoDocumentoCTesAntigos = repCargaPedidoDocumentoCTe.BuscarPorCarga(codigoCargaAntiga);
                parametrosDuplicarCargaPedido.CargaPedidoDocumentoCTeComponentesFreteAntigos = repCargaPedidoDocumentoCTeComponenteFrete.BuscarPorCarga(codigoCargaAntiga);
            }

            if (possuiNaoCTeEmitidoNoEmbarcador)
            {
                if (!buscouPedidosXMLNotasFiscaisAntigas)
                    parametrosDuplicarCargaPedido.PedidosXMLNotasFiscaisAntigas = repPedidoXMLNotaFiscal.BuscarPorCargaSemFetch(codigoCargaAntiga);

                parametrosDuplicarCargaPedido.PedidoCTesParaSubcontratacaoAntigos = repPedidoCTeParaSubcontratacao.BuscarPorCargaSemFetch(codigoCargaAntiga);
                parametrosDuplicarCargaPedido.PedidoCTeParaSubContratacaoPedidoNotaFiscalAntigos = repPedidoCTeParaSubContratacaoPedidoNotaFiscal.BuscarAtivosPorCarga(codigoCargaAntiga);
                parametrosDuplicarCargaPedido.PedidoCteParaSubContratacaoComponenteFretesAntigos = repPedidoCteParaSubContratacaoComponenteFrete.BuscarPorCarga(codigoCargaAntiga, false);
            }

            return parametrosDuplicarCargaPedido;
        }

        private Dominio.ObjetosDeValor.Embarcador.Carga.Cancelamento.ParametrosDuplicarPedido ObterParametrosDuplicarPedido(int codigoCargaAntiga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.PedidoImportacao repPedidoImportacao = new Repositorio.Embarcador.Pedidos.PedidoImportacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoProduto repPedidoProduto = new Repositorio.Embarcador.Pedidos.PedidoProduto(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoProdutoONU repPedidoProdutoONU = new Repositorio.Embarcador.Pedidos.PedidoProdutoONU(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoTransbordo repPedidoTransbordo = new Repositorio.Embarcador.Pedidos.PedidoTransbordo(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoComponenteFrete repPedidoComponenteFrete = new Repositorio.Embarcador.Pedidos.PedidoComponenteFrete(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoAutorizacao repPedidoAutorizacao = new Repositorio.Embarcador.Pedidos.PedidoAutorizacao(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoAnexo repPedidoAnexo = new Repositorio.Embarcador.Pedidos.PedidoAnexo(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoAdicional repositorioPedidoAdicional = new Repositorio.Embarcador.Pedidos.PedidoAdicional(unitOfWork);

            Dominio.ObjetosDeValor.Embarcador.Carga.Cancelamento.ParametrosDuplicarPedido parametrosDuplicarPedido = new Dominio.ObjetosDeValor.Embarcador.Carga.Cancelamento.ParametrosDuplicarPedido();

            parametrosDuplicarPedido.PedidoImportacoesAntigos = repPedidoImportacao.BuscarPorCarga(codigoCargaAntiga);
            parametrosDuplicarPedido.PedidoProdutosAntigos = repPedidoProduto.BuscarPorCarga(codigoCargaAntiga);
            parametrosDuplicarPedido.PedidoProdutosONUAntigos = repPedidoProdutoONU.BuscarPorCarga(codigoCargaAntiga);
            parametrosDuplicarPedido.PedidoTransbordosAntigos = repPedidoTransbordo.BuscarPorCarga(codigoCargaAntiga);
            parametrosDuplicarPedido.PedidoComponentesFreteAntigos = repPedidoComponenteFrete.BuscarPorCarga(codigoCargaAntiga);
            parametrosDuplicarPedido.PedidoAutorizacoesAntigos = repPedidoAutorizacao.BuscarPorCarga(codigoCargaAntiga);
            parametrosDuplicarPedido.PedidoAnexosAntigos = repPedidoAnexo.BuscarPorCarga(codigoCargaAntiga);
            parametrosDuplicarPedido.PedidoAdicionalAntigos = repositorioPedidoAdicional.BuscarPorCarga(codigoCargaAntiga);

            return parametrosDuplicarPedido;
        }

        private bool SempreDuplicarCargaCancelada(AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS)
        {
            return tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS || configuracaoTMS.SempreDuplicarCargaCancelada;
        }

        #endregion Métodos Privados Duplicar Carga

        #region Métodos Privados Estáticos

        private dynamic ObterConfiguracoesDetalhesCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            bool emissaoLiberada = VerificarSeCargaEmEmissao(carga, tipoServicoMultisoftware);

            return new
            {
                EmissaoLiberada = emissaoLiberada,
                carga.CargaDeComplemento,
                carga.CargaDePreCarga,
                PossuiConfiguracaoImpressora = !string.IsNullOrWhiteSpace(carga.NumeroImpressora) || carga.Filial?.NumeroUnidadeImpressao > 0,
                carga.ExigeNotaFiscalParaCalcularFrete,
                carga.NaoExigeVeiculoParaEmissao,
                carga.AgImportacaoCTe,
                carga.LiberadaSemTodosPreCTes,
                carga.PendenteGerarCargaDistribuidor,
                carga.LiberadoComProblemaCIOT,
                carga.CalcularFreteCliente,
                PossuiIntegracaoMichelin = carga.GrupoPessoaPrincipal?.LayoutsEDI?.Any(o => o.TipoIntegracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Michelin) ?? false,
                carga.CargaColeta,
                carga.CargaSVMTerceiro,
                carga.SeparacaoConferida,
                carga.PossuiSeparacao,
                carga.AgGeracaoCTesAnteriorFilialEmissora,
                carga.EmEmissaoCTeSubContratacaoFilialEmissora,
                carga.AgNFSManual,
                carga.CargaEmitidaParcialmente,
                carga.NaoGerarMDFe,
                PossuiCTeSubcontratacaoFilialEmissora = carga.EmpresaFilialEmissora != null,
                carga.AgConfirmacaoUtilizacaoCredito,
                CienciaDoEnvioDaNotaInformado = true,
                carga.CTesEmDigitacao,
                carga.CargaSVM,
                CargaTipoConsolidacao = carga.TipoOperacao?.CargaTipoConsolidacao ?? false,
                carga.CargaTakeOrPay,
                carga.CargaDemurrage,
                carga.CargaDetention,
                carga.SeparacaoMercadoriaConfirmada,
                PossuiIntegracaoIntercement = carga.Integracoes?.Any(o => o.TipoIntegracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Intercement) ?? false,
                carga.CargaDestinadaCTeComplementar,
                carga.AgSelecaoRotaOperador,
                carga.CargaTrocaDeNota,
                ExibirMensagensAlerta = false,
                carga.LiberadaEtapaFaturamentoBloqueada,
                carga.EmitindoCTes,
                carga.AverbandoCTes,
                carga.AverbouTodosCTes,
                carga.AutorizouTodosCTes,
                EmissaoDocumentosAutorizada = carga.DataEnvioUltimaNFe.HasValue && carga.DataEnvioUltimaNFe.Value <= DateTime.Now && emissaoLiberada && !carga.CalculandoFrete && !carga.PendenteGerarCargaDistribuidor && !carga.AguardarIntegracaoEtapaTransportador,
                carga.FreteDeTerceiro,
                carga.ProblemaIntegracaoValePedagio,
                carga.ProblemaIntegracaoCIOT,
                LiberadoComProblemaValePedagio = carga.LiberadoComProblemaValePedagio,
                carga.LiberadoComProblemaPagamentoMotorista,
                carga.ProblemaIntegracaoPagamentoMotorista,
                carga.CargaTransbordo,
                carga.AguardandoEmissaoDocumentoAnterior,
                carga.RejeitadaPeloTransportador,
                ExibirCalculoFreteCargaAgrupada = carga.TabelaFrete?.TipoCalculo != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoCalculoTabelaFrete.PorPedido && carga.AgrupadaPosEmissaoDocumento,
                ObrigatorioInformarAnexoSolicitacaoFrete = carga.TipoOperacao?.ObrigatorioInformarAnexoSolicitacaoFrete ?? false,
                PermiteImportarDocumentosManualmente = carga.TipoOperacao?.PermiteImportarDocumentosManualmente ?? false,
                PermitirTransbordarNotasDeOutrasCargas = carga.TipoOperacao?.PermitirTransbordarNotasDeOutrasCargas ?? false,
                PermitirSelecionarNotasCompativeis = carga.TipoOperacao?.PermitirSelecionarNotasCompativeis ?? false,
                carga.PossuiPendencia,
                carga.OrigemFretePelaJanelaTransportador,
                ProblemaMDFe = carga.problemaMDFe,
                ProblemaCTE = carga.problemaCTE,
                ProblemaEmissaoNFeRemessa = carga.problemaEmissaoNFeRemessa,
                carga.EmiteMDFeFilialEmissora,
                carga.LiberadaParaEmissaoCTeSubContratacaoFilialEmissora,
                ProblemaNFS = carga.problemaNFS,
                ProblemaAverbacaoCTe = carga.problemaAverbacaoCTe,
                carga.ProblemaAverbacaoMDFe,
                carga.Desistencia,
                carga.ProcessandoDocumentosFiscais,
                carga.CargaPossuiOutrosNumerosEmbarcador,
                carga.AguardarIntegracaoEtapaTransportador,
                carga.AguardarIntegracaoDadosTransporte,
                carga.ProblemaIntegracaoDadosTransporte,
                carga.LiberadaComProblemaIntegracaoDadosTransporte,
                ExigirDataRetiradaCtrnVeiculos = carga.TipoOperacao?.ExigirDataRetiradaCtrnJanelaCarregamentoTransportador ?? false,
                ExigirNumeroContainerVeiculos = carga.TipoOperacao?.ExigirNumeroContainerJanelaCarregamentoTransportador ?? false,
                ProblemaIntegracaoGrMotoristaVeiculo = carga.ProblemaIntegracaoGrMotoristaVeiculo && carga.SituacaoCarga == SituacaoCarga.Nova,
                ProblemaIntegracaoGrMotoristaVeiculoDetalhes = carga.ProblemaIntegracaoGrMotoristaVeiculo && carga.SituacaoCarga != SituacaoCarga.Nova,
                carga.NaoComparecido,
                PermitirTransportadorEnviarNotasFiscais = carga.TipoOperacao?.PermitirTransportadorEnviarNotasFiscais ?? false,
                PermitirTransportadorSolicitarNotasFiscais = carga.TipoOperacao?.ConfiguracaoTransportador?.PermitirTransportadorSolicitarNotasFiscais ?? false,
                ExibirValorUnitarioDoProduto = carga.TipoOperacao?.TipoOperacaoExibeValorUnitarioDoProduto ?? false,
                PermiteInformarIsca = carga.TipoOperacao?.PermiteInformarIscaNaCarga ?? false,
                ExigeInformarIsca = (carga.TipoOperacao?.PermiteInformarIscaNaCarga ?? false) && (carga.TipoOperacao?.ExigeInformarIscaNaCarga ?? false),
                IntegrandoValePedagio = carga.IntegrandoValePedagio,
                CargaPossuiPreCalculoFrete = carga.CargaPossuiPreCalculoFrete,
                PermiteInformarQuantidadePaletes = carga.TipoOperacao?.ConfiguracaoCalculoFrete?.PermiteInformarQuantidadePaletes ?? false,
                NaoPermitirAcessarDocumentosAntesCargaEmTransporte = carga.TipoOperacao?.ConfiguracaoEmissaoDocumento?.NaoPermitirAcessarDocumentosAntesCargaEmTransporte ?? false,
                ObrigatorioVincularContainerCarga = carga.TipoOperacao?.ObrigatorioVincularContainerCarga ?? false,
                PermiteAdicionarAnexosGuarita = carga.TipoOperacao?.ConfiguracaoCarga?.PermiteAdicionarAnexosGuarita ?? false,
                TransferenciaContainer = carga.TipoOperacao?.OperacaoTransferenciaContainer ?? false,
                ExibirNumeroPedidoNosDetalhesDaCarga = carga.TipoOperacao?.ConfiguracaoCarga?.ExibirNumeroPedidoNosDetalhesDaCarga ?? false,
                ValidarLicencaMotorista = carga.TipoOperacao?.ConfiguracaoTipoOperacaoLicenca?.ValidarLicencaMotorista ?? false,
                CargaTipoInformarDadosNotaCte = carga.TipoOperacao?.InformarDadosNotaCte ?? false,
                carga.UtilizarCTesAnterioresComoCTeFilialEmissora,
                NaoPermitirLiberarSemValePedagio = carga.TipoOperacao?.ConfiguracaoEmissaoDocumento?.NaoPermitirLiberarSemValePedagio ?? false,
                ExclusivaDeSubcontratacaoOuRedespacho = carga.TipoOperacao?.ExclusivaDeSubcontratacaoOuRedespacho ?? false,
                Reentrega = carga.DadosSumarizados?.Reentrega ?? false,
                PermiteTransportadorAvancarEtapaEmissao = carga.TipoOperacao?.PermiteTransportadorAvancarEtapaEmissao ?? false,
                ClassificacaoNFeRemessaVenda = carga.TipoOperacao?.ConfiguracaoEmissaoDocumento?.ClassificacaoNFeRemessaVenda ?? false,
                ConsolidadoPreCheckin = carga?.TipoOperacao?.TipoConsolidacao == EnumTipoConsolidacao.PreCheckIn,
                PendenciaTransportadorContribuinte = carga.PendenciaDocumentoTransportador,
                carga.PendenciaValorLimiteApolice,
                TipoIntegracaoMercadoLivre = carga.TipoOperacao?.TipoIntegracaoMercadoLivre ?? TipoIntegracaoMercadoLivre.HandlingUnit,
                SaldoInsuficienteContratoFreteCliente = carga.SaldoInsuficienteContratoFreteCliente ?? false
            };
        }

        private string ObterDadosIntegracaoPrecalculo(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaDadosTransporteIntegracao repositorioCargaDadosTransporte = new Repositorio.Embarcador.Cargas.CargaDadosTransporteIntegracao(unitOfWork);
            Repositorio.Embarcador.Pedidos.StageAgrupamento repositorioStageAgrupamento = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);
            Dominio.Entidades.Embarcador.Cargas.CargaDadosTransporteIntegracao cargaDadosTransporteIntegracao = repositorioCargaDadosTransporte.BuscarPorCargaETipoIntegracao(carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Unilever);

            string retorno = string.Empty;

            if (cargaDadosTransporteIntegracao == null || cargaDadosTransporteIntegracao.TipoIntegracao.Tipo != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Unilever || repositorioStageAgrupamento.EstaCargaFoiGeradoPorUmAgrupamento(carga.Codigo))
                return retorno;

            if (cargaDadosTransporteIntegracao.SituacaoIntegracao != SituacaoIntegracao.Integrado)
                return "Não foi possivel calcular";

            return "Realizado com sucesso";
        }

        private static bool IsAnexosAgendamentoColetaValido(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Logistica.AgendamentoColeta repAgendamentoColeta = new Repositorio.Embarcador.Logistica.AgendamentoColeta(unitOfWork);
            Dominio.Entidades.Embarcador.Logistica.AgendamentoColeta agendamento = repAgendamentoColeta.BuscarPorCarga(carga.Codigo);

            if (agendamento == null || !agendamento.CargaPerigosa)
                return true;

            Repositorio.Embarcador.Cargas.CargaNFeAnexo repCargaNFeAnexo = new Repositorio.Embarcador.Cargas.CargaNFeAnexo(unitOfWork);
            return repCargaNFeAnexo.ContarPorCarga(carga.Codigo) > 0;
        }

        private static void AtualizarTipoContratacao(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);

            if (cargaPedido.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SVMProprio && cargaPedido.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho && cargaPedido.TipoContratacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario)
            {
                if (cargaPedido.Expedidor != null && cargaPedido.Recebedor != null)
                {
                    if (cargaPedido.Carga.GrupoPessoaPrincipal != null && cargaPedido.Carga.GrupoPessoaPrincipal.EmitirSempreComoRedespacho)
                        cargaPedido.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho;
                    else
                        cargaPedido.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.RedespachoIntermediario;
                }
                else if (cargaPedido.Expedidor != null || cargaPedido.Recebedor != null)
                    cargaPedido.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.Redespacho;
                else
                    cargaPedido.TipoContratacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoContratacaoCarga.SubContratada;

                if (cargaPedido.TipoServicoMultimodal == TipoServicoMultimodal.Subcontratacao || (cargaPedido.Carga.TipoOperacao?.SempreEmitirSubcontratacao ?? false))
                    cargaPedido.TipoContratacaoCarga = TipoContratacaoCarga.SubContratada;

                cargaPedido.CargaPedidoFilialEmissora = false;

            }

            repCargaPedido.Atualizar(cargaPedido);

        }

        private static void GerarSubContratacaoSVM(Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, string stringConexao, Repositorio.UnitOfWork unitOfWork)
        {
            Log.TratarErro($"Inicio GerarSubContratacaoSVM - {cargaPedido?.Carga?.CodigoCargaEmbarcador ?? ""} - {DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff")}", "CTeSubContratacao");
            Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe repCargaPedidoDocumentoCTe = new Repositorio.Embarcador.Cargas.CargaPedidoDocumentoCTe(unitOfWork);
            Repositorio.Embarcador.CTe.CTeTerceiro repositorioCTeTerceiro = new Repositorio.Embarcador.CTe.CTeTerceiro(unitOfWork);
            List<int> codigosCTes = repCargaPedidoDocumentoCTe.BuscarCodigosCTesPorCargaPedido(cargaPedido.Codigo);
            Servicos.Embarcador.CTe.CTe serCTe = new Embarcador.CTe.CTe(unitOfWork);
            Servicos.Embarcador.Carga.Carga serCarga = new Carga(unitOfWork);
            Servicos.Embarcador.Carga.CTeSubContratacao serCTeSubContratacao = new Servicos.Embarcador.Carga.CTeSubContratacao(unitOfWork);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new ConhecimentoDeTransporteEletronico(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao repPedidoCTeParaSubContratacao = new Repositorio.Embarcador.Pedidos.PedidoCTeParaSubContratacao(unitOfWork);
            Repositorio.Embarcador.Configuracoes.IntegracaoIntercab repIntegracaoIntercab = new Repositorio.Embarcador.Configuracoes.IntegracaoIntercab(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoGeral repositorioConfiguracaoGeral = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeral(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeral configuracaoGeral = repositorioConfiguracaoGeral.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab = repIntegracaoIntercab.BuscarIntegracao();

            bool enviarCTeApenasParaTomador = (configuracaoGeral?.EnviarCTeApenasParaTomador ?? false);

            for (int i = 0; i < codigosCTes.Count; i++)
            {
                unitOfWork.Start();

                string retorno = "";
                Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorCodigo(codigosCTes[i]);
                Dominio.Entidades.Embarcador.CTe.CTeTerceiro cteParaSubContratacao = repositorioCTeTerceiro.BuscarPorChave(cte.Chave, false);

                if (cteParaSubContratacao == null)
                {
                    string descricaoItemPeso = serCTeSubContratacao.ObterDescricaoItemPeso(cargaPedido, unitOfWork, out bool utilizarPrimeiraUnidadeMedidaPeso);
                    Log.TratarErro($"ObterDescricaoItemPeso - {cargaPedido?.Carga?.CodigoCargaEmbarcador ?? ""} - {DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff")}", "CTeSubContratacao");
                    Dominio.ObjetosDeValor.Embarcador.CTe.CTe cteIntegracao = serCTe.ConverterEntidadeCTeParaObjeto(cte, enviarCTeApenasParaTomador, unitOfWork);
                    Log.TratarErro($"ConverterEntidadeCTeParaObjeto - {cargaPedido?.Carga?.CodigoCargaEmbarcador ?? ""} - {DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff")}", "CTeSubContratacao");

                    cteParaSubContratacao = serCTeSubContratacao.CriarCTeTerceiro(unitOfWork, ref retorno, null, cteIntegracao, descricaoItemPeso, utilizarPrimeiraUnidadeMedidaPeso, 0, false, false, tipoServicoMultisoftware);
                    Log.TratarErro($"CriarCTeTerceiro - {cargaPedido?.Carga?.CodigoCargaEmbarcador ?? ""} - {DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff")}", "CTeSubContratacao");
                }

                if (string.IsNullOrEmpty(retorno) && !cargaPedido.Carga.CargaRecebidaDeIntegracao)
                {
                    cteParaSubContratacao.Ativo = true;
                    Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao pedidoCTeParaSubContratacao = repPedidoCTeParaSubContratacao.BuscarPorCTeSubContratacaoECargaPedido(cteParaSubContratacao.Codigo, cargaPedido.Codigo);
                    if (pedidoCTeParaSubContratacao == null)
                        pedidoCTeParaSubContratacao = serCTeSubContratacao.InserirCTeSubContratacaoFilialEmissora(cteParaSubContratacao, null, cargaPedido, tipoServicoMultisoftware, unitOfWork);
                    Log.TratarErro($"InserirCTeSubContratacaoFilialEmissora - {cargaPedido?.Carga?.CodigoCargaEmbarcador ?? ""} - {DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff")}", "CTeSubContratacao");
                    repositorioCTeTerceiro.Atualizar(cteParaSubContratacao);
                }

                if (cteParaSubContratacao != null && (integracaoIntercab?.BuscarTipoServicoModeloDocumentoVinculadoCarga ?? false))
                    serCarga.AtualizarTipoServicoCargaMultimodal(cteParaSubContratacao, cargaPedido, unitOfWork, out string msgRetornoTipoServico);

                unitOfWork.CommitChanges();

                unitOfWork.FlushAndClear();

                cargaPedido = repCargaPedido.BuscarPorCodigo(cargaPedido.Codigo);
            }

            if (!(integracaoIntercab?.BuscarTipoServicoModeloDocumentoVinculadoCarga ?? false))
                AtualizarTipoContratacao(cargaPedido, unitOfWork);

            Log.TratarErro($"Fim GerarSubContratacaoSVM - {cargaPedido?.Carga?.CodigoCargaEmbarcador ?? ""} - {DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff")}", "CTeSubContratacao");
        }

        private static List<Dominio.ObjetosDeValor.Embarcador.GR.RetornoGR> ValidarVeiculoGR(bool liberarComProblema, Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            string mensagem = string.Empty;
            List<Dominio.ObjetosDeValor.Embarcador.GR.RetornoGR> listaRetorno = new List<Dominio.ObjetosDeValor.Embarcador.GR.RetornoGR>();

            List<Dominio.Entidades.Veiculo> veiculos = new List<Dominio.Entidades.Veiculo>();
            veiculos.Add(carga.Veiculo);

            //if (carga.VeiculosVinculados != null)
            //    veiculos.AddRange(carga.VeiculosVinculados);

            bool veiculoVinculado = false;
            int veiculosInvalidos = 0;
            Servicos.Embarcador.Veiculo.VeiculoGR servicoVeiculoGR = new Servicos.Embarcador.Veiculo.VeiculoGR(unitOfWork);

            foreach (Dominio.Entidades.Veiculo veiculo in veiculos)
            {
                veiculoVinculado = carga.VeiculosVinculados?.Contains(veiculo) ?? false;

                Dominio.ObjetosDeValor.Embarcador.GR.RetornoGR retornoGR = servicoVeiculoGR.Validar(carga, veiculo);
                if (retornoGR != null)
                {
                    carga.ProtocoloIntegracaoGR = retornoGR.Protocolo;

                    listaRetorno.Add(retornoGR);

                    if (!retornoGR.Sucesso)
                    {
                        carga.ProblemaIntegracaoGrMotoristaVeiculo = true;
                        carga.LiberadoComProblemaIntegracaoGrMotoristaVeiculo = liberarComProblema;
                    }

                    if (!string.IsNullOrWhiteSpace(retornoGR.Mensagem))
                    {
                        if (veiculosInvalidos >= 1)
                            mensagem += "|";

                        if (veiculoVinculado)
                            mensagem += " Veículo Vinculado: ";
                        else
                            mensagem += " Tração: ";

                        veiculosInvalidos++;
                        mensagem += $"{retornoGR.Mensagem} ";
                    }
                }
            }

            if (!string.IsNullOrWhiteSpace(mensagem))
                carga.MensagemProblemaIntegracaoGrMotoristaVeiculo = mensagem;

            return listaRetorno;
        }

        private static Dominio.ObjetosDeValor.Embarcador.GR.RetornoGR ValidarMotoristaGR(bool liberarComProblema, Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Usuario motorista, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {
            carga.ProblemaIntegracaoGrMotoristaVeiculo = false;
            carga.LiberarComProblemaAverbacao = false;

            Dominio.ObjetosDeValor.Embarcador.GR.RetornoGR retornoGR = new Servicos.Embarcador.Transportadores.MotoristaGR(unitOfWork).Validar(carga, motorista, tipoServicoMultisoftware);
            if (retornoGR != null)
            {
                carga.MensagemProblemaIntegracaoGrMotoristaVeiculo = retornoGR.Mensagem;
                carga.ProtocoloIntegracaoGR = retornoGR.Protocolo;

                if (!retornoGR.Sucesso)
                {
                    carga.ProblemaIntegracaoGrMotoristaVeiculo = true;
                    carga.LiberadoComProblemaIntegracaoGrMotoristaVeiculo = liberarComProblema;
                }
                else
                {
                    carga.ProblemaIntegracaoGrMotoristaVeiculo = false;
                }
            }
            return retornoGR;
        }

        private void VerificarErroAdagio(Dominio.ObjetosDeValor.Embarcador.GR.RetornoGR retornoGR, bool liberarComProblemaIntegracaoGrMotoristaVeiculo)
        {
            if (retornoGR != null && retornoGR.TipoIntegracao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Adagio && !retornoGR.Sucesso && !liberarComProblemaIntegracaoGrMotoristaVeiculo)
            {
                throw new ServicoException(retornoGR.Mensagem);
            }
        }

        private List<Dominio.Entidades.Cliente> ObterFornecedorCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pessoas.ModalidadeFornecedorPessoas repositorioModalidadeFornecedorPessoa = new Repositorio.Embarcador.Pessoas.ModalidadeFornecedorPessoas(unitOfWork);
            List<Dominio.Entidades.Embarcador.Pessoas.ModalidadeFornecedorPessoas> modalidadesFornecedor = repositorioModalidadeFornecedorPessoa.BuscarPorCliente(carga.DadosSumarizados.ClientesRemetentes.Select(x => x.CPF_CNPJ).ToList());

            return modalidadesFornecedor.Where(x => x.EnviarEmailFornecedorDadosTransporte).Select(x => x.ModalidadePessoas.Cliente).ToList();
        }

        private void AtualizarVinculoVeiculoMotorista(Dominio.Entidades.Veiculo veiculo, List<int> codigosMotoristas, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado)
        {
            Repositorio.Embarcador.Veiculos.VeiculoMotorista repVeiculoMotorista = new Repositorio.Embarcador.Veiculos.VeiculoMotorista(unitOfWork);
            if (configuracao.AtualizarVinculoVeiculoMotoristaIntegracaoCarga && veiculo != null && codigosMotoristas != null && codigosMotoristas.Count > 0)
            {
                Repositorio.Usuario repUsuario = new Repositorio.Usuario(unitOfWork);
                Dominio.Entidades.Usuario motorista = repUsuario.BuscarPorCodigo(codigosMotoristas.First());
                if (motorista != null)
                {
                    //veiculo.Motorista = motorista;
                    if (auditado != null)
                        Servicos.Auditoria.Auditoria.Auditar(auditado, veiculo, $"Removido motorista principal.", unitOfWork);
                    repVeiculoMotorista.DeletarMotoristaPrincipal(veiculo.Codigo);
                    Dominio.Entidades.Embarcador.Veiculos.VeiculoMotorista VeiculoMotoristaPrincipal = new Dominio.Entidades.Embarcador.Veiculos.VeiculoMotorista
                    {
                        CPF = motorista.CPF,
                        Motorista = motorista,
                        Nome = motorista.Nome,
                        Veiculo = veiculo,
                        Principal = true
                    };

                    repVeiculoMotorista.Inserir(VeiculoMotoristaPrincipal);
                }
            }
        }

        private static bool VerificarValorColuna(string numeroCarga, string placaVeiculo, string cpfMotorista, string nomeMotorista, string data)
        {

            if (string.IsNullOrEmpty(numeroCarga) || string.IsNullOrEmpty(placaVeiculo) || string.IsNullOrEmpty(cpfMotorista) || string.IsNullOrEmpty(nomeMotorista) || string.IsNullOrEmpty(data))
                return true;

            return false;
        }

        private static string VerificarFormatoDados(string cpf, string data)
        {

            if (cpf != null && data != null)
            {
                bool cpfValido = Utilidades.Validate.ValidarCPF(cpf);
                string[] dateFomato = data.Split('/', ' ');

                if (!cpfValido)
                    return "Formato CPF invalido";

                if (dateFomato.Length < 3)
                    return "Formato de data invalida";

                int dia = Int32.Parse(dateFomato[0]);
                int mes = Int32.Parse(dateFomato[1]);
                int ano = Int32.Parse(dateFomato[2]);

                if (dia < 0 || dia > 31 || mes < 0 || mes > 12 || ano < 1000 || ano > 9999)
                    return "Formato de data invalida";
            }

            return null;
        }

        private bool PossuiMesmaOrigemEDestino(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);

            Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmissaoCTeDocumentos tipoEmissaoCTeDocumentos = cargaPedidos.Select(o => o.TipoRateio).FirstOrDefault();

            if (tipoEmissaoCTeDocumentos == TipoEmissaoCTeDocumentos.EmitePorPedidoAgrupado || tipoEmissaoCTeDocumentos == TipoEmissaoCTeDocumentos.EmitePorPedidoIndividual)
                return repCargaPedido.PossuiMesmaOrigemEDestino(carga.Codigo);
            else
            {
                foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargaPedidos)
                {
                    Dominio.Entidades.Cliente expedidor = null, recebedor = null;

                    if (cargaPedido.TipoEmissaoCTeParticipantes == TipoEmissaoCTeParticipantes.ComExpedidor || cargaPedido.TipoEmissaoCTeParticipantes == TipoEmissaoCTeParticipantes.ComExpedidorERecebedor)
                        expedidor = cargaPedido.Expedidor;

                    if (cargaPedido.TipoEmissaoCTeParticipantes == TipoEmissaoCTeParticipantes.ComRecebedor || cargaPedido.TipoEmissaoCTeParticipantes == TipoEmissaoCTeParticipantes.ComExpedidorERecebedor)
                        recebedor = cargaPedido.Recebedor;

                    if (expedidor != null && recebedor != null && expedidor.Localidade?.Codigo == recebedor.Localidade?.Codigo)
                        return true;

                    if (repPedidoXMLNotaFiscal.ExisteComMesmaLocalidadePorCargaPedido(cargaPedido.Codigo, expedidor?.Localidade?.Codigo, recebedor?.Localidade?.Codigo))
                        return true;
                }
            }

            return false;
        }

        public void ObterDadosVeiculosEMotoristasExternal1(ref Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            if (string.IsNullOrEmpty(carga.ExternalID1) || carga.TipoOperacao == null || !(carga.TipoOperacao?.ConfiguracaoCarga?.HerdarDadosDeTransporteCargaPrimeiroTrecho ?? false))
                return;

            Repositorio.Embarcador.Cargas.Carga repositorioCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            List<Dominio.Entidades.Embarcador.Cargas.Carga> existeCargaExternalIgual = repositorioCarga.BuscarCargasPorExternalID1(carga.ExternalID1);
            Servicos.Embarcador.Carga.MensagemAlertaCarga servicoMensagemAlerta = new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork);

            if (existeCargaExternalIgual == null || existeCargaExternalIgual.Count == 0)
                return;

            List<Dominio.Entidades.Usuario> motoristas = carga.Motoristas.ToList();
            Dominio.Entidades.Veiculo veiculo = carga.Veiculo;
            List<Dominio.Entidades.Veiculo> veiculosVinculados = carga.VeiculosVinculados != null && carga.VeiculosVinculados.Count() > 0 ? carga.VeiculosVinculados.ToList() : null;

            if (veiculo == null || motoristas == null || motoristas.Count == 0)
                return;

            foreach (Dominio.Entidades.Embarcador.Cargas.Carga cargaDiferente in existeCargaExternalIgual)
            {
                cargaDiferente.VeiculosVinculados = veiculosVinculados;
                cargaDiferente.Motoristas = motoristas;
                cargaDiferente.Veiculo = veiculo;
                servicoMensagemAlerta.Confirmar(cargaDiferente, TipoMensagemAlerta.NaoPodeHerdarDadosTransporte);
                repositorioCarga.Atualizar(cargaDiferente);
            }

        }

        public void ConfirmarPendenciasTipoOperacao(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            if (carga == null || carga.TipoOperacao == null)
                return;

            new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork).Confirmar(carga, TipoMensagemAlerta.ProblemaComTipoOperacao);

            if (carga.Veiculo != null)
                new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork).Confirmar(carga, TipoMensagemAlerta.ProblemaComTipoOperacao);
        }

        public void AlterarCentroResultadoCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Financeiro.CentroResultado centroResultado, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCTe repCargaCTe = new Repositorio.Embarcador.Cargas.CargaCTe(unitOfWork);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new ConhecimentoDeTransporteEletronico(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos = repCargaPedido.BuscarPedidosPorCarga(carga.Codigo);
            List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> ctes = repCargaCTe.BuscarCTePorCarga(carga.Codigo);

            foreach (Dominio.Entidades.ConhecimentoDeTransporteEletronico cte in ctes)
            {
                cte.Initialize();

                cte.CentroResultadoFaturamento = centroResultado;

                repCTe.Atualizar(cte, auditado);
            }

            foreach (Dominio.Entidades.Embarcador.Pedidos.Pedido pedido in pedidos)
            {
                pedido.Initialize();

                pedido.CentroResultado = centroResultado;

                repPedido.Atualizar(pedido, auditado);
            }

            Servicos.Auditoria.Auditoria.Auditar(auditado, carga, $"Alterou o centro de resultado para {centroResultado.Descricao}.", unitOfWork);
        }

        public void AlterarCentroResultadoPedidoCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.ObjetosDeValor.Embarcador.Carga.CargaDadosTransporte dadosTransporte, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);
            Repositorio.Embarcador.Financeiro.CentroResultado repCentroResultado = new Repositorio.Embarcador.Financeiro.CentroResultado(unitOfWork);

            Dominio.Entidades.Embarcador.Financeiro.CentroResultado centroResultado = repCentroResultado.BuscarPorCodigo(dadosTransporte.CodigoCentroResultado);

            if (centroResultado == null)
                return;

            List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos = repCargaPedido.BuscarPedidosPorCarga(carga.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.Pedido pedido in pedidos)
            {
                pedido.Initialize();

                pedido.CentroResultado = centroResultado;

                repPedido.Atualizar(pedido, auditado);
            }

            Servicos.Auditoria.Auditoria.Auditar(auditado, carga, $"Alterou o centro de resultado para {centroResultado?.Descricao}.", unitOfWork);
        }

        public byte[] ObterPreviaCustoCarga(int codigoCarga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.PreConhecimentoDeTransporteEletronico repositorioPreCTe = new PreConhecimentoDeTransporteEletronico(unitOfWork);
            List<Dominio.Entidades.Embarcador.Cargas.CargaCTe> cargaPreCtes = repositorioPreCTe.BuscarPreCtesParaPreviaCusto(codigoCarga);

            List<Dominio.ObjetosDeValor.Embarcador.Carga.PlanilhaPreviaCusto> planilhaAgerar = new List<Dominio.ObjetosDeValor.Embarcador.Carga.PlanilhaPreviaCusto>();

            foreach (Dominio.Entidades.Embarcador.Cargas.CargaCTe linhaCargaPreCteAGerar in cargaPreCtes)
                planilhaAgerar.Add(ConverterPreCteParaDadoLinha(linhaCargaPreCteAGerar, unitOfWork));

            return Utilidades.CSV.GerarCSV(planilhaAgerar);
        }

        public void AtualizarVeiculoEMotoristasPedidos(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.Pedido repPedido = new Repositorio.Embarcador.Pedidos.Pedido(unitOfWork);

            Repositorio.Embarcador.Cargas.CargaMotorista repositorioCargaMotorista = new Repositorio.Embarcador.Cargas.CargaMotorista(unitOfWork);
            List<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> cargaMotoristas = repositorioCargaMotorista.BuscarPorCarga(carga.Codigo);

            List<Dominio.Entidades.Embarcador.Pedidos.Pedido> pedidos = repCargaPedido.BuscarPedidosPorCarga(carga.Codigo);

            if (pedidos == null)
                return;

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork).BuscarConfiguracaoPadrao();

            foreach (Dominio.Entidades.Embarcador.Pedidos.Pedido pedido in pedidos)
            {
                pedido.Initialize();

                if (((carga?.Veiculo ?? null) != null) || (carga.VeiculosVinculados != null && carga.VeiculosVinculados.Count > 0))
                {
                    if (configuracaoTMS.PermitirSelecionarReboquePedido)
                        pedido.VeiculoTracao = carga?.Veiculo ?? null;
                    else
                    {
                        if (pedido.Veiculos == null)
                            pedido.Veiculos = new List<Dominio.Entidades.Veiculo>();

                        if (pedido.Veiculos != null && pedido.Veiculos.Count > 0)
                            pedido.Veiculos.Clear();

                        if (carga.VeiculosVinculados != null && carga.VeiculosVinculados.Count > 0)
                            foreach (Dominio.Entidades.Veiculo veiculo in carga.VeiculosVinculados)
                                pedido.Veiculos.Add(veiculo);

                        if (carga?.Veiculo != null)
                            pedido.Veiculos.Add(carga?.Veiculo);
                    }
                }

                if ((carga?.ModeloVeicularCarga ?? null) != null)
                    pedido.ModeloVeicularCarga = carga?.ModeloVeicularCarga ?? null;

                if (cargaMotoristas != null && cargaMotoristas.Count > 0)
                {
                    if (pedido.Motoristas == null)
                        pedido.Motoristas = new List<Dominio.Entidades.Usuario>();

                    if (pedido.Motoristas != null && pedido.Motoristas.Count > 0)
                        pedido.Motoristas.Clear();

                    foreach (Dominio.Entidades.Embarcador.Cargas.CargaMotorista cargaMotorista in cargaMotoristas)
                        pedido.Motoristas.Add(cargaMotorista.Motorista);
                }
                else if (carga.Motoristas != null && carga.Motoristas.Count > 0)
                {
                    if (pedido.Motoristas == null)
                        pedido.Motoristas = new List<Dominio.Entidades.Usuario>();

                    if (pedido.Motoristas != null && pedido.Motoristas.Count > 0)
                        pedido.Motoristas.Clear();

                    if (carga.Motoristas != null && carga.Motoristas.Count > 0)
                        foreach (Dominio.Entidades.Usuario motorista in carga.Motoristas)
                            pedido.Motoristas.Add(motorista);
                }

                repPedido.Atualizar(pedido);

                Servicos.Auditoria.Auditoria.Auditar(auditado, pedido, pedido.GetChanges(), "Atualizado ao alterar dados da carga", unitOfWork);
            }
        }

        private Dominio.ObjetosDeValor.Embarcador.Carga.PlanilhaPreviaCusto ConverterPreCteParaDadoLinha(Dominio.Entidades.Embarcador.Cargas.CargaCTe preCte, Repositorio.UnitOfWork unitOfWork)
        {
            Dominio.ObjetosDeValor.Embarcador.Carga.PlanilhaPreviaCusto previaCustoPlanilha = new Dominio.ObjetosDeValor.Embarcador.Carga.PlanilhaPreviaCusto();
            Repositorio.Embarcador.Transportadores.TransportadorConfiguracaoNFSe repTransportadorConfiguracaoNFSe = new Repositorio.Embarcador.Transportadores.TransportadorConfiguracaoNFSe(unitOfWork);
            Repositorio.Embarcador.Pedidos.Stage repositorioStage = new Repositorio.Embarcador.Pedidos.Stage(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe repositorioCargaPedidoCategaCte = new Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe(unitOfWork);

            Dominio.Entidades.Embarcador.Pedidos.Stage etapa = repositorioStage.BuscarPrimeiraPorCarga(preCte.Carga.Codigo);
            Dominio.Entidades.Embarcador.Transportadores.TransportadorConfiguracaoNFSe transportadorConfiguracaoNFSe = repTransportadorConfiguracaoNFSe.BuscarPorEmpresa(preCte.PreCTe.Empresa.Codigo);
            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedido = repositorioCargaPedidoCategaCte.BuscarCargaPedidoPorCargaCTe(preCte.Codigo);
            Dominio.Entidades.Embarcador.Pedidos.Pedido pedidoPrincipal = cargaPedido.Select(x => x.Pedido).FirstOrDefault();

            previaCustoPlanilha.CNPJFilialPedido = pedidoPrincipal?.Filial?.CNPJ_Formatado;
            previaCustoPlanilha.CodigoIntegracaoFilialPedido = pedidoPrincipal?.Filial?.CodigoFilialEmbarcador;
            previaCustoPlanilha.DescricaoFilialPedido = pedidoPrincipal.Filial?.Descricao;

            previaCustoPlanilha.CodigoIntegraoTransportador = preCte.Carga.Empresa?.CodigoIntegracao;
            previaCustoPlanilha.RazaoSocialTransportadorVinculado = preCte.Carga.Empresa?.Descricao;

            previaCustoPlanilha.NumeroCarga = preCte.Carga.Numero ?? string.Empty;
            previaCustoPlanilha.NumeroEtapa = etapa?.NumeroStage ?? string.Empty;
            previaCustoPlanilha.CodigoIntegraoTransportador = preCte.Carga.Empresa?.CodigoIntegracao;
            previaCustoPlanilha.RazaoSocialTransportadorVinculado = preCte.Carga.Empresa?.Descricao;
            previaCustoPlanilha.DataCarregamento = preCte.Carga.DataCarregamentoCarga?.ToString("dd/MM/yyyy") ?? string.Empty;
            previaCustoPlanilha.PlacaTracao = preCte.Carga.Veiculo?.Placa;
            previaCustoPlanilha.PlacasReboques = string.Join(", ", preCte.Carga.VeiculosVinculados.Select(v => v.Placa).ToList());
            previaCustoPlanilha.CanalVenda = etapa?.CanalVenda?.Descricao ?? string.Empty;
            previaCustoPlanilha.ModalTransporte = etapa?.TipoModal.ObterDescricao() ?? string.Empty;
            previaCustoPlanilha.CodigoIntegracaoTipoCarga = preCte.Carga.TipoDeCarga?.CodigoTipoCargaEmbarcador;
            previaCustoPlanilha.CodigoIntegracaoModeloVeicular = preCte.Carga.ModeloVeicularCarga?.CodigoIntegracao;

            previaCustoPlanilha.NumeroNfe = string.Join(", ", preCte.NotasFiscais.Select(s => s.PedidoXMLNotaFiscal.XMLNotaFiscal.Numero).ToList());
            previaCustoPlanilha.DataEmisaoNFe = preCte.NotasFiscais.FirstOrDefault().PedidoXMLNotaFiscal.XMLNotaFiscal.DataEmissao.ToString("dd/MM/yyyy");
            previaCustoPlanilha.PesoBruto = preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.Peso).Sum();

            previaCustoPlanilha.CodigoIntegracaoModeloVeicular = preCte.Carga.ModeloVeicularCarga?.CodigoIntegracao;
            previaCustoPlanilha.NumeroVolumen = preCte.PreCTe.NumeroColeta; //Verificar
            previaCustoPlanilha.ValorMercaduria = preCte.PreCTe.ValorTotalMercadoria;
            previaCustoPlanilha.Frete = preCte.PreCTe.ValorFrete;
            previaCustoPlanilha.AdValorem = preCte.Componentes.Where(c => c.ComponenteFrete != null && c.ComponenteFrete.TipoComponenteFrete == TipoComponenteFrete.ADVALOREM).Select(c => (decimal?)c.ValorComponente).Sum() ?? 0m;
            previaCustoPlanilha.GRIS = "0";
            previaCustoPlanilha.ValorOutrosCompoentes = preCte.Componentes.Where(c => c.ComponenteFrete != null && c.ComponenteFrete.TipoComponenteFrete != TipoComponenteFrete.ADVALOREM && c.ComponenteFrete.TipoComponenteFrete != TipoComponenteFrete.DESCARGA && c.ComponenteFrete.TipoComponenteFrete != TipoComponenteFrete.ICMS && c.ComponenteFrete.TipoComponenteFrete != TipoComponenteFrete.ISS).Select(c => (decimal?)c.ValorComponente).Sum() ?? 0m;
            previaCustoPlanilha.TaxaDescarga = preCte.Componentes.Where(c => c.ComponenteFrete != null && c.ComponenteFrete.TipoComponenteFrete == TipoComponenteFrete.DESCARGA).Select(c => (decimal?)c.ValorComponente).Sum() ?? 0m;
            previaCustoPlanilha.BaseCalculoISS = preCte.PreCTe.BaseCalculoISS;
            previaCustoPlanilha.AliquotaISS = preCte.PreCTe.AliquotaISS;
            previaCustoPlanilha.ValorISS = preCte.PreCTe.ValorISS;
            previaCustoPlanilha.BaseCalculoICMS = preCte.PreCTe.BaseCalculoICMS;
            previaCustoPlanilha.ValorICMS = preCte.PreCTe.ValorICMS;
            previaCustoPlanilha.AliquotaICMS = preCte.PreCTe.AliquotaICMS;
            previaCustoPlanilha.ValorTotalFrete = preCte.PreCTe.ValorAReceber;
            previaCustoPlanilha.ChavesNotas = string.Join(", ", preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.Chave).ToList());
            previaCustoPlanilha.ISSRetido = preCte.PreCTe.ISSRetido == true ? "Sim" : "Não";

            //Destinatario
            previaCustoPlanilha.CNP_CPF = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Destinatario.CPF_CNPJ_Formatado).Distinct().ToList());
            previaCustoPlanilha.IE = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Destinatario?.IE_RG).Distinct().ToList());
            previaCustoPlanilha.RazaoSocial = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Destinatario?.Descricao).Distinct().ToList());
            previaCustoPlanilha.Telefone = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Destinatario?.Telefone1).Distinct().ToList());
            previaCustoPlanilha.Endereco = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Destinatario?.Endereco).Distinct().ToList());
            previaCustoPlanilha.Numero = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Destinatario?.Numero).Distinct().ToList());
            previaCustoPlanilha.Complemento = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Destinatario?.Complemento).Distinct().ToList());
            previaCustoPlanilha.Bairro = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Destinatario?.Bairro).Distinct().ToList());
            previaCustoPlanilha.CodigoIBGECidade = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Destinatario?.Localidade?.CodigoIBGE).Distinct().ToList());
            previaCustoPlanilha.DescricaoCidade = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Destinatario?.Localidade?.Descricao).Distinct().ToList());
            previaCustoPlanilha.CEP = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Destinatario?.CEP).Distinct().ToList());
            previaCustoPlanilha.UF = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Destinatario?.Localidade?.Descricao).Distinct().ToList());
            previaCustoPlanilha.CodigoPais = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Destinatario?.Pais?.Codigo).Distinct().ToList());
            previaCustoPlanilha.DescricaoPais = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Destinatario?.Pais?.Descricao).Distinct().ToList());

            //Emissor
            previaCustoPlanilha.CNPJ_CPFEmissoNota = string.Join(", ", preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal?.Emitente?.CPF_CNPJ_Formatado).ToList());
            previaCustoPlanilha.IEEmissoNota = string.Join(", ", preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.Emitente.IE_RG).ToList());
            previaCustoPlanilha.RazaoSocialEmissoNota = string.Join(", ", preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.Emitente?.Descricao).ToList());
            previaCustoPlanilha.TelefoneEmissoNota = string.Join(", ", preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.Emitente?.Telefone1).ToList());
            previaCustoPlanilha.EnderecoEmissoNota = string.Join(", ", preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.Emitente?.Endereco).ToList());
            previaCustoPlanilha.NumeroEmissoNota = string.Join(", ", preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.Emitente?.Numero).ToList());
            previaCustoPlanilha.ComplementoEmissoNota = string.Join(", ", preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.Emitente?.Complemento).ToList());
            previaCustoPlanilha.BairroEmissoNota = string.Join(", ", preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.Emitente?.Bairro).ToList());
            previaCustoPlanilha.CodigoIBGECidadeEmissoNota = string.Join(", ", preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.Emitente?.Localidade?.CodigoIBGE).ToList());
            previaCustoPlanilha.DescricaoCidadeEmissoNota = string.Join(", ", preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.Emitente?.Localidade?.DescricaoCidadeEstado).ToList());
            previaCustoPlanilha.CEPEmissoNota = string.Join(", ", preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.Emitente?.CEP).ToList());
            previaCustoPlanilha.UFEmissoNota = string.Join(", ", preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.Emitente.Localidade?.Descricao).ToList());
            previaCustoPlanilha.CodigoPaisEmissoNota = string.Join(", ", preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.Emitente?.Pais?.Codigo).ToList());
            previaCustoPlanilha.DescricaoPaisEmissoNota = string.Join(", ", preCte.NotasFiscais.Select(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.Emitente?.Pais?.Descricao).ToList());

            //tomador
            previaCustoPlanilha.CNPJ_CPFTomadorFrete = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Tomador?.CPF_CNPJ_Formatado).ToList());
            previaCustoPlanilha.IETomadorFrete = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Tomador?.IE_RG).ToList());
            previaCustoPlanilha.RazaoSocialTomadorFrete = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Tomador?.Descricao).ToList());
            previaCustoPlanilha.TelefoneTomadorFrete = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Tomador?.Telefone1).ToList());
            previaCustoPlanilha.EnderecoTomadorFrete = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Tomador?.Endereco).ToList());
            previaCustoPlanilha.NumeroTomadorFrete = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Tomador?.Numero).ToList());
            previaCustoPlanilha.ComplementoTomadorFrete = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Tomador?.Complemento).ToList());
            previaCustoPlanilha.BairroTomadorFrete = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Tomador?.Bairro).ToList());
            previaCustoPlanilha.CodigoIBGECidadeTomadorFrete = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Tomador?.Localidade?.CodigoIBGE).ToList());
            previaCustoPlanilha.DescricaoCidadeTomadorFrete = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Tomador?.Localidade?.Descricao).ToList());
            previaCustoPlanilha.CEPTomadorFrete = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Tomador?.CEP).ToList());
            previaCustoPlanilha.UFTomadorFrete = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Tomador?.Localidade?.Descricao).ToList());
            previaCustoPlanilha.CodigoPaisTomadorFrete = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Tomador?.Pais?.Codigo).ToList());
            previaCustoPlanilha.DescricaoPaisTomadorFrete = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Tomador?.Pais?.Descricao).ToList());
            previaCustoPlanilha.TipoTomador = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.TipoTomador).ToList());

            //recebedor
            previaCustoPlanilha.CNPJ_CPFRecebedor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Recebedor?.CPF_CNPJ_Formatado).ToList());
            previaCustoPlanilha.IERecebedor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Recebedor?.IE_RG).ToList());
            previaCustoPlanilha.TelefoneRecebedor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Recebedor?.Telefone1).ToList());
            previaCustoPlanilha.EnderecoRecebedor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Recebedor?.Endereco).ToList());
            previaCustoPlanilha.NumeroRecebedor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Recebedor?.Numero).ToList());
            previaCustoPlanilha.ComplementoRecebedor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Recebedor?.Complemento).ToList());
            previaCustoPlanilha.BairroRecebedor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido.Recebedor?.Bairro).ToList());
            previaCustoPlanilha.CodigoIBGECidadeRecebedor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Recebedor?.Localidade?.CodigoIBGE).ToList());
            previaCustoPlanilha.DescricaoCidadeRecebedor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Recebedor?.Localidade?.Descricao).ToList());
            previaCustoPlanilha.CEPRecebedor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Recebedor?.CEP).ToList());
            previaCustoPlanilha.UFRecebedor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Recebedor?.Localidade?.Descricao).ToList());
            previaCustoPlanilha.CodigoPaisRecebedor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Recebedor?.Pais?.Codigo).ToList());
            previaCustoPlanilha.DescricaoPaisRecebedor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Recebedor?.Pais?.Descricao).ToList());

            //Transportador
            previaCustoPlanilha.CNPJ_CPFRecebedor = preCte.Carga.Empresa?.CNPJ_Formatado;
            previaCustoPlanilha.IERecebedor = preCte.Carga.Empresa?.InscricaoEstadual ?? string.Empty;
            previaCustoPlanilha.TelefoneRecebedor = preCte.Carga.Empresa?.Telefone ?? string.Empty;
            previaCustoPlanilha.EnderecoRecebedor = preCte.Carga.Empresa?.Endereco ?? string.Empty;
            previaCustoPlanilha.NumeroRecebedor = preCte.Carga.Empresa?.Numero ?? string.Empty;
            previaCustoPlanilha.ComplementoRecebedor = preCte.Carga.Empresa?.Complemento ?? string.Empty;
            previaCustoPlanilha.BairroRecebedor = preCte.Carga.Empresa?.Bairro;
            previaCustoPlanilha.CodigoIBGECidadeRecebedor = preCte.Carga.Empresa?.Localidade.CodigoIBGE.ToString();
            previaCustoPlanilha.DescricaoCidadeRecebedor = preCte.Carga.Empresa?.Localidade?.Descricao;
            previaCustoPlanilha.CEPRecebedor = preCte.Carga.Empresa?.CEP;
            previaCustoPlanilha.UFRecebedor = preCte.Carga.Empresa?.LocalidadeUF;
            previaCustoPlanilha.CodigoPaisRecebedor = preCte.Carga.Empresa?.Pais?.Codigo.ToString();
            previaCustoPlanilha.DescricaoPaisRecebedor = preCte.Carga.Empresa?.Pais?.Descricao;

            //recebedor
            previaCustoPlanilha.CNPJ_CPFExpedidor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Expedidor?.CPF_CNPJ_Formatado).ToList());
            previaCustoPlanilha.IEExpedidor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Expedidor?.IE_RG).ToList());
            previaCustoPlanilha.TelefoneExpedidor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Expedidor?.Telefone1).ToList());
            previaCustoPlanilha.EnderecoExpedidor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Expedidor?.Endereco).ToList());
            previaCustoPlanilha.NumeroExpedidor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Expedidor?.Numero).ToList());
            previaCustoPlanilha.ComplementoExpedidor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Expedidor?.Complemento).ToList());
            previaCustoPlanilha.BairroExpedidor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Expedidor?.Bairro).ToList());
            previaCustoPlanilha.CodigoIBGECidadeExpedidor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Expedidor?.Localidade?.CodigoIBGE).ToList());
            previaCustoPlanilha.DescricaoCidadeExpedidor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Expedidor?.Localidade?.Descricao).ToList());
            previaCustoPlanilha.CEPExpedidor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Expedidor?.CEP).ToList());
            previaCustoPlanilha.UFExpedidor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Expedidor?.Localidade?.Descricao).ToList());
            previaCustoPlanilha.CodigoPaisExpedidor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Expedidor?.Pais?.Codigo).ToList());
            previaCustoPlanilha.DescricaoPaisExpedidor = string.Join(", ", preCte.Carga.Pedidos.Select(p => p.Pedido?.Expedidor?.Pais?.Descricao).ToList());

            previaCustoPlanilha.NumerosNotasPreCte = string.Join(", ", preCte.NotasFiscais.Select(s => s.PedidoXMLNotaFiscal?.XMLNotaFiscal?.Numero).ToList());

            return previaCustoPlanilha;
        }

        private void CriarPendenciaTipoOperacaoNaCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Servicos.Embarcador.Carga.MensagemAlertaCarga servisoMensagemAlerta = new Servicos.Embarcador.Carga.MensagemAlertaCarga(unitOfWork);
            List<Dominio.ObjetosDeValor.Embarcador.Alertas.MensagemAlerta> existeMensagems = servisoMensagemAlerta.ObterMensagensPorEntidades(new List<int> { carga.Codigo });

            if ((existeMensagems == null || existeMensagems.Count == 0) || !existeMensagems.Any(m => m.Tipo == TipoMensagemAlerta.ProblemaComTipoOperacao))
                servisoMensagemAlerta.Adicionar(carga, TipoMensagemAlerta.ProblemaComTipoOperacao, $"Por que não foi encontrada uma regra valida para um tipo operação");
        }

        public void CriarIntegracaoesCargaFrete(ref Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repositorioCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoStage repositorioPedidoStage = new Repositorio.Embarcador.Pedidos.PedidoStage(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaFreteIntegracao repositorioCargaFreteIntegracao = new Repositorio.Embarcador.Cargas.CargaFreteIntegracao(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repositorioNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.StageAgrupamento repStageAgrupamento = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);
            Repositorio.Embarcador.Configuracoes.Integracao repConfiguracaoIntegracao = new Repositorio.Embarcador.Configuracoes.Integracao(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracoes.Integracao configuracaoIntegracao = repConfiguracaoIntegracao.Buscar();
            List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao> tiposPermitidos = new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao>() {
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Unilever,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.UnileverLinkNotas,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Raster,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Cebrace,
            };

            foreach (Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao tipoIntegracao in tiposPermitidos)
            {
                //carga mae do consolidado vai gerar integracao de linkNotas ao confirmar ctes.
                if (tipoIntegracao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.UnileverLinkNotas && carga.TipoOperacao?.TipoConsolidacao == EnumTipoConsolidacao.PreCheckIn)
                    continue;

                if (tipoIntegracao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Unilever || tipoIntegracao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.UnileverLinkNotas)
                {
                    if (CenarioIntegracaoConfigurado(ref carga, unitOfWork, tipoIntegracao))
                    {
                        //ver com victor pq esse if do ExigeNotaFiscalParaCalcularFrete..
                        if (!carga.TipoOperacao.ExigeNotaFiscalParaCalcularFrete || carga.DadosSumarizados.CargaTrecho == CargaTrechoSumarizada.SubCarga)
                        {
                            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargasPedido = repositorioCargaPedido.BuscarPorCarga(carga.Codigo);
                            foreach (Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido in cargasPedido)
                            {
                                if (cargaPedido.NotasFiscais.Count == 0)
                                    continue;

                                Dominio.Entidades.Embarcador.Pedidos.Stage stagePorPedido = repositorioPedidoStage.BuscarStagePorCargaPedido(cargaPedido.Codigo);

                                if (stagePorPedido == null && carga.DadosSumarizados?.CargaTrecho == CargaTrechoSumarizada.SubCarga)//carga filho de pre-checkin
                                {
                                    Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento stageAgrupamento = repStageAgrupamento.BuscarPorCargaGerada(carga.Codigo).FirstOrDefault();
                                    stagePorPedido = repositorioPedidoStage.BuscarRelevantesCustoPorPedidoECargaPai(cargaPedido.Pedido.Codigo, stageAgrupamento.CargaDT.Codigo);

                                    if (stagePorPedido == null)
                                        continue;
                                }

                                Dominio.Entidades.Embarcador.Cargas.CargaFreteIntegracao existeRegistro = repositorioCargaFreteIntegracao.BuscarPorStageECarga(stagePorPedido?.Codigo ?? 0, carga.Codigo, tipoIntegracao);

                                if (existeRegistro == null)
                                {
                                    CriarRegistroIntegracaoCargaFrete(cargaPedido.Carga, unitOfWork, tipoIntegracao, stagePorPedido, repositorioNotaFiscal.BuscarChavesNotasPorStage(stagePorPedido?.Codigo ?? 0));
                                    continue;
                                }

                                if (tipoIntegracao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.UnileverLinkNotas)
                                {
                                    List<string> chaves = repositorioNotaFiscal.BuscarChavesNotasPorStage(stagePorPedido.Codigo);

                                    if (!existeRegistro.ChavesNotasIntegradas.Any(x => chaves.Contains(x)))
                                        CriarRegistroIntegracaoCargaFrete(cargaPedido.Carga, unitOfWork, tipoIntegracao, stagePorPedido, repositorioNotaFiscal.BuscarChavesNotasPorStage(stagePorPedido.Codigo));
                                }
                                else if (tipoIntegracao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Unilever)
                                {
                                    existeRegistro.DataIntegracao = DateTime.Now;
                                    existeRegistro.NumeroTentativas = 0;
                                    existeRegistro.ProblemaIntegracao = "";
                                    existeRegistro.SituacaoIntegracao = SituacaoIntegracao.AgIntegracao;

                                    repositorioCargaFreteIntegracao.Atualizar(existeRegistro);
                                }
                            }
                            continue;
                        }
                        CriarRegistroIntegracaoCargaFrete(carga, unitOfWork, tipoIntegracao, null, new List<string>());
                    }
                }
                else if (tipoIntegracao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Raster)
                {
                    if ((configuracaoIntegracao?.GerarIntegracaoPreSmEtapaCargaDadosTransporteRaster ?? false) && (configuracaoIntegracao?.GerarIntegracaoEfetivaPreSmEtapaCargaFreteRaster ?? false) && (carga.TipoOperacao?.PossuiIntegracaoRaster ?? false))
                        CriarRegistroIntegracaoCargaFrete(carga, unitOfWork, tipoIntegracao, null, null);
                }
                else if (tipoIntegracao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Cebrace)
                {
                    if (!carga.ExigeNotaFiscalParaCalcularFrete && carga.SituacaoCarga != SituacaoCarga.AgNFe)
                    {
                        CriarRegistroIntegracaoCargaFrete(carga, unitOfWork, tipoIntegracao, null, null, true);
                    }
                }
                else
                    CriarRegistroIntegracaoCargaFrete(carga, unitOfWork, tipoIntegracao, null, null);
            }
        }

        public void CriarRegistroIntegracaoConsolidado(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, TipoServicoMultisoftware tipoServicoMultisoftware, string webServiceConsultaCTe)
        {
            //Aqui vamos gerar registros de integracao para LinkNotas e Relevancia das cargas mae do consolidado, apenas se todos os CTES estao com status autorizados

            if (carga.TipoOperacao?.TipoConsolidacao != EnumTipoConsolidacao.PreCheckIn)
                return;

            Repositorio.Embarcador.Cargas.CargaCTe repCargaCTe = new Repositorio.Embarcador.Cargas.CargaCTe(unitOfWork);
            Repositorio.Embarcador.Pedidos.StageAgrupamento repStageAgrupamento = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaFreteIntegracao repositorioCargaFreteIntegracao = new Repositorio.Embarcador.Cargas.CargaFreteIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoIntegracao repositorioTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaCargaIntegracao repCargaIntegracao = new Repositorio.Embarcador.Cargas.CargaCargaIntegracao(unitOfWork);

            List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao> TiposPermitidos = new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao>() {
            Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.UnileverRelevanciaCustos ,
            Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.UnileverLinkNotas,
            Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Unilever
            };

            if (carga.TipoOperacao?.TipoConsolidacao == EnumTipoConsolidacao.PreCheckIn)
            {
                //só deve enviar se todos os ctes (inclusive das filhos) ja estao confirmados ou recusaReprovada ou sem regra aprovacao
                List<Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento> agrupamentos = repStageAgrupamento.BuscarPorCargaDt(carga.Codigo);

                foreach (Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento agrupamento in agrupamentos)
                    if (agrupamento.CargaGerada == null)//nao tem carga, nao tem CargaCte da filho.
                        return;

                if (repCargaCTe.CargaPossuiCtesInviaveisParaIntegracao(carga.Codigo))
                    return;
            }

            foreach (Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao tipoIntegracao in TiposPermitidos)
            {
                Dominio.Entidades.Embarcador.Cargas.TipoIntegracao existeTipoIntegracao = repositorioTipoIntegracao.BuscarPorTipo(tipoIntegracao);

                if (CenarioIntegracaoConfigurado(ref carga, unitOfWork, tipoIntegracao))
                {
                    if (tipoIntegracao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.UnileverRelevanciaCustos)
                    {
                        Dominio.Entidades.Embarcador.Cargas.CargaCargaIntegracao cargaIntegracao = new Dominio.Entidades.Embarcador.Cargas.CargaCargaIntegracao();
                        cargaIntegracao.Carga = carga;
                        cargaIntegracao.DataIntegracao = DateTime.Now;
                        cargaIntegracao.NumeroTentativas = 0;
                        cargaIntegracao.ProblemaIntegracao = "";
                        cargaIntegracao.SituacaoIntegracao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoIntegracao.AgIntegracao;
                        cargaIntegracao.TipoIntegracao = existeTipoIntegracao;
                        cargaIntegracao.IntegracaoColeta = false;
                        cargaIntegracao.RealizarIntegracaoCompleta = false;
                        cargaIntegracao.Stage = null;

                        repCargaIntegracao.Inserir(cargaIntegracao);
                    }
                    else if (tipoIntegracao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.UnileverLinkNotas)
                    {

                        Dominio.Entidades.Embarcador.Cargas.CargaFreteIntegracao novoCargaFreteIntegracao = new Dominio.Entidades.Embarcador.Cargas.CargaFreteIntegracao()
                        {
                            TipoIntegracao = existeTipoIntegracao,
                            Carga = carga,
                            Stage = null,
                            NumeroTentativas = 0,
                            SituacaoIntegracao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoIntegracao.AgIntegracao,
                            DataIntegracao = DateTime.Now,
                            ProblemaIntegracao = "",
                            ChavesNotasIntegradas = null
                        };

                        repositorioCargaFreteIntegracao.Inserir(novoCargaFreteIntegracao);

                        new Servicos.Embarcador.Integracao.Unilever.IntegracaoUnilever(unitOfWork).IntegrarLinkNotas(novoCargaFreteIntegracao, unitOfWork, auditado, tipoServicoMultisoftware, webServiceConsultaCTe);
                    }
                    else if (tipoIntegracao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Unilever)
                    {
                        Dominio.Entidades.Embarcador.Cargas.CargaFreteIntegracao cargaFreteIntegracao = repositorioCargaFreteIntegracao.BuscarPorCargaETipoIntegracao(carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Unilever);
                        if (cargaFreteIntegracao != null && cargaFreteIntegracao.SituacaoIntegracao == SituacaoIntegracao.AgIntegracao)
                            new Servicos.Embarcador.Integracao.Unilever.IntegracaoUnilever(unitOfWork).IntegrarCargaFrete(cargaFreteIntegracao, unitOfWork, auditado, tipoServicoMultisoftware, webServiceConsultaCTe);
                    }
                }
            }

            new Servicos.Embarcador.Integracao.IntegracaoCarga(unitOfWork).IniciarIntegracoesComDocumentos(carga, unitOfWork, tipoServicoMultisoftware);
        }

        public void AvancarEtapaSubCargasConsolidado(Dominio.Entidades.Embarcador.Cargas.Carga cargaDT, Dominio.Entidades.Embarcador.Cargas.CargaCTe cargaCTe, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, TipoServicoMultisoftware tipoServicoMultisoftware, string webServiceConsultaCTe)
        {
            //aqui avança as cargas de Transferencia e cargas de Entrega para etapa CTE (filhas do consolidado)

            if (cargaDT.TipoOperacao?.TipoConsolidacao != EnumTipoConsolidacao.PreCheckIn)
                return;

            Repositorio.Embarcador.Cargas.CargaCTe repCargaCTe = new Repositorio.Embarcador.Cargas.CargaCTe(unitOfWork);
            Repositorio.Embarcador.Pedidos.StageAgrupamento repStageAgrupamento = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);
            Repositorio.Embarcador.Pedidos.Stage repStage = new Repositorio.Embarcador.Pedidos.Stage(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Cargas.CargaPedidoRecusaCTE repCargaPedidoRecusa = new Repositorio.Embarcador.Cargas.CargaPedidoRecusaCTE(unitOfWork);

            if (repCargaCTe.CargaPossuiCtesInviaveisParaIntegracao(cargaDT.Codigo))
            {
                Servicos.Log.TratarErro($"Carga pre-chekin ainda com ctes Inviaveis Carga:  {cargaDT.Codigo} ");
                return;
            }

            //só deve enviar se todos os ctes (inclusive das filhos) ja estao confirmados ou recusaReprovada ou sem regra aprovacao
            List<Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento> agrupamentos = repStageAgrupamento.BuscarPorCargaDt(cargaDT.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento agrupamento in agrupamentos)
                if (agrupamento.CargaGerada == null)//nao tem carga, nao tem CargaCte da filho.
                    return;

            if (cargaDT.CargaEmitidaParcialmente)
            {
                cargaDT.CargaEmitidaParcialmente = false;
                cargaDT.DataConfirmacaoCtes = DateTime.Now;
                repCarga.Atualizar(cargaDT);

                Servicos.Log.TratarErro($"Carga pre-chekin emitida parcialmente false Carga:  {cargaDT.Codigo} ");
            }

            foreach (Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento agrupamento in agrupamentos)
            {
                List<Dominio.Entidades.Embarcador.Pedidos.Stage> stagesAgrupamento = repStage.BuscarporAgrupamento(agrupamento.Codigo);

                if ((stagesAgrupamento.Any(x => x.TipoPercurso == Vazio.PercursoPrincipal) || stagesAgrupamento.Any(x => x.TipoPercurso == Vazio.PercursoSubSeQuente)) && agrupamento.CargaGerada.SituacaoCarga != SituacaoCarga.PendeciaDocumentos)
                {
                    //carga de transferencia
                    agrupamento.CargaGerada.SituacaoCarga = SituacaoCarga.PendeciaDocumentos;
                    agrupamento.CargaGerada.EmitindoCTes = false;
                    agrupamento.CargaGerada.DataInicioEmissaoDocumentos = DateTime.Now;
                    agrupamento.CargaGerada.DataEnvioUltimaNFe = DateTime.Now;
                    agrupamento.CargaGerada.DataInicioGeracaoCTes = DateTime.Now;

                    repCarga.Atualizar(agrupamento.CargaGerada);
                }
            }

            //transferir o cte para as cargas de transf e entrega
            if (cargaCTe.SituacaoCheckin == SituacaoCheckin.Confirmado && repCargaPedidoRecusa.ExisteRecusaCte(cargaCTe.CTe.Codigo))
                new Servicos.Embarcador.Frete.RecusaCheckin(unitOfWork).ReplicarCteRecusadoCargaCtesConsolidado(cargaDT);

        }

        public void FinalizarCargasConsolidadoAoCancelarCargaDT(Dominio.Entidades.Embarcador.Cargas.Carga cargaDT, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            Repositorio.Embarcador.Pedidos.StageAgrupamento repStageAgrupamento = new Repositorio.Embarcador.Pedidos.StageAgrupamento(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            List<Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento> agrupamentos = repStageAgrupamento.BuscarPorCargaDt(cargaDT.Codigo);

            foreach (Dominio.Entidades.Embarcador.Pedidos.StageAgrupamento agrupamento in agrupamentos)
            {
                if (agrupamento.CargaGerada == null)//nao tem carga, nao tem CargaCte da filho.
                    continue;
                else
                {
                    agrupamento.CargaGerada.SituacaoCarga = SituacaoCarga.Cancelada;
                    agrupamento.CargaGerada.CargaFechada = false;
                    repCarga.Atualizar(agrupamento.CargaGerada);
                }
            }
        }

        public bool ConfirmarImpressaoDocumentosCarga(int codigoCarga, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoEmbarcador = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoEmbarcador = repConfiguracaoEmbarcador.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigo(codigoCarga);

            if (carga == null)
                return false;

            if (carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgImpressaoDocumentos)
            {
                carga.SituacaoCarga = configuracaoEmbarcador.SituacaoCargaAposConfirmacaoImpressao;

                if (carga.SituacaoCarga == SituacaoCarga.EmTransporte)
                {
                    new Servicos.Embarcador.SuperApp.IntegracaoNotificacaoApp(unitOfWork).GerarIntegracaoNotificacao(carga, TipoNotificacaoApp.MotoristaPodeSeguirViagem);
                    if (configuracaoEmbarcador.QuandoIniciarMonitoramento == Dominio.ObjetosDeValor.Embarcador.Enumeradores.QuandoIniciarMonitoramento.AoInformarVeiculoNaCargaECargaEmTransporte)
                        Servicos.Embarcador.Monitoramento.Monitoramento.GerarMonitoramentoEIniciar(carga, configuracaoEmbarcador, null, "Carga em transporte", unitOfWork);
                }

                Servicos.Auditoria.Auditoria.Auditar(auditado, carga, null, "Confirmou impressão dos documentos.", unitOfWork);

                repCarga.Atualizar(carga);

                return true;
            }
            else
                return false;
        }

        public void VincularDocumentoContainerVazio(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS)
        {
            Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
            Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);

            Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido = repCargaPedido.BuscarPorCarga(carga.Codigo).FirstOrDefault();

            if (cargaPedido == null)
                return;

            List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> xMLNotaFiscals = repXMLNotaFiscal.BuscarPorCargaPedidoETipoDocumentos(cargaPedido.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoDocumento.Outros).ToList();
            Servicos.Embarcador.Pedido.NotaFiscal serCargaNotaFiscal = new Servicos.Embarcador.Pedido.NotaFiscal(unitOfWork);

            if (xMLNotaFiscals == null || xMLNotaFiscals.Count() == 0)
            {
                if ((cargaPedido.Carga.TipoOperacao?.DeslocamentoVazio ?? false) && cargaPedido.Pedido.Remetente != null && cargaPedido.Pedido.Destinatario != null && !repPedidoXMLNotaFiscal.VerificarSeExistePorCargaPedido(cargaPedido.Codigo))
                {
                    Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xmlNotaFiscal = new Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal()
                    {
                        CNPJTranposrtador = "",
                        DataEmissao = DateTime.Now,
                        Descricao = "Outros",
                        Destinatario = cargaPedido.Pedido.Destinatario,
                        Emitente = cargaPedido.Pedido.Remetente,
                        Modelo = "99",
                        nfAtiva = true,
                        Numero = 1,
                        PlacaVeiculoNotaFiscal = "",
                        Serie = "",
                        TipoDocumento = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoDocumento.Outros,
                        TipoOperacaoNotaFiscal = TipoOperacaoNotaFiscal.Saida,
                        XML = "",
                        DataRecebimento = DateTime.Now,
                        Peso = 1m,
                        Valor = 1m
                    };

                    repXMLNotaFiscal.Inserir(xmlNotaFiscal);

                    serCargaNotaFiscal.InserirNotaCargaPedido(xmlNotaFiscal, cargaPedido, tipoServicoMultisoftware, TipoNotaFiscal.Venda, configuracaoTMS, false, out bool alteradoTipoDeCarga, Auditado);

                    if (Auditado != null)
                        Servicos.Auditoria.Auditoria.Auditar(Auditado, xmlNotaFiscal, "Adicionado pelo vínculo de notas fiscais dos pedidos", unitOfWork);

                    if (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS || tipoServicoMultisoftware == TipoServicoMultisoftware.MultiEmbarcador)
                    {
                        carga.ProcessandoDocumentosFiscais = true;
                        carga.DataInicioConfirmacaoDocumentosFiscais = DateTime.Now;
                        repCarga.Atualizar(carga);
                    }
                }
            }
        }
        private static void ValidarFiltroTransportadoresDescarga(List<Dominio.Entidades.Embarcador.Frete.ConfiguracaoDescargaCliente> configuracoesDescarga, Dominio.Entidades.Embarcador.Cargas.Carga carga)
        {
            List<Dominio.Entidades.Embarcador.Frete.ConfiguracaoDescargaCliente> descargasComTransportadores = configuracoesDescarga.Where(x => x.Transportadores.Count > 0).ToList();
            List<Dominio.Entidades.Embarcador.Frete.ConfiguracaoDescargaCliente> descargasComTransportadoresIncompativeis = configuracoesDescarga.Where(x => !(x.Transportadores.Select(y => y.Codigo).Contains(carga.Empresa.Codigo))).ToList();

            foreach (Dominio.Entidades.Embarcador.Frete.ConfiguracaoDescargaCliente descargaDeletar in descargasComTransportadoresIncompativeis)
            {
                configuracoesDescarga.Remove(descargaDeletar);
            }
        }

        private void GerarOcorrenciaSemTabelaFrente(Dominio.Entidades.Embarcador.Cargas.Carga carga, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            bool gerarOcorrenciaSemTabelaFrete = false;
            Dominio.Entidades.TipoDeOcorrenciaDeCTe tipoOcorrenciaSemTabelaFrete = null;

            Dominio.Entidades.Cliente tomador = cargaPedidos.FirstOrDefault()?.ObterTomador() ?? null;

            if (carga.TipoOperacao != null && carga.TipoOperacao.UsarConfiguracaoEmissao)
            {
                gerarOcorrenciaSemTabelaFrete = carga.TipoOperacao.GerarOcorrenciaSemTabelaFrete;
                tipoOcorrenciaSemTabelaFrete = carga.TipoOperacao.TipoOcorrenciaSemTabelaFrete;

            }
            else if (tomador != null)
            {
                if (tomador.NaoUsarConfiguracaoEmissaoGrupo)
                {
                    gerarOcorrenciaSemTabelaFrete = tomador.GerarOcorrenciaSemTabelaFrete;
                    tipoOcorrenciaSemTabelaFrete = tomador.TipoOcorrenciaSemTabelaFrete;
                }
                else if (tomador.GrupoPessoas != null)
                {
                    gerarOcorrenciaSemTabelaFrete = tomador.GrupoPessoas.GerarOcorrenciaSemTabelaFrete;
                    tipoOcorrenciaSemTabelaFrete = tomador.GrupoPessoas.TipoOcorrenciaSemTabelaFrete;
                }
            }

            if (gerarOcorrenciaSemTabelaFrete && tipoOcorrenciaSemTabelaFrete != null)
            {
                Servicos.Embarcador.Carga.Ocorrencia.GerarOcorrenciaAutomaticaSemTabelaFrete(carga, tipoOcorrenciaSemTabelaFrete, unitOfWork, tipoServicoMultisoftware);
            }
        }

        private static bool ValidarRecriarControleEntrega(Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTms, Repositorio.UnitOfWork unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            if (carga.ExigeNotaFiscalParaCalcularFrete && (!configuracaoTms.UtilizarRotaFreteInformadoPedido && (!carga.TipoOperacao?.ConfiguracaoCarga?.UtilizarRotaFreteInformadoPedido ?? false)) && ((carga.TipoOperacao?.ConfiguracaoMontagemCarga?.RoteirizarNovamenteAoConfirmarDocumentos ?? false) || (tipoServicoMultisoftware == TipoServicoMultisoftware.MultiTMS && (carga.TipoOperacao?.ConfiguracaoControleEntrega?.RecriarControleDeEntregasAoConfirmarEnvioDocumentos ?? false))))
                return true;

            if (carga.ExigeNotaFiscalParaCalcularFrete && (carga.TipoOperacao?.ConfiguracaoControleEntrega?.RecriarControleDeEntregasAoConfirmarEnvioDocumentos ?? false) && !Servicos.Embarcador.Carga.ControleEntrega.ControleEntrega.CargaPossuiControleEntrega(carga, unitOfWork))
                return true;


            return false;
        }

        private static void SalvarDistanciaCargaNova(Dominio.Entidades.Embarcador.Cargas.Carga cargaAntiga, Dominio.Entidades.Embarcador.Cargas.Carga cargaNova, List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos, List<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> pedidosXMLNotasFiscais, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Cargas.CargaDadosSumarizados repositorioCargaDadosSumarizados = new Repositorio.Embarcador.Cargas.CargaDadosSumarizados(unitOfWork);
            Servicos.Embarcador.Carga.CargaRotaFrete servicoCargaRotaFrete = new Servicos.Embarcador.Carga.CargaRotaFrete(unitOfWork);

            decimal distanciaCargaAntiga = cargaAntiga.DadosSumarizados?.Distancia ?? 0;
            if (distanciaCargaAntiga != 0 && cargaNova.DadosSumarizados != null)
            {
                Dominio.Entidades.Embarcador.Cargas.CargaDadosSumarizados cargaDadosSumarizados = cargaNova.DadosSumarizados;

                cargaDadosSumarizados.Distancia = distanciaCargaAntiga;

                repositorioCargaDadosSumarizados.Atualizar(cargaDadosSumarizados);
            }

            if (!(cargaAntiga.TipoOperacao?.ConfiguracaoCarga?.GerarCargaEspelhoAutomaticamenteAoFinalizarCarga ?? false) && cargaAntiga.TipoOperacao?.TipoUltimoPontoRoteirizacao == cargaNova.TipoOperacao?.TipoUltimoPontoRoteirizacao)
            {
                (Dominio.Entidades.Embarcador.Cargas.CargaRotaFrete cargaRotaFrete, List<Dominio.Entidades.Embarcador.Cargas.CargaRotaFretePontosPassagem> cargaRotaFretePontosPassagem) = servicoCargaRotaFrete.DuplicarCargaRotaFrete(cargaNova, cargaAntiga);

                if (cargaRotaFrete != null)
                {
                    cargaNova.SituacaoRoteirizacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoRoteirizacao.Concluido;
                    Servicos.Embarcador.Carga.ControleEntrega.ControleEntrega.GerarCargaEntrega(cargaNova, cargaPedidos, pedidosXMLNotasFiscais, cargaRotaFrete, cargaRotaFretePontosPassagem, true, configuracaoTMS, unitOfWork, tipoServicoMultisoftware);
                    //setar a flag carga.IntegrandoValePedagio para true caso exista consultas valor pedagio
                    Servicos.Embarcador.Carga.ValePedagio.CargaValePedagioRota.SetarCargaIntegrandoConsultaValePedagio(cargaNova, unitOfWork);
                }
            }
        }

        private void RemoverVeiculosFilaCarregamento(Dominio.Entidades.Veiculo veiculo, Repositorio.UnitOfWork unitOfWork, TipoServicoMultisoftware tipoServicoMultisoftware, int codigoCarga)
        {
            if (veiculo == null)
                return;

            Servicos.Embarcador.Logistica.FilaCarregamentoVeiculo servicoFilaCarregamento = new Servicos.Embarcador.Logistica.FilaCarregamentoVeiculo(unitOfWork, OrigemAlteracaoFilaCarregamento.Embarcador);

            Repositorio.Embarcador.Logistica.FilaCarregamentoVeiculo repositorioFilaCarregamentoVeiculo = new Repositorio.Embarcador.Logistica.FilaCarregamentoVeiculo(unitOfWork);

            Dominio.Entidades.Embarcador.Logistica.FilaCarregamentoVeiculo filaCarregamentoVeiculo = repositorioFilaCarregamentoVeiculo.BuscarAtivaPorVeiculo(veiculo.Codigo);

            if (filaCarregamentoVeiculo == null || (filaCarregamentoVeiculo.Carga != null && !VerificarSeCargaEstaNaLogistica(filaCarregamentoVeiculo.Carga, tipoServicoMultisoftware)))
                return;

            servicoFilaCarregamento.RemoverFilaCarregamento(filaCarregamentoVeiculo, tipoServicoMultisoftware, codigoCarga);

            Servicos.Log.GravarInfo($"Veículo {veiculo.Codigo} - {veiculo.Placa} removido da fila de carregamento", "RemocaoFilaCarregamento");
        }

        private void RealocarVeiculosSeNecessario(Dominio.Entidades.Veiculo veiculo, Dominio.Entidades.Veiculo veiculoAnterior, bool veiculoAlterado, List<Dominio.Entidades.Veiculo> reboquesVinculados, List<Dominio.Entidades.Veiculo> reboquesAnteriores, Dominio.Entidades.Embarcador.Cargas.Carga carga, UnitOfWork unitOfWork, TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            bool reboqueAlterado = carga.IsChangedByPropertyName("VeiculosVinculados");

            if (!veiculoAlterado && !reboqueAlterado)
                return;

            Servicos.Embarcador.Logistica.FilaCarregamentoVeiculo servicoFilaCarregamentoVeiculo = new Servicos.Embarcador.Logistica.FilaCarregamentoVeiculo(unitOfWork, null, Logistica.FilaCarregamentoVeiculo.ObterOrigemAlteracaoFilaCarregamento(tipoServicoMultisoftware));

            if (veiculoAlterado)
            {
                if (veiculo != null)
                    RemoverVeiculosFilaCarregamento(veiculo, unitOfWork, tipoServicoMultisoftware, carga.Codigo);

                if (veiculoAnterior != null)
                    servicoFilaCarregamentoVeiculo.RealocarVeiculoNaFila(veiculoAnterior.Codigo, tipoServicoMultisoftware, true);
            }

            if (reboqueAlterado)
            {
                List<Dominio.Entidades.Veiculo> reboquesAdicionados = reboquesVinculados.Where(r => !reboquesAnteriores.Any(ra => ra.Codigo == r.Codigo)).ToList();
                foreach (Dominio.Entidades.Veiculo reboque in reboquesAdicionados)
                    RemoverVeiculosFilaCarregamento(reboque, unitOfWork, tipoServicoMultisoftware, carga.Codigo);

                List<Dominio.Entidades.Veiculo> reboquesRemovidos = reboquesAnteriores.Where(ra => !reboquesVinculados.Any(r => r.Codigo == ra.Codigo)).ToList();
                foreach (Dominio.Entidades.Veiculo reboque in reboquesRemovidos)
                    servicoFilaCarregamentoVeiculo.RealocarVeiculoNaFila(reboque.Codigo, tipoServicoMultisoftware, true);
            }
        }

        #endregion Métodos Privados Estáticos
    }
}

using AdminMultisoftware.Dominio.Enumeradores;
using Dominio.Enumeradores;
using Dominio.Excecoes.Embarcador;
using Dominio.ObjetosDeValor.Embarcador.Enumeradores;
using Dominio.ObjetosDeValor.Relatorios;
using ICSharpCode.SharpZipLib.Zip;
using Newtonsoft.Json;
using Servicos.Extensions;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Net;
using System.ServiceModel;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Xml.Serialization;

namespace Servicos
{
    public class CTe : ServicoBase
    {
        #region Propriedades

        private Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoArquivo _configuracaoArquivo;
        public const string ReplaceMotivoRegexPatternFront = @"[^0-9a-záéíóúàèìòùâêîôûãõç\s,:;.\[\]\-\/\+\*\?\{\}]";
        public const string ReplaceMotivoRegexPatternBack = @"(?i)[^0-9a-záéíóúàèìòùâêîôûãõç\s,:;.\[\]\-\/+*?{}]";

        #endregion

        #region Construtores          

        public CTe(Repositorio.UnitOfWork unitOfWork) : base(unitOfWork)
        {
        }

        #endregion

        #region Métodos Públicos

        public Dominio.Entidades.EmpresaSerie ObterSerie(Dominio.Entidades.Empresa empresa, int serie, Dominio.Enumeradores.TipoSerie tipoSerie, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.EmpresaSerie repSerie = new Repositorio.EmpresaSerie(unidadeDeTrabalho);

            Dominio.Entidades.EmpresaSerie empSerie = repSerie.BuscarPorSerie(empresa.Codigo, serie, tipoSerie);

            if (empSerie == null)
            {
                empSerie = new Dominio.Entidades.EmpresaSerie
                {
                    Empresa = empresa,
                    Numero = serie,
                    Status = "A",
                    Tipo = tipoSerie
                };

                repSerie.Inserir(empSerie);
            }

            return empSerie;
        }

        public bool Cancelar(int codigoCTe, int codigoEmpresa, string justificativa, Repositorio.UnitOfWork unitOfWork = null, DateTime? dataCancelamento = null, bool gerarLog = false, Dominio.Entidades.Usuario usuario = null, string cobrarCancelamento = "")
        {
            unitOfWork = unitOfWork ?? new Repositorio.UnitOfWork(StringConexao);

            ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unitOfWork).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorId(codigoCTe, codigoEmpresa);

            TimeZoneInfo fusoHorarioEmpresa = TimeZoneInfo.FindSystemTimeZoneById(cte.Empresa.FusoHorario);
            DateTime dataFuso = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day, DateTime.Now.Hour, DateTime.Now.Minute, 0);
            dataFuso = TimeZoneInfo.ConvertTime(dataFuso, TimeZoneInfo.Local, fusoHorarioEmpresa);

            bool horarioVerao = fusoHorarioEmpresa.IsDaylightSavingTime(dataCancelamento.HasValue ? dataCancelamento.Value : DateTime.Today);
            string fusoHorario = horarioVerao ? AjustarFuso(fusoHorarioEmpresa.BaseUtcOffset.Hours + 1, fusoHorarioEmpresa.BaseUtcOffset.Minutes) : AjustarFuso(fusoHorarioEmpresa.BaseUtcOffset.Hours, fusoHorarioEmpresa.BaseUtcOffset.Minutes);

            // Tratamento para remover caracteres especiais
            string pattern = @"(?i)[^0-9a-záéíóúàèìòùâêîôûãõç\s:.\[\]\-\/+*?{}]";
            Regex rgx = new Regex(pattern);
            justificativa = rgx.Replace(justificativa, "");

            ServicoCTe.ResultadoString ret = svcCTe.CancelamentoCte(cte.Chave, justificativa, (int)cte.TipoAmbiente, dataCancelamento.HasValue ? dataCancelamento.Value.ToString("dd/MM/yyyy HH:mm:ss") : dataFuso.ToString("dd/MM/yyyy HH:mm:ss"), fusoHorario);

            cte.ObservacaoCancelamento = justificativa;
            cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat(ret.Info.Mensagem, " - ", ret.Info.MensagemOriginal));
            cte.CobrarCancelamento = cobrarCancelamento == "Sim";

            if (gerarLog && usuario != null)
                cte.Log = string.Concat(cte.Log, " Enviado cancelamento por ", usuario.CPF, " - ", usuario.Nome, " em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");

            if (ret.Info.Tipo == "OK")
            {
                cte.Status = "K";
                repCTe.Atualizar(cte);
                return true;
            }
            else
            {
                if (ret.Info.Mensagem == "CT-e não encontrado.")
                {
                    ServicoCTe.ResultadoString ret2 = svcCTe.CancelamentoCteProtocolo(cte.Chave, cte.Protocolo, justificativa, (int)cte.TipoAmbiente, dataCancelamento.HasValue ? dataCancelamento.Value.ToString("dd/MM/yyyy HH:mm:ss") : dataFuso.ToString("dd/MM/yyyy HH:mm:ss"), fusoHorario);

                    if (ret2.Info.Tipo == "OK")
                    {
                        cte.Status = "K";
                        repCTe.Atualizar(cte);
                        return true;
                    }
                }

                repCTe.Atualizar(cte);
                return false;
            }
        }

        public void ConsultarDuplicidade(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ErroSefaz repErroSefaz = new Repositorio.ErroSefaz(unidadeDeTrabalho);

            string chaveCTe = this.GerarChaveCTe(cte);

            ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unidadeDeTrabalho).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);

            ServicoCTe.RetornoCTE retorno = svcCTe.ConsultaProtocoloCteChave(chaveCTe);

            if (retorno.CodStatusProtocolo == "100")
            {
                DateTime dataAutorizacao = retorno.DataProtocolo != DateTime.MinValue ? retorno.DataProtocolo : DateTime.Now;

                cte.Status = "A";
                cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat(retorno.Info.Mensagem, " - ", retorno.Info.MensagemOriginal));
                cte.Protocolo = retorno.NumeroProtocolo;
                cte.DataRetornoSefaz = dataAutorizacao;
                cte.DataAutorizacao = dataAutorizacao;
                cte.Chave = retorno.ChaveCTE;
                cte.StatusIntegrador = retorno.StatusIntegrador;
                cte.CodStatusProtocolo = retorno.CodStatusProtocolo;
                cte.NumeroRecibo = retorno.NumeroRecibo;
                cte.CodigoCTeIntegrador = retorno.CodigoCTeInterno;
            }
            else
            {
                cte.Status = "R";
                if (cte.TipoEmissao == "4" || cte.TipoEmissao == "5")
                    cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat("Rejeição contingência: ", retorno.DescricaoStatusIntegrador, " - ", retorno.CodStatusEnvio, " - ", retorno.DescricaoEnvio));
                else
                    cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat(retorno.DescricaoStatusIntegrador, " - ", retorno.CodStatusEnvio, " - ", retorno.DescricaoEnvio));
                cte.StatusIntegrador = retorno.StatusIntegrador;
                cte.CodStatusProtocolo = retorno.CodStatusProtocolo;
            }

            int statusCTe = 0;
            int.TryParse(string.IsNullOrWhiteSpace(retorno.CodStatusProtocolo) ? retorno.CodStatusEnvio : retorno.CodStatusProtocolo, out statusCTe);

            cte.MensagemStatus = repErroSefaz.BuscarPorCodigoDoErro(statusCTe, Dominio.Enumeradores.TipoErroSefaz.CTe);
        }

        public void ConsultarDigestCTe(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);

            string chaveCTe = this.GerarChaveCTe(cte);

            ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unidadeDeTrabalho).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);

            ServicoCTe.RetornoCTE retorno = svcCTe.VerificarDigestCTe(chaveCTe);

            if (retorno.StatusIntegrador == "I")
            {
                cte.Status = "E";
                cte.CodigoCTeIntegrador = retorno.CodigoCTeInterno;

                repCTe.Atualizar(cte);
            }
            else
            {
                this.ConsultarDuplicidade(ref cte, unidadeDeTrabalho);
                repCTe.Atualizar(cte);
            }

        }

        public List<Dominio.ObjetosDeValor.InformacaoSeguro> ObterSegurosPorCTes(List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> ctes)
        {
            List<Dominio.ObjetosDeValor.InformacaoSeguro> listaSeguros = (from obj in ctes.Select(o => o.Seguros).SelectMany(o => o)
                                                                          group obj by new
                                                                          {
                                                                              obj.CTE.Codigo,
                                                                              obj.Tipo,
                                                                              obj.NomeSeguradora,
                                                                              obj.NumeroApolice,
                                                                              obj.CNPJSeguradora,
                                                                              obj.NumeroAverbacao,
                                                                              obj.CTE.Tomador.CPF_CNPJ,
                                                                              obj.CTE.Empresa.CNPJ
                                                                          } into grupo
                                                                          select new Dominio.ObjetosDeValor.InformacaoSeguro()
                                                                          {
                                                                              Id = grupo.Key.Codigo,
                                                                              Responsavel = grupo.Key.Tipo,
                                                                              CNPJResponsavel = grupo.Key.Tipo == Dominio.Enumeradores.TipoSeguro.Emitente_CTE ? grupo.Key.CNPJ : grupo.Key.CPF_CNPJ,
                                                                              Seguradora = grupo.Key.NomeSeguradora,
                                                                              NumeroApolice = grupo.Key.NumeroApolice,
                                                                              CNPJSeguradora = grupo.Key.CNPJSeguradora,
                                                                              NumeroAverberacao = grupo.Key.NumeroAverbacao,
                                                                          }).ToList();

            return listaSeguros;
        }

        public void Consultar(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            unidadeDeTrabalho = unidadeDeTrabalho != null ? unidadeDeTrabalho : new Repositorio.UnitOfWork(StringConexao);

            try
            {
                if (cte.SistemaEmissor != null && cte.SistemaEmissor != TipoEmissorDocumento.Integrador)
                    return;

                ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unidadeDeTrabalho).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);

                if (cte.Status == "E" || cte.Status == "X" || cte.Status == "F" || cte.Status == "Q")
                {
                    bool duplicidade = false;

                    ServicoCTe.RetornoCTE retorno = null;

                    if (cte.CodigoCTeIntegrador != 0)
                    {
                        retorno = svcCTe.ConsultaProtocoloCte(cte.CodigoCTeIntegrador);
                    }
                    else
                    {
                        retorno = svcCTe.ConsultaProtocoloCteChave(GerarChaveCTe(cte));
                    }

                    unidadeDeTrabalho.Start();

                    int statusCTe = 0;
                    int.TryParse(string.IsNullOrWhiteSpace(retorno.CodStatusProtocolo) ? retorno.CodStatusEnvio : retorno.CodStatusProtocolo, out statusCTe);

                    if (retorno.StatusIntegrador != "I" && retorno.StatusIntegrador != "A")
                    {
                        SalvarRetornoSefaz(cte, "A", retorno.CodigoCTeInterno, statusCTe, string.IsNullOrWhiteSpace(retorno.DescricaoProtocolo) ? retorno.DescricaoEnvio : retorno.DescricaoProtocolo, unidadeDeTrabalho);
                    }

                    Repositorio.ErroSefaz repErroSefaz = new Repositorio.ErroSefaz(unidadeDeTrabalho);

                    cte.MensagemStatus = repErroSefaz.BuscarPorCodigoDoErro(statusCTe, Dominio.Enumeradores.TipoErroSefaz.CTe);

                    if (retorno.Info.Tipo.Equals("OK"))
                    {
                        if (!string.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(retorno.TipoEmissao)))
                            cte.TipoEmissao = Utilidades.String.OnlyNumbers(retorno.TipoEmissao);

                        if (retorno.StatusIntegrador.Equals("E"))
                        {
                            if (retorno.CodStatusEnvio != null && retorno.CodStatusEnvio.Equals("204"))
                            {
                                this.ConsultarDuplicidade(ref cte, unidadeDeTrabalho);

                                duplicidade = true;
                            }
                            else if (retorno.CodStatusProtocolo != null && (retorno.CodStatusProtocolo.Equals("110") || retorno.CodStatusProtocolo.Equals("301") || retorno.CodStatusProtocolo.Equals("205")))
                            {
                                DateTime dataAutorizacao = retorno.DataProtocolo != DateTime.MinValue ? retorno.DataProtocolo : DateTime.Now;
                                cte.Status = "D";
                                cte.Protocolo = retorno.NumeroProtocolo;
                                cte.DataRetornoSefaz = dataAutorizacao;
                                cte.DataAutorizacao = dataAutorizacao;
                                cte.Chave = retorno.ChaveCTE;
                                cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat(retorno.DescricaoStatusIntegrador, " - ", retorno.CodStatusProtocolo, " - ", retorno.DescricaoProtocolo));
                                cte.StatusIntegrador = retorno.StatusIntegrador;
                            }
                            else
                            {
                                cte.Status = "R";
                                if (cte.TipoEmissao == "4" || cte.TipoEmissao == "5")
                                {
                                    cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat("Rejeição contingência: ", retorno.DescricaoStatusIntegrador, " - ", retorno.CodStatusEnvio, " - ", retorno.DescricaoEnvio));
                                    if (string.IsNullOrWhiteSpace(cte.ChaveContingencia)) //Se ainda não foi autoriszado em contingência volta o tipo de emissão para Normal
                                        cte.TipoEmissao = "1";
                                    else
                                        cte.Status = cte.TipoEmissao == "4" ? "Q" : "F";
                                }
                                else if (!string.IsNullOrWhiteSpace(retorno.CodStatusEnvio) && retorno.CodStatusEnvio != "0")
                                    cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat(retorno.DescricaoStatusIntegrador, " - ", retorno.CodStatusEnvio, " - ", retorno.DescricaoEnvio));
                                else
                                    cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat(retorno.DescricaoStatusIntegrador, " - ", retorno.DescricaoEnvio));
                                cte.StatusIntegrador = retorno.StatusIntegrador;
                            }
                        }
                        else if (retorno.StatusIntegrador.Equals("I") || retorno.StatusIntegrador.Equals("L"))
                        {
                            cte.Status = "E";
                            cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat(retorno.DescricaoStatusIntegrador, " - ", retorno.CodStatusEnvio, " - ", retorno.DescricaoEnvio));
                            cte.StatusIntegrador = retorno.StatusIntegrador;
                        }
                        else if (retorno.StatusIntegrador.Equals("D") || retorno.StatusIntegrador.Equals("M"))
                        {
                            DateTime dataAutorizacao = retorno.DataProtocolo != DateTime.MinValue ? retorno.DataProtocolo : DateTime.Now;

                            cte.Status = "A";
                            cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat(retorno.Info.Mensagem, " - ", retorno.Info.MensagemOriginal));
                            cte.Protocolo = retorno.NumeroProtocolo;
                            cte.DataRetornoSefaz = dataAutorizacao;
                            cte.DataAutorizacao = dataAutorizacao;
                            cte.Chave = retorno.ChaveCTE;
                            cte.StatusIntegrador = retorno.StatusIntegrador;
                            cte.NumeroRecibo = retorno.NumeroRecibo;
                        }
                        else if (retorno.StatusIntegrador.Equals("A"))
                        {
                            cte.Status = "X";
                            cte.MensagemRetornoSefaz = "Aguardando Assinatura";
                            cte.StatusIntegrador = retorno.StatusIntegrador;
                        }
                        else if (retorno.StatusIntegrador.Equals("P"))
                        {
                            cte.Status = "E";
                            cte.MensagemRetornoSefaz = "Aguardando geração da DACTE";
                            cte.StatusIntegrador = retorno.StatusIntegrador;
                        }
                        else if (retorno.StatusIntegrador.Equals("F"))
                        {
                            cte.Status = "F";
                            cte.Chave = retorno.ChaveCTE;
                            cte.ChaveContingencia = retorno.ChaveContingencia;
                            cte.MensagemRetornoSefaz = "DACTE gerada em contingência FSDA";
                            cte.StatusIntegrador = retorno.StatusIntegrador;
                        }
                        else if (retorno.StatusIntegrador.Equals("Q"))
                        {
                            cte.Status = "Q";
                            cte.Chave = retorno.ChaveCTE;
                            cte.ChaveContingencia = retorno.ChaveContingencia;
                            cte.MensagemRetornoSefaz = "DACTE gerada em contingência EPEC";
                            cte.StatusIntegrador = retorno.StatusIntegrador;
                            cte.TentativaReenvio += 1;
                        }
                    }
                    else
                    {
                        cte.Status = "R";
                        if (cte.TipoEmissao == "4" || cte.TipoEmissao == "5")
                            cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat("Rejeição contingência: ", retorno.Info.Mensagem, " - ", retorno.Info.MensagemOriginal));
                        else
                            cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat(retorno.Info.Mensagem, " - ", retorno.Info.MensagemOriginal));
                    }

                    if (cte.CodigoCTeIntegrador == 0 && retorno.CodigoCTeInterno > 0)
                        cte.CodigoCTeIntegrador = retorno.CodigoCTeInterno;

                    repCTe.Atualizar(cte);

                    unidadeDeTrabalho.CommitChanges();

                    Servicos.Subcontratacao svcSubcontratacao = new Subcontratacao(unidadeDeTrabalho);
                    svcSubcontratacao.AtualizarEmissaoCTe(cte, unidadeDeTrabalho);

                    if (cte.Status == "A")
                    {
                        Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoSGT = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unidadeDeTrabalho);
                        Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoSGT = repConfiguracaoSGT.BuscarConfiguracaoPadrao();
                        bool armazenarEmArquivo = configuracaoSGT != null ? configuracaoSGT.ArmazenarXMLCTeEmArquivo : false;

                        this.ObterESalvarDACTE(cte, cte.Empresa.Codigo, duplicidade ? null : retorno, unidadeDeTrabalho);

                        this.ObterESalvarXMLAutorizacao(cte, cte.Empresa.Codigo, armazenarEmArquivo, duplicidade ? null : retorno, unidadeDeTrabalho);

                        this.SalvarMovimentoDoFinanceiro(cte, cte.Empresa.Codigo, unidadeDeTrabalho);
                    }
                    if (cte.Status == "D") //Denegado
                    {
                        Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoSGT = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unidadeDeTrabalho);
                        Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoSGT = repConfiguracaoSGT.BuscarConfiguracaoPadrao();
                        bool armazenarEmArquivo = configuracaoSGT != null ? configuracaoSGT.ArmazenarXMLCTeEmArquivo : false;

                        this.ObterESalvarXMLAutorizacao(cte, cte.Empresa.Codigo, armazenarEmArquivo, duplicidade ? null : retorno, unidadeDeTrabalho);
                    }
                    else if (cte.Status == "F") //Contingência FSDA
                        this.ObterESalvarDACTE(cte, cte.Empresa.Codigo, duplicidade ? null : retorno, unidadeDeTrabalho, "FSDA");
                    else if (cte.Status == "Q") //Contingência FSDA
                        this.ObterESalvarDACTE(cte, cte.Empresa.Codigo, duplicidade ? null : retorno, unidadeDeTrabalho, "EPEC");

                }

                //return cte;
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro(ex);
                if (!ex.ToString().Contains("Transaction not connected, or was disconnected"))
                    unidadeDeTrabalho.Rollback();
                throw;
            }
        }

        public Dominio.Entidades.ConhecimentoDeTransporteEletronico ConsultarCancelamento(int codigoCTe, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            unidadeDeTrabalho = unidadeDeTrabalho != null ? unidadeDeTrabalho : new Repositorio.UnitOfWork(StringConexao);

            try
            {
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);

                Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorCodigo(codigoCTe);

                ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unidadeDeTrabalho).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);

                ServicoCTe.ResultadoProtocolo retorno = svcCTe.ConsultaCancelamentoCte(cte.Chave);

                unidadeDeTrabalho.Start();

                if (retorno.Retorno.CodigoStatusSefaz != 0)
                    SalvarRetornoSefaz(cte, "C", 0, retorno.Retorno.CodigoStatusSefaz, Utilidades.String.ReplaceInvalidCharacters(retorno.Retorno.Motivo), unidadeDeTrabalho);

                if (retorno.Retorno.CodigoStatusSefaz == 101)
                {
                    cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(retorno.Retorno.Motivo);
                    cte.ProtocoloCancelamentoInutilizacao = retorno.Retorno.NumeroProtocolo;
                    cte.Status = "C";
                    cte.Cancelado = "S";
                    cte.DataCancelamento = DateTime.Now;

                    repCTe.Atualizar(cte);

                    Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoSGT = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unidadeDeTrabalho);
                    Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoSGT = repConfiguracaoSGT.BuscarConfiguracaoPadrao();
                    bool armazenarEmArquivo = configuracaoSGT != null ? configuracaoSGT.ArmazenarXMLCTeEmArquivo : false;

                    this.ObterESalvarXMLCancelamento(cte, cte.Empresa.Codigo, armazenarEmArquivo, null, unidadeDeTrabalho);

                    this.SalvarMovimentoDoFinanceiro(cte, cte.Empresa.Codigo, unidadeDeTrabalho);
                }
                else if (retorno.Retorno.CodigoStatusSefaz != 0)
                {
                    cte.Status = "A";
                    cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(retorno.Retorno.Motivo);
                }
                else if (retorno.Retorno.Status == 2)
                {
                    cte.Status = "V";
                    cte.MensagemRetornoSefaz = "Aguardando assinatura.";
                }

                Repositorio.ErroSefaz repErroSefaz = new Repositorio.ErroSefaz(unidadeDeTrabalho);

                cte.MensagemStatus = repErroSefaz.BuscarPorCodigoDoErro(retorno.Retorno.CodigoStatusSefaz, Dominio.Enumeradores.TipoErroSefaz.CTe);

                repCTe.Atualizar(cte);

                unidadeDeTrabalho.CommitChanges();

                if (cte.Status == "C")
                    new DACTE(unidadeDeTrabalho).GerarPorProcessoAsync(cte.Codigo, unidadeDeTrabalho);

                return cte;
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro(ex);
                unidadeDeTrabalho.Rollback();
                throw;
            }
        }

        public Dominio.Entidades.ConhecimentoDeTransporteEletronico ConsultarInutilizacao(int codigoCTe, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            unidadeDeTrabalho = unidadeDeTrabalho != null ? unidadeDeTrabalho : new Repositorio.UnitOfWork(StringConexao);

            try
            {
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);

                Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorCodigo(codigoCTe);

                ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unidadeDeTrabalho).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);

                ServicoCTe.ResultadoProtocolo retorno = svcCTe.ConsultaInutilizacao(cte.ProtocoloCancelamentoInutilizacao);

                unidadeDeTrabalho.Start();

                if (retorno.Retorno.CodigoStatusSefaz != 0)
                    SalvarRetornoSefaz(cte, "I", 0, retorno.Retorno.CodigoStatusSefaz, Utilidades.String.ReplaceInvalidCharacters(retorno.Retorno.Motivo), unidadeDeTrabalho);

                if (retorno.Retorno.CodigoStatusSefaz == 102)
                {
                    cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(retorno.Retorno.Motivo);
                    cte.ProtocoloCancelamentoInutilizacao = retorno.Retorno.NumeroProtocolo;
                    cte.Status = "I";
                    cte.DataCancelamento = DateTime.Now;
                }
                else if (retorno.Retorno.CodigoStatusSefaz != 0)
                {
                    cte.Status = "R";
                    cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(retorno.Retorno.Motivo);
                }

                Repositorio.ErroSefaz repErroSefaz = new Repositorio.ErroSefaz(unidadeDeTrabalho);

                cte.MensagemStatus = repErroSefaz.BuscarPorCodigoDoErro(retorno.Retorno.CodigoStatusSefaz, Dominio.Enumeradores.TipoErroSefaz.CTe);

                repCTe.Atualizar(cte);

                this.ObterESalvarXMLInutilizacao(cte, retorno.Retorno.XMLInutilizacao, unidadeDeTrabalho);

                unidadeDeTrabalho.CommitChanges();

                return cte;
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro(ex);
                unidadeDeTrabalho.Rollback();
                throw;
            }
        }

        public void SalvarRetornoSefaz(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, string tipo, int codigoCTeIntegrador, int codigoRetornoSefaz, string mensagemRetornoSefaz, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            try
            {
                Repositorio.ErroSefaz repErroSefaz = new Repositorio.ErroSefaz(unidadeDeTrabalho);
                Repositorio.CTeRetornoSefaz repCTeRetornoSefaz = new Repositorio.CTeRetornoSefaz(unidadeDeTrabalho);

                Dominio.Entidades.CTeRetornoSefaz cteRetornoSefaz = new Dominio.Entidades.CTeRetornoSefaz();

                string mensagemRetorno = codigoRetornoSefaz.ToString() + " - " + mensagemRetornoSefaz;

                cteRetornoSefaz.CTe = cte;
                cteRetornoSefaz.Tipo = tipo;
                cteRetornoSefaz.CodigoCTeIntegrador = codigoCTeIntegrador;
                cteRetornoSefaz.DataHora = DateTime.Now;
                cteRetornoSefaz.MensagemRetorno = mensagemRetorno.Length > 5000 ? mensagemRetorno.Substring(0, 5000) : mensagemRetorno;
                cteRetornoSefaz.CodStatusProtocolo = codigoRetornoSefaz.ToString();
                cteRetornoSefaz.ErroSefaz = repErroSefaz.BuscarPorCodigoDoErro(codigoRetornoSefaz, Dominio.Enumeradores.TipoErroSefaz.CTe);
                repCTeRetornoSefaz.Inserir(cteRetornoSefaz);
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Erro ao salvar retorno sefaz CTe: " + ex);
            }
        }

        public void SalvarInformacoesMultiModal(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, decimal valorPrestacaoServico, Repositorio.UnitOfWork unidadeDeTrabalho, string numeroControle = "")
        {
            Servicos.CTe serCTE = new Servicos.CTe(unidadeDeTrabalho);
            Servicos.Embarcador.Fatura.Fatura servFatura = new Servicos.Embarcador.Fatura.Fatura(unidadeDeTrabalho);

            Repositorio.ContainerCTE repContainerCTE = new Repositorio.ContainerCTE(unidadeDeTrabalho);
            Repositorio.Embarcador.CTe.CTeContainerDocumento repCTeContainerDocumento = new Repositorio.Embarcador.CTe.CTeContainerDocumento(unidadeDeTrabalho);
            Repositorio.ObservacaoContribuinteCTE repObservacaoContribuinteCTE = new Repositorio.ObservacaoContribuinteCTE(unidadeDeTrabalho);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);
            Repositorio.Embarcador.Configuracoes.IntegracaoIntercab repIntegracaoIntercab = new Repositorio.Embarcador.Configuracoes.IntegracaoIntercab(unidadeDeTrabalho);
            Repositorio.Embarcador.Pedidos.PedidoViagemNavioSchedule repPedidoNavioSchedule = new Repositorio.Embarcador.Pedidos.PedidoViagemNavioSchedule(unidadeDeTrabalho);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);

            Dominio.Entidades.Embarcador.Configuracoes.IntegracaoIntercab integracaoIntercab = repIntegracaoIntercab.BuscarIntegracao();

            //if (integracaoIntercab == null || !integracaoIntercab.BuscarTipoServicoModeloDocumentoVinculadoCarga)
            //return;

            if (cargaPedido != null && cargaPedido.Pedido != null)
            {
                if (integracaoIntercab == null || integracaoIntercab.BuscarTipoServicoModeloDocumentoVinculadoCarga)
                {
                    if (cte.TipoModal == TipoModal.Aquaviario)
                        cargaPedido.TipoCobrancaMultimodal = TipoCobrancaMultimodal.CTEAquaviario;
                    else if (cte.TipoModal == TipoModal.Multimodal)
                        cargaPedido.TipoCobrancaMultimodal = TipoCobrancaMultimodal.CTeMultimodal;
                    else if (cte.TipoModal == TipoModal.Rodoviario)
                        cargaPedido.TipoCobrancaMultimodal = TipoCobrancaMultimodal.CTeRodoviario;

                    if (cargaPedido != null && cargaPedido.Pedido != null && cargaPedido.Pedido.TipoDeCarga != null && (cargaPedido.Pedido.TipoDeCarga.ModalProposta == ModalPropostaMultimodal.PortaPorta || cargaPedido.Pedido.TipoDeCarga.ModalProposta == ModalPropostaMultimodal.PortaPorto || cargaPedido.Pedido.TipoDeCarga.ModalProposta == ModalPropostaMultimodal.PortoPorta || cargaPedido.Pedido.TipoDeCarga.ModalProposta == ModalPropostaMultimodal.PortoPorto))
                        cargaPedido.ModalPropostaMultimodal = cargaPedido.Pedido.TipoDeCarga.ModalProposta;

                    if (cargaPedido.Carga.CargaSVM)
                        cargaPedido.TipoServicoMultimodal = TipoServicoMultimodal.VinculadoMultimodalProprio;
                    else if (cte.TipoServico == Dominio.Enumeradores.TipoServico.Normal)
                        cargaPedido.TipoServicoMultimodal = TipoServicoMultimodal.Normal;
                    else if (cte.TipoServico == Dominio.Enumeradores.TipoServico.Redespacho)
                        cargaPedido.TipoServicoMultimodal = TipoServicoMultimodal.Redespacho;
                    else if (cte.TipoServico == Dominio.Enumeradores.TipoServico.RedIntermediario)
                        cargaPedido.TipoServicoMultimodal = TipoServicoMultimodal.RedespachoIntermediario;
                    else if (cte.TipoServico == Dominio.Enumeradores.TipoServico.ServVinculadoMultimodal)
                        cargaPedido.TipoServicoMultimodal = TipoServicoMultimodal.VinculadoMultimodalTerceiro;
                    else if (cte.TipoServico == Dominio.Enumeradores.TipoServico.SubContratacao)
                        cargaPedido.TipoServicoMultimodal = TipoServicoMultimodal.Subcontratacao;

                    if (cte.TipoModal == TipoModal.Multimodal)
                        cargaPedido.TipoPropostaMultimodal = TipoPropostaMultimodal.CargaFracionada;
                }

                if (cargaPedido.Pedido?.Porto != null)
                    cte.PortoOrigem = cargaPedido.Pedido?.Porto;
                if (cargaPedido.Pedido?.PortoDestino != null)
                    cte.PortoDestino = cargaPedido.Pedido?.PortoDestino;
                if (cargaPedido.Pedido?.TerminalOrigem != null)
                    cte.TerminalOrigem = cargaPedido.Pedido?.TerminalOrigem;
                if (cargaPedido.Pedido?.TerminalDestino != null)
                    cte.TerminalDestino = cargaPedido.Pedido?.TerminalDestino;
                if (cargaPedido.Carga?.PedidoViagemNavio != null)
                    cte.Viagem = cargaPedido.Carga?.PedidoViagemNavio;

                if (cargaPedido.Pedido != null && cargaPedido.Pedido.PedidosTransbordo != null && cargaPedido.Pedido.PedidosTransbordo.Count > 0)
                {
                    List<Dominio.Entidades.Embarcador.Pedidos.PedidoTransbordo> listaTransbordo = (from obj in cargaPedido.Pedido.PedidosTransbordo orderby obj.Sequencia select obj).ToList();
                    int sequencia = 1;
                    foreach (Dominio.Entidades.Embarcador.Pedidos.PedidoTransbordo transbordo in listaTransbordo)
                    {
                        if (sequencia == 1)
                        {
                            cte.PortoPassagemUm = transbordo.Porto;
                            cte.ViagemPassagemUm = transbordo.PedidoViagemNavio;
                        }
                        else if (sequencia == 2)
                        {
                            cte.PortoPassagemDois = transbordo.Porto;
                            cte.ViagemPassagemDois = transbordo.PedidoViagemNavio;
                        }
                        else if (sequencia == 3)
                        {
                            cte.PortoPassagemTres = transbordo.Porto;
                            cte.ViagemPassagemTres = transbordo.PedidoViagemNavio;
                        }
                        else if (sequencia == 4)
                        {
                            cte.PortoPassagemQuatro = transbordo.Porto;
                            cte.ViagemPassagemQuatro = transbordo.PedidoViagemNavio;
                        }
                        else if (sequencia == 5)
                        {
                            cte.PortoPassagemCinco = transbordo.Porto;
                            cte.ViagemPassagemCinco = transbordo.PedidoViagemNavio;
                        }
                        sequencia += 1;
                    }
                }

                if (cargaPedido.TipoServicoMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoServicoMultimodal.VinculadoMultimodalProprio || cargaPedido.TipoServicoMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoServicoMultimodal.VinculadoMultimodalTerceiro)
                    cte.TipoServico = Dominio.Enumeradores.TipoServico.ServVinculadoMultimodal;
                else if (cargaPedido.TipoServicoMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoServicoMultimodal.RedespachoIntermediario)
                    cte.TipoServico = Dominio.Enumeradores.TipoServico.RedIntermediario;
                else if (cargaPedido.TipoServicoMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoServicoMultimodal.Subcontratacao)
                    cte.TipoServico = Dominio.Enumeradores.TipoServico.SubContratacao;

                if (cargaPedido.TipoCobrancaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoCobrancaMultimodal.CTeRodoviario)
                    cte.TipoModal = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Rodoviario;
                else if (cargaPedido.TipoCobrancaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoCobrancaMultimodal.CTeMultimodal)
                {
                    cte.TipoModal = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Multimodal;
                    cte.NumeroCOTM = cargaPedido.Carga?.Empresa?.COTM ?? "";
                    if (cargaPedido.Pedido?.Navio != null)
                        cte.Navio = cargaPedido.Pedido?.Navio;
                    if (cargaPedido.Carga?.PedidoViagemNavio != null)
                        cte.NumeroViagem = cargaPedido.Carga.PedidoViagemNavio.NumeroViagem.ToString("D");
                }
                else if (cargaPedido.TipoCobrancaMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoCobrancaMultimodal.CTEAquaviario)
                {
                    cte.TipoModal = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Aquaviario;
                    cte.ValorPrestacaoAFRMM = valorPrestacaoServico;
                    cte.ValorAdicionalAFRMM = 0;
                    if (cargaPedido.Pedido?.Navio != null)
                        cte.Navio = cargaPedido.Pedido?.Navio;
                    if (cargaPedido.Carga?.PedidoViagemNavio != null)
                        cte.NumeroViagem = cargaPedido.Carga.PedidoViagemNavio.NumeroViagem.ToString("D");
                    if (cargaPedido.Pedido != null)
                        cte.Direcao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.DirecaoViagemMultimodalHelper.ObterAbreviacao(cargaPedido.Pedido.DirecaoViagemMultimodal);
                }

                if (cargaPedido.Pedido?.Container != null)
                {
                    repCTeContainerDocumento.DeletarPorCTe(cte.Codigo);
                    repContainerCTE.DeletarPorCTe(cte.Codigo);

                    Dominio.Entidades.ContainerCTE container = new Dominio.Entidades.ContainerCTE()
                    {
                        Container = cargaPedido.Pedido.Container,
                        CTE = cte,
                        Lacre1 = cargaPedido.Pedido.LacreContainerUm,
                        Lacre2 = cargaPedido.Pedido.LacreContainerDois,
                        Lacre3 = cargaPedido.Pedido.LacreContainerTres,
                        Numero = cargaPedido.Pedido.Container.Numero
                    };
                    repContainerCTE.Inserir(container);
                    if (cte.Documentos != null && cte.Documentos.Count > 0)
                    {
                        foreach (Dominio.Entidades.DocumentosCTE nota in cte.Documentos)
                        {
                            Dominio.Entidades.Embarcador.CTe.CTeContainerDocumento notaContainer = new Dominio.Entidades.Embarcador.CTe.CTeContainerDocumento()
                            {
                                DocumentosCTE = nota,
                                Chave = nota.ChaveNFE,
                                ContainerCTE = container,
                                Numero = nota.Numero,
                                Serie = !string.IsNullOrWhiteSpace(nota.Serie) ? nota.Serie : "1",
                                TipoDocumento = Dominio.Enumeradores.TipoDocumentoCTe.NFe,
                                UnidadeMedidaRateada = 0
                            };

                            if (!string.IsNullOrWhiteSpace(notaContainer.Chave))
                                notaContainer.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(notaContainer.Chave);

                            repCTeContainerDocumento.Inserir(notaContainer);
                        }
                    }
                }

                cte.NumeroOS = cargaPedido.Pedido.NumeroOS;
                cte.Embarque = cargaPedido.Pedido.Embarque;
                cte.MasterBL = cargaPedido.Pedido.MasterBL;
                cte.NumeroDI = cargaPedido.Pedido.NumeroDI;
                cte.TipoOSConvertido = cargaPedido.Carga.TipoOSConvertido;
                cte.TipoOS = cargaPedido.Pedido.TipoOS;
                cte.BookingReference = cargaPedido.Pedido.BookingReference;
                cte.SVMTerceiro = cargaPedido.TipoServicoMultimodal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoServicoMultimodal.VinculadoMultimodalTerceiro;
                if (cargaPedido.Pedido.ProvedorOS != null)
                    cte.ClienteProvedorOS = cargaPedido.Pedido.ProvedorOS;
                cte.NumeroBooking = cargaPedido.Pedido.NumeroBooking;
                cte.DescricaoCarrier = cargaPedido.Pedido.DescricaoCarrierNavioViagem;
                cte.TipoPropostaFeeder = cargaPedido.Pedido.TipoPropostaFeeder;
                cte.NumeroControle = numeroControle;
                cte.PedidoViagemNavioSchedule = repPedidoNavioSchedule.BuscarPorCodigo(repCTe.BuscarCodigoSchedule(cte.ViagemPassagemCinco?.Codigo ?? 0, cte.ViagemPassagemQuatro?.Codigo ?? 0, cte.ViagemPassagemTres?.Codigo ?? 0, cte.ViagemPassagemDois?.Codigo ?? 0, cte.ViagemPassagemUm?.Codigo ?? 0, cte.Viagem?.Codigo ?? 0, cte.PortoDestino?.Codigo ?? 0, cte.TerminalDestino?.Codigo ?? 0));

                List<Dominio.Entidades.ObservacaoContribuinteCTE> observacaos = repObservacaoContribuinteCTE.BuscarPorCTe(cte.Codigo);
                if (observacaos != null && observacaos.Count > 0 && string.IsNullOrWhiteSpace(numeroControle))
                {
                    foreach (Dominio.Entidades.ObservacaoContribuinteCTE observacao in observacaos)
                    {
                        if (!string.IsNullOrWhiteSpace(observacao.Descricao) && observacao.Descricao.ToLower().Contains("num ctrl:"))
                        {
                            int posicaoInicial = observacao.Descricao.ToLower().IndexOf("num ctrl:");
                            posicaoInicial += ("num ctrl:").Length;
                            cte.NumeroControle = observacao.Descricao.Substring(posicaoInicial);
                            if (!string.IsNullOrWhiteSpace(cte.NumeroControle))
                                cte.NumeroControle = cte.NumeroControle.Trim();
                        }
                    }
                }
                if (string.IsNullOrWhiteSpace(cte.NumeroControle) && !string.IsNullOrWhiteSpace(cte.ObservacoesGerais))
                {
                    if (cte.ObservacoesGerais.ToLower().Contains("num ctrl:"))
                    {
                        int posicaoInicial = cte.ObservacoesGerais.ToLower().IndexOf("num ctrl:");
                        posicaoInicial += ("num ctrl:").Length;
                        cte.NumeroControle = cte.ObservacoesGerais.Substring(posicaoInicial);
                        if (!string.IsNullOrWhiteSpace(cte.NumeroControle))
                            cte.NumeroControle = cte.NumeroControle.Trim();
                    }
                }
                if ((cte.TipoModal == TipoModal.Aquaviario || cte.TipoModal == TipoModal.Multimodal || cte.TipoModal == TipoModal.Rodoviario) && string.IsNullOrWhiteSpace(cte.NumeroControle))
                {
                    cte.NumeroControle = serCTE.RetornarNumeroControleCTe(out int numeroSequencia, cte.NumeroBooking, cte.DescricaoCarrier, cte.TipoPropostaFeeder, cte.TipoModal, cte.TipoServico, cte?.Codigo ?? 0, cte.SVMTerceiro, unidadeDeTrabalho, false, 0, true, cte?.SequenciaBooking ?? 0);
                    cte.SequenciaBooking = numeroSequencia;
                    if (cte.NumeroControle == "0")
                        cte.NumeroControle = cte.Codigo.ToString("D");
                    else
                    {
                        if (repCTe.ContemNumeroControleDuplicado(cte.NumeroControle, cte.Empresa?.Codigo ?? 0, cte.Codigo))
                        {
                            cte.NumeroControle = serCTE.RetornarNumeroControleCTe(out numeroSequencia, cte.NumeroBooking, cte.DescricaoCarrier, cte.TipoPropostaFeeder, cte.TipoModal, cte.TipoServico, cte.Codigo, cte.SVMTerceiro, unidadeDeTrabalho, true, cte.SequenciaBooking, true, cte?.SequenciaBooking ?? 0);
                            cte.SequenciaBooking = numeroSequencia;

                            if (repCTe.ContemNumeroControleDuplicado(cte.NumeroControle, cte.Empresa?.Codigo ?? 0, cte.Codigo))
                            {
                                bool contemNumeroDuplicado = true;
                                int count = 0;
                                while (contemNumeroDuplicado)
                                {
                                    cte.NumeroControle = serCTE.RetornarNumeroControleCTe(out numeroSequencia, cte.NumeroBooking, cte.DescricaoCarrier, cte.TipoPropostaFeeder, cte.TipoModal, cte.TipoServico, cte.Codigo, cte.SVMTerceiro, unidadeDeTrabalho, true, cte.SequenciaBooking, true);
                                    cte.SequenciaBooking = numeroSequencia;
                                    contemNumeroDuplicado = repCTe.ContemNumeroControleDuplicado(cte.NumeroControle, cte.Empresa?.Codigo ?? 0, cte.Codigo);
                                    count++;
                                    if (count > 100)
                                        break;
                                }
                            }
                            repCTe.Atualizar(cte);
                        }
                    }
                }

                if (!cte.DataPreviaVencimento.HasValue)
                {
                    int? diasPrazoFatura = 0;
                    int? diaMes = 0;
                    bool? permiteFinalSemana = false;
                    FormaTitulo formaTitulo = FormaTitulo.Outros;
                    Dominio.ObjetosDeValor.Embarcador.Enumeradores.DiaSemana? diaSemana = null;
                    Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPrazoFaturamento? tipoPrazoFatura = null;

                    List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.DiaSemana> diasSemana = new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.DiaSemana>();
                    List<int> diasMes = new List<int>();

                    servFatura.RetornarParametrosFaturamento(cte, unidadeDeTrabalho, true, out diaMes, out diaSemana, out permiteFinalSemana, out diasPrazoFatura, out diasSemana, out diasMes, out tipoPrazoFatura, cargaPedido?.Carga?.Codigo ?? 0, out formaTitulo);
                    DateTime? dataBaseParcela = servFatura.RetornarDataBase(tipoPrazoFatura, cte, true, unidadeDeTrabalho);

                    if (dataBaseParcela.HasValue && (diaMes != null || diaSemana != null || diasPrazoFatura != null || tipoPrazoFatura != null || diasMes.Count > 0 || diasSemana.Count > 0))
                    {
                        cte.DataPreviaVencimento = servFatura.RetornaDataPadraoFatura(diaMes, diaSemana, permiteFinalSemana, dataBaseParcela, diasPrazoFatura, diasSemana, diasMes, cte.TomadorPagador.Cliente, cte.TomadorPagador.GrupoPessoas, false, unidadeDeTrabalho);
                        repCTe.Atualizar(cte);
                    }
                }
            }
        }

        public void SalvarMovimentoDoFinanceiro(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int codigoEmpresa, Repositorio.UnitOfWork unidadeDeTrabalho, bool gerarMovimentoCTeSemParcelas = false)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);

            //Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorId(codigoCTe, codigoEmpresa);

            if (cte != null && cte.Empresa.Configuracao != null && cte.Empresa.Configuracao.PlanoCTe != null)
            {
                Repositorio.MovimentoDoFinanceiro repMovimento = new Repositorio.MovimentoDoFinanceiro(unidadeDeTrabalho);
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);
                Repositorio.MotoristaCTE repMotoristaCTe = new Repositorio.MotoristaCTE(unidadeDeTrabalho);
                Repositorio.Usuario repMotorista = new Repositorio.Usuario(unidadeDeTrabalho);
                Repositorio.ParcelaCobrancaCTe repParcela = new Repositorio.ParcelaCobrancaCTe(unidadeDeTrabalho);

                if (cte.Empresa.Configuracao.GeraDuplicatasAutomaticamente == Dominio.Enumeradores.OpcaoSimNao.Sim)
                {
                    Repositorio.Duplicata repDuplicata = new Repositorio.Duplicata(unidadeDeTrabalho);
                    Repositorio.DuplicataParcelas repDuplicataParcelas = new Repositorio.DuplicataParcelas(unidadeDeTrabalho);
                    Repositorio.DuplicataCtes repDuplicataCtes = new Repositorio.DuplicataCtes(unidadeDeTrabalho);

                    Servicos.Duplicatas svcDuplicata = new Servicos.Duplicatas(unidadeDeTrabalho);

                    List<Dominio.Entidades.ParcelaCobrancaCTe> parcelasCTe = repParcela.BuscarPorCTe(codigoEmpresa, cte.Codigo);

                    if (cte.Status == "A")
                    {
                        Dominio.Entidades.Duplicata duplicata = new Dominio.Entidades.Duplicata();
                        duplicata.Numero = repDuplicata.BuscarUltimoNumero(cte.Empresa.Codigo) + 1;
                        duplicata.Codigo = repDuplicata.BuscarUltimoCodigo(cte.Empresa.Codigo) + 1;
                        duplicata.Empresa = cte.Empresa;
                        duplicata.Tipo = Dominio.Enumeradores.TipoDuplicata.AReceber;
                        duplicata.Status = "A";
                        duplicata.DataLancamento = DateTime.Now;
                        duplicata.Documento = cte.Numero.ToString() + "/" + cte.Serie.Numero.ToString();
                        duplicata.DataDocumento = cte.DataEmissao.Value;
                        duplicata.Valor = cte.ValorAReceber;
                        duplicata.Desconto = 0;
                        duplicata.Acrescimo = 0;
                        duplicata.Funcionario = cte.Usuario != null ? cte.Usuario : repMotorista.BuscarPrimeiroPorEmpresa(cte.Empresa.Codigo, Dominio.Enumeradores.TipoAcesso.Emissao);
                        duplicata.Motorista = cte.Motoristas != null && cte.Motoristas.Count > 0 ? repMotorista.BuscarMotoristaPorCPF(cte.Motoristas.FirstOrDefault().CPFMotorista) : null;
                        duplicata.Pessoa = repCliente.BuscarPorCPFCNPJ(double.Parse(cte.TomadorPagador.CPF_CNPJ));
                        duplicata.Veiculo1 = cte.Veiculos != null && cte.Veiculos.Count > 0 && cte.Veiculos[0].Veiculo != null ? cte.Veiculos[0].Veiculo : null;
                        duplicata.Veiculo2 = cte.Veiculos != null && cte.Veiculos.Count > 1 && cte.Veiculos[1].Veiculo != null ? cte.Veiculos[1].Veiculo : null;
                        duplicata.Veiculo3 = cte.Veiculos != null && cte.Veiculos.Count > 2 && cte.Veiculos[2].Veiculo != null ? cte.Veiculos[2].Veiculo : null;
                        duplicata.PlanoDeConta = cte.Empresa.Configuracao.PlanoCTe;

                        unidadeDeTrabalho.Start(System.Data.IsolationLevel.Serializable);

                        repDuplicata.Inserir(duplicata);

                        Dominio.Entidades.DuplicataCtes duplicataCte = new Dominio.Entidades.DuplicataCtes();
                        duplicataCte.Duplicata = duplicata;
                        duplicataCte.ConhecimentoDeTransporteEletronico = cte;
                        repDuplicataCtes.Inserir(duplicataCte);

                        if (parcelasCTe != null && parcelasCTe.Count > 0)
                        {
                            int numeroParcelas = parcelasCTe.Count;
                            DateTime dataVencimento = duplicata.DataDocumento.AddDays(cte.Empresa.Configuracao.DiasParaVencimentoDasDuplicatas);
                            Decimal valorParcelas = Math.Round(duplicata.Valor / numeroParcelas, 2, MidpointRounding.ToEven);

                            int numeroParcela = 1;
                            foreach (Dominio.Entidades.ParcelaCobrancaCTe parcelaCTe in parcelasCTe)
                            {
                                Dominio.Entidades.DuplicataParcelas parcela = new Dominio.Entidades.DuplicataParcelas();
                                parcela.Codigo = 0;
                                parcela.Duplicata = duplicata;
                                parcela.Parcela = numeroParcela;
                                parcela.Valor = parcelaCTe.Valor > 0 ? parcelaCTe.Valor : valorParcelas;
                                parcela.Status = Dominio.Enumeradores.StatusDuplicata.Pendente;
                                parcela.DataVcto = parcelaCTe.DataVencimento > DateTime.MinValue ? parcelaCTe.DataVencimento : dataVencimento;
                                repDuplicataParcelas.Inserir(parcela);

                                numeroParcela += numeroParcela;
                                dataVencimento = parcela.DataVcto.AddDays(cte.Empresa.Configuracao.DiasParaVencimentoDasDuplicatas);
                            }
                        }
                        else
                        {
                            int numeroParcelas = cte.Empresa.Configuracao.NumeroDeParcelasDasDuplicatas > 0 ? cte.Empresa.Configuracao.NumeroDeParcelasDasDuplicatas : 1;
                            DateTime dataVencimento = duplicata.DataDocumento.AddDays(cte.Empresa.Configuracao.DiasParaVencimentoDasDuplicatas);
                            Decimal valorParcelas = duplicata.Valor / numeroParcelas;

                            for (int i = 0; i < numeroParcelas; i++)
                            {
                                Dominio.Entidades.DuplicataParcelas parcela = new Dominio.Entidades.DuplicataParcelas();
                                parcela.Codigo = 0;
                                parcela.Duplicata = duplicata;
                                parcela.Parcela = i + 1;
                                parcela.Valor = valorParcelas;
                                parcela.Status = Dominio.Enumeradores.StatusDuplicata.Pendente;
                                parcela.DataVcto = dataVencimento;
                                repDuplicataParcelas.Inserir(parcela);

                                dataVencimento = parcela.DataVcto.AddDays(cte.Empresa.Configuracao.DiasParaVencimentoDasDuplicatas);
                            }
                        }

                        svcDuplicata.GerarMovimentoDoFinanceiro(duplicata.Empresa.Codigo, duplicata, unidadeDeTrabalho);

                        unidadeDeTrabalho.CommitChanges();
                    }
                    else if (cte.Status.Equals("C") && cte.Cancelado.Equals("S"))
                    {
                        Dominio.Entidades.DuplicataCtes duplicataCTe = repDuplicataCtes.BuscarPorCodigoCTe(cte.Codigo);
                        if (duplicataCTe != null && duplicataCTe.Duplicata.Status == "A")
                        {
                            List<Dominio.Entidades.DuplicataParcelas> parcelas = repDuplicataParcelas.BuscarPorDuplicata(duplicataCTe.Duplicata.Codigo);
                            if (parcelas.Where(o => o.Status == Dominio.Enumeradores.StatusDuplicata.Paga).Count() == 0)
                            {
                                duplicataCTe.Duplicata.Status = "I";
                                repDuplicata.Atualizar(duplicataCTe.Duplicata);

                                svcDuplicata.DeletarMovimentoDoFinanceiro(duplicataCTe.Duplicata, unidadeDeTrabalho);
                            }
                        }
                    }
                }
                else
                {
                    List<Dominio.Entidades.ParcelaCobrancaCTe> parcelas = repParcela.BuscarPorCTe(codigoEmpresa, cte.Codigo);

                    if (parcelas != null && parcelas.Count() > 0)
                    {
                        foreach (Dominio.Entidades.ParcelaCobrancaCTe parcela in parcelas)
                        {
                            Dominio.Entidades.MovimentoDoFinanceiro movimento = repMovimento.BuscarPorParcelaCobrancaCTe(codigoEmpresa, parcela.Codigo);

                            if (cte.Status.Equals("A"))
                            {
                                if (movimento == null)
                                    movimento = new Dominio.Entidades.MovimentoDoFinanceiro();

                                movimento.Data = DateTime.Today; //parcela.DataVencimento; Definido com Cesar devido a alteração para incluir o tipo do movimento, gerava movimento com data maior da data do dia.
                                movimento.Empresa = cte.Empresa;
                                movimento.Observacao = string.Concat("Ref. ao mov. " + parcela.Cobranca.Numero + "-" + parcela.Numero + " do CT-e ", cte.Numero, "-", cte.Serie.Numero, ".");
                                movimento.PlanoDeConta = cte.Empresa.Configuracao.PlanoCTe;
                                movimento.Valor = parcela.Valor;
                                movimento.Documento = parcela.Cobranca.Numero + "-" + parcela.Numero;
                                movimento.Tipo = Dominio.Enumeradores.TipoMovimento.Entrada;

                                double cpfCnpjTomador = 0f;
                                if (!cte.Tomador.Exterior && double.TryParse(Utilidades.String.OnlyNumbers(cte.Tomador.CPF_CNPJ), out cpfCnpjTomador))
                                    movimento.Pessoa = repCliente.BuscarPorCPFCNPJ(cpfCnpjTomador);

                                List<Dominio.Entidades.VeiculoCTE> veiculos = repVeiculoCTe.BuscarPorCTe(codigoEmpresa, cte.Codigo);
                                if (veiculos.Count() > 0)
                                {
                                    movimento.Veiculo = veiculos.Select(o => o.Veiculo).Where(o => o.TipoVeiculo.Equals("0")).FirstOrDefault();

                                    if (movimento.Veiculo == null)
                                        movimento.Veiculo = veiculos.Select(o => o.Veiculo).FirstOrDefault();
                                }

                                List<Dominio.Entidades.MotoristaCTE> motoristas = repMotoristaCTe.BuscarPorCTe(codigoEmpresa, cte.Codigo);
                                if (motoristas.Count() > 0)
                                    movimento.Motorista = repMotorista.BuscarMotoristaPorCPF(codigoEmpresa, motoristas.FirstOrDefault().CPFMotorista);

                                if (movimento.ParcelasCTe != null && movimento.ParcelasCTe.Count() > 0)
                                    movimento.ParcelasCTe.Clear();
                                else if (movimento.ParcelasCTe == null)
                                    movimento.ParcelasCTe = new List<Dominio.Entidades.ParcelaCobrancaCTe>();

                                movimento.ParcelasCTe.Add(parcela);

                                if (movimento.Codigo > 0)
                                    repMovimento.Atualizar(movimento);
                                else
                                    repMovimento.Inserir(movimento);

                            }
                            else if (cte.Status.Equals("C") && cte.Cancelado.Equals("S"))
                            {
                                if (movimento != null)
                                    repMovimento.Deletar(movimento);
                            }
                        }
                    }
                    else if (gerarMovimentoCTeSemParcelas)
                    {
                        if (cte.Status.Equals("A"))
                        {
                            Dominio.Entidades.MovimentoDoFinanceiro movimento = new Dominio.Entidades.MovimentoDoFinanceiro();

                            movimento.Data = DateTime.Today; //parcela.DataVencimento; Definido com Cesar devido a alteração para incluir o tipo do movimento, gerava movimento com data maior da data do dia.
                            movimento.Empresa = cte.Empresa;
                            movimento.Observacao = string.Concat("Ref. ao mov. do CT-e ", cte.Numero, "-", cte.Serie.Numero, ".");
                            movimento.PlanoDeConta = cte.Empresa.Configuracao.PlanoCTe;
                            movimento.Valor = cte.ValorAReceber;
                            movimento.Documento = string.Concat(cte.Numero, "-", cte.Serie.Numero);
                            movimento.Tipo = Dominio.Enumeradores.TipoMovimento.Entrada;

                            double cpfCnpjTomador = 0f;
                            if (!cte.Tomador.Exterior && double.TryParse(Utilidades.String.OnlyNumbers(cte.Tomador.CPF_CNPJ), out cpfCnpjTomador))
                                movimento.Pessoa = repCliente.BuscarPorCPFCNPJ(cpfCnpjTomador);

                            List<Dominio.Entidades.VeiculoCTE> veiculos = repVeiculoCTe.BuscarPorCTe(codigoEmpresa, cte.Codigo);
                            if (veiculos.Count() > 0)
                            {
                                movimento.Veiculo = veiculos.Select(o => o.Veiculo).Where(o => o.TipoVeiculo.Equals("0")).FirstOrDefault();

                                if (movimento.Veiculo == null)
                                    movimento.Veiculo = veiculos.Select(o => o.Veiculo).FirstOrDefault();
                            }

                            List<Dominio.Entidades.MotoristaCTE> motoristas = repMotoristaCTe.BuscarPorCTe(codigoEmpresa, cte.Codigo);
                            if (motoristas.Count() > 0)
                                movimento.Motorista = repMotorista.BuscarMotoristaPorCPF(codigoEmpresa, motoristas.FirstOrDefault().CPFMotorista);

                            if (movimento.Codigo > 0)
                                repMovimento.Atualizar(movimento);
                            else
                                repMovimento.Inserir(movimento);
                        }
                    }
                }
            }
        }

        public void EmitirAverbacaoOracle(int codigoAverbacao, ref int tentativas, Repositorio.UnitOfWork unitOfWork, string stringConexao)
        {
            Servicos.Averbacao svcAverbacao = new Servicos.Averbacao(unitOfWork);
            Repositorio.AverbacaoCTe repAverbacaoCTe = new Repositorio.AverbacaoCTe(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);

            Dominio.Entidades.AverbacaoCTe averbacao = repAverbacaoCTe.BuscarPorCodigo(codigoAverbacao);
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao = repConfiguracaoTMS.BuscarConfiguracaoPadrao();

            if (averbacao.Status != Dominio.Enumeradores.StatusAverbacaoCTe.AgEmissao)
                return;

            if (averbacao.ApoliceSeguroAverbacao == null || averbacao.ApoliceSeguroAverbacao.ApoliceSeguro == null)
                return;

            if (averbacao.AverbacaoImportada.HasValue && averbacao.AverbacaoImportada.Value == true)
                return;

            Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro apolice = averbacao.ApoliceSeguroAverbacao.ApoliceSeguro;

            Servicos.Log.TratarErro($"EmitirAverbacaoOracle CAA_CODIGO = {apolice.Codigo} + {apolice.SeguradoraAverbacao.Descricao()}", "Averbacao");

            if (apolice.SeguradoraAverbacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SeguradoraAverbacao.ATM)
            {
                if (configuracao.UtilizarWebServiceRestATM && averbacao.CTe != null && averbacao.CTe.ModeloDocumentoFiscal != null && averbacao.CTe.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.CTe && averbacao.Forma != Dominio.Enumeradores.FormaAverbacaoCTE.Provisoria)
                    Servicos.Embarcador.Integracao.ATM.ATMRestIntegracao.AverbarDocumento(apolice, averbacao, ref tentativas, unitOfWork, stringConexao);
                else
                    Servicos.Embarcador.Integracao.ATM.ATMIntegracao.AverbarDocumento(apolice, averbacao, ref tentativas, unitOfWork, stringConexao);
            }
            else if (apolice.SeguradoraAverbacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SeguradoraAverbacao.Senig)
                new Servicos.Embarcador.Integracao.Senig.AverbacaoSenig(unitOfWork).AverbarDocumento(apolice, averbacao, ref tentativas);
            else if (apolice.SeguradoraAverbacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SeguradoraAverbacao.ELT)
                Servicos.Embarcador.Integracao.ELT.IntegracaoELT.AverbarDocumento(apolice, averbacao, unitOfWork);
            else if (apolice.SeguradoraAverbacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SeguradoraAverbacao.PortoSeguro)
                Servicos.Embarcador.Integracao.PortoSeguro.IntegracaoPortoSeguro.AverbarDocumento(apolice, averbacao, ref tentativas, unitOfWork, string.Empty, string.Empty);
            else if (apolice.SeguradoraAverbacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SeguradoraAverbacao.Bradesco && (configuracao?.UtilizarIntegracaoAverbacaoBradescoEmbarcador ?? false))
                new Servicos.Embarcador.Integracao.Bradesco.IntegracaoBradescoAverbacao(unitOfWork).AverbarDocumento(apolice, averbacao, ref tentativas);
            else
            {
                int codigoIntegracao = 0;

                bool envioSucesso = svcAverbacao.AverbarCTeEmbarcador(averbacao, Dominio.Enumeradores.TipoAverbacaoCTe.Autorizacao, ref codigoIntegracao, unitOfWork);

                if (!envioSucesso)
                {
                    averbacao.Status = Dominio.Enumeradores.StatusAverbacaoCTe.Rejeicao;
                    averbacao.MensagemRetorno = "Erro ao enviar averbação";
                }
                else
                {
                    averbacao.Status = Dominio.Enumeradores.StatusAverbacaoCTe.Enviado;
                    averbacao.CodigoIntegracao = codigoIntegracao; // Seta codigo de retorno
                    averbacao.MensagemRetorno = "";
                }
                averbacao.Tipo = Dominio.Enumeradores.TipoAverbacaoCTe.Autorizacao;

                repAverbacaoCTe.Atualizar(averbacao);
            }
        }

        public void CancelarAverbacaoOracle(int codigoAverbacao, ref int tentativa, Repositorio.UnitOfWork unitOfWork, string stringConexao)
        {
            Servicos.Averbacao svcAverbacao = new Servicos.Averbacao(unitOfWork);
            Repositorio.AverbacaoCTe repAverbacaoCTe = new Repositorio.AverbacaoCTe(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);

            Dominio.Entidades.AverbacaoCTe averbacao = repAverbacaoCTe.BuscarPorCodigo(codigoAverbacao);
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao = repConfiguracaoTMS.BuscarConfiguracaoPadrao();

            if (averbacao.Status != Dominio.Enumeradores.StatusAverbacaoCTe.AgCancelamento)
                return;

            if (averbacao.AverbacaoImportada.HasValue && averbacao.AverbacaoImportada.Value == true)
                return;

            if (averbacao.ApoliceSeguroAverbacao == null)
            {
                averbacao.Tipo = Dominio.Enumeradores.TipoAverbacaoCTe.Cancelamento;
                averbacao.Status = Dominio.Enumeradores.StatusAverbacaoCTe.Rejeicao;
                averbacao.MensagemRetorno = "Sem Apolice Seguro.";

                repAverbacaoCTe.Atualizar(averbacao);

                return;
            }

            Dominio.Entidades.Embarcador.Seguros.ApoliceSeguro apolice = averbacao.ApoliceSeguroAverbacao.ApoliceSeguro;

            if (apolice.SeguradoraAverbacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SeguradoraAverbacao.ATM)
            {
                if (configuracao.UtilizarWebServiceRestATM && averbacao.CTe != null && averbacao.CTe.ModeloDocumentoFiscal != null && averbacao.CTe.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.CTe)
                    Servicos.Embarcador.Integracao.ATM.ATMRestIntegracao.CancelarAverbacaoDocumento(apolice, averbacao, ref tentativa, unitOfWork, stringConexao);
                else
                    Servicos.Embarcador.Integracao.ATM.ATMIntegracao.CancelarAverbacaoDocumento(apolice, averbacao, ref tentativa, unitOfWork, stringConexao);
            }
            else if (apolice.SeguradoraAverbacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SeguradoraAverbacao.ELT)
                Servicos.Embarcador.Integracao.ELT.IntegracaoELT.CancelarAverbacaoDocumento(apolice, averbacao, unitOfWork);
            else if (apolice.SeguradoraAverbacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SeguradoraAverbacao.Senig)
                new Servicos.Embarcador.Integracao.Senig.AverbacaoSenig(unitOfWork).CancelarAverbacaoDocumento(apolice, averbacao, ref tentativa);
            else if (apolice.SeguradoraAverbacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SeguradoraAverbacao.PortoSeguro)
                Servicos.Embarcador.Integracao.PortoSeguro.IntegracaoPortoSeguro.CancelarAverbacaoDocumento(apolice, averbacao, ref tentativa, unitOfWork, string.Empty, string.Empty);
            else if (apolice.SeguradoraAverbacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SeguradoraAverbacao.Bradesco && (configuracao?.UtilizarIntegracaoAverbacaoBradescoEmbarcador ?? false))
                new Servicos.Embarcador.Integracao.Bradesco.IntegracaoBradescoAverbacao(unitOfWork).CancelarAverbacaoDocumento(apolice, averbacao, ref tentativa);
            else
            {
                int codigoIntegracao = 0;

                bool envioSucesso = svcAverbacao.AverbarCTeEmbarcador(averbacao, Dominio.Enumeradores.TipoAverbacaoCTe.Cancelamento, ref codigoIntegracao, unitOfWork);

                if (!envioSucesso)
                {
                    averbacao.Status = Dominio.Enumeradores.StatusAverbacaoCTe.Sucesso;
                    averbacao.MensagemRetorno = "Erro ao cancelar averbação";
                }
                else
                {
                    averbacao.CodigoIntegracao = codigoIntegracao;
                    averbacao.Status = Dominio.Enumeradores.StatusAverbacaoCTe.Enviado;
                }

                averbacao.Tipo = Dominio.Enumeradores.TipoAverbacaoCTe.Cancelamento;

                repAverbacaoCTe.Atualizar(averbacao);
            }
        }

        public void AjustarAverbacoesParaAutorizacao(int codigoCTe, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.AverbacaoCTe repAverbacaoCTe = new Repositorio.AverbacaoCTe(unitOfWork);

            List<Dominio.Entidades.AverbacaoCTe> averbacoes = repAverbacaoCTe.BuscarPorCTe(codigoCTe);

            List<Dominio.Entidades.AverbacaoCTe> averbacoesPendentes = averbacoes.Where(o => o.Status == Dominio.Enumeradores.StatusAverbacaoCTe.Pendente).ToList();

            for (int i = 0; i < averbacoesPendentes.Count; i++)
            {
                Dominio.Entidades.AverbacaoCTe averbacao = averbacoesPendentes[i];
                averbacao.Status = Dominio.Enumeradores.StatusAverbacaoCTe.AgEmissao;
                repAverbacaoCTe.Atualizar(averbacao);
            }
            if (averbacoesPendentes.Count == 0)
            {
                foreach (var averbacao in averbacoes)
                    Servicos.Log.TratarErro($"Ave. Cod {averbacao.Codigo} situacao: {averbacao.Status}", "CTEAUTORIZADO_AVERBACAO_NOT_PENDENTE");
            }
        }

        public void AjustarAverbacoesParaCancelamento(int codigoCTe, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.AverbacaoCTe repAverbacaoCTe = new Repositorio.AverbacaoCTe(unitOfWork);

            List<Dominio.Entidades.AverbacaoCTe> averbacoes = repAverbacaoCTe.BuscarPorCTeESituacao(codigoCTe, Dominio.Enumeradores.StatusAverbacaoCTe.Sucesso);

            int countAverbacoes = averbacoes.Count;

            for (int i = 0; i < countAverbacoes; i++)
            {
                Dominio.Entidades.AverbacaoCTe averbacao = averbacoes[i];

                if (averbacao.AverbacaoImportada != true)
                {
                    averbacao.Status = Dominio.Enumeradores.StatusAverbacaoCTe.AgCancelamento;
                    repAverbacaoCTe.Atualizar(averbacao);
                }
            }
        }

        public void EmitirAverbacoesOracle(int codigoEmpresa, int codigoCTe, Dominio.Enumeradores.StatusAverbacaoCTe situacao, Repositorio.UnitOfWork unitOfWork)
        {
            // Busca todas as averbações do CTe e envia para o Oracle averbar
            Servicos.Averbacao svcAverbacao = new Servicos.Averbacao(unitOfWork);
            Repositorio.AverbacaoCTe repAverbacaoCTe = new Repositorio.AverbacaoCTe(unitOfWork);

            // Busca as averbacoes
            List<Dominio.Entidades.AverbacaoCTe> averbacoes = repAverbacaoCTe.BuscarPorCTesAutorizadosESituacao(codigoEmpresa, codigoCTe, situacao);

            for (int i = 0; i < averbacoes.Count; i++)
            {
                Dominio.Entidades.AverbacaoCTe averbacao = averbacoes[i];
                averbacao.Status = Dominio.Enumeradores.StatusAverbacaoCTe.AgEmissao;
                repAverbacaoCTe.Atualizar(averbacao);

            }
        }

        public void ObterESalvarXMLAutorizacaoOracle(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, bool armazenarEmArquivo, Dominio.ObjetosDeValor.WebService.CTe.CTeOracle retorno, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (cte != null)
            {
                if (retorno == null)
                {
                    ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unidadeDeTrabalho).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);
                    ServicoCTe.RetornoCTE retornows = svcCTe.ConsultaProtocoloCte(cte.CodigoCTeIntegrador);
                    ObterESalvarXMLAutorizacao(cte, armazenarEmArquivo, retornows, unidadeDeTrabalho);
                }
                else
                {
                    if (!string.IsNullOrWhiteSpace(retorno.XML))
                    {
                        Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeDeTrabalho);

                        Dominio.Entidades.XMLCTe xmlCTe = repXMLCTe.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.Autorizacao);

                        if (xmlCTe == null)
                            xmlCTe = new Dominio.Entidades.XMLCTe();

                        if (armazenarEmArquivo)
                        {
                            string arquivo = CriarERetornarCaminhoXMLCTe(cte, "A", unidadeDeTrabalho);
                            if (!Utilidades.IO.FileStorageService.Storage.Exists(arquivo))
                                Utilidades.IO.FileStorageService.Storage.WriteAllText(arquivo, retorno.XML);
                            xmlCTe.XMLArmazenadoEmArquivo = true;
                            xmlCTe.XML = "";
                        }
                        else
                        {
                            xmlCTe.XMLArmazenadoEmArquivo = false;
                            xmlCTe.XML = retorno.XML;
                        }

                        xmlCTe.CTe = cte;
                        xmlCTe.Tipo = Dominio.Enumeradores.TipoXMLCTe.Autorizacao;


                        if (xmlCTe.Codigo > 0)
                            repXMLCTe.Atualizar(xmlCTe);
                        else
                            repXMLCTe.Inserir(xmlCTe);

                    }
                }

            }
        }

        public string ObterStringESalvarXMLAutorizacaoOracle(Dominio.Entidades.XMLCTe xml, Repositorio.UnitOfWork unitOfWork)
        {
            if (xml == null)
                return null;

            Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unitOfWork);

            ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unitOfWork).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);
            ServicoCTe.RetornoCTE retornows = svcCTe.ConsultaProtocoloCte(xml.CTe.CodigoCTeIntegrador);

            string arquivo = CriarERetornarCaminhoXMLCTe(xml.CTe, "A", unitOfWork);
            Utilidades.IO.FileStorageService.Storage.WriteAllText(arquivo, retornows.XML);

            xml.XMLArmazenadoEmArquivo = true;
            xml.XML = string.Empty;

            repXMLCTe.Atualizar(xml);

            return retornows.XML;
        }

        public void ObterESalvarXMLNFSAutorizacao(int codigoCTe, int codigoEmpresa, bool armazenarEmArquivo, ServicoNFSe.RetornoNFSe retorno = null, Repositorio.UnitOfWork unidadeDeTrabalho = null)
        {
            if (unidadeDeTrabalho == null)
                unidadeDeTrabalho = new Repositorio.UnitOfWork(StringConexao);

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorId(codigoCTe, codigoEmpresa);

            if (cte != null)
            {
                if (retorno == null)
                {
                    ServicoNFSe.uNFSeServiceTSSoapClient svcNFSe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unidadeDeTrabalho).ObterClient<ServicoNFSe.uNFSeServiceTSSoapClient, ServicoNFSe.uNFSeServiceTSSoap>(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoWebServiceIntegracao.Oracle_uNFSeServiceTS);
                    retorno = svcNFSe.ConsultarNFSePorCodigo(cte.RPS.CodigoIntegracao);
                }

                if (!string.IsNullOrWhiteSpace(retorno.XML))
                {
                    Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeDeTrabalho);

                    Dominio.Entidades.XMLCTe xmlCTe = repXMLCTe.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.Autorizacao);

                    if (xmlCTe == null)
                        xmlCTe = new Dominio.Entidades.XMLCTe();

                    xmlCTe.CTe = cte;
                    xmlCTe.Tipo = Dominio.Enumeradores.TipoXMLCTe.Autorizacao;

                    if (armazenarEmArquivo)
                    {
                        string arquivo = CriarERetornarCaminhoXMLCTe(cte, "A", unidadeDeTrabalho);
                        Utilidades.IO.FileStorageService.Storage.WriteAllText(arquivo, retorno.XML);
                        xmlCTe.XMLArmazenadoEmArquivo = true;
                        xmlCTe.XML = "";
                    }
                    else
                    {
                        xmlCTe.XMLArmazenadoEmArquivo = false;
                        xmlCTe.XML = retorno.XML;
                    }


                    if (xmlCTe.Codigo > 0)
                        repXMLCTe.Atualizar(xmlCTe);
                    else
                        repXMLCTe.Inserir(xmlCTe);
                }
            }
        }

        public void ObterESalvarXMLAutorizacaoNFSeOracle(int codigoCTe, int codigoEmpresa, bool armazenarEmArquivo, Repositorio.UnitOfWork unidadeDeTrabalho, Dominio.ObjetosDeValor.WebService.NFSe.NFSeOracle retorno = null)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);
            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorId(codigoCTe, codigoEmpresa);

            if (cte != null)
            {
                if (retorno == null)
                {
                    ObterESalvarXMLNFSAutorizacao(codigoCTe, codigoEmpresa, armazenarEmArquivo, null, unidadeDeTrabalho);
                }
                else
                {
                    if (!string.IsNullOrWhiteSpace(retorno.XML))
                    {
                        Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeDeTrabalho);

                        Dominio.Entidades.XMLCTe xmlCTe = repXMLCTe.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.Autorizacao);

                        if (xmlCTe == null)
                            xmlCTe = new Dominio.Entidades.XMLCTe();

                        if (armazenarEmArquivo)
                        {
                            string arquivo = CriarERetornarCaminhoXMLCTe(cte, "A", unidadeDeTrabalho);
                            Utilidades.IO.FileStorageService.Storage.WriteAllText(arquivo, retorno.XML);
                            xmlCTe.XMLArmazenadoEmArquivo = true;
                            xmlCTe.XML = "";
                        }
                        else
                        {
                            xmlCTe.XMLArmazenadoEmArquivo = false;
                            xmlCTe.XML = retorno.XML;
                        }

                        xmlCTe.CTe = cte;
                        xmlCTe.Tipo = Dominio.Enumeradores.TipoXMLCTe.Autorizacao;


                        if (xmlCTe.Codigo > 0)
                            repXMLCTe.Atualizar(xmlCTe);
                        else
                            repXMLCTe.Inserir(xmlCTe);

                    }
                }

            }
        }

        public string ObterDiretorioArmazenamentoXMLCTeArquivo(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, string status, Repositorio.UnitOfWork unitOfWork)
        {

            string caminho = ObterConfiguracaoArquivo(unitOfWork).CaminhoRetornoXMLIntegrador;

            if (cte.TipoAmbiente == Dominio.Enumeradores.TipoAmbiente.Producao)
                caminho = Utilidades.IO.FileStorageService.Storage.Combine(caminho, "Producao");
            else
                caminho = Utilidades.IO.FileStorageService.Storage.Combine(caminho, "Homologacao");

            if (status == "A")
                caminho = Utilidades.IO.FileStorageService.Storage.Combine(caminho, "Autorizacao");
            else if (status == "C" || status == "I")
                caminho = Utilidades.IO.FileStorageService.Storage.Combine(caminho, "Cancelamento");
            else
                caminho = Utilidades.IO.FileStorageService.Storage.Combine(caminho, "Outros");

            caminho = Utilidades.IO.FileStorageService.Storage.Combine(caminho, cte.Empresa.CNPJ_SemFormato);

            caminho = Utilidades.IO.FileStorageService.Storage.Combine(caminho, cte.DataEmissao.Value.Month + "-" + cte.DataEmissao.Value.Year);

            return caminho;
        }

        public string ObterCaminhoArmazenamentoXMLCTeArquivo(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, string status, Repositorio.UnitOfWork unitOfWork)
        {
            string caminho = ObterDiretorioArmazenamentoXMLCTeArquivo(cte, status, unitOfWork);

            if (status == "I")
                caminho = Utilidades.IO.FileStorageService.Storage.Combine(caminho, $"{cte.Empresa.CNPJ}_{cte.Numero}_{cte.Serie.Numero}.xml");
            else
                caminho = Utilidades.IO.FileStorageService.Storage.Combine(caminho, cte.Chave + ".xml");

            return caminho;
        }

        public string CriarERetornarCaminhoXMLCTe(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, string status, Repositorio.UnitOfWork unitOfWork)
        {
            string arquivo = ObterCaminhoArmazenamentoXMLCTeArquivo(cte, status, unitOfWork);

            return arquivo;
        }

        public void ObterESalvarXMLAutorizacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int codigoEmpresa, bool armazenarEmArquivo, ServicoCTe.RetornoCTE retorno = null, Repositorio.UnitOfWork unidadeDeTrabalho = null)
        {
            if (unidadeDeTrabalho == null)
                unidadeDeTrabalho = new Repositorio.UnitOfWork(StringConexao);

            if (cte != null)
            {
                if (retorno == null)
                {
                    ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unidadeDeTrabalho).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);
                    retorno = svcCTe.ConsultaProtocoloCte(cte.CodigoCTeIntegrador);
                }

                if (!string.IsNullOrWhiteSpace(retorno.XML))
                {
                    Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeDeTrabalho);

                    Dominio.Entidades.XMLCTe xmlCTe = repXMLCTe.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.Autorizacao);

                    if (xmlCTe == null)
                        xmlCTe = new Dominio.Entidades.XMLCTe();

                    xmlCTe.CTe = cte;
                    xmlCTe.Tipo = Dominio.Enumeradores.TipoXMLCTe.Autorizacao;

                    if (armazenarEmArquivo)
                    {
                        string arquivo = CriarERetornarCaminhoXMLCTe(cte, "A", unidadeDeTrabalho);
                        Utilidades.IO.FileStorageService.Storage.WriteAllText(arquivo, retorno.XML);
                        xmlCTe.XMLArmazenadoEmArquivo = true;
                        xmlCTe.XML = "";
                    }
                    else
                    {
                        xmlCTe.XMLArmazenadoEmArquivo = false;
                        xmlCTe.XML = retorno.XML;
                    }

                    if (xmlCTe.Codigo > 0)
                        repXMLCTe.Atualizar(xmlCTe);
                    else
                        repXMLCTe.Inserir(xmlCTe);
                }
            }
        }

        public byte[] ObterESalvarXMLAutorizacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, bool armazenarEmArquivo, ServicoCTe.RetornoCTE retorno = null, Repositorio.UnitOfWork unidadeDeTrabalho = null)
        {
            byte[] retArquivo = null;

            if (cte != null)
            {
                if (unidadeDeTrabalho == null)
                    unidadeDeTrabalho = new Repositorio.UnitOfWork(StringConexao);

                if (retorno == null)
                {
                    ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unidadeDeTrabalho).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);
                    retorno = svcCTe.ConsultaProtocoloCte(cte.CodigoCTeIntegrador);
                }

                if (!string.IsNullOrWhiteSpace(retorno.XML))
                {
                    Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeDeTrabalho);
                    Dominio.Entidades.XMLCTe xmlCTe = repXMLCTe.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.Autorizacao);

                    if (xmlCTe == null)
                        xmlCTe = new Dominio.Entidades.XMLCTe();

                    xmlCTe.CTe = cte;
                    xmlCTe.Tipo = Dominio.Enumeradores.TipoXMLCTe.Autorizacao;

                    if (armazenarEmArquivo)
                    {
                        string arquivo = CriarERetornarCaminhoXMLCTe(cte, "A", unidadeDeTrabalho);
                        Utilidades.IO.FileStorageService.Storage.WriteAllText(arquivo, retorno.XML);
                        xmlCTe.XMLArmazenadoEmArquivo = true;
                        xmlCTe.XML = "";
                    }
                    else
                    {
                        xmlCTe.XMLArmazenadoEmArquivo = false;
                        xmlCTe.XML = retorno.XML;
                    }

                    if (xmlCTe.Codigo > 0)
                        repXMLCTe.Atualizar(xmlCTe);
                    else
                        repXMLCTe.Inserir(xmlCTe);

                    retArquivo = Encoding.UTF8.GetBytes(retorno.XML);
                }
            }

            return retArquivo;
        }

        public void ObterESalvarDACTEOracle(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.ObjetosDeValor.WebService.CTe.CTeOracle retorno, string contingencia, Repositorio.UnitOfWork unitOfWork, byte[] dacte = null)
        {
            string diretorio = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoArquivo().CaminhoRelatorios;
            if (!string.IsNullOrWhiteSpace(diretorio))
            {
                if (cte != null)
                {
                    if (retorno != null)
                    {
                        if (!string.IsNullOrWhiteSpace(retorno.PDFDacte) || dacte != null)
                        {
                            byte[] decodedData = null;
                            if (dacte != null)
                                decodedData = dacte;
                            else
                            {
                                string texto = Encoding.UTF8.GetString(Convert.FromBase64String(retorno.PDFDacte));
                                var windows1252 = Encoding.GetEncoding("Windows-1252");
                                decodedData = windows1252.GetBytes(texto);
                            }

                            string caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoArquivo().CaminhoRelatorios, cte.Empresa.CNPJ, cte.Chave);

                            if (string.IsNullOrWhiteSpace(contingencia))
                                caminhoPDF = caminhoPDF + ".pdf";
                            else
                                caminhoPDF = caminhoPDF + "_" + contingencia + ".pdf";

                            Utilidades.IO.FileStorageService.Storage.WriteAllBytes(caminhoPDF, decodedData);
                        }
                    }
                }
            }
        }

        public void ObterESalvarDANFSEOracle(int codigoCTe, int codigoEmpresa, Repositorio.UnitOfWork unidadeDeTrabalho, Dominio.ObjetosDeValor.WebService.NFSe.NFSeOracle retorno = null)
        {
            string diretorio = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoArquivo().CaminhoRelatorios;
            if (!string.IsNullOrWhiteSpace(diretorio))
            {
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);

                Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorId(codigoCTe, codigoEmpresa);

                if (cte != null)
                {
                    if (retorno != null)
                    {
                        if (!string.IsNullOrWhiteSpace(retorno.PDF))
                        {
                            string texto = Encoding.UTF8.GetString(Convert.FromBase64String(retorno.PDF));
                            var windows1252 = Encoding.GetEncoding("Windows-1252");
                            byte[] decodedData = windows1252.GetBytes(texto);

                            string caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoArquivo().CaminhoRelatorios, "NFSe", cte.Empresa.CNPJ, cte.Codigo.ToString() + "_" + cte.Numero.ToString() + "_" + cte.Serie.Numero.ToString()) + ".pdf";

                            Utilidades.IO.FileStorageService.Storage.WriteAllBytes(caminhoPDF, decodedData);
                        }
                    }
                }
            }
        }

        public void ObterESalvarDACTE(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int codigoEmpresa, ServicoCTe.RetornoCTE retorno = null, Repositorio.UnitOfWork unidadeDeTrabalho = null, string contingencia = "")
        {
            if (unidadeDeTrabalho == null)
                unidadeDeTrabalho = new Repositorio.UnitOfWork(StringConexao);

            if (!string.IsNullOrWhiteSpace(ObterConfiguracaoArquivo(unidadeDeTrabalho).CaminhoRelatorios))
            {
                if (cte != null)
                {
                    if (retorno == null && cte.SistemaEmissor == TipoEmissorDocumento.Integrador)
                    {
                        ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unidadeDeTrabalho).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);
                        retorno = svcCTe.ConsultaProtocoloCte(cte.CodigoCTeIntegrador);
                    }

                    if (!string.IsNullOrWhiteSpace(retorno.PDFDacte))
                    {
                        string texto = Encoding.UTF8.GetString(Convert.FromBase64String(retorno.PDFDacte));
                        var windows1252 = Encoding.GetEncoding("Windows-1252");
                        byte[] decodedData = windows1252.GetBytes(texto);

                        string caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(ObterConfiguracaoArquivo(unidadeDeTrabalho).CaminhoRelatorios, cte.Empresa.CNPJ, cte.Chave);

                        if (string.IsNullOrWhiteSpace(contingencia))
                            caminhoPDF = caminhoPDF + ".pdf";
                        else
                            caminhoPDF = caminhoPDF + "_" + contingencia + ".pdf";

                        Utilidades.IO.FileStorageService.Storage.WriteAllBytes(caminhoPDF, decodedData);
                    }
                }
            }
        }

        public void ObterESalvarXMLInutilizacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, string xml, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (!string.IsNullOrWhiteSpace(xml) && cte != null)
            {
                Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeDeTrabalho);
                Dominio.Entidades.XMLCTe xmlCTe = repXMLCTe.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.Cancelamento);

                if (xmlCTe == null)
                    xmlCTe = new Dominio.Entidades.XMLCTe();

                xmlCTe.CTe = cte;
                xmlCTe.Tipo = Dominio.Enumeradores.TipoXMLCTe.Cancelamento;
                xmlCTe.XML = xml;

                if (xmlCTe.Codigo > 0)
                    repXMLCTe.Atualizar(xmlCTe);
                else
                    repXMLCTe.Inserir(xmlCTe);
            }
        }

        public byte[] ObterESalvarXMLCancelamento(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int codigoEmpresa, bool armazenarEmArquivo, ServicoCTe.RetornoCTE retorno = null, Repositorio.UnitOfWork unidadeDeTrabalho = null)
        {
            byte[] retArquivo = null;

            if (cte != null)
            {
                if (unidadeDeTrabalho == null)
                    unidadeDeTrabalho = new Repositorio.UnitOfWork(StringConexao);

                if (retorno == null)
                {
                    ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unidadeDeTrabalho).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);

                    if (cte.CodigoCTeIntegrador > 0)
                        retorno = svcCTe.ConsultaProtocoloCte(cte.CodigoCTeIntegrador);
                    else
                        retorno = svcCTe.ConsultaProtocoloCteChave(cte.Chave);
                }

                if (!string.IsNullOrWhiteSpace(retorno.XMLCancelamento))
                {
                    Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeDeTrabalho);

                    Dominio.Entidades.XMLCTe xmlCTe = repXMLCTe.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.Cancelamento);

                    if (xmlCTe == null)
                        xmlCTe = new Dominio.Entidades.XMLCTe();

                    xmlCTe.CTe = cte;
                    xmlCTe.Tipo = Dominio.Enumeradores.TipoXMLCTe.Cancelamento;

                    if (armazenarEmArquivo)
                    {
                        string arquivo = CriarERetornarCaminhoXMLCTe(cte, "C", unidadeDeTrabalho);
                        Utilidades.IO.FileStorageService.Storage.WriteAllText(arquivo, retorno.XMLCancelamento);
                        xmlCTe.XMLArmazenadoEmArquivo = true;
                        xmlCTe.XML = "";
                    }
                    else
                    {
                        xmlCTe.XMLArmazenadoEmArquivo = false;
                        xmlCTe.XML = retorno.XMLCancelamento;
                    }

                    if (xmlCTe.Codigo > 0)
                        repXMLCTe.Atualizar(xmlCTe);
                    else
                        repXMLCTe.Inserir(xmlCTe);

                    retArquivo = Encoding.UTF8.GetBytes(retorno.XMLCancelamento);
                }
            }

            return retArquivo;
        }

        public void RemoverVinculoComNotasFiscais(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (cte != null)
            {
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeTrabalho);
                List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> notasCTe = repXMLNotaFiscal.BuscarPorCTe(cte);
                if (notasCTe != null && notasCTe.Count > 0)
                {
                    foreach (Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal nota in notasCTe)
                    {
                        if (!repXMLNotaFiscal.ContemNotaEmOutroCTe(nota.Chave, cte.Codigo))
                        {
                            nota.nfAtiva = false;
                            repXMLNotaFiscal.Atualizar(nota);
                        }
                    }
                }

            }
        }

        public void ObterESalvarXMLCancelamentoInutilizacao(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.ObjetosDeValor.WebService.CTe.CTeOracle cteOracle, bool armazenarEmArquivo, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (cte != null)
            {
                if (!string.IsNullOrWhiteSpace(cteOracle.XMLCancelamento))
                {
                    Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeTrabalho);

                    Dominio.Entidades.XMLCTe xmlCTe = repXMLCTe.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.Cancelamento);

                    if (xmlCTe == null)
                        xmlCTe = new Dominio.Entidades.XMLCTe();

                    if (armazenarEmArquivo)
                    {
                        string arquivo = CriarERetornarCaminhoXMLCTe(cte, cte.Status, unidadeTrabalho);
                        if (!Utilidades.IO.FileStorageService.Storage.Exists(arquivo))
                            Utilidades.IO.FileStorageService.Storage.WriteAllText(arquivo, cteOracle.XMLCancelamento);
                        xmlCTe.XMLArmazenadoEmArquivo = true;
                        xmlCTe.XML = "";
                    }
                    else
                    {
                        xmlCTe.XMLArmazenadoEmArquivo = false;
                        xmlCTe.XML = cteOracle.XMLCancelamento;
                    }

                    xmlCTe.CTe = cte;
                    xmlCTe.Tipo = Dominio.Enumeradores.TipoXMLCTe.Cancelamento;

                    if (xmlCTe.Codigo > 0)
                        repXMLCTe.Atualizar(xmlCTe);
                    else
                        repXMLCTe.Inserir(xmlCTe);
                }
            }
        }

        public bool Inutilizar(int codigoCTe, int codigoEmpresa, string justificativa, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork = null, bool gerarLog = false, Dominio.Entidades.Usuario usuario = null)
        {
            unitOfWork = unitOfWork ?? new Repositorio.UnitOfWork(StringConexao);

            ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unitOfWork).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorId(codigoCTe, codigoEmpresa);

            TimeZoneInfo fusoHorarioEmpresa = TimeZoneInfo.FindSystemTimeZoneById(cte.Empresa.FusoHorario);
            DateTime dataFuso = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day, DateTime.Now.Hour, DateTime.Now.Minute, 0);

            bool horarioVerao = fusoHorarioEmpresa.IsDaylightSavingTime(cte.DataEmissao.HasValue ? cte.DataEmissao.Value : DateTime.Today);
            string fusoHorario = horarioVerao ? AjustarFuso(fusoHorarioEmpresa.BaseUtcOffset.Hours + 1, fusoHorarioEmpresa.BaseUtcOffset.Minutes) : AjustarFuso(fusoHorarioEmpresa.BaseUtcOffset.Hours, fusoHorarioEmpresa.BaseUtcOffset.Minutes);

            if (InutilizarCteGerencialmente(justificativa, cte, tipoServicoMultisoftware, unitOfWork))
            {
                repCTe.Atualizar(cte);
                return true;
            }
            else
            {
                ServicoCTe.ResultadoString retorno = svcCTe.Inutilizacao(cte.Empresa.CNPJ, justificativa, DateTime.Now.Year, int.Parse(cte.ModeloDocumentoFiscal.Numero), cte.Serie.Numero, cte.Numero, cte.Numero, (int)cte.TipoAmbiente, fusoHorario);
                cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat(retorno.Info.Mensagem, " - ", retorno.Info.MensagemOriginal));
                cte.ProtocoloCancelamentoInutilizacao = retorno.Valor;
                cte.ObservacaoCancelamento = justificativa;

                if (gerarLog && usuario != null)
                    cte.Log = string.Concat(cte.Log, " Enviado inutilização por ", usuario.CPF, " - ", usuario.Nome, " em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");

                if (retorno.Info.Tipo == "OK")
                {
                    cte.Status = "L";
                    repCTe.Atualizar(cte);
                    return true;
                }
                else
                {
                    repCTe.Atualizar(cte);
                    return false;
                }
            }
        }

        public byte[] ObterDACTE(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unitOfWork)
        {
            if (cte == null || !(cte.Status == "A" || cte.Status == "C" || cte.Status == "K" || cte.Status == "F" || cte.Status == "Q") || string.IsNullOrWhiteSpace(cte.Chave))
                return null;

            if (string.IsNullOrWhiteSpace(ObterConfiguracaoArquivo(unitOfWork).CaminhoRelatorios))
                throw new Exception("O caminho para os download da DACTE não está disponível.");

            string caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(ObterConfiguracaoArquivo(unitOfWork).CaminhoRelatorios, cte.Empresa.CNPJ, cte.Chave);

            if (cte.Status == "F")
                caminhoPDF = caminhoPDF + "_FSDA";

            caminhoPDF = caminhoPDF + ".pdf";

            ////Buscar DACTE do Oracle
            if (!Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF) /*&& Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoArquivo().RegerarDACTEOracle != "NAO"*/)
            {
                Servicos.CTe servicoCTe = new Servicos.CTe(unitOfWork);
                servicoCTe.ObterESalvarDACTE(cte, cte.Empresa.Codigo, null, unitOfWork);
            }

            if (!Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF))
            {
                if (string.IsNullOrWhiteSpace(ObterConfiguracaoArquivo(unitOfWork).CaminhoGeradorRelatorios))
                    throw new Exception("O gerador da DACTE não está disponível. Contate o suporte técnico.");

                Servicos.DACTE svcDACTE = new Servicos.DACTE(unitOfWork);

                return svcDACTE.GerarPorProcesso(cte.Codigo, unitOfWork);
            }
            else
                return Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminhoPDF);
        }

        public string ObterDACTE(int codigoCTe, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork = null, bool codificarUTF8 = true, bool retornarComoBinario = false)
        {
            Repositorio.UnitOfWork unidadeDeTrabalho = unitOfWork ?? new Repositorio.UnitOfWork(StringConexao);

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorId(codigoCTe, codigoEmpresa);

            byte[] dacte = ObterDACTE(cte, unidadeDeTrabalho);
            if (dacte == null)
                return null;

            string stringDacte;
            if (!retornarComoBinario)
            {
                if (codificarUTF8)
                    stringDacte = Convert.ToBase64String(Encoding.Convert(Encoding.GetEncoding("ISO-8859-1"), Encoding.UTF8, dacte));
                else
                    stringDacte = Convert.ToBase64String(dacte);
            }
            else
                stringDacte = Encoding.Default.GetString(dacte);

            if (!string.IsNullOrWhiteSpace(stringDacte))
                return stringDacte;

            return null;
        }

        public byte[] ObterXMLAutorizacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte)
        {
            Repositorio.UnitOfWork unidadeDeTrabalho = new Repositorio.UnitOfWork(StringConexao);

            try
            {
                return ObterXMLAutorizacao(cte, unidadeDeTrabalho, null, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS);
            }
            finally
            {
                unidadeDeTrabalho.Dispose();
            }
        }

        public byte[] ObterXMLAutorizacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeTrabalho, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado = null, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware = TipoServicoMultisoftware.MultiTMS)
        {
            if (cte != null)
            {
                Repositorio.XMLCTe repXML = new Repositorio.XMLCTe(unidadeTrabalho);
                Dominio.Entidades.XMLCTe xml = repXML.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.Autorizacao);

                if (xml == null)
                {
                    Servicos.Embarcador.EmissorDocumento.EmissorDocumentoService.GetEmissorDocumentoCTe(cte.SistemaEmissor).ObterXMLCteAutorizacao(cte, Auditado, tipoServicoMultisoftware, unidadeTrabalho);
                    xml = repXML.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.Autorizacao);
                }

                return ObterXMLAutorizacao(xml, unidadeTrabalho, Auditado, tipoServicoMultisoftware);
            }

            return null;
        }

        public byte[] ObterXMLCancelamentoAutorizacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.Enumeradores.TipoXMLCTe tipo, Repositorio.UnitOfWork unitOfWork)
        {
            if (cte != null)
            {
                if (tipo == Dominio.Enumeradores.TipoXMLCTe.Autorizacao)
                    return ObterXMLAutorizacao(cte, unitOfWork);
                else
                    return ObterXMLCancelamento(cte, unitOfWork);
            }

            return null;
        }

        private byte[] ObterXMLCancelamentoAutorizacao(Dominio.Entidades.XMLCTe xml, Repositorio.UnitOfWork unitOfWork)
        {
            if (xml != null)
            {
                if (xml.Tipo == Dominio.Enumeradores.TipoXMLCTe.Autorizacao)
                    return ObterXMLAutorizacao(xml, unitOfWork);
                else
                    return ObterXMLCancelamento(xml, unitOfWork);
            }

            return null;
        }

        private byte[] ObterXMLAutorizacao(Dominio.Entidades.XMLCTe xml, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado = null, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware = TipoServicoMultisoftware.MultiTMS)
        {
            byte[] retorno = null;

            if (xml != null)
            {
                if (!xml.XMLArmazenadoEmArquivo)
                {
                    if (!string.IsNullOrWhiteSpace(xml.XML))
                        retorno = System.Text.Encoding.Default.GetBytes(xml.XML);
                }
                else
                {
                    string caminho = ObterCaminhoArmazenamentoXMLCTeArquivo(xml.CTe, "A", unitOfWork);

                    if (Utilidades.IO.FileStorageService.Storage.Exists(caminho))
                        retorno = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminho);
                    else if (!Utilidades.IO.FileStorageService.Storage.Exists(caminho))
                        retorno = Servicos.Embarcador.EmissorDocumento.EmissorDocumentoService.GetEmissorDocumentoCTe(xml.CTe.SistemaEmissor).ObterXMLCteAutorizacao(xml.CTe, Auditado, tipoServicoMultisoftware, unitOfWork);
                }
            }

            return retorno;
        }

        public string ObterStringXMLAutorizacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado = null, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware = TipoServicoMultisoftware.MultiTMS)
        {
            string retorno = string.Empty;

            byte[] xmlArquivo = ObterXMLAutorizacao(cte, unitOfWork, Auditado, tipoServicoMultisoftware);

            if (xmlArquivo != null)
                retorno = Encoding.UTF8.GetString(xmlArquivo);

            return retorno;
        }

        public string ObterStringXMLCancelamento(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado = null, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware = TipoServicoMultisoftware.MultiTMS)
        {
            string retorno = string.Empty;

            byte[] xmlArquivo = ObterXMLCancelamento(cte, unitOfWork, Auditado, tipoServicoMultisoftware);

            if (xmlArquivo != null)
                retorno = Encoding.UTF8.GetString(xmlArquivo);

            return retorno;
        }

        private byte[] ObterXMLCancelamento(Dominio.Entidades.XMLCTe xml, Repositorio.UnitOfWork unitOfWork, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado = null, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware = TipoServicoMultisoftware.MultiTMS)
        {
            byte[] retorno = null;

            if (xml != null)
            {
                if (!xml.XMLArmazenadoEmArquivo)
                {
                    if (!string.IsNullOrWhiteSpace(xml.XML))
                        return System.Text.Encoding.Default.GetBytes(xml.XML);
                }
                else
                {
                    string caminho = string.Empty;
                    if (xml.CTe.Status == "I")
                        caminho = ObterCaminhoArmazenamentoXMLCTeArquivo(xml.CTe, "I", unitOfWork);
                    else
                        caminho = ObterCaminhoArmazenamentoXMLCTeArquivo(xml.CTe, "C", unitOfWork);

                    if (Utilidades.IO.FileStorageService.Storage.Exists(caminho))
                        retorno = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminho);
                    else if (!Utilidades.IO.FileStorageService.Storage.Exists(caminho) && xml.CTe.Status == "C")
                        retorno = Servicos.Embarcador.EmissorDocumento.EmissorDocumentoService.GetEmissorDocumentoCTe(xml.CTe.SistemaEmissor).ObterXMLCteCancelamento(xml.CTe, Auditado, tipoServicoMultisoftware, unitOfWork);
                }
            }

            return retorno;
        }

        public byte[] ObterXMLInutilizacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unitOfWork)
        {
            if (cte == null)
                return null;

            Repositorio.XMLCTe repXML = new Repositorio.XMLCTe(unitOfWork);

            Dominio.Entidades.XMLCTe xml = repXML.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.Cancelamento);

            if (xml == null)
                return null;

            if (!xml.XMLArmazenadoEmArquivo)
            {
                if (!string.IsNullOrWhiteSpace(xml.XML))
                {
                    byte[] data = System.Text.Encoding.Default.GetBytes(xml.XML);
                    return data;
                }
            }
            else
            {
                string caminho = ObterCaminhoArmazenamentoXMLCTeArquivo(xml.CTe, "I", unitOfWork);
                byte[] data = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminho);
                return data;
            }

            return null;
        }

        public byte[] ObterXMLCancelamento(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeTrabalho, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado = null, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware = TipoServicoMultisoftware.MultiTMS)
        {
            byte[] retorno = null;

            if (cte != null)
            {
                Repositorio.XMLCTe repXML = new Repositorio.XMLCTe(unidadeTrabalho);
                Dominio.Entidades.XMLCTe xml = repXML.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.Cancelamento);

                if (xml == null)
                {
                    Servicos.Embarcador.EmissorDocumento.EmissorDocumentoService.GetEmissorDocumentoCTe(cte.SistemaEmissor).ObterXMLCteCancelamento(cte, Auditado, tipoServicoMultisoftware, unidadeTrabalho);
                    xml = repXML.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.Cancelamento);
                }

                return ObterXMLCancelamento(xml, unidadeTrabalho, Auditado, tipoServicoMultisoftware);
            }

            return retorno;
        }

        public System.IO.MemoryStream ObterXMLIntegracao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeTrabalho)
        {
            MemoryStream fZip = new MemoryStream();
            ZipOutputStream zipOStream = new ZipOutputStream(fZip);
            zipOStream.SetLevel(9);
            bool encontrouXML = false;

            if (cte != null)
            {
                Repositorio.XMLCTe repXML = new Repositorio.XMLCTe(unidadeTrabalho);

                Dominio.Entidades.XMLCTe xmlEnvioIntegracao = repXML.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.EnvioIntegracao);

                if (xmlEnvioIntegracao != null)
                {
                    byte[] dataEnvioIntegracao = null;

                    if (!xmlEnvioIntegracao.XMLArmazenadoEmArquivo)
                    {
                        if (!string.IsNullOrWhiteSpace(xmlEnvioIntegracao.XML))
                        {
                            dataEnvioIntegracao = System.Text.Encoding.Default.GetBytes(xmlEnvioIntegracao.XML);
                        }
                    }
                    else
                    {
                        string caminho = ObterCaminhoArmazenamentoXMLCTeArquivo(cte, "A", unidadeTrabalho);
                        dataEnvioIntegracao = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminho);
                    }

                    if (dataEnvioIntegracao != null)
                    {
                        encontrouXML = true;
                        ZipEntry entry = new ZipEntry($"xmlEnvInteg_NFS_{cte.Numero}.xml");
                        entry.DateTime = DateTime.Now;
                        zipOStream.PutNextEntry(entry);
                        zipOStream.Write(dataEnvioIntegracao, 0, dataEnvioIntegracao.Length);
                        zipOStream.CloseEntry();
                    }
                }

                Dominio.Entidades.XMLCTe xmlRetornoIntegracao = repXML.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.RetornoIntegracao);

                if (xmlRetornoIntegracao != null)
                {
                    byte[] dataRetornoIntegracao = null;

                    if (!xmlRetornoIntegracao.XMLArmazenadoEmArquivo)
                    {
                        if (!string.IsNullOrWhiteSpace(xmlEnvioIntegracao.XML))
                            dataRetornoIntegracao = System.Text.Encoding.Default.GetBytes(xmlRetornoIntegracao.XML);
                    }
                    else
                    {
                        string caminho = ObterCaminhoArmazenamentoXMLCTeArquivo(cte, "A", unidadeTrabalho);
                        dataRetornoIntegracao = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminho);
                    }

                    if (dataRetornoIntegracao != null)
                    {
                        encontrouXML = true;
                        ZipEntry entry = new ZipEntry($"xmlRetInteg_NFS_{cte.Numero}.xml");
                        entry.DateTime = DateTime.Now;
                        zipOStream.PutNextEntry(entry);
                        zipOStream.Write(dataRetornoIntegracao, 0, dataRetornoIntegracao.Length);
                        zipOStream.CloseEntry();
                    }
                }

                Dominio.Entidades.XMLCTe xmlEnvioConsultaIntegracao = repXML.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.EnvioConsultaIntegracao);

                if (xmlEnvioConsultaIntegracao != null)
                {
                    byte[] dataEnvioConsultaIntegracao = null;

                    if (!xmlEnvioConsultaIntegracao.XMLArmazenadoEmArquivo)
                    {
                        if (!string.IsNullOrWhiteSpace(xmlEnvioConsultaIntegracao.XML))
                            dataEnvioConsultaIntegracao = System.Text.Encoding.Default.GetBytes(xmlEnvioConsultaIntegracao.XML);
                    }
                    else
                    {
                        string caminho = ObterCaminhoArmazenamentoXMLCTeArquivo(cte, "A", unidadeTrabalho);
                        dataEnvioConsultaIntegracao = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminho);
                    }

                    if (dataEnvioConsultaIntegracao != null)
                    {
                        encontrouXML = true;
                        ZipEntry entry = new ZipEntry($"xmlEnvConsInteg_NFS_{cte.Numero}.xml");
                        entry.DateTime = DateTime.Now;
                        zipOStream.PutNextEntry(entry);
                        zipOStream.Write(dataEnvioConsultaIntegracao, 0, dataEnvioConsultaIntegracao.Length);
                        zipOStream.CloseEntry();
                    }
                }

                Dominio.Entidades.XMLCTe xmlRetornoConsultaIntegracao = repXML.BuscarPorCTe(cte.Codigo, Dominio.Enumeradores.TipoXMLCTe.RetornoConsultaIntegracao);

                if (xmlRetornoConsultaIntegracao != null)
                {
                    byte[] dataRetornoConsultaIntegracao = null;

                    if (!xmlRetornoConsultaIntegracao.XMLArmazenadoEmArquivo)
                    {
                        if (!string.IsNullOrWhiteSpace(xmlRetornoConsultaIntegracao.XML))
                            dataRetornoConsultaIntegracao = System.Text.Encoding.Default.GetBytes(xmlRetornoConsultaIntegracao.XML);
                    }
                    else
                    {
                        string caminho = ObterCaminhoArmazenamentoXMLCTeArquivo(cte, "A", unidadeTrabalho);
                        dataRetornoConsultaIntegracao = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminho);
                    }

                    if (dataRetornoConsultaIntegracao != null)
                    {
                        encontrouXML = true;
                        ZipEntry entry = new ZipEntry($"xmlRetConsInteg_NFS_{cte.Numero}.xml");
                        entry.DateTime = DateTime.Now;
                        zipOStream.PutNextEntry(entry);
                        zipOStream.Write(dataRetornoConsultaIntegracao, 0, dataRetornoConsultaIntegracao.Length);
                        zipOStream.CloseEntry();
                    }
                }
            }

            zipOStream.IsStreamOwner = false;
            zipOStream.Close();

            fZip.Position = 0;

            if (!encontrouXML)
                return null;

            return fZip;
        }

        public System.IO.MemoryStream ObterLoteDeDACTE(List<int> codigosCTes, List<int> codigosNFSe, Repositorio.UnitOfWork unidadeTrabalho)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            MemoryStream fZip = new MemoryStream();
            ZipOutputStream zipOStream = new ZipOutputStream(fZip);
            zipOStream.SetLevel(9);

            string caminhoRelatorios = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeTrabalho).ObterConfiguracaoArquivo().CaminhoRelatorios;

            if (codigosCTes.Count > 0)
            {
                List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> ctes = repCTe.BuscarPorCodigo(codigosCTes);
                // TODO: ToList cast
                List<(int CodigoCTe, bool ImprimirTabelaTemperaturaVersoCTe)> ctesImprimirTabelaTemperatura = repCTe.BuscarInformacaoImpressaoTabelaTemperaturaVersoCTe(codigosCTes).ToList();

                for (int i = 0; i < ctes.Count; i++)
                {
                    Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = ctes[i];

                    bool imprimirTabelaTemperaturaNoVersoCTe = ctesImprimirTabelaTemperatura.Exists(cteImprimirTabelaTemperatura => cteImprimirTabelaTemperatura.CodigoCTe == cte.Codigo && cteImprimirTabelaTemperatura.ImprimirTabelaTemperaturaVersoCTe);

                    string nomeArquivo = cte.Chave;
                    string caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(caminhoRelatorios, cte.Empresa.CNPJ, nomeArquivo) + ".pdf";

                    if (cte.ModeloDocumentoFiscal.Numero != "57")
                    {
                        nomeArquivo = cte.ModeloDocumentoFiscal.Numero + "_" + cte.Numero + "_" + cte.Serie.Numero + "_" + cte.ModeloDocumentoFiscal.Abreviacao + "_" + cte.Codigo;
                        caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(caminhoRelatorios, "NFSe", cte.Empresa.CNPJ, nomeArquivo) + ".pdf";
                    }

                    if (!Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF))
                        GerarDACTENFse(cte.Codigo, unidadeTrabalho);

                    if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFS)
                    {
                        Repositorio.Embarcador.NFS.LancamentoNFSManual repNFSManual = new Repositorio.Embarcador.NFS.LancamentoNFSManual(unidadeTrabalho);
                        Dominio.Entidades.Embarcador.NFS.LancamentoNFSManual nfsManual = repNFSManual.BuscarPorCTe(cte.Codigo);

                        if (nfsManual != null)
                        {
                            if (!string.IsNullOrWhiteSpace(nfsManual.DadosNFS.ImagemNFS))
                            {
                                byte[] dacte = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(nfsManual.DadosNFS.ImagemNFS);
                                string nomeArquivoDownload = System.IO.Path.GetFileName(caminhoPDF);

                                ZipEntry entry = new ZipEntry(nomeArquivoDownload);
                                entry.DateTime = DateTime.Now;
                                zipOStream.PutNextEntry(entry);
                                zipOStream.Write(dacte, 0, dacte.Length);
                                zipOStream.CloseEntry();
                            }

                        }

                    }
                    else if (Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF))
                    {
                        byte[] dacte = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminhoPDF);
                        byte[] pdfAgrupado = imprimirTabelaTemperaturaNoVersoCTe ? ObterVersoCTE(dacte, unidadeTrabalho) : null;

                        string nomeArquivoDownload = Servicos.Embarcador.CTe.CTe.ObterNomeArquivoDownloadCTe(cte, "pdf");

                        if (string.IsNullOrWhiteSpace(nomeArquivoDownload))
                            nomeArquivoDownload = System.IO.Path.GetFileName(caminhoPDF);

                        ZipEntry entry = new ZipEntry(nomeArquivoDownload);
                        entry.DateTime = DateTime.Now;
                        zipOStream.PutNextEntry(entry);

                        if (pdfAgrupado != null)
                            zipOStream.Write(pdfAgrupado, 0, pdfAgrupado.Length);
                        else
                            zipOStream.Write(dacte, 0, dacte.Length);

                        zipOStream.CloseEntry();
                    }
                }

                ctes = null;
            }

            if (codigosNFSe.Count > 0)
            {
                List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> nfses = repCTe.BuscarPorCodigo(codigosNFSe);

                for (int i = 0; i < nfses.Count; i++)
                {
                    //int.TryParse(codigosNFSe[i], out int codigoNFSe);
                    //Servicos.NFSe svcNFSe = new Servicos.NFSe(unidadeTrabalho.StringConexao);                
                    //pdf = svcNFSe.ObterDANFSECTe(codigoNFSe);

                    Dominio.Entidades.ConhecimentoDeTransporteEletronico nfse = nfses[i];
                    string caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(caminhoRelatorios, "NFSe", nfse.Empresa.CNPJ, nfse.Codigo.ToString() + "_" + nfse.Numero.ToString() + "_" + nfse.Serie.Numero.ToString()) + ".pdf";

                    if (!Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF))
                    {
                        Servicos.NFSe svcNFSe = new Servicos.NFSe(unidadeTrabalho);
                        svcNFSe.ObterDANFSECTe(codigosNFSe[i]);
                    }

                    if (!Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF))
                        GerarDACTENFse(nfse.Codigo, unidadeTrabalho);

                    if (Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF))
                    {
                        byte[] dacte = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminhoPDF);

                        string nomeArquivoDownload = Servicos.Embarcador.CTe.CTe.ObterNomeArquivoDownloadCTe(nfse, "pdf");

                        if (string.IsNullOrWhiteSpace(nomeArquivoDownload))
                            nomeArquivoDownload = System.IO.Path.GetFileName(caminhoPDF);

                        ZipEntry entry = new ZipEntry(nomeArquivoDownload);
                        entry.DateTime = DateTime.Now;
                        zipOStream.PutNextEntry(entry);
                        zipOStream.Write(dacte, 0, dacte.Length);
                        zipOStream.CloseEntry();
                    }
                }
            }

            zipOStream.IsStreamOwner = false;
            zipOStream.Close();

            fZip.Position = 0;

            return fZip;
        }

        private bool GerarDACTENFse(int codigo, Repositorio.UnitOfWork unidadeTrabalho)
        {
            try
            {
                int codigoCTe = codigo;

                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);
                Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorCodigo(codigoCTe);

                if (cte == null)
                    return false;

                if (cte.Status != "A" && cte.Status != "C" && cte.Status != "K" && cte.Status != "Z")
                    return false;

                string nomeArquivo = "";

                if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao != Dominio.Enumeradores.TipoDocumento.CTe && cte.ModeloDocumentoFiscal.TipoDocumentoEmissao != Dominio.Enumeradores.TipoDocumento.NFSe && cte.ModeloDocumentoFiscal.TipoDocumentoEmissao != Dominio.Enumeradores.TipoDocumento.NFS)
                {
                    nomeArquivo = cte.Numero + "_" + cte.Serie.Numero + "_" + cte.ModeloDocumentoFiscal.Abreviacao;

                    if (!string.IsNullOrWhiteSpace(cte.ModeloDocumentoFiscal.Relatorio))
                    {
                        byte[] arquivo = new Servicos.Embarcador.Relatorios.OutrosDocumentos(unidadeTrabalho).ObterPdf(cte);

                        return true;
                    }
                }

                if (string.IsNullOrWhiteSpace(Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeTrabalho).ObterConfiguracaoArquivo().CaminhoRelatorios))
                    return false;

                string nomeArquivoDownload = Servicos.Embarcador.CTe.CTe.ObterNomeArquivoDownloadCTe(cte, "pdf");

                byte[] pdf = null;

                if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFSe || cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFS)
                {
                    nomeArquivo = cte.Numero.ToString() + "_" + cte.Serie.Numero.ToString() + ".pdf";

                    Servicos.NFSe svcNFSe = new Servicos.NFSe(unidadeTrabalho);

                    pdf = svcNFSe.ObterDANFSECTe(cte.Codigo);
                }
                else
                {
                    nomeArquivo = cte.Chave;

                    if (cte.ModeloDocumentoFiscal.Numero != "57")
                        nomeArquivo = cte.ModeloDocumentoFiscal.Numero + "_" + cte.Numero + "_" + cte.Serie.Numero + "_" + cte.ModeloDocumentoFiscal.Abreviacao + "_" + cte.Codigo;

                    string caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeTrabalho).ObterConfiguracaoArquivo().CaminhoRelatorios, cte.Empresa.CNPJ, nomeArquivo) + ".pdf";

                    nomeArquivo = System.IO.Path.GetFileName(caminhoPDF);

                    if (!Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF))
                    {
                        if (string.IsNullOrWhiteSpace(Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeTrabalho).ObterConfiguracaoArquivo().CaminhoGeradorRelatorios))
                            return false;

                        Servicos.DACTE svcDACTE = new Servicos.DACTE(unidadeTrabalho);

                        pdf = svcDACTE.GerarPorProcesso(cte.Codigo, unidadeTrabalho);
                    }
                    else
                    {
                        pdf = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminhoPDF);
                    }
                }

                if (string.IsNullOrWhiteSpace(nomeArquivoDownload))
                    nomeArquivoDownload = nomeArquivo;

                if (pdf != null)
                    return true;
                else
                    return false;
            }
            catch (ServicoException)
            {
                return false;
            }
        }

        public System.IO.MemoryStream ObterLotePDFsTMS(int codigoCarga, List<int> codigosCTes, List<int> codigosMDFe, List<int> codigosValePedagios, Repositorio.UnitOfWork unidadeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, string nomeCliente = "")
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);
            Repositorio.ManifestoEletronicoDeDocumentosFiscais repMDFe = new Repositorio.ManifestoEletronicoDeDocumentosFiscais(unidadeTrabalho);
            Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio repCargaValePedagio = new Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio(unidadeTrabalho);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unidadeTrabalho);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unidadeTrabalho);
            Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeTrabalho);
            Repositorio.Embarcador.Cargas.CargaCargaIntegracao repIntegracao = new Repositorio.Embarcador.Cargas.CargaCargaIntegracao(unidadeTrabalho);
            Repositorio.Embarcador.Cargas.CargaCIOT repCargaCIOT = new Repositorio.Embarcador.Cargas.CargaCIOT(unidadeTrabalho);

            Servicos.CTe serCTe = new CTe(unidadeTrabalho);
            Servicos.MDFe svcMDFe = new Servicos.MDFe(unidadeTrabalho);
            Servicos.DAMDFE svcDAMDFE = new Servicos.DAMDFE(unidadeTrabalho);
            Servicos.Embarcador.Carga.Impressao servicoImpressao = new Servicos.Embarcador.Carga.Impressao(unidadeTrabalho);
            Servicos.Embarcador.Integracao.SemParar.ValePedagio servicoSemParar = new Servicos.Embarcador.Integracao.SemParar.ValePedagio();

            MemoryStream fZip = new MemoryStream();
            ZipOutputStream zipOStream = new ZipOutputStream(fZip);
            zipOStream.SetLevel(9);

            string caminhoRelatorios = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeTrabalho).ObterConfiguracaoArquivo().CaminhoRelatorios;
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao = repConfiguracaoTMS.BuscarConfiguracaoPadrao();

            List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> ctes = null;
            if (codigosCTes.Count > 0)
            {
                ctes = repCTe.BuscarPorCodigo(codigosCTes);

                for (int i = 0; i < ctes.Count; i++)
                {
                    string caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(caminhoRelatorios, ctes[i].Empresa.CNPJ, ctes[i].Chave ?? "") + ".pdf";

                    if (Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF))
                    {
                        byte[] dacte = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminhoPDF);

                        ZipEntry entry = new ZipEntry(System.IO.Path.GetFileName(caminhoPDF));
                        entry.DateTime = DateTime.Now;
                        zipOStream.PutNextEntry(entry);
                        zipOStream.Write(dacte, 0, dacte.Length);
                        zipOStream.CloseEntry();
                    }
                }

                int quantidadeLotes = (int)Math.Ceiling((decimal)codigosCTes.Count / 1000);
                for (int i = 1; i <= quantidadeLotes; i++)
                {
                    List<Dominio.Entidades.XMLCTe> xmls = repXMLCTe.BuscarPorCTe(codigosCTes.Skip((i - 1) * 1000).Take(1000).ToList(), 0);

                    foreach (Dominio.Entidades.XMLCTe xml in xmls)
                    {
                        byte[] arquivo = serCTe.ObterXMLCancelamentoAutorizacao(xml, unidadeTrabalho);

                        string nomeArquivoDownload = Servicos.Embarcador.CTe.CTe.ObterNomeArquivoDownloadCTe(xml.CTe, "xml");

                        if (string.IsNullOrWhiteSpace(nomeArquivoDownload))
                        {
                            string identificacao = xml.CTe.Chave;

                            if (string.IsNullOrWhiteSpace(identificacao))
                                identificacao = xml.CTe.Descricao;

                            string abrev = xml.CTe.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.CTe ? "CTe" : string.Empty;

                            nomeArquivoDownload = abrev + identificacao;

                            if (xml.Tipo == Dominio.Enumeradores.TipoXMLCTe.Cancelamento)
                            {
                                if (xml.CTe.Status == "C")
                                    nomeArquivoDownload += "-procCancCTe";
                                else if (xml.CTe.Status == "I")
                                    nomeArquivoDownload = abrev + xml.CTe.Descricao + "-procInutCTe";
                            }

                            nomeArquivoDownload += ".xml";
                        }

                        ZipEntry entry = new ZipEntry(nomeArquivoDownload);
                        entry.DateTime = DateTime.Now;
                        zipOStream.PutNextEntry(entry);
                        zipOStream.Write(arquivo, 0, arquivo.Length);
                        zipOStream.CloseEntry();
                    }

                    xmls = null;
                }
            }

            for (int i = 0; i < codigosMDFe.Count; i++)
            {
                byte[] damdfe = null;
                Dominio.Entidades.ManifestoEletronicoDeDocumentosFiscais mdfe = repMDFe.BuscarPorCodigo(codigosMDFe[i]);
                if (!string.IsNullOrWhiteSpace(Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeTrabalho).ObterConfiguracaoArquivo().CaminhoRelatorios))
                {
                    string caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeTrabalho).ObterConfiguracaoArquivo().CaminhoRelatorios, mdfe.Empresa.CNPJ, mdfe.Chave) + ".pdf";
                    if (Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF))
                        damdfe = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminhoPDF);
                }
                if (damdfe == null)
                    damdfe = svcDAMDFE.Gerar(mdfe.Codigo);
                ZipEntry entry = new ZipEntry(System.IO.Path.GetFileName(string.Concat(mdfe.Chave, ".pdf")));
                entry.DateTime = DateTime.Now;
                zipOStream.PutNextEntry(entry);
                zipOStream.Write(damdfe, 0, damdfe.Length);
                zipOStream.CloseEntry();

                byte[] arquivo = svcMDFe.ObterXMLAutorizacao(mdfe, unidadeTrabalho);
                if (arquivo != null)
                {
                    ZipEntry entryXML = new ZipEntry(System.IO.Path.GetFileName(string.Concat(mdfe.Chave, ".xml")));
                    entryXML.DateTime = DateTime.Now;
                    zipOStream.PutNextEntry(entryXML);
                    zipOStream.Write(arquivo, 0, arquivo.Length);
                    zipOStream.CloseEntry();
                }
            }

            for (int i = 0; i < codigosValePedagios.Count; i++)
            {
                Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio cargaIntegracaoValePedagio = repCargaValePedagio.BuscarPorCodigo(codigosValePedagios[i]);

                try
                {
                    byte[] pdf = servicoSemParar.GerarImpressaoValePedagio(cargaIntegracaoValePedagio, unidadeTrabalho, tipoServicoMultisoftware);
                    if (pdf == null) continue;

                    ZipEntry entry = new ZipEntry(System.IO.Path.GetFileName(string.Concat(cargaIntegracaoValePedagio.NumeroValePedagio, ".pdf")))
                    {
                        DateTime = DateTime.Now
                    };
                    zipOStream.PutNextEntry(entry);
                    zipOStream.Write(pdf, 0, pdf.Length);
                    zipOStream.CloseEntry();
                }
                catch (ServicoException)
                {
                }
            }

            ctes = null;
            Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigo(codigoCarga);
            if (carga != null)
            {
                if (configuracao.HabilitarRelatorioDeTroca)
                {
                    string mensagem = string.Empty;
                    byte[] relatorioEntrega = new Servicos.Embarcador.Carga.Carregamento().RelatorioTroca(carga, false, unidadeTrabalho, ref mensagem);
                    if (relatorioEntrega != null)
                    {
                        ZipEntry entryTrocaDetalhada = new ZipEntry(System.IO.Path.GetFileName(string.Concat("Relatório de Entregas - ", carga.CodigoCargaEmbarcador, ".pdf")))
                        {
                            DateTime = DateTime.Now
                        };
                        zipOStream.PutNextEntry(entryTrocaDetalhada);
                        zipOStream.Write(relatorioEntrega, 0, relatorioEntrega.Length);

                        byte[] relatorioTroca = new Servicos.Embarcador.Carga.Carregamento().RelatorioTroca(carga, true, unidadeTrabalho, ref mensagem);
                        if (relatorioTroca != null)
                        {
                            ZipEntry entryRecolhimento = new ZipEntry(System.IO.Path.GetFileName(string.Concat("Relatório de Troca - ", carga.CodigoCargaEmbarcador, ".pdf")))
                            {
                                DateTime = DateTime.Now
                            };
                            zipOStream.PutNextEntry(entryRecolhimento);
                            zipOStream.Write(relatorioTroca, 0, relatorioTroca.Length);
                        }

                        zipOStream.CloseEntry();
                    }
                }

                if (carga.TipoOperacao?.UtilizarPlanoViagem ?? false)
                {
                    byte[] pdf = servicoImpressao.ObterPdfPlanoViagem(carga);

                    if (pdf != null)
                    {
                        ZipEntry entry = new ZipEntry(System.IO.Path.GetFileName($"Plano de Viagem {carga.CodigoCargaEmbarcador}.pdf"))
                        {
                            DateTime = DateTime.Now
                        };
                        zipOStream.PutNextEntry(entry);
                        zipOStream.Write(pdf, 0, pdf.Length);
                        zipOStream.CloseEntry();
                    }
                }

                if (configuracao.AdicionarRelatorioRelacaoEntregaDownloadDocumentos)
                {
                    byte[] pdf = servicoImpressao.ObterPdfRelacaoEntrega(carga.Codigo, nomeCliente);

                    if (pdf != null)
                    {
                        ZipEntry entry = new ZipEntry(Path.GetFileName($"Relatorio de Relacao de Entrega {DateTime.Now.ToString("dd-MM-yyyy HH-mm")}.pdf"))
                        {
                            DateTime = DateTime.Now
                        };
                        zipOStream.PutNextEntry(entry);
                        zipOStream.Write(pdf, 0, pdf.Length);
                        zipOStream.CloseEntry();
                    }
                }

                Dominio.Entidades.Embarcador.Cargas.CargaCargaIntegracao cargaIntegracao = repIntegracao.BuscarPorCargaETipoIntegracao(carga.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.OpenTech);
                if (cargaIntegracao != null && cargaIntegracao.SituacaoIntegracao == SituacaoIntegracao.Integrado)
                {
                    string mensagemErro = string.Empty;
                    byte[] arquivo = new Servicos.Embarcador.Integracao.OpenTech.IntegracaoCargaOpenTech(unidadeTrabalho).ObterAutorizacaoEmbarque(cargaIntegracao, out mensagemErro);
                    ZipEntry entry = new ZipEntry(System.IO.Path.GetFileName(string.Concat("AE_" + cargaIntegracao.ProblemaIntegracao, ".pdf")));
                    entry.DateTime = DateTime.Now;
                    zipOStream.PutNextEntry(entry);
                    zipOStream.Write(arquivo, 0, arquivo.Length);
                    zipOStream.CloseEntry();
                }

                Dominio.Entidades.Embarcador.Cargas.CargaCIOT cargaCIOT = repCargaCIOT.BuscarPorCarga(codigoCarga);
                if (cargaCIOT != null)
                {
                    byte[] arquivo = null;
                    string mensagemErro = string.Empty;
                    if (cargaCIOT.CIOT.Operadora == Dominio.ObjetosDeValor.Embarcador.Enumeradores.OperadoraCIOT.eFrete)
                    {
                        Servicos.Embarcador.CIOT.EFrete serEfrete = new Servicos.Embarcador.CIOT.EFrete();
                        arquivo = serEfrete.ObterOperacaoTransportePdf(cargaCIOT, unidadeTrabalho, out string erro);
                    }
                    else
                        arquivo = new Servicos.Embarcador.CIOT.CIOT().GerarContratoFrete(cargaCIOT.CIOT.Codigo, unidadeTrabalho, out mensagemErro);

                    if (arquivo != null)
                    {
                        ZipEntry entry = new ZipEntry(System.IO.Path.GetFileName(string.Concat("CIOT_" + cargaCIOT.CIOT.Numero.ToString(), ".pdf")));
                        entry.DateTime = DateTime.Now;
                        zipOStream.PutNextEntry(entry);
                        zipOStream.Write(arquivo, 0, arquivo.Length);
                        zipOStream.CloseEntry();
                    }
                }
            }

            zipOStream.IsStreamOwner = false;
            zipOStream.Close();

            fZip.Position = 0;

            return fZip;
        }

        public System.IO.MemoryStream ObterLotePDFs(int codigoCarga, List<int> codigosCTes, List<int> codigosMDFe, List<int> codigosValePedagios, Repositorio.UnitOfWork unidadeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, string nomeCliente = "")
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);
            Repositorio.ManifestoEletronicoDeDocumentosFiscais repMDFe = new Repositorio.ManifestoEletronicoDeDocumentosFiscais(unidadeTrabalho);
            Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio repCargaValePedagio = new Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio(unidadeTrabalho);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unidadeTrabalho);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unidadeTrabalho);

            Servicos.DAMDFE svcDAMDFE = new Servicos.DAMDFE(unidadeTrabalho);
            Servicos.Embarcador.Carga.Impressao servicoImpressao = new Servicos.Embarcador.Carga.Impressao(unidadeTrabalho);
            Servicos.Embarcador.Integracao.SemParar.ValePedagio servicoSemParar = new Servicos.Embarcador.Integracao.SemParar.ValePedagio();

            MemoryStream fZip = new MemoryStream();
            ZipOutputStream zipOStream = new ZipOutputStream(fZip);
            zipOStream.SetLevel(9);

            string caminhoRelatorios = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeTrabalho).ObterConfiguracaoArquivo().CaminhoRelatorios;
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao = repConfiguracaoTMS.BuscarConfiguracaoPadrao();

            if ((codigosCTes == null || codigosCTes.Count == 0) && codigosMDFe != null && codigosMDFe.Count > 0)
                codigosCTes = repMDFe.BuscarCodigosCTePorMDFe(codigosMDFe.ToArray());

            List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> ctes = null;
            if (codigosCTes.Count > 0)
            {
                // TODO: ToList cast
                List<(int CodigoCTe, bool ImprimirTabelaTemperaturaVersoCTe)> ctesImprimirTabelaTemperatura = repCTe.BuscarInformacaoImpressaoTabelaTemperaturaVersoCTe(codigosCTes).ToList();
                ctes = repCTe.BuscarPorCodigo(codigosCTes);

                for (int i = 0; i < ctes.Count; i++)
                {
                    string caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(caminhoRelatorios, ctes[i].Empresa.CNPJ, ctes[i].Chave) + ".pdf";
                    bool imprimirTabelaTemperaturaNoVersoCTe = ctesImprimirTabelaTemperatura.Exists(cteImprimirTabelaTemperatura => cteImprimirTabelaTemperatura.CodigoCTe == ctes[i].Codigo && cteImprimirTabelaTemperatura.ImprimirTabelaTemperaturaVersoCTe);

                    if (Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF))
                    {
                        byte[] dacte = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminhoPDF);
                        byte[] pdfAgrupado = imprimirTabelaTemperaturaNoVersoCTe ? ObterVersoCTE(dacte, unidadeTrabalho) : null;

                        ZipEntry entry = new ZipEntry(System.IO.Path.GetFileName(caminhoPDF));
                        entry.DateTime = DateTime.Now;
                        zipOStream.PutNextEntry(entry);

                        if (pdfAgrupado != null)
                            zipOStream.Write(pdfAgrupado, 0, pdfAgrupado.Length);
                        else
                            zipOStream.Write(dacte, 0, dacte.Length);
                        zipOStream.CloseEntry();
                    }
                }
            }

            for (int i = 0; i < codigosMDFe.Count; i++)
            {
                byte[] damdfe = null;
                Dominio.Entidades.ManifestoEletronicoDeDocumentosFiscais mdfe = repMDFe.BuscarPorCodigo(codigosMDFe[i]);
                if (!string.IsNullOrWhiteSpace(Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeTrabalho).ObterConfiguracaoArquivo().CaminhoRelatorios))
                {
                    string caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeTrabalho).ObterConfiguracaoArquivo().CaminhoRelatorios, mdfe.Empresa.CNPJ, mdfe.Chave) + ".pdf";
                    if (Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF))
                        damdfe = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminhoPDF);
                }
                if (damdfe == null)
                    damdfe = svcDAMDFE.Gerar(mdfe.Codigo);
                ZipEntry entry = new ZipEntry(System.IO.Path.GetFileName(string.Concat(mdfe.Chave, ".pdf")));
                entry.DateTime = DateTime.Now;
                zipOStream.PutNextEntry(entry);
                zipOStream.Write(damdfe, 0, damdfe.Length);
                zipOStream.CloseEntry();
            }

            for (int i = 0; i < codigosValePedagios.Count; i++)
            {
                Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio cargaIntegracaoValePedagio = repCargaValePedagio.BuscarPorCodigo(codigosValePedagios[i]);

                try
                {
                    byte[] pdf = servicoSemParar.GerarImpressaoValePedagio(cargaIntegracaoValePedagio, unidadeTrabalho, tipoServicoMultisoftware);
                    if (pdf == null) continue;

                    ZipEntry entry = new ZipEntry(System.IO.Path.GetFileName(string.Concat(cargaIntegracaoValePedagio.NumeroValePedagio, ".pdf")))
                    {
                        DateTime = DateTime.Now
                    };
                    zipOStream.PutNextEntry(entry);
                    zipOStream.Write(pdf, 0, pdf.Length);
                    zipOStream.CloseEntry();
                }
                catch (ServicoException)
                {
                }
            }

            ctes = null;

            Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigo(codigoCarga);
            if (carga != null)
            {
                if (configuracao.HabilitarRelatorioDeTroca)
                {
                    string mensagem = string.Empty;
                    byte[] relatorioEntrega = new Servicos.Embarcador.Carga.Carregamento().RelatorioTroca(carga, false, unidadeTrabalho, ref mensagem);
                    if (relatorioEntrega != null)
                    {
                        ZipEntry entryTrocaDetalhada = new ZipEntry(System.IO.Path.GetFileName(string.Concat("Relatório de Entregas - ", carga.CodigoCargaEmbarcador, ".pdf")))
                        {
                            DateTime = DateTime.Now
                        };
                        zipOStream.PutNextEntry(entryTrocaDetalhada);
                        zipOStream.Write(relatorioEntrega, 0, relatorioEntrega.Length);

                        byte[] relatorioTroca = new Servicos.Embarcador.Carga.Carregamento().RelatorioTroca(carga, true, unidadeTrabalho, ref mensagem);
                        if (relatorioTroca != null)
                        {
                            ZipEntry entryRecolhimento = new ZipEntry(System.IO.Path.GetFileName(string.Concat("Relatório de Troca - ", carga.CodigoCargaEmbarcador, ".pdf")))
                            {
                                DateTime = DateTime.Now
                            };
                            zipOStream.PutNextEntry(entryRecolhimento);
                            zipOStream.Write(relatorioTroca, 0, relatorioTroca.Length);
                        }

                        zipOStream.CloseEntry();
                    }
                }

                if (carga.TipoOperacao?.UtilizarPlanoViagem ?? false)
                {
                    byte[] pdf = servicoImpressao.ObterPdfPlanoViagem(carga);

                    if (pdf != null)
                    {
                        ZipEntry entry = new ZipEntry(System.IO.Path.GetFileName($"Plano de Viagem {carga.CodigoCargaEmbarcador}.pdf"))
                        {
                            DateTime = DateTime.Now
                        };
                        zipOStream.PutNextEntry(entry);
                        zipOStream.Write(pdf, 0, pdf.Length);
                        zipOStream.CloseEntry();
                    }
                }

                if (configuracao.AdicionarRelatorioRelacaoEntregaDownloadDocumentos)
                {
                    byte[] pdf;
                    if (configuracao.RelatorioEntregaPorPedido)
                        pdf = servicoImpressao.ObterPdfRelacaoEntregaPorPedido(carga.Codigo, nomeCliente);
                    else
                        pdf = servicoImpressao.ObterPdfRelacaoEntrega(carga.Codigo, nomeCliente);

                    if (pdf != null)
                    {
                        ZipEntry entry = new ZipEntry(Path.GetFileName($"Relatorio de Relacao de Entrega {DateTime.Now.ToString("dd-MM-yyyy HH-mm")}.pdf"))
                        {
                            DateTime = DateTime.Now
                        };
                        zipOStream.PutNextEntry(entry);
                        zipOStream.Write(pdf, 0, pdf.Length);
                        zipOStream.CloseEntry();
                    }
                }

                byte[] detalheCTeMDF = Servicos.Embarcador.Carga.Carga.GerarPDFDetalheCTeMDF(codigoCarga, unidadeTrabalho);
                if (detalheCTeMDF != null)
                {
                    ZipEntry entry = new ZipEntry(Path.GetFileName($"Relatorio de Protocolo de Entrega de Documentos {DateTime.Now.ToString("dd-MM-yyyy HH-mm")}.pdf"))
                    {
                        DateTime = DateTime.Now
                    };
                    zipOStream.PutNextEntry(entry);
                    zipOStream.Write(detalheCTeMDF, 0, detalheCTeMDF.Length);
                    zipOStream.CloseEntry();
                }
            }

            zipOStream.IsStreamOwner = false;
            zipOStream.Close();

            fZip.Position = 0;

            return fZip;
        }

        private byte[] ObterVersoCTE(byte[] arquivo, Repositorio.UnitOfWork unidadeTrabalho)
        {
            byte[] versoCTe = ReportRequest.WithType(ReportType.RegistroTemperaturaETrocaDeGelo)
                .WithExecutionType(ExecutionType.Sync)
                .CallReport()
                .GetContentFile();

            if (versoCTe != null && arquivo != null)
            {
                Servicos.DACTE svcDACTE = new Servicos.DACTE(unidadeTrabalho);
                List<byte[]> sourceFiles = new List<byte[]>()
                {
                    arquivo,
                    versoCTe
                };
                return svcDACTE.MergeFiles(sourceFiles);
            }
            return null;
        }

        //Metodo usado para gerar um PDF unico com todos os documentos.
        public byte[] ObterLotePDFsAgrupado(int codigoCarga, List<int> codigosCTes, List<int> codigosMDFe, List<int> codigosValePedagios, Repositorio.UnitOfWork unidadeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, string nomeCliente = "")
        {
            ImprimirLogObterLotePDFsAgrupado("Iniciando a execução do método observado.", TipoLogSistema.Info);

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);
            Repositorio.ManifestoEletronicoDeDocumentosFiscais repMDFe = new Repositorio.ManifestoEletronicoDeDocumentosFiscais(unidadeTrabalho);
            Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio repCargaValePedagio = new Repositorio.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio(unidadeTrabalho);
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unidadeTrabalho);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unidadeTrabalho);
            Repositorio.Embarcador.Cargas.CargaCIOT repCargaCIOT = new Repositorio.Embarcador.Cargas.CargaCIOT(unidadeTrabalho);
            Repositorio.Embarcador.CIOT.CIOTTarget repCIOTTarget = new Repositorio.Embarcador.CIOT.CIOTTarget(unidadeTrabalho);

            Servicos.DAMDFE svcDAMDFE = new Servicos.DAMDFE(unidadeTrabalho);
            Servicos.DACTE svcDACTE = new Servicos.DACTE(unidadeTrabalho);
            Servicos.Embarcador.Carga.Impressao servicoImpressao = new Servicos.Embarcador.Carga.Impressao(unidadeTrabalho);
            Dominio.Entidades.Embarcador.Cargas.Carga carga = repCarga.BuscarPorCodigo(codigoCarga);

            List<byte[]> pdfFinal = new List<byte[]>();
            MemoryStream fZip = new MemoryStream();
            ZipOutputStream zipOStream = new ZipOutputStream(fZip);

            zipOStream.SetLevel(9);

            string caminhoRelatorios = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeTrabalho).ObterConfiguracaoArquivo().CaminhoRelatorios;
            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracao = repConfiguracaoTMS.BuscarConfiguracaoPadrao();

            if (codigosCTes.Count > 0)
            {
                // TODO: ToList cast
                List<(int CodigoCTe, bool ImprimirTabelaTemperaturaVersoCTe)> ctesImprimirTabelaTemperatura = repCTe.BuscarInformacaoImpressaoTabelaTemperaturaVersoCTe(codigosCTes).ToList();
                List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> ctes = repCTe.BuscarPorCodigo(codigosCTes);
                ctes = ctes.OrderBy(cte => cte.ModeloDocumentoFiscal.TipoDocumentoEmissao).ToList();

                foreach (Dominio.Entidades.ConhecimentoDeTransporteEletronico cte in ctes)
                {
                    if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao != Dominio.Enumeradores.TipoDocumento.CTe && cte.ModeloDocumentoFiscal.TipoDocumentoEmissao != Dominio.Enumeradores.TipoDocumento.NFSe && cte.ModeloDocumentoFiscal.TipoDocumentoEmissao != Dominio.Enumeradores.TipoDocumento.NFS)
                    {
                        if (!string.IsNullOrWhiteSpace(cte.ModeloDocumentoFiscal.Relatorio))
                        {
                            if (cte.ModeloDocumentoFiscal.DocumentoTipoCRT)
                            {
                                byte[] pdfCRT = servicoImpressao.ObterPDFCRT(cte, carga);
                                if (pdfCRT != null)
                                {
                                    ImprimirLogObterLotePDFsAgrupado("Adicionando CRT cte: " + cte.Chave, TipoLogSistema.Info);
                                    pdfFinal.Add(pdfCRT);
                                }
                            }
                            else
                            {
                                byte[] pdfOutroDocumento = new Servicos.Embarcador.Relatorios.OutrosDocumentos(unidadeTrabalho).ObterPdf(cte);

                                if (pdfOutroDocumento != null)
                                {
                                    ImprimirLogObterLotePDFsAgrupado("Adicionando outro documento,  cte: " + cte.Chave, TipoLogSistema.Info);
                                    pdfFinal.Add(pdfOutroDocumento);
                                }
                            }
                        }
                    }
                    else if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFSe || cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFS)
                    {
                        byte[] pdfNFSe = null;

                        Servicos.NFSe svcNFSe = new Servicos.NFSe(unidadeTrabalho);

                        if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFS)
                            pdfNFSe = svcNFSe.ObterDANFSECTe(cte.Codigo, null, true);
                        else
                            pdfNFSe = svcNFSe.ObterDANFSECTe(cte.Codigo);

                        if (pdfNFSe != null)
                        {
                            ImprimirLogObterLotePDFsAgrupado("Adicionando NFS cte: " + cte.Chave, TipoLogSistema.Info);
                            pdfFinal.Add(pdfNFSe);
                        }
                    }
                    else
                    {
                        string caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(caminhoRelatorios, cte.Empresa.CNPJ, cte.Chave) + ".pdf";

                        if (!Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF))
                            continue;

                        byte[] dacte = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminhoPDF);

                        if (dacte != null)
                        {
                            bool imprimirTabelaTemperaturaNoVersoCTe = ctesImprimirTabelaTemperatura.Exists(cteImprimirTabelaTemperatura => cteImprimirTabelaTemperatura.CodigoCTe == cte.Codigo && cteImprimirTabelaTemperatura.ImprimirTabelaTemperaturaVersoCTe);

                            byte[] pdf = imprimirTabelaTemperaturaNoVersoCTe ? ObterVersoCTE(dacte, unidadeTrabalho) : null;
                            ImprimirLogObterLotePDFsAgrupado("Adicionando dacte cte: " + cte.Chave, TipoLogSistema.Info);
                            pdfFinal.Add(pdf ?? dacte);
                        }
                    }
                }
            }
            else
            {
                ImprimirLogObterLotePDFsAgrupado("Zero CTEs para gerar PDF agrupado.", TipoLogSistema.Advertencia);
            }

            for (int i = 0; i < codigosMDFe.Count; i++)
            {
                if (string.IsNullOrWhiteSpace(caminhoRelatorios))
                {
                    ImprimirLogObterLotePDFsAgrupado("Sem caminho do relatório.", TipoLogSistema.Advertencia);
                    continue;
                }

                Dominio.Entidades.ManifestoEletronicoDeDocumentosFiscais mdfe = repMDFe.BuscarPorCodigo(codigosMDFe[i]);
                byte[] damdfe = null;
                string caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(caminhoRelatorios, mdfe.Empresa.CNPJ, mdfe.Chave) + ".pdf";

                if (!Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF))
                    damdfe = svcDAMDFE.Gerar(mdfe.Codigo);
                else
                    damdfe = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminhoPDF);

                if (damdfe != null)
                {
                    ImprimirLogObterLotePDFsAgrupado("Adicionando damdfe mfde: " + mdfe.Chave, TipoLogSistema.Info);
                    pdfFinal.Add(damdfe);
                }
            }

            for (int i = 0; i < codigosValePedagios.Count; i++)
            {
                try
                {
                    string mensagemRetorno = string.Empty;
                    byte[] pdf = null;

                    Dominio.Entidades.Embarcador.Cargas.ValePedagio.CargaIntegracaoValePedagio cargaIntegracaoValePedagio = repCargaValePedagio.BuscarPorCodigo(codigosValePedagios[i]);

                    Servicos.Embarcador.Carga.ValePedagio.ValePedagio servicoValePedagio = new Servicos.Embarcador.Carga.ValePedagio.ValePedagio(unidadeTrabalho);
                    servicoValePedagio.ObterArquivoValePedagio(cargaIntegracaoValePedagio, ref pdf, tipoServicoMultisoftware);

                    if (pdf == null) continue;

                    ImprimirLogObterLotePDFsAgrupado("Adicionando Vale Pedágio.", TipoLogSistema.Info);
                    pdfFinal.Add(pdf);
                }
                catch (Exception ex)
                {
                    ImprimirLogObterLotePDFsAgrupado("Erro ao obter arquivo de Vale Pedágio: " + ex.Message, TipoLogSistema.Error);
                    continue;
                }
            }

            #region PDF CIOT

            ImprimirLogObterLotePDFsAgrupado("Buscando carga CIOT. Codigo da Carga: " + codigoCarga, TipoLogSistema.Debug);
            Dominio.Entidades.Embarcador.Cargas.CargaCIOT cargaCIOT = repCargaCIOT.BuscarPorCarga(codigoCarga);

            if (cargaCIOT != null)
            {
                byte[] pdfCIOT = null;
                if (cargaCIOT.CIOT.Operadora == OperadoraCIOT.eFrete)
                {
                    Servicos.Embarcador.CIOT.EFrete serEfrete = new Servicos.Embarcador.CIOT.EFrete();
                    pdfCIOT = serEfrete.ObterOperacaoTransportePdf(cargaCIOT, unidadeTrabalho, out string erro);
                }
                else if (cargaCIOT.CIOT.Operadora == OperadoraCIOT.Target)
                {
                    Servicos.Embarcador.CIOT.Target serTarget = new Servicos.Embarcador.CIOT.Target();
                    pdfCIOT = serTarget.ImprimirCIOT(cargaCIOT.CIOT, unidadeTrabalho, out string erro);
                }

                if (pdfCIOT != null)
                {
                    ImprimirLogObterLotePDFsAgrupado("Adicionando CIOT.", TipoLogSistema.Info);
                    pdfFinal.Add(pdfCIOT);
                }
            }

            #endregion

            if (carga != null)
            {
                if (configuracao.HabilitarRelatorioDeTroca)
                {
                    string mensagem = string.Empty;

                    ImprimirLogObterLotePDFsAgrupado("Solicitando relatório de troca (ReportAPI). Codigo Carga: " + codigoCarga, TipoLogSistema.Debug);
                    byte[] relatorioEntrega = new Servicos.Embarcador.Carga.Carregamento().RelatorioTroca(carga, false, unidadeTrabalho, ref mensagem);

                    if (relatorioEntrega != null)
                    {
                        ImprimirLogObterLotePDFsAgrupado("Adicionando Relatório de Entrega.", TipoLogSistema.Info);
                        pdfFinal.Add(relatorioEntrega);

                        byte[] relatorioTroca = new Servicos.Embarcador.Carga.Carregamento().RelatorioTroca(carga, true, unidadeTrabalho, ref mensagem);
                        if (relatorioTroca != null)
                        {
                            ImprimirLogObterLotePDFsAgrupado("Adicionando Relatório de Troca.", TipoLogSistema.Info);
                            pdfFinal.Add(relatorioTroca);
                        }
                    }
                }

                if (carga.TipoOperacao?.UtilizarPlanoViagem ?? false)
                {
                    ImprimirLogObterLotePDFsAgrupado("Solicitando plano de viagem (ReportAPI). Codigo Carga: " + codigoCarga, TipoLogSistema.Debug);
                    byte[] pdfPlanoViagem = servicoImpressao.ObterPdfPlanoViagem(carga);

                    if (pdfPlanoViagem != null)
                    {
                        ImprimirLogObterLotePDFsAgrupado("Adicionando Plano de Viagem.", TipoLogSistema.Info);
                        pdfFinal.Add(pdfPlanoViagem);
                    }
                }

                if (configuracao.AdicionarRelatorioRelacaoEntregaDownloadDocumentos)
                {
                    byte[] pdfRelatorioRelacaoEntregaDownload = null;

                    if (configuracao.RelatorioEntregaPorPedido)
                    {
                        ImprimirLogObterLotePDFsAgrupado("Solicitando relação de entrega por pedido (ReportAPI). Codigo Carga: " + codigoCarga, TipoLogSistema.Debug);
                        pdfRelatorioRelacaoEntregaDownload = servicoImpressao.ObterPdfRelacaoEntregaPorPedido(carga.Codigo, nomeCliente);
                    }
                    else
                    {
                        ImprimirLogObterLotePDFsAgrupado("Solicitando relação de entrega (ReportAPI). Codigo Carga: " + codigoCarga, TipoLogSistema.Debug);
                        pdfRelatorioRelacaoEntregaDownload = servicoImpressao.ObterPdfRelacaoEntrega(carga.Codigo, nomeCliente);
                    }

                    if (pdfRelatorioRelacaoEntregaDownload != null)
                    {
                        ImprimirLogObterLotePDFsAgrupado("Adicionando Relatório relação de entrega", TipoLogSistema.Info);
                        pdfFinal.Add(pdfRelatorioRelacaoEntregaDownload);
                    }
                }

                try
                {
                    ImprimirLogObterLotePDFsAgrupado("Gerando PDF de Detalhes CTe MDF pelo ReportAPI.", TipoLogSistema.Info);
                    byte[] detalheCTeMDF = Servicos.Embarcador.Carga.Carga.GerarPDFDetalheCTeMDF(codigoCarga, unidadeTrabalho);

                    if (detalheCTeMDF != null)
                    {
                        ImprimirLogObterLotePDFsAgrupado("Adicionando Detalhe CTe MDF.", TipoLogSistema.Info);
                        pdfFinal.Add(detalheCTeMDF);
                    }
                }
                catch (Exception ex)
                {
                    ImprimirLogObterLotePDFsAgrupado("Erro ao gerar detalhes CTe MDF: " + ex.Message, TipoLogSistema.Error);
                    throw new ServicoException(ex.Message);
                }
            }

            byte[] pdfAgrupado = null;

            if (pdfFinal.Count == 0)
            {
                ImprimirLogObterLotePDFsAgrupado("Nenhum documento encontrado para gerar o PDF.", TipoLogSistema.Advertencia);
                return pdfAgrupado;
            }

            try
            {
                ImprimirLogObterLotePDFsAgrupado("Combinando arquivos PDF.", TipoLogSistema.Info);
                pdfAgrupado = svcDACTE.MergeFiles(pdfFinal);
            }
            catch (Exception ex)
            {
                ImprimirLogObterLotePDFsAgrupado("Erro ao combinar arquivos PDF: " + ex.Message, TipoLogSistema.Error);
                throw new ServicoException(ex.Message);
            }

            ImprimirLogObterLotePDFsAgrupado("Retornando PDF com conteúdo.", TipoLogSistema.Info);

            return pdfAgrupado;
        }

        public System.IO.MemoryStream ObterLoteDeXML(List<int> codigos, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork = null)
        {
            if (unitOfWork == null)
                unitOfWork = new Repositorio.UnitOfWork(StringConexao);

            Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unitOfWork);
            Servicos.CTe serCTe = new CTe(unitOfWork);
            MemoryStream fZip = new MemoryStream();
            ZipOutputStream zipOStream = new ZipOutputStream(fZip);
            zipOStream.SetLevel(9);

            int quantidadeLotes = (int)Math.Ceiling((decimal)codigos.Count / 1000);

            for (int i = 1; i <= quantidadeLotes; i++)
            {
                List<Dominio.Entidades.XMLCTe> xmls = repXMLCTe.BuscarPorCTe(codigos.Skip((i - 1) * 1000).Take(1000).ToList(), codigoEmpresa);

                foreach (Dominio.Entidades.XMLCTe xml in xmls)
                {
                    byte[] arquivo = serCTe.ObterXMLCancelamentoAutorizacao(xml, unitOfWork); // System.Text.Encoding.Default.GetBytes(xml.XML);

                    string nomeArquivoDownload = Servicos.Embarcador.CTe.CTe.ObterNomeArquivoDownloadCTe(xml.CTe, "xml");

                    if (string.IsNullOrWhiteSpace(nomeArquivoDownload))
                    {
                        string identificacao = xml.CTe.Chave;

                        if (string.IsNullOrWhiteSpace(identificacao))
                            identificacao = xml.CTe.Descricao;

                        string abrev = xml.CTe.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.CTe ? "CTe" : string.Empty;

                        nomeArquivoDownload = abrev + identificacao;

                        if (xml.Tipo == Dominio.Enumeradores.TipoXMLCTe.Cancelamento)
                        {
                            if (xml.CTe.Status == "C")
                                nomeArquivoDownload += "-procCancCTe";
                            else if (xml.CTe.Status == "I")
                                nomeArquivoDownload = abrev + xml.CTe.Descricao + "-procInutCTe";
                        }

                        nomeArquivoDownload += ".xml";
                    }

                    ZipEntry entry = new ZipEntry(nomeArquivoDownload);
                    entry.DateTime = DateTime.Now;
                    zipOStream.PutNextEntry(entry);
                    zipOStream.Write(arquivo, 0, arquivo.Length);
                    zipOStream.CloseEntry();
                }

                xmls = null;
            }

            zipOStream.IsStreamOwner = false;
            zipOStream.Close();

            fZip.Position = 0;

            return fZip;
        }

        public System.IO.MemoryStream ObterLoteXML(List<int> codigos, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCte = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            MemoryStream fZip = new MemoryStream();
            ZipOutputStream zipOStream = new ZipOutputStream(fZip);
            zipOStream.SetLevel(9);

            int quantidadeLotes = (int)Math.Ceiling((decimal)codigos.Count / 1000);

            for (int i = 1; i <= quantidadeLotes; i++)
            {
                List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> ctes = repCte.BuscarCTesPorCodigos(codigos.Skip((i - 1) * 1000).Take(1000).ToList());

                foreach (Dominio.Entidades.ConhecimentoDeTransporteEletronico cte in ctes.Where(obj => obj.Status == "A"))
                {
                    byte[] arquivo = ObterXMLCancelamentoAutorizacao(cte, Dominio.Enumeradores.TipoXMLCTe.Autorizacao, unitOfWork);
                    if (arquivo == null)
                        continue;

                    string identificacao = cte.Chave;
                    if (string.IsNullOrWhiteSpace(identificacao))
                        identificacao = cte.Descricao;
                    ZipEntry entry = new ZipEntry(string.Concat("CTe", identificacao, ".xml"));
                    entry.DateTime = DateTime.Now;
                    zipOStream.PutNextEntry(entry);
                    zipOStream.Write(arquivo, 0, arquivo.Length);
                    zipOStream.CloseEntry();
                }

                foreach (Dominio.Entidades.ConhecimentoDeTransporteEletronico cte in ctes.Where(obj => obj.Status == "C"))
                {
                    byte[] arquivo = ObterXMLCancelamentoAutorizacao(cte, Dominio.Enumeradores.TipoXMLCTe.Cancelamento, unitOfWork);
                    if (arquivo == null)
                        continue;

                    string identificacao = cte.Chave;
                    if (string.IsNullOrWhiteSpace(identificacao))
                        identificacao = cte.Descricao;
                    ZipEntry entry = new ZipEntry(string.Concat("CTe", identificacao, "-procCancCTe", ".xml"));
                    entry.DateTime = DateTime.Now;
                    zipOStream.PutNextEntry(entry);
                    zipOStream.Write(arquivo, 0, arquivo.Length);
                    zipOStream.CloseEntry();
                }
            }

            zipOStream.IsStreamOwner = false;
            zipOStream.Close();

            fZip.Position = 0;

            return fZip;
        }

        public System.IO.MemoryStream ObterLoteDeXML(List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> ctes, Repositorio.UnitOfWork unitOfWork)
        {
            MemoryStream fZip = new MemoryStream();
            ZipOutputStream zipOStream = new ZipOutputStream(fZip);
            zipOStream.SetLevel(9);
            Servicos.CTe serCTe = new CTe(unitOfWork);

            foreach (Dominio.Entidades.ConhecimentoDeTransporteEletronico cte in ctes)
            {
                if (!(cte.Status == "A" || cte.Status == "C" || cte.Status == "Z"))
                    continue;

                byte[] arquivo = serCTe.ObterXMLCancelamentoAutorizacao(cte, Dominio.Enumeradores.TipoXMLCTe.Autorizacao, unitOfWork);

                if (arquivo != null)
                {
                    ZipEntry entry = new ZipEntry(string.Concat("CTe", cte.Chave, ".xml"));
                    entry.DateTime = DateTime.Now;
                    zipOStream.PutNextEntry(entry);
                    zipOStream.Write(arquivo, 0, arquivo.Length);
                    zipOStream.CloseEntry();
                }

                if (cte.Status == "C")
                {
                    arquivo = serCTe.ObterXMLCancelamentoAutorizacao(cte, Dominio.Enumeradores.TipoXMLCTe.Cancelamento, unitOfWork);
                    if (arquivo != null)
                    {
                        ZipEntry entry = new ZipEntry(string.Concat("CTe", cte.Chave, "-procCancCTe", ".xml"));
                        entry.DateTime = DateTime.Now;
                        zipOStream.PutNextEntry(entry);
                        zipOStream.Write(arquivo, 0, arquivo.Length);
                        zipOStream.CloseEntry();
                    }
                }
            }

            zipOStream.IsStreamOwner = false;
            zipOStream.Close();

            fZip.Position = 0;

            return fZip;
        }

        public System.IO.MemoryStream ObterLoteDeDACTE(List<string> chaves, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork)
        {
            if (string.IsNullOrWhiteSpace(Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoArquivo().CaminhoRelatorios))
                throw new Exception("O caminho para os download da DACTE não está disponível.");

            string caminhoRelatorios = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoArquivo().CaminhoRelatorios;

            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unitOfWork);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);

            if (codigoEmpresa > 0)
            {
                Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCodigo(codigoEmpresa);

                MemoryStream fZip = new MemoryStream();

                using (ZipOutputStream zipOStream = new ZipOutputStream(fZip))
                {
                    zipOStream.SetLevel(9);

                    foreach (string chave in chaves)
                    {
                        string caminhoDACTE = Utilidades.IO.FileStorageService.Storage.Combine(caminhoRelatorios, empresa.CNPJ, chave) + ".pdf";

                        long tamanhoDACTE = 0;
                        if (Utilidades.IO.FileStorageService.Storage.Exists(caminhoDACTE))
                        {
                            tamanhoDACTE = Utilidades.IO.FileStorageService.Storage.GetFileInfo(caminhoDACTE).Size;
                        }

                        if (!Utilidades.IO.FileStorageService.Storage.Exists(caminhoDACTE) || tamanhoDACTE <= 0)
                        {
                            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorChave(0, chave);

                            if (Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoAmbiente().RegerarDACTEOracle.Value && cte.CodigoCTeIntegrador > 0)
                            {
                                //Alterado para obter a DACTE do Oracle para não iniciar o Gerador de relatórios
                                if (cte != null)
                                    ObterESalvarDACTE(cte, empresa.Codigo);
                            }
                            else
                            {
                                if (cte != null)
                                {
                                    byte[] dacte = null;
                                    DACTE svcDACTE = new DACTE(unitOfWork);
                                    dacte = svcDACTE.GerarPorProcesso(cte.Codigo);
                                }
                            }
                        }

                        if (Utilidades.IO.FileStorageService.Storage.Exists(caminhoDACTE))
                        {
                            byte[] dacte = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminhoDACTE);

                            ZipEntry entry = new ZipEntry(string.Concat(chave, ".pdf"));

                            entry.DateTime = DateTime.Now;

                            zipOStream.PutNextEntry(entry);
                            zipOStream.Write(dacte, 0, dacte.Length);
                            zipOStream.CloseEntry();
                        }
                    }

                    zipOStream.IsStreamOwner = false;
                    zipOStream.Close();
                }

                fZip.Position = 0;

                return fZip;
            }
            else
            {
                MemoryStream fZip = new MemoryStream();

                using (ZipOutputStream zipOStream = new ZipOutputStream(fZip))
                {
                    zipOStream.SetLevel(9);

                    foreach (string chave in chaves)
                    {
                        Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorChave(0, chave);
                        if (cte != null && cte.Status == "A")
                        {
                            Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCodigo(cte.Empresa.Codigo);

                            string caminhoDACTE = Utilidades.IO.FileStorageService.Storage.Combine(caminhoRelatorios, cte.Empresa.CNPJ, chave) + ".pdf";

                            if (Utilidades.IO.FileStorageService.Storage.Exists(caminhoDACTE))
                            {
                                byte[] dacte = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminhoDACTE);

                                ZipEntry entry = new ZipEntry(string.Concat(chave, ".pdf"));

                                entry.DateTime = DateTime.Now;

                                zipOStream.PutNextEntry(entry);
                                zipOStream.Write(dacte, 0, dacte.Length);
                                zipOStream.CloseEntry();
                            }
                        }
                    }

                    zipOStream.IsStreamOwner = false;
                    zipOStream.Close();
                }

                fZip.Position = 0;

                return fZip;

            }

        }

        public bool EnviarEmail(int codigoCTe, int codigoEmpresa, string emails, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorId(codigoCTe, codigoEmpresa);
            if (cte != null)
            {
                ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unitOfWork).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);
                ServicoCTe.ResultadoString retorno = svcCTe.EnviarEmailCTe(cte.CodigoCTeIntegrador, emails);

                if (retorno.Info.Tipo == "OK")
                    return true;
            }
            return false;
        }

        public bool EnviarEmail(int codigoCTe, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorId(codigoCTe, codigoEmpresa);
            if (cte != null)
            {
                ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unitOfWork).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);
                ServicoCTe.ResultadoString retorno = svcCTe.EnviarEmailCTeParaTodos(cte.CodigoCTeIntegrador);
                if (retorno.Info.Tipo == "OK")
                    return true;
            }
            return false;
        }

        public bool EnviarEmail(int codigoCTe, string emails, Repositorio.UnitOfWork unidadeTrabalho)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);
            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorCodigo(codigoCTe);

            return Servicos.Embarcador.EmissorDocumento.EmissorDocumentoService.EmissorDocumentoCTe.EnviarEmail(cte, emails, unidadeTrabalho);
        }

        public bool EnviarEmail(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, string emails, Repositorio.UnitOfWork unitOfWork)
        {
            ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unitOfWork).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);
            ServicoCTe.ResultadoString retorno = svcCTe.EnviarEmailCTe(cte.CodigoCTeIntegrador, emails);

            if (retorno.Info.Tipo == "OK")
                return true;
            else
                return false;
        }

        public bool Emitir(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unitOfWork, string statusPosEmissao = "E", string wsOracle = "")
        {
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);

            if (!ValidarEmissaoImpostosIBSCBS(cte, unitOfWork))
                return false;

            bool retorno = Servicos.Embarcador.EmissorDocumento.EmissorDocumentoService.EmissorDocumentoCTe.EmitirCte(ref cte, null, unitOfWork, statusPosEmissao, wsOracle);

            if (!retorno && Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoAmbiente().ReenviarErroIntegracaoCTe.Value)
            {
                Servicos.Log.TratarErro("CT-e codigo " + cte.Codigo.ToString() + ": Reenviado problema integração", "ReenvioCTe");

                System.Threading.Thread.Sleep(2000);
                retorno = Servicos.Embarcador.EmissorDocumento.EmissorDocumentoService.EmissorDocumentoCTe.EmitirCte(ref cte, null, unitOfWork, statusPosEmissao, wsOracle);

                if (!retorno)
                {
                    System.Threading.Thread.Sleep(2000);
                    retorno = Servicos.Embarcador.EmissorDocumento.EmissorDocumentoService.EmissorDocumentoCTe.EmitirCte(ref cte, null, unitOfWork, statusPosEmissao, wsOracle);
                }
                if (!retorno)
                {
                    System.Threading.Thread.Sleep(2000);
                    retorno = Servicos.Embarcador.EmissorDocumento.EmissorDocumentoService.EmissorDocumentoCTe.EmitirCte(ref cte, null, unitOfWork, statusPosEmissao, wsOracle);
                }
            }

            if (repTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.CargoX) != null)
                Servicos.Embarcador.Integracao.CargoX.IntegracaoCargoX.IntegrarSituacaoCTe(cte, unitOfWork);

            SalvarIntegracaoRetornoCTe(cte, cte.Empresa, unitOfWork);

            return retorno;
        }

        public bool Emitir(int codigoCTe, int codigoEmpresa = 0, Repositorio.UnitOfWork unitOfWork = null, string statusPosEmissao = "E", string wsOracle = "")
        {
            unitOfWork = unitOfWork ?? new Repositorio.UnitOfWork(StringConexao);

            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unitOfWork);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);

            Dominio.Entidades.Empresa empresa = codigoEmpresa > 0 ? repEmpresa.BuscarPorCodigo(codigoEmpresa) : null;
            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = codigoEmpresa > 0 ? repCTe.BuscarPorCodigo(codigoEmpresa, codigoCTe) : repCTe.BuscarPorCodigoComFetch(codigoCTe);

            if (!ValidarEmissaoImpostosIBSCBS(cte, unitOfWork))
                return false;

            bool retorno = Servicos.Embarcador.EmissorDocumento.EmissorDocumentoService.EmissorDocumentoCTe.EmitirCte(ref cte, empresa, unitOfWork, statusPosEmissao, wsOracle);

            if (!retorno && Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoAmbiente().ReenviarErroIntegracaoCTe.Value)
            {
                retorno = Servicos.Embarcador.EmissorDocumento.EmissorDocumentoService.EmissorDocumentoCTe.EmitirCte(ref cte, empresa, unitOfWork, statusPosEmissao, wsOracle);
                if (!retorno)
                    retorno = Servicos.Embarcador.EmissorDocumento.EmissorDocumentoService.EmissorDocumentoCTe.EmitirCte(ref cte, empresa, unitOfWork, statusPosEmissao, wsOracle);
                if (!retorno)
                    retorno = Servicos.Embarcador.EmissorDocumento.EmissorDocumentoService.EmissorDocumentoCTe.EmitirCte(ref cte, empresa, unitOfWork, statusPosEmissao, wsOracle);
            }

            if (repTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.CargoX) != null)
                Servicos.Embarcador.Integracao.CargoX.IntegracaoCargoX.IntegrarSituacaoCTe(cte, unitOfWork);

            return retorno;
        }

        public bool SincronizarDocumentoEmProcessamento(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, string wsOracle = "")
        {
            ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unitOfWork).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);

            if (!string.IsNullOrWhiteSpace(wsOracle))
            {
                string endpoint = string.Concat(wsOracle, "uCTeServiceTS.asmx");
                svcCTe.Endpoint.Address = new System.ServiceModel.EndpointAddress(endpoint);
            }

            try
            {
                Servicos.ServicoCTe.RetornoCTE retorno = svcCTe.ConsultaProtocoloCte(cte.CodigoCTeIntegrador);

                Dominio.ObjetosDeValor.WebService.CTe.CTeOracle cteOracle = new Dominio.ObjetosDeValor.WebService.CTe.CTeOracle();
                cteOracle.DataRecibo = retorno.DataRecibo.ToString("dd/MM/yyyy HH:mm:ss");
                cteOracle.CodStatusEnvio = retorno.CodStatusEnvio;
                cteOracle.DescricaoEnvio = retorno.DescricaoEnvio;
                cteOracle.NumeroRecibo = retorno.NumeroRecibo;
                cteOracle.DataProtocolo = retorno.DataProtocolo.ToString("dd/MM/yyyy HH:mm:ss");
                cteOracle.CodStatusProtocolo = retorno.CodStatusProtocolo;
                cteOracle.DescricaoProtocolo = retorno.DescricaoProtocolo;
                cteOracle.NumeroProtocolo = retorno.NumeroProtocolo;
                cteOracle.ChaveCTE = retorno.ChaveCTE;
                cteOracle.DigVerificador = retorno.DigVerificador;
                cteOracle.StatusIntegrador = retorno.StatusIntegrador;
                cteOracle.DescricaoStatusIntegrador = retorno.DescricaoStatusIntegrador;
                cteOracle.CodigoCTeInterno = retorno.CodigoCTeInterno;
                cteOracle.PDFDacte = retorno.PDFDacte;
                cteOracle.XML = retorno.XML;

                if (retorno.Info != null)
                {
                    cteOracle.Info = new Dominio.ObjetosDeValor.WebService.CTe.Resultado();
                    cteOracle.Info.Tipo = retorno.Info.Tipo;
                    cteOracle.Info.Mensagem = retorno.Info.Mensagem;
                }

                string mensagemErro = string.Empty;

                Servicos.CTe serCTe = new Servicos.CTe(unitOfWork);
                serCTe.ProcessarRetornoCTeAutorizado(cteOracle, cte, Auditado, tipoServicoMultisoftware, unitOfWork);
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Exception Sincronizar Documento");
                Servicos.Log.TratarErro(ex);

                throw;
            }

            return true;
        }

        public Dominio.Entidades.ConhecimentoDeTransporteEletronico ConsultaEAtualizaStatusDocumento(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork, string wsOracle = "")
        {
            ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unitOfWork).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unitOfWork);

            if (!string.IsNullOrWhiteSpace(wsOracle))
            {
                string endpoint = string.Concat(wsOracle, "uCTeServiceTS.asmx");
                svcCTe.Endpoint.Address = new System.ServiceModel.EndpointAddress(endpoint);
            }

            try
            {
                if (cte.CodigoCTeIntegrador != 0)
                {
                    Servicos.ServicoCTe.RetornoCTE retorno = svcCTe.ConsultaProtocoloCte(cte.CodigoCTeIntegrador);
                    var status = retorno.StatusIntegrador;
                    var codigoStatus = retorno.CodStatusEnvio;

                    if ((status != null && (status.Equals("M") || status.Equals('D'))) || (codigoStatus != null && codigoStatus.Equals("100")))
                    {
                        unitOfWork.Start();

                        cte.Status = "A";
                        cte.MensagemRetornoSefaz = "Autorizado o uso do CT-e";

                        if (retorno.XML != null)
                        {
                            var cteXML = new Dominio.Entidades.XMLCTe()
                            {
                                XML = retorno.XML,
                                Tipo = Dominio.Enumeradores.TipoXMLCTe.Autorizacao,
                                XMLArmazenadoEmArquivo = false,
                                CTe = cte
                            };

                            repXMLCTe.Inserir(cteXML);
                        }


                        repCTe.Atualizar(cte);

                        unitOfWork.CommitChanges();
                    }
                }
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Exception Sincronizar Documento");
                Servicos.Log.TratarErro(ex);

                throw;
            }

            return cte;
        }

        public int ObterProximoNumero(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.ConhecimentoDeTransporteEletronico repCTe)
        {
            (int codigoCTE, int proximoNumeroCTE) = repCTe.BuscarNumeroReutilizavel(cte.Empresa.Codigo, cte.Serie.Codigo, cte.TipoAmbiente, cte.ModeloDocumentoFiscal.Codigo);

            if (codigoCTE > 0)
            {
                List<string> comand = new List<string>();
                comand.Add($" UPDATE T_CTE SET CON_REUTILIZA_NUMERACAO = {(int)Dominio.Enumeradores.ReutilizaNumeracao.Reutilizado}, CON_TIPO_CONTROLE = CON_CODIGO * -1 WHERE CON_CODIGO = {codigoCTE} ");
                repCTe.ComandSql(comand);
            }
            else
            {
                proximoNumeroCTE = repCTe.BuscarUltimoNumero(cte.Empresa.Codigo, cte.Serie.Codigo, cte.TipoAmbiente, cte.ModeloDocumentoFiscal.Codigo) + 1;
            }

            return proximoNumeroCTE;
        }

        public bool EmitirCte(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.Entidades.Empresa empresa, Repositorio.UnitOfWork unitOfWork, string statusPosEmissao = "E", string wsOracle = "")
        {
            ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unitOfWork).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);

            if (!string.IsNullOrWhiteSpace(wsOracle))
            {
                string endpoint = string.Concat(wsOracle, "uCTeServiceTS.asmx");
                svcCTe.Endpoint.Address = new System.ServiceModel.EndpointAddress(endpoint);
            }

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);

            Repositorio.ErroSefaz repErroSefaz = new Repositorio.ErroSefaz(unitOfWork);
            Dominio.Entidades.ErroSefaz erroSefaz = repErroSefaz.BuscarPorCodigoDoErro(8888, Dominio.Enumeradores.TipoErroSefaz.CTe);


            if (empresa == null)
                empresa = cte.Empresa;

            try
            {
                cte.LogIntegracao += "Enviado para o Oracle (" + svcCTe.Endpoint.Address.Uri + "). ";
                cte.SistemaEmissor = TipoEmissorDocumento.Integrador;

                //Servicos.Log.TratarErro(DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff") + " - Iniciou obter ct-e emissão.");

                if (cte.TipoCTE == Dominio.Enumeradores.TipoCTE.Simplificado || cte.TipoCTE == Dominio.Enumeradores.TipoCTE.SimplificadoSubstituto)
                    throw new ServicoException("Tipo de CT-e simplificado não homologado no Integrador.");

                ServicoCTe.Cte cteImportar = this.ObterCTeParaEmissao(cte, empresa, unitOfWork);

                //Servicos.Log.TratarErro(DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff") + " - Iniciou envio ct-e para oracle.");

                ServicoCTe.ResultadoInteger retorno = svcCTe.ImportaCte(cteImportar);

                //Servicos.Log.TratarErro(DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff") + " - Finalizou envio ct-e para oracle.");

                if (retorno.Valor <= 0)
                {
                    Servicos.Log.TratarErro("Erro integrar CTe " + cte.Codigo.ToString() + ": " + Utilidades.String.ReplaceInvalidCharacters(retorno.Info.Mensagem));
                    Servicos.Log.TratarErro("Erro integrar CTe " + cte.Codigo.ToString() + ": " + retorno.Info.MensagemOriginal);

                    //cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(retorno.Info.Mensagem);
                    cte.MensagemRetornoSefaz = string.Concat(DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), " - ERRO: Sefaz indisponível no momento. Tente novamente.");
                    if (erroSefaz != null)
                        cte.MensagemStatus = erroSefaz;
                    cte.Status = "R";

                    repCTe.Atualizar(cte);

                    return false;
                }
                else
                {
                    cte.CodigoCTeIntegrador = retorno.Valor;
                    cte.MensagemRetornoSefaz = "CT-e em processamento.";
                    cte.Status = statusPosEmissao;
                    cte.DataIntegracao = DateTime.Now;

                    repCTe.Atualizar(cte);

                    bool atualizarTipoEmpresa = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoAmbiente().AtualizarTipoEmpresa.Value;
                    if (atualizarTipoEmpresa && (cte.Usuario?.Callcenter ?? false) && cte.Empresa.StatusEmissao != "C")
                    {
                        Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unitOfWork);

                        cte.Empresa.StatusEmissao = "C";
                        repEmpresa.Atualizar(cte.Empresa);

                        Servicos.Log.TratarErro(cte.Empresa.Descricao + " alterada para callcenter devido a emissão do CTe " + cte.Descricao + " por " + cte.Usuario.Descricao, "StatusEmissaoEmpresa");
                    }


                    return true;
                }
            }
            catch (FaultException ex)
            {
                cte.Status = "R";
                cte.MensagemRetornoSefaz = string.Concat(DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), " - ERRO: Sefaz indisponível no momento. Tente novamente.");
                if (erroSefaz != null)
                    cte.MensagemStatus = erroSefaz;
                repCTe.Atualizar(cte);

                SalvarRetornoSefaz(cte, "A", 0, 8888, "ERRO: Sefaz indisponível no momento. Tente novamente.", unitOfWork);

                enviarEmail(cte, ex.ToString(), unitOfWork);
                Servicos.Log.TratarErro("FaultException Emitir");
                Servicos.Log.TratarErro(ex);

                return false;
            }
            catch (ServicoException ex)
            {
                Servicos.Log.TratarErro(ex);
                try
                {
                    cte.Status = "R";
                    cte.MensagemRetornoSefaz = string.Concat(DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), $" - {ex.Message}.");
                    if (erroSefaz != null)
                        cte.MensagemStatus = erroSefaz;
                    repCTe.Atualizar(cte);

                    SalvarRetornoSefaz(cte, "A", 0, 8888, ex.Message, unitOfWork);

                    enviarEmail(cte, ex.ToString(), unitOfWork);
                }
                catch (Exception exptEmail)
                {
                    Servicos.Log.TratarErro("Erro ao enviar e-mail:" + exptEmail);
                    throw;
                }

                return false;
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Exception Emitir");
                Servicos.Log.TratarErro(ex);
                try
                {
                    cte.Status = "R";
                    cte.MensagemRetornoSefaz = string.Concat(DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), " - ERRO: Sefaz indisponível no momento. Tente novamente.");
                    if (erroSefaz != null)
                        cte.MensagemStatus = erroSefaz;
                    repCTe.Atualizar(cte);

                    SalvarRetornoSefaz(cte, "A", 0, 8888, "ERRO: Sefaz indisponível no momento. Tente novamente.", unitOfWork);

                    enviarEmail(cte, ex.ToString(), unitOfWork);
                }
                catch (Exception exptEmail)
                {
                    Servicos.Log.TratarErro("Erro ao enviar e-mail:" + exptEmail);
                    throw;
                }

                return false;
            }
        }

        private void enviarEmail(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, string ex, Repositorio.UnitOfWork unidadeTrabalho)
        {
            Email svcEmail = new Servicos.Email(unidadeTrabalho);

            string ambiente = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeTrabalho).ObterConfiguracaoAmbiente().IdentificacaoAmbiente;
            string assunto = ambiente + " - Problemas na emissão de CT-e!";

            System.Text.StringBuilder sb = new System.Text.StringBuilder();
            sb.Append("<p>Atenção, problemas na emissão de CT-e no ambiente ").Append(ambiente).Append(" - ").Append(DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss")).Append("<br /> <br />");
            sb.Append("CTe ").Append(cte.Numero).Append("/").Append(cte.Serie.Numero.ToString()).Append(" transportador ").Append(cte.Empresa.CNPJ).Append(" ").Append(cte.Empresa.RazaoSocial).Append("<br /> <br />");
            sb.Append("Erro: ").Append(ex).Append("</p><br /> <br />");

            System.Text.StringBuilder ss = new System.Text.StringBuilder();
            ss.Append("MultiSoftware - http://www.multicte.com.br/ <br />");

#if DEBUG
            svcEmail.EnviarEmail(string.Empty, string.Empty, string.Empty, "infra@multisoftware.com.br", "", "", assunto, sb.ToString(), string.Empty, null, ss.ToString(), true, "cte@multisoftware.com.br", 0, unidadeTrabalho, 0, true, null, false);
#else
            svcEmail.EnviarEmail(string.Empty, string.Empty, string.Empty, "infra@multisoftware.com.br", "", "cesar@multisoftware.com.br", assunto, sb.ToString(), string.Empty, null, ss.ToString(), true, "cte@multisoftware.com.br", 0, unidadeTrabalho, 0, true, null, false);
            svcEmail.EnviarEmail(string.Empty, string.Empty, string.Empty, "cesar@multisoftware.com.br", "rodrigo@multisoftware.com.br", "willian@multisoftware.com.br", assunto, sb.ToString(), string.Empty, null, ss.ToString(), true, "cte@multisoftware.com.br", 0, unidadeTrabalho, 0, true, null, false);
#endif
        }

        public Dominio.Entidades.ConhecimentoDeTransporteEletronico GerarCTePorPreCTe(System.IO.Stream xml, int codigoEmpresa = 0, int codigoUsuario = 0, bool subContratacao = false, int codigoCTe = 0, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware = null)
        {
            Repositorio.UnitOfWork unidadeTrabalho = new Repositorio.UnitOfWork(StringConexao);

            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeTrabalho);
            Repositorio.Usuario repUsuario = new Repositorio.Usuario(unidadeTrabalho);

            object arquivo = MultiSoftware.CTe.Servicos.Leitura.Ler(xml);

            xml.Dispose();

            try
            {
                unidadeTrabalho.Start();

                Type tipoArquivo = arquivo.GetType();

                if (tipoArquivo == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTe))
                    return this.GerarCTePorPreCTe(codigoEmpresa, codigoUsuario, (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTe)arquivo, unidadeTrabalho);

                if (tipoArquivo == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporteProcessado.cteProc))
                    return this.GerarCTePorPreCTe(codigoEmpresa, codigoUsuario, ((MultiSoftware.CTe.v104.ConhecimentoDeTransporteProcessado.cteProc)arquivo).CTe, unidadeTrabalho);

                if (tipoArquivo == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTe))
                    return this.GerarCTePorPreCTe(codigoEmpresa, codigoUsuario, (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTe)arquivo, unidadeTrabalho);

                if (tipoArquivo == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporteProcessado.cteProc))
                    return this.GerarCTePorPreCTe(codigoEmpresa, codigoUsuario, ((MultiSoftware.CTe.v200.ConhecimentoDeTransporteProcessado.cteProc)arquivo).CTe, unidadeTrabalho);

                if (tipoArquivo == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporteProcessado.cteProc))
                {
                    if (codigoCTe > 0 && subContratacao)
                        return this.AdicionarCTeSubcontratacao(codigoCTe, codigoEmpresa, codigoUsuario, (MultiSoftware.CTe.v300.ConhecimentoDeTransporteProcessado.cteProc)arquivo, unidadeTrabalho, subContratacao);
                    else
                        return this.GerarCTePorPreCTe(codigoEmpresa, codigoUsuario, (MultiSoftware.CTe.v300.ConhecimentoDeTransporteProcessado.cteProc)arquivo, unidadeTrabalho, subContratacao, tipoServicoMultisoftware);
                }

                if (tipoArquivo == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporteProcessado.cteProc))
                {
                    if (codigoCTe > 0 && subContratacao)
                        return this.AdicionarCTeSubcontratacao(codigoCTe, codigoEmpresa, codigoUsuario, (MultiSoftware.CTe.v400.ConhecimentoDeTransporteProcessado.cteProc)arquivo, unidadeTrabalho, subContratacao);
                    else
                        return this.GerarCTePorPreCTe(codigoEmpresa, codigoUsuario, (MultiSoftware.CTe.v400.ConhecimentoDeTransporteProcessado.cteProc)arquivo, unidadeTrabalho, subContratacao, tipoServicoMultisoftware);
                }

                unidadeTrabalho.Rollback();
                return null;
            }
            catch (Exception ex)
            {
                unidadeTrabalho.Rollback();
                Servicos.Log.TratarErro(ex);
                throw;
            }
        }

        public Dominio.Entidades.ConhecimentoDeTransporteEletronico PreencherCTePorObjeto(Dominio.ObjetosDeValor.Embarcador.CTe.CTe cteIntegracao, Dominio.Entidades.Empresa empresa, Repositorio.UnitOfWork unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Dominio.Entidades.ModeloDocumentoFiscal modeloDocumentoFiscal = null, Dominio.Entidades.EmpresaSerie serie = null, long? tipoControle = null, bool? tomadorPagador = null)
        {
            try
            {
                Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeDeTrabalho);
                Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);
                Repositorio.ObservacaoContribuinteCTE repObservacaoContribuinteCTE = new Repositorio.ObservacaoContribuinteCTE(unidadeDeTrabalho);
                Cliente svcCliente = new Cliente(StringConexao);

                Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();

                cte.LogIntegracao += "Gerado no servidor (MachineName: " + System.Environment.MachineName + "). Aplicação (" + System.Reflection.Assembly.GetExecutingAssembly().CodeBase + "). ";
                cte.Versao = !string.IsNullOrWhiteSpace(cteIntegracao.Versao) ? cteIntegracao.Versao : empresa.Configuracao != null && !string.IsNullOrWhiteSpace(empresa.Configuracao.VersaoCTe) ? empresa.Configuracao.VersaoCTe : empresa.EmpresaPai.Configuracao != null && !string.IsNullOrWhiteSpace(empresa.EmpresaPai.Configuracao.VersaoCTe) ? empresa.EmpresaPai.Configuracao.VersaoCTe : "4.00";
                //cte.IndicadorGlobalizado = cteIntegracao.indicadorGlobalizado; //CTe 3.0
                //cte.ValorCarbaAverbacao = cteIntegracao.ValorCargaAverbacao; //CTe 3.0
                //cte.IndicadorIETomador = cteIntegracao.indicadorIETomador; //CTe 3.0
                //cte.PercentualICMSIncluirNoFrete = cteIntegracao.PercentualICMSIncluirNoFrete;
                cte.Empresa = empresa;
                cte.TipoTomador = cteIntegracao.TipoTomador;
                cte.TipoPagamento = cteIntegracao.TipoPagamento;
                cte.ValorICMS = cteIntegracao.ValorFrete.ICMS.ValorICMS;
                cte.BaseCalculoICMS = cteIntegracao.ValorFrete.ICMS.ValorBaseCalculoICMS;
                cte.CST = cteIntegracao.ValorFrete.ICMS.CST;
                cte.AliquotaICMS = cteIntegracao.ValorFrete.ICMS.Aliquota;
                cte.SimplesNacional = cteIntegracao.ValorFrete.ICMS.SimplesNacional ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao;
                cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Nao;
                cte.IncluirISSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Nao;
                cte.ValorFrete = cteIntegracao.ValorFrete.FreteProprio;
                cte.ValorPrestacaoServico = cteIntegracao.ValorFrete.ValorPrestacaoServico;
                cte.ValorAReceber = cteIntegracao.ValorFrete.ValorTotalAReceber;
                cte.ExibeICMSNaDACTE = true;
                cte.ValorTotalMercadoria = cteIntegracao.InformacaoCarga.ValorTotalCarga;
                cte.ProdutoPredominante = !string.IsNullOrWhiteSpace(cteIntegracao.InformacaoCarga.ProdutoPredominante) ? cteIntegracao.InformacaoCarga.ProdutoPredominante : cte.Empresa.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.Configuracao.ProdutoPredominante) ? cte.Empresa.Configuracao.ProdutoPredominante : "DIVERSOS";
                cte.Retira = cteIntegracao.Retira ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao;
                cte.DetalhesRetira = cteIntegracao.DetalhesRetira;
                cte.RNTRC = cte.Empresa.RegistroANTT;
                cte.CIOT = cteIntegracao.ModalRodoviario.CIOT;
                cte.Chave = cteIntegracao.Chave;
                if (cte.LocalidadeInicioPrestacao == null)
                    cte.LocalidadeInicioPrestacao = cte.Expedidor?.Localidade ?? cte.Remetente?.Localidade;
                if (cte.LocalidadeTerminoPrestacao == null)
                    cte.LocalidadeTerminoPrestacao = cte.Recebedor?.Localidade ?? cte.Destinatario?.Localidade;


                DateTime dataPrevistaEntrega = DateTime.MinValue;
                if (cteIntegracao.ModalRodoviario.DataEntrega != null)
                    DateTime.TryParseExact(cteIntegracao.ModalRodoviario.DataEntrega, "dd/MM/yyyy", null, System.Globalization.DateTimeStyles.None, out dataPrevistaEntrega);

                cte.DataPrevistaEntrega = dataPrevistaEntrega == DateTime.MinValue ? DateTime.Now.AddDays(cte.Empresa.Configuracao.DiasParaEntrega) : dataPrevistaEntrega;
                cte.TipoAmbiente = cteIntegracao.TipoAmbiente;
                cte.TipoCTE = cteIntegracao.TipoCTE;
                cte.TipoEmissao = "1"; // Normal
                cte.TipoEnvio = 0; // 0 - Normal
                cte.TipoImpressao = cteIntegracao.TipoImpressao <= 0 && empresa.Configuracao != null ? empresa.Configuracao.TipoImpressao : cteIntegracao.TipoImpressao;
                cte.TipoServico = cteIntegracao.TipoServico;

                TimeZoneInfo fusoHorarioEmpresa = TimeZoneInfo.FindSystemTimeZoneById(cte.Empresa.FusoHorario);
                DateTime dataFuso = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day, DateTime.Now.Hour, DateTime.Now.Minute, 0);
                dataFuso = TimeZoneInfo.ConvertTime(dataFuso, TimeZoneInfo.Local, fusoHorarioEmpresa);

                cte.DataEmissao = cteIntegracao.DataEmissao == DateTime.MinValue ? dataFuso : cteIntegracao.DataEmissao;

                cte.ModalTransporte = repModalTransporte.BuscarPorNumero((int)cteIntegracao.TipoModal > 0 ? cteIntegracao.TipoModal.ToString("D") : "1");
                //cte.ModalTransporte = repModalTransporte.BuscarPorId(1);

                if (modeloDocumentoFiscal == null)
                    cte.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("57");
                else
                    cte.ModeloDocumentoFiscal = modeloDocumentoFiscal;

                if (!tipoControle.HasValue)
                {
                    if (cte.ModeloDocumentoFiscal.Numero == "57")
                        cte.TipoControle = 1;
                    else
                        cte.TipoControle = repCTe.BuscarUltimoTipoControle() + 1;
                }
                else
                {
                    cte.TipoControle = tipoControle.Value;
                }

                cte.Lotacao = cteIntegracao.ModalRodoviario.Lotacao ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao;
                cte.LocalidadeEmissao = cte.Empresa.Localidade;
                cte.Serie = serie;
                cte.Status = "A"; // A - AUTORIZADO
                cte.Cancelado = "N";
                cte.Numero = cteIntegracao.Numero;
                cte.ObservacoesGerais = cteIntegracao.ObservacoesGeral?.Texto ?? string.Empty;

                cte.LocalidadeInicioPrestacao = repLocalidade.BuscarPorDescricaoEUF(cteIntegracao.LocalidadeInicioPrestacao.Descricao, cteIntegracao.LocalidadeInicioPrestacao.SiglaUF);
                cte.LocalidadeTerminoPrestacao = repLocalidade.BuscarPorDescricaoEUF(cteIntegracao.LocalidadeFimPrestacao.Descricao, cteIntegracao.LocalidadeFimPrestacao.SiglaUF);

                if (cte.LocalidadeInicioPrestacao == null)
                    cte.LocalidadeInicioPrestacao = cte.Expedidor?.Localidade ?? cte.Remetente?.Localidade;
                if (cte.LocalidadeTerminoPrestacao == null)
                    cte.LocalidadeTerminoPrestacao = cte.Recebedor?.Localidade ?? cte.Destinatario?.Localidade;

                cte.CFOP = repCFOP.BuscarPorNumero(cteIntegracao.CFOP);
                if (cte.CFOP == null)
                    throw new ArgumentNullException("CFOP informada não existe na base da Multisoftware.");
                cte.NaturezaDaOperacao = cte.CFOP.NaturezaDaOperacao;

                Dominio.ObjetosDeValor.RetornoVerificacaoCliente addRemetente = svcCliente.ConverterObjetoValorPessoa(cteIntegracao.Remetente, string.Empty, unidadeDeTrabalho, empresa.Codigo);
                if (!addRemetente.Status && cteIntegracao.Remetente != null) throw new ArgumentNullException("Não foi possível inserir o Remetente.");

                Dominio.ObjetosDeValor.RetornoVerificacaoCliente addExpedidor = svcCliente.ConverterObjetoValorPessoa(cteIntegracao.Expedidor, string.Empty, unidadeDeTrabalho, empresa.Codigo);
                if (!addExpedidor.Status && cteIntegracao.Expedidor != null) throw new ArgumentNullException("Não foi possível inserir o Expedidor.");

                Dominio.ObjetosDeValor.RetornoVerificacaoCliente addRecebedor = svcCliente.ConverterObjetoValorPessoa(cteIntegracao.Recebedor, string.Empty, unidadeDeTrabalho, empresa.Codigo);
                if (!addRecebedor.Status && cteIntegracao.Recebedor != null) throw new ArgumentNullException("Não foi possível inserir o Recebedor.");

                Dominio.ObjetosDeValor.RetornoVerificacaoCliente addDestinatario = svcCliente.ConverterObjetoValorPessoa(cteIntegracao.Destinatario, string.Empty, unidadeDeTrabalho, empresa.Codigo);
                if (!addDestinatario.Status && cteIntegracao.Destinatario != null) throw new ArgumentNullException("Não foi possível inserir o Destinatario.");

                Dominio.ObjetosDeValor.RetornoVerificacaoCliente addTomador = svcCliente.ConverterObjetoValorPessoa(cteIntegracao.Tomador, string.Empty, unidadeDeTrabalho, empresa.Codigo);
                if (!addDestinatario.Status && cteIntegracao.Tomador != null) throw new ArgumentNullException("Não foi possível inserir o Tomador.");

                this.ObterParticipante(ref cte, svcCliente.ObterClienteCTE(addRemetente.cliente, null), Dominio.Enumeradores.TipoTomador.Remetente, unidadeDeTrabalho);
                this.ObterParticipante(ref cte, svcCliente.ObterClienteCTE(addExpedidor.cliente, null), Dominio.Enumeradores.TipoTomador.Expedidor, unidadeDeTrabalho);
                this.ObterParticipante(ref cte, svcCliente.ObterClienteCTE(addRecebedor.cliente, null), Dominio.Enumeradores.TipoTomador.Recebedor, unidadeDeTrabalho);
                this.ObterParticipante(ref cte, svcCliente.ObterClienteCTE(addDestinatario.cliente, null), Dominio.Enumeradores.TipoTomador.Destinatario, unidadeDeTrabalho);

                if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Outros)
                {
                    this.ObterParticipante(ref cte, svcCliente.ObterClienteCTE(addTomador.cliente, null), Dominio.Enumeradores.TipoTomador.Outros, unidadeDeTrabalho);
                }
                else
                {
                    Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Outros);

                    if (part != null)
                    {
                        Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeDeTrabalho);

                        cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Outros);

                        repParticipante.Deletar(part);
                    }
                }

                //SetarTomadorPagadorCTe(ref cte);
                if (tomadorPagador.HasValue && tomadorPagador.Value == true)
                {
                    Dominio.ObjetosDeValor.RetornoVerificacaoCliente _cliente = svcCliente.ConverterParaTransportadorTerceiro(cteIntegracao.Emitente, string.Empty, unidadeDeTrabalho);
                    //cte.SetarParticipante(addRemetente.cliente, Dominio.Enumeradores.TipoTomador.TomadorPagador);
                    this.ObterParticipante(ref cte, svcCliente.ObterClienteCTE(_cliente.cliente, null), Dominio.Enumeradores.TipoTomador.Intermediario, unidadeDeTrabalho);
                }

                //cte.ClienteRetira = this.ObterCliente(empresa, cteIntegracao.Retira, unidadeDeTrabalho);
                //cte.ClienteEntrega = this.ObterCliente(empresa, cteIntegracao.ClienteEntrega, unidadeDeTrabalho);

                repCTe.Inserir(cte);

                Dominio.Entidades.ObservacaoContribuinteCTE obsLocalidadeTermino = new Dominio.Entidades.ObservacaoContribuinteCTE()
                {
                    CTE = cte,
                    Descricao = cte.LocalidadeTerminoPrestacao?.DescricaoCidadeEstado ?? cteIntegracao.LocalidadeFimPrestacao.Descricao,
                    Identificador = "LOCTERMINO"
                };
                Dominio.Entidades.ObservacaoContribuinteCTE obsLocalidadeInicio = new Dominio.Entidades.ObservacaoContribuinteCTE()
                {
                    CTE = cte,
                    Descricao = cte.LocalidadeInicioPrestacao?.DescricaoCidadeEstado ?? cteIntegracao.LocalidadeInicioPrestacao.Descricao,
                    Identificador = "LOCINICIO"
                };

                repObservacaoContribuinteCTE.Inserir(obsLocalidadeTermino);
                repObservacaoContribuinteCTE.Inserir(obsLocalidadeInicio);

                this.SalvarInformacoesVeiculos(ref cte, cteIntegracao.ModalRodoviario.Veiculos, unidadeDeTrabalho, tipoServicoMultisoftware);
                this.SalvarInformacoesMotoristas(cte, cteIntegracao.ModalRodoviario.Motoristas, unidadeDeTrabalho);
                this.SalvarInformacoesDeQuantidadeDaCarga(cte, cteIntegracao.QuantidadesCarga, unidadeDeTrabalho);
                this.SalvarInformacoesDeSeguroDaCarga(cte, cteIntegracao.Seguros, unidadeDeTrabalho);
                this.SalvarInformacoesProdutosPerigosos(cte, cteIntegracao.ProdutosPerigosos, unidadeDeTrabalho);
                this.SalvarInformacoesComponentesDaPrestacao(cte, cteIntegracao.ValorFrete.ComponentesAdicionais, unidadeDeTrabalho);
                this.SalvarInformacoesDocumentos(cte, cteIntegracao.NFEs, unidadeDeTrabalho);
                //this.SalvarInformacoesDocumentosAnteriores(cte, cteIntegracao.DocumentosAnteriores, unidadeDeTrabalho);
                //this.SalvarInformacoesValePedagio(cte, cteIntegracao.ModalRodoviario.Veiculos, unidadeDeTrabalho);
                //this.CalcularImpostos(ref cte, cteIntegracao, unidadeDeTrabalho);

                //this.SetarPartilhaICMS(ref cte, unidadeDeTrabalho);

                repCTe.Atualizar(cte);

                return cte;
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro(ex);

                throw;
            }
        }

        public object GerarCTeXMLEnvio(System.IO.Stream xml, string chCTe, string nProt, string cStat, string tpAmb, string tipoVeiculo, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork = null, dynamic arquivo = null, bool retornaCTeJaInserido = false)
        {
            unitOfWork = unitOfWork ?? new Repositorio.UnitOfWork(StringConexao);

            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unitOfWork);

            Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCodigo(codigoEmpresa);

            arquivo = arquivo ?? MultiSoftware.CTe.Servicos.Leitura.LerXMLEnvio(xml);

            unitOfWork.Start();

            try
            {
                if (arquivo != null)
                {
                    Type tipoArquivo = arquivo.GetType();

                    if (tipoArquivo != typeof(MultiSoftware.CTe.v200.Envio.TEnviCTe))
                    {
                        unitOfWork.Rollback();
                        return "XML CTe não é do tipo enviCTe.";
                    }

                    return this.GerarCTeEnvio(empresa, (MultiSoftware.CTe.v200.Envio.TEnviCTe)arquivo, xml, chCTe, nProt, cStat, tpAmb, tipoVeiculo, unitOfWork);

                }

                unitOfWork.Rollback();
                return "O arquivo XML é inválido para a leitura.";
            }
            catch
            {
                unitOfWork.Rollback();
                throw;
            }
        }

        public object GerarCTeAnterior(System.IO.Stream xml, int codigoEmpresa, string expressaoRegularBooking, string expressaoRegularContainer, Repositorio.UnitOfWork unitOfWork = null, dynamic arquivo = null, bool retornaCTeJaInserido = false, bool importarOracle = true, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware = null, bool utilizarEmpresaDoCTe = false, Dominio.ObjetosDeValor.WebService.CTe.CTe dadosCTeInutilizado = null, string numeroControle = "")
        {
            if (unitOfWork == null)
                unitOfWork = new Repositorio.UnitOfWork(StringConexao);

            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unitOfWork);

            Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCodigo(codigoEmpresa);

            arquivo = arquivo ?? MultiSoftware.CTe.Servicos.Leitura.Ler(xml);

            unitOfWork.Start();

            try
            {
                if (arquivo != null)
                {
                    Type tipoArquivo = arquivo.GetType();

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporteProcessado.cteProc))
                        return this.GerarCTeAnterior(empresa, (MultiSoftware.CTe.v104.ConhecimentoDeTransporteProcessado.cteProc)arquivo, xml, unitOfWork, false, retornaCTeJaInserido, importarOracle, utilizarEmpresaDoCTe, numeroControle);

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporteProcessado.cteProc))
                        return this.GerarCTeAnterior(empresa, (MultiSoftware.CTe.v200.ConhecimentoDeTransporteProcessado.cteProc)arquivo, xml, unitOfWork, expressaoRegularBooking, expressaoRegularContainer, false, retornaCTeJaInserido, importarOracle, tipoServicoMultisoftware, utilizarEmpresaDoCTe, numeroControle);

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporteProcessado.cteProc))
                        return this.GerarCTeAnterior(empresa, (MultiSoftware.CTe.v300.ConhecimentoDeTransporteProcessado.cteProc)arquivo, xml, unitOfWork, expressaoRegularBooking, expressaoRegularContainer, false, retornaCTeJaInserido, importarOracle, tipoServicoMultisoftware, utilizarEmpresaDoCTe, false, numeroControle);

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporteProcessado.cteProc))
                        return this.GerarCTeAnterior(empresa, (MultiSoftware.CTe.v400.ConhecimentoDeTransporteProcessado.cteProc)arquivo, xml, unitOfWork, expressaoRegularBooking, expressaoRegularContainer, false, retornaCTeJaInserido, importarOracle, tipoServicoMultisoftware, utilizarEmpresaDoCTe, false, numeroControle);

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporteProcessado.cteSimpProc))
                        return this.GerarCTeAnterior(empresa, (MultiSoftware.CTe.v400.ConhecimentoDeTransporteProcessado.cteSimpProc)arquivo, xml, unitOfWork, expressaoRegularBooking, expressaoRegularContainer, false, retornaCTeJaInserido, importarOracle, tipoServicoMultisoftware, utilizarEmpresaDoCTe, false, numeroControle);

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporteProcessado.cteOSProc))
                        return this.GerarCTeAnterior(empresa, (MultiSoftware.CTe.v300.ConhecimentoDeTransporteProcessado.cteOSProc)arquivo, xml, unitOfWork, false, retornaCTeJaInserido, importarOracle, utilizarEmpresaDoCTe);

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporteProcessado.cteOSProc))
                        return this.GerarCTeAnterior(empresa, (MultiSoftware.CTe.v400.ConhecimentoDeTransporteProcessado.cteOSProc)arquivo, xml, unitOfWork, false, retornaCTeJaInserido, importarOracle, utilizarEmpresaDoCTe);

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporteCancelado.TProcCancCTe))
                        return this.GerarCTeAnteriorCancelado(empresa, (MultiSoftware.CTe.v104.ConhecimentoDeTransporteCancelado.TProcCancCTe)arquivo, unitOfWork, utilizarEmpresaDoCTe);

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v200.Eventos.TProcEvento))
                        return this.GerarCTeAnteriorEvento(empresa, (MultiSoftware.CTe.v200.Eventos.TProcEvento)arquivo, xml, unitOfWork, utilizarEmpresaDoCTe);

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v300.Eventos.TProcEvento))
                        return this.GerarCTeAnteriorEvento(empresa, (MultiSoftware.CTe.v300.Eventos.TProcEvento)arquivo, xml, unitOfWork, utilizarEmpresaDoCTe, importarOracle);

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v400.Eventos.TProcEvento))
                        return this.GerarCTeAnteriorEvento(empresa, (MultiSoftware.CTe.v400.Eventos.TProcEvento)arquivo, xml, unitOfWork, utilizarEmpresaDoCTe, importarOracle);

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporteInutilizado.TProcInutCTe))
                        return this.GerarCTeAnteriorInutilizado(empresa, (MultiSoftware.CTe.v104.ConhecimentoDeTransporteInutilizado.TProcInutCTe)arquivo, unitOfWork);

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporteInutilizado.TProcInutCTe))
                        return this.GerarCTeAnteriorInutilizado(empresa, (MultiSoftware.CTe.v200.ConhecimentoDeTransporteInutilizado.TProcInutCTe)arquivo, unitOfWork);

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporteInutilizado.TProcInutCTe))
                    {
                        if (dadosCTeInutilizado == null)
                            return this.GerarCTeAnteriorInutilizado(empresa, (MultiSoftware.CTe.v300.ConhecimentoDeTransporteInutilizado.TProcInutCTe)arquivo, unitOfWork);
                        else
                            return this.GerarCTeAnteriorInutilizado(xml, dadosCTeInutilizado, (MultiSoftware.CTe.v300.ConhecimentoDeTransporteInutilizado.TProcInutCTe)arquivo, unitOfWork);
                    }

                    unitOfWork.Rollback();
                    return "O arquivo XML é inválido para a leitura.";
                }
                else
                {
                    unitOfWork.Rollback();
                    return "O arquivo XML é inválido para a leitura.";
                }
            }
            catch
            {
                unitOfWork.Rollback();
                throw;
            }
        }

        public object GerarCTeAnteriorCIOT(System.IO.Stream xml, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork, dynamic arquivo = null)
        {
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unitOfWork);

            Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCodigo(codigoEmpresa);

            arquivo = arquivo ?? MultiSoftware.CTe.Servicos.Leitura.Ler(xml);

            //var arquivo = MultiSoftware.CTe.Servicos.Leitura.Ler(xml);

            unitOfWork.Start();

            try
            {
                if (arquivo != null)
                {
                    Type tipoArquivo = arquivo.GetType();

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporteProcessado.cteProc))
                        return this.GerarCTeAnterior(empresa, (MultiSoftware.CTe.v104.ConhecimentoDeTransporteProcessado.cteProc)arquivo, xml, unitOfWork, true);

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporteProcessado.cteProc))
                        return this.GerarCTeAnterior(empresa, (MultiSoftware.CTe.v200.ConhecimentoDeTransporteProcessado.cteProc)arquivo, xml, unitOfWork, "", "", true);

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporteCancelado.TProcCancCTe))
                        return "Não é possível importar um xml de cancelamento de CTe.";

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v200.Eventos.TProcEvento))
                        return "Não é possível importar um xml de evento de CTe.";

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporteInutilizado.TProcInutCTe))
                        return "Não é possível importar um xml de inutilização de CTe.";

                    if (tipoArquivo == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporteInutilizado.TProcInutCTe))
                        return "Não é possível importar um xml de inutilização de CTe.";
                }

                unitOfWork.Rollback();
                return "O arquivo XML é inválido para a leitura.";
            }
            catch
            {
                unitOfWork.Rollback();
                throw;
            }
        }

        public object GerarCTeAnteriorInutilizado(Stream xml, Dominio.ObjetosDeValor.WebService.CTe.CTe dadosCTeInutilizado, MultiSoftware.CTe.v300.ConhecimentoDeTransporteInutilizado.TProcInutCTe procInutCTe, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unitOfWork);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unitOfWork);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unitOfWork);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unitOfWork);
            Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unitOfWork);
            Repositorio.IntegracaoCTeRecebimento repIntegracaoCTeRecebimento = new Repositorio.IntegracaoCTeRecebimento(unitOfWork);

            Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCNPJ(procInutCTe.inutCTe.infInut.CNPJ);

            if (empresa == null)
                return $"A empresa {procInutCTe.inutCTe.infInut.CNPJ} não está cadastrada.";

            int numero = procInutCTe.inutCTe.infInut.nCTIni.ToInt();
            int serie = procInutCTe.inutCTe.infInut.serie.ToInt();
            string modelo = procInutCTe.inutCTe.infInut.mod.ToString("D");
            Dominio.Enumeradores.TipoAmbiente tipoAmbiente = (Dominio.Enumeradores.TipoAmbiente)procInutCTe.inutCTe.infInut.tpAmb;
            DateTime dataInutilizacao = procInutCTe.retInutCTe.infInut.dhRecbto;
            string protocoloInutilizacao = procInutCTe.retInutCTe.infInut.nProt;

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = repCTe.BuscarPorNumeroESerie(empresa.Codigo, numero, serie, modelo, tipoAmbiente);

            if (conhecimento != null)
            {
                if (conhecimento.Status != "I")
                    return $"Já existe um CT-e com o número {numero}, série {serie}, modelo {modelo} e ambiente {tipoAmbiente} para o CNPJ {empresa.CNPJ}, não sendo possível gerar o CT-e de inutilização.";
                else
                    return conhecimento;
            }

            unitOfWork.Start();

            conhecimento = new Dominio.Entidades.ConhecimentoDeTransporteEletronico
            {
                Empresa = empresa,
                TipoControle = 1,
                CFOP = this.ObterCFOP(dadosCTeInutilizado.CFOP, unitOfWork),
                ValorAReceber = dadosCTeInutilizado.ValorFrete?.ValorTotalAReceber ?? 0m,
                ValorPrestacaoServico = dadosCTeInutilizado.ValorFrete?.ValorPrestacaoServico ?? 0m,
                ValorFrete = dadosCTeInutilizado.ValorFrete?.ValorTotalAReceber ?? 0m,
                LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(dadosCTeInutilizado.LocalidadeInicioPrestacao?.IBGE ?? 0),
                LocalidadeEmissao = empresa.Localidade,
                LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(dadosCTeInutilizado.LocalidadeFimPrestacao?.IBGE ?? 0),
                ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false),
                TipoPagamento = Dominio.Enumeradores.TipoPagamento.Pago,
                ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo(modelo),
                Serie = this.ObterSerie(empresa, serie, unitOfWork),
                TipoImpressao = Dominio.Enumeradores.TipoImpressao.Retrato,
                TipoServico = dadosCTeInutilizado.TipoServico,
                TipoCTE = dadosCTeInutilizado.TipoCTE,
                TipoTomador = dadosCTeInutilizado.TipoTomador,
                Retira = Dominio.Enumeradores.OpcaoSimNao.Nao,
                DetalhesRetira = null,
                DataEmissao = dadosCTeInutilizado.DataEmissao.ToDateTime(),
                Numero = numero,
                Status = "I",
                Cancelado = "S",
                Chave = null,
                ProtocoloCancelamentoInutilizacao = protocoloInutilizacao,
                DataRetornoSefaz = dataInutilizacao,
                DataCancelamento = dataInutilizacao,
                ObservacaoCancelamento = procInutCTe.inutCTe.infInut.xJust,
                Versao = procInutCTe.retInutCTe.versao,
                MensagemRetornoSefaz = procInutCTe.retInutCTe.infInut.xMotivo,
                TipoAmbiente = tipoAmbiente,
                Log = string.Concat("CT-e importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".")
            };

            conhecimento.NaturezaDaOperacao = conhecimento.CFOP.NaturezaDaOperacao;

            repCTe.Inserir(conhecimento);

            Servicos.Cliente svcCliente = new Cliente();

            if (dadosCTeInutilizado.Remetente != null)
            {
                Dominio.ObjetosDeValor.RetornoVerificacaoCliente retorno = svcCliente.ConverterObjetoValorPessoa(dadosCTeInutilizado.Remetente, "remetente", unitOfWork, 0, false);

                if (retorno.Status)
                    conhecimento.SetarParticipante(retorno.cliente, Dominio.Enumeradores.TipoTomador.Remetente);
            }

            if (dadosCTeInutilizado.Expedidor != null)
            {
                Dominio.ObjetosDeValor.RetornoVerificacaoCliente retorno = svcCliente.ConverterObjetoValorPessoa(dadosCTeInutilizado.Expedidor, "expedidor", unitOfWork, 0, false);

                if (retorno.Status)
                    conhecimento.SetarParticipante(retorno.cliente, Dominio.Enumeradores.TipoTomador.Expedidor);
            }

            if (dadosCTeInutilizado.Recebedor != null)
            {
                Dominio.ObjetosDeValor.RetornoVerificacaoCliente retorno = svcCliente.ConverterObjetoValorPessoa(dadosCTeInutilizado.Expedidor, "recebedor", unitOfWork, 0, false);

                if (retorno.Status)
                    conhecimento.SetarParticipante(retorno.cliente, Dominio.Enumeradores.TipoTomador.Recebedor);
            }

            if (dadosCTeInutilizado.Destinatario != null)
            {
                Dominio.ObjetosDeValor.RetornoVerificacaoCliente retorno = svcCliente.ConverterObjetoValorPessoa(dadosCTeInutilizado.Destinatario, "destinatario", unitOfWork, 0, false);

                if (retorno.Status)
                    conhecimento.SetarParticipante(retorno.cliente, Dominio.Enumeradores.TipoTomador.Destinatario);
            }

            if (dadosCTeInutilizado.Tomador != null)
            {
                Dominio.ObjetosDeValor.RetornoVerificacaoCliente retorno = svcCliente.ConverterObjetoValorPessoa(dadosCTeInutilizado.Tomador, "tomador", unitOfWork, 0, false);

                if (retorno.Status)
                    conhecimento.SetarParticipante(retorno.cliente, Dominio.Enumeradores.TipoTomador.Outros);
            }

            SetarTomadorPagadorCTe(ref conhecimento);

            repCTe.Atualizar(conhecimento);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = repConfiguracaoTMS.BuscarConfiguracaoPadrao();
            bool armazenarEmArquivo = configuracaoTMS?.ArmazenarXMLCTeEmArquivo ?? false;

            Dominio.Entidades.XMLCTe xmlCTe = new Dominio.Entidades.XMLCTe
            {
                CTe = conhecimento,
                Tipo = Dominio.Enumeradores.TipoXMLCTe.Cancelamento
            };

            xml.Position = 0;

            if (!armazenarEmArquivo)
            {
                using (StreamReader reader = new StreamReader(xml))
                    xmlCTe.XML = reader.ReadToEnd();

                xmlCTe.XMLArmazenadoEmArquivo = false;
            }
            else
            {
                xmlCTe.XML = "";
                xmlCTe.XMLArmazenadoEmArquivo = true;

                string arquivo = CriarERetornarCaminhoXMLCTe(conhecimento, "I", unitOfWork);

                using (Stream fileXML = Utilidades.IO.FileStorageService.Storage.Create(arquivo))
                    xml.CopyTo(fileXML);
            }

            repXMLCTe.Inserir(xmlCTe);

            Dominio.Entidades.IntegracaoCTeRecebimento integracaoCTeRecebimento = new Dominio.Entidades.IntegracaoCTeRecebimento
            {
                CTe = conhecimento,
                Data = DateTime.Now,
                DataStatus = DateTime.Now,
                Status = Dominio.Enumeradores.StatusIntegracaoRecebimentoCTe.Pendente,
                Tipo = Dominio.Enumeradores.TipoIntegracaoEnvioCTe.Inutilizacao
            };

            repIntegracaoCTeRecebimento.Inserir(integracaoCTeRecebimento);

            unitOfWork.CommitChanges();

            return conhecimento;
        }

        public Dominio.Entidades.ConhecimentoDeTransporteEletronico GerarCTePorCTeIntegracao(Dominio.ObjetosDeValor.WebService.CTe.CTe cteIntegrado, Dominio.Entidades.Empresa empresa, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.CFOP repCFOP = new Repositorio.CFOP(unitOfWork);
            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unitOfWork);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unitOfWork);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unitOfWork);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);

            Servicos.Cliente svcCliente = new Cliente();

            Dominio.Entidades.ModeloDocumentoFiscal modeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo(cteIntegrado.Modelo);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = new Dominio.Entidades.ConhecimentoDeTransporteEletronico
            {
                Empresa = empresa,
                TipoControle = 1,
                CFOP = ObterCFOP(cteIntegrado.CFOP, unitOfWork),
                ValorAReceber = cteIntegrado.ValorFrete?.ValorTotalAReceber ?? 0m,
                ValorPrestacaoServico = cteIntegrado.ValorFrete?.ValorPrestacaoServico ?? 0m,
                ValorFrete = cteIntegrado.ValorFrete?.ValorTotalAReceber ?? 0m,
                LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(cteIntegrado.LocalidadeInicioPrestacao?.IBGE ?? 0),
                LocalidadeEmissao = empresa.Localidade,
                LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(cteIntegrado.LocalidadeFimPrestacao?.IBGE ?? 0),
                ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false),
                TipoPagamento = Dominio.Enumeradores.TipoPagamento.Pago,
                ModeloDocumentoFiscal = modeloDocumentoFiscal,
                Serie = ObterSerie(empresa, cteIntegrado.Serie, unitOfWork),
                TipoImpressao = Dominio.Enumeradores.TipoImpressao.Retrato,
                TipoServico = cteIntegrado.TipoServico,
                TipoCTE = cteIntegrado.TipoCTE,
                TipoTomador = cteIntegrado.TipoTomador,
                Retira = Dominio.Enumeradores.OpcaoSimNao.Nao,
                DetalhesRetira = null,
                DataEmissao = cteIntegrado.DataEmissao.ToDateTime(),
                Numero = cteIntegrado.Numero,
                Status = "E",
                Chave = cteIntegrado.Chave,
                NumeroControle = cteIntegrado.NumeroControle
            };

            if (cteIntegrado.Modelo != "57")
            {
                conhecimento.Status = "A";
                conhecimento.DataAutorizacao = DateTime.Now;
                conhecimento.Protocolo = "1234";
            }

            conhecimento.NaturezaDaOperacao = conhecimento.CFOP.NaturezaDaOperacao;

            repCTe.Inserir(conhecimento);

            if (cteIntegrado.Remetente != null)
            {
                Dominio.ObjetosDeValor.RetornoVerificacaoCliente retorno = svcCliente.ConverterObjetoValorPessoa(cteIntegrado.Remetente, "remetente", unitOfWork, 0, false);

                if (retorno.Status)
                    conhecimento.SetarParticipante(retorno.cliente, Dominio.Enumeradores.TipoTomador.Remetente);
            }

            if (cteIntegrado.Expedidor != null)
            {
                Dominio.ObjetosDeValor.RetornoVerificacaoCliente retorno = svcCliente.ConverterObjetoValorPessoa(cteIntegrado.Expedidor, "expedidor", unitOfWork, 0, false);

                if (retorno.Status)
                    conhecimento.SetarParticipante(retorno.cliente, Dominio.Enumeradores.TipoTomador.Expedidor);
            }

            if (cteIntegrado.Recebedor != null)
            {
                Dominio.ObjetosDeValor.RetornoVerificacaoCliente retorno = svcCliente.ConverterObjetoValorPessoa(cteIntegrado.Expedidor, "recebedor", unitOfWork, 0, false);

                if (retorno.Status)
                    conhecimento.SetarParticipante(retorno.cliente, Dominio.Enumeradores.TipoTomador.Recebedor);
            }

            if (cteIntegrado.Destinatario != null)
            {
                Dominio.ObjetosDeValor.RetornoVerificacaoCliente retorno = svcCliente.ConverterObjetoValorPessoa(cteIntegrado.Destinatario, "destinatario", unitOfWork, 0, false);

                if (retorno.Status)
                    conhecimento.SetarParticipante(retorno.cliente, Dominio.Enumeradores.TipoTomador.Destinatario);
            }

            if (cteIntegrado.Tomador != null)
            {
                Dominio.ObjetosDeValor.RetornoVerificacaoCliente retorno = svcCliente.ConverterObjetoValorPessoa(cteIntegrado.Tomador, "tomador", unitOfWork, 0, false);

                if (retorno.Status)
                    conhecimento.SetarParticipante(retorno.cliente, Dominio.Enumeradores.TipoTomador.Outros);
            }

            SetarTomadorPagadorCTe(ref conhecimento);

            repCTe.Atualizar(conhecimento);

            return conhecimento;
        }

        public object GerarCTeAnteriorInutilizado(Stream xml, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, MultiSoftware.CTe.v300.ConhecimentoDeTransporteInutilizado.TProcInutCTe procInutCTe, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unitOfWork);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unitOfWork);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unitOfWork);
            Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unitOfWork);
            Repositorio.IntegracaoCTeRecebimento repIntegracaoCTeRecebimento = new Repositorio.IntegracaoCTeRecebimento(unitOfWork);
            Repositorio.CFOP repCFOP = new Repositorio.CFOP(unitOfWork);
            Repositorio.DocumentosCTE repDocumentosCTe = new Repositorio.DocumentosCTE(unitOfWork);

            Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCNPJ(procInutCTe.inutCTe.infInut.CNPJ);

            if (empresa == null)
                return $"A empresa {procInutCTe.inutCTe.infInut.CNPJ} não está cadastrada.";

            int numero = procInutCTe.inutCTe.infInut.nCTIni.ToInt();
            int serie = procInutCTe.inutCTe.infInut.serie.ToInt();
            string modelo = procInutCTe.inutCTe.infInut.mod.ToString("D");
            Dominio.Enumeradores.TipoAmbiente tipoAmbiente = (Dominio.Enumeradores.TipoAmbiente)procInutCTe.inutCTe.infInut.tpAmb;
            DateTime dataInutilizacao = procInutCTe.retInutCTe.infInut.dhRecbto;
            string protocoloInutilizacao = procInutCTe.retInutCTe.infInut.nProt;

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = repCTe.BuscarPorNumeroESerie(empresa.Codigo, numero, serie, modelo, tipoAmbiente);

            if (conhecimento != null)
            {
                if (conhecimento.Status != "I")
                    return $"Já existe um CT-e com o número {numero}, série {serie}, modelo {modelo} e ambiente {tipoAmbiente} para o CNPJ {empresa.CNPJ}, não sendo possível gerar o CT-e de inutilização.";
                else
                    return conhecimento;
            }

            unitOfWork.Start();

            conhecimento = new Dominio.Entidades.ConhecimentoDeTransporteEletronico
            {
                Empresa = empresa,
                TipoControle = 1,
                CFOP = repCFOP.BuscarPrimeiroPorTipo(Dominio.Enumeradores.TipoCFOP.Saida),
                LocalidadeInicioPrestacao = cargaPedido.Origem,
                LocalidadeEmissao = empresa.Localidade,
                LocalidadeTerminoPrestacao = cargaPedido.Destino,
                ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false),
                TipoPagamento = Dominio.Enumeradores.TipoPagamento.Pago,
                ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo(modelo),
                Serie = this.ObterSerie(empresa, serie, unitOfWork),
                TipoImpressao = Dominio.Enumeradores.TipoImpressao.Retrato,
                TipoServico = Dominio.Enumeradores.TipoServico.Normal,
                TipoCTE = Dominio.Enumeradores.TipoCTE.Normal,
                TipoTomador = Dominio.Enumeradores.TipoTomador.Remetente,
                Retira = Dominio.Enumeradores.OpcaoSimNao.Nao,
                DetalhesRetira = null,
                DataEmissao = dataInutilizacao,
                Numero = numero,
                Status = "I",
                Cancelado = "S",
                Chave = null,
                ProtocoloCancelamentoInutilizacao = protocoloInutilizacao,
                DataRetornoSefaz = dataInutilizacao,
                DataCancelamento = dataInutilizacao,
                ObservacaoCancelamento = procInutCTe.inutCTe.infInut.xJust,
                Versao = procInutCTe.retInutCTe.versao,
                MensagemRetornoSefaz = procInutCTe.retInutCTe.infInut.xMotivo,
                TipoAmbiente = tipoAmbiente,
                Log = string.Concat("CT-e importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".")
            };

            conhecimento.NaturezaDaOperacao = conhecimento.CFOP.NaturezaDaOperacao;
            conhecimento.SetarParticipante(cargaPedido.Pedido.Remetente, Dominio.Enumeradores.TipoTomador.Remetente);
            conhecimento.SetarParticipante(cargaPedido.Pedido.Destinatario, Dominio.Enumeradores.TipoTomador.Destinatario);

            SetarTomadorPagadorCTe(ref conhecimento);

            repCTe.Inserir(conhecimento);

            Dominio.Entidades.DocumentosCTE documentosCTE = new Dominio.Entidades.DocumentosCTE()
            {
                Descricao = "1",
                Numero = "1",
                Peso = 1m,
                Valor = 1m,
                DataEmissao = dataInutilizacao,
                CTE = conhecimento,
                ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("99")
            };

            repDocumentosCTe.Inserir(documentosCTE);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = repConfiguracaoTMS.BuscarConfiguracaoPadrao();
            bool armazenarEmArquivo = configuracaoTMS?.ArmazenarXMLCTeEmArquivo ?? false;

            Dominio.Entidades.XMLCTe xmlCTe = new Dominio.Entidades.XMLCTe
            {
                CTe = conhecimento,
                Tipo = Dominio.Enumeradores.TipoXMLCTe.Autorizacao
            };

            xml.Position = 0;

            if (!armazenarEmArquivo)
            {
                using (StreamReader reader = new StreamReader(xml))
                    xmlCTe.XML = reader.ReadToEnd();

                xmlCTe.XMLArmazenadoEmArquivo = false;
            }
            else
            {
                xmlCTe.XML = "";
                xmlCTe.XMLArmazenadoEmArquivo = true;

                string arquivo = CriarERetornarCaminhoXMLCTe(conhecimento, "I", unitOfWork);

                using (Stream fileXML = Utilidades.IO.FileStorageService.Storage.Create(arquivo))
                    xml.CopyTo(fileXML);
            }

            repXMLCTe.Inserir(xmlCTe);

            Dominio.Entidades.IntegracaoCTeRecebimento integracaoCTeRecebimento = new Dominio.Entidades.IntegracaoCTeRecebimento
            {
                CTe = conhecimento,
                Data = DateTime.Now,
                DataStatus = DateTime.Now,
                Status = Dominio.Enumeradores.StatusIntegracaoRecebimentoCTe.Pendente,
                Tipo = Dominio.Enumeradores.TipoIntegracaoEnvioCTe.Inutilizacao
            };

            repIntegracaoCTeRecebimento.Inserir(integracaoCTeRecebimento);

            unitOfWork.CommitChanges();

            return conhecimento;
        }

        public string GerarChaveCTe(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte)
        {
            int.TryParse(cte.Numero.ToString() + "9", out int codigoCTe);

            StringBuilder chave = new StringBuilder();
            chave.Append(cte.Empresa.Localidade.Estado.CodigoIBGE);
            chave.Append(cte.DataEmissao.Value.ToString("yyMM"));
            chave.Append(Utilidades.String.OnlyNumbers(cte.Empresa.CNPJ));
            chave.Append(cte.ModeloDocumentoFiscal.Numero);
            chave.Append(string.Format("{0:000}", cte.Serie.Numero));
            chave.Append(string.Format("{0:000000000}", cte.Numero));
            chave.Append("1");
            chave.Append(string.Format("{0:00000000}", codigoCTe));
            chave.Append(Utilidades.Calc.Modulo11(chave.ToString()));
            return chave.ToString();
        }

        public Dominio.Entidades.ConhecimentoDeTransporteEletronico GerarCTePorNFe(MultiSoftware.NFe.NotaFiscalProcessada.TNfeProc notaFiscal, int codigoEmpresa, decimal valorFrete = 0, decimal valorTotalMercadoria = 0, string observacao = "", bool gerarLog = false, Dominio.Entidades.Usuario usuario = null, Repositorio.UnitOfWork unitOfWork = null, bool emitirCTe = true)
        {
            Repositorio.UnitOfWork unidadeDeTrabalho = unitOfWork ?? new Repositorio.UnitOfWork(StringConexao);

            try
            {
                NFe servicoNFe = new NFe(unidadeDeTrabalho);
                Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeDeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
                Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);
                Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeDeTrabalho);
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);
                Repositorio.EstadosDeEmissaoSerie repEstadosDeEmissaoSerie = new Repositorio.EstadosDeEmissaoSerie(unidadeDeTrabalho);
                Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeDeTrabalho);

                Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCodigo(codigoEmpresa);
                Dominio.Entidades.Cliente clienteRemetente = null;
                Dominio.Entidades.Cliente clienteDestinatario = null;

                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                if (unitOfWork == null)
                    unidadeDeTrabalho.Start();

                Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();

                cte.Empresa = empresa;

                clienteRemetente = servicoNFe.ObterEmitente(notaFiscal.NFe.infNFe.emit, codigoEmpresa);
                cte.SetarParticipante(clienteRemetente, Dominio.Enumeradores.TipoTomador.Remetente, null, repDadosCliente.Buscar(codigoEmpresa, clienteRemetente.CPF_CNPJ));

                clienteDestinatario = servicoNFe.ObterDestinatario(notaFiscal.NFe.infNFe.dest, codigoEmpresa);
                cte.SetarParticipante(clienteDestinatario, Dominio.Enumeradores.TipoTomador.Destinatario, null, repDadosCliente.Buscar(codigoEmpresa, clienteDestinatario.CPF_CNPJ));

                cte.LocalidadeEmissao = cte.Empresa.Localidade;

                cte.LocalidadeInicioPrestacao = cte.Remetente.Localidade;

                cte.LocalidadeTerminoPrestacao = cte.Destinatario.Localidade;

                cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Nao;

                cte.TipoPagamento = servicoNFe.ObterFormaPagamento(notaFiscal.NFe.infNFe.transp);

                cte.TipoTomador = servicoNFe.ObterTipoTomador(notaFiscal.NFe.infNFe.transp);

                cte.ValorFrete = valorFrete > 0 ? valorFrete : decimal.Parse(notaFiscal.NFe.infNFe.total.ICMSTot.vFrete, cultura);

                cte.ValorPrestacaoServico = cte.ValorFrete;

                cte.ValorAReceber = cte.ValorFrete;

                cte.ValorTotalMercadoria = valorTotalMercadoria > 0 ? valorTotalMercadoria : decimal.Parse(notaFiscal.NFe.infNFe.total.ICMSTot.vNF, cultura);

                cte.ProdutoPredominante = cte.Empresa.Configuracao.ProdutoPredominante;
                cte.OutrasCaracteristicasDaCarga = cte.Empresa.Configuracao.OutrasCaracteristicas;

                cte.ExibeICMSNaDACTE = true;

                if (cte.Empresa.Localidade.Estado.Sigla != cte.LocalidadeInicioPrestacao.Estado.Sigla)
                    cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Nao;
                else
                    cte.SimplesNacional = cte.Empresa.OptanteSimplesNacional ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao;

                if (empresa.Configuracao.ICMSIsento)
                {
                    cte.CST = "40";
                    this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);
                    this.CalcularICMS(ref cte, unidadeDeTrabalho);
                }
                else
                {
                    this.CalcularICMSPorTabelaDeAliquotas(ref cte, cte.SimplesNacional, unidadeDeTrabalho);
                }

                cte.Retira = Dominio.Enumeradores.OpcaoSimNao.Nao;

                cte.RNTRC = cte.Empresa.RegistroANTT;

                cte.DataPrevistaEntrega = DateTime.Now.AddDays(cte.Empresa.Configuracao.DiasParaEntrega);

                cte.TipoAmbiente = empresa.TipoAmbiente;

                cte.TipoCTE = Dominio.Enumeradores.TipoCTE.Normal;

                cte.TipoEmissao = "1";

                cte.TipoEnvio = 0;

                cte.TipoImpressao = cte.Empresa.Configuracao.TipoImpressao;

                cte.TipoServico = Dominio.Enumeradores.TipoServico.Normal;

                cte.DataEmissao = DateTime.Now;

                //cte.ModalTransporte = repModalTransporte.BuscarPorNumero((int)cteIntegracao.TipoModal > 0 ? cteIntegracao.TipoModal.ToString("D") : "1");
                cte.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);

                cte.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("57");

                cte.Lotacao = Dominio.Enumeradores.OpcaoSimNao.Nao;

                cte.Serie = this.ObterSerie(empresa, cte.LocalidadeEmissao.Estado.Sigla, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, cte.Remetente?.CPF_CNPJ ?? string.Empty, cte.Destinatario?.CPF_CNPJ ?? string.Empty, cte.Recebedor?.CPF_CNPJ ?? string.Empty, cte.Expedidor?.CPF_CNPJ ?? string.Empty, cte.TomadorPagador?.CPF_CNPJ ?? string.Empty, unidadeDeTrabalho, null);

                cte.Versao = cte.Empresa.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.Configuracao.VersaoCTe) ? cte.Empresa.Configuracao.VersaoCTe : cte.Empresa.EmpresaPai.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.EmpresaPai.Configuracao.VersaoCTe) ? cte.Empresa.EmpresaPai.Configuracao.VersaoCTe : "4.00"; //cte.Empresa.Versao;

                cte.ObservacoesGerais = observacao;

                repCTe.Inserir(cte);

                SetarTomadorPagadorCTe(ref cte);

                this.SalvarInformacoesDeSeguroDaCarga(cte, cte.Empresa.Configuracao.ResponsavelSeguro, unidadeDeTrabalho);

                this.SalvarInformacoesComponentesDaPrestacao(cte, "FRETE VALOR", cte.ValorFrete, false, true, unidadeDeTrabalho);

                this.SalvarInformacoesDeQuantidadeDaCarga(cte, notaFiscal.NFe.infNFe.transp.vol, unidadeDeTrabalho);

                this.SalvarInformacoesNFes(cte, notaFiscal, unidadeDeTrabalho);

                if (notaFiscal.NFe.infNFe.transp != null && notaFiscal.NFe.infNFe.transp.Items != null)
                    this.SalvarInformacoesVeiculos(cte, (from obj in notaFiscal.NFe.infNFe.transp.Items where obj.GetType() == typeof(MultiSoftware.NFe.NotaFiscal.TVeiculo) select (MultiSoftware.NFe.NotaFiscal.TVeiculo)obj).ToList(), unidadeDeTrabalho);

                if (emitirCTe)
                    cte.Status = "E";
                else
                    cte.Status = "S";

                cte.Cancelado = "N";

                cte.Numero = ObterProximoNumero(cte, repCTe);

                if (gerarLog && usuario != null)
                    cte.Log = string.Concat("Criado por ", usuario.CPF, " - ", usuario.Nome, " em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");
                else if (gerarLog)
                    cte.Log = string.Concat("CTe salvo automaticamente em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");

                this.SetarPartilhaICMS(ref cte, unidadeDeTrabalho);

                repCTe.Atualizar(cte);

                if (unitOfWork == null)
                    unidadeDeTrabalho.CommitChanges();

                return cte;
            }
            catch
            {
                if (unitOfWork == null && unidadeDeTrabalho != null)
                    unidadeDeTrabalho.Rollback();

                throw;
            }
        }

        public Dominio.Entidades.ConhecimentoDeTransporteEletronico GerarCTePorNFe(MultiSoftware.NFe.v310.NotaFiscalProcessada.TNfeProc notaFiscal, int codigoEmpresa, decimal valorFrete = 0, decimal valorTotalMercadoria = 0, string observacao = "", bool gerarLog = false, Dominio.Entidades.Usuario usuario = null, Repositorio.UnitOfWork unitOfWork = null, bool emitirCTe = true, bool destinoDiversos = false, Dominio.Enumeradores.TipoPagamento? tipoPagamento = null, Dominio.Enumeradores.TipoTomador? tomador = null)
        {
            Repositorio.UnitOfWork unidadeDeTrabalho = unitOfWork ?? new Repositorio.UnitOfWork(StringConexao);

            try
            {
                NFe servicoNFe = new NFe(unidadeDeTrabalho);
                Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeDeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
                Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);
                Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeDeTrabalho);
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);
                Repositorio.Atividade repAtividade = new Repositorio.Atividade(unidadeDeTrabalho);
                Repositorio.ApoliceDeSeguro repApoliceDeSeguro = new Repositorio.ApoliceDeSeguro(unidadeDeTrabalho);
                Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeDeTrabalho);

                Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCodigo(codigoEmpresa);
                Dominio.Entidades.Cliente clienteRemetente = null;
                Dominio.Entidades.Cliente clienteDestinatario = null;

                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                if (unitOfWork == null)
                    unidadeDeTrabalho.Start();

                Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();

                cte.Empresa = empresa;

                clienteRemetente = servicoNFe.ObterEmitente(notaFiscal.NFe.infNFe.emit, codigoEmpresa);
                cte.SetarParticipante(clienteRemetente, Dominio.Enumeradores.TipoTomador.Remetente, null, repDadosCliente.Buscar(codigoEmpresa, clienteRemetente.CPF_CNPJ));

                if (destinoDiversos)
                {
                    cte.IndicadorGlobalizado = Dominio.Enumeradores.OpcaoSimNao.Sim;
                    cte.SetarDestinatarioDiversos(empresa, repAtividade.BuscarPorCodigo(4));
                }
                else
                {
                    clienteDestinatario = servicoNFe.ObterDestinatario(notaFiscal.NFe.infNFe.dest, codigoEmpresa);
                    cte.SetarParticipante(clienteDestinatario, Dominio.Enumeradores.TipoTomador.Destinatario, null, repDadosCliente.Buscar(codigoEmpresa, clienteDestinatario.CPF_CNPJ));
                }

                cte.LocalidadeEmissao = cte.Empresa.Localidade;

                cte.LocalidadeInicioPrestacao = cte.Remetente.Localidade;

                cte.LocalidadeTerminoPrestacao = cte.Destinatario.Localidade;

                if (tipoPagamento == null)
                    cte.TipoPagamento = servicoNFe.ObterFormaPagamento(notaFiscal.NFe.infNFe.transp);
                else
                    cte.TipoPagamento = tipoPagamento == Dominio.Enumeradores.TipoPagamento.Pago ? Dominio.Enumeradores.TipoPagamento.Pago :
                                        tipoPagamento == Dominio.Enumeradores.TipoPagamento.A_Pagar ? Dominio.Enumeradores.TipoPagamento.A_Pagar :
                                        tipoPagamento == Dominio.Enumeradores.TipoPagamento.Outros ? Dominio.Enumeradores.TipoPagamento.Outros :
                                        servicoNFe.ObterFormaPagamento(notaFiscal.NFe.infNFe.transp);

                if (tomador == null)
                    cte.TipoTomador = servicoNFe.ObterTipoTomador(notaFiscal.NFe.infNFe.transp);
                else
                    cte.TipoTomador = tomador == Dominio.Enumeradores.TipoTomador.Remetente ? Dominio.Enumeradores.TipoTomador.Remetente :
                                      tomador == Dominio.Enumeradores.TipoTomador.Destinatario ? Dominio.Enumeradores.TipoTomador.Destinatario :
                                      tomador == Dominio.Enumeradores.TipoTomador.Outros ? Dominio.Enumeradores.TipoTomador.Outros :
                                      tomador == Dominio.Enumeradores.TipoTomador.Expedidor ? Dominio.Enumeradores.TipoTomador.Expedidor :
                                      tomador == Dominio.Enumeradores.TipoTomador.Recebedor ? Dominio.Enumeradores.TipoTomador.Recebedor : servicoNFe.ObterTipoTomador(notaFiscal.NFe.infNFe.transp);

                cte.ValorFrete = valorFrete > 0 ? valorFrete : decimal.Parse(notaFiscal.NFe.infNFe.total.ICMSTot.vFrete, cultura);

                cte.ValorPrestacaoServico = cte.ValorFrete;

                cte.ValorAReceber = cte.ValorFrete;

                cte.ValorTotalMercadoria = valorTotalMercadoria > 0 ? valorTotalMercadoria : decimal.Parse(notaFiscal.NFe.infNFe.total.ICMSTot.vNF, cultura);

                if (cte.Empresa.Configuracao != null)
                {
                    cte.ProdutoPredominante = cte.Empresa.Configuracao.ProdutoPredominante;
                    cte.OutrasCaracteristicasDaCarga = cte.Empresa.Configuracao.OutrasCaracteristicas;
                }
                else
                    cte.ProdutoPredominante = "DIVERSOS";

                cte.Retira = Dominio.Enumeradores.OpcaoSimNao.Nao;

                cte.RNTRC = cte.Empresa.RegistroANTT;

                if (cte.Empresa.Configuracao != null)
                    cte.DataPrevistaEntrega = DateTime.Now.AddDays(cte.Empresa.Configuracao.DiasParaEntrega);
                else
                    cte.DataPrevistaEntrega = DateTime.Now.AddDays(1);

                cte.TipoAmbiente = empresa.TipoAmbiente;

                cte.TipoCTE = Dominio.Enumeradores.TipoCTE.Normal;

                cte.TipoEmissao = "1";

                cte.TipoEnvio = 0;

                if (cte.Empresa.Configuracao != null)
                    cte.TipoImpressao = cte.Empresa.Configuracao.TipoImpressao;
                else
                    cte.TipoImpressao = Dominio.Enumeradores.TipoImpressao.Retrato;

                cte.TipoServico = Dominio.Enumeradores.TipoServico.Normal;

                cte.DataEmissao = DateTime.Now;

                //cte.ModalTransporte = repModalTransporte.BuscarPorNumero((int)cteIntegracao.TipoModal > 0 ? cteIntegracao.TipoModal.ToString("D") : "1");
                cte.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);

                cte.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("57");

                cte.Lotacao = Dominio.Enumeradores.OpcaoSimNao.Nao;

                cte.Serie = this.ObterSerie(empresa, cte.LocalidadeEmissao.Estado.Sigla, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, cte.Remetente?.CPF_CNPJ ?? string.Empty, cte.Destinatario?.CPF_CNPJ ?? string.Empty, cte.Recebedor?.CPF_CNPJ ?? string.Empty, cte.Expedidor?.CPF_CNPJ ?? string.Empty, cte.TomadorPagador?.CPF_CNPJ ?? string.Empty, unidadeDeTrabalho);

                cte.Versao = cte.Empresa.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.Configuracao.VersaoCTe) ? cte.Empresa.Configuracao.VersaoCTe : cte.Empresa.EmpresaPai.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.EmpresaPai.Configuracao.VersaoCTe) ? cte.Empresa.EmpresaPai.Configuracao.VersaoCTe : "4.00"; //cte.Empresa.Versao;

                cte.ObservacoesGerais = observacao;

                cte.Status = "S";

                cte.Cancelado = "N";

                cte.Numero = ObterProximoNumero(cte, repCTe);

                this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);

                repCTe.Inserir(cte);

                double cnpjRemetente;
                double.TryParse(cte.Remetente.CPF_CNPJ, out cnpjRemetente);
                List<Dominio.Entidades.ApoliceDeSeguro> listaApoliceSeguroCliente = repApoliceDeSeguro.BuscarPorCliente(cte.Empresa.Codigo, cte.Empresa.EmpresaPai.Codigo, cnpjRemetente);

                if (listaApoliceSeguroCliente.Count > 0)
                {
                    string apolice = listaApoliceSeguroCliente[0].NumeroApolice;
                    if (listaApoliceSeguroCliente[0].NomeSeguradora == "Starr Companies")
                        apolice = String.Format(@"{0:0000\.0000\.00\.0000\.00000}", long.Parse(listaApoliceSeguroCliente[0].NumeroApolice));


                    Dominio.Enumeradores.TipoSeguro respSeguro = listaApoliceSeguroCliente.FirstOrDefault().Responsavel == 0 ? Dominio.Enumeradores.TipoSeguro.Remetente :
                                                                 listaApoliceSeguroCliente.FirstOrDefault().Responsavel == 1 ? Dominio.Enumeradores.TipoSeguro.Expedidor :
                                                                 listaApoliceSeguroCliente.FirstOrDefault().Responsavel == 2 ? Dominio.Enumeradores.TipoSeguro.Recebedor :
                                                                 listaApoliceSeguroCliente.FirstOrDefault().Responsavel == 3 ? Dominio.Enumeradores.TipoSeguro.Destinatario :
                                                                 listaApoliceSeguroCliente.FirstOrDefault().Responsavel == 4 ? Dominio.Enumeradores.TipoSeguro.Emitente_CTE :
                                                                 listaApoliceSeguroCliente.FirstOrDefault().Responsavel == 5 ? Dominio.Enumeradores.TipoSeguro.Tomador_Servico :
                                                                 Dominio.Enumeradores.TipoSeguro.Emitente_CTE;

                    this.SalvarInformacoesDeSeguroDaCarga(cte, respSeguro, unidadeDeTrabalho, listaApoliceSeguroCliente.FirstOrDefault());
                    cte.ObservacoesGerais = string.Concat("Seguradora ", listaApoliceSeguroCliente[0].NomeSeguradora,
                                                          " Apólice ", apolice,
                                                          " Vigência ", listaApoliceSeguroCliente[0].DataInicioVigencia?.ToString("dd/MM/yyyy"), " à ", listaApoliceSeguroCliente[0].DataFimVigencia?.ToString("dd/MM/yyyy"),
                                                          ". " + cte.ObservacoesGerais);
                }
                else if (cte.Empresa.Configuracao != null)
                    this.SalvarInformacoesDeSeguroDaCarga(cte, cte.Empresa.Configuracao.ResponsavelSeguro, unidadeDeTrabalho);
                else
                    this.SalvarInformacoesDeSeguroDaCarga(cte, Dominio.Enumeradores.TipoSeguro.Remetente, unidadeDeTrabalho);

                this.SalvarInformacoesComponentesDaPrestacao(cte, "FRETE VALOR", cte.ValorFrete, false, true, unidadeDeTrabalho);

                this.SalvarInformacoesDeQuantidadeDaCarga(cte, notaFiscal.NFe.infNFe.transp.vol, unidadeDeTrabalho);

                this.SalvarInformacoesNFes(cte, notaFiscal, unidadeDeTrabalho);

                if (notaFiscal.NFe.infNFe.transp != null && notaFiscal.NFe.infNFe.transp.Items != null)
                    this.SalvarInformacoesVeiculos(ref cte, (from obj in notaFiscal.NFe.infNFe.transp.Items where obj.GetType() == typeof(MultiSoftware.NFe.v310.NotaFiscal.TVeiculo) select (MultiSoftware.NFe.v310.NotaFiscal.TVeiculo)obj).ToList(), unidadeDeTrabalho);

                cte.ExibeICMSNaDACTE = true;

                cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Nao;

                if (cte.Empresa.Localidade.Estado.Sigla != cte.LocalidadeInicioPrestacao.Estado.Sigla)
                    cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Nao;
                else
                    cte.SimplesNacional = cte.Empresa.OptanteSimplesNacional ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao;

                if (cte.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && empresa.Configuracao != null)
                {
                    cte.IncluirICMSNoFrete = empresa.Configuracao.IncluirICMSNoFrete;
                    if (cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim)
                        cte.PercentualICMSIncluirNoFrete = 100;
                }

                if (cte.Empresa.Configuracao != null && empresa.Configuracao.ICMSIsento)
                {
                    cte.CST = "40";
                    cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Nao;
                    this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);
                    this.CalcularICMS(ref cte, unidadeDeTrabalho);
                }
                else
                {
                    this.CalcularICMSPorTabelaDeAliquotas(ref cte, cte.SimplesNacional, unidadeDeTrabalho);
                }

                if (gerarLog && usuario != null)
                    cte.Log = string.Concat("Criado por ", usuario.CPF, " - ", usuario.Nome, " em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");
                else if (gerarLog)
                    cte.Log = string.Concat("CTe salvo automaticamente em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");

                this.SetarPartilhaICMS(ref cte, unidadeDeTrabalho);

                if (emitirCTe)
                    cte.Status = "E";
                else
                    cte.Status = "S";

                SetarTomadorPagadorCTe(ref cte);

                if (string.IsNullOrWhiteSpace(cte.ObservacoesAvancadas))//Quando esta alterando, se já possui observação não muda para não dar erro de Digest value
                {
                    if (!this.SetarObservacoesVeiculo(ref cte, unidadeDeTrabalho))
                        this.SetarObservacoesAvancadas(ref cte, unidadeDeTrabalho);

                    if (cte.ModeloDocumentoFiscal.Numero == "57")
                        this.SetarObservacaoAvancadaPorRegraICMS(ref cte, unidadeDeTrabalho);

                    this.SetarXCampoVeiculo(cte, unidadeDeTrabalho);
                    this.AdicionarResponsavelSeguroObsContribuinte(cte, unidadeDeTrabalho);
                }

                repCTe.Atualizar(cte);

                if (unitOfWork == null)
                    unidadeDeTrabalho.CommitChanges();

                return cte;
            }
            catch
            {
                if (unitOfWork == null && unidadeDeTrabalho != null)
                    unidadeDeTrabalho.Rollback();

                throw;
            }
        }

        public Dominio.Entidades.ConhecimentoDeTransporteEletronico GerarCTePorNFe(MultiSoftware.NFe.v400.NotaFiscalProcessada.TNfeProc notaFiscal, int codigoEmpresa, decimal valorFrete = 0, decimal valorTotalMercadoria = 0, string observacao = "", bool gerarLog = false, Dominio.Entidades.Usuario usuario = null, Repositorio.UnitOfWork unitOfWork = null, bool emitirCTe = true, bool destinoDiversos = false, Dominio.Enumeradores.TipoPagamento? tipoPagamento = null, Dominio.Enumeradores.TipoTomador? tomador = null)
        {
            Repositorio.UnitOfWork unidadeDeTrabalho = unitOfWork ?? new Repositorio.UnitOfWork(StringConexao);

            try
            {
                NFe servicoNFe = new NFe(unidadeDeTrabalho);
                Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeDeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
                Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);
                Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeDeTrabalho);
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);
                Repositorio.Atividade repAtividade = new Repositorio.Atividade(unidadeDeTrabalho);
                Repositorio.ApoliceDeSeguro repApoliceDeSeguro = new Repositorio.ApoliceDeSeguro(unidadeDeTrabalho);
                Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeDeTrabalho);

                Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCodigo(codigoEmpresa);
                Dominio.Entidades.Cliente clienteRemetente = null;
                Dominio.Entidades.Cliente clienteDestinatario = null;

                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                if (unitOfWork == null)
                    unidadeDeTrabalho.Start();

                Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();

                cte.Empresa = empresa;

                clienteRemetente = servicoNFe.ObterEmitente(notaFiscal.NFe.infNFe.emit, codigoEmpresa);
                cte.SetarParticipante(clienteRemetente, Dominio.Enumeradores.TipoTomador.Remetente, null, repDadosCliente.Buscar(codigoEmpresa, clienteRemetente.CPF_CNPJ));

                if (destinoDiversos)
                {
                    cte.IndicadorGlobalizado = Dominio.Enumeradores.OpcaoSimNao.Sim;
                    cte.SetarDestinatarioDiversos(empresa, repAtividade.BuscarPorCodigo(4));
                }
                else
                {
                    clienteDestinatario = servicoNFe.ObterDestinatario(notaFiscal.NFe.infNFe.dest, codigoEmpresa);
                    cte.SetarParticipante(clienteDestinatario, Dominio.Enumeradores.TipoTomador.Destinatario, null, repDadosCliente.Buscar(codigoEmpresa, clienteDestinatario.CPF_CNPJ));
                }

                cte.LocalidadeEmissao = cte.Empresa.Localidade;

                cte.LocalidadeInicioPrestacao = cte.Remetente.Localidade;

                cte.LocalidadeTerminoPrestacao = cte.Destinatario.Localidade;

                if (tipoPagamento == null)
                    cte.TipoPagamento = servicoNFe.ObterFormaPagamento(notaFiscal.NFe.infNFe.transp);
                else
                    cte.TipoPagamento = tipoPagamento == Dominio.Enumeradores.TipoPagamento.Pago ? Dominio.Enumeradores.TipoPagamento.Pago :
                                        tipoPagamento == Dominio.Enumeradores.TipoPagamento.A_Pagar ? Dominio.Enumeradores.TipoPagamento.A_Pagar :
                                        tipoPagamento == Dominio.Enumeradores.TipoPagamento.Outros ? Dominio.Enumeradores.TipoPagamento.Outros :
                                        servicoNFe.ObterFormaPagamento(notaFiscal.NFe.infNFe.transp);

                if (tomador == null)
                    cte.TipoTomador = servicoNFe.ObterTipoTomador(notaFiscal.NFe.infNFe.transp);
                else
                    cte.TipoTomador = tomador == Dominio.Enumeradores.TipoTomador.Remetente ? Dominio.Enumeradores.TipoTomador.Remetente :
                                      tomador == Dominio.Enumeradores.TipoTomador.Destinatario ? Dominio.Enumeradores.TipoTomador.Destinatario :
                                      tomador == Dominio.Enumeradores.TipoTomador.Outros ? Dominio.Enumeradores.TipoTomador.Outros :
                                      tomador == Dominio.Enumeradores.TipoTomador.Expedidor ? Dominio.Enumeradores.TipoTomador.Expedidor :
                                      tomador == Dominio.Enumeradores.TipoTomador.Recebedor ? Dominio.Enumeradores.TipoTomador.Recebedor : servicoNFe.ObterTipoTomador(notaFiscal.NFe.infNFe.transp);

                cte.ValorFrete = valorFrete > 0 ? valorFrete : decimal.Parse(notaFiscal.NFe.infNFe.total.ICMSTot.vFrete, cultura);

                cte.ValorPrestacaoServico = cte.ValorFrete;

                cte.ValorAReceber = cte.ValorFrete;

                cte.ValorTotalMercadoria = valorTotalMercadoria > 0 ? valorTotalMercadoria : decimal.Parse(notaFiscal.NFe.infNFe.total.ICMSTot.vNF, cultura);

                if (cte.Empresa.Configuracao != null)
                {
                    cte.ProdutoPredominante = cte.Empresa.Configuracao.ProdutoPredominante;
                    cte.OutrasCaracteristicasDaCarga = cte.Empresa.Configuracao.OutrasCaracteristicas;
                }
                else
                    cte.ProdutoPredominante = "DIVERSOS";

                cte.Retira = Dominio.Enumeradores.OpcaoSimNao.Nao;

                cte.RNTRC = cte.Empresa.RegistroANTT;

                if (cte.Empresa.Configuracao != null)
                    cte.DataPrevistaEntrega = DateTime.Now.AddDays(cte.Empresa.Configuracao.DiasParaEntrega);
                else
                    cte.DataPrevistaEntrega = DateTime.Now.AddDays(1);

                cte.TipoAmbiente = empresa.TipoAmbiente;

                cte.TipoCTE = Dominio.Enumeradores.TipoCTE.Normal;

                cte.TipoEmissao = "1";

                cte.TipoEnvio = 0;

                if (cte.Empresa.Configuracao != null)
                    cte.TipoImpressao = cte.Empresa.Configuracao.TipoImpressao;
                else
                    cte.TipoImpressao = Dominio.Enumeradores.TipoImpressao.Retrato;

                cte.TipoServico = Dominio.Enumeradores.TipoServico.Normal;

                cte.DataEmissao = DateTime.Now;

                //cte.ModalTransporte = repModalTransporte.BuscarPorNumero((int)cteIntegracao.TipoModal > 0 ? cteIntegracao.TipoModal.ToString("D") : "1");
                cte.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);

                cte.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("57");

                cte.Lotacao = Dominio.Enumeradores.OpcaoSimNao.Nao;

                cte.Serie = this.ObterSerie(empresa, cte.LocalidadeEmissao.Estado.Sigla, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, cte.Remetente?.CPF_CNPJ ?? string.Empty, cte.Destinatario?.CPF_CNPJ ?? string.Empty, cte.Recebedor?.CPF_CNPJ ?? string.Empty, cte.Expedidor?.CPF_CNPJ ?? string.Empty, cte.TomadorPagador?.CPF_CNPJ ?? string.Empty, unidadeDeTrabalho);

                cte.Versao = cte.Empresa.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.Configuracao.VersaoCTe) ? cte.Empresa.Configuracao.VersaoCTe : cte.Empresa.EmpresaPai.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.EmpresaPai.Configuracao.VersaoCTe) ? cte.Empresa.EmpresaPai.Configuracao.VersaoCTe : "4.00"; //cte.Empresa.Versao;

                cte.ObservacoesGerais = observacao;

                cte.Status = "S";

                cte.Cancelado = "N";

                cte.Numero = ObterProximoNumero(cte, repCTe);

                this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);

                repCTe.Inserir(cte);

                double cnpjRemetente;
                double.TryParse(cte.Remetente.CPF_CNPJ, out cnpjRemetente);
                List<Dominio.Entidades.ApoliceDeSeguro> listaApoliceSeguroCliente = repApoliceDeSeguro.BuscarPorCliente(cte.Empresa.Codigo, cte.Empresa.EmpresaPai.Codigo, cnpjRemetente);

                if (listaApoliceSeguroCliente.Count > 0)
                {
                    string apolice = listaApoliceSeguroCliente[0].NumeroApolice;
                    if (listaApoliceSeguroCliente[0].NomeSeguradora == "Starr Companies")
                        apolice = String.Format(@"{0:0000\.0000\.00\.0000\.00000}", long.Parse(listaApoliceSeguroCliente[0].NumeroApolice));


                    Dominio.Enumeradores.TipoSeguro respSeguro = listaApoliceSeguroCliente.FirstOrDefault().Responsavel == 0 ? Dominio.Enumeradores.TipoSeguro.Remetente :
                                                                 listaApoliceSeguroCliente.FirstOrDefault().Responsavel == 1 ? Dominio.Enumeradores.TipoSeguro.Expedidor :
                                                                 listaApoliceSeguroCliente.FirstOrDefault().Responsavel == 2 ? Dominio.Enumeradores.TipoSeguro.Recebedor :
                                                                 listaApoliceSeguroCliente.FirstOrDefault().Responsavel == 3 ? Dominio.Enumeradores.TipoSeguro.Destinatario :
                                                                 listaApoliceSeguroCliente.FirstOrDefault().Responsavel == 4 ? Dominio.Enumeradores.TipoSeguro.Emitente_CTE :
                                                                 listaApoliceSeguroCliente.FirstOrDefault().Responsavel == 5 ? Dominio.Enumeradores.TipoSeguro.Tomador_Servico :
                                                                 Dominio.Enumeradores.TipoSeguro.Emitente_CTE;

                    this.SalvarInformacoesDeSeguroDaCarga(cte, respSeguro, unidadeDeTrabalho, listaApoliceSeguroCliente.FirstOrDefault());
                    cte.ObservacoesGerais = string.Concat("Seguradora ", listaApoliceSeguroCliente[0].NomeSeguradora,
                                                          " Apólice ", apolice,
                                                          " Vigência ", listaApoliceSeguroCliente[0].DataInicioVigencia?.ToString("dd/MM/yyyy"), " à ", listaApoliceSeguroCliente[0].DataFimVigencia?.ToString("dd/MM/yyyy"),
                                                          ". " + cte.ObservacoesGerais);
                }
                else if (cte.Empresa.Configuracao != null)
                    this.SalvarInformacoesDeSeguroDaCarga(cte, cte.Empresa.Configuracao.ResponsavelSeguro, unidadeDeTrabalho);
                else
                    this.SalvarInformacoesDeSeguroDaCarga(cte, Dominio.Enumeradores.TipoSeguro.Remetente, unidadeDeTrabalho);

                this.SalvarInformacoesComponentesDaPrestacao(cte, "FRETE VALOR", cte.ValorFrete, false, true, unidadeDeTrabalho);

                this.SalvarInformacoesDeQuantidadeDaCarga(cte, notaFiscal.NFe.infNFe.transp.vol, unidadeDeTrabalho);

                this.SalvarInformacoesNFes(cte, notaFiscal, unidadeDeTrabalho);

                if (notaFiscal.NFe.infNFe.transp != null && notaFiscal.NFe.infNFe.transp.Items != null)
                    this.SalvarInformacoesVeiculos(ref cte, (from obj in notaFiscal.NFe.infNFe.transp.Items where obj.GetType() == typeof(MultiSoftware.NFe.v400.NotaFiscal.TVeiculo) select (MultiSoftware.NFe.v400.NotaFiscal.TVeiculo)obj).ToList(), unidadeDeTrabalho);

                cte.ExibeICMSNaDACTE = true;

                cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Nao;

                if (cte.Empresa.Localidade.Estado.Sigla != cte.LocalidadeInicioPrestacao.Estado.Sigla)
                    cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Nao;
                else
                    cte.SimplesNacional = cte.Empresa.OptanteSimplesNacional ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao;

                if (cte.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && empresa.Configuracao != null)
                {
                    cte.IncluirICMSNoFrete = empresa.Configuracao.IncluirICMSNoFrete;
                    if (cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim)
                        cte.PercentualICMSIncluirNoFrete = 100;
                }

                if (cte.Empresa.Configuracao != null && empresa.Configuracao.ICMSIsento)
                {
                    cte.CST = "40";
                    cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Nao;
                    this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);
                    this.CalcularICMS(ref cte, unidadeDeTrabalho);
                }
                else
                {
                    this.CalcularICMSPorTabelaDeAliquotas(ref cte, cte.SimplesNacional, unidadeDeTrabalho);
                }

                if (gerarLog && usuario != null)
                    cte.Log = string.Concat("Criado por ", usuario.CPF, " - ", usuario.Nome, " em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");
                else if (gerarLog)
                    cte.Log = string.Concat("CTe salvo automaticamente em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");

                this.SetarPartilhaICMS(ref cte, unidadeDeTrabalho);

                if (emitirCTe)
                    cte.Status = "E";
                else
                    cte.Status = "S";

                SetarTomadorPagadorCTe(ref cte);

                if (string.IsNullOrWhiteSpace(cte.ObservacoesAvancadas))//Quando esta alterando, se já possui observação não muda para não dar erro de Digest value
                {
                    if (!this.SetarObservacoesVeiculo(ref cte, unidadeDeTrabalho))
                        this.SetarObservacoesAvancadas(ref cte, unidadeDeTrabalho);

                    if (cte.ModeloDocumentoFiscal.Numero == "57")
                        this.SetarObservacaoAvancadaPorRegraICMS(ref cte, unidadeDeTrabalho);

                    this.SetarXCampoVeiculo(cte, unidadeDeTrabalho);
                    this.AdicionarResponsavelSeguroObsContribuinte(cte, unidadeDeTrabalho);
                }

                repCTe.Atualizar(cte);

                if (unitOfWork == null)
                    unidadeDeTrabalho.CommitChanges();

                return cte;
            }
            catch
            {
                if (unitOfWork == null && unidadeDeTrabalho != null)
                    unidadeDeTrabalho.Rollback();

                throw;
            }
        }

        public List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> SalvarCTePorObjetoNFe(Dominio.Entidades.Empresa empresa, Dominio.Entidades.Usuario usuarioAdministrativo, Dominio.Entidades.Usuario usuario, bool agruparRemetente, bool agruparDestinatario, bool agruparUFDestino, bool agruparDT, List<Dominio.ObjetosDeValor.XMLNFe> documentos, Repositorio.UnitOfWork unitOfWork, int codigoTabelaFreteValor, int codigoTracao, int codigoReboque, int codigoMotorista, bool manterDigitacao, decimal valorFrete, decimal valorPedagio, decimal percentualGris, Dominio.Enumeradores.TipoRateioTabelaFreteValor tipoRateio, Dominio.Enumeradores.TipoTomador? tipoTomador, int codigoSeguro, string observacaoCTe, string recebedorCTe, string expedidorCTe, decimal valorAdicionalEntrega, ref bool notaSalva)
        {
            try
            {
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unitOfWork);
                Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unitOfWork);
                Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unitOfWork);
                Repositorio.Usuario repUsuario = new Repositorio.Usuario(unitOfWork);
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unitOfWork);
                Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unitOfWork);
                Repositorio.Pais repPais = new Repositorio.Pais(unitOfWork);
                Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unitOfWork);
                Repositorio.NaturezaDaOperacao repNatureza = new Repositorio.NaturezaDaOperacao(unitOfWork);
                Repositorio.CFOP repCFOP = new Repositorio.CFOP(unitOfWork);
                Repositorio.ApoliceDeSeguro repApoliceSeguro = new Repositorio.ApoliceDeSeguro(unitOfWork);
                Repositorio.EstadosDeEmissaoSerie repEstadosDeEmissaoSerie = new Repositorio.EstadosDeEmissaoSerie(unitOfWork);
                Repositorio.ObservacaoContribuinteCTE repObservacaoContribuinteCTE = new Repositorio.ObservacaoContribuinteCTE(unitOfWork);
                Repositorio.XMLNotaFiscalEletronica repXMLNotaFiscalEletronica = new Repositorio.XMLNotaFiscalEletronica(unitOfWork);
                Repositorio.Atividade repAtividade = new Repositorio.Atividade(unitOfWork);

                Servicos.CTe svcCTe = new Servicos.CTe(unitOfWork);
                Cliente svcCliente = new Cliente(unitOfWork.StringConexao);

                bool valorFreteInformado = false;
                if (codigoTabelaFreteValor > 0 && empresa.Configuracao != null)
                    CalcularFretePorValorNFEs(ref documentos, codigoTabelaFreteValor, empresa, unitOfWork);
                else if (valorFrete > 0)
                {
                    if (tipoRateio == Dominio.Enumeradores.TipoRateioTabelaFreteValor.PesoDestinatarioRemetente)
                        RatearValorFreteNFEsPesoDestinatarioRemetente(ref documentos, empresa, valorFrete, valorPedagio, valorAdicionalEntrega, tipoRateio, unitOfWork);
                    else if (tipoRateio == Dominio.Enumeradores.TipoRateioTabelaFreteValor.ValorMercadoriaDestinatarioRemetente)
                        RatearValorFreteNFEsValorDestinatarioRemetente(ref documentos, empresa, valorFrete, valorPedagio, valorAdicionalEntrega, tipoRateio, unitOfWork);
                    else if (tipoRateio != Dominio.Enumeradores.TipoRateioTabelaFreteValor.PorCTe)
                        RatearValorFreteNFEs(ref documentos, empresa, valorFrete, valorPedagio, valorAdicionalEntrega, tipoRateio, unitOfWork);
                    valorFreteInformado = true;
                }
                Dominio.Entidades.ModalTransporte modalTransporte = repModalTransporte.BuscarPorCodigo(1, false);

                Dominio.Entidades.NaturezaDaOperacao naturezaOperacao = repNatureza.BuscarPrimeiroRegistro();
                Dominio.Entidades.CFOP cfopPadrao = repCFOP.BuscarPorNaturezaDaOperacao(naturezaOperacao.Codigo).FirstOrDefault();

                Dominio.Entidades.ModeloDocumentoFiscal modeloCTe = repModeloDocumentoFiscal.BuscarPorModelo("57");
                Dominio.Entidades.ModeloDocumentoFiscal modeloNFSe = repModeloDocumentoFiscal.BuscarPorModelo("39");

                Dominio.Entidades.Localidade localidadeEmissao = repLocalidade.BuscarPorCodigo(empresa.Localidade.Codigo);

                Dominio.Entidades.Veiculo veiculo = null;
                Dominio.Entidades.Veiculo veiculoReboque = null;
                Dominio.Entidades.Usuario motorista = null;
                Dominio.Entidades.ApoliceDeSeguro apolice = null;
                if (codigoTracao > 0)
                    veiculo = repVeiculo.BuscarPorCodigo(empresa.Codigo, codigoTracao);
                if (codigoReboque > 0)
                    veiculoReboque = repVeiculo.BuscarPorCodigo(empresa.Codigo, codigoReboque);
                if (codigoMotorista > 0)
                    motorista = repUsuario.BuscarMotoristaPorCodigoEEmpresa(empresa.Codigo, codigoMotorista);
                if (codigoSeguro > 0)
                    apolice = repApoliceSeguro.BuscarPorCodigo(codigoSeguro, empresa.Codigo);

                Dominio.Entidades.Cliente recebedor = null;
                Dominio.Entidades.DadosCliente dadosRecebedor = null;
                Dominio.Entidades.Localidade localidadeRecebedor = null;
                if (!string.IsNullOrWhiteSpace(recebedorCTe) && recebedorCTe != "0")
                {
                    recebedor = repCliente.BuscarPorCPFCNPJ(double.Parse(Utilidades.String.OnlyNumbers(recebedorCTe)));
                    dadosRecebedor = repDadosCliente.Buscar(empresa.Codigo, double.Parse(Utilidades.String.OnlyNumbers(recebedorCTe)));
                    localidadeRecebedor = repLocalidade.BuscarPorCodigo(recebedor.Localidade.Codigo);
                }

                Dominio.Entidades.Cliente expedidor = null;
                Dominio.Entidades.DadosCliente dadosExpedidor = null;
                Dominio.Entidades.Localidade localidadeExpedidor = null;
                if (!string.IsNullOrWhiteSpace(expedidorCTe) && expedidorCTe != "0")
                {
                    expedidor = repCliente.BuscarPorCPFCNPJ(double.Parse(Utilidades.String.OnlyNumbers(expedidorCTe)));
                    dadosExpedidor = repDadosCliente.Buscar(empresa.Codigo, double.Parse(Utilidades.String.OnlyNumbers(expedidorCTe)));
                    localidadeExpedidor = repLocalidade.BuscarPorCodigo(expedidor.Localidade.Codigo);
                }

                List<Dominio.Entidades.EstadosDeEmissaoSerie> listaSeriesPorEstado = repEstadosDeEmissaoSerie.BuscarPorConfiguracao(empresa.Configuracao.Codigo);
                int[] seriesUsuario = null;
                if (usuario != null)
                    usuario.Series.Where(o => o.Tipo == Dominio.Enumeradores.TipoSerie.CTe).Select(o => o.Codigo).ToArray();

                List<Dominio.Entidades.CFOP> listaCFOP = repCFOP.BuscarPorCFOPPorTipo(Dominio.Enumeradores.TipoCFOP.Saida);

                List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> listaCTes = new List<Dominio.Entidades.ConhecimentoDeTransporteEletronico>();

                if (documentos != null && documentos.Count > 0)
                { //Quando for para gerar CTe de subcontratação não emite agrupado
                    if (!string.IsNullOrWhiteSpace(documentos.FirstOrDefault().ChaveCTeAnterior) && (!empresa.Configuracao?.NaoImportarValoresImportacaoCTe ?? false))
                    {
                        agruparRemetente = false;
                        agruparDestinatario = false;
                        agruparUFDestino = false;
                        agruparDT = false;
                    }
                }

                foreach (Dominio.ObjetosDeValor.XMLNFe documento in documentos)
                {
                    if (!documento.Adicionada)
                    {
                        string cnpjRemetente = String.Join("", System.Text.RegularExpressions.Regex.Split(documento.Remetente, @"[^\d]"));
                        Dominio.Entidades.Cliente remetente = repCliente.BuscarPorCPFCNPJ(double.Parse(cnpjRemetente));
                        if (remetente == null)
                            throw new Exception("Remetente " + cnpjRemetente + " não cadastrado na importação de NFe");
                        Dominio.Entidades.DadosCliente dadosRemetente = repDadosCliente.Buscar(empresa.Codigo, double.Parse(cnpjRemetente));
                        Dominio.Entidades.Localidade localidadeInicioPrestacao = localidadeExpedidor != null ? localidadeExpedidor : remetente.Localidade;

                        string cnpjDestinatario = "0";
                        if (documento.Destinatario != null && documento.Destinatario != "")
                            cnpjDestinatario = String.Join("", System.Text.RegularExpressions.Regex.Split(documento.Destinatario, @"[^\d]"));
                        Dominio.Entidades.Cliente destinatario = repCliente.BuscarPorCPFCNPJ(double.Parse(cnpjDestinatario));
                        Dominio.Entidades.DadosCliente dadosDestinatario = repDadosCliente.Buscar(empresa.Codigo, double.Parse(cnpjDestinatario));
                        if (destinatario == null)
                            throw new Exception("Destinatario " + cnpjDestinatario + " não cadastrado na importação de NFe");
                        Dominio.Entidades.Localidade localidadeTerminoPrestacao = localidadeRecebedor != null ? localidadeRecebedor : destinatario.Localidade;

                        if (empresa.Configuracao.GerarNFSeImportacoes && dadosRemetente != null && dadosRemetente.ArmazenaNotasParaGerarPorPeriodo && localidadeInicioPrestacao.Codigo == localidadeTerminoPrestacao.Codigo)
                        {
                            Dominio.Entidades.XMLNotaFiscalEletronica notaImportada = repXMLNotaFiscalEletronica.BuscarPorChaveNFe(documento.Chave);
                            if (notaImportada == null)
                            {
                                Servicos.NFSe serNFSe = new NFSe(unitOfWork);

                                notaImportada = new Dominio.Entidades.XMLNotaFiscalEletronica();
                                notaImportada.Chave = documento.Chave;
                                DateTime dataEmissao;
                                if (!DateTime.TryParseExact(documento.DataEmissao, "dd/MM/yyyy", null, System.Globalization.DateTimeStyles.None, out dataEmissao))
                                    dataEmissao = DateTime.Now;
                                notaImportada.DataEmissao = dataEmissao;
                                notaImportada.Emitente = remetente;
                                notaImportada.Destinatario = destinatario;
                                notaImportada.Empresa = empresa;
                                Dominio.Enumeradores.TipoPagamento tipoPagamento;
                                Enum.TryParse<Dominio.Enumeradores.TipoPagamento>(documento.FormaPagamento, out tipoPagamento);
                                notaImportada.FormaDePagamento = ((int)tipoPagamento).ToString();
                                notaImportada.Numero = documento.Numero;
                                notaImportada.Peso = documento.Peso;
                                notaImportada.Valor = documento.ValorTotal;
                                notaImportada.GeradoDocumento = false;
                                notaImportada.ValorDoFrete = serNFSe.CalcularFretePorNotaImportada(notaImportada, empresa.Codigo, "", unitOfWork);
                                notaImportada.Volumes = (int)documento.Volume;
                                repXMLNotaFiscalEletronica.Inserir(notaImportada);

                                notaSalva = true;

                                Servicos.LsTranslog svcLsTranslog = new Servicos.LsTranslog(unitOfWork);
                                svcLsTranslog.SalvarNFeParaIntegracao(notaImportada, empresa.Codigo, unitOfWork);
                            }

                            documento.Adicionada = true;
                        }
                        else
                        {
                            decimal pesoTotal = 0;
                            decimal valorTotal = 0;
                            decimal volumeTotal = 0;
                            decimal cubagemTotal = 0;
                            decimal valorFreteTotal = 0;
                            decimal valorPedagioTotal = 0;
                            decimal valorAdicionalEntregaTotal = 0;
                            decimal valorSobreNFTotal = 0;
                            decimal baseICMSTotal = 0;
                            decimal valorICMSTotal = 0;
                            decimal baseICMSSTTotal = 0;
                            decimal valorICMSSTTotal = 0;
                            decimal valorAdValoremTotal = 0;
                            decimal valorDescargaTotal = 0;
                            decimal valorGris = 0;

                            string obsPadraoVeiculo = "";

                            Dominio.Enumeradores.TipoPagamento tipoPagamento;
                            Enum.TryParse<Dominio.Enumeradores.TipoPagamento>(documento.FormaPagamento, out tipoPagamento);

                            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                            TimeZoneInfo fusoHorarioEmpresa = TimeZoneInfo.FindSystemTimeZoneById(empresa.FusoHorario);
                            DateTime dataFuso = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day, DateTime.Now.Hour, DateTime.Now.Minute, 0);
                            dataFuso = TimeZoneInfo.ConvertTime(dataFuso, TimeZoneInfo.Local, fusoHorarioEmpresa);

                            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = null;
                            if (Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoAmbiente().ValidarNFeJaImportada.Value && !string.IsNullOrWhiteSpace(documento.Chave))
                                cte = repCTe.BuscarPorNFeStatus(empresa.Codigo, empresa.TipoAmbiente, DateTime.Today, documento.Chave, "S");

                            if (cte == null)
                            {
                                bool cteGlobalizado = false;
                                System.Threading.Thread.Sleep(500);

                                unitOfWork.Start();

                                cte = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();

                                cte.Empresa = empresa;
                                cte.SetarParticipante(remetente, Dominio.Enumeradores.TipoTomador.Remetente, null, dadosRemetente);

                                if (destinatario != null && destinatario.CPF_CNPJ > 0)
                                    cte.SetarParticipante(destinatario, Dominio.Enumeradores.TipoTomador.Destinatario, null, dadosDestinatario);
                                else if (documento.DestinatarioExportacao != null)
                                    cte.SetarParticipanteExportacao(documento.DestinatarioExportacao, Dominio.Enumeradores.TipoTomador.Destinatario, repPais.BuscarPorSigla(documento.DestinatarioExportacao.SiglaPais));

                                if (expedidor != null)
                                    cte.SetarParticipante(expedidor, Dominio.Enumeradores.TipoTomador.Expedidor, null, dadosExpedidor);

                                if (recebedor != null)
                                    cte.SetarParticipante(recebedor, Dominio.Enumeradores.TipoTomador.Recebedor, null, dadosRecebedor);

                                cte.LocalidadeEmissao = localidadeEmissao;
                                cte.LocalidadeInicioPrestacao = localidadeExpedidor != null ? localidadeExpedidor : remetente.Localidade;
                                cte.LocalidadeTerminoPrestacao = localidadeRecebedor != null ? localidadeRecebedor : destinatario.Localidade;
                                cte.IncluirICMSNoFrete = cte.Empresa.Configuracao != null ? cte.Empresa.Configuracao.IncluirICMSNoFrete : Dominio.Enumeradores.OpcaoSimNao.Sim;
                                cte.PercentualICMSIncluirNoFrete = 100;
                                cte.TipoPagamento = tipoPagamento;
                                if (tipoTomador == null)
                                    cte.TipoTomador = cte.TipoPagamento == Dominio.Enumeradores.TipoPagamento.Pago ? Dominio.Enumeradores.TipoTomador.Remetente : Dominio.Enumeradores.TipoTomador.Destinatario;
                                else
                                    cte.TipoTomador = tipoTomador == Dominio.Enumeradores.TipoTomador.Remetente ? Dominio.Enumeradores.TipoTomador.Remetente : Dominio.Enumeradores.TipoTomador.Destinatario;
                                //cte.ModalTransporte = repModalTransporte.BuscarPorNumero((int)cteIntegracao.TipoModal > 0 ? cteIntegracao.TipoModal.ToString("D") : "1");
                                cte.ModalTransporte = modalTransporte;
                                cte.ValorFrete = 0;
                                cte.ValorPrestacaoServico = 0;
                                cte.ValorAReceber = 0;

                                if (cte.Empresa.Configuracao != null)
                                {
                                    cte.ProdutoPredominante = cte.Empresa.Configuracao.ProdutoPredominante;
                                    cte.OutrasCaracteristicasDaCarga = cte.Empresa.Configuracao.OutrasCaracteristicas;
                                }
                                else
                                {
                                    cte.ProdutoPredominante = empresa.EmpresaPai.Configuracao.ProdutoPredominante;
                                    cte.OutrasCaracteristicasDaCarga = empresa.EmpresaPai.Configuracao.OutrasCaracteristicas;
                                }

                                cte.ExibeICMSNaDACTE = true;
                                cte.NaturezaDaOperacao = naturezaOperacao;
                                cte.CFOP = cfopPadrao;

                                if (empresa.Localidade.Estado.Sigla != cte.LocalidadeInicioPrestacao.Estado.Sigla)
                                    cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Nao;
                                else
                                    cte.SimplesNacional = cte.Empresa.OptanteSimplesNacional ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao;

                                cte.Retira = Dominio.Enumeradores.OpcaoSimNao.Nao;

                                cte.RNTRC = cte.Empresa.RegistroANTT;

                                if (cte.Empresa.Configuracao != null)
                                    cte.DataPrevistaEntrega = DateTime.Now.AddDays(cte.Empresa.Configuracao.DiasParaEntrega);
                                else
                                    cte.DataPrevistaEntrega = DateTime.Now.AddDays(empresa.EmpresaPai.Configuracao.DiasParaEntrega);

                                cte.TipoAmbiente = empresa.TipoAmbiente;

                                cte.TipoCTE = Dominio.Enumeradores.TipoCTE.Normal;

                                cte.TipoEmissao = "0";

                                if (cte.Empresa.Configuracao != null)
                                    cte.TipoImpressao = cte.Empresa.Configuracao.TipoImpressao;
                                else
                                    cte.TipoImpressao = empresa.EmpresaPai.Configuracao.TipoImpressao;

                                cte.TipoServico = Dominio.Enumeradores.TipoServico.Normal;

                                cte.DataEmissao = dataFuso;

                                //cte.ModalTransporte = repModalTransporte.BuscarPorNumero((int)cteIntegracao.TipoModal > 0 ? cteIntegracao.TipoModal.ToString("D") : "1");
                                cte.ModalTransporte = modalTransporte;

                                if (modeloNFSe != null && cte.LocalidadeInicioPrestacao.Codigo == cte.LocalidadeTerminoPrestacao.Codigo && cte.Empresa.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.Configuracao.SerieRPSNFSe) && cte.Empresa.Configuracao.GerarNFSeImportacoes)
                                    cte.ModeloDocumentoFiscal = modeloNFSe;
                                else
                                    cte.ModeloDocumentoFiscal = modeloCTe;

                                cte.Serie = svcCTe.ObterSerie(empresa, cte.LocalidadeEmissao.Estado.Sigla, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, cte.Remetente?.CPF_CNPJ ?? string.Empty, cte.Destinatario?.CPF_CNPJ ?? string.Empty, cte.Recebedor?.CPF_CNPJ ?? string.Empty, cte.Expedidor?.CPF_CNPJ ?? string.Empty, cte.TomadorPagador?.CPF_CNPJ ?? string.Empty, unitOfWork, seriesUsuario, usuario, listaSeriesPorEstado);

                                string guid = Utilidades.String.OnlyNumbers(Guid.NewGuid().ToString());
                                guid = guid.Length > 12 ? guid.Substring(0, 12) : guid;
                                long.TryParse(guid, out long tipoControle);
                                cte.TipoControle = tipoControle;

                                cte.Versao = cte.Empresa.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.Configuracao.VersaoCTe) ? cte.Empresa.Configuracao.VersaoCTe : cte.Empresa.EmpresaPai.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.EmpresaPai.Configuracao.VersaoCTe) ? cte.Empresa.EmpresaPai.Configuracao.VersaoCTe : "4.00";// cte.Empresa.Versao;

                                cte.ObservacoesGerais = observacaoCTe;

                                if (!string.IsNullOrWhiteSpace(documento.ObservacaoCTe))
                                    cte.ObservacoesGerais = !string.IsNullOrWhiteSpace(cte.ObservacoesGerais) ? string.Concat(documento.ObservacaoCTe, " ", cte.ObservacoesGerais) : documento.ObservacaoCTe;

                                if (!string.IsNullOrWhiteSpace(documento.ObsTransporte))
                                    cte.ObservacoesGerais = !string.IsNullOrWhiteSpace(cte.ObservacoesGerais) ? string.Concat("N. Transporte ", documento.ObsTransporte, " ", cte.ObservacoesGerais) : string.Concat("N. Transporte ", documento.ObsTransporte);

                                if (!string.IsNullOrWhiteSpace(documento.ObsPlaca))
                                    cte.ObservacoesGerais = !string.IsNullOrWhiteSpace(cte.ObservacoesGerais) ? string.Concat("Placa ", documento.ObsPlaca, " ", cte.ObservacoesGerais) : string.Concat("Placa ", documento.ObsPlaca);

                                repCTe.Inserir(cte);

                                if (!string.IsNullOrWhiteSpace(cte.Empresa.Configuracao.TagParaImportarObservacaoNFe) && cte.Empresa.Configuracao.TamanhoTagObservacaoNFe > 0)
                                {
                                    if (documento.Observacao.Contains(cte.Empresa.Configuracao.TagParaImportarObservacaoNFe))
                                    {
                                        string pedido = string.Empty;
                                        if (documento.Observacao.Length > documento.Observacao.IndexOf(cte.Empresa.Configuracao.TagParaImportarObservacaoNFe) + cte.Empresa.Configuracao.TagParaImportarObservacaoNFe.Length + cte.Empresa.Configuracao.TamanhoTagObservacaoNFe)
                                            pedido = Utilidades.String.OnlyNumbers(documento.Observacao.Substring(documento.Observacao.IndexOf(cte.Empresa.Configuracao.TagParaImportarObservacaoNFe) + cte.Empresa.Configuracao.TagParaImportarObservacaoNFe.Length, cte.Empresa.Configuracao.TamanhoTagObservacaoNFe));
                                        if (!string.IsNullOrWhiteSpace(pedido))
                                        {
                                            Dominio.Entidades.ObservacaoContribuinteCTE obsCTeContribuinte = new Dominio.Entidades.ObservacaoContribuinteCTE();
                                            obsCTeContribuinte.CTE = cte;
                                            obsCTeContribuinte.Identificador = cte.Empresa.Configuracao.TagParaImportarObservacaoNFe.Length > 20 ? cte.Empresa.Configuracao.TagParaImportarObservacaoNFe.Substring(0, 20) : cte.Empresa.Configuracao.TagParaImportarObservacaoNFe;
                                            obsCTeContribuinte.Descricao = pedido.Length > 160 ? pedido.Substring(0, 160) : pedido;
                                            repObservacaoContribuinteCTE.Inserir(obsCTeContribuinte);
                                        }
                                    }
                                }

                                this.SalvarInformacoesNFes(cte, documento, ref documentos, agruparRemetente, agruparDestinatario, agruparUFDestino, agruparDT, ref valorTotal, ref pesoTotal, ref volumeTotal, ref cubagemTotal, ref valorFreteTotal, ref valorPedagioTotal, ref valorAdicionalEntregaTotal, ref valorSobreNFTotal, ref baseICMSTotal, ref valorICMSTotal, ref baseICMSSTTotal, ref valorICMSSTTotal, ref valorAdValoremTotal, ref valorDescargaTotal, ref cteGlobalizado, unitOfWork);

                                if (cteGlobalizado)
                                {
                                    cte.IndicadorGlobalizado = OpcaoSimNao.Sim;
                                    cte.SetarDestinatarioDiversos(empresa, repAtividade.BuscarPorCodigo(4));
                                }

                                cte.ValorTotalMercadoria = valorTotal;

                                this.SalvarInformacoesDeQuantidadeDaCarga(cte, pesoTotal, volumeTotal, cubagemTotal, unitOfWork);

                                Dominio.Entidades.Cliente clienteAnterior = null;
                                if (!string.IsNullOrWhiteSpace(documento.EmissorCTeAnterior))
                                    clienteAnterior = repCliente.BuscarPorCPFCNPJ(double.Parse(documento.EmissorCTeAnterior));

                                if (clienteAnterior != null && !string.IsNullOrWhiteSpace(documento.ChaveCTeAnterior))
                                {
                                    cte.TipoServico = Dominio.Enumeradores.TipoServico.SubContratacao;
                                    cte.TipoTomador = Dominio.Enumeradores.TipoTomador.Outros;

                                    Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior documentoAnterior = new Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior();
                                    documentoAnterior.Chave = documento.ChaveCTeAnterior;
                                    documentoAnterior.Emissor = svcCliente.ObterClienteCTE(clienteAnterior, null);

                                    List<Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior> listaDocumentosAnterior = new List<Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior>();
                                    listaDocumentosAnterior.Add(documentoAnterior);

                                    cte.SetarParticipante(clienteAnterior, Dominio.Enumeradores.TipoTomador.Outros, null, null);
                                    this.SalvarInformacoesDocumentosAnteriores(cte, listaDocumentosAnterior, unitOfWork, false);
                                }


                                if ((cte.Empresa.Configuracao != null && empresa.Configuracao.ICMSIsento) || cte.TipoServico == Dominio.Enumeradores.TipoServico.SubContratacao)
                                {
                                    cte.CST = "40";
                                    svcCTe.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unitOfWork);
                                    svcCTe.CalcularICMS(ref cte, unitOfWork);
                                }
                                else
                                {
                                    if (valorICMSSTTotal > 0 && baseICMSSTTotal > 0 && documento.AliquotaICMS > 0)
                                    {
                                        cte.CST = "60";
                                        cte.BaseCalculoICMS = baseICMSSTTotal;
                                        cte.AliquotaICMS = documento.AliquotaICMS;
                                        cte.ValorICMS = valorICMSSTTotal;

                                        if (baseICMSSTTotal < valorFreteTotal)
                                            cte.PercentualReducaoBaseCalculoICMS = Math.Round((1 - (baseICMSSTTotal / valorFreteTotal)) * 100, 0, MidpointRounding.ToEven);

                                        svcCTe.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unitOfWork);
                                        svcCTe.CalcularICMS(ref cte, unitOfWork);
                                    }
                                    else if (valorICMSTotal > 0 && baseICMSTotal > 0 && documento.AliquotaICMS > 0)
                                    {
                                        this.SetarCSTPorTabelaDeAliquotas(ref cte, unitOfWork);

                                        cte.BaseCalculoICMS = baseICMSTotal;
                                        cte.AliquotaICMS = documento.AliquotaICMS;
                                        cte.ValorICMS = valorICMSTotal;

                                        if (baseICMSTotal == valorFreteTotal)
                                            cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Nao;
                                        else
                                        {
                                            decimal diferencaValor = baseICMSTotal - valorFreteTotal;
                                            if (diferencaValor == valorICMSTotal)
                                                cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Sim;
                                        }

                                        svcCTe.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unitOfWork);
                                        svcCTe.CalcularICMS(ref cte, unitOfWork);
                                    }
                                    else
                                        svcCTe.CalcularICMSPorTabelaDeAliquotas(ref cte, cte.SimplesNacional, unitOfWork, false, listaCFOP);
                                }

                                cte.Lotacao = Dominio.Enumeradores.OpcaoSimNao.Nao;
                                if (cte.Empresa.Configuracao != null && cte.Empresa.Configuracao.IndicadorDeLotacao)
                                    cte.Lotacao = Dominio.Enumeradores.OpcaoSimNao.Sim;

                                Dominio.Entidades.Veiculo veiculoCTe = null;
                                if (veiculo == null && !string.IsNullOrWhiteSpace(documento.Placa))
                                    veiculoCTe = repVeiculo.BuscarPorPlaca(empresa.Codigo, documento.Placa); // Busca por placa no documento
                                else if (veiculo == null && !string.IsNullOrWhiteSpace(documento.ObsPlaca))
                                    veiculoCTe = repVeiculo.BuscarPorPlaca(empresa.Codigo, Utilidades.String.OnlyNumbersAndChars(documento.ObsPlaca)); // Busca por placa no documento
                                else
                                    veiculoCTe = veiculo;

                                List<Dominio.Entidades.MotoristaCTE> motoristasCTe = new List<Dominio.Entidades.MotoristaCTE>();

                                if (veiculoCTe != null)
                                {
                                    motoristasCTe = this.SalvarInformacoesVeiculos(cte, veiculoCTe, veiculoReboque, ref obsPadraoVeiculo, unitOfWork);
                                    cte.Lotacao = Dominio.Enumeradores.OpcaoSimNao.Sim;
                                    cte.CIOT = veiculoCTe != null && !string.IsNullOrWhiteSpace(veiculoCTe.CIOT) ? veiculoCTe.CIOT : null;
                                }

                                // Mesmo que venha motorista do veiculo, prevalece o informado pelo usuario
                                if (motorista != null)
                                {
                                    motoristasCTe.Clear();
                                    Dominio.Entidades.MotoristaCTE motoristaInformado = new Dominio.Entidades.MotoristaCTE()
                                    {
                                        CPFMotorista = motorista.CPF,
                                        NomeMotoristaCTe = motorista.Nome
                                    };
                                    motoristasCTe.Add(motoristaInformado);
                                }

                                if (motoristasCTe != null)
                                    this.SalvarInformacoesMotorista(cte, motoristasCTe, unitOfWork);

                                cte.Status = "S";

                                cte.Cancelado = "N";

                                cte.TipoControle = 1;
                                cte.Numero = ObterProximoNumero(cte, repCTe);


                                //if (empresa.Codigo == 1)
                                //    throw new Exception("Teste");

                                if (empresa.Configuracao != null && valorFreteTotal > 0)
                                {
                                    Dominio.Enumeradores.IncluiICMSFrete incluirICMS = documento.incluirICMS;
                                    if (valorFreteInformado == false && codigoTabelaFreteValor == 0)
                                        incluirICMS = cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim ? Dominio.Enumeradores.IncluiICMSFrete.Sim : Dominio.Enumeradores.IncluiICMSFrete.Nao;

                                    this.SalvarValoresFrete(ref cte, incluirICMS, valorFreteTotal, valorSobreNFTotal, valorPedagioTotal, valorAdicionalEntregaTotal, valorGris, 0, valorDescargaTotal, valorAdValoremTotal, unitOfWork);
                                }
                                else if (!valorFreteInformado)
                                {
                                    if (empresa.Configuracao != null && empresa.Configuracao.UtilizaTabelaDeFrete)
                                    {
                                        if (!svcCTe.CalcularFretePorTabelaDeFrete(ref cte, cte.Empresa.Codigo, unitOfWork, true))
                                            svcCTe.CarregarInformacoesSemelhantes(ref cte, unitOfWork);
                                    }
                                    else
                                        svcCTe.CarregarInformacoesSemelhantes(ref cte, unitOfWork);
                                }

                                if (apolice != null)
                                    this.SalvarInformacoesDeSeguro(cte, apolice, unitOfWork);
                                else if (empresa.Configuracao != null)
                                    svcCTe.SalvarInformacoesDeSeguroDaCarga(cte, unitOfWork);

                                if (obsPadraoVeiculo != "")
                                {
                                    if (cte.ObservacoesGerais == "")
                                        cte.ObservacoesGerais = obsPadraoVeiculo;
                                    else
                                        cte.ObservacoesGerais += " " + obsPadraoVeiculo;
                                }

                                svcCTe.SetarPartilhaICMS(ref cte, unitOfWork);

                                if (usuarioAdministrativo != null)
                                {
                                    cte.Log = string.Concat(usuarioAdministrativo.CPF, " - ", usuarioAdministrativo.Nome);
                                    cte.Usuario = usuarioAdministrativo;
                                }
                                else if (usuario != null)
                                {
                                    cte.Log = string.Concat(usuario.CPF, " - ", usuario.Nome);
                                    cte.Usuario = usuario;
                                }

                                Servicos.CTe.SetarTomadorPagadorCTe(ref cte);

                                Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE indicadorTomador = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS;

                                if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Remetente)
                                    indicadorTomador = !String.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Remetente.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Remetente.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
                                else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Destinatario)
                                    indicadorTomador = !String.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Destinatario.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Destinatario.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
                                else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Recebedor && cte.Recebedor != null)
                                    indicadorTomador = !String.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Recebedor.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Recebedor.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
                                else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Recebedor && cte.Expedidor != null)
                                    indicadorTomador = !String.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Expedidor.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Expedidor.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
                                else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Recebedor && cte.OutrosTomador != null)
                                    indicadorTomador = !String.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.OutrosTomador.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.OutrosTomador.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;

                                cte.IndicadorIETomador = indicadorTomador; //CTe 3.0

                                repCTe.Atualizar(cte);

                                unitOfWork.CommitChanges();

                                unitOfWork.FlushAndClear();
                            }
                            else
                                documento.Adicionada = true;

                            if (!listaCTes.Contains(cte))
                                listaCTes.Add(cte);

                        }

                        System.Threading.Thread.Sleep(500);
                    }
                }

                if (listaCTes != null && listaCTes.Count > 0)
                {
                    Servicos.LsTranslog svcLsTranslog = new Servicos.LsTranslog(unitOfWork);

                    decimal valorPorCTe = 0;
                    decimal valorPedagioPorCTe = 0;
                    decimal valorAdicionalEntregaPorCTe = 0;

                    if (tipoRateio == Dominio.Enumeradores.TipoRateioTabelaFreteValor.PorCTe)
                    {
                        valorPorCTe = Math.Round(valorFrete / listaCTes.Count, 2, MidpointRounding.ToEven);
                        valorPedagioPorCTe = Math.Round(valorPedagio / listaCTes.Count, 2, MidpointRounding.ToEven);
                        valorAdicionalEntregaPorCTe = Math.Round(valorAdicionalEntrega / listaCTes.Count, 2, MidpointRounding.ToEven);
                    }

                    for (int i = 0; i < listaCTes.Count(); i++)
                    {
                        Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorCodigo(listaCTes[i].Codigo);
                        if (valorPorCTe > 0)
                        {
                            svcCTe.AlterarValorFreteCTe(ref cte, valorPorCTe, valorPedagioPorCTe, valorAdicionalEntregaPorCTe, percentualGris, unitOfWork);
                            repCTe.Atualizar(cte);
                        }

                        if (!manterDigitacao && cte.ValorFrete > 0 && cte.CST != null && cte.ModeloDocumentoFiscal.Numero == "57")
                        {
                            if (usuarioAdministrativo != null)
                                cte.Usuario = usuarioAdministrativo;
                            else if (usuario != null)
                                cte.Usuario = usuario;

                            repCTe.Atualizar(cte);

                            if (svcCTe.Emitir(ref cte, unitOfWork))
                                this.AdicionarCTeNaFilaDeConsulta(cte, unitOfWork);
                        }

                        if (cte.ModeloDocumentoFiscal.Numero == "39") //Quando gera NFSe duplica para a tabela de NFSe
                        {
                            Servicos.NFSe svcNFSe = new NFSe(unitOfWork);
                            Dominio.Entidades.NFSe nfse = svcNFSe.GerarNFSePorCTe(cte, unitOfWork, Dominio.Enumeradores.StatusNFSe.EmDigitacao);

                            cte.AliquotaISS = nfse.AliquotaISS;
                            cte.ValorISS = nfse.ValorISS;
                            cte.BaseCalculoISS = nfse.BaseCalculoISS;
                            cte.AliquotaICMS = nfse.AliquotaISS;
                            cte.ValorICMS = nfse.ValorISS;
                            cte.BaseCalculoICMS = nfse.BaseCalculoISS;

                            cte.ValorIR = nfse.ValorIR;

                            repCTe.Atualizar(cte);

                            Dominio.Entidades.RPSNFSe rpsNFSe = null;

                            if (nfse != null && !manterDigitacao && cte.ValorFrete > 0)
                            {
                                if (svcNFSe.Emitir(nfse, unitOfWork))
                                {
                                    Repositorio.RPSNFSe repNFSe = new Repositorio.RPSNFSe(unitOfWork);
                                    rpsNFSe = repNFSe.BuscarPorNFSe(nfse.Codigo);
                                }
                            }
                            else
                            {
                                svcNFSe.ObterRPS(ref nfse, unitOfWork);
                                Repositorio.RPSNFSe repNFSe = new Repositorio.RPSNFSe(unitOfWork);
                                rpsNFSe = repNFSe.BuscarPorNFSe(nfse.Codigo);
                            }

                            if (rpsNFSe != null)
                            {
                                cte.RPS = rpsNFSe;
                                repCTe.Atualizar(cte);
                            }
                            if (nfse.Status == Dominio.Enumeradores.StatusNFSe.EmDigitacao)
                                svcLsTranslog.SalvarNFSeParaIntegracao(nfse.Codigo, nfse.Empresa.Codigo, unitOfWork, true);

                        }
                        else
                        {
                            if (cte.Status == "S")
                                svcLsTranslog.SalvarCTeParaIntegracao(cte.Codigo, cte.Empresa.Codigo, unitOfWork, true);
                        }
                    }
                }


                return listaCTes;
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro(ex);

                unitOfWork.Rollback();

                return null;
            }
        }

        public Dominio.Entidades.ConhecimentoDeTransporteEletronico GerarCTePorListaCTe(Dominio.Entidades.Empresa empresa, Dominio.Entidades.Cliente tomador, Dominio.Entidades.Cliente expedidor, Dominio.Entidades.Cliente recebedor, Dominio.Entidades.Veiculo tracao, Dominio.Entidades.Veiculo reboque, Dominio.Entidades.Usuario motorista, decimal valorFrete, decimal valorPedagio, decimal valorOutros, decimal percentualGris, string observacaoCTe, Dominio.Entidades.Usuario usuarioAdministrativo, Dominio.Entidades.Usuario usuario, List<Dominio.ObjetosDeValor.Embarcador.CTe.CTe> listaCTes, Dominio.Enumeradores.TipoServico tipoServico, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Cliente svcCliente = new Cliente(unidadeDeTrabalho.StringConexao);
            Servicos.CTe svcCTe = new Servicos.CTe(unidadeDeTrabalho);

            Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeDeTrabalho);
            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeDeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeDeTrabalho);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);
            Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeDeTrabalho);
            Repositorio.EstadosDeEmissaoSerie repEstadosDeEmissaoSerie = new Repositorio.EstadosDeEmissaoSerie(unidadeDeTrabalho);
            Repositorio.NaturezaDaOperacao repNatureza = new Repositorio.NaturezaDaOperacao(unidadeDeTrabalho);
            Repositorio.ComponentePrestacaoCTE repComponentePrestacao = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            List<Dominio.Entidades.EstadosDeEmissaoSerie> listaSeriesPorEstado = repEstadosDeEmissaoSerie.BuscarPorConfiguracao(empresa.Configuracao.Codigo);
            int[] seriesUsuario = null;
            if (usuario != null)
                usuario.Series.Where(o => o.Tipo == Dominio.Enumeradores.TipoSerie.CTe).Select(o => o.Codigo).ToArray();

            Dominio.Entidades.NaturezaDaOperacao naturezaOperacao = repNatureza.BuscarPrimeiroRegistro();
            Dominio.Entidades.CFOP cfopPadrao = repCFOP.BuscarPorNaturezaDaOperacao(naturezaOperacao.Codigo).FirstOrDefault();

            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();

            cte.Empresa = empresa;

            Dominio.ObjetosDeValor.RetornoVerificacaoCliente retorno = svcCliente.ConverterObjetoValorPessoa(listaCTes.FirstOrDefault().Remetente, "remetente", unidadeDeTrabalho, 0, false);
            if (retorno.Status)
                cte.SetarParticipante(retorno.cliente, Dominio.Enumeradores.TipoTomador.Remetente);

            retorno = svcCliente.ConverterObjetoValorPessoa(listaCTes.FirstOrDefault().Destinatario, "destinatario", unidadeDeTrabalho, 0, false);
            if (retorno.Status)
                cte.SetarParticipante(retorno.cliente, Dominio.Enumeradores.TipoTomador.Destinatario);

            if (expedidor != null)
                cte.SetarParticipante(expedidor, Dominio.Enumeradores.TipoTomador.Expedidor);

            if (recebedor != null)
                cte.SetarParticipante(recebedor, Dominio.Enumeradores.TipoTomador.Recebedor);

            cte.LocalidadeEmissao = empresa.Localidade;
            cte.LocalidadeInicioPrestacao = expedidor != null ? expedidor.Localidade : repLocalidade.BuscarPorCodigoIBGE(listaCTes.FirstOrDefault().LocalidadeInicioPrestacao.IBGE);
            cte.LocalidadeTerminoPrestacao = recebedor != null ? recebedor.Localidade : repLocalidade.BuscarPorCodigoIBGE(listaCTes.FirstOrDefault().LocalidadeFimPrestacao.IBGE);
            cte.IncluirICMSNoFrete = cte.Empresa.Configuracao != null ? cte.Empresa.Configuracao.IncluirICMSNoFrete : Dominio.Enumeradores.OpcaoSimNao.Sim;
            cte.PercentualICMSIncluirNoFrete = 100;
            cte.TipoPagamento = listaCTes.FirstOrDefault().TipoPagamento;
            cte.TipoTomador = cte.TipoPagamento == Dominio.Enumeradores.TipoPagamento.Pago ? Dominio.Enumeradores.TipoTomador.Remetente : Dominio.Enumeradores.TipoTomador.Destinatario;
            cte.ModalTransporte = repModalTransporte.BuscarPorNumero("01");

            cte.ValorFrete = valorFrete;
            cte.ValorPrestacaoServico = valorFrete;
            cte.ValorAReceber = valorFrete;

            if (cte.Empresa.Configuracao != null)
            {
                cte.ProdutoPredominante = cte.Empresa.Configuracao.ProdutoPredominante;
                cte.OutrasCaracteristicasDaCarga = cte.Empresa.Configuracao.OutrasCaracteristicas;
            }
            else
            {
                cte.ProdutoPredominante = empresa.EmpresaPai.Configuracao.ProdutoPredominante;
                cte.OutrasCaracteristicasDaCarga = empresa.EmpresaPai.Configuracao.OutrasCaracteristicas;
            }

            cte.ExibeICMSNaDACTE = true;
            cte.NaturezaDaOperacao = naturezaOperacao;
            cte.CFOP = cfopPadrao;

            if (empresa.Localidade.Estado.Sigla != cte.LocalidadeInicioPrestacao.Estado.Sigla)
                cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Nao;
            else
                cte.SimplesNacional = cte.Empresa.OptanteSimplesNacional ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao;

            cte.Retira = Dominio.Enumeradores.OpcaoSimNao.Nao;

            cte.RNTRC = cte.Empresa.RegistroANTT;

            if (cte.Empresa.Configuracao != null)
                cte.DataPrevistaEntrega = DateTime.Now.AddDays(cte.Empresa.Configuracao.DiasParaEntrega);
            else
                cte.DataPrevistaEntrega = DateTime.Now.AddDays(empresa.EmpresaPai.Configuracao.DiasParaEntrega);

            cte.TipoAmbiente = empresa.TipoAmbiente;

            cte.TipoCTE = Dominio.Enumeradores.TipoCTE.Normal;

            cte.TipoEmissao = "0";

            if (cte.Empresa.Configuracao != null)
                cte.TipoImpressao = cte.Empresa.Configuracao.TipoImpressao;
            else
                cte.TipoImpressao = empresa.EmpresaPai.Configuracao.TipoImpressao;

            cte.TipoServico = tipoServico;

            TimeZoneInfo fusoHorarioEmpresa = TimeZoneInfo.FindSystemTimeZoneById(cte.Empresa.FusoHorario);
            DateTime dataFuso = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day, DateTime.Now.Hour, DateTime.Now.Minute, 0);
            dataFuso = TimeZoneInfo.ConvertTime(dataFuso, TimeZoneInfo.Local, fusoHorarioEmpresa);

            cte.DataEmissao = dataFuso;

            cte.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("57");

            cte.Serie = svcCTe.ObterSerie(empresa, cte.LocalidadeEmissao.Estado.Sigla, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, cte.Remetente?.CPF_CNPJ ?? string.Empty, cte.Destinatario?.CPF_CNPJ ?? string.Empty, cte.Recebedor?.CPF_CNPJ ?? string.Empty, cte.Expedidor?.CPF_CNPJ ?? string.Empty, cte.TomadorPagador?.CPF_CNPJ ?? string.Empty, unidadeDeTrabalho, seriesUsuario, usuario, listaSeriesPorEstado);

            string guid = Utilidades.String.OnlyNumbers(Guid.NewGuid().ToString());
            guid = guid.Length > 12 ? guid.Substring(0, 12) : guid;
            long.TryParse(guid, out long tipoControle);
            cte.TipoControle = tipoControle;

            cte.Versao = cte.Empresa.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.Configuracao.VersaoCTe) ? cte.Empresa.Configuracao.VersaoCTe : cte.Empresa.EmpresaPai.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.EmpresaPai.Configuracao.VersaoCTe) ? cte.Empresa.EmpresaPai.Configuracao.VersaoCTe : "4.00";// cte.Empresa.Versao;

            cte.ObservacoesGerais = observacaoCTe;
            repCTe.Inserir(cte);

            //this.SalvarInformacoesNFes(cte, documento, ref documentos, agruparRemetente, agruparDestinatario, agruparUFDestino, ref valorTotal, ref pesoTotal, ref volumeTotal, ref valorFreteTotal, ref valorPedagioTotal, ref valorAdicionalEntregaTotal, ref valorSobreNFTotal, ref baseICMSTotal, ref valorICMSTotal, ref baseICMSSTTotal, ref valorICMSSTTotal, ref valorAdValoremTotal, ref valorDescargaTotal, unitOfWork);
            //cte.ValorAReceber = cte.ValorFrete + valorPedagio + valorOutros;

            cte.ValorTotalMercadoria = (from obj in listaCTes select obj.InformacaoCarga.ValorTotalCarga).Sum();
            cte.ValorCarbaAverbacao = (from obj in listaCTes select obj.InformacaoCarga.ValorCargaAverbacao).Sum();
            if (cte.ValorCarbaAverbacao == 0)
                cte.ValorCarbaAverbacao = cte.ValorTotalMercadoria;

            decimal pesoTotal = 0;
            decimal volumesTotal = 0;
            decimal cubagemTotal = 0;
            if (cte.TipoServico == Dominio.Enumeradores.TipoServico.Redespacho || cte.TipoServico == Dominio.Enumeradores.TipoServico.RedIntermediario || cte.TipoServico == Dominio.Enumeradores.TipoServico.SubContratacao)
            {
                List<Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior> listaDocumentosAnterior = new List<Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior>();

                Dominio.Entidades.Cliente clienteAnterior = null;

                foreach (Dominio.ObjetosDeValor.Embarcador.CTe.CTe objCTe in listaCTes)
                {
                    cte.TipoTomador = Dominio.Enumeradores.TipoTomador.Outros;
                    clienteAnterior = Servicos.Embarcador.Pessoa.Pessoa.Converter(objCTe.Emitente, unidadeDeTrabalho);

                    Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior documentoAnterior = new Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior();
                    documentoAnterior.Chave = objCTe.Chave;
                    documentoAnterior.Emissor = svcCliente.ObterClienteCTE(clienteAnterior, null);
                    listaDocumentosAnterior.Add(documentoAnterior);

                    pesoTotal += (from obj in objCTe.QuantidadesCarga where obj.Unidade == UnidadeMedida.KG select obj.Quantidade).Sum();
                    volumesTotal += (from obj in objCTe.QuantidadesCarga where obj.Unidade == UnidadeMedida.UN select obj.Quantidade).Sum();
                    cubagemTotal += (from obj in objCTe.QuantidadesCarga where obj.Unidade == UnidadeMedida.M3 select obj.Quantidade).Sum();
                }

                if (clienteAnterior != null)
                    cte.SetarParticipante(clienteAnterior, Dominio.Enumeradores.TipoTomador.Outros, null, null);
                this.SalvarInformacoesDocumentosAnteriores(cte, listaDocumentosAnterior, unidadeDeTrabalho, false);
            }

            if (tomador != null)
            {
                cte.TipoTomador = Dominio.Enumeradores.TipoTomador.Outros;
                cte.SetarParticipante(tomador, Dominio.Enumeradores.TipoTomador.Outros, null, null);
            }

            this.SalvarInformacoesDeQuantidadeDaCarga(cte, pesoTotal, volumesTotal, cubagemTotal, unidadeDeTrabalho);

            if ((cte.Empresa.Configuracao != null && empresa.Configuracao.ICMSIsento) || cte.TipoServico == Dominio.Enumeradores.TipoServico.SubContratacao)
            {
                cte.CST = "40";
                svcCTe.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);
                svcCTe.CalcularICMS(ref cte, unidadeDeTrabalho);
            }
            else
                svcCTe.CalcularICMSPorTabelaDeAliquotas(ref cte, cte.SimplesNacional, unidadeDeTrabalho, false);
            //this.CalcularImpostos(ref cte, listaCTes.FirstOrDefault(), string.Empty, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe, unidadeDeTrabalho);

            cte.ValorPrestacaoServico = Math.Round(cte.ValorFrete + valorPedagio + valorOutros, 2, MidpointRounding.ToEven);
            cte.ValorAReceber = Math.Round(cte.ValorFrete + valorPedagio + valorOutros, 2, MidpointRounding.ToEven);

            Dominio.Entidades.ComponentePrestacaoCTE componenteFreteValorCTe = new Dominio.Entidades.ComponentePrestacaoCTE();
            componenteFreteValorCTe.CTE = cte;
            componenteFreteValorCTe.IncluiNaBaseDeCalculoDoICMS = false;
            componenteFreteValorCTe.IncluiNoTotalAReceber = true;
            componenteFreteValorCTe.Nome = "FRETE VALOR";
            componenteFreteValorCTe.Valor = cte.ValorFrete;

            repComponentePrestacao.Inserir(componenteFreteValorCTe);

            if (percentualGris > 0 && cte.ValorTotalMercadoria > 0)
            {
                decimal valorGris = cte.ValorTotalMercadoria * (percentualGris / 100);

                Dominio.Entidades.ComponentePrestacaoCTE componenteGris = new Dominio.Entidades.ComponentePrestacaoCTE();
                componenteGris.CTE = cte;
                componenteGris.IncluiNaBaseDeCalculoDoICMS = true;
                componenteGris.IncluiNoTotalAReceber = true;
                componenteGris.Nome = "GRIS";
                componenteGris.Valor = Math.Round(valorGris, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componenteGris);

                cte.ValorPrestacaoServico = cte.ValorPrestacaoServico + Math.Round(valorGris, 2, MidpointRounding.ToEven);
                cte.ValorAReceber = cte.ValorAReceber + Math.Round(valorGris, 2, MidpointRounding.ToEven);
            }

            if (valorPedagio > 0)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componentePedagioCTe = new Dominio.Entidades.ComponentePrestacaoCTE();
                componentePedagioCTe.CTE = cte;
                componentePedagioCTe.IncluiNaBaseDeCalculoDoICMS = cte.LocalidadeInicioPrestacao.Estado.Sigla == "PR" ? false : true;
                componentePedagioCTe.IncluiNoTotalAReceber = true;
                componentePedagioCTe.Nome = "PEDAGIO";
                componentePedagioCTe.Valor = Math.Round(valorPedagio, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componentePedagioCTe);
            }

            if (valorOutros > 0)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteOutros = new Dominio.Entidades.ComponentePrestacaoCTE();
                componenteOutros.CTE = cte;
                componenteOutros.IncluiNaBaseDeCalculoDoICMS = true;
                componenteOutros.IncluiNoTotalAReceber = true;
                componenteOutros.Nome = "OUTROS";
                componenteOutros.Valor = Math.Round(valorOutros, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componenteOutros);
            }

            if (cte.AliquotaICMS > 0)
            {
                if (cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim)
                {
                    cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Sim;
                    cte.BaseCalculoICMS = cte.ValorAReceber;
                    cte.ValorICMS = Math.Round(cte.BaseCalculoICMS * (cte.AliquotaICMS / 100), 2, MidpointRounding.ToEven);
                    cte.PercentualICMSIncluirNoFrete = 100;

                    cte.BaseCalculoICMS = Math.Round(cte.ValorAReceber / (1 - (cte.AliquotaICMS / 100)), 2, MidpointRounding.ToEven);
                    cte.ValorICMS = Math.Round(cte.BaseCalculoICMS * (cte.AliquotaICMS / 100), 2, MidpointRounding.ToEven);

                    decimal valorImpostoIncluso = Math.Round(cte.BaseCalculoICMS - cte.ValorPrestacaoServico, 2, MidpointRounding.ToEven);
                    if (valorImpostoIncluso > 0)
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteImpostoCTe = new Dominio.Entidades.ComponentePrestacaoCTE();
                        componenteImpostoCTe.CTE = cte;
                        componenteImpostoCTe.IncluiNaBaseDeCalculoDoICMS = false;
                        componenteImpostoCTe.IncluiNoTotalAReceber = false;
                        componenteImpostoCTe.Nome = "IMPOSTOS";
                        componenteImpostoCTe.Valor = Math.Round(valorImpostoIncluso, 2, MidpointRounding.ToEven);

                        repComponentePrestacao.Inserir(componenteImpostoCTe);
                    }

                    cte.ValorPrestacaoServico = cte.BaseCalculoICMS;
                    cte.ValorAReceber = cte.BaseCalculoICMS;
                }
                else
                {
                    cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Nao;

                    cte.BaseCalculoICMS = Math.Round(cte.ValorAReceber * (1 - (cte.PercentualReducaoBaseCalculoICMS / 100)), 2, MidpointRounding.ToEven);
                    cte.ValorICMS = Math.Round(cte.BaseCalculoICMS * (cte.AliquotaICMS / 100), 2, MidpointRounding.ToEven);
                }
            }

            cte.Lotacao = Dominio.Enumeradores.OpcaoSimNao.Nao;
            if (cte.Empresa.Configuracao != null && cte.Empresa.Configuracao.IndicadorDeLotacao)
                cte.Lotacao = Dominio.Enumeradores.OpcaoSimNao.Sim;

            List<Dominio.Entidades.MotoristaCTE> motoristasCTe = new List<Dominio.Entidades.MotoristaCTE>();

            cte.Status = "S";
            cte.Cancelado = "N";
            cte.TipoControle = 1;
            cte.Numero = ObterProximoNumero(cte, repCTe);

            svcCTe.SalvarInformacoesDeSeguroDaCarga(cte, unidadeDeTrabalho);

            svcCTe.SetarPartilhaICMS(ref cte, unidadeDeTrabalho);

            if (usuarioAdministrativo != null)
            {
                cte.Log = string.Concat(usuarioAdministrativo.CPF, " - ", usuarioAdministrativo.Nome);
                cte.Usuario = usuarioAdministrativo;
            }
            else if (usuario != null)
            {
                cte.Log = string.Concat(usuario.CPF, " - ", usuario.Nome);
                cte.Usuario = usuario;
            }

            Servicos.CTe.SetarTomadorPagadorCTe(ref cte);

            Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE indicadorTomador = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS;

            if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Remetente)
                indicadorTomador = !String.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Remetente.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Remetente.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
            else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Destinatario)
                indicadorTomador = !String.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Destinatario.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Destinatario.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
            else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Recebedor && cte.Recebedor != null)
                indicadorTomador = !String.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Recebedor.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Recebedor.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
            else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Recebedor && cte.Expedidor != null)
                indicadorTomador = !String.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Expedidor.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Expedidor.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
            else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Recebedor && cte.OutrosTomador != null)
                indicadorTomador = !String.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.OutrosTomador.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.OutrosTomador.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;

            cte.IndicadorIETomador = indicadorTomador; //CTe 3.0

            if (tracao != null)
            {
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);

                Dominio.Entidades.VeiculoCTE veiculoCTe = new Dominio.Entidades.VeiculoCTE();

                veiculoCTe.CTE = cte;
                veiculoCTe.Veiculo = tracao;
                veiculoCTe.SetarDadosVeiculo(tracao);

                repVeiculoCTe.Inserir(veiculoCTe);
            }

            if (reboque != null)
            {
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);

                Dominio.Entidades.VeiculoCTE veiculoCTe = new Dominio.Entidades.VeiculoCTE();

                veiculoCTe.CTE = cte;
                veiculoCTe.Veiculo = reboque;
                veiculoCTe.SetarDadosVeiculo(reboque);

                repVeiculoCTe.Inserir(veiculoCTe);
            }

            if (motorista != null)
            {
                Repositorio.MotoristaCTE repMotoristaCTe = new Repositorio.MotoristaCTE(unidadeDeTrabalho);

                Dominio.Entidades.MotoristaCTE motoristaCTe = new Dominio.Entidades.MotoristaCTE();

                motoristaCTe.CPFMotorista = motorista.CPF;
                motoristaCTe.CTE = cte;
                motoristaCTe.NomeMotorista = motorista.Nome;

                repMotoristaCTe.Inserir(motoristaCTe);
            }


            repCTe.Atualizar(cte);

            return cte;
        }

        public Dominio.Entidades.ConhecimentoDeTransporteEletronico GerarCTePorListaNFe(List<Dominio.ObjetosDeValor.NFeAdmin> notasFiscais, int codigoEmpresa, DateTime dataEmissao, decimal valorFrete = 0, decimal valorTotalMercadoria = 0, string observacao = "", bool gerarLog = false, Dominio.Entidades.Usuario usuario = null, List<Dominio.Entidades.Veiculo> veiculos = null)
        {
            Repositorio.UnitOfWork unidadeDeTrabalho = new Repositorio.UnitOfWork(StringConexao);

            try
            {
                NFe servicoNFe = new NFe(unidadeDeTrabalho);
                Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeDeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
                Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);
                Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeDeTrabalho);
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);
                Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeDeTrabalho);

                Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCodigo(codigoEmpresa);
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                unidadeDeTrabalho.Start();

                Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();
                Dominio.Entidades.Cliente clienteRemetente = null;
                Dominio.Entidades.Cliente clienteDestinatario = null;

                cte.Empresa = empresa;

                if (notasFiscais[0].NFe2 != null)
                {
                    clienteRemetente = servicoNFe.ObterEmitente(notasFiscais[0].NFe2.NFe.infNFe.emit, codigoEmpresa);
                    cte.SetarParticipante(clienteRemetente, Dominio.Enumeradores.TipoTomador.Remetente, null, repDadosCliente.Buscar(codigoEmpresa, clienteRemetente.CPF_CNPJ));

                    clienteDestinatario = servicoNFe.ObterDestinatario(notasFiscais[0].NFe2.NFe.infNFe.dest, codigoEmpresa);
                    cte.SetarParticipante(clienteDestinatario, Dominio.Enumeradores.TipoTomador.Destinatario, null, repDadosCliente.Buscar(codigoEmpresa, clienteDestinatario.CPF_CNPJ));

                    cte.TipoPagamento = servicoNFe.ObterFormaPagamento(notasFiscais[0].NFe2.NFe.infNFe.transp);

                    cte.TipoTomador = servicoNFe.ObterTipoTomador(notasFiscais[0].NFe2.NFe.infNFe.transp);
                }
                else if (notasFiscais[0].NFe3 != null)
                {
                    clienteRemetente = servicoNFe.ObterEmitente(notasFiscais[0].NFe3.NFe.infNFe.emit, codigoEmpresa);
                    cte.SetarParticipante(clienteRemetente, Dominio.Enumeradores.TipoTomador.Remetente, null, repDadosCliente.Buscar(codigoEmpresa, clienteRemetente.CPF_CNPJ));

                    clienteDestinatario = servicoNFe.ObterDestinatario(notasFiscais[0].NFe3.NFe.infNFe.dest, codigoEmpresa);
                    cte.SetarParticipante(clienteDestinatario, Dominio.Enumeradores.TipoTomador.Destinatario, null, repDadosCliente.Buscar(codigoEmpresa, clienteDestinatario.CPF_CNPJ));

                    cte.TipoPagamento = servicoNFe.ObterFormaPagamento(notasFiscais[0].NFe3.NFe.infNFe.transp);

                    cte.TipoTomador = servicoNFe.ObterTipoTomador(notasFiscais[0].NFe3.NFe.infNFe.transp);
                }
                else if (notasFiscais[0].NFe4 != null)
                {
                    clienteRemetente = servicoNFe.ObterEmitente(notasFiscais[0].NFe4.NFe.infNFe.emit, codigoEmpresa);
                    cte.SetarParticipante(clienteRemetente, Dominio.Enumeradores.TipoTomador.Remetente, null, repDadosCliente.Buscar(codigoEmpresa, clienteRemetente.CPF_CNPJ));

                    clienteDestinatario = servicoNFe.ObterDestinatario(notasFiscais[0].NFe4.NFe.infNFe.dest, codigoEmpresa);
                    cte.SetarParticipante(clienteDestinatario, Dominio.Enumeradores.TipoTomador.Destinatario, null, repDadosCliente.Buscar(codigoEmpresa, clienteDestinatario.CPF_CNPJ));

                    cte.TipoPagamento = servicoNFe.ObterFormaPagamento(notasFiscais[0].NFe4.NFe.infNFe.transp);

                    cte.TipoTomador = servicoNFe.ObterTipoTomador(notasFiscais[0].NFe4.NFe.infNFe.transp);
                }

                cte.ValorFrete = valorFrete > 0 ? valorFrete : ((from obj in notasFiscais where obj.NFe2 != null select decimal.Parse(obj.NFe2.NFe.infNFe.total.ICMSTot.vFrete, cultura)).Sum() +
                                                               (from obj in notasFiscais where obj.NFe3 != null select decimal.Parse(obj.NFe3.NFe.infNFe.total.ICMSTot.vFrete, cultura)).Sum() +
                                                               (from obj in notasFiscais where obj.NFe4 != null select decimal.Parse(obj.NFe4.NFe.infNFe.total.ICMSTot.vFrete, cultura)).Sum());

                cte.ValorTotalMercadoria = valorTotalMercadoria > 0 ? valorTotalMercadoria : ((from obj in notasFiscais where obj.NFe2 != null select decimal.Parse(obj.NFe2.NFe.infNFe.total.ICMSTot.vNF, cultura)).Sum() +
                                                                                             (from obj in notasFiscais where obj.NFe3 != null select decimal.Parse(obj.NFe3.NFe.infNFe.total.ICMSTot.vNF, cultura)).Sum() +
                                                                                             (from obj in notasFiscais where obj.NFe4 != null select decimal.Parse(obj.NFe4.NFe.infNFe.total.ICMSTot.vNF, cultura)).Sum());

                cte.LocalidadeEmissao = cte.Empresa.Localidade;

                cte.LocalidadeInicioPrestacao = cte.Remetente.Localidade;

                cte.LocalidadeTerminoPrestacao = cte.Destinatario.Localidade;

                cte.ValorPrestacaoServico = cte.ValorFrete;

                cte.ValorAReceber = cte.ValorFrete;

                cte.ProdutoPredominante = cte.Empresa.Configuracao.ProdutoPredominante;

                cte.OutrasCaracteristicasDaCarga = cte.Empresa.Configuracao.OutrasCaracteristicas;

                cte.ExibeICMSNaDACTE = true;

                if (cte.Empresa.Localidade.Estado.Sigla != cte.LocalidadeInicioPrestacao.Estado.Sigla)
                    cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Nao;
                else
                    cte.SimplesNacional = cte.Empresa.OptanteSimplesNacional ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao;

                this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);

                cte.Retira = Dominio.Enumeradores.OpcaoSimNao.Nao;

                cte.RNTRC = cte.Empresa.RegistroANTT;

                cte.DataPrevistaEntrega = DateTime.Now.AddDays(cte.Empresa.Configuracao.DiasParaEntrega);

                cte.TipoAmbiente = empresa.TipoAmbiente;

                cte.TipoCTE = Dominio.Enumeradores.TipoCTE.Normal;

                cte.TipoEmissao = "1";

                cte.TipoEnvio = 0;

                cte.TipoImpressao = cte.Empresa.Configuracao.TipoImpressao;

                cte.TipoServico = Dominio.Enumeradores.TipoServico.Normal;

                cte.DataEmissao = dataEmissao != DateTime.MinValue ? dataEmissao : DateTime.Now;

                //cte.ModalTransporte = repModalTransporte.BuscarPorNumero((int)cteIntegracao.TipoModal > 0 ? cteIntegracao.TipoModal.ToString("D") : "1");
                cte.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);

                cte.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("57");

                if (veiculos != null && veiculos.Count > 0)
                    cte.Lotacao = Dominio.Enumeradores.OpcaoSimNao.Sim;
                else
                    cte.Lotacao = Dominio.Enumeradores.OpcaoSimNao.Nao;

                cte.Serie = this.ObterSerie(empresa, cte.LocalidadeEmissao.Estado.Sigla, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, cte.Remetente?.CPF_CNPJ ?? string.Empty, cte.Destinatario?.CPF_CNPJ ?? string.Empty, cte.Recebedor?.CPF_CNPJ ?? string.Empty, cte.Expedidor?.CPF_CNPJ ?? string.Empty, cte.TomadorPagador?.CPF_CNPJ ?? string.Empty, unidadeDeTrabalho);

                cte.Versao = cte.Empresa.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.Configuracao.VersaoCTe) ? cte.Empresa.Configuracao.VersaoCTe : cte.Empresa.EmpresaPai.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.EmpresaPai.Configuracao.VersaoCTe) ? cte.Empresa.EmpresaPai.Configuracao.VersaoCTe : "4.00"; //cte.Empresa.Versao;

                cte.ObservacoesGerais = observacao;

                repCTe.Inserir(cte);

                this.SalvarInformacoesDeSeguroDaCarga(cte, cte.Empresa.Configuracao.ResponsavelSeguro, unidadeDeTrabalho, empresa.Configuracao != null && empresa.Configuracao.ApoliceSeguro != null ? empresa.Configuracao.ApoliceSeguro : null);

                this.SalvarInformacoesComponentesDaPrestacao(cte, "FRETE VALOR", cte.ValorFrete, false, true, unidadeDeTrabalho);

                this.SalvarInformacoesDeQuantidadeDaCarga(cte, notasFiscais, unidadeDeTrabalho);

                this.SalvarInformacoesNFes(cte, notasFiscais, unidadeDeTrabalho);

                this.SalvarInformacoesVeiculos(cte, veiculos, unidadeDeTrabalho);

                if (empresa.Configuracao != null)
                {
                    if (empresa.Configuracao.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim)
                    {
                        cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Sim;
                        cte.PercentualICMSIncluirNoFrete = 100;
                    }
                    else
                    {
                        cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Nao;
                    }
                }
                else if (empresa.EmpresaPai != null && empresa.EmpresaPai.Configuracao != null)
                {
                    if (empresa.EmpresaPai.Configuracao.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim)
                    {
                        cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Sim;
                        cte.PercentualICMSIncluirNoFrete = 100;
                    }
                    else
                    {
                        cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Nao;
                    }
                }
                else
                {
                    cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Nao;
                }

                if (empresa.Configuracao.ICMSIsento)
                {
                    cte.CST = "40";
                    this.CalcularICMS(ref cte, unidadeDeTrabalho);
                }
                else
                {
                    this.CalcularICMSPorTabelaDeAliquotas(ref cte, cte.SimplesNacional, unidadeDeTrabalho);
                }

                cte.Status = "E";

                cte.Cancelado = "N";

                cte.Numero = ObterProximoNumero(cte, repCTe);

                if (gerarLog && usuario != null)
                    cte.Log = string.Concat("[Admin] Criado por ", usuario.CPF, " - ", usuario.Nome, " em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");

                this.SetarPartilhaICMS(ref cte, unidadeDeTrabalho);

                SetarTomadorPagadorCTe(ref cte);

                repCTe.Atualizar(cte);

                unidadeDeTrabalho.CommitChanges();

                return cte;
            }
            catch
            {
                unidadeDeTrabalho.Rollback();
                throw;
            }
        }

        public Dominio.Entidades.ConhecimentoDeTransporteEletronico GerarCTePorTxt(Dominio.NDDigital.v104.Emissao.Registro11000 arquivoCTe, int codigoEmpresa, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            NDDigital servicoNDDigital = new NDDigital(unidadeDeTrabalho);

            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeDeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);
            Repositorio.EmpresaSerie repSerie = new Repositorio.EmpresaSerie(unidadeDeTrabalho);
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeDeTrabalho);
            Repositorio.Aliquota repAliquota = new Repositorio.Aliquota(unidadeDeTrabalho);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);
            Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeDeTrabalho);

            Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCodigo(codigoEmpresa);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();

            cte.Empresa = empresa;

            cte.SetarParticipante(servicoNDDigital.ObterRemetente(arquivoCTe.rem, codigoEmpresa, unidadeDeTrabalho), Dominio.Enumeradores.TipoTomador.Remetente);

            cte.SetarParticipante(servicoNDDigital.ObterExpedidor(arquivoCTe.exped, codigoEmpresa, unidadeDeTrabalho), Dominio.Enumeradores.TipoTomador.Expedidor);

            cte.SetarParticipante(servicoNDDigital.ObterRecebedor(arquivoCTe.receb, codigoEmpresa, unidadeDeTrabalho), Dominio.Enumeradores.TipoTomador.Recebedor);

            cte.SetarParticipante(servicoNDDigital.ObterDestinatario(arquivoCTe.dest, codigoEmpresa, unidadeDeTrabalho), Dominio.Enumeradores.TipoTomador.Destinatario);

            cte.TipoTomador = (arquivoCTe.ide.toma03 != null ? (Dominio.Enumeradores.TipoTomador)arquivoCTe.ide.toma03.toma : Dominio.Enumeradores.TipoTomador.Outros);

            cte.SetarParticipante((cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Outros ? servicoNDDigital.ObterTomador(arquivoCTe.ide.toma4, codigoEmpresa, unidadeDeTrabalho) : null), Dominio.Enumeradores.TipoTomador.Outros);

            Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE indicadorTomador = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS;

            if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Remetente)
                indicadorTomador = !String.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Remetente.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Remetente.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
            else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Destinatario)
                indicadorTomador = !String.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Destinatario.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Destinatario.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
            else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Recebedor && cte.Recebedor != null)
                indicadorTomador = !String.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Recebedor.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Recebedor.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
            else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Recebedor && cte.Expedidor != null)
                indicadorTomador = !String.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Expedidor.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Expedidor.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
            else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Recebedor && cte.OutrosTomador != null)
                indicadorTomador = !String.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.OutrosTomador.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.OutrosTomador.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;

            cte.IndicadorIETomador = indicadorTomador; //CTe 3.0

            cte.LocalidadeEmissao = repLocalidade.BuscarPorCodigoIBGE(arquivoCTe.ide.cMunEnv);

            cte.LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(arquivoCTe.ide.cMunIni);

            cte.LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(arquivoCTe.ide.cMunFim);

            cte.TipoPagamento = (Dominio.Enumeradores.TipoPagamento)arquivoCTe.ide.forPag;

            cte.IncluirICMSNoFrete = arquivoCTe.imp.incluirICMSNoFrete == 1 ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao;

            cte.PercentualICMSIncluirNoFrete = arquivoCTe.imp.percentualICMSRecolhido;

            cte.ValorFrete = arquivoCTe.vPrest.vTPrest;

            cte.ValorPrestacaoServico = arquivoCTe.vPrest.vTPrest;

            cte.ValorAReceber = arquivoCTe.vPrest.vRec;

            cte.ValorTotalMercadoria = arquivoCTe.infCTeNorm.infCarga.vCarga;

            cte.ProdutoPredominante = arquivoCTe.infCTeNorm.infCarga.proPred;

            cte.SimplesNacional = arquivoCTe.imp.ICMSSN != null ? Dominio.Enumeradores.OpcaoSimNao.Sim : (empresa.OptanteSimplesNacional ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao);

            cte.Retira = arquivoCTe.ide.retira == 0 ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao;

            cte.RNTRC = cte.Empresa.RegistroANTT;

            cte.DataPrevistaEntrega = DateTime.Now.AddDays(cte.Empresa.Configuracao.DiasParaEntrega);

            cte.TipoAmbiente = empresa.TipoAmbiente;

            cte.TipoCTE = arquivoCTe.ide.tpCTe == 0 ? Dominio.Enumeradores.TipoCTE.Normal : arquivoCTe.ide.tpCTe == 1 ? Dominio.Enumeradores.TipoCTE.Complemento : arquivoCTe.ide.tpCTe == 2 ? Dominio.Enumeradores.TipoCTE.Anulacao : arquivoCTe.ide.tpCTe == 3 ? Dominio.Enumeradores.TipoCTE.Substituto : Dominio.Enumeradores.TipoCTE.Normal;

            cte.TipoEmissao = "1";

            cte.TipoEnvio = 0;

            cte.TipoImpressao = cte.Empresa.Configuracao.TipoImpressao;

            cte.TipoServico = Dominio.Enumeradores.TipoServico.Normal;

            cte.DataEmissao = arquivoCTe.ide.dhEmi != DateTime.MinValue ? arquivoCTe.ide.dhEmi : DateTime.Now;

            //cte.ModalTransporte = repModalTransporte.BuscarPorNumero((int)cteIntegracao.TipoModal > 0 ? cteIntegracao.TipoModal.ToString("D") : "1");
            cte.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);

            cte.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("57");

            cte.Lotacao = Dominio.Enumeradores.OpcaoSimNao.Nao;

            cte.ExibeICMSNaDACTE = true;

            cte.Serie = this.ObterSerie(empresa, cte.LocalidadeEmissao.Estado.Sigla, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, cte.Remetente?.CPF_CNPJ ?? string.Empty, cte.Destinatario?.CPF_CNPJ ?? string.Empty, cte.Recebedor?.CPF_CNPJ ?? string.Empty, cte.Expedidor?.CPF_CNPJ ?? string.Empty, cte.TomadorPagador?.CPF_CNPJ ?? string.Empty, unidadeDeTrabalho);

            cte.Versao = cte.Empresa.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.Configuracao.VersaoCTe) ? cte.Empresa.Configuracao.VersaoCTe : cte.Empresa.EmpresaPai.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.EmpresaPai.Configuracao.VersaoCTe) ? cte.Empresa.EmpresaPai.Configuracao.VersaoCTe : "4.00"; //cte.Empresa.Versao;

            cte.ObservacoesGerais = arquivoCTe.compl.xObs;

            this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);

            repCTe.Inserir(cte);

            this.CalcularImpostos(ref cte, arquivoCTe.imp, arquivoCTe.vPrest.comp, null, unidadeDeTrabalho);

            this.SalvarInformacoesDeSeguroDaCarga(cte, arquivoCTe.infCTeNorm.seg, unidadeDeTrabalho);

            this.SalvarInformacoesComponentesDaPrestacao(cte, arquivoCTe.vPrest.comp, unidadeDeTrabalho);

            this.SalvarInformacoesDeQuantidadeDaCarga(cte, arquivoCTe.infCTeNorm.infCarga.infQ, unidadeDeTrabalho);

            this.SalvarInformacoesNFs(cte, arquivoCTe.rem.infNF, unidadeDeTrabalho);

            this.SalvarInformacoesNFes(cte, arquivoCTe.rem.infNFe, unidadeDeTrabalho);

            this.SalvarInformacoesOutrosDocumentos(cte, arquivoCTe.rem.infOutros, unidadeDeTrabalho);

            this.SalvarInformacoesVeiculos(cte, arquivoCTe.infCTeNorm.infModal, unidadeDeTrabalho);

            if (cte.TipoCTE == Dominio.Enumeradores.TipoCTE.Complemento)
                cte.ChaveCTESubComp = arquivoCTe.infCteComp.chave;

            cte.Status = "E";

            cte.Cancelado = "N";

            cte.Numero = ObterProximoNumero(cte, repCTe);

            this.SetarPartilhaICMS(ref cte, unidadeDeTrabalho);

            SetarTomadorPagadorCTe(ref cte);

            repCTe.Atualizar(cte);

            return cte;
        }

        public Dominio.Entidades.ConhecimentoDeTransporteEletronico GerarCTePorObjeto(Dominio.ObjetosDeValor.CTe.CTe cteIntegracao, int codigoCTe, Repositorio.UnitOfWork unitOfWork = null, string tipoEmissao = "1", int tipoEnvio = 0, string status = "E", Dominio.Entidades.ModeloDocumentoFiscal modeloDocumentoFiscal = null, int numeroDocumento = 0, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware = null, Dominio.Entidades.Empresa empresa = null, int codigoCarga = 0, string descricaoComponentePadrao = "FRETE VALOR", string descricaoComponenteImposto = "IMPOSTOS", bool naoGerarDocumentoAnterior = false, Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacao = null)
        {
            Repositorio.UnitOfWork unidadeDeTrabalho = unitOfWork ?? new Repositorio.UnitOfWork(StringConexao);
            //Servicos.Log.GravarInfo("GerarCTePorObjeto - CTe: " + (cteIntegracao != null ? Newtonsoft.Json.JsonConvert.SerializeObject(cteIntegracao) : string.Empty));
            try
            {
                Servicos.CTe servicoCte = new Servicos.CTe(unitOfWork);
                Servicos.Embarcador.Fatura.Fatura servFatura = new Servicos.Embarcador.Fatura.Fatura(unidadeDeTrabalho);

                Repositorio.Embarcador.Pedidos.PedidoViagemNavioSchedule repPedidoNavioSchedule = new Repositorio.Embarcador.Pedidos.PedidoViagemNavioSchedule(unidadeDeTrabalho);
                Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeDeTrabalho);
                Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeDeTrabalho);
                Repositorio.NaturezaDaOperacao repNaturezaDaOperacao = new Repositorio.NaturezaDaOperacao(unidadeDeTrabalho);
                Repositorio.Aliquota repAliquota = new Repositorio.Aliquota(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);
                Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeDeTrabalho);
                Repositorio.EmpresaSerie repSerie = new Repositorio.EmpresaSerie(unidadeDeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);
                Repositorio.Cliente repositorioCliente = new Repositorio.Cliente(unidadeDeTrabalho);

                Servicos.Log.GravarInfo("Iniciou geração CT-e - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                if (empresa == null)
                    empresa = repEmpresa.BuscarPorCNPJ(cteIntegracao.Emitente.CNPJ);

                Servicos.Log.GravarInfo("Iniciou transação - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                if (unitOfWork == null)
                    unidadeDeTrabalho.Start();

                if (cteIntegracao.Emitente.Atualizar)
                    empresa = Servicos.Empresa.AtualizarEmpresa(empresa.Codigo, cteIntegracao.Emitente, unidadeDeTrabalho);

                Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = codigoCTe > 0 ? repCTe.BuscarPorCodigo(codigoCTe) : new Dominio.Entidades.ConhecimentoDeTransporteEletronico();

                cte.PercentualPagamentoAgregado = cteIntegracao.PercentualPagamentoAgregado;
                cte.Peso = cteIntegracao.Peso;
                cte.PesoLiquido = cteIntegracao.PesoLiquido;
                cte.FatorCubagem = cteIntegracao.FatorCubagem;
                cte.PesoCubado = cteIntegracao.PesoCubado;
                cte.PesoFaturado = cteIntegracao.PesoFaturado;
                cte.Volumes = cteIntegracao.Volumes;
                cte.MetrosCubicos = cteIntegracao.MetrosCubicos;
                cte.Pallets = cteIntegracao.Pallets;
                cte.CaracteristicaTransporte = cteIntegracao.CaracteristicaTransporte;
                cte.CaracteristicaServico = cteIntegracao.CaracteristicaServico;
                cte.TipoCTeIntegracao = cteIntegracao.TipoCTeIntegracao;
                cte.ValorTotalMoeda = cteIntegracao.ValorTotalMoeda;
                cte.ValorCotacaoMoeda = cteIntegracao.ValorCotacaoMoeda;
                cte.Moeda = cteIntegracao.Moeda;
                cte.TipoConhecimentoProceda = cteIntegracao.TipoConhecimentoProceda;

                cte.LogIntegracao += "Gerado no servidor (MachineName: " + System.Environment.MachineName + "). Aplicação (" + System.Reflection.Assembly.GetExecutingAssembly().CodeBase + "). ";

                cte.Versao = !string.IsNullOrWhiteSpace(cteIntegracao.Versao) ? cteIntegracao.Versao : empresa.Configuracao != null && !string.IsNullOrWhiteSpace(empresa.Configuracao.VersaoCTe) ? empresa.Configuracao.VersaoCTe : empresa.EmpresaPai.Configuracao != null && !string.IsNullOrWhiteSpace(empresa.EmpresaPai.Configuracao.VersaoCTe) ? empresa.EmpresaPai.Configuracao.VersaoCTe : "4.00";

                cte.IndicadorGlobalizado = cteIntegracao.indicadorGlobalizado; //CTe 3.0

                cte.ValorCarbaAverbacao = cteIntegracao.ValorCargaAverbacao; //CTe 3.0

                cte.Empresa = empresa;

                cte.TipoTomador = cteIntegracao.TipoTomador;

                cte.TipoPagamento = cteIntegracao.TipoPagamento;

                cte.IncluirICMSNoFrete = cteIntegracao.IncluirICMSNoFrete;

                cte.IncluirISSNoFrete = cteIntegracao.IncluirISSNoFrete;

                cte.PercentualICMSIncluirNoFrete = cteIntegracao.PercentualICMSIncluirNoFrete;

                cte.ValorFrete = cteIntegracao.ValorFrete;

                cte.ValorPrestacaoServico = cteIntegracao.ValorTotalPrestacaoServico;

                cte.ValorAReceber = cteIntegracao.ValorAReceber;

                cte.ExibeICMSNaDACTE = cteIntegracao.ExibeICMSNaDACTE;

                cte.ValorTotalMercadoria = Math.Round(cteIntegracao.ValorTotalMercadoria, 2, MidpointRounding.ToEven);

                cte.ValorTotalDocumentoFiscal = Math.Round(cteIntegracao.ValorTotalDocumentoFiscal, 2, MidpointRounding.ToEven);

                cte.ValorImpostoSuspenso = Math.Round(cteIntegracao.ValorImpostoSuspenso, 2, MidpointRounding.ToEven);

                cte.ProdutoPredominante = Utilidades.String.Left(!string.IsNullOrWhiteSpace(cteIntegracao.ProdutoPredominante) ? cteIntegracao.ProdutoPredominante : !string.IsNullOrWhiteSpace(cte.Empresa.Configuracao?.ProdutoPredominante) ? cte.Empresa.Configuracao.ProdutoPredominante : "DIVERSOS", 60);

                cte.ProdutoPredominanteCEAN = Utilidades.String.Left(cteIntegracao.ProdutoPredominanteCEAN.ObterSomenteNumeros(), 14);

                cte.ProdutoPredominanteNCM = Utilidades.String.Left(cteIntegracao.ProdutoPredominanteNCM.ObterSomenteNumeros(), 8);

                cte.CodigoProdutoEmbarcador = !string.IsNullOrWhiteSpace(cteIntegracao.CodigoProdutoEmbarcador) ? cteIntegracao.CodigoProdutoEmbarcador.Length > 50 ? cteIntegracao.CodigoProdutoEmbarcador.Substring(0, 50) : cteIntegracao.CodigoProdutoEmbarcador : string.Empty;

                cte.Retira = cteIntegracao.Retira;

                cte.DetalhesRetira = cteIntegracao.DetalhesRetira;

                cte.RNTRC = Utilidades.String.Right(cte.Empresa.RegistroANTT, 8);

                cte.CIOT = cteIntegracao.CIOT;

                DateTime dataPrevistaEntrega = DateTime.MinValue;
                if (cteIntegracao.DataPrevistaEntrega != null)
                    DateTime.TryParseExact(cteIntegracao.DataPrevistaEntrega, "dd/MM/yyyy HH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataPrevistaEntrega);

                //Quando está alterando o CTe e não é enviado a data/hora não altera a data/hora de previsão do CTe (Erro de digest ao reenviar via WS)
                if (codigoCTe > 0 && dataPrevistaEntrega > DateTime.MinValue)
                    cte.DataPrevistaEntrega = dataPrevistaEntrega;
                else if (codigoCTe == 0 || cte.DataPrevistaEntrega == null || cte.DataPrevistaEntrega == DateTime.MinValue)
                    cte.DataPrevistaEntrega = dataPrevistaEntrega == DateTime.MinValue ? DateTime.Now.AddDays(cte.Empresa.Configuracao?.DiasParaEntrega ?? 0) : dataPrevistaEntrega;

                cte.TipoAmbiente = empresa.TipoAmbiente;

                cte.TipoCTE = cteIntegracao.TipoCTe;

                cte.TipoEmissao = tipoEmissao;

                cte.TipoEnvio = tipoEnvio == 1 ? empresa.EmpresaPai != null && empresa.EmpresaPai.Configuracao != null && !string.IsNullOrWhiteSpace(empresa.EmpresaPai.Configuracao.NumeroLoteEmissaoCTe) ? int.Parse(empresa.EmpresaPai.Configuracao.NumeroLoteEmissaoCTe) : tipoEnvio : tipoEnvio;

                if (modeloDocumentoFiscal == null)
                    cte.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorTipoDocumento(Dominio.Enumeradores.TipoDocumento.CTe);
                else
                    cte.ModeloDocumentoFiscal = modeloDocumentoFiscal;

                if ((cte.Empresa?.Configuracao?.PossuiIntegracaoMigrate ?? false))
                {
                    if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFSe)
                        cte.SistemaEmissor = TipoEmissorDocumento.Migrate;
                }

                cte.DocumentoOperacaoContainer = cteIntegracao.DocumentoOperacaoContainer;

                // Caso esteja configurado para utilizar várias filas de processamento, atualiza o tipoenvio pegando a próxima fila de acordo com a fila utilizada na emissão anterior.
                if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.CTe)
                    cte.TipoEnvio = Servicos.Embarcador.CTe.FilaEnvioIntegradorInstance.GetInstance(unitOfWork).BuscarProximaFilaEnvioIntegrador(cte.TipoEnvio);

                cte.TipoImpressao = cteIntegracao.TipoImpressao <= 0 && empresa.Configuracao != null ? empresa.Configuracao.TipoImpressao : cteIntegracao.TipoImpressao;

                cte.TipoServico = cteIntegracao.TipoServico;

                DateTime dataEmissao = DateTime.MinValue;
                if (!string.IsNullOrWhiteSpace(cteIntegracao.DataEmissao) && cteIntegracao.DataEmissao.Length >= 16)
                    DateTime.TryParseExact(string.Concat(cteIntegracao.DataEmissao.Substring(0, 16), ":00"), "dd/MM/yyyy HH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataEmissao);

                TimeZoneInfo fusoHorarioEmpresa = TimeZoneInfo.FindSystemTimeZoneById(cte.Empresa.FusoHorario);

                DateTime dataFuso = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day, DateTime.Now.Hour, DateTime.Now.Minute, 0);
                dataFuso = TimeZoneInfo.ConvertTime(dataFuso, TimeZoneInfo.Local, fusoHorarioEmpresa);

                //Quando está alterando o CTe e não é enviado a data/hora não altera a data/hora de emissão do CTe
                if (codigoCTe > 0 && dataEmissao > DateTime.MinValue)
                    cte.DataEmissao = dataEmissao;
                else if (codigoCTe == 0 || cte.DataEmissao == null || cte.DataEmissao == DateTime.MinValue)
                    cte.DataEmissao = dataEmissao == DateTime.MinValue ? dataFuso : dataEmissao;

                if (codigoCTe == 0 || cte.DataIntegracao == null)
                    cte.DataIntegracao = DateTime.Now;

                //cte.ModalTransporte = repModalTransporte.BuscarPorId(1);
                cte.ModalTransporte = repModalTransporte.BuscarPorNumero((int)cteIntegracao.TipoModal > 0 ? cteIntegracao.TipoModal.ToString("D") : "1");
                if (VerificarMultiModalPorTipoVeiculo(cteIntegracao, empresa))
                {
                    Dominio.Entidades.ModalTransporte modalMultimodal = repModalTransporte.BuscarPorNumero("6");
                    if (modalMultimodal != null)
                        cte.ModalTransporte = modalMultimodal;
                }

                if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFSe)
                {
                    cte.SerieRPS = Utilidades.String.Left(cteIntegracao.SerieRPS, 8);
                    cte.NaoEnviarAliquotaEValorISS = cteIntegracao.NaoEnviarAliquotaEValorISS;
                    if (cteIntegracao.NaturezaNFSe != null && cteIntegracao.NaturezaNFSe.CodigoInterno > 0)
                    {
                        Repositorio.NaturezaNFSe repNaturezaNFSe = new Repositorio.NaturezaNFSe(unidadeDeTrabalho);
                        cte.NaturezaNFSe = repNaturezaNFSe.BuscarPorCodigo(cteIntegracao.NaturezaNFSe.CodigoInterno);
                    }
                }

                if (cte.ModeloDocumentoFiscal.GerarISSAutomaticamente || cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFSe || cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFS)
                {
                    if (cteIntegracao.ISS != null)
                    {
                        cte.AliquotaISS = cteIntegracao.ISS.Aliquota;
                        cte.ISSRetido = cteIntegracao.ISS.PercentualRetencao > 0m ? true : false;
                        cte.PercentualISSRetido = cteIntegracao.ISS.PercentualRetencao;
                        cte.ValorISSRetido = cteIntegracao.ISS.ValorRetencao;
                        cte.BaseCalculoISS = cteIntegracao.ISS.BaseCalculo;
                        cte.ValorISS = cteIntegracao.ISS.Valor;
                    }

                    cte.ValorDeducoes = cteIntegracao.ValorDeducoes;
                    cte.ValorDescontoIncondicionado = cteIntegracao.ValorDescontoIncondicionado;
                    cte.ValorOutrasRetencoes = cteIntegracao.ValorOutrasRetencoes;
                    cte.ValorDescontoCondicionado = cteIntegracao.ValorDescontoCondicionado;

                    if (cteIntegracao.PIS != null)
                    {
                        cte.ValorPIS = cteIntegracao.PIS.Valor;
                        cte.AliquotaPIS = cteIntegracao.PIS.Aliquota;
                        cte.BasePIS = cteIntegracao.PIS.BaseCalculo;
                    }

                    if (cteIntegracao.COFINS != null)
                    {
                        cte.ValorCOFINS = cteIntegracao.COFINS.Valor;
                        cte.AliquotaCOFINS = cteIntegracao.COFINS.Aliquota;
                        cte.BaseCOFINS = cteIntegracao.COFINS.BaseCalculo;
                    }


                    if (cteIntegracao.IR != null)
                        cte.ValorIR = cteIntegracao.IR.Valor;

                    if (cteIntegracao.CSLL != null)
                        cte.ValorCSLL = cteIntegracao.CSLL.Valor;
                }

                cte.Lotacao = cteIntegracao.Lotacao;

                cte.LocalidadeEmissao = cte.Empresa.Localidade;

                if (cte.ModeloDocumentoFiscal.DocumentoTipoCRT)
                {
                    cte.LocalidadeInicioPrestacao = repositorioCliente.BuscarLocalidadePorCPFCNPJ(cteIntegracao.Remetente.Codigo);
                    cte.LocalidadeTerminoPrestacao = repositorioCliente.BuscarLocalidadePorCPFCNPJ(cteIntegracao.Destinatario.Codigo);
                }
                else
                {
                    cte.LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(cteIntegracao.CodigoIBGECidadeInicioPrestacao);
                    cte.LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(cteIntegracao.CodigoIBGECidadeTerminoPrestacao);
                }

                if (cte.Codigo <= 0 || (cte.Status == "P" && cte.Numero == 0))
                {
                    if (cteIntegracao.Serie > 0)
                    {
                        if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFS || cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFSe)
                            cte.Serie = repSerie.BuscarPorSerie(empresa.Codigo, cteIntegracao.Serie, Dominio.Enumeradores.TipoSerie.NFSe);
                        else if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.Outros)
                            cte.Serie = repSerie.BuscarPorSerie(empresa.Codigo, cteIntegracao.Serie, Dominio.Enumeradores.TipoSerie.OutrosDocumentos);
                        else
                            cte.Serie = repSerie.BuscarPorSerie(empresa.Codigo, cteIntegracao.Serie, Dominio.Enumeradores.TipoSerie.CTe);

                        if (cte.Serie == null)
                            throw new ArgumentNullException($"Não foi encontrada uma série {cteIntegracao.Serie} do tipo {cte.ModeloDocumentoFiscal.TipoDocumentoEmissao.ToString("G")} para a empresa {empresa.CNPJ}.");
                    }
                    else
                    {
                        if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFSe)
                        {
                            cte.Serie = this.ObterSerieNFSe(empresa.Codigo, unidadeDeTrabalho);
                            if (cte.Serie == null)
                                throw new ArgumentNullException($"Não foi encontrada uma série configurada para emitir {cte.ModeloDocumentoFiscal.TipoDocumentoEmissao.ToString("G")} para a empresa {empresa.CNPJ}.");
                        }
                        else
                        {
                            if (cte.TipoCTE == Dominio.Enumeradores.TipoCTE.Complemento && empresa.Configuracao != null && empresa.Configuracao.SerieCTeComplementar != null)
                                cte.Serie = empresa.Configuracao.SerieCTeComplementar;
                            else
                            {
                                cte.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorId(cte.ModeloDocumentoFiscal.Codigo);
                                if (cte.Empresa != null && cte.ModeloDocumentoFiscal?.Series != null && cte.ModeloDocumentoFiscal?.Series.Count > 0)
                                    cte.Serie = cte.ModeloDocumentoFiscal.Series.Where(o => o.Empresa.Codigo == cte.Empresa.Codigo && o.Status == "A").FirstOrDefault();

                                if (cte.Serie == null || (cte.Status == "P" && cte.Numero == 0))
                                    cte.Serie = this.ObterSerie(empresa, cte.LocalidadeEmissao.Estado.Sigla, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, cte.Remetente?.CPF_CNPJ ?? string.Empty, cte.Destinatario?.CPF_CNPJ ?? string.Empty, cte.Recebedor?.CPF_CNPJ ?? string.Empty, cte.Expedidor?.CPF_CNPJ ?? string.Empty, cte.TomadorPagador?.CPF_CNPJ ?? string.Empty, unidadeDeTrabalho);
                            }
                        }
                    }
                }

                cte.ObservacoesGerais = cteIntegracao.ObservacoesGerais;

                cte.ObservacaoDaCarga = cteIntegracao.ObservacaoDaCarga;

                if (cteIntegracao.CFOP > 0)
                {
                    Dominio.Entidades.CFOP cfop = repCFOP.BuscarPorCFOPEmpresa(cteIntegracao.CFOP, empresa.Codigo);
                    if (cfop != null)
                        cte.CFOP = cfop;

                    if (cte.CFOP == null)
                        cte.CFOP = repCFOP.BuscarPorNumero(cteIntegracao.CFOP);

                    if (cte.CFOP == null)
                        throw new ArgumentNullException("CFOP informada não existe na base da Multisoftware.");

                    if (cte.NaturezaNFSe != null)
                        cte.NaturezaDaOperacao = repNaturezaDaOperacao.BuscarPorIdNFSe(cte.NaturezaNFSe.Codigo);

                    if (cte.NaturezaDaOperacao == null)
                    {
                        if (cte.CFOP.NaturezaDaOperacao == null)
                            cte.NaturezaDaOperacao = repNaturezaDaOperacao.BuscarPrimeiroRegistro();
                        else
                            cte.NaturezaDaOperacao = cte.CFOP.NaturezaDaOperacao;
                    }
                }
                else if (tipoServicoMultisoftware != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiNFe)
                {
                    this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, cteIntegracao, unidadeDeTrabalho);
                }

                if (cteIntegracao.TipoCTe == Dominio.Enumeradores.TipoCTE.Complemento)
                {
                    cte.ChaveCTESubComp = cteIntegracao.ChaveCTESubstituicaoComplementar;
                }
                else if (cteIntegracao.TipoCTe == Dominio.Enumeradores.TipoCTE.Substituto)
                {
                    cte.ChaveCTESubComp = cteIntegracao.ChaveCTESubstituicaoComplementar;
                    cte.SubstituicaoTomador = cteIntegracao.SubstituicaoTomador;
                }

                if (status == "A" && cte.ModeloDocumentoFiscal.TipoDocumentoEmissao != Dominio.Enumeradores.TipoDocumento.CTe && cte.ModeloDocumentoFiscal.TipoDocumentoEmissao != Dominio.Enumeradores.TipoDocumento.NFSe) //quando é outros documentos e manda emitir automaticamente, não pode ficar sem data de autorização
                {
                    cte.DataAutorizacao = DateTime.Now;
                    cte.DataRetornoSefaz = cte.DataAutorizacao;
                }

                cte.Cancelado = "N";

                bool obterNumeroCTe = false;
                cte.TipoControle = 0;
                if (cte.Codigo <= 0 || cte.Numero == 0)
                {
                    if (modeloDocumentoFiscal != null &&
                        modeloDocumentoFiscal.Numero != "57" &&
                        modeloDocumentoFiscal.Numero != "39" &&
                        (modeloDocumentoFiscal.UtilizarNumeracaoCTe || modeloDocumentoFiscal.UtilizarNumeracaoNFe) &&
                        numeroDocumento > 0)
                        cte.Numero = numeroDocumento;
                    else
                    {
                        if (tipoServicoMultisoftware.HasValue && tipoServicoMultisoftware.Value == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                            obterNumeroCTe = true;

                        if (cteIntegracao.Numero > 0 && cteIntegracao.Serie > 0)
                            cte.Numero = cteIntegracao.Numero;
                        else
                            cte.Numero = Servicos.Embarcador.CTe.NumeracaoCTe.GetInstance().ObterProximoNumero(cte, unitOfWork);
                    }
                }
                if (cte.TipoControle == 0)
                {// a função ObterProximoNumero pode manipular o TipoControle se for diferente de zero a função manipulou 
                    if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.CTe || obterNumeroCTe)
                        cte.TipoControle = 1;
                    else
                        cte.TipoControle = repCTe.BuscarUltimoTipoControle() + 1;
                }

                Servicos.Log.GravarInfo("Iniciou insert CT-e - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe"); // SQL-INJECTION-SAFE

                if (cte.Codigo <= 0)
                    repCTe.Inserir(cte);
                else
                    repCTe.Atualizar(cte);

                string observacaoSequencialOperacao = string.Empty;
                if (tipoOperacao?.ConfiguracaoEmissao?.GerarSequencialObservacaoCTe ?? false)
                {
                    cte.TipoOperacao = tipoOperacao;
                    cte.SequencialOperacao = repCTe.BuscarUltimoSequencialPorOperacao(tipoOperacao.Codigo) + 1;

                    if (!string.IsNullOrWhiteSpace(tipoOperacao?.ConfiguracaoEmissao?.PrefixoObservacaoSequencialCTe))
                        observacaoSequencialOperacao = tipoOperacao.ConfiguracaoEmissao.PrefixoObservacaoSequencialCTe + cte.SequencialOperacao.ToString().PadLeft(14, '0');
                }

                if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFSe)
                {
                    Repositorio.NFSeItem repNFSeItem = new Repositorio.NFSeItem(unidadeDeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeDeTrabalho);
                    repNFSeItem.DeletarPorCTe(cte.Codigo);
                    Repositorio.ServicoNFSe repServico = new Repositorio.ServicoNFSe(unidadeDeTrabalho);


                    if (cteIntegracao.ItensNFSe != null && cteIntegracao.ItensNFSe.Count > 0)
                    {
                        foreach (Dominio.ObjetosDeValor.CTe.ItemNFSe item in cteIntegracao.ItensNFSe)
                        {
                            Dominio.Entidades.ServicoNFSe servicoNFSe = null;
                            if (item.Servico != null && item.Servico.CodigoInterno > 0)
                                servicoNFSe = repServico.BuscarPorCodigo(item.Servico.CodigoInterno);

                            if (servicoNFSe != null)
                            {
                                Dominio.Entidades.NFSeItem itemNFSe = new Dominio.Entidades.NFSeItem();

                                itemNFSe.BaseCalculoISS = item.BaseCalculoISS;

                                itemNFSe.Discriminacao = item.Discriminacao;
                                itemNFSe.ExigibilidadeISS = (Dominio.Enumeradores.ExigibilidadeISS)item.ExigibilidadeISS;
                                itemNFSe.Municipio = repLocalidade.BuscarPorCodigoIBGE(item.CodigoIBGECidade);
                                itemNFSe.MunicipioIncidencia = repLocalidade.BuscarPorCodigoIBGE(item.CodigoIBGECidadeIncidencia);
                                itemNFSe.CTe = cte;
                                itemNFSe.PaisPrestacaoServico = repPais.BuscarPorSigla(string.Format("{0:00000}", item.CodigoPaisPrestacaoServico));
                                itemNFSe.Quantidade = item.Quantidade;
                                itemNFSe.ServicoPrestadoNoPais = item.ServicoPrestadoNoPais;
                                itemNFSe.ValorDeducoes = item.ValorDeducoes;
                                itemNFSe.ValorDescontoCondicionado = item.ValorDescontoCondicionado;
                                itemNFSe.ValorDescontoIncondicionado = item.ValorDescontoIncondicionado;
                                itemNFSe.ValorServico = item.ValorServico;
                                itemNFSe.ValorISS = item.ValorISS;
                                itemNFSe.ValorTotal = item.ValorTotal;
                                itemNFSe.AliquotaISS = item.AliquotaISS;

                                if (item.PIS != null)
                                {
                                    itemNFSe.CSTPIS = item.PIS.CST;
                                    itemNFSe.BaseCalculoPIS = item.PIS.BaseCalculo;
                                    itemNFSe.AliquotaPIS = item.PIS.Aliquota;
                                    itemNFSe.ValorPIS = item.PIS.Valor;
                                }

                                if (item.COFINS != null)
                                {
                                    itemNFSe.CSTCOFINS = item.COFINS.CST;
                                    itemNFSe.BaseCalculoCOFINS = item.COFINS.BaseCalculo;
                                    itemNFSe.AliquotaCOFINS = item.COFINS.Aliquota;
                                    itemNFSe.ValorCOFINS = item.COFINS.Valor;
                                }

                                if (item.IBSCBS != null)
                                {
                                    itemNFSe.NBS = item.IBSCBS.NBS;
                                    itemNFSe.CodigoIndicadorOperacao = item.IBSCBS.CodigoIndicadorOperacao;
                                    itemNFSe.CSTIBSCBS = item.IBSCBS.CST;
                                    itemNFSe.ClassificacaoTributariaIBSCBS = item.IBSCBS.ClassificacaoTributaria;
                                    itemNFSe.BaseCalculoIBSCBS = item.IBSCBS.BaseCalculo;
                                    itemNFSe.AliquotaIBSEstadual = item.IBSCBS.AliquotaIBSEstadual;
                                    itemNFSe.PercentualReducaoIBSEstadual = item.IBSCBS.PercentualReducaoIBSEstadual;
                                    itemNFSe.ValorIBSEstadual = item.IBSCBS.ValorIBSEstadual;
                                    itemNFSe.AliquotaIBSMunicipal = item.IBSCBS.AliquotaIBSMunicipal;
                                    itemNFSe.PercentualReducaoIBSMunicipal = item.IBSCBS.PercentualReducaoIBSMunicipal;
                                    itemNFSe.ValorIBSMunicipal = item.IBSCBS.ValorIBSMunicipal;
                                    itemNFSe.AliquotaCBS = item.IBSCBS.AliquotaCBS;
                                    itemNFSe.PercentualReducaoCBS = item.IBSCBS.PercentualReducaoCBS;
                                    itemNFSe.ValorCBS = item.IBSCBS.ValorCBS;
                                }

                                itemNFSe.Servico = servicoNFSe;
                                repNFSeItem.Inserir(itemNFSe);
                            }
                        }
                    }
                }

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou BuscarUltimoNumero - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                if (obterNumeroCTe && cte.Numero <= 0)
                    cte.Numero = Servicos.Embarcador.CTe.NumeracaoCTe.GetInstance().ObterProximoNumero(cte, unitOfWork);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou geração participantes - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                this.ObterParticipante(ref cte, cteIntegracao.Remetente, Dominio.Enumeradores.TipoTomador.Remetente, unidadeDeTrabalho);

                this.ObterParticipante(ref cte, cteIntegracao.Expedidor, Dominio.Enumeradores.TipoTomador.Expedidor, unidadeDeTrabalho);

                this.ObterParticipante(ref cte, cteIntegracao.Recebedor, Dominio.Enumeradores.TipoTomador.Recebedor, unidadeDeTrabalho);

                this.ObterParticipante(ref cte, cteIntegracao.Destinatario, Dominio.Enumeradores.TipoTomador.Destinatario, unidadeDeTrabalho);

                if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Outros)
                {
                    this.ObterParticipante(ref cte, cteIntegracao.Tomador, Dominio.Enumeradores.TipoTomador.Outros, unidadeDeTrabalho);
                }
                else
                {
                    Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Outros);

                    if (part != null)
                    {
                        Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeDeTrabalho);

                        cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Outros);

                        repParticipante.Deletar(part);
                    }
                }

                cte.ClienteRetira = this.ObterCliente(empresa, cteIntegracao.ClienteRetira, unidadeDeTrabalho);

                cte.ClienteEntrega = this.ObterCliente(empresa, cteIntegracao.ClienteEntrega, unidadeDeTrabalho);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Terminou geração participantes - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE indicadorTomador = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS;

                if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Remetente)
                    indicadorTomador = !string.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Remetente.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Remetente.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
                else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Destinatario)
                    indicadorTomador = !string.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Destinatario.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Destinatario.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
                else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Recebedor && cte.Recebedor != null)
                    indicadorTomador = !string.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Recebedor.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Recebedor.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
                else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Recebedor && cte.Expedidor != null)
                    indicadorTomador = !string.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.Expedidor.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.Expedidor.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;
                else if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Recebedor && cte.OutrosTomador != null)
                    indicadorTomador = !string.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cte.OutrosTomador.IE_RG)) ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS : cte.OutrosTomador.IE_RG == "ISENTO" ? Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento : Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte;

                cte.IndicadorIETomador = cteIntegracao.indicadorIETomador.HasValue && cteIntegracao.indicadorIETomador.Value != 0 ? cteIntegracao.indicadorIETomador.Value : indicadorTomador; //CTe 3.0

                cte.LacreContainer = cteIntegracao.LacreContainer;

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SalvarInformacoesModais - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                this.SalvarInformacoesModais(ref cte, cteIntegracao, unidadeDeTrabalho, tipoServicoMultisoftware.HasValue ? tipoServicoMultisoftware.Value : AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SalvarInformacoesVeiculos - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                this.SalvarInformacoesVeiculos(ref cte, cteIntegracao, unidadeDeTrabalho, tipoServicoMultisoftware.HasValue ? tipoServicoMultisoftware.Value : AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SalvarInformacoesMotoristas - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                this.SalvarInformacoesMotoristas(cte, cteIntegracao.Motoristas, unidadeDeTrabalho, tipoServicoMultisoftware.HasValue ? tipoServicoMultisoftware.Value : AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SalvarInformacoesDeQuantidadeDaCarga - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                this.SalvarInformacoesDeQuantidadeDaCarga(cte, cteIntegracao.QuantidadesCarga, unidadeDeTrabalho);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SalvarInformacoesDeSeguroDaCarga - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                this.SalvarInformacoesDeSeguroDaCarga(cte, cteIntegracao.Seguros, unidadeDeTrabalho);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SalvarInformacoesDocumentos - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                if (codigoCTe == 0 || cte.Documentos == null || cte.Documentos.Count <= 0)
                {
                    if (cte.TipoCTE == TipoCTE.Simplificado && (cteIntegracao.Entregas?.Count() ?? 0) > 0)
                        this.SalvarInformacoesEntregas(ref cte, cteIntegracao.Entregas, descricaoComponentePadrao, descricaoComponenteImposto, unidadeDeTrabalho, tipoServicoMultisoftware);
                    else
                        this.SalvarInformacoesDocumentos(ref cte, cteIntegracao.Documentos, unidadeDeTrabalho, tipoServicoMultisoftware);
                }

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SalvarInformacoesDocumentosAnteriores - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                if (!(cte.TipoCTE == TipoCTE.Simplificado && (cteIntegracao.Entregas?.Count() ?? 0) > 0))
                    this.SalvarInformacoesDocumentosAnteriores(cte, cteIntegracao.DocumentosTransporteAnteriores, unidadeDeTrabalho, naoGerarDocumentoAnterior);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SalvarInformacoesDocumentosAnterioresPapel - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                this.SalvarInformacoesDocumentosAnterioresPapel(cte, cteIntegracao.DocumentosAnterioresDePapel, unidadeDeTrabalho);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SalvarInformacoesProdutosPerigosos - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                this.SalvarInformacoesProdutosPerigosos(cte, cteIntegracao.ProdutosPerigosos, unidadeDeTrabalho);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SalvarInformacoesValePedagio - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                this.SalvarInformacoesValePedagio(cte, cteIntegracao.ValesPedagio, unidadeDeTrabalho);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou CalcularFretePorTabelaDeFrete - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                if (empresa.Configuracao != null && empresa.Configuracao.UtilizaTabelaDeFrete && cte.ValorFrete <= 0)
                    this.CalcularFretePorTabelaDeFrete(ref cte, cte.Empresa.Codigo, unidadeDeTrabalho, cteIntegracao.ICMS != null ? false : true, cteIntegracao.CodigoTabelaFreteIntegracao);

                if (empresa.EmpresaPai != null && empresa.EmpresaPai.Configuracao != null && empresa.EmpresaPai.Configuracao.UtilizaTabelaDeFrete && cte.ValorFrete <= 0)
                    this.CalcularFretePorTabelaDeFrete(ref cte, empresa.EmpresaPai.Codigo, unidadeDeTrabalho, cteIntegracao.ICMS != null ? false : true, cteIntegracao.CodigoTabelaFreteIntegracao);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SalvarInformacoesComponentesDaPrestacao - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                this.SalvarInformacoesComponentesDaPrestacao(cte, cteIntegracao, unidadeDeTrabalho, descricaoComponentePadrao, descricaoComponenteImposto);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou CalcularImpostos - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                bool descontarImpostoDoValorDoFrete = cteIntegracao.CodigoTipoOperacao == "09";
                this.CalcularImpostos(ref cte, cteIntegracao, descricaoComponenteImposto, descontarImpostoDoValorDoFrete, tipoServicoMultisoftware, unidadeDeTrabalho);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SalvarObservacoesContribuinte - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                this.SalvarObservacoesContribuinte(cte, cteIntegracao.ObservacoesContribuinte, unidadeDeTrabalho, tipoServicoMultisoftware);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SalvarObservacoesFisco - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                this.SalvarObservacoesFisco(cte, cteIntegracao.ObservacoesFisco, unidadeDeTrabalho, tipoServicoMultisoftware);

                if (cte.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && cte.Empresa.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.Configuracao.ObservacaoCTeSimplesNacional))
                    cte.ObservacoesGerais = !string.IsNullOrWhiteSpace(cte.ObservacoesGerais) ? cte.ObservacoesGerais + " / " + cte.Empresa.Configuracao.ObservacaoCTeSimplesNacional : cte.Empresa.Configuracao.ObservacaoCTeSimplesNacional;

                if (cte.ValorPresumido > 0 && cte.ValorICMS > 0 && empresa.Configuracao != null && empresa.PercentualCredito > 0)
                    cte.ObservacoesGerais = !string.IsNullOrWhiteSpace(cte.ObservacoesGerais) ? cte.ObservacoesGerais + " / " + (Math.Round(empresa.PercentualCredito, 2, MidpointRounding.ToEven)).ToString() + "% Crédito presumido: R$" + (Math.Round(cte.ValorPresumido, 2, MidpointRounding.ToEven)).ToString() : (Math.Round(empresa.PercentualCredito, 2, MidpointRounding.ToEven)).ToString() + "% Crédito presumido: R$" + (Math.Round(cte.ValorPresumido, 2, MidpointRounding.ToEven)).ToString();

                if (cte.TipoCTE == TipoCTE.Normal && empresa.Configuracao != null && !string.IsNullOrWhiteSpace(empresa.Configuracao.ObservacaoCTeNormal) && (string.IsNullOrWhiteSpace(cte.ObservacoesGerais) || !cte.ObservacoesGerais.Contains(empresa.Configuracao.ObservacaoCTeNormal)))
                    cte.ObservacoesGerais = !string.IsNullOrWhiteSpace(cte.ObservacoesGerais) ? (cte.ObservacoesGerais + " / " + empresa.Configuracao.ObservacaoCTeNormal).Length > 2000 ? (cte.ObservacoesGerais + " / " + empresa.Configuracao.ObservacaoCTeNormal).Substring(0, 2000) : cte.ObservacoesGerais + " / " + empresa.Configuracao.ObservacaoCTeNormal : empresa.Configuracao.ObservacaoCTeNormal;

                if (!string.IsNullOrWhiteSpace(observacaoSequencialOperacao))
                    cte.ObservacoesGerais = !string.IsNullOrWhiteSpace(cte.ObservacoesGerais) ? (cte.ObservacoesGerais + " / " + observacaoSequencialOperacao).Length > 2000 ? (cte.ObservacoesGerais + " / " + observacaoSequencialOperacao).Substring(0, 2000) : cte.ObservacoesGerais + " / " + observacaoSequencialOperacao : observacaoSequencialOperacao + " /";

                //Alterado para gerar observação no método SetarObservacoesAvancadas
                //var obsPadraoGeral = this.BuscarObservacaoPadrao(cte, Dominio.Enumeradores.TipoObservacao.Geral, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, cte.CST, cte.ValorICMS, unidadeDeTrabalho, tipoServicoMultisoftware);
                //if (!string.IsNullOrWhiteSpace(obsPadraoGeral))
                //    cte.ObservacoesGerais = !string.IsNullOrWhiteSpace(cte.ObservacoesGerais) ? (cte.ObservacoesGerais + " / " + obsPadraoGeral).Length > 2000 ? (cte.ObservacoesGerais + " / " + obsPadraoGeral).Substring(0, 2000) : cte.ObservacoesGerais + " / " + obsPadraoGeral : obsPadraoGeral;

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SalvarObservacoesValePedagio - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                this.SalvarObservacoesValePedagio(ref cte, unidadeDeTrabalho);

                if (!string.IsNullOrWhiteSpace(cte.CIOT) && (string.IsNullOrWhiteSpace(cte.ObservacoesGerais) || !cte.ObservacoesGerais.Contains(cte.CIOT)))
                    cte.ObservacoesGerais = string.IsNullOrWhiteSpace(cte.ObservacoesGerais) ? "CIOT " + cte.CIOT + " / " : string.Concat("CIOT " + cte.CIOT, " / ", cte.ObservacoesGerais);

                if (!string.IsNullOrWhiteSpace(cte.ObservacoesGerais) && cte.ObservacoesGerais.Length > 2000)
                    cte.ObservacoesGerais = cte.ObservacoesGerais.Substring(0, 2000);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SetarPartilhaICMS - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                this.SetarPartilhaICMS(ref cte, unidadeDeTrabalho);

                if (modeloDocumentoFiscal == null || modeloDocumentoFiscal.Numero == "57")
                {
                    if (!string.IsNullOrWhiteSpace(cteIntegracao.ChaveCTe) && Utilidades.Validate.ValidarChave(cteIntegracao.ChaveCTe))
                        cte.Chave = cteIntegracao.ChaveCTe;
                    else
                        cte.Chave = GerarChaveCTe(cte);
                }
                else
                    cte.Chave = string.Format("{0:0000000000}", codigoCarga) + string.Format("{0:0000000000}", cte.Codigo);

                //this.SalvarDadosCobrancaAutomatico(cte.Empresa, ref cte, unidadeDeTrabalho);
                SetarTomadorPagadorCTe(ref cte);

                if (cteIntegracao.TipoCTe == Dominio.Enumeradores.TipoCTE.Substituto)
                {
                    Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SalvarSubstitucao - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                    this.SalvarDadosSubstituicao(cte, unidadeDeTrabalho);
                }


                if (string.IsNullOrWhiteSpace(cte.ObservacoesAvancadas))//Quando esta alterando, se já possui observação não muda para não dar erro de Digest value
                {
                    Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SetarObservacoesVeiculo - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");
                    if (!this.SetarObservacoesVeiculo(ref cte, unidadeDeTrabalho))
                    {
                        Servicos.Log.TratarErro(cte.Codigo.ToString() + " - Iniciou SetarObservacoesAvancadas - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");
                        this.SetarObservacoesAvancadas(ref cte, unidadeDeTrabalho);
                    }

                    Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SetarObservacoesTransportadora - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");
                    this.SetarObservacoesTransportadora(ref cte, unidadeDeTrabalho);

                    if (modeloDocumentoFiscal == null || modeloDocumentoFiscal.Numero == "57")
                    {
                        Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SetarObservacaoAvancadaPorRegraICMS - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");
                        this.SetarObservacaoAvancadaPorRegraICMS(ref cte, unidadeDeTrabalho, tipoServicoMultisoftware);
                    }
                    Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou SetarXCampoVeiculo - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");
                    this.SetarXCampoVeiculo(cte, unidadeDeTrabalho);
                    this.AdicionarResponsavelSeguroObsContribuinte(cte, unidadeDeTrabalho);
                }

                cte.Status = status;

                if (!string.IsNullOrWhiteSpace(cte.NumeroBooking) || !string.IsNullOrWhiteSpace(cte.NumeroOS))
                {
                    int? diasPrazoFatura = 0;
                    int? diaMes = 0;
                    bool? permiteFinalSemana = false;
                    FormaTitulo formaTitulo = FormaTitulo.Outros;
                    Dominio.ObjetosDeValor.Embarcador.Enumeradores.DiaSemana? diaSemana = null;
                    Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPrazoFaturamento? tipoPrazoFatura = null;

                    List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.DiaSemana> diasSemana = new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.DiaSemana>();
                    List<int> diasMes = new List<int>();

                    servFatura.RetornarParametrosFaturamento(cte, unidadeDeTrabalho, true, out diaMes, out diaSemana, out permiteFinalSemana, out diasPrazoFatura, out diasSemana, out diasMes, out tipoPrazoFatura, codigoCarga, out formaTitulo);
                    DateTime? dataBaseParcela = servFatura.RetornarDataBase(tipoPrazoFatura, cte, true, unidadeDeTrabalho);

                    if (dataBaseParcela.HasValue && (diaMes != null || diaSemana != null || diasPrazoFatura != null || tipoPrazoFatura != null || diasMes.Count > 0 || diasSemana.Count > 0))
                        cte.DataPreviaVencimento = servFatura.RetornaDataPadraoFatura(diaMes, diaSemana, permiteFinalSemana, dataBaseParcela, diasPrazoFatura, diasSemana, diasMes, cte.TomadorPagador.Cliente, cte.TomadorPagador.GrupoPessoas, false, unidadeDeTrabalho);

                    cte.NumeroControle = servicoCte.RetornarNumeroControleCTe(out int numeroSequencia, cte.NumeroBooking, cte.DescricaoCarrier, cte.TipoPropostaFeeder, cte.TipoModal, cte.TipoServico, cte.Codigo, cte.SVMTerceiro, unidadeDeTrabalho, false, 0, false, cte?.SequenciaBooking ?? 0);
                    cte.PedidoViagemNavioSchedule = repPedidoNavioSchedule.BuscarPorCodigo(repCTe.BuscarCodigoSchedule(cte.ViagemPassagemCinco?.Codigo ?? 0, cte.ViagemPassagemQuatro?.Codigo ?? 0, cte.ViagemPassagemTres?.Codigo ?? 0, cte.ViagemPassagemDois?.Codigo ?? 0, cte.ViagemPassagemUm?.Codigo ?? 0, cte.Viagem?.Codigo ?? 0, cte.PortoDestino?.Codigo ?? 0, cte.TerminalDestino?.Codigo ?? 0));
                    cte.SequenciaBooking = numeroSequencia;

                    if (cte.Codigo.ToString("D") != cte.NumeroControle)
                    {
                        if (repCTe.ContemNumeroControleDuplicado(cte.NumeroControle, cte.Empresa?.Codigo ?? 0, cte.Codigo))
                        {
                            cte.NumeroControle = servicoCte.RetornarNumeroControleCTe(out numeroSequencia, cte.NumeroBooking, cte.DescricaoCarrier, cte.TipoPropostaFeeder, cte.TipoModal, cte.TipoServico, cte.Codigo, cte.SVMTerceiro, unidadeDeTrabalho, true, cte.SequenciaBooking);
                            cte.SequenciaBooking = numeroSequencia;

                            if (repCTe.ContemNumeroControleDuplicado(cte.NumeroControle, cte.Empresa?.Codigo ?? 0, cte.Codigo))
                            {
                                bool contemNumeroDuplicado = true;
                                int count = 0;
                                while (contemNumeroDuplicado)
                                {
                                    cte.NumeroControle = servicoCte.RetornarNumeroControleCTe(out numeroSequencia, cte.NumeroBooking, cte.DescricaoCarrier, cte.TipoPropostaFeeder, cte.TipoModal, cte.TipoServico, cte.Codigo, cte.SVMTerceiro, unidadeDeTrabalho, true, cte.SequenciaBooking);
                                    cte.SequenciaBooking = numeroSequencia;
                                    contemNumeroDuplicado = repCTe.ContemNumeroControleDuplicado(cte.NumeroControle, cte.Empresa?.Codigo ?? 0, cte.Codigo);
                                    count++;
                                    if (count > 100)
                                        break;
                                }
                            }
                        }
                    }
                }

                repCTe.Atualizar(cte);

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Iniciou commit - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");

                if (unitOfWork == null)
                    unidadeDeTrabalho.CommitChanges();

                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Fim commit - " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "TempoEmissaoCTe");
                Servicos.Log.GravarInfo(cte.Codigo.ToString() + " - Valor: " + cte.ValorAReceber, "ValorEmissaoCTe");

                return cte;
            }
            catch
            {
                if (unitOfWork == null)
                    unidadeDeTrabalho.Rollback();

                throw;
            }
        }

        public Dominio.Entidades.ConhecimentoDeTransporteEletronico GerarCTeTemporarioIntegracao(Dominio.ObjetosDeValor.CTe.CTe cteIntegracao, Dominio.Entidades.Empresa empresa, Dominio.Entidades.ModalTransporte modal, Dominio.Entidades.ModeloDocumentoFiscal modelo, Dominio.Entidades.EmpresaSerie serie, Dominio.Entidades.CFOP cfop, int tipoEnvio, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();

            //Random rnd = new Random();
            //long tipoControle = rnd.Next(999999);
            string guid = Utilidades.String.OnlyNumbers(Guid.NewGuid().ToString());
            guid = guid.Length > 12 ? guid.Substring(0, 12) : guid;
            long.TryParse(guid, out long tipoControle);

            cte.Empresa = empresa;
            cte.TipoAmbiente = empresa.TipoAmbiente;

            if (cteIntegracao.Numero > 0)
            {
                cte.Numero = cteIntegracao.Numero;
                cte.TipoControle = 1;
            }
            else
            {
                cte.Numero = 0;
                cte.TipoControle = tipoControle > 0 ? tipoControle : repCTe.BuscarUltimoTipoControle();
            }

            if (!string.IsNullOrWhiteSpace(cteIntegracao.ChaveCTe) && Utilidades.Validate.ValidarChave(cteIntegracao.ChaveCTe))
                cte.Chave = cteIntegracao.ChaveCTe;

            cte.ModalTransporte = modal;
            cte.Status = "P";
            cte.Cancelado = "N";
            cte.ModeloDocumentoFiscal = modelo;
            cte.CFOP = cfop;
            cte.NaturezaDaOperacao = cte.CFOP.NaturezaDaOperacao;
            cte.Serie = serie;
            cte.DataIntegracao = DateTime.Now;
            cte.TipoEnvio = tipoEnvio;

            repCTe.Inserir(cte);

            this.SalvarInformacoesDocumentos(ref cte, cteIntegracao.Documentos, unitOfWork, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe);

            return cte;
        }

        public Dominio.Entidades.ConhecimentoDeTransporteEletronico GerarCTeComplementar(Dominio.Entidades.ConhecimentoDeTransporteEletronico cteComplementado, decimal valorComplemento, string observacao, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Repositorio.ComponentePrestacaoCTE repComponentePrestacaoCTE = new Repositorio.ComponentePrestacaoCTE(unitOfWork);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();

            cte.TipoCTE = Dominio.Enumeradores.TipoCTE.Complemento;
            cte.TipoCTeIntegracao = cteComplementado.TipoCTeIntegracao;
            cte.LogIntegracao += "Gerado no servidor (MachineName: " + System.Environment.MachineName + "). Aplicação (" + System.Reflection.Assembly.GetExecutingAssembly().CodeBase + "). ";
            cte.Versao = cteComplementado.Empresa.Configuracao != null && !string.IsNullOrWhiteSpace(cteComplementado.Empresa.Configuracao.VersaoCTe) ? cteComplementado.Empresa.Configuracao.VersaoCTe : cteComplementado.Empresa.EmpresaPai.Configuracao != null && !string.IsNullOrWhiteSpace(cteComplementado.Empresa.EmpresaPai.Configuracao.VersaoCTe) ? cteComplementado.Empresa.EmpresaPai.Configuracao.VersaoCTe : "4.00";
            cte.IndicadorGlobalizado = cteComplementado.IndicadorGlobalizado;
            cte.ValorCarbaAverbacao = cteComplementado.ValorCarbaAverbacao;
            cte.Empresa = cteComplementado.Empresa;
            cte.TipoTomador = cteComplementado.TipoTomador;
            cte.TipoPagamento = cteComplementado.TipoPagamento;
            cte.IncluirICMSNoFrete = cteComplementado.IncluirICMSNoFrete;
            cte.IncluirISSNoFrete = cteComplementado.IncluirISSNoFrete;
            cte.PercentualICMSIncluirNoFrete = cteComplementado.PercentualICMSIncluirNoFrete;
            cte.ExibeICMSNaDACTE = cteComplementado.ExibeICMSNaDACTE;
            cte.ValorTotalMercadoria = cteComplementado.ValorTotalMercadoria;
            cte.ProdutoPredominante = cteComplementado.ProdutoPredominante;
            cte.CodigoProdutoEmbarcador = cteComplementado.CodigoProdutoEmbarcador;
            cte.Retira = cteComplementado.Retira;
            cte.DetalhesRetira = cteComplementado.DetalhesRetira;
            cte.RNTRC = cteComplementado.Empresa.RegistroANTT;
            cte.CIOT = cteComplementado.CIOT;
            cte.DataPrevistaEntrega = cteComplementado.DataPrevistaEntrega;
            cte.TipoAmbiente = cteComplementado.TipoAmbiente;
            cte.TipoEmissao = cteComplementado.TipoEmissao;
            cte.TipoEnvio = cteComplementado.TipoEnvio;
            cte.TipoImpressao = cteComplementado.TipoImpressao;
            cte.TipoServico = cteComplementado.TipoServico;

            TimeZoneInfo fusoHorarioEmpresa = TimeZoneInfo.FindSystemTimeZoneById(cte.Empresa.FusoHorario);
            DateTime dataFuso = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day, DateTime.Now.Hour, DateTime.Now.Minute, 0);
            dataFuso = TimeZoneInfo.ConvertTime(dataFuso, TimeZoneInfo.Local, fusoHorarioEmpresa);
            cte.DataEmissao = dataFuso;

            cte.DataIntegracao = DateTime.Now;
            cte.ModalTransporte = cteComplementado.ModalTransporte;
            cte.ModeloDocumentoFiscal = cteComplementado.ModeloDocumentoFiscal;
            cte.Lotacao = cteComplementado.Lotacao;
            cte.LocalidadeEmissao = cte.Empresa.Localidade;
            cte.LocalidadeInicioPrestacao = cteComplementado.LocalidadeInicioPrestacao;
            cte.LocalidadeTerminoPrestacao = cteComplementado.LocalidadeTerminoPrestacao;
            cte.ObservacoesGerais = observacao;
            cte.ObservacaoDaCarga = cteComplementado.ObservacaoDaCarga;
            cte.CFOP = cteComplementado.CFOP;
            cte.NaturezaDaOperacao = cteComplementado.NaturezaDaOperacao;
            cte.ChaveCTESubComp = cteComplementado.Chave;
            cte.Cancelado = "N";
            cte.IndicadorIETomador = cteComplementado.IndicadorIETomador;
            cte.LacreContainer = cteComplementado.LacreContainer;
            cte.ValorFrete = valorComplemento;
            cte.Status = "R";

            if (cte.TipoCTE == Dominio.Enumeradores.TipoCTE.Complemento && cte.Empresa.Configuracao != null && cte.Empresa.Configuracao.SerieCTeComplementar != null)
                cte.Serie = cte.Empresa.Configuracao.SerieCTeComplementar;
            else
                cte.Serie = cteComplementado.Serie;

            if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.CTe)
                cte.TipoControle = 1;
            else
                cte.TipoControle = repCTe.BuscarUltimoTipoControle() + 1;

            cte.Numero = ObterProximoNumero(cte, repCTe);

            repCTe.Inserir(cte);

            cte.Chave = GerarChaveCTe(cte);

            cte.Remetente = cteComplementado.Remetente;
            cte.Destinatario = cteComplementado.Destinatario;
            cte.Expedidor = cteComplementado.Expedidor;
            cte.Recebedor = cteComplementado.Recebedor;
            cte.ClienteRetira = cteComplementado.ClienteRetira;
            cte.ClienteEntrega = cteComplementado.ClienteEntrega;
            cte.OutrosTomador = cteComplementado.OutrosTomador;

            //this.AlterarValorFreteCTe(ref cte, valorComplemento, 0, 0, unitOfWork);           

            cte.ValorFrete = Math.Round(valorComplemento, 2, MidpointRounding.ToEven);
            repCTe.Atualizar(cte);
            repComponentePrestacaoCTE.DeletarPorCTe(cte.Codigo);
            this.SalvarInformacoesComponentesDaPrestacao(cte, "FRETE VALOR", cte.ValorFrete, false, true, unitOfWork);
            cte.CST = cteComplementado.CST;
            cte.AliquotaICMS = cteComplementado.AliquotaICMS;

            this.CalcularInclusaoICMSNoFrete(ref cte, valorComplemento, valorComplemento, valorComplemento, cte.AliquotaICMS, unitOfWork);
            CalcularICMS(ref cte, unitOfWork);

            this.SetarPartilhaICMS(ref cte, unitOfWork);

            SetarTomadorPagadorCTe(ref cte);
            cte.Status = "E";

            repCTe.Atualizar(cte);

            return cte;
        }

        public bool RatearValorFreteEntreCTes(List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> ctes, decimal valorFrete, Dominio.Enumeradores.TipoRateioTabelaFreteValor tipoRateio, Repositorio.UnitOfWork unitOfWork)
        {
            if (ctes == null || ctes.Count == 0)
                throw new Exception("Nenhum CT-e enviado");

            Repositorio.InformacaoCargaCTE repInformacaoCargaCTE = new Repositorio.InformacaoCargaCTE(unitOfWork);
            Repositorio.ComponentePrestacaoCTE repComponentePrestacaoCTE = new Repositorio.ComponentePrestacaoCTE(unitOfWork);

            decimal valorMercadoriaTotal = ctes.Sum(o => o.ValorTotalMercadoria);
            decimal valorMercadoriaCTe = 0;
            decimal pesoTotal = repInformacaoCargaCTE.ObterPesoTotal(ctes.Select(o => o.Codigo).ToArray(), Dominio.Enumeradores.UnidadeMedidaMDFe.KG);
            if (pesoTotal == 0)
                pesoTotal = repInformacaoCargaCTE.ObterPesoTotal(ctes.Select(o => o.Codigo).ToArray(), Dominio.Enumeradores.UnidadeMedidaMDFe.TON);
            decimal pesoCTe = 0;
            decimal valorCTe = 0;
            decimal valorTotalRateado = 0;

            Servicos.Log.TratarErro("Peso total CTes: " + pesoTotal.ToString(), "FinalizacaoCarga");
            Servicos.Log.TratarErro("Valor total Frete: " + valorFrete.ToString(), "FinalizacaoCarga");

            for (int i = 0; i < ctes.Count(); i++)
            {
                Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = ctes[i];
                valorMercadoriaCTe = cte.ValorTotalMercadoria;
                pesoCTe = cte.QuantidadesCarga.Where(obj => obj.UnidadeMedida == "01").Sum(o => o.Quantidade);

                Servicos.Log.TratarErro("Peso CTe " + cte.Codigo + " = " + pesoCTe.ToString(), "FinalizacaoCarga");

                if (tipoRateio == Dominio.Enumeradores.TipoRateioTabelaFreteValor.Peso)
                    valorCTe = (valorFrete / pesoTotal) * pesoCTe;
                else
                    valorCTe = (valorFrete / valorMercadoriaTotal) / valorMercadoriaCTe;

                valorCTe = Math.Round(valorCTe, 2, MidpointRounding.ToEven);
                valorTotalRateado += valorCTe;

                //Adiciona no último CTe diferença do valor rateado
                if (i == ctes.Count - 1)
                {
                    decimal valorDiferenca = valorFrete - valorTotalRateado;
                    valorCTe = valorCTe + valorDiferenca;
                }

                cte.ValorFrete = valorCTe;
                List<Dominio.Entidades.ComponentePrestacaoCTE> componentesValorFrete = repComponentePrestacaoCTE.BuscarPorCTeDescricao(cte.Codigo, "FRETE VALOR");
                if (componentesValorFrete != null && componentesValorFrete.Count > 0)
                {
                    componentesValorFrete[0].Valor = valorCTe;
                    repComponentePrestacaoCTE.Atualizar(componentesValorFrete[0]);
                }

                CalcularICMSPorTabelaDeAliquotas(ref cte, cte.SimplesNacional, unitOfWork);
            }

            return true;
        }

        public static void SetarTomadorPagadorCTe(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte)
        {
            switch (cte.TipoTomador)
            {
                case Dominio.Enumeradores.TipoTomador.Remetente:
                    cte.TomadorPagador = cte.Remetente;
                    break;
                case Dominio.Enumeradores.TipoTomador.Expedidor:
                    cte.TomadorPagador = cte.Expedidor;
                    break;
                case Dominio.Enumeradores.TipoTomador.Recebedor:
                    cte.TomadorPagador = cte.Recebedor;
                    break;
                case Dominio.Enumeradores.TipoTomador.Destinatario:
                    cte.TomadorPagador = cte.Destinatario;
                    break;
                case Dominio.Enumeradores.TipoTomador.Outros:
                    cte.TomadorPagador = cte.OutrosTomador;
                    break;
                default:
                    cte.TomadorPagador = null;
                    break;
            }
        }

        public static void SetarNumeroBookingObservacaoCTe(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, string expressaoRegularBooking)
        {
            if (string.IsNullOrWhiteSpace(cte?.ObservacoesGerais) || string.IsNullOrWhiteSpace(expressaoRegularBooking))
                return;

            Regex regex = new Regex(expressaoRegularBooking, RegexOptions.IgnoreCase);

            Match match = regex.Match(cte.ObservacoesGerais);

            if (match.Success && !string.IsNullOrWhiteSpace(match.Value))
                cte.NumeroBookingObservacao = match.Value.Trim().ToUpper();
        }

        public static void SetarNumeroContainerObservacaoCTe(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, string expressaoRegularContainer)
        {
            if (string.IsNullOrWhiteSpace(cte?.ObservacoesGerais) || string.IsNullOrWhiteSpace(expressaoRegularContainer))
                return;

            Regex regex = new Regex(expressaoRegularContainer, RegexOptions.IgnoreCase);

            Match match = regex.Match(cte.ObservacoesGerais);

            if (match.Success && !string.IsNullOrWhiteSpace(match.Value))
            {
                string numeroContainer = match.Value.ToUpper();
                numeroContainer = numeroContainer.Replace(" ", "").Replace("-", "").Replace(".", "").Replace("/", "").Replace("\\", "").Trim();
                cte.NumeroContainerObservacao = numeroContainer;
            }
        }

        public static void SetarNumeroPedidoObservacaoCTe(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte)
        {
            if (string.IsNullOrWhiteSpace(cte?.ObservacoesGerais))
                return;

            if (cte?.TomadorPagador?.GrupoPessoas != null && cte.TomadorPagador.GrupoPessoas.LerNumeroPedidoObservacaoCTe && !string.IsNullOrWhiteSpace(cte.TomadorPagador.GrupoPessoas.RegexNumeroPedidoObservacaoCTe))
            {
                Regex regex = new Regex(cte.TomadorPagador.GrupoPessoas.RegexNumeroPedidoObservacaoCTe, RegexOptions.IgnoreCase);

                Match match = regex.Match(cte.ObservacoesGerais);

                if (match.Success)
                    cte.NumeroPedido = match.Value.Trim();
            }
        }

        public string BuscarObservacaoPadrao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.Enumeradores.TipoObservacao tipo, string ufInicio, string ufFim, string cst, decimal valorICMS, Repositorio.UnitOfWork unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware = null)
        {
            if (tipoServicoMultisoftware.HasValue && (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)) //removido do tms pois onera o processo de emissão de ct-es em grande quantidade
                return string.Empty;

            try
            {
                Repositorio.Observacao repObservacao = new Repositorio.Observacao(unidadeDeTrabalho);
                Repositorio.VeiculoCTE repVeiculo = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
                Repositorio.MotoristaCTE repMotoristaCTE = new Repositorio.MotoristaCTE(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumentos = new Repositorio.DocumentosCTE(unidadeDeTrabalho);

                string observacao = "";

                if (cst != null && cst == "")
                    cst = "SN";

                int codigoEmpresa = cte.Empresa.Codigo;
                Dominio.Enumeradores.TipoCTE tipoCTe = cte.TipoCTE;

                List<Dominio.Entidades.Observacao> listaObs = repObservacao.BuscarAutomaticasPorEmpresa(codigoEmpresa, cte.Empresa.EmpresaPai != null ? cte.Empresa.EmpresaPai.Codigo : 1, tipo);

                for (int i = 0; i < listaObs.Count; i++)
                {
                    //Testar CST Nula
                    if (listaObs[i].TipoCTe == tipoCTe &&
                        listaObs[i].Operacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.Operacao.Todos &&
                       ((!string.IsNullOrWhiteSpace(listaObs[i].CST) && listaObs[i].CST == cst) || (string.IsNullOrWhiteSpace(listaObs[i].CST))) &&
                       !string.IsNullOrWhiteSpace(listaObs[i].UF) && !string.IsNullOrWhiteSpace(listaObs[i].UFDestino) && listaObs[i].UF == ufInicio && listaObs[i].UFDestino == ufFim)
                        observacao = !string.IsNullOrWhiteSpace(observacao) ? observacao + " " + listaObs[i].Descricao : listaObs[i].Descricao;
                    else if (listaObs[i].TipoCTe == tipoCTe &&
                        listaObs[i].Operacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.Operacao.Todos &&
                        ((!string.IsNullOrWhiteSpace(listaObs[i].CST) && listaObs[i].CST == cst) || (string.IsNullOrWhiteSpace(listaObs[i].CST))) &&
                        !string.IsNullOrWhiteSpace(listaObs[i].UF) && string.IsNullOrWhiteSpace(listaObs[i].UFDestino) && listaObs[i].UF == ufInicio)
                        observacao = !string.IsNullOrWhiteSpace(observacao) ? observacao + " " + listaObs[i].Descricao : listaObs[i].Descricao;
                    else if (listaObs[i].TipoCTe == tipoCTe &&
                        listaObs[i].Operacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.Operacao.Todos &&
                        ((!string.IsNullOrWhiteSpace(listaObs[i].CST) && listaObs[i].CST == cst) || (string.IsNullOrWhiteSpace(listaObs[i].CST))) &&
                        string.IsNullOrWhiteSpace(listaObs[i].UF) && !string.IsNullOrWhiteSpace(listaObs[i].UFDestino) && listaObs[i].UFDestino == ufFim)
                        observacao = !string.IsNullOrWhiteSpace(observacao) ? observacao + " " + listaObs[i].Descricao : listaObs[i].Descricao;
                    else if (listaObs[i].TipoCTe == tipoCTe &&
                        listaObs[i].Operacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.Operacao.Todos &&
                        ((!string.IsNullOrWhiteSpace(listaObs[i].CST) && listaObs[i].CST == cst) || (string.IsNullOrWhiteSpace(listaObs[i].CST))) &&
                        string.IsNullOrWhiteSpace(listaObs[i].UF) && string.IsNullOrWhiteSpace(listaObs[i].UFDestino))
                        observacao = !string.IsNullOrWhiteSpace(observacao) ? observacao + " " + listaObs[i].Descricao : listaObs[i].Descricao;
                    else if (listaObs[i].TipoCTe == tipoCTe &&
                        ((listaObs[i].Operacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.Operacao.EstadoDestinoDiferenteTransportador && cte.Empresa.Localidade.Estado.Sigla != ufFim) || (listaObs[i].Operacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.Operacao.EstadoDestinoIgualTransportador && cte.Empresa.Localidade.Estado.Sigla == ufFim)) &&
                        ((string.IsNullOrWhiteSpace(listaObs[i].CST)) || (!string.IsNullOrWhiteSpace(listaObs[i].CST) && ((listaObs[i].CST == "M0" && valorICMS > 0) || (listaObs[i].CST == "I0" && valorICMS == 0)))))
                        observacao = !string.IsNullOrWhiteSpace(observacao) ? observacao + " " + listaObs[i].Descricao : listaObs[i].Descricao;
                    else if (listaObs[i].TipoCTe == tipoCTe &&
                       ((listaObs[i].Operacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.Operacao.Interestadual && ufInicio != ufFim) || (listaObs[i].Operacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.Operacao.Intraestadual && ufInicio == ufFim)) &&
                       ((string.IsNullOrWhiteSpace(listaObs[i].CST)) || (!string.IsNullOrWhiteSpace(listaObs[i].CST) && ((listaObs[i].CST == "M0" && valorICMS > 0) || (listaObs[i].CST == "I0" && valorICMS == 0)))))
                        observacao = !string.IsNullOrWhiteSpace(observacao) ? observacao + " " + listaObs[i].Descricao : listaObs[i].Descricao;
                }

                if (!string.IsNullOrWhiteSpace(observacao))
                {
                    bool formatarPlacaComHifen = cte.Empresa.Configuracao != null ? cte.Empresa.Configuracao.FormatarPlacaComHifenNaObservacao : false;

                    List<Dominio.Entidades.VeiculoCTE> veiculos = repVeiculo.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);
                    Dominio.Entidades.VeiculoCTE veiculo = (from obj in veiculos where obj.TipoVeiculo.Equals("0") select obj).FirstOrDefault();
                    if (veiculo == null)
                        veiculo = (from obj in veiculos orderby obj.TipoVeiculo select obj).FirstOrDefault();

                    List<Dominio.Entidades.MotoristaCTE> listaMotoristas = repMotoristaCTE.BuscarPorCTe(cte.Codigo);
                    List<string> listaPlacas = (from veicVeinculado in veiculos where veiculo.Placa != veicVeinculado.Placa select veicVeinculado.Placa).ToList();
                    string placasVinculadas = listaPlacas.Count() > 0 ? String.Join(", ", listaPlacas) : string.Empty;

                    List<string> listaPlacasRenavam = (from veicVeinculado in veiculos where veiculo.Placa != veicVeinculado.Placa select veicVeinculado.Placa + "/" + veicVeinculado.RENAVAM).ToList();
                    string placasVinculadasRenavam = listaPlacasRenavam.Count() > 0 ? String.Join(", ", listaPlacasRenavam) : string.Empty;

                    string[] nomesMotoristas = (from m in listaMotoristas select m.NomeMotorista).ToArray();
                    string[] cpfsMotoristas = (from m in listaMotoristas select m.CPFMotorista).ToArray();

                    List<Dominio.Entidades.DocumentosCTE> listaDocumentos = repDocumentos.BuscarPorCTe(cte.Codigo);

                    observacao = observacao.Replace("#NomeMotorista#", nomesMotoristas.Length > 0 ? String.Join(", ", nomesMotoristas) : string.Empty)
                                           .Replace("#CPFMotorista#", cpfsMotoristas.Length > 0 ? String.Join(", ", cpfsMotoristas) : string.Empty)
                                           .Replace("#CPFCNPJProprietario#", (veiculo != null && veiculo.Proprietario != null ? veiculo.Proprietario.CPF_CNPJ : string.Empty))
                                           .Replace("#NomeProprietario#", (veiculo != null && veiculo.Proprietario != null ? veiculo.Proprietario.Nome : string.Empty))
                                           .Replace("#RNTRCProprietario#", (veiculo != null && veiculo.Proprietario != null ? veiculo.Proprietario.RNTRC : string.Empty))
                                           .Replace("#PlacaVeiculo#", (veiculo != null ? formatarPlacaComHifen ? veiculo.Placa_Formatada : veiculo.Placa : string.Empty))
                                           .Replace("#RENAVAMVeiculo#", (veiculo != null ? veiculo.RENAVAM : string.Empty))
                                           .Replace("#UFVeiculo#", (veiculo != null ? veiculo.SiglaUF : string.Empty))
                                           .Replace("#MarcaVeiculo#", (veiculo != null && veiculo.Veiculo.Marca != null ? veiculo.Veiculo.Marca.Descricao : string.Empty))
                                           .Replace("#PlacasVinculadas#", (placasVinculadas != "" ? placasVinculadas : string.Empty))
                                           .Replace("#PlacasRenavamVinculadas#", (placasVinculadasRenavam != "" ? placasVinculadasRenavam : string.Empty))
                                           .Replace("#SerieCTe#", cte.Serie.Numero.ToString())
                                           .Replace("#CPFCNPJRemetente#", cte.Remetente != null ? cte.Remetente.CPF_CNPJ_SemFormato : string.Empty)
                                           .Replace("#NomeRemetente#", cte.Remetente != null ? cte.Remetente.Nome : string.Empty)
                                           .Replace("#FantasiaRemetente#", cte.Remetente != null ? !string.IsNullOrWhiteSpace(cte.Remetente.NomeFantasia) ? cte.Remetente.NomeFantasia : cte.Remetente.Nome : string.Empty)
                                           .Replace("#CidadeRemetente#", cte.Remetente != null && cte.Remetente.Localidade != null ? cte.Remetente.Localidade.Descricao : string.Empty)
                                           .Replace("#EstadoRemetente#", cte.Remetente != null && cte.Remetente.Localidade != null ? cte.Remetente.Localidade.Estado.Sigla : string.Empty)
                                           .Replace("#CPFCNPJDestinatario#", cte.Destinatario != null ? cte.Destinatario.CPF_CNPJ_SemFormato : string.Empty)
                                           .Replace("#NomeDestinatario#", cte.Destinatario != null ? cte.Destinatario.Nome : string.Empty)
                                           .Replace("#FantasiaDestinatario#", cte.Destinatario != null ? !string.IsNullOrWhiteSpace(cte.Destinatario.NomeFantasia) ? cte.Destinatario.NomeFantasia : cte.Destinatario.Nome : string.Empty)
                                           .Replace("#CidadeDestinatario#", cte.Destinatario != null && cte.Destinatario.Localidade != null ? cte.Destinatario.Localidade.Descricao : string.Empty)
                                           .Replace("#EstadoDestinatario#", cte.Destinatario != null && cte.Destinatario.Localidade != null ? cte.Destinatario.Localidade.Estado.Sigla : string.Empty)
                                           .Replace("#NumeroNFe#", listaDocumentos != null && listaDocumentos.Count > 0 ? listaDocumentos.FirstOrDefault().NumeroOuNumeroDaChave : string.Empty);


                    switch (tipo)
                    {
                        case Dominio.Enumeradores.TipoObservacao.Geral:
                            return observacao.Length > 2000 ? observacao.Substring(0, 2000) : observacao;
                        case Dominio.Enumeradores.TipoObservacao.Contribuinte:
                            return observacao.Length > 160 ? observacao.Substring(0, 160) : observacao;
                        case Dominio.Enumeradores.TipoObservacao.Fisco:
                            return observacao.Length > 60 ? observacao.Substring(0, 60) : observacao;
                        default:
                            return string.Empty;
                    }
                }
                else return string.Empty;

            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Problemas ao buscar observação padrão: " + ex);
                return string.Empty;
            }

        }

        public bool CalcularFretePorTabelaDeFrete(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int codigoEmpresa, Repositorio.UnitOfWork unidadeDeTrabalho, bool calcularImpostos = false, string codigoIntegracao = "")
        {
            if (string.IsNullOrWhiteSpace(cte.Remetente.CPF_CNPJ) || string.IsNullOrWhiteSpace(cte.Destinatario.CPF_CNPJ))
                return false;

            double cpfCnpjOrigem = double.Parse(cte.Remetente.CPF_CNPJ);
            double cpfCnpjDestino = double.Parse(cte.Destinatario.CPF_CNPJ);
            Dominio.Entidades.Localidade localidadeOrigem = cte.LocalidadeInicioPrestacao;
            Dominio.Entidades.Localidade localidadeDestino = cte.LocalidadeTerminoPrestacao; //codigoLocalidadeDestino = cte.Destinatario == null || cte.Destinatario.Exterior ? 0 : cte.Destinatario.Localidade.Codigo;

            Dominio.Enumeradores.TipoPagamentoFrete tipoPagamento = cte.TipoPagamento == Dominio.Enumeradores.TipoPagamento.A_Pagar ? Dominio.Enumeradores.TipoPagamentoFrete.A_Pagar :
                                                                    cte.TipoPagamento == Dominio.Enumeradores.TipoPagamento.Pago ? Dominio.Enumeradores.TipoPagamentoFrete.Pago :
                                                                    Dominio.Enumeradores.TipoPagamentoFrete.Todos;

            decimal valorFrete = 0;
            decimal valorAdValorem = 0;
            decimal valorGris = 0;
            decimal valorExedentePeso = 0;
            decimal valorExedenteValor = 0;
            decimal pesoMaximoTabela = 0;
            decimal valorMaximoTabela = 0;
            decimal pesoTotalCTe = 0;
            decimal valorTotalNFe = 0;
            decimal valorPedagio = 0;
            decimal valorDescarga = 0;
            decimal valorSeguro = 0;
            decimal valorOutros = 0;
            decimal valorMinimo = 0;
            decimal valorTAS = 0;

            Dominio.Enumeradores.IncluiICMSFrete incluirICMS = Dominio.Enumeradores.IncluiICMSFrete.Nao;
            Dominio.Enumeradores.OpcaoSimNao adicionarGrisBcICMS = Dominio.Enumeradores.OpcaoSimNao.Sim;
            Dominio.Enumeradores.OpcaoSimNao adicionarAdValoremBcICMS = Dominio.Enumeradores.OpcaoSimNao.Sim;
            Dominio.Enumeradores.OpcaoSimNao adicionarPedagioBcICMS = Dominio.Enumeradores.OpcaoSimNao.Sim;
            Dominio.Enumeradores.OpcaoSimNao adicionarDescargaBcICMS = Dominio.Enumeradores.OpcaoSimNao.Sim;
            Dominio.Enumeradores.OpcaoSimNao adicionarSeguroBcICMS = Dominio.Enumeradores.OpcaoSimNao.Sim;
            Dominio.Enumeradores.OpcaoSimNao adicionarOutrosBcICMS = Dominio.Enumeradores.OpcaoSimNao.Sim;
            Dominio.Enumeradores.TipoFrete tipoMinimoFretePeso = Dominio.Enumeradores.TipoFrete.ValorMinimoGarantido;

            Repositorio.FreteFracionadoUnidade repFreteFracionadoUnidade = new Repositorio.FreteFracionadoUnidade(unidadeDeTrabalho);
            List<Dominio.Entidades.FreteFracionadoUnidade> listaFreteFracionadoUnidade = repFreteFracionadoUnidade.Buscar(codigoEmpresa, "A", double.Parse(cte.Remetente.CPF_CNPJ), Dominio.Enumeradores.TipoTomador.Remetente, localidadeDestino.CodigoIBGE);
            if (listaFreteFracionadoUnidade.Count == 0 && cte.Destinatario != null)
                listaFreteFracionadoUnidade = repFreteFracionadoUnidade.Buscar(codigoEmpresa, "A", double.Parse(cte.Destinatario.CPF_CNPJ), Dominio.Enumeradores.TipoTomador.Destinatario, localidadeDestino.CodigoIBGE);
            if (listaFreteFracionadoUnidade.Count == 0 && cte.Expedidor != null)
                listaFreteFracionadoUnidade = repFreteFracionadoUnidade.Buscar(codigoEmpresa, "A", double.Parse(cte.Expedidor.CPF_CNPJ), Dominio.Enumeradores.TipoTomador.Expedidor, localidadeDestino.CodigoIBGE);
            if (listaFreteFracionadoUnidade.Count == 0 && cte.Recebedor != null)
                listaFreteFracionadoUnidade = repFreteFracionadoUnidade.Buscar(codigoEmpresa, "A", double.Parse(cte.Recebedor.CPF_CNPJ), Dominio.Enumeradores.TipoTomador.Recebedor, localidadeDestino.CodigoIBGE);
            if (listaFreteFracionadoUnidade.Count == 0 && cte.Tomador != null)
                listaFreteFracionadoUnidade = repFreteFracionadoUnidade.Buscar(codigoEmpresa, "A", double.Parse(cte.Tomador.CPF_CNPJ), Dominio.Enumeradores.TipoTomador.Outros, localidadeDestino.CodigoIBGE);
            if (listaFreteFracionadoUnidade.Count == 0)
                listaFreteFracionadoUnidade = repFreteFracionadoUnidade.Buscar(codigoEmpresa, "A", 0, null, localidadeDestino.CodigoIBGE);

            if (listaFreteFracionadoUnidade.Count > 0)
            {
                Dominio.Entidades.UnidadeDeMedida unidadeMedidaTabela = listaFreteFracionadoUnidade.FirstOrDefault().UnidadeDeMedida;

                pesoMaximoTabela = listaFreteFracionadoUnidade.Max(x => x.PesoAte);
                valorTotalNFe = cte.ValorTotalMercadoria;

                Repositorio.InformacaoCargaCTE repInformacaoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
                List<Dominio.Entidades.InformacaoCargaCTE> listaInformacaoCargaCTe = repInformacaoCarga.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);

                pesoTotalCTe = listaInformacaoCargaCTe.Count > 0 ? listaInformacaoCargaCTe.Where(x => x.UnidadeMedida == unidadeMedidaTabela.CodigoDaUnidade).Sum(x => x.Quantidade) : 0;

                if (pesoTotalCTe > pesoMaximoTabela)
                {
                    Dominio.Entidades.FreteFracionadoUnidade frete = listaFreteFracionadoUnidade.LastOrDefault();

                    valorFrete = frete.ValorFrete;
                    valorAdValorem = frete.PercentualAdValorem > 0 ? valorTotalNFe * (frete.PercentualAdValorem / 100) : 0;
                    valorGris = frete.PercentualGris > 0 ? valorTotalNFe * (frete.PercentualGris / 100) : 0;
                    valorPedagio = frete.ValorPedagio;
                    valorTAS = frete.ValorTAS;
                    decimal pesoExcedente = pesoTotalCTe - pesoMaximoTabela;
                    valorExedentePeso = pesoExcedente * frete.ValorExcedente;
                    incluirICMS = frete.IncluiICMS;

                    if (frete.ValorMinimoGris > 0 && valorGris < frete.ValorMinimoGris)
                        valorGris = frete.ValorMinimoGris;
                    if (frete.ValorMinimoAdValorem > 0 && valorAdValorem < frete.ValorMinimoAdValorem)
                        valorAdValorem = frete.ValorMinimoAdValorem;

                    if (frete.ValorPorUnidadeMedida > 0 && pesoTotalCTe > 0)
                        valorFrete += (frete.ValorPorUnidadeMedida * pesoTotalCTe);
                }
                else
                {
                    for (int i = 0; i < listaFreteFracionadoUnidade.Count; i++)
                    {
                        if (listaFreteFracionadoUnidade[i].PesoDe <= pesoTotalCTe && listaFreteFracionadoUnidade[i].PesoAte >= pesoTotalCTe)
                        {
                            valorFrete = listaFreteFracionadoUnidade[i].ValorFrete;
                            valorAdValorem = listaFreteFracionadoUnidade[i].PercentualAdValorem > 0 ? valorTotalNFe * (listaFreteFracionadoUnidade[i].PercentualAdValorem / 100) : 0;
                            valorGris = listaFreteFracionadoUnidade[i].PercentualGris > 0 ? valorTotalNFe * (listaFreteFracionadoUnidade[i].PercentualGris / 100) : 0;
                            valorPedagio = listaFreteFracionadoUnidade[i].ValorPedagio;
                            valorTAS = listaFreteFracionadoUnidade[i].ValorTAS;
                            valorExedentePeso = 0;
                            incluirICMS = listaFreteFracionadoUnidade[i].IncluiICMS;

                            if (listaFreteFracionadoUnidade[i].ValorMinimoGris > 0 && valorGris < listaFreteFracionadoUnidade[i].ValorMinimoGris)
                                valorGris = listaFreteFracionadoUnidade[i].ValorMinimoGris;
                            if (listaFreteFracionadoUnidade[i].ValorMinimoAdValorem > 0 && valorAdValorem < listaFreteFracionadoUnidade[i].ValorMinimoAdValorem)
                                valorAdValorem = listaFreteFracionadoUnidade[i].ValorMinimoAdValorem;

                            if (listaFreteFracionadoUnidade[i].ValorPorUnidadeMedida > 0 && pesoTotalCTe > 0)
                                valorFrete += (listaFreteFracionadoUnidade[i].ValorPorUnidadeMedida * pesoTotalCTe);

                            break;
                        }
                    }
                }
            }
            else
            {
                Repositorio.FreteFracionadoValor repFreteFracionadoValor = new Repositorio.FreteFracionadoValor(unidadeDeTrabalho);
                List<Dominio.Entidades.FreteFracionadoValor> listaFreteFracionadoValor = repFreteFracionadoValor.Buscar(codigoEmpresa, "A", double.Parse(cte.Remetente.CPF_CNPJ), Dominio.Enumeradores.TipoTomador.Remetente, localidadeDestino.CodigoIBGE);
                if (listaFreteFracionadoValor.Count == 0 && cte.Destinatario != null)
                    listaFreteFracionadoValor = repFreteFracionadoValor.Buscar(codigoEmpresa, "A", double.Parse(cte.Destinatario.CPF_CNPJ), Dominio.Enumeradores.TipoTomador.Destinatario, localidadeDestino.CodigoIBGE);
                if (listaFreteFracionadoValor.Count == 0 && cte.Expedidor != null)
                    listaFreteFracionadoValor = repFreteFracionadoValor.Buscar(codigoEmpresa, "A", double.Parse(cte.Expedidor.CPF_CNPJ), Dominio.Enumeradores.TipoTomador.Expedidor, localidadeDestino.CodigoIBGE);
                if (listaFreteFracionadoValor.Count == 0 && cte.Recebedor != null)
                    listaFreteFracionadoValor = repFreteFracionadoValor.Buscar(codigoEmpresa, "A", double.Parse(cte.Recebedor.CPF_CNPJ), Dominio.Enumeradores.TipoTomador.Recebedor, localidadeDestino.CodigoIBGE);
                if (listaFreteFracionadoValor.Count == 0 && cte.Tomador != null)
                    listaFreteFracionadoValor = repFreteFracionadoValor.Buscar(codigoEmpresa, "A", double.Parse(cte.Tomador.CPF_CNPJ), Dominio.Enumeradores.TipoTomador.Outros, localidadeDestino.CodigoIBGE);
                if (listaFreteFracionadoValor.Count == 0)
                    listaFreteFracionadoValor = repFreteFracionadoValor.Buscar(codigoEmpresa, "A", 0, null, localidadeDestino.CodigoIBGE);

                if (listaFreteFracionadoValor.Count > 0)
                {
                    valorTotalNFe = cte.ValorTotalMercadoria;
                    valorMaximoTabela = listaFreteFracionadoValor.Max(x => x.ValorAte);

                    if (valorTotalNFe > valorMaximoTabela)
                    {
                        Dominio.Entidades.FreteFracionadoValor frete = listaFreteFracionadoValor.LastOrDefault();

                        valorFrete = frete.TipoValor == "P" ? valorTotalNFe * (frete.ValorFrete / 100) : frete.ValorFrete;
                        valorAdValorem = frete.PercentualAdValorem > 0 ? valorTotalNFe * (frete.PercentualAdValorem / 100) : 0;
                        valorGris = frete.PercentualGris > 0 ? valorTotalNFe * (frete.PercentualGris / 100) : 0;
                        valorPedagio = frete.ValorPedagio;
                        valorTAS = frete.ValorTAS;
                        decimal valorExcedente = valorTotalNFe - valorMaximoTabela;
                        valorExedenteValor = valorExcedente * frete.ValorExcedente;
                        incluirICMS = frete.IncluiICMS;

                        if (frete.ValorMinimoGris > 0 && valorGris < frete.ValorMinimoGris)
                            valorGris = frete.ValorMinimoGris;
                        if (frete.ValorMinimoAdValorem > 0 && valorAdValorem < frete.ValorMinimoAdValorem)
                            valorAdValorem = frete.ValorMinimoAdValorem;
                    }
                    else
                    {
                        for (int i = 0; i < listaFreteFracionadoValor.Count; i++)
                        {
                            if (listaFreteFracionadoValor[i].ValorDe <= valorTotalNFe && listaFreteFracionadoValor[i].ValorAte >= valorTotalNFe)
                            {
                                valorFrete = listaFreteFracionadoValor[i].TipoValor == "P" ? valorTotalNFe * (listaFreteFracionadoValor[i].ValorFrete / 100) : listaFreteFracionadoValor[i].ValorFrete;
                                valorAdValorem = listaFreteFracionadoValor[i].PercentualAdValorem > 0 ? valorTotalNFe * (listaFreteFracionadoValor[i].PercentualAdValorem / 100) : 0;
                                valorGris = listaFreteFracionadoValor[i].PercentualGris > 0 ? valorTotalNFe * (listaFreteFracionadoValor[i].PercentualGris / 100) : 0;
                                valorPedagio = listaFreteFracionadoValor[i].ValorPedagio;
                                valorTAS = listaFreteFracionadoValor[i].ValorTAS;
                                valorExedenteValor = 0;
                                incluirICMS = listaFreteFracionadoValor[i].IncluiICMS;

                                if (listaFreteFracionadoValor[i].ValorMinimoGris > 0 && valorGris < listaFreteFracionadoValor[i].ValorMinimoGris)
                                    valorGris = listaFreteFracionadoValor[i].ValorMinimoGris;
                                if (listaFreteFracionadoValor[i].ValorMinimoAdValorem > 0 && valorAdValorem < listaFreteFracionadoValor[i].ValorMinimoAdValorem)
                                    valorAdValorem = listaFreteFracionadoValor[i].ValorMinimoAdValorem;

                                break;
                            }
                        }
                    }
                }
                else
                {
                    Repositorio.Frete repFretePorPeso = new Repositorio.Frete(unidadeDeTrabalho);

                    Dominio.Entidades.Frete fretePorPeso = repFretePorPeso.BuscarPorOrigemEDestino(codigoEmpresa, double.Parse(cte.Remetente.CPF_CNPJ), localidadeDestino.Codigo, true, tipoPagamento, Dominio.Enumeradores.TipoTomador.Remetente);
                    if (fretePorPeso == null && cte.Destinatario != null)
                        fretePorPeso = repFretePorPeso.BuscarPorOrigemEDestino(codigoEmpresa, double.Parse(cte.Destinatario.CPF_CNPJ), localidadeDestino.Codigo, true, tipoPagamento, Dominio.Enumeradores.TipoTomador.Destinatario);
                    if (fretePorPeso == null && cte.Expedidor != null)
                        fretePorPeso = repFretePorPeso.BuscarPorOrigemEDestino(codigoEmpresa, double.Parse(cte.Expedidor.CPF_CNPJ), localidadeDestino.Codigo, true, tipoPagamento, Dominio.Enumeradores.TipoTomador.Expedidor);
                    if (fretePorPeso == null && cte.Recebedor != null)
                        fretePorPeso = repFretePorPeso.BuscarPorOrigemEDestino(codigoEmpresa, double.Parse(cte.Recebedor.CPF_CNPJ), localidadeDestino.Codigo, true, tipoPagamento, Dominio.Enumeradores.TipoTomador.Recebedor);
                    if (fretePorPeso == null && cte.Tomador != null)
                        fretePorPeso = repFretePorPeso.BuscarPorOrigemEDestino(codigoEmpresa, double.Parse(cte.Tomador.CPF_CNPJ), localidadeDestino.Codigo, true, tipoPagamento, Dominio.Enumeradores.TipoTomador.Outros);

                    if (fretePorPeso != null)
                    {
                        Repositorio.InformacaoCargaCTE repInformacaoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
                        List<Dominio.Entidades.InformacaoCargaCTE> informacoesCarga = repInformacaoCarga.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);
                        decimal quantidade = (from obj in informacoesCarga where obj.UnidadeMedida.Equals(fretePorPeso.UnidadeDeMedida.CodigoDaUnidade) select obj.Quantidade).Sum();

                        Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                        List<Dominio.Entidades.DocumentosCTE> documentos = repDocumento.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);
                        decimal valorNotas = (from obj in documentos select obj.Valor).Sum();

                        valorFrete = (fretePorPeso.ValorFrete * (quantidade > fretePorPeso.QuantidadeExcedente && fretePorPeso.QuantidadeExcedente > 0 && fretePorPeso.ValorExcedente > 0 ? fretePorPeso.QuantidadeExcedente : quantidade));// + fretePorPeso.ValorSeguro + fretePorPeso.OutrosValores;

                        valorPedagio = fretePorPeso.ValorPedagio;
                        if (fretePorPeso.ValorPedagioPerc > 0)
                            valorPedagio += (fretePorPeso.ValorPedagioPerc * fretePorPeso.ValorPedagioPerc);

                        valorSeguro = fretePorPeso.ValorSeguro;
                        valorOutros = fretePorPeso.OutrosValores;
                        valorDescarga = fretePorPeso.ValorDescarga;

                        if (fretePorPeso.PercentualGris > 0 && valorNotas > 0)
                            valorGris = (valorNotas * (fretePorPeso.PercentualGris / 100));
                        if (fretePorPeso.PercentualAdValorem > 0 && valorNotas > 0)
                            valorAdValorem = (valorNotas * (fretePorPeso.PercentualAdValorem / 100));

                        if (fretePorPeso.ValorExcedente > 0 && fretePorPeso.QuantidadeExcedente < quantidade)
                            valorFrete += ((quantidade - fretePorPeso.QuantidadeExcedente) * fretePorPeso.ValorExcedente);

                        valorMinimo = fretePorPeso.ValorMinimoFrete;
                        tipoMinimoFretePeso = fretePorPeso.TipoMinimo;

                        incluirICMS = fretePorPeso.IncluiICMS;
                        adicionarPedagioBcICMS = fretePorPeso.IncluirPedagioBC;
                        adicionarSeguroBcICMS = fretePorPeso.IncluirSeguroBC;
                        adicionarOutrosBcICMS = fretePorPeso.IncluirOutrosBC;
                        adicionarDescargaBcICMS = fretePorPeso.IncluirDescargaBC;
                        adicionarGrisBcICMS = fretePorPeso.IncluirGrisBC;
                        adicionarAdValoremBcICMS = fretePorPeso.IncluirAdValoremBC;

                    }
                    else
                    {
                        Repositorio.FretePorValor repFretePorValor = new Repositorio.FretePorValor(unidadeDeTrabalho);

                        //Busca tabela valor com cliente e com localidade destino
                        Dominio.Entidades.FretePorValor fretePorValor = repFretePorValor.BuscarParaCalculo(codigoEmpresa, double.Parse(cte.Remetente.CPF_CNPJ), localidadeDestino.Codigo, true, tipoPagamento, codigoIntegracao, Dominio.Enumeradores.TipoTomador.Remetente);
                        if (fretePorValor == null && cte.Destinatario != null)
                            fretePorValor = repFretePorValor.BuscarParaCalculo(codigoEmpresa, double.Parse(cte.Destinatario.CPF_CNPJ), localidadeDestino.Codigo, true, tipoPagamento, codigoIntegracao, Dominio.Enumeradores.TipoTomador.Destinatario);
                        if (fretePorValor == null && cte.Expedidor != null)
                            fretePorValor = repFretePorValor.BuscarParaCalculo(codigoEmpresa, double.Parse(cte.Expedidor.CPF_CNPJ), localidadeDestino.Codigo, true, tipoPagamento, codigoIntegracao, Dominio.Enumeradores.TipoTomador.Expedidor);
                        if (fretePorValor == null && cte.Recebedor != null)
                            fretePorValor = repFretePorValor.BuscarParaCalculo(codigoEmpresa, double.Parse(cte.Recebedor.CPF_CNPJ), localidadeDestino.Codigo, true, tipoPagamento, codigoIntegracao, Dominio.Enumeradores.TipoTomador.Recebedor);
                        if (fretePorValor == null && cte.Tomador != null)
                            fretePorValor = repFretePorValor.BuscarParaCalculo(codigoEmpresa, double.Parse(cte.Tomador.CPF_CNPJ), localidadeDestino.Codigo, true, tipoPagamento, codigoIntegracao, Dominio.Enumeradores.TipoTomador.Outros);

                        if (fretePorValor != null)
                        {
                            Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                            List<Dominio.Entidades.DocumentosCTE> documentos = repDocumento.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);

                            decimal valorTotal = (from obj in documentos select obj.Valor).Sum();
                            decimal valorSobrePercentual = (valorTotal * (fretePorValor.PercentualSobreNF / 100));

                            valorPedagio = fretePorValor.ValorPedagio;
                            adicionarPedagioBcICMS = fretePorValor.IncluirPedagioBC;
                            incluirICMS = fretePorValor.IncluiICMS;

                            if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.ValorMinimoMaisPercentual)
                            {
                                valorFrete = valorSobrePercentual + fretePorValor.ValorMinimoFrete;
                            }
                            else if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.ValorMinimoGarantido)
                            { //Minimo Garantido
                                valorFrete = fretePorValor.ValorMinimoFrete > valorSobrePercentual ? fretePorValor.ValorMinimoFrete : valorSobrePercentual;
                            }
                            else if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.SomentePercentualSobreNF)
                            { //Percentual
                                valorFrete = valorSobrePercentual;
                            }
                        }
                        else
                        {
                            //Busca tabela valor com cliente e sem localidade destino
                            fretePorValor = repFretePorValor.BuscarParaCalculo(codigoEmpresa, cpfCnpjOrigem, 0, true, tipoPagamento, codigoIntegracao, Dominio.Enumeradores.TipoTomador.Remetente);
                            if (fretePorValor == null && cte.Destinatario != null)
                                fretePorValor = repFretePorValor.BuscarParaCalculo(codigoEmpresa, double.Parse(cte.Destinatario.CPF_CNPJ), 0, true, tipoPagamento, codigoIntegracao, Dominio.Enumeradores.TipoTomador.Destinatario);
                            if (fretePorValor == null && cte.Expedidor != null)
                                fretePorValor = repFretePorValor.BuscarParaCalculo(codigoEmpresa, double.Parse(cte.Expedidor.CPF_CNPJ), 0, true, tipoPagamento, codigoIntegracao, Dominio.Enumeradores.TipoTomador.Expedidor);
                            if (fretePorValor == null && cte.Recebedor != null)
                                fretePorValor = repFretePorValor.BuscarParaCalculo(codigoEmpresa, double.Parse(cte.Recebedor.CPF_CNPJ), 0, true, tipoPagamento, codigoIntegracao, Dominio.Enumeradores.TipoTomador.Recebedor);
                            if (fretePorValor == null && cte.Tomador != null)
                                fretePorValor = repFretePorValor.BuscarParaCalculo(codigoEmpresa, double.Parse(cte.Tomador.CPF_CNPJ), 0, true, tipoPagamento, codigoIntegracao, Dominio.Enumeradores.TipoTomador.Outros);

                            if (fretePorValor != null)
                            {
                                Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                                List<Dominio.Entidades.DocumentosCTE> documentos = repDocumento.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);

                                decimal valorTotal = (from obj in documentos select obj.Valor).Sum();
                                decimal valorSobrePercentual = (valorTotal * (fretePorValor.PercentualSobreNF / 100));

                                valorPedagio = fretePorValor.ValorPedagio;
                                adicionarPedagioBcICMS = fretePorValor.IncluirPedagioBC;
                                incluirICMS = fretePorValor.IncluiICMS;

                                if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.ValorMinimoMaisPercentual)
                                {
                                    valorFrete = valorSobrePercentual + fretePorValor.ValorMinimoFrete;
                                }
                                else if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.ValorMinimoGarantido)
                                { //Minimo Garantido
                                    valorFrete = fretePorValor.ValorMinimoFrete > valorSobrePercentual ? fretePorValor.ValorMinimoFrete : valorSobrePercentual;
                                }
                                else if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.SomentePercentualSobreNF)
                                { //Percentual
                                    valorFrete = valorSobrePercentual;
                                }
                            }
                            else
                            {
                                //Busca tabela valor sem cliente e com localidade destino
                                fretePorValor = repFretePorValor.BuscarParaCalculo(codigoEmpresa, 0, localidadeDestino.Codigo, true, tipoPagamento, codigoIntegracao);

                                if (fretePorValor != null)
                                {
                                    Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                                    List<Dominio.Entidades.DocumentosCTE> documentos = repDocumento.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);

                                    decimal valorTotal = (from obj in documentos select obj.Valor).Sum();
                                    decimal valorSobrePercentual = (valorTotal * (fretePorValor.PercentualSobreNF / 100));

                                    valorPedagio = fretePorValor.ValorPedagio;
                                    adicionarPedagioBcICMS = fretePorValor.IncluirPedagioBC;
                                    incluirICMS = fretePorValor.IncluiICMS;

                                    if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.ValorMinimoMaisPercentual)
                                    {
                                        valorFrete = valorSobrePercentual + fretePorValor.ValorMinimoFrete;
                                    }
                                    else if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.ValorMinimoGarantido)
                                    { //Minimo Garantido
                                        valorFrete = fretePorValor.ValorMinimoFrete > valorSobrePercentual ? fretePorValor.ValorMinimoFrete : valorSobrePercentual;
                                    }
                                    else if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.SomentePercentualSobreNF)
                                    { //Percentual
                                        valorFrete = valorSobrePercentual;
                                    }
                                }
                                else
                                {
                                    Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
                                    List<Dominio.Entidades.VeiculoCTE> veiculos = repVeiculoCTe.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);

                                    if ((from obj in veiculos where obj.Veiculo.TipoDoVeiculo != null select obj).Any())
                                    {
                                        Repositorio.FretePorTipoDeVeiculo repFretePorTipoVeiculo = new Repositorio.FretePorTipoDeVeiculo(unidadeDeTrabalho);

                                        Dominio.Entidades.Veiculo tracao = (from obj in veiculos where obj.TipoVeiculo.Equals("0") select obj.Veiculo).FirstOrDefault();
                                        Dominio.Entidades.Veiculo reboque = (from obj in veiculos where obj.TipoVeiculo.Equals("1") select obj.Veiculo).FirstOrDefault();

                                        if (tracao == null)
                                            tracao = (from obj in veiculos select obj.Veiculo).FirstOrDefault();

                                        bool calculouTabelaPorTracao = false;
                                        if (tracao != null && tracao.TipoDoVeiculo != null)
                                        {
                                            Dominio.Entidades.FretePorTipoDeVeiculo fretePorTipoVeiculo = repFretePorTipoVeiculo.BuscarPorOrigemDestinoEDescricaoTipoVeiculo(codigoEmpresa, cpfCnpjOrigem, cpfCnpjDestino, tracao != null ? tracao.TipoDoVeiculo.Descricao : string.Empty, "A", true, tipoPagamento);

                                            if (fretePorTipoVeiculo != null)
                                            {
                                                Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                                                List<Dominio.Entidades.DocumentosCTE> documentos = repDocumento.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);
                                                decimal valorNotas = (from obj in documentos select obj.Valor).Sum();

                                                valorFrete = fretePorTipoVeiculo.ValorFrete;

                                                valorPedagio = fretePorTipoVeiculo.ValorPedagio;

                                                valorDescarga = fretePorTipoVeiculo.ValorDescarga;

                                                if (fretePorTipoVeiculo.PercentualGris > 0 && valorNotas > 0)
                                                    valorGris = (valorNotas * (fretePorTipoVeiculo.PercentualGris / 100));

                                                if (fretePorTipoVeiculo.PercentualAdValorem > 0 && valorNotas > 0)
                                                    valorAdValorem = (valorNotas * (fretePorTipoVeiculo.PercentualAdValorem / 100));
                                                else if (fretePorTipoVeiculo.ValorAdValorem > 0)
                                                    valorAdValorem = fretePorTipoVeiculo.ValorAdValorem;


                                                incluirICMS = fretePorTipoVeiculo.IncluiICMS;
                                                adicionarGrisBcICMS = fretePorTipoVeiculo.AdicionarGrisBcICMS;
                                                adicionarAdValoremBcICMS = fretePorTipoVeiculo.AdicionarAdValoremBcICMS;
                                                adicionarDescargaBcICMS = fretePorTipoVeiculo.AdicionarDescargaBcICMS;
                                                adicionarPedagioBcICMS = fretePorTipoVeiculo.AdicionarPedagioBcICMS;

                                                calculouTabelaPorTracao = true;
                                            }
                                            else
                                            {
                                                fretePorTipoVeiculo = repFretePorTipoVeiculo.BuscarPorOrigemDestinoEDescricaoTipoVeiculo(codigoEmpresa, cpfCnpjOrigem, 0, tracao != null ? tracao.TipoDoVeiculo.Descricao : string.Empty, "A", true, tipoPagamento);

                                                if (fretePorTipoVeiculo != null)
                                                {
                                                    Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                                                    List<Dominio.Entidades.DocumentosCTE> documentos = repDocumento.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);
                                                    decimal valorNotas = (from obj in documentos select obj.Valor).Sum();

                                                    valorFrete = fretePorTipoVeiculo.ValorFrete;

                                                    valorPedagio = fretePorTipoVeiculo.ValorPedagio;

                                                    valorDescarga = fretePorTipoVeiculo.ValorDescarga;

                                                    if (fretePorTipoVeiculo.PercentualGris > 0 && valorNotas > 0)
                                                        valorGris = (valorNotas * (fretePorTipoVeiculo.PercentualGris / 100));

                                                    if (fretePorTipoVeiculo.PercentualAdValorem > 0 && valorNotas > 0)
                                                        valorAdValorem = (valorNotas * (fretePorTipoVeiculo.PercentualAdValorem / 100));
                                                    else if (fretePorTipoVeiculo.ValorAdValorem > 0)
                                                        valorAdValorem = fretePorTipoVeiculo.ValorAdValorem;


                                                    incluirICMS = fretePorTipoVeiculo.IncluiICMS;
                                                    adicionarGrisBcICMS = fretePorTipoVeiculo.AdicionarGrisBcICMS;
                                                    adicionarAdValoremBcICMS = fretePorTipoVeiculo.AdicionarAdValoremBcICMS;
                                                    adicionarDescargaBcICMS = fretePorTipoVeiculo.AdicionarDescargaBcICMS;
                                                    adicionarPedagioBcICMS = fretePorTipoVeiculo.AdicionarPedagioBcICMS;

                                                    calculouTabelaPorTracao = true;
                                                }
                                                else
                                                {
                                                    fretePorTipoVeiculo = repFretePorTipoVeiculo.BuscarPorLocalidadeOrigemDestinoEDescricaoTipoVeiculo(codigoEmpresa, localidadeOrigem.Codigo, localidadeDestino.Codigo, tracao != null ? tracao.TipoDoVeiculo.Descricao : string.Empty, "A", true, tipoPagamento);

                                                    if (fretePorTipoVeiculo != null)
                                                    {
                                                        Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                                                        List<Dominio.Entidades.DocumentosCTE> documentos = repDocumento.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);
                                                        decimal valorNotas = (from obj in documentos select obj.Valor).Sum();

                                                        valorFrete = fretePorTipoVeiculo.ValorFrete;

                                                        valorPedagio = fretePorTipoVeiculo.ValorPedagio;

                                                        valorDescarga = fretePorTipoVeiculo.ValorDescarga;

                                                        if (fretePorTipoVeiculo.PercentualGris > 0 && valorNotas > 0)
                                                            valorGris = (valorNotas * (fretePorTipoVeiculo.PercentualGris / 100));

                                                        if (fretePorTipoVeiculo.PercentualAdValorem > 0 && valorNotas > 0)
                                                            valorAdValorem = (valorNotas * (fretePorTipoVeiculo.PercentualAdValorem / 100));
                                                        else if (fretePorTipoVeiculo.ValorAdValorem > 0)
                                                            valorAdValorem = fretePorTipoVeiculo.ValorAdValorem;

                                                        incluirICMS = fretePorTipoVeiculo.IncluiICMS;
                                                        adicionarGrisBcICMS = fretePorTipoVeiculo.AdicionarGrisBcICMS;
                                                        adicionarAdValoremBcICMS = fretePorTipoVeiculo.AdicionarAdValoremBcICMS;
                                                        adicionarDescargaBcICMS = fretePorTipoVeiculo.AdicionarDescargaBcICMS;
                                                        adicionarPedagioBcICMS = fretePorTipoVeiculo.AdicionarPedagioBcICMS;

                                                        calculouTabelaPorTracao = true;
                                                    }
                                                }
                                            }
                                        }

                                        if (!calculouTabelaPorTracao && reboque != null && reboque.TipoDoVeiculo != null)
                                        {
                                            Dominio.Entidades.FretePorTipoDeVeiculo fretePorTipoVeiculo = repFretePorTipoVeiculo.BuscarPorOrigemDestinoEDescricaoTipoVeiculo(codigoEmpresa, cpfCnpjOrigem, cpfCnpjDestino, reboque != null ? reboque.TipoDoVeiculo.Descricao : string.Empty, "A", true, tipoPagamento);

                                            if (fretePorTipoVeiculo != null)
                                            {
                                                Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                                                List<Dominio.Entidades.DocumentosCTE> documentos = repDocumento.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);
                                                decimal valorNotas = (from obj in documentos select obj.Valor).Sum();

                                                valorFrete = fretePorTipoVeiculo.ValorFrete;

                                                valorPedagio = fretePorTipoVeiculo.ValorPedagio;

                                                valorDescarga = fretePorTipoVeiculo.ValorDescarga;

                                                if (fretePorTipoVeiculo.PercentualGris > 0 && valorNotas > 0)
                                                    valorGris = (valorNotas * (fretePorTipoVeiculo.PercentualGris / 100));

                                                if (fretePorTipoVeiculo.PercentualAdValorem > 0 && valorNotas > 0)
                                                    valorAdValorem = (valorNotas * (fretePorTipoVeiculo.PercentualAdValorem / 100));
                                                else if (fretePorTipoVeiculo.ValorAdValorem > 0)
                                                    valorAdValorem = fretePorTipoVeiculo.ValorAdValorem;


                                                incluirICMS = fretePorTipoVeiculo.IncluiICMS;
                                                adicionarGrisBcICMS = fretePorTipoVeiculo.AdicionarGrisBcICMS;
                                                adicionarAdValoremBcICMS = fretePorTipoVeiculo.AdicionarAdValoremBcICMS;
                                                adicionarDescargaBcICMS = fretePorTipoVeiculo.AdicionarDescargaBcICMS;
                                                adicionarPedagioBcICMS = fretePorTipoVeiculo.AdicionarPedagioBcICMS;
                                            }
                                            else
                                            {
                                                fretePorTipoVeiculo = repFretePorTipoVeiculo.BuscarPorOrigemDestinoEDescricaoTipoVeiculo(codigoEmpresa, cpfCnpjOrigem, 0, reboque != null ? reboque.TipoDoVeiculo.Descricao : string.Empty, "A", true, tipoPagamento);

                                                if (fretePorTipoVeiculo != null)
                                                {
                                                    Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                                                    List<Dominio.Entidades.DocumentosCTE> documentos = repDocumento.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);
                                                    decimal valorNotas = (from obj in documentos select obj.Valor).Sum();

                                                    valorFrete = fretePorTipoVeiculo.ValorFrete;

                                                    valorPedagio = fretePorTipoVeiculo.ValorPedagio;

                                                    valorDescarga = fretePorTipoVeiculo.ValorDescarga;

                                                    if (fretePorTipoVeiculo.PercentualGris > 0 && valorNotas > 0)
                                                        valorGris = (valorNotas * (fretePorTipoVeiculo.PercentualGris / 100));

                                                    if (fretePorTipoVeiculo.PercentualAdValorem > 0 && valorNotas > 0)
                                                        valorAdValorem = (valorNotas * (fretePorTipoVeiculo.PercentualAdValorem / 100));
                                                    else if (fretePorTipoVeiculo.ValorAdValorem > 0)
                                                        valorAdValorem = fretePorTipoVeiculo.ValorAdValorem;


                                                    incluirICMS = fretePorTipoVeiculo.IncluiICMS;
                                                    adicionarGrisBcICMS = fretePorTipoVeiculo.AdicionarGrisBcICMS;
                                                    adicionarAdValoremBcICMS = fretePorTipoVeiculo.AdicionarAdValoremBcICMS;
                                                    adicionarDescargaBcICMS = fretePorTipoVeiculo.AdicionarDescargaBcICMS;
                                                    adicionarPedagioBcICMS = fretePorTipoVeiculo.AdicionarPedagioBcICMS;
                                                }
                                                else
                                                {
                                                    fretePorTipoVeiculo = repFretePorTipoVeiculo.BuscarPorLocalidadeOrigemDestinoEDescricaoTipoVeiculo(codigoEmpresa, localidadeOrigem.Codigo, localidadeDestino.Codigo, reboque != null ? reboque.TipoDoVeiculo.Descricao : string.Empty, "A", true, tipoPagamento);

                                                    if (fretePorTipoVeiculo != null)
                                                    {
                                                        Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                                                        List<Dominio.Entidades.DocumentosCTE> documentos = repDocumento.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);
                                                        decimal valorNotas = (from obj in documentos select obj.Valor).Sum();

                                                        valorFrete = fretePorTipoVeiculo.ValorFrete;

                                                        valorPedagio = fretePorTipoVeiculo.ValorPedagio;

                                                        valorDescarga = fretePorTipoVeiculo.ValorDescarga;

                                                        if (fretePorTipoVeiculo.PercentualGris > 0 && valorNotas > 0)
                                                            valorGris = (valorNotas * (fretePorTipoVeiculo.PercentualGris / 100));

                                                        if (fretePorTipoVeiculo.PercentualAdValorem > 0 && valorNotas > 0)
                                                            valorAdValorem = (valorNotas * (fretePorTipoVeiculo.PercentualAdValorem / 100));
                                                        else if (fretePorTipoVeiculo.ValorAdValorem > 0)
                                                            valorAdValorem = fretePorTipoVeiculo.ValorAdValorem;

                                                        incluirICMS = fretePorTipoVeiculo.IncluiICMS;
                                                        adicionarGrisBcICMS = fretePorTipoVeiculo.AdicionarGrisBcICMS;
                                                        adicionarAdValoremBcICMS = fretePorTipoVeiculo.AdicionarAdValoremBcICMS;
                                                        adicionarDescargaBcICMS = fretePorTipoVeiculo.AdicionarDescargaBcICMS;
                                                        adicionarPedagioBcICMS = fretePorTipoVeiculo.AdicionarPedagioBcICMS;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            if (valorFrete > 0)
            {
                this.SalvarValoresFrete(ref cte, incluirICMS, valorFrete + valorExedentePeso + valorExedenteValor, valorAdValorem, valorPedagio, valorGris, valorDescarga, calcularImpostos, adicionarGrisBcICMS, adicionarAdValoremBcICMS, adicionarPedagioBcICMS, adicionarDescargaBcICMS, valorSeguro, adicionarSeguroBcICMS, valorOutros, adicionarOutrosBcICMS, valorMinimo, valorTAS, tipoMinimoFretePeso, unidadeDeTrabalho);
                return true;
            }
            else
                return false;
        }

        private void SalvarValoresFrete(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.Enumeradores.IncluiICMSFrete incluirICMS, decimal valorFrete, decimal valorAdicional, decimal valorPedagio, decimal valorGris, decimal valorDescarga, bool calcularImpostos, Dominio.Enumeradores.OpcaoSimNao adicionarGrisBcICMS, Dominio.Enumeradores.OpcaoSimNao adicionarAdValoremBcICMS, Dominio.Enumeradores.OpcaoSimNao adicionarPedagioBcICMS, Dominio.Enumeradores.OpcaoSimNao adicionarDescargaBcICMS, decimal valorSeguro, Dominio.Enumeradores.OpcaoSimNao adicionarSeguroBcICMS, decimal valorOutros, Dominio.Enumeradores.OpcaoSimNao adicionarOutrosBcICMS, decimal valorMinimo, decimal valorTAS, Dominio.Enumeradores.TipoFrete tipoMinimoFretePeso, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ComponentePrestacaoCTE repComponentePrestacao = new Repositorio.ComponentePrestacaoCTE(unitOfWork);
            List<Dominio.Entidades.ComponentePrestacaoCTE> componentes = repComponentePrestacao.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);

            bool utilizouMinimoFrete = false;
            if (tipoMinimoFretePeso == Dominio.Enumeradores.TipoFrete.ValorMinimoMaisComponentes && valorFrete < valorMinimo)
            {
                valorFrete = valorMinimo;
                utilizouMinimoFrete = false;
            }
            else if (tipoMinimoFretePeso == Dominio.Enumeradores.TipoFrete.ValorMinimoGarantido)
            {
                if ((valorFrete + valorPedagio + valorAdicional + valorGris + valorDescarga + valorSeguro + valorOutros) < valorMinimo)
                {
                    valorFrete = valorMinimo;
                    utilizouMinimoFrete = true;
                    incluirICMS = Dominio.Enumeradores.IncluiICMSFrete.Nao;
                }
            }
            cte.IncluirICMSNoFrete = incluirICMS == Dominio.Enumeradores.IncluiICMSFrete.Sim ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao;
            cte.ValorFrete = Math.Round(valorFrete, 2, MidpointRounding.ToEven);
            cte.ValorPrestacaoServico = cte.ValorFrete;
            cte.ValorAReceber = cte.ValorFrete;
            cte.BaseCalculoICMS = cte.ValorFrete;

            Dominio.Entidades.ComponentePrestacaoCTE componenteFreteValorCTe = (from obj in componentes where obj.Nome.ToUpper().Contains("FRETE VALOR") select obj).FirstOrDefault();

            if (componenteFreteValorCTe == null)
                componenteFreteValorCTe = new Dominio.Entidades.ComponentePrestacaoCTE();

            componenteFreteValorCTe.CTE = cte;
            componenteFreteValorCTe.IncluiNaBaseDeCalculoDoICMS = false;
            componenteFreteValorCTe.IncluiNoTotalAReceber = true;
            componenteFreteValorCTe.Nome = "FRETE VALOR";
            componenteFreteValorCTe.Valor = cte.ValorFrete;

            repComponentePrestacao.Inserir(componenteFreteValorCTe);

            if (valorPedagio > 0)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componentePedagioCTe = (from obj in componentes where obj.Nome.ToUpper().Contains("FRETE PEDAGIO") || obj.Nome.ToUpper().Contains("PEDAGIO") select obj).FirstOrDefault();

                if (componentePedagioCTe == null)
                    componentePedagioCTe = new Dominio.Entidades.ComponentePrestacaoCTE();

                componentePedagioCTe.CTE = cte;
                componentePedagioCTe.IncluiNaBaseDeCalculoDoICMS = adicionarPedagioBcICMS == Dominio.Enumeradores.OpcaoSimNao.Sim && !utilizouMinimoFrete ? true : false;
                componentePedagioCTe.IncluiNoTotalAReceber = !utilizouMinimoFrete ? true : false;
                componentePedagioCTe.Nome = "PEDAGIO";
                componentePedagioCTe.Valor = Math.Round(valorPedagio, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componentePedagioCTe);

                if (componentePedagioCTe.IncluiNaBaseDeCalculoDoICMS)
                    cte.BaseCalculoICMS += componentePedagioCTe.Valor;

                if (componentePedagioCTe.IncluiNoTotalAReceber)
                {
                    cte.ValorPrestacaoServico += componentePedagioCTe.Valor;
                    cte.ValorAReceber += componentePedagioCTe.Valor;
                }
            }

            if (valorAdicional > 0)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteAdicionalValorCTe = (from obj in componentes where obj.Nome.ToUpper().Contains("AD VALOREM") select obj).FirstOrDefault();

                if (componenteAdicionalValorCTe == null)
                    componenteAdicionalValorCTe = new Dominio.Entidades.ComponentePrestacaoCTE();

                componenteAdicionalValorCTe.CTE = cte;
                componenteAdicionalValorCTe.IncluiNaBaseDeCalculoDoICMS = adicionarAdValoremBcICMS == Dominio.Enumeradores.OpcaoSimNao.Sim && !utilizouMinimoFrete ? true : false;
                componenteAdicionalValorCTe.IncluiNoTotalAReceber = !utilizouMinimoFrete ? true : false;
                componenteAdicionalValorCTe.Nome = "AD VALOREM";
                componenteAdicionalValorCTe.Valor = Math.Round(valorAdicional, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componenteAdicionalValorCTe);

                if (componenteAdicionalValorCTe.IncluiNaBaseDeCalculoDoICMS)
                    cte.BaseCalculoICMS += componenteAdicionalValorCTe.Valor;

                if (componenteAdicionalValorCTe.IncluiNoTotalAReceber)
                {
                    cte.ValorPrestacaoServico += componenteAdicionalValorCTe.Valor;
                    cte.ValorAReceber += componenteAdicionalValorCTe.Valor;
                }
            }

            if (valorGris > 0)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteGris = (from obj in componentes where obj.Nome.ToUpper().Contains("GRIS") select obj).FirstOrDefault();

                if (componenteGris == null)
                    componenteGris = new Dominio.Entidades.ComponentePrestacaoCTE();

                componenteGris.CTE = cte;
                componenteGris.IncluiNaBaseDeCalculoDoICMS = adicionarGrisBcICMS == Dominio.Enumeradores.OpcaoSimNao.Sim && !utilizouMinimoFrete ? true : false;
                componenteGris.IncluiNoTotalAReceber = !utilizouMinimoFrete ? true : false;
                componenteGris.Nome = "GRIS";
                componenteGris.Valor = Math.Round(valorGris, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componenteGris);

                if (componenteGris.IncluiNaBaseDeCalculoDoICMS)
                    cte.BaseCalculoICMS += componenteGris.Valor;

                if (componenteGris.IncluiNoTotalAReceber)
                {
                    cte.ValorPrestacaoServico += componenteGris.Valor;
                    cte.ValorAReceber += componenteGris.Valor;
                }
            }

            if (valorDescarga > 0)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteDescarga = (from obj in componentes where obj.Nome.ToUpper().Contains("DESCARGA") select obj).FirstOrDefault();

                if (componenteDescarga == null)
                    componenteDescarga = new Dominio.Entidades.ComponentePrestacaoCTE();

                componenteDescarga.CTE = cte;
                componenteDescarga.IncluiNaBaseDeCalculoDoICMS = adicionarDescargaBcICMS == Dominio.Enumeradores.OpcaoSimNao.Sim && !utilizouMinimoFrete ? true : false;
                componenteDescarga.IncluiNoTotalAReceber = !utilizouMinimoFrete ? true : false;
                componenteDescarga.Nome = "DESCARGA";
                componenteDescarga.Valor = Math.Round(valorDescarga, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componenteDescarga);

                if (componenteDescarga.IncluiNaBaseDeCalculoDoICMS)
                    cte.BaseCalculoICMS += componenteDescarga.Valor;

                if (componenteDescarga.IncluiNoTotalAReceber)
                {
                    cte.ValorPrestacaoServico += componenteDescarga.Valor;
                    cte.ValorAReceber += componenteDescarga.Valor;
                }
            }

            if (valorSeguro > 0)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteSeguro = (from obj in componentes where obj.Nome.ToUpper().Contains("SEGURO") select obj).FirstOrDefault();

                if (componenteSeguro == null)
                    componenteSeguro = new Dominio.Entidades.ComponentePrestacaoCTE();

                componenteSeguro.CTE = cte;
                componenteSeguro.IncluiNaBaseDeCalculoDoICMS = adicionarSeguroBcICMS == Dominio.Enumeradores.OpcaoSimNao.Sim && !utilizouMinimoFrete ? true : false;
                componenteSeguro.IncluiNoTotalAReceber = !utilizouMinimoFrete ? true : false;
                componenteSeguro.Nome = "SEGURO";
                componenteSeguro.Valor = Math.Round(valorSeguro, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componenteSeguro);

                if (componenteSeguro.IncluiNaBaseDeCalculoDoICMS)
                    cte.BaseCalculoICMS += componenteSeguro.Valor;

                if (componenteSeguro.IncluiNoTotalAReceber)
                {
                    cte.ValorPrestacaoServico += componenteSeguro.Valor;
                    cte.ValorAReceber += componenteSeguro.Valor;
                }
            }

            if (valorOutros > 0)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteOutros = (from obj in componentes where obj.Nome.ToUpper().Contains("OUTROS") select obj).FirstOrDefault();

                if (componenteOutros == null)
                    componenteOutros = new Dominio.Entidades.ComponentePrestacaoCTE();

                componenteOutros.CTE = cte;
                componenteOutros.IncluiNaBaseDeCalculoDoICMS = adicionarOutrosBcICMS == Dominio.Enumeradores.OpcaoSimNao.Sim && !utilizouMinimoFrete ? true : false;
                componenteOutros.IncluiNoTotalAReceber = !utilizouMinimoFrete ? true : false;
                componenteOutros.Nome = "OUTROS";
                componenteOutros.Valor = Math.Round(valorOutros, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componenteOutros);

                if (componenteOutros.IncluiNaBaseDeCalculoDoICMS)
                    cte.BaseCalculoICMS += componenteOutros.Valor;

                if (componenteOutros.IncluiNoTotalAReceber)
                {
                    cte.ValorPrestacaoServico += componenteOutros.Valor;
                    cte.ValorAReceber += componenteOutros.Valor;
                }
            }

            if (valorTAS > 0)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteTASCTe = (from obj in componentes where obj.Nome.ToUpper().Contains("TAS") select obj).FirstOrDefault();

                if (componenteTASCTe == null)
                    componenteTASCTe = new Dominio.Entidades.ComponentePrestacaoCTE();

                componenteTASCTe.CTE = cte;
                componenteTASCTe.IncluiNaBaseDeCalculoDoICMS = true;
                componenteTASCTe.IncluiNoTotalAReceber = !utilizouMinimoFrete ? true : false;
                componenteTASCTe.Nome = "TAS";
                componenteTASCTe.Valor = Math.Round(valorTAS, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componenteTASCTe);

                if (componenteTASCTe.IncluiNaBaseDeCalculoDoICMS)
                    cte.BaseCalculoICMS += componenteTASCTe.Valor;

                if (componenteTASCTe.IncluiNoTotalAReceber)
                {
                    cte.ValorPrestacaoServico += componenteTASCTe.Valor;
                    cte.ValorAReceber += componenteTASCTe.Valor;
                }
            }

            if (calcularImpostos && cte.AliquotaICMS > 0)
            {
                cte.ValorICMS = Math.Round(cte.BaseCalculoICMS * (cte.AliquotaICMS / 100), 2, MidpointRounding.ToEven);

                if (incluirICMS == Dominio.Enumeradores.IncluiICMSFrete.Sim)
                {
                    decimal bcICMSSemInclusao = cte.BaseCalculoICMS;
                    cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Sim;
                    cte.PercentualICMSIncluirNoFrete = 100;

                    cte.BaseCalculoICMS = Math.Round(cte.BaseCalculoICMS / (1 - (cte.AliquotaICMS / 100)), 2, MidpointRounding.ToEven);
                    cte.ValorICMS = Math.Round(cte.BaseCalculoICMS * (cte.AliquotaICMS / 100), 2, MidpointRounding.ToEven);

                    decimal valorImpostoIncluso = Math.Round(cte.BaseCalculoICMS - bcICMSSemInclusao, 2, MidpointRounding.ToEven);
                    if (valorImpostoIncluso > 0)
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteImpostoCTe = (from obj in componentes where obj.Nome.ToUpper().Contains("IMPOSTOS") select obj).FirstOrDefault();

                        if (componenteImpostoCTe == null)
                            componenteImpostoCTe = new Dominio.Entidades.ComponentePrestacaoCTE();

                        componenteImpostoCTe.CTE = cte;
                        componenteImpostoCTe.IncluiNaBaseDeCalculoDoICMS = false;
                        componenteImpostoCTe.IncluiNoTotalAReceber = false;
                        componenteImpostoCTe.Nome = "IMPOSTOS";
                        componenteImpostoCTe.Valor = valorImpostoIncluso;

                        repComponentePrestacao.Inserir(componenteImpostoCTe);
                    }

                    cte.ValorPrestacaoServico += valorImpostoIncluso;
                    if (cte.CST != "60")
                        cte.ValorAReceber += valorImpostoIncluso;
                }
                else
                    cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Nao;
            }
        }

        private void CalcularImpostos(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.NDDigital.v104.Emissao.Registro14000 impostos, List<Dominio.NDDigital.v104.Emissao.Registro13110> componentes, Dominio.Entidades.Aliquota aliquota = null, Repositorio.UnitOfWork unidadeDeTrabalho = null)
        {
            if (impostos.ICMS00 != null)
            {
                cte.CST = impostos.ICMS00.CST;
                cte.AliquotaICMS = impostos.ICMS00.pICMS;
                cte.BaseCalculoICMS = impostos.ICMS00.vBC;
                cte.ValorICMS = impostos.ICMS00.vICMS;

                this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);
            }
            else if (impostos.ICMS20 != null)
            {
                cte.CST = impostos.ICMS20.CST;
                cte.AliquotaICMS = impostos.ICMS20.pICMS;
                cte.PercentualReducaoBaseCalculoICMS = impostos.ICMS20.pRedBC;
                cte.BaseCalculoICMS = impostos.ICMS20.vBC;
                cte.ValorICMS = impostos.ICMS20.vICMS;

                this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);
            }
            else if (impostos.ICMS45 != null)
            {
                cte.CST = impostos.ICMS45.CST;

                this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);
            }
            else if (impostos.ICMS60 != null)
            {
                cte.CST = impostos.ICMS60.CST;
                cte.AliquotaICMS = impostos.ICMS60.pICMSSTRet;
                cte.BaseCalculoICMS = impostos.ICMS60.vBCSTRet;
                cte.ValorPresumido = impostos.ICMS60.vCred;
                cte.ValorICMS = impostos.ICMS60.vICMSSTRet;

                this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);
            }
            else if (impostos.ICMS90 != null)
            {
                cte.CST = impostos.ICMS90.CST;
                cte.AliquotaICMS = impostos.ICMS90.pICMS;
                cte.PercentualReducaoBaseCalculoICMS = impostos.ICMS90.pRedBC;
                cte.BaseCalculoICMS = impostos.ICMS90.vBC;
                cte.ValorPresumido = impostos.ICMS90.vCred;
                cte.ValorICMS = impostos.ICMS90.vICMS;

                this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);
            }
            else if (impostos.ICMSOutraUF != null)
            {
                cte.CST = impostos.ICMSOutraUF.CST;
                cte.AliquotaICMS = impostos.ICMSOutraUF.pICMSOutraUF;
                cte.PercentualReducaoBaseCalculoICMS = impostos.ICMSOutraUF.pRedBCOutraUF;
                cte.BaseCalculoICMS = impostos.ICMSOutraUF.vBCOutraUF;
                cte.ValorICMS = impostos.ICMSOutraUF.vICMSOutraUF;

                this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);
            }
            else if (impostos.ICMSSN != null)
            {
                cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Sim;
                cte.CST = "";

                this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);
            }
            else
            {
                this.CalcularICMSPorTabelaDeAliquotasNDD(ref cte, cte.SimplesNacional, componentes, null, unidadeDeTrabalho);
            }
        }

        private void CalcularImpostos(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.ObjetosDeValor.CTe.CTe cteIntegracao, string descricaoComponenteImposto, bool descontarImpostoDoValorDoFrete, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Servicos.Embarcador.Imposto.ImpostoIBSCBS servicoImpostoIBSCBS = new Servicos.Embarcador.Imposto.ImpostoIBSCBS(unidadeDeTrabalho);

            if (string.IsNullOrWhiteSpace(descricaoComponenteImposto))
                descricaoComponenteImposto = "IMPOSTOS";
            else
                descricaoComponenteImposto = Utilidades.String.Left(descricaoComponenteImposto, 15);

            bool configOptanteSimples = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().UtilizaOptanteSimplesNacionalDaIntegracao.Value;

            if (cteIntegracao.Emitente.OptanteSimplesNacional != null && configOptanteSimples)
                cte.SimplesNacional = cteIntegracao.Emitente.OptanteSimplesNacional == true ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao;
            else if (cte.Empresa.Localidade.Estado.Sigla != cte.LocalidadeInicioPrestacao.Estado.Sigla)
                cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Nao;
            else
            {
                cte.SimplesNacional = cte.Empresa.OptanteSimplesNacional ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao;

                if (tipoServicoMultisoftware != null && (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador || tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS))
                {
                    if (cteIntegracao.ICMS != null && cteIntegracao.ICMS.CST == "" && cte.SimplesNacional == OpcaoSimNao.Nao && cte.TipoCTE == TipoCTE.Complemento)
                        cte.SimplesNacional = OpcaoSimNao.Sim;
                }
            }

            //Quando empresa é do Simples e for subcontratação SEMPRE emitir CTe como Simples Nacional (Solicitado pelo Cesar para a Coopercaga 27/01/2017)
            if ((tipoServicoMultisoftware == null || tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe) && cte.Empresa.OptanteSimplesNacional && cte.TipoServico == Dominio.Enumeradores.TipoServico.SubContratacao)
            {
                cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Sim;
                this.CalcularICMSPorTabelaDeAliquotas(ref cte, cte.SimplesNacional, unidadeDeTrabalho);
            }
            else if (cteIntegracao.ICMS != null && !string.IsNullOrWhiteSpace(cteIntegracao.ICMS.CST))
            {
                if (cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.CTe || cte.ModeloDocumentoFiscal.CalcularImpostos)
                {
                    cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Nao;
                    cte.CST = cteIntegracao.ICMS.CST;

                    if (cte.CST == "40" || cte.CST == "41" || cte.CST == "51")
                    {
                        cte.AliquotaICMS = 0m;
                        cte.PercentualReducaoBaseCalculoICMS = 0m;
                        cte.BaseCalculoICMS = 0m;
                        cte.ValorPresumido = 0m;
                        cte.ValorICMS = 0m;
                        cte.ValorICMSDevido = 0m;
                        cte.ValorICMSDesoneracao = cteIntegracao.ICMS.ValorDesoneracao;
                        cte.CodigoBeneficio = cteIntegracao.ICMS.CodigoBeneficio;
                    }
                    else
                    {
                        cte.AliquotaICMS = cteIntegracao.ICMS.Aliquota;
                        cte.PercentualReducaoBaseCalculoICMS = cteIntegracao.ICMS.PercentualReducaoBaseCalculo;
                        cte.BaseCalculoICMS = cteIntegracao.ICMS.BaseCalculo;
                        cte.ValorPresumido = cteIntegracao.ICMS.ValorCreditoPresumido;
                        cte.ValorICMS = cteIntegracao.ICMS.Valor;
                        cte.ValorICMSDevido = cteIntegracao.ICMS.ValorDevido;
                        cte.ValorICMSDesoneracao = cteIntegracao.ICMS.ValorDesoneracao;
                        cte.CodigoBeneficio = cteIntegracao.ICMS.CodigoBeneficio;

                        if (Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().RecalcularICMSNaEmissaoCTe.Value)
                        {
                            if (cte.PercentualReducaoBaseCalculoICMS <= 0)
                            {
                                if (cte.BaseCalculoICMS > 0 && cte.AliquotaICMS > 0)
                                    cte.ValorICMS = Math.Round((cte.BaseCalculoICMS * (cte.AliquotaICMS / 100)), 2, MidpointRounding.ToEven);
                            }
                        }
                    }

                    if (cteIntegracao.CFOP == 0)
                        this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);

                    if ((cte.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim) || (cte.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && cte.Empresa.Configuracao != null && cte.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0))
                    {
                        bool incluiTotalReceber = (cte.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && cte.Empresa.Configuracao != null && cte.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0);
                        this.SalvarInformacoesComponentesDaPrestacao(cte, descricaoComponenteImposto, (cteIntegracao.ICMS.ValorIncluso > 0m ? cteIntegracao.ICMS.ValorIncluso : cteIntegracao.ICMS.Valor), false, incluiTotalReceber, unidadeDeTrabalho);
                    }
                }
            }
            else if (cteIntegracao.ICMS != null && cte.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && tipoServicoMultisoftware != null && (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador || tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS))
            {
                cte.CST = "";
            }
            else
            {
                if (cte.ModeloDocumentoFiscal.Numero == "57")
                {
                    if (cte.TipoServico == Dominio.Enumeradores.TipoServico.SubContratacao)
                        cte.CST = "40";
                    else
                        this.CalcularICMSPorTabelaDeAliquotas(ref cte, cte.SimplesNacional, unidadeDeTrabalho, true, null, descontarImpostoDoValorDoFrete);

                    if (cteIntegracao.CFOP == 0 && cte.CFOP == null)
                        this.SetarCFOPENaturezaPorTabelaDeAliquotas(ref cte, unidadeDeTrabalho);

                    if (cte.NaturezaDaOperacao == null && cte.CFOP?.NaturezaDaOperacao != null)
                        cte.NaturezaDaOperacao = cte.CFOP.NaturezaDaOperacao;

                    Dominio.ObjetosDeValor.Embarcador.Imposto.ParametroCalculoIBSCBS parametroCalculo = new Dominio.ObjetosDeValor.Embarcador.Imposto.ParametroCalculoIBSCBS
                    {
                        BaseCalculo = ObterBaseCalculoIBSCBS(cte, unidadeDeTrabalho),
                        CodigoLocalidade = cte.Destinatario?.Localidade?.Codigo ?? cte.LocalidadeTerminoPrestacao?.Codigo ?? 0,
                        SiglaUF = cte.Destinatario?.Localidade?.Estado?.Sigla ?? cte.LocalidadeTerminoPrestacao?.Estado?.Sigla,
                        CodigoTipoOperacao = 0,
                        Empresa = cte.Empresa
                    };

                    cteIntegracao.IBSCBS = servicoImpostoIBSCBS.ObterImpostoIBSCBSDoCTe(servicoImpostoIBSCBS.ObterImpostoIBSCBS(parametroCalculo));
                }
                else
                {
                    cte.CST = "";
                }
            }

            if (cte.ValorICMS == 0 && (cte.Empresa.Configuracao?.NaoGerarCteComICMSZerado ?? false))
            {
                if (cte.BaseCalculoICMS > 0 && cte.AliquotaICMS > 0 && (cte.CST == "00" || cte.CST == "20" || cte.CST == "90" || cte.CST == "91" || cte.CST == "60"))
                {
                    cte.ValorICMS = 0.01m;
                    cte.BaseCalculoICMS += cte.ValorICMS;
                    cte.ValorPrestacaoServico += cte.ValorICMS;
                    cte.ValorAReceber += cte.ValorICMS;
                    if ((cte.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim) || (cte.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && cte.Empresa.Configuracao != null && cte.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0))
                    {
                        bool incluiTotalReceber = (cte.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && cte.Empresa.Configuracao != null && cte.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0);
                        this.SalvarInformacoesComponentesDaPrestacao(cte, descricaoComponenteImposto, cte.ValorICMS, false, incluiTotalReceber, unidadeDeTrabalho);
                    }
                }
            }

            if (cteIntegracao.IBSCBS != null)
            {
                Dominio.ObjetosDeValor.CTe.ImpostoIBSCBS impostoIBSCBS = cteIntegracao.IBSCBS;

                cte.NBS = impostoIBSCBS.NBS;
                cte.CodigoIndicadorOperacao = impostoIBSCBS.CodigoIndicadorOperacao;
                cte.CSTIBSCBS = impostoIBSCBS.CST;
                cte.ClassificacaoTributariaIBSCBS = impostoIBSCBS.ClassificacaoTributaria;
                cte.BaseCalculoIBSCBS = impostoIBSCBS.BaseCalculo;

                cte.AliquotaIBSEstadual = impostoIBSCBS.AliquotaIBSEstadual;
                cte.PercentualReducaoIBSEstadual = impostoIBSCBS.PercentualReducaoIBSEstadual;
                cte.AliquotaIBSEstadualEfetiva = impostoIBSCBS.AliquotaIBSEstadualEfetiva;
                cte.ValorIBSEstadual = impostoIBSCBS.ValorIBSEstadual;

                cte.AliquotaIBSMunicipal = impostoIBSCBS.AliquotaIBSMunicipal;
                cte.PercentualReducaoIBSMunicipal = impostoIBSCBS.PercentualReducaoIBSMunicipal;
                cte.AliquotaIBSMunicipalEfetiva = impostoIBSCBS.AliquotaIBSMunicipalEfetiva;
                cte.ValorIBSMunicipal = impostoIBSCBS.ValorIBSMunicipal;

                cte.AliquotaCBS = impostoIBSCBS.AliquotaCBS;
                cte.PercentualReducaoCBS = impostoIBSCBS.PercentualReducaoCBS;
                cte.AliquotaCBSEfetiva = impostoIBSCBS.AliquotaCBSEfetiva;
                cte.ValorCBS = impostoIBSCBS.ValorCBS;

                cte.SetarRegraOutraAliquota(servicoImpostoIBSCBS.ObterOutrasAliquotasIBSCBS(cte.CSTIBSCBS)?.Codigo ?? 0);
            }
        }

        private decimal ObterBaseCalculoIBSCBS(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            List<Dominio.Entidades.ComponentePrestacaoCTE> componentes = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho).BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);

            decimal valorBaseCalculo = 0;
            bool impostoNosComponentes = false;

            for (int i = 0; i < componentes.Count(); i++)
            {
                if (componentes[i].Nome != "IMPOSTOS")
                    valorBaseCalculo += componentes[i].Valor;
                else
                    impostoNosComponentes = true;
            }

            return impostoNosComponentes ? valorBaseCalculo : (valorBaseCalculo - cte.ValorICMS);
        }

        public void SetarCSTPorTabelaDeAliquotas(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);

            Servicos.Embarcador.Carga.ICMS svcICMS = new Embarcador.Carga.ICMS(unidadeDeTrabalho);

            bool incluirICMS = cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim ? true : false;
            decimal percentualInclusaoICMS = cte.PercentualICMSIncluirNoFrete;
            decimal valorBaseICMS = cte.BaseCalculoICMS;

            Dominio.Entidades.Localidade localidadeTermino = cte.LocalidadeTerminoPrestacao;
            Dominio.Entidades.Localidade localidadeExterior = null;
            if (cte.Destinatario?.Exterior ?? false)
            {
                localidadeExterior = repLocalidade.BuscarPorEstado("EX");
                if (localidadeExterior != null)
                    localidadeTermino = localidadeExterior;
            }

            Dominio.ObjetosDeValor.Embarcador.ICMS.RegraICMS regraICMS = svcICMS.BuscarRegraICMSMultiCTe(cte.Empresa, cte.SimplesNacional, cte.Remetente.Cliente, cte.Destinatario.Cliente, cte.Tomador.Cliente, cte.LocalidadeInicioPrestacao, localidadeTermino, (localidadeExterior != null), ref incluirICMS, ref percentualInclusaoICMS, valorBaseICMS, cte.TipoServico, cte.CodigoProdutoEmbarcador, unidadeDeTrabalho);

            if (regraICMS != null && !string.IsNullOrWhiteSpace(regraICMS.CST))
            {
                cte.CST = regraICMS.CST;
            }
            else
            {
                Dominio.Entidades.Aliquota aliquota = this.ObterAliquota(cte, unidadeDeTrabalho);

                if (aliquota != null)
                    cte.CST = aliquota.CST;
            }
        }

        public void SetarCFOPENaturezaPorTabelaDeAliquotas(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);

            Servicos.Embarcador.Carga.ICMS svcICMS = new Embarcador.Carga.ICMS(unidadeDeTrabalho);

            bool incluirICMS = cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim;
            decimal percentualInclusaoICMS = cte.PercentualICMSIncluirNoFrete;
            decimal valorBaseICMS = cte.BaseCalculoICMS;

            Dominio.Entidades.Localidade localidadeTermino = cte.LocalidadeTerminoPrestacao;
            Dominio.Entidades.Localidade localidadeExterior = null;
            if (cte.Recebedor == null && (cte.Destinatario?.Exterior ?? false))
            {
                localidadeExterior = repLocalidade.BuscarPorEstado("EX");
                if (localidadeExterior != null)
                    localidadeTermino = localidadeExterior;
            }

            Dominio.ObjetosDeValor.Embarcador.ICMS.RegraICMS regraICMS = svcICMS.BuscarRegraICMSMultiCTe(cte.Empresa, cte.SimplesNacional, cte.Remetente.Cliente, cte.Destinatario.Cliente, cte.Tomador.Cliente, cte.LocalidadeInicioPrestacao, localidadeTermino, localidadeExterior != null, ref incluirICMS, ref percentualInclusaoICMS, valorBaseICMS, cte.TipoServico, cte.CodigoProdutoEmbarcador, unidadeDeTrabalho);

            if (regraICMS != null && regraICMS.CFOP > 0)
            {
                Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeDeTrabalho);
                Dominio.Entidades.CFOP cfop = repCFOP.BuscarPorCFOP(regraICMS.CFOP, Dominio.Enumeradores.TipoCFOP.Saida);

                if (cfop != null)
                {
                    cte.CFOP = cfop;
                    cte.NaturezaDaOperacao = cfop.NaturezaDaOperacao;
                }
            }
            else
            {
                Dominio.Entidades.Aliquota aliquota = this.ObterAliquota(cte, unidadeDeTrabalho);

                if (aliquota != null)
                {
                    cte.CFOP = aliquota.CFOP;
                    cte.NaturezaDaOperacao = aliquota.CFOP.NaturezaDaOperacao;
                }
            }
        }

        public void SetarCFOPENaturezaPorTabelaDeAliquotas(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.ObjetosDeValor.CTe.CTe cteIntegracao, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Dominio.Entidades.Aliquota aliquota = this.ObterAliquota(cteIntegracao, cte, unidadeDeTrabalho);

            if (aliquota != null)
            {
                cte.CFOP = aliquota.CFOP;
                cte.NaturezaDaOperacao = aliquota.CFOP.NaturezaDaOperacao;
            }
        }

        public static Dominio.Entidades.Aliquota ObterAliquota(string ufEmpresa, string ufInicioPrestacao, string ufTerminoPrestacao, int codigoAtividadeRemetente, int codigoAtividadeDestinatario, int codigoAtividadeTomador, Repositorio.UnitOfWork unidadeTrabalho)
        {
            Repositorio.Aliquota repAliquota = new Repositorio.Aliquota(unidadeTrabalho);

            Dominio.Entidades.Aliquota aliquota = repAliquota.BuscarParaCalculoDoICMS(ufEmpresa, ufInicioPrestacao, ufTerminoPrestacao, codigoAtividadeRemetente, codigoAtividadeDestinatario);

            if (aliquota == null)
                aliquota = repAliquota.BuscarParaCalculoDoICMS(ufEmpresa, ufInicioPrestacao, ufTerminoPrestacao, codigoAtividadeTomador);

            return aliquota;
        }

        public Dominio.Entidades.Aliquota ObterAliquota(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.Aliquota repAliquota = new Repositorio.Aliquota(unidadeDeTrabalho);

            Dominio.Entidades.Aliquota aliquota = repAliquota.BuscarParaCalculoDoICMS(cte.Empresa.Localidade.Estado.Sigla, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, cte.Remetente != null && cte.Remetente.Atividade != null ? cte.Remetente.Atividade.Codigo : 3, cte.Destinatario != null && cte.Destinatario.Atividade != null ? cte.Destinatario.Atividade.Codigo : 3);

            if (aliquota == null)
                aliquota = repAliquota.BuscarParaCalculoDoICMS(cte.Empresa.Localidade.Estado.Sigla, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, cte.Tomador != null && cte.Tomador.Atividade != null ? cte.Tomador.Atividade.Codigo : 3);

            return aliquota;
        }

        public Dominio.Entidades.Aliquota ObterAliquota(Dominio.ObjetosDeValor.CTe.CTe cteIntegracao, Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.Aliquota repAliquota = new Repositorio.Aliquota(unidadeDeTrabalho);

            Dominio.Entidades.Aliquota aliquota = repAliquota.BuscarParaCalculoDoICMS(cte.Empresa.Localidade.Estado.Sigla, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, ObterAtividade(cte.Remetente, cteIntegracao.Remetente) ?? ObterAtividade(cte.Expedidor, cteIntegracao.Expedidor) ?? 3, ObterAtividade(cte.Destinatario, cteIntegracao.Destinatario) ?? ObterAtividade(cte.Recebedor, cteIntegracao.Recebedor) ?? 3);

            if (aliquota == null)
                aliquota = repAliquota.BuscarParaCalculoDoICMS(cte.Empresa.Localidade.Estado.Sigla, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, cteIntegracao.TomadorDoCTe?.CodigoAtividade ?? 2);

            return aliquota;
        }

        private int? ObterAtividade(Dominio.Entidades.ParticipanteCTe participanteCTe, Dominio.ObjetosDeValor.CTe.Cliente cliente)
        {
            if (participanteCTe?.Atividade != null)
                return participanteCTe.Atividade.Codigo;

            if (cliente != null)
                return cliente.CodigoAtividade;

            return null;
        }

        public void CalcularICMSPorTabelaDeAliquotasNDD(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.Enumeradores.OpcaoSimNao simplesNacional, List<Dominio.NDDigital.v104.Emissao.Registro13110> componentes, Dominio.Entidades.Aliquota aliquota = null, Repositorio.UnitOfWork unidadeDeTrabalho = null)
        {
            aliquota = aliquota ?? this.ObterAliquota(cte, unidadeDeTrabalho);

            if (aliquota != null)
            {
                cte.CFOP = aliquota.CFOP;
                cte.NaturezaDaOperacao = aliquota.CFOP.NaturezaDaOperacao;

                if (simplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao)
                {
                    cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Nao;
                    cte.CST = aliquota.CST;

                    if (cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim && cte.PercentualICMSIncluirNoFrete > 0)
                    {
                        decimal valorFreteContratado = 0;
                        decimal valorAReceber = 0;
                        decimal valorBaseCalculoICMS = 0;

                        for (int i = 0; i < componentes.Count(); i++)
                        {
                            if (componentes[i].xNome == "VALOR FRETE" || componentes[i].xNome == "FRETE VALOR")
                            {
                                valorFreteContratado += componentes[i].vComp;
                                valorBaseCalculoICMS += componentes[i].vComp;
                                valorAReceber += componentes[i].vComp;
                            }
                        }

                        CalcularInclusaoICMSNoFrete(ref cte, valorAReceber, valorBaseCalculoICMS, valorFreteContratado, aliquota.Percentual, unidadeDeTrabalho);

                        CalcularICMS(ref cte, unidadeDeTrabalho);
                    }
                    else
                    {
                        cte.BaseCalculoICMS = cte.ValorFrete;
                        cte.AliquotaICMS = aliquota.Percentual;
                        cte.ValorICMS = (cte.ValorFrete * (aliquota.Percentual / 100m));
                    }
                }
                else
                {
                    cte.CST = "";
                }
            }
            else
            {
                throw new Exception("Alíquota para cálculo de impostos não encontrada.");
            }
        }

        public void CalcularImpostosCTe(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ComponentePrestacaoCTE repComponente = new Repositorio.ComponentePrestacaoCTE(unitOfWork);

            SalvarInformacoesComponentesDaPrestacao(cte, "FRETE VALOR", cte.ValorFrete, false, true, unitOfWork);

            decimal valorFreteContratado = 0m;
            decimal valorAReceber = 0m;
            decimal valorBaseCalculoICMS = 0m;

            List<Dominio.Entidades.ComponentePrestacaoCTE> componentes = repComponente.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);

            for (int i = 0; i < componentes.Count(); i++)
            {
                if (componentes[i].Nome == "VALOR FRETE" || componentes[i].Nome == "FRETE VALOR")
                {
                    valorFreteContratado += componentes[i].Valor;
                    valorBaseCalculoICMS += componentes[i].Valor;
                }

                if (componentes[i].IncluiNaBaseDeCalculoDoICMS)
                    valorBaseCalculoICMS += componentes[i].Valor;

                if (componentes[i].IncluiNoTotalAReceber)
                    valorAReceber += componentes[i].Valor;
            }

            CalcularInclusaoICMSNoFrete(ref cte, valorAReceber, valorBaseCalculoICMS, valorFreteContratado, cte.AliquotaICMS, unitOfWork);

            CalcularICMS(ref cte, unitOfWork);
        }

        public void CalcularICMSPorTabelaDeAliquotas(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.Enumeradores.OpcaoSimNao simplesNacional, Repositorio.UnitOfWork unidadeDeTrabalho, bool buscarComponentes = true, List<Dominio.Entidades.CFOP> listaCFOP = null, bool descontarImpostoDoValorDoFrete = false)
        {
            unidadeDeTrabalho = unidadeDeTrabalho ?? new Repositorio.UnitOfWork(StringConexao);

            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
            Repositorio.ComponentePrestacaoCTE repComponente = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);
            Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeDeTrabalho);


            Servicos.Embarcador.Carga.ICMS svcICMS = new Embarcador.Carga.ICMS(unidadeDeTrabalho);

            decimal valorFreteContratado = 0;
            decimal valorAReceber = 0;
            decimal valorBaseCalculoICMS = 0;

            if (buscarComponentes)
            {
                List<Dominio.Entidades.ComponentePrestacaoCTE> componentes = repComponente.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);

                for (int i = 0; i < componentes.Count(); i++)
                {
                    if (componentes[i].Nome == "VALOR FRETE" || componentes[i].Nome == "FRETE VALOR")
                    {
                        valorFreteContratado += componentes[i].Valor;
                        valorBaseCalculoICMS += componentes[i].Valor;
                    }

                    if (componentes[i].IncluiNaBaseDeCalculoDoICMS)
                        valorBaseCalculoICMS += componentes[i].Valor;

                    if (componentes[i].IncluiNoTotalAReceber)
                        valorAReceber += componentes[i].Valor;
                }
            }


            bool incluirICMS = cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim ? true : false;
            decimal percentualInclusaoICMS = cte.PercentualICMSIncluirNoFrete;
            decimal valorBaseICMS = valorBaseCalculoICMS;

            Dominio.Entidades.Localidade localidadeTermino = cte.LocalidadeTerminoPrestacao;
            //Dominio.Entidades.Localidade localidadeExterior = null;
            //if (cte.Destinatario?.Exterior ?? false)
            //{
            //    localidadeExterior = repLocalidade.BuscarPorEstado("EX");
            //    if (localidadeExterior != null)
            //        localidadeTermino = localidadeExterior;
            //}
            Dominio.Entidades.Localidade localidadeExterior = repLocalidade.BuscarPorEstado("EX");
            bool destinatarioExportacao = cte.Destinatario?.Exterior ?? false;

            //Dominio.ObjetosDeValor.Embarcador.ICMS.RegraICMS regraICMS = svcICMS.BuscarRegraICMSMultiCTe(cte.Empresa, simplesNacional, cte.Remetente.Cliente, cte.Destinatario.Cliente, cte.Tomador != null ? cte.Tomador.Cliente : cte.TomadorPagador != null ? cte.TomadorPagador.Cliente : null, cte.LocalidadeInicioPrestacao, localidadeTermino, (localidadeExterior != null), ref incluirICMS, ref percentualInclusaoICMS, valorBaseICMS, cte.TipoServico, cte.CodigoProdutoEmbarcador, unidadeDeTrabalho);
            Dominio.ObjetosDeValor.Embarcador.ICMS.RegraICMS regraICMS = svcICMS.BuscarRegraICMSMultiCTe(cte?.Empresa, simplesNacional, cte.Remetente?.Cliente, cte.Destinatario?.Cliente, cte.Tomador != null ? cte.Tomador.Cliente : cte.TomadorPagador != null ? cte.TomadorPagador.Cliente : null, cte.LocalidadeInicioPrestacao, localidadeTermino, (destinatarioExportacao && localidadeExterior != null), ref incluirICMS, ref percentualInclusaoICMS, valorBaseICMS, cte.TipoServico, cte.CodigoProdutoEmbarcador, unidadeDeTrabalho);

            if (regraICMS != null)
            {
                Dominio.Entidades.CFOP cfop = null;

                if (listaCFOP != null && listaCFOP.Count > 0)
                    cfop = listaCFOP.Where(o => o.CodigoCFOP == regraICMS.CFOP).FirstOrDefault();

                if (cfop == null)
                    cfop = repCFOP.BuscarPorCFOP(regraICMS.CFOP, Dominio.Enumeradores.TipoCFOP.Saida);

                if (cfop != null)
                {
                    cte.CFOP = cfop;
                    cte.NaturezaDaOperacao = cfop.NaturezaDaOperacao;
                }

                if (regraICMS.ValorBaseCalculoICMS == 0) //Configurado para Zerar o valor da Base de Calculo
                    valorBaseCalculoICMS = 0;

                if (simplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && regraICMS.CST != "SN")
                {
                    cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Nao;
                    cte.CST = regraICMS.CST;
                    cte.PercentualReducaoBaseCalculoICMS = regraICMS.PercentualReducaoBC;

                    CalcularInclusaoICMSNoFrete(ref cte, valorAReceber, valorBaseCalculoICMS, valorFreteContratado, regraICMS.Aliquota, unidadeDeTrabalho, descontarImpostoDoValorDoFrete);

                    CalcularICMS(ref cte, unidadeDeTrabalho);
                }
                else
                {
                    cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Sim;
                    if (cte.Empresa.Configuracao != null && cte.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0)
                    {
                        decimal valorImpostos = Math.Round((valorFreteContratado * (cte.Empresa.Configuracao.PercentualImpostoSimplesNacional.Value / 100)), 2, MidpointRounding.ToEven);

                        valorFreteContratado = valorFreteContratado - valorImpostos;

                        this.AlterarComponenteImposto(cte, valorImpostos, unidadeDeTrabalho);

                        cte.ValorFrete = valorFreteContratado;
                    }

                    cte.CST = "";

                    CalcularInclusaoICMSNoFrete(ref cte, valorAReceber, 0, valorFreteContratado, 0, unidadeDeTrabalho);

                    CalcularICMS(ref cte, unidadeDeTrabalho);
                }

                //Comentado pois duplicava a observação na integração de CTe via WebService
                //if (!string.IsNullOrWhiteSpace(regraICMS.ObservacaoCTe) && string.IsNullOrWhiteSpace(cte.ObservacoesAvancadas))
                //{
                //    string observacaoICMS = svcICMS.ObterObservacaoRegraICMS(regraICMS.ObservacaoCTe, cte.AliquotaICMS, cte.ValorFrete, cte.ValorICMS, cte.BaseCalculoICMS, cte.Empresa, cte.Remetente.Cliente, cte.Destinatario.Cliente, cte.Tomador.Cliente, cte.LocalidadeInicioPrestacao, cte.LocalidadeTerminoPrestacao, cte.PercentualICMSIncluirNoFrete, string.Empty);
                //    cte.ObservacoesAvancadas = observacaoICMS;
                //}
            }
            else
            {
                Dominio.Entidades.Aliquota aliquota = this.ObterAliquota(cte, unidadeDeTrabalho);

                if (aliquota != null)
                {
                    cte.CFOP = aliquota.CFOP;
                    cte.NaturezaDaOperacao = aliquota.CFOP.NaturezaDaOperacao;

                    if (simplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao)
                    {
                        cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Nao;
                        cte.CST = aliquota.CST;

                        CalcularInclusaoICMSNoFrete(ref cte, valorAReceber, valorBaseCalculoICMS, valorFreteContratado, aliquota.Percentual, unidadeDeTrabalho);

                        CalcularICMS(ref cte, unidadeDeTrabalho);
                    }
                    else
                    {
                        cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Sim;
                        if (cte.Empresa.Configuracao != null && cte.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0)
                        {
                            decimal valorImpostos = Math.Round((valorFreteContratado * (cte.Empresa.Configuracao.PercentualImpostoSimplesNacional.Value / 100)), 2, MidpointRounding.ToEven);

                            valorFreteContratado = valorFreteContratado - valorImpostos;

                            this.AlterarComponenteImposto(cte, valorImpostos, unidadeDeTrabalho);

                            cte.ValorFrete = valorFreteContratado;
                        }

                        cte.CST = "";

                        CalcularInclusaoICMSNoFrete(ref cte, valorAReceber, 0, valorFreteContratado, 0, unidadeDeTrabalho);

                        CalcularICMS(ref cte, unidadeDeTrabalho);
                    }
                }
                else
                {
                    throw new Exception("Alíquota para cálculo de impostos não encontrada.");
                }
            }
        }

        public void CalcularICMS(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (cte.CST != "40" && cte.CST != "41" && cte.CST != "51" && cte.CST != "")
            {
                decimal valor = cte.BaseCalculoICMS;
                decimal aliquota = cte.AliquotaICMS;
                decimal valorICMS = valor * (aliquota / 100);

                cte.ValorICMS = decimal.Round(valorICMS, 2, MidpointRounding.AwayFromZero);
            }
            else
            {
                cte.PercentualReducaoBaseCalculoICMS = 0;
                cte.BaseCalculoICMS = 0;
                cte.ValorICMS = 0;
                cte.ValorPresumido = 0;
                cte.AliquotaICMS = 0;
            }

            if (cte.ValorICMS > 0)
                this.AlterarComponenteImposto(cte, unidadeDeTrabalho);
        }

        public void CalcularInclusaoICMSNoFrete(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, decimal valorAReceber, decimal valorBaseCalculoICMS, decimal valorFreteContratado, decimal aliquota, Repositorio.UnitOfWork unidadeDeTrabalho, bool descontarImpostoDoValorDoFrete = false)
        {
            decimal percentualReducaoBaseCalculoICMS = cte.PercentualReducaoBaseCalculoICMS;
            valorBaseCalculoICMS -= valorBaseCalculoICMS * (percentualReducaoBaseCalculoICMS / 100);
            decimal percentualAliquota = 0;
            percentualAliquota = cte.CST != "40" && cte.CST != "41" && cte.CST != "51" && cte.CST != "" ? aliquota : 0;
            decimal percentualICMSRecolhido = cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim ? cte.PercentualICMSIncluirNoFrete : 0;
            if (!descontarImpostoDoValorDoFrete)
                valorBaseCalculoICMS += cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim ? (percentualAliquota > 0 ? ((valorBaseCalculoICMS / ((100 - percentualAliquota) / 100)) - valorBaseCalculoICMS) : 0) : 0;
            decimal valorICMS = valorBaseCalculoICMS * (percentualAliquota / 100);
            decimal valorRecolhido = valorICMS * (percentualICMSRecolhido / 100);

            cte.AliquotaICMS = decimal.Round(percentualAliquota, 2, MidpointRounding.AwayFromZero);

            if (cte.CST == "60")
            {
                if (!descontarImpostoDoValorDoFrete)
                {
                    cte.ValorAReceber = decimal.Round(valorAReceber, 2, MidpointRounding.AwayFromZero);
                    cte.ValorPrestacaoServico = decimal.Round(valorAReceber + valorRecolhido, 2, MidpointRounding.AwayFromZero);
                }
                else
                {
                    cte.ValorFrete = decimal.Round(valorAReceber - valorRecolhido, 2, MidpointRounding.AwayFromZero);
                    cte.ValorAReceber = cte.ValorFrete;
                    cte.ValorPrestacaoServico = decimal.Round(valorAReceber, 2, MidpointRounding.AwayFromZero);

                }
            }
            else
            {
                if (!descontarImpostoDoValorDoFrete)
                {
                    cte.ValorAReceber = decimal.Round(valorAReceber + valorRecolhido, 2, MidpointRounding.AwayFromZero);
                    cte.ValorPrestacaoServico = cte.ValorAReceber;
                }
                else
                {
                    cte.ValorFrete = decimal.Round(valorAReceber - valorRecolhido, 2, MidpointRounding.AwayFromZero);
                    cte.ValorAReceber = decimal.Round(valorAReceber, 2, MidpointRounding.AwayFromZero);
                    cte.ValorPrestacaoServico = cte.ValorAReceber;
                }
            }
            if (valorRecolhido > 0)
                this.SalvarInformacoesComponentesDaPrestacao(cte, "IMPOSTOS", valorRecolhido, false, false, unidadeDeTrabalho);

            cte.BaseCalculoICMS = decimal.Round(valorBaseCalculoICMS, 2, MidpointRounding.AwayFromZero);

            if (descontarImpostoDoValorDoFrete)
            {
                Repositorio.ComponentePrestacaoCTE repComponente = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);
                List<Dominio.Entidades.ComponentePrestacaoCTE> componentes = repComponente.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);

                for (int i = 0; i < componentes.Count(); i++)
                {
                    if (componentes[i].Nome == "VALOR FRETE" || componentes[i].Nome == "FRETE VALOR")
                    {
                        componentes[i].Valor = cte.ValorFrete;
                        repComponente.Atualizar(componentes[i]);
                    }
                }
            }

        }

        public void CalcularICMSInclusoNoFrete(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, decimal valorAReceber, decimal valorBaseCalculoICMS, decimal valorFreteContratado, decimal aliquota, Repositorio.UnitOfWork unidadeDeTrabalho, decimal aliquotaInternaDifal)
        {
            decimal percentualReducaoBaseCalculoICMS = cte.PercentualReducaoBaseCalculoICMS;
            valorBaseCalculoICMS -= valorBaseCalculoICMS * (percentualReducaoBaseCalculoICMS / 100);
            decimal percentualAliquota = 0;
            if (aliquotaInternaDifal > 0)
                percentualAliquota = cte.CST != "40" && cte.CST != "41" && cte.CST != "51" && cte.CST != "" ? aliquotaInternaDifal : 0;
            else
                percentualAliquota = cte.CST != "40" && cte.CST != "41" && cte.CST != "51" && cte.CST != "" ? aliquota : 0;
            decimal percentualICMSRecolhido = cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim ? cte.PercentualICMSIncluirNoFrete : 0;
            valorBaseCalculoICMS += cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim ? (percentualAliquota > 0 ? ((valorBaseCalculoICMS / ((100 - percentualAliquota) / 100)) - valorBaseCalculoICMS) : 0) : 0;
            decimal valorICMS = valorBaseCalculoICMS * (percentualAliquota / 100);
            decimal valorRecolhido = valorICMS * (percentualICMSRecolhido / 100);

            cte.AliquotaICMS = decimal.Round(percentualAliquota, 2, MidpointRounding.AwayFromZero);

            if (cte.CST == "60")
            {
                cte.ValorAReceber = decimal.Round(valorAReceber, 2, MidpointRounding.AwayFromZero);
                cte.ValorPrestacaoServico = decimal.Round(valorAReceber + valorRecolhido, 2, MidpointRounding.AwayFromZero);
            }
            else
            {
                cte.ValorAReceber = decimal.Round(valorAReceber + valorRecolhido, 2, MidpointRounding.AwayFromZero);
                cte.ValorPrestacaoServico = cte.ValorAReceber;
            }
            if (valorRecolhido > 0)
                this.SalvarInformacoesComponentesDaPrestacao(cte, "IMPOSTOS", valorRecolhido, false, false, unidadeDeTrabalho);

            cte.BaseCalculoICMS = decimal.Round(valorBaseCalculoICMS, 2, MidpointRounding.AwayFromZero);
        }

        public bool Deletar(int codigoCTe, int codigoEmpresa, bool deletar, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorCodigo(codigoEmpresa, codigoCTe);

            if (cte != null && (cte.Status == "R" || cte.Status == "S") || string.IsNullOrWhiteSpace(cte.Status))
            {
                Repositorio.MotoristaCTE repMotorista = new Repositorio.MotoristaCTE(unidadeDeTrabalho);
                Repositorio.ParticipanteCTe repParticipanteCTe = new Repositorio.ParticipanteCTe(unidadeDeTrabalho);
                Repositorio.ProprietarioVeiculoCTe repProprietarioVeiculo = new Repositorio.ProprietarioVeiculoCTe(unidadeDeTrabalho);
                Repositorio.VeiculoCTE repVeiculo = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
                Repositorio.CobrancaCTe repCobranca = new Repositorio.CobrancaCTe(unidadeDeTrabalho);
                Repositorio.ComponentePrestacaoCTE repComponentePrestacao = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);
                Repositorio.ContainerCTE repContainer = new Repositorio.ContainerCTE(unidadeDeTrabalho);
                Repositorio.DocumentoDeTransporteAnteriorCTe repDocumentoTransporteAnterior = new Repositorio.DocumentoDeTransporteAnteriorCTe(unidadeDeTrabalho);
                Repositorio.DocumentosAnulacaoCTE repDocumentoAnulacao = new Repositorio.DocumentosAnulacaoCTE(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumentos = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.EnderecoParticipanteCTe repEnderecoParticipante = new Repositorio.EnderecoParticipanteCTe(unidadeDeTrabalho);
                Repositorio.InformacaoCargaCTE repInformacaoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
                //Repositorio.IntegracaoCTe repIntegracao = new Repositorio.IntegracaoCTe(unidadeDeTrabalho);
                Repositorio.ObservacaoContribuinteCTE repObservacaoContribuinte = new Repositorio.ObservacaoContribuinteCTE(unidadeDeTrabalho);
                Repositorio.ObservacaoFiscoCTE repObservacaoFisco = new Repositorio.ObservacaoFiscoCTE(unidadeDeTrabalho);
                Repositorio.OcorrenciaDeCTe repOcorrencia = new Repositorio.OcorrenciaDeCTe(unidadeDeTrabalho);
                Repositorio.ParcelaCobrancaCTe repParcelaCobranca = new Repositorio.ParcelaCobrancaCTe(unidadeDeTrabalho);
                Repositorio.ProdutoPerigosoCTE repProdutoPerigoso = new Repositorio.ProdutoPerigosoCTE(unidadeDeTrabalho);
                Repositorio.SeguroCTE repSeguro = new Repositorio.SeguroCTE(unidadeDeTrabalho);
                Repositorio.MovimentoDoFinanceiro repMovimento = new Repositorio.MovimentoDoFinanceiro(unidadeDeTrabalho);
                Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeDeTrabalho);

                if (cte.Destinatario != null)
                {
                    Dominio.Entidades.ParticipanteCTe participante = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Destinatario);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Destinatario);

                    repParticipanteCTe.Deletar(participante);
                }

                if (cte.Remetente != null)
                {
                    Dominio.Entidades.ParticipanteCTe participante = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Remetente);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Remetente);

                    repParticipanteCTe.Deletar(participante);
                }

                if (cte.Expedidor != null)
                {
                    Dominio.Entidades.ParticipanteCTe participante = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Expedidor);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Expedidor);

                    repParticipanteCTe.Deletar(participante);
                }

                if (cte.Recebedor != null)
                {
                    Dominio.Entidades.ParticipanteCTe participante = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Recebedor);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Recebedor);

                    repParticipanteCTe.Deletar(participante);
                }

                if (cte.OutrosTomador != null)
                {
                    Dominio.Entidades.ParticipanteCTe participante = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Outros);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Outros);

                    repParticipanteCTe.Deletar(participante);
                }

                if (cte.TomadorPagador != null)
                    cte.TomadorPagador = null;

                //List<Dominio.Entidades.VeiculoCTE> veiculos = repVeiculo.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);

                if (cte.Veiculos != null && cte.Veiculos.Count() > 0)
                {
                    foreach (Dominio.Entidades.VeiculoCTE veiculo in cte.Veiculos)
                    {
                        if (veiculo.Proprietario != null)
                        {
                            Dominio.Entidades.ProprietarioVeiculoCTe proprietario = repProprietarioVeiculo.BuscarPorCodigo(veiculo.Proprietario.Codigo);

                            veiculo.Proprietario = null;

                            repProprietarioVeiculo.Deletar(proprietario);
                        }

                        repVeiculo.Deletar(veiculo);
                    }
                }

                repParcelaCobranca.DeletarPorCTe(cte.Codigo);
                repCobranca.DeletarPorCTe(cte.Codigo);
                repComponentePrestacao.DeletarPorCTe(cte.Codigo);
                repContainer.DeletarPorCTe(cte.Codigo);
                repDocumentoAnulacao.DeletarPorCTe(cte.Codigo);
                repDocumentos.DeletarPorCTe(cte.Codigo);
                repDocumentoTransporteAnterior.DeletarPorCTe(cte.Codigo);
                repInformacaoCarga.DeletarPorCTe(cte.Codigo);
                //repIntegracao.DeletarPorCTe(cte.Codigo);
                repMotorista.DeletarPorCTe(cte.Codigo);
                repObservacaoContribuinte.DeletarPorCTe(cte.Codigo);
                repObservacaoFisco.DeletarPorCTe(cte.Codigo);
                repOcorrencia.DeletarPorCTe(cte.Codigo);
                repProdutoPerigoso.DeletarPorCTe(cte.Codigo);
                repSeguro.DeletarPorCTe(cte.Codigo);
                repXMLCTe.DeletarPorCTe(cte.Codigo);

                //Dominio.Entidades.MovimentoDoFinanceiro movimento = repMovimento.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);

                //if (movimento != null)
                //    repMovimento.Deletar(movimento);

                if (deletar)
                    repCTe.Deletar(cte);

                return true;
            }

            return false;
        }

        public void SetarPartilhaICMS(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            bool naoCalcularDIFALParaCSTNaoTributavel = (bool)Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().NaoCalcularDIFALParaCSTNaoTributavel;
            cte.AliquotaICMSInterna = 0;
            cte.ValorICMSUFDestino = 0;
            cte.ValorICMSUFOrigem = 0;
            cte.ValorICMSFCPFim = 0;
            Dominio.Entidades.ParticipanteCTe participanteCTe = cte.Tomador;

            //Criado configuração para não calcular Difal em CTe-OS
            if (cte != null && cte.ModeloDocumentoFiscal.Numero == "67" && cte.Empresa.Configuracao != null && cte.Empresa.Configuracao.NaoCalcularDIFALCTeOS)
            {
                cte.PercentualICMSPartilha = 0;
                cte.AliquotaICMSInterna = 0;
                cte.ValorICMSUFDestino = 0;
                cte.ValorICMSUFOrigem = 0;
                cte.ValorICMSFCPFim = 0;

                return;
            }
            if (naoCalcularDIFALParaCSTNaoTributavel && cte != null && (cte.CST == "40" || cte.CST == "41" || cte.CST == "51" || cte.CST == "040" || cte.CST == "041" || cte.CST == "051") && (cte.Destinatario?.Localidade?.Estado?.Sigla != "EX") && (!string.IsNullOrWhiteSpace(cte.Destinatario?.Localidade?.Estado?.Sigla)))
            {
                cte.PercentualICMSPartilha = 0;
                cte.AliquotaICMSInterna = 0;
                cte.ValorICMSUFDestino = 0;
                cte.ValorICMSUFOrigem = 0;
                cte.ValorICMSFCPFim = 0;

                return;
            }
            if (naoCalcularDIFALParaCSTNaoTributavel && participanteCTe != null && cte.Remetente != null && participanteCTe.CPF_CNPJ == cte.Remetente.CPF_CNPJ)
            {
                cte.PercentualICMSPartilha = 0;
                cte.AliquotaICMSInterna = 0;
                cte.ValorICMSUFDestino = 0;
                cte.ValorICMSUFOrigem = 0;
                cte.ValorICMSFCPFim = 0;

                return;
            }
            if (naoCalcularDIFALParaCSTNaoTributavel && participanteCTe != null && cte.Expedidor != null && participanteCTe.CPF_CNPJ == cte.Expedidor.CPF_CNPJ)
            {
                cte.PercentualICMSPartilha = 0;
                cte.AliquotaICMSInterna = 0;
                cte.ValorICMSUFDestino = 0;
                cte.ValorICMSUFOrigem = 0;
                cte.ValorICMSFCPFim = 0;

                return;
            }
            if (naoCalcularDIFALParaCSTNaoTributavel && (participanteCTe?.Cliente?.IndicadorIE == Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS || cte.IndicadorIETomador == Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteICMS || participanteCTe?.CPF_CNPJ == cte.Expedidor?.CPF_CNPJ || participanteCTe?.CPF_CNPJ == cte.Remetente?.CPF_CNPJ))
            {
                cte.PercentualICMSPartilha = 0;
                cte.AliquotaICMSInterna = 0;
                cte.ValorICMSUFDestino = 0;
                cte.ValorICMSUFOrigem = 0;
                cte.ValorICMSFCPFim = 0;

                return;
            }
            if (cte.Empresa.Configuracao != null && cte.Empresa.Configuracao.NaoCalcularDIFALTomadorExterior && (cte.TomadorPagador?.Exterior ?? participanteCTe?.Exterior ?? false))
            {
                cte.PercentualICMSPartilha = 0;
                cte.AliquotaICMSInterna = 0;
                cte.ValorICMSUFDestino = 0;
                cte.ValorICMSUFOrigem = 0;
                cte.ValorICMSFCPFim = 0;

                return;
            }

            Repositorio.Aliquota repAliquota = new Repositorio.Aliquota(unidadeDeTrabalho);


            if (cte.Empresa.Configuracao != null && cte.Empresa.Configuracao.UtilizarDestinoParaCalculoDifal)
            {
                if (cte.Destinatario != null)
                    participanteCTe = cte.Destinatario;
            }

            //Alterado para validar o Tomador ao invés do Remetente 18/05/2016 conf. solicitação da parati
            //if (cte != null && cte.LocalidadeInicioPrestacao.Estado.Sigla != cte.LocalidadeTerminoPrestacao.Estado.Sigla && cte.Tomador != null &&
            //Alterado dia 11/01/2018 para considerar a cidade do cliente destino 
            string siglaUFDestino = cte.Destinatario != null && cte.Destinatario.Localidade != null ? cte.Destinatario.Localidade.Estado.Sigla : cte.LocalidadeTerminoPrestacao.Estado.Sigla;

            Dominio.Entidades.Aliquota aliquotaInterna = repAliquota.BuscarParaCalculoDoICMS(cte.Empresa.Localidade.Estado.Sigla, siglaUFDestino, siglaUFDestino, 7);
            Dominio.Entidades.Aliquota aliquotaInterEstadual = repAliquota.BuscarParaCalculoDoICMS(cte.Empresa.Localidade.Estado.Sigla, cte.LocalidadeInicioPrestacao.Estado.Sigla, siglaUFDestino, 7);

            if (cte != null && cte.LocalidadeInicioPrestacao.Estado.Sigla != siglaUFDestino && participanteCTe != null &&
                (string.IsNullOrWhiteSpace(participanteCTe.IE_RG) || participanteCTe.IE_RG == "" || participanteCTe.IE_RG == "ISENTO" || cte.IndicadorIETomador == Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.ContribuinteIsento || cte.IndicadorIETomador == Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte))
            {
                if (aliquotaInterna != null && aliquotaInterEstadual != null)
                {
                    if (DateTime.Now.Year == 2016)
                        cte.PercentualICMSPartilha = 40;
                    else if (DateTime.Now.Year == 2017)
                        cte.PercentualICMSPartilha = 60;
                    else if (DateTime.Now.Year == 2018)
                        cte.PercentualICMSPartilha = 80;
                    else if (DateTime.Now.Year > 2018)
                        cte.PercentualICMSPartilha = 100;

                    decimal valorBaseCalculo = cte.BaseCalculoICMS > 0 ? cte.BaseCalculoICMS : cte.ValorAReceber;

                    if (cte.PercentualICMSPartilha > 0)
                    {
                        decimal percentualDifal = aliquotaInterna.Percentual - aliquotaInterEstadual.Percentual;
                        if (naoCalcularDIFALParaCSTNaoTributavel)
                            percentualDifal = (aliquotaInterna.Percentual - aliquotaInterna.AliquotaFCP) - aliquotaInterEstadual.Percentual;

                        if (percentualDifal > 0)
                        {
                            decimal valorDifal = valorBaseCalculo * (percentualDifal / 100);

                            if (naoCalcularDIFALParaCSTNaoTributavel)
                                cte.AliquotaICMSInterna = aliquotaInterna.Percentual - aliquotaInterna.AliquotaFCP;
                            else
                                cte.AliquotaICMSInterna = aliquotaInterna.Percentual;
                            cte.ValorICMSUFDestino = Math.Round((valorDifal * (cte.PercentualICMSPartilha / 100)), 2, MidpointRounding.ToEven);
                            cte.ValorICMSUFOrigem = Math.Round((valorDifal * ((100 - cte.PercentualICMSPartilha) / 100)), 2, MidpointRounding.ToEven);
                        }
                        else if (!naoCalcularDIFALParaCSTNaoTributavel || (cte.Destinatario?.Localidade?.Estado?.Sigla == "EX") || (string.IsNullOrWhiteSpace(cte.Destinatario?.Localidade?.Estado?.Sigla)))//Solicitação aliança 27/07/2020 #11525 e #13776 13/10/2020
                        { //Definido com Cesar dia 24/11/2017 quando a Aliquota Interna é menor que a Inter Estadual envia com 1 centavo o difal pois gerava valores negativos
                            cte.AliquotaICMSInterna = aliquotaInterna.Percentual;
                            cte.ValorICMSUFDestino = 0.01m;
                            cte.ValorICMSUFOrigem = 0.01m;
                        }
                        else
                        {
                            cte.PercentualICMSPartilha = 0;
                            cte.AliquotaICMSInterna = 0;
                            cte.ValorICMSUFDestino = 0;
                            cte.ValorICMSUFOrigem = 0;
                            cte.ValorICMSFCPFim = 0;

                            return;
                        }
                    }
                }
            }

            if (participanteCTe != null && (string.IsNullOrWhiteSpace(participanteCTe.IE_RG) || participanteCTe.IE_RG == "" || participanteCTe.IE_RG == "ISENTO") && (aliquotaInterna?.AliquotaFCP ?? 0) > 0)
                cte.ValorICMSFCPFim = Math.Round((cte.BaseCalculoICMS > 0 ? cte.BaseCalculoICMS : cte.ValorAReceber) * (aliquotaInterna.AliquotaFCP / 100), 2, MidpointRounding.ToEven);
        }

        public bool SetarObservacoesVeiculo(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware = null)
        {
            if (tipoServicoMultisoftware.HasValue && (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS || tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador))
                return false;

            Repositorio.VeiculoCTE repVeiculo = new Repositorio.VeiculoCTE(unidadeDeTrabalho);

            if (cte != null && string.IsNullOrWhiteSpace(cte.ObservacoesAvancadas))
            {
                List<Dominio.Entidades.VeiculoCTE> veiculos = repVeiculo.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);

                Dominio.Entidades.VeiculoCTE veiculo = (from obj in veiculos where obj.TipoVeiculo == "0" select obj).FirstOrDefault();

                if (veiculo == null)
                    veiculo = (from obj in veiculos orderby obj.TipoVeiculo select obj).FirstOrDefault();

                if (cte != null && veiculo != null && veiculo.Veiculo != null && veiculo.Veiculo.ObservacaoCTe != null && veiculo.Veiculo.ObservacaoCTe != "")
                {
                    try
                    {
                        bool formatarPlacaComHifen = cte.Empresa.Configuracao != null ? cte.Empresa.Configuracao.FormatarPlacaComHifenNaObservacao : false;

                        string observacaoVeiculo = veiculo.Veiculo.ObservacaoCTe;

                        string placasVinculadas = "";
                        foreach (Dominio.Entidades.VeiculoCTE veiculosVinculados in veiculos)
                        {
                            if (veiculo.Placa != veiculosVinculados.Placa)
                            {
                                if (placasVinculadas != "")
                                    placasVinculadas += formatarPlacaComHifen ? veiculosVinculados.Placa_Formatada : veiculosVinculados.Placa + ", ";
                                else
                                    placasVinculadas = formatarPlacaComHifen ? veiculosVinculados.Placa_Formatada : veiculosVinculados.Placa;
                            }
                        }

                        observacaoVeiculo = observacaoVeiculo.Replace("#CPFCNPJProprietarioVeiculo#", (veiculo != null && veiculo.Proprietario != null ? veiculo.Proprietario.CPF_CNPJ : veiculo != null && veiculo.Veiculo != null && veiculo.Veiculo.Proprietario != null ? veiculo.Veiculo.Proprietario.CPF_CNPJ_SemFormato : string.Empty));
                        observacaoVeiculo = observacaoVeiculo.Replace("#NomeProprietarioVeiculo#", (veiculo != null && veiculo.Proprietario != null ? veiculo.Proprietario.Nome : veiculo != null && veiculo.Veiculo != null && veiculo.Veiculo.Proprietario != null ? veiculo.Veiculo.Proprietario.Nome : string.Empty));
                        observacaoVeiculo = observacaoVeiculo.Replace("#RNTRCProprietario#", (veiculo != null && veiculo.Proprietario != null ? veiculo.Proprietario.RNTRC : veiculo != null && veiculo.Veiculo != null && veiculo.Veiculo.Proprietario != null ? veiculo.Veiculo.RNTRC.ToString() : string.Empty));

                        observacaoVeiculo = observacaoVeiculo.Replace("#PlacaVeiculo#", (veiculo != null ? formatarPlacaComHifen ? veiculo.Placa_Formatada : veiculo.Placa : string.Empty));
                        observacaoVeiculo = observacaoVeiculo.Replace("#RENAVAMVeiculo#", (veiculo != null ? veiculo.RENAVAM : string.Empty));
                        observacaoVeiculo = observacaoVeiculo.Replace("#UFVeiculo#", (veiculo != null ? veiculo.SiglaUF : string.Empty));
                        observacaoVeiculo = observacaoVeiculo.Replace("#MarcaVeiculo#", (veiculo != null && veiculo.Veiculo.Marca != null ? veiculo.Veiculo.Marca.Descricao : string.Empty));

                        observacaoVeiculo = observacaoVeiculo.Replace("#PlacasVinculadas#", (placasVinculadas != "" ? placasVinculadas : string.Empty));

                        string observacaoPadrao = this.BuscarObservacaoPadrao(cte, Dominio.Enumeradores.TipoObservacao.Geral, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, cte.CST, cte.ValorICMS, unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe);
                        if (!string.IsNullOrEmpty(observacaoPadrao))
                            observacaoVeiculo += " / " + observacaoPadrao;

                        cte.ObservacoesAvancadas = string.IsNullOrWhiteSpace(cte.ObservacoesAvancadas) ? observacaoVeiculo : string.Concat(cte.ObservacoesAvancadas, " / ", observacaoVeiculo);

                        return true;
                    }
                    catch (Exception ex)
                    {
                        Servicos.Log.TratarErro("Erro buscando observação veiculos: " + ex);
                        return false;
                    }
                }
                else
                    return false;
            }
            else
                return false;
        }

        public bool SetarObservacoesTransportadora(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware = null)
        {
            if (tipoServicoMultisoftware.HasValue && (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS || tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador))
                return false;

            if (cte != null && cte.Empresa != null && !string.IsNullOrWhiteSpace(cte.Empresa.ObservacaoCTe))
            {
                cte.ObservacoesAvancadas = string.IsNullOrWhiteSpace(cte.ObservacoesAvancadas) ? cte.Empresa.ObservacaoCTe : string.Concat(cte.ObservacoesAvancadas, " / ", cte.Empresa.ObservacaoCTe);

                return true;
            }
            else
                return false;
        }

        public void SetarXCampoVeiculo(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware = null)
        {
            if (tipoServicoMultisoftware.HasValue && (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS || tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador))
                return;

            Repositorio.ObservacaoContribuinteCTE repObsContribuinte = new Repositorio.ObservacaoContribuinteCTE(unidadeDeTrabalho);
            Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unidadeDeTrabalho);
            Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);

            if (cte != null)
            {
                List<Dominio.Entidades.VeiculoCTE> veiculosCTe = repVeiculoCTe.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);

                foreach (Dominio.Entidades.VeiculoCTE veiculoCTe in veiculosCTe)
                {
                    Dominio.Entidades.Veiculo veiculo = repVeiculo.BuscarPorPlaca(cte.Empresa.Codigo, veiculoCTe.Placa);
                    if (veiculo != null)
                    {
                        if (!string.IsNullOrWhiteSpace(veiculo.XCampo) && !string.IsNullOrWhiteSpace(veiculo.XTexto))
                        {
                            Dominio.Entidades.ObservacaoContribuinteCTE obs = repObsContribuinte.BuscarPorCTeEIdentificacaoEDescricao(cte.Codigo, veiculo.XCampo, veiculo.XTexto);
                            if (obs == null)
                            {
                                obs = new Dominio.Entidades.ObservacaoContribuinteCTE();
                                obs.CTE = cte;
                                obs.Identificador = veiculo.XCampo.Length > 20 ? veiculo.XCampo.Substring(0, 20) : veiculo.XCampo;
                                obs.Descricao = veiculo.XTexto;
                                repObsContribuinte.Inserir(obs);
                            }
                        }
                        if (veiculo.ValorContainerAverbacao > 0)
                        {
                            Dominio.Entidades.ObservacaoContribuinteCTE obs = new Dominio.Entidades.ObservacaoContribuinteCTE();
                            obs.CTE = cte;
                            obs.Identificador = "ValorContainer";
                            obs.Descricao = veiculo.ValorContainerAverbacao.ToString("n2");
                            repObsContribuinte.Inserir(obs);
                        }
                    }
                }
            }
        }

        public void AdicionarResponsavelSeguroObsContribuinte(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ObservacaoContribuinteCTE repObsContribuinte = new Repositorio.ObservacaoContribuinteCTE(unidadeDeTrabalho);
            Repositorio.SeguroCTE repSeguroCTE = new Repositorio.SeguroCTE(unidadeDeTrabalho);

            if (cte != null && cte.Empresa.Configuracao != null)
            {
                List<Dominio.Entidades.SeguroCTE> segurosCTe = repSeguroCTE.BuscarPorCTe(cte.Codigo);

                if (segurosCTe != null && segurosCTe.Count > 0)
                {
                    if (cte.Empresa.Configuracao.AdicionarResponsavelSeguroObsContribuinte)
                    {
                        string cnpjResponsavel = string.Empty;
                        if (segurosCTe.FirstOrDefault().Tipo == Dominio.Enumeradores.TipoSeguro.Remetente && cte.Remetente != null && !string.IsNullOrWhiteSpace(cte.Remetente.CPF_CNPJ))
                            cnpjResponsavel = cte.Remetente.CPF_CNPJ;
                        else if (segurosCTe.FirstOrDefault().Tipo == Dominio.Enumeradores.TipoSeguro.Destinatario && cte.Destinatario != null && !string.IsNullOrWhiteSpace(cte.Destinatario.CPF_CNPJ))
                            cnpjResponsavel = cte.Destinatario.CPF_CNPJ;
                        else if (segurosCTe.FirstOrDefault().Tipo == Dominio.Enumeradores.TipoSeguro.Expedidor && cte.Destinatario != null && !string.IsNullOrWhiteSpace(cte.Expedidor.CPF_CNPJ))
                            cnpjResponsavel = cte.Expedidor.CPF_CNPJ;
                        else if (segurosCTe.FirstOrDefault().Tipo == Dominio.Enumeradores.TipoSeguro.Recebedor && cte.Destinatario != null && !string.IsNullOrWhiteSpace(cte.Recebedor.CPF_CNPJ))
                            cnpjResponsavel = cte.Recebedor.CPF_CNPJ;
                        else if (segurosCTe.FirstOrDefault().Tipo == Dominio.Enumeradores.TipoSeguro.Tomador_Servico && cte.TomadorPagador != null && !string.IsNullOrWhiteSpace(cte.TomadorPagador.CPF_CNPJ))
                            cnpjResponsavel = cte.TomadorPagador.CPF_CNPJ;
                        else if (segurosCTe.FirstOrDefault().Tipo == Dominio.Enumeradores.TipoSeguro.Emitente_CTE)
                            cnpjResponsavel = cte.Empresa.CNPJ;

                        if (!string.IsNullOrWhiteSpace(cnpjResponsavel))
                        {
                            Dominio.Entidades.ObservacaoContribuinteCTE obs = repObsContribuinte.BuscarPorCTeEIdentificacaoEDescricao(cte.Codigo, "RESPSEG", cnpjResponsavel);
                            if (obs == null)
                            {
                                obs = new Dominio.Entidades.ObservacaoContribuinteCTE();
                                obs.CTE = cte;
                                obs.Identificador = "RESPSEG";
                                obs.Descricao = cnpjResponsavel;
                                repObsContribuinte.Inserir(obs);
                            }
                        }
                    }
                    else
                    {
                        Repositorio.ApoliceDeSeguro repApoliceDeSeguro = new Repositorio.ApoliceDeSeguro(unidadeDeTrabalho);
                        Dominio.Entidades.ApoliceDeSeguro apoliceDeSeguro = repApoliceDeSeguro.BuscarPorEmpresaApolice(cte.Empresa.Codigo, segurosCTe.FirstOrDefault().NumeroApolice);
                        if (apoliceDeSeguro != null && !string.IsNullOrWhiteSpace(apoliceDeSeguro.CNPJResposavelNaObservacaoContribuinte))
                        {
                            Repositorio.ObservacaoContribuinteCTE repObservacaoContribuinteCTE = new Repositorio.ObservacaoContribuinteCTE(unidadeDeTrabalho);
                            Dominio.Entidades.ObservacaoContribuinteCTE obsCont = repObservacaoContribuinteCTE.BuscarPorCTeEIdentificacaoEDescricao(cte.Codigo, "RESPSEG", apoliceDeSeguro.CNPJResposavelNaObservacaoContribuinte);
                            if (obsCont == null)
                            {
                                obsCont = new Dominio.Entidades.ObservacaoContribuinteCTE();
                                obsCont.CTE = cte;
                                obsCont.Identificador = "RESPSEG";
                                obsCont.Descricao = apoliceDeSeguro.CNPJResposavelNaObservacaoContribuinte;
                                repObservacaoContribuinteCTE.Inserir(obsCont);
                            }
                        }
                    }
                }
            }
        }

        public void SetarObservacoesAvancadas(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.VeiculoCTE repVeiculo = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
            Repositorio.MotoristaCTE repMotoristaCTE = new Repositorio.MotoristaCTE(unidadeDeTrabalho);
            Repositorio.DocumentosCTE repDocumentosCTe = new Repositorio.DocumentosCTE(unidadeDeTrabalho);

            if (cte == null)
                return;

            bool possuiConfigEmpresa = cte.Empresa != null && cte.Empresa.Configuracao != null;
            bool possuiObsAvancada = !string.IsNullOrWhiteSpace(cte.Empresa?.Configuracao?.ObservacaoCTeAvancadaProprio) || !string.IsNullOrWhiteSpace(cte.Empresa?.Configuracao?.ObservacaoCTeAvancadaTerceiros);
            bool formatarPlacaComHifen = cte.Empresa.Configuracao != null ? cte.Empresa.Configuracao.FormatarPlacaComHifenNaObservacao : false;
            bool cteNaoPossuiObsSetada = string.IsNullOrWhiteSpace(cte.ObservacoesAvancadas);

            if (possuiConfigEmpresa && possuiObsAvancada && cteNaoPossuiObsSetada)
            {
                List<Dominio.Entidades.VeiculoCTE> veiculos = repVeiculo.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);
                Dominio.Entidades.VeiculoCTE veiculo = (from obj in veiculos where obj.TipoVeiculo != null && obj.TipoVeiculo.Equals("0") select obj).FirstOrDefault();
                if (veiculo == null)
                    veiculo = (from obj in veiculos orderby obj.TipoVeiculo select obj).FirstOrDefault();

                string observacaoEmpresa = veiculo != null && veiculo.Proprietario != null ? cte.Empresa.Configuracao.ObservacaoCTeAvancadaTerceiros : cte.Empresa.Configuracao.ObservacaoCTeAvancadaProprio;

                if (!string.IsNullOrWhiteSpace(observacaoEmpresa))
                {
                    List<Dominio.Entidades.MotoristaCTE> listaMotoristas = repMotoristaCTE.BuscarPorCTe(cte.Codigo);
                    List<string> listaPlacas = (from veicVeinculado in veiculos where veiculo.Placa != veicVeinculado.Placa select veicVeinculado.Placa).ToList();
                    string placasVinculadas = listaPlacas.Count() > 0 ? String.Join(", ", listaPlacas) : string.Empty;

                    List<string> listaPlacasRenavam = (from veicVeinculado in veiculos where veiculo.Placa != veicVeinculado.Placa select veicVeinculado.Placa + "/" + veicVeinculado.RENAVAM).ToList();
                    string placasVinculadasRenavam = listaPlacasRenavam.Count() > 0 ? String.Join(", ", listaPlacasRenavam) : string.Empty;

                    string[] nomesMotoristas = (from m in listaMotoristas select m.NomeMotorista).ToArray();
                    string[] cpfsMotoristas = (from m in listaMotoristas select m.CPFMotorista).ToArray();

                    observacaoEmpresa = observacaoEmpresa.Replace("#NomeMotorista#", nomesMotoristas.Length > 0 ? String.Join(", ", nomesMotoristas) : string.Empty);
                    observacaoEmpresa = observacaoEmpresa.Replace("#CPFMotorista#", cpfsMotoristas.Length > 0 ? String.Join(", ", cpfsMotoristas) : string.Empty);

                    observacaoEmpresa = observacaoEmpresa.Replace("#CPFCNPJProprietario#", (veiculo != null && veiculo.Proprietario != null ? veiculo.Proprietario.CPF_CNPJ : string.Empty));
                    observacaoEmpresa = observacaoEmpresa.Replace("#NomeProprietario#", (veiculo != null && veiculo.Proprietario != null ? veiculo.Proprietario.Nome : string.Empty));
                    observacaoEmpresa = observacaoEmpresa.Replace("#RNTRCProprietario#", (veiculo != null && veiculo.Proprietario != null ? veiculo.Proprietario.RNTRC : string.Empty));

                    observacaoEmpresa = observacaoEmpresa.Replace("#PlacaVeiculo#", (veiculo != null ? formatarPlacaComHifen ? veiculo.Placa_Formatada : veiculo.Placa : string.Empty));
                    observacaoEmpresa = observacaoEmpresa.Replace("#RENAVAMVeiculo#", (veiculo != null ? veiculo.RENAVAM : string.Empty));
                    observacaoEmpresa = observacaoEmpresa.Replace("#UFVeiculo#", (veiculo != null ? veiculo.SiglaUF : string.Empty));
                    observacaoEmpresa = observacaoEmpresa.Replace("#MarcaVeiculo#", (veiculo != null && veiculo.Veiculo.Marca != null ? veiculo.Veiculo.Marca.Descricao : string.Empty));

                    observacaoEmpresa = observacaoEmpresa.Replace("#PlacasVinculadas#", (placasVinculadas != "" ? placasVinculadas : string.Empty));
                    observacaoEmpresa = observacaoEmpresa.Replace("#PlacasRenavamVinculadas#", (placasVinculadasRenavam != "" ? placasVinculadasRenavam : string.Empty));

                    if (observacaoEmpresa.Contains("#QuantidadeNotas#"))
                    {
                        int quantidadeNotas = repDocumentosCTe.ContarPorCTe(cte.Codigo);
                        observacaoEmpresa = observacaoEmpresa.Replace("#QuantidadeNotas#", quantidadeNotas.ToString());
                    }
                }

                string observacaoPadrao = this.BuscarObservacaoPadrao(cte, Dominio.Enumeradores.TipoObservacao.Geral, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, cte.CST, cte.ValorICMS, unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe);
                if (!string.IsNullOrWhiteSpace(observacaoPadrao))
                    observacaoEmpresa += " / " + observacaoPadrao;

                if (!string.IsNullOrWhiteSpace(observacaoEmpresa))
                    cte.ObservacoesAvancadas = string.IsNullOrWhiteSpace(cte.ObservacoesAvancadas) ? observacaoEmpresa : string.Concat(observacaoEmpresa, " ", cte.ObservacoesAvancadas);
            }
            else if (cteNaoPossuiObsSetada)
            {
                string observacaoPadrao = this.BuscarObservacaoPadrao(cte, Dominio.Enumeradores.TipoObservacao.Geral, cte.LocalidadeInicioPrestacao.Estado.Sigla, cte.LocalidadeTerminoPrestacao.Estado.Sigla, cte.CST, cte.ValorICMS, unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe);

                if (!string.IsNullOrWhiteSpace(observacaoPadrao))
                    cte.ObservacoesAvancadas = string.IsNullOrWhiteSpace(cte.ObservacoesAvancadas) ? observacaoPadrao : string.Concat(observacaoPadrao, " ", cte.ObservacoesAvancadas);
            }

            if (!string.IsNullOrWhiteSpace(cte.CIOT))
                cte.ObservacoesAvancadas = string.IsNullOrWhiteSpace(cte.ObservacoesAvancadas) ? "CIOT " + cte.CIOT : string.Concat(cte.ObservacoesAvancadas, " / CIOT " + cte.CIOT);

        }

        public void SetarObservacaoAvancadaPorRegraICMS(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware = null, bool emissaoManual = false)
        {
            if (tipoServicoMultisoftware.HasValue && (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador || tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS))
                return;

            if (cte != null)
            {
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);

                Servicos.Embarcador.Carga.ICMS svcICMS = new Embarcador.Carga.ICMS(unidadeDeTrabalho);

                bool incluirICMS = cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim ? true : false;
                decimal percentualInclusaoICMS = cte.PercentualICMSIncluirNoFrete;
                decimal valorBaseICMS = cte.BaseCalculoICMS;

                Dominio.Entidades.Localidade localidadeTermino = cte.LocalidadeTerminoPrestacao;
                Dominio.Entidades.Localidade localidadeExterior = null;
                if (cte.Destinatario?.Exterior ?? false)
                {
                    localidadeExterior = repLocalidade.BuscarPorEstado("EX");
                    if (localidadeExterior != null)
                        localidadeTermino = localidadeExterior;
                }

                Dominio.ObjetosDeValor.Embarcador.ICMS.RegraICMS regraICMS = svcICMS.BuscarRegraICMSMultiCTe(cte.Empresa, cte.SimplesNacional, cte.Remetente?.Cliente, cte.Destinatario?.Cliente, cte.Tomador?.Cliente, cte.LocalidadeInicioPrestacao, localidadeTermino, (localidadeExterior != null), ref incluirICMS, ref percentualInclusaoICMS, valorBaseICMS, cte.TipoServico, cte.CodigoProdutoEmbarcador, unidadeDeTrabalho);

                if (regraICMS != null && !string.IsNullOrWhiteSpace(regraICMS.ObservacaoCTe))
                {
                    if (!emissaoManual && !string.IsNullOrWhiteSpace(regraICMS.CST) && regraICMS.CST != cte.CST) //Quando não for emissão manual (MultiCTe) verifica se CTe esta com CST diferente da CST da Regra não gera observação
                        return;

                    string observacaoRegra = svcICMS.ObterObservacaoRegraICMS(regraICMS.ObservacaoCTe, cte.AliquotaICMS, regraICMS.AliquotaSimples, cte.ValorAReceber, cte.ValorICMS, cte.BaseCalculoICMS, cte.Empresa, cte.Remetente?.Cliente, cte.Destinatario?.Cliente, cte.Tomador?.Cliente, cte.LocalidadeInicioPrestacao, cte.LocalidadeTerminoPrestacao, cte.PercentualICMSIncluirNoFrete, string.Empty, cte.ValorPresumido);
                    if (!string.IsNullOrWhiteSpace(observacaoRegra) && (string.IsNullOrWhiteSpace(cte.ObservacoesAvancadas) || !cte.ObservacoesAvancadas.Contains(observacaoRegra)))
                        cte.ObservacoesAvancadas = string.IsNullOrWhiteSpace(cte.ObservacoesAvancadas) ? observacaoRegra : string.Concat(cte.ObservacoesAvancadas, " / ", observacaoRegra);
                }

                if (regraICMS != null && regraICMS.AliquotaSimples > 0 && cte.ValorAReceber > 0)
                {
                    cte.AliquotaICMSSimples = regraICMS.AliquotaSimples;
                    cte.ValorICMSSimples = Math.Round(cte.ValorAReceber * (regraICMS.AliquotaSimples / 100), 2, MidpointRounding.ToEven);
                }
                else
                {
                    cte.AliquotaICMSSimples = 0;
                    cte.ValorICMSSimples = 0;
                }
            }
        }

        public void SalvarDadosCobrancaAutomatico(Dominio.Entidades.Empresa empresa, ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            try
            {
                if (empresa.Configuracao != null && empresa.Configuracao.NumeroDeParcelasDasDuplicatas > 0)
                {
                    Repositorio.CobrancaCTe repCobranca = new Repositorio.CobrancaCTe(unidadeDeTrabalho);
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);
                    Dominio.Entidades.CobrancaCTe cobranca = repCobranca.BuscarPorCTe(empresa.Codigo, cte.Codigo);

                    if (cobranca == null && cte.Tomador?.CPF_CNPJ != null)
                    {
                        Repositorio.ParcelaCobrancaCTe repParcelaCobranca = new Repositorio.ParcelaCobrancaCTe(unidadeDeTrabalho);

                        cobranca = new Dominio.Entidades.CobrancaCTe();
                        cobranca.Numero = repCobranca.BuscarUltimoNumero(empresa.Codigo) + 1;
                        cobranca.Valor = cte.ValorAReceber;
                        cobranca.ValorDesconto = 0;
                        cobranca.ValorLiquido = cte.ValorFrete;
                        cobranca.CTe = cte;
                        cobranca.Cliente = repCliente.BuscarPorCPFCNPJ(double.Parse(cte.Tomador.CPF_CNPJ));

                        repCobranca.Inserir(cobranca);

                        int diasParaVencimento = empresa.Configuracao.DiasParaVencimentoDasDuplicatas > 0 ? empresa.Configuracao.DiasParaVencimentoDasDuplicatas : 0;

                        decimal valorDaParcela = Math.Round(cte.ValorAReceber / empresa.Configuracao.NumeroDeParcelasDasDuplicatas, 2, MidpointRounding.AwayFromZero);

                        DateTime dataVencimento = DateTime.Now.AddDays(diasParaVencimento);

                        for (int i = 0; i < empresa.Configuracao.NumeroDeParcelasDasDuplicatas; i++)
                        {
                            Dominio.Entidades.ParcelaCobrancaCTe parcela = new Dominio.Entidades.ParcelaCobrancaCTe();

                            parcela.Cobranca = cobranca;
                            parcela.DataVencimento = dataVencimento.Date;
                            parcela.Numero = i + 1;
                            parcela.Status = Dominio.Enumeradores.StatusDuplicata.Pendente;

                            if (parcela.Numero == 1)
                                parcela.Valor = valorDaParcela + (cte.ValorAReceber - Math.Round((valorDaParcela * empresa.Configuracao.NumeroDeParcelasDasDuplicatas), 2, MidpointRounding.AwayFromZero));
                            else
                                parcela.Valor = valorDaParcela;

                            if (parcela.Valor == 0 && empresa.Configuracao.NumeroDeParcelasDasDuplicatas == 1)
                                parcela.Valor = cte.ValorAReceber;

                            repParcelaCobranca.Inserir(parcela);

                            dataVencimento = dataVencimento.AddDays(diasParaVencimento);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Problemas ao salvar cobrança CTe " + ex);
            }
        }

        public Dominio.Entidades.EmpresaSerie ObterSerieNFSe(int codigoEmpresa, Repositorio.UnitOfWork unidadeDeTrabalho, int[] series = null, int codigoUsuario = 0)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeDeTrabalho);
            Repositorio.EmpresaSerie repSerie = new Repositorio.EmpresaSerie(unidadeDeTrabalho);
            Repositorio.Usuario repUsuario = new Repositorio.Usuario(unidadeDeTrabalho);

            Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCodigo(codigoEmpresa);
            Dominio.Entidades.EmpresaSerie serie = null;
            Dominio.Entidades.Usuario usuario = null;

            if (codigoUsuario > 0)
                usuario = repUsuario.BuscarPorCodigo(codigoUsuario);

            if (usuario != null)
                serie = (from obj in usuario.Series where obj.Status.Equals("A") && obj.Tipo == Dominio.Enumeradores.TipoSerie.NFSe select obj).FirstOrDefault();

            if (serie == null && empresa != null && empresa.Configuracao != null)
            {
                serie = empresa.Configuracao.SerieNFSe;
            }

            if (serie == null)
            {
                //cte = repCTe.BuscarUltimoCTeEmitido(codigoEmpresa, series);
                serie = repCTe.BuscarSerieUltimoCTeEmitidoNFSe(codigoEmpresa, series);

                if (serie == null)
                    serie = repSerie.BuscarUltimoRegistroNFSe(codigoEmpresa, series);
            }

            if (serie == null)
                serie = repSerie.BuscarPorEmpresaTipo(codigoEmpresa, Dominio.Enumeradores.TipoSerie.NFSe);

            return serie;
        }

        public Dominio.Entidades.EmpresaSerie ObterSerie(Dominio.Entidades.Empresa empresa, string siglaUFEmissao, string siglaUFOrigem, string siglaUFDestino, string cnpjRemetente, string cnpjDestinatario, string cnpjRecebedor, string cnpjExpedidor, string cnpjTomador, Repositorio.UnitOfWork unidadeDeTrabalho, int[] series = null, Dominio.Entidades.Usuario usuario = null, List<Dominio.Entidades.EstadosDeEmissaoSerie> listaEstadosDeEmissaoSerie = null)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);
            Repositorio.EstadosDeEmissaoSerie repEstadosDeEmissaoSerie = new Repositorio.EstadosDeEmissaoSerie(unidadeDeTrabalho);
            Repositorio.ConfiguracaoEmpresaClienteSerie repConfiguracaoEmpresaClienteSerie = new Repositorio.ConfiguracaoEmpresaClienteSerie(unidadeDeTrabalho);
            Repositorio.EmpresaSerie repSerie = new Repositorio.EmpresaSerie(unidadeDeTrabalho);

            Dominio.Entidades.EmpresaSerie serie = null;
            Dominio.Entidades.EstadosDeEmissaoSerie estadoDeEmissaoSerie = null;
            Dominio.Entidades.ConfiguracaoEmpresaClienteSerie configuracaoEmpresaClienteSerie = null;

            if (usuario != null)
                serie = (from obj in usuario.Series where obj.Status.Equals("A") && obj.Tipo == Dominio.Enumeradores.TipoSerie.CTe select obj).FirstOrDefault();

            if (serie == null && empresa != null && empresa.Configuracao != null)
            {
                if (!string.IsNullOrWhiteSpace(cnpjTomador))
                    configuracaoEmpresaClienteSerie = repConfiguracaoEmpresaClienteSerie.BuscarPorCliente(empresa.Configuracao.Codigo, Utilidades.String.OnlyNumbers(cnpjTomador), Dominio.Enumeradores.TipoTomador.Outros);
                if (configuracaoEmpresaClienteSerie == null && !string.IsNullOrWhiteSpace(cnpjRemetente))
                    configuracaoEmpresaClienteSerie = repConfiguracaoEmpresaClienteSerie.BuscarPorCliente(empresa.Configuracao.Codigo, Utilidades.String.OnlyNumbers(cnpjRemetente), Dominio.Enumeradores.TipoTomador.Remetente);
                if (configuracaoEmpresaClienteSerie == null && !string.IsNullOrWhiteSpace(cnpjDestinatario))
                    configuracaoEmpresaClienteSerie = repConfiguracaoEmpresaClienteSerie.BuscarPorCliente(empresa.Configuracao.Codigo, Utilidades.String.OnlyNumbers(cnpjDestinatario), Dominio.Enumeradores.TipoTomador.Destinatario);
                if (configuracaoEmpresaClienteSerie == null && !string.IsNullOrWhiteSpace(cnpjExpedidor))
                    configuracaoEmpresaClienteSerie = repConfiguracaoEmpresaClienteSerie.BuscarPorCliente(empresa.Configuracao.Codigo, Utilidades.String.OnlyNumbers(cnpjExpedidor), Dominio.Enumeradores.TipoTomador.Expedidor);
                if (configuracaoEmpresaClienteSerie == null && !string.IsNullOrWhiteSpace(cnpjRecebedor))
                    configuracaoEmpresaClienteSerie = repConfiguracaoEmpresaClienteSerie.BuscarPorCliente(empresa.Configuracao.Codigo, Utilidades.String.OnlyNumbers(cnpjRecebedor), Dominio.Enumeradores.TipoTomador.Recebedor);

                if (configuracaoEmpresaClienteSerie != null)
                    serie = configuracaoEmpresaClienteSerie.Serie;
                else
                {
                    if (listaEstadosDeEmissaoSerie == null)
                        estadoDeEmissaoSerie = repEstadosDeEmissaoSerie.BuscarPorUF(empresa.Configuracao.Codigo, siglaUFOrigem);
                    else if (listaEstadosDeEmissaoSerie.Count > 0)
                        estadoDeEmissaoSerie = listaEstadosDeEmissaoSerie.Where(o => o.Estado.Sigla == siglaUFOrigem).Select(o => o).FirstOrDefault();

                    if (estadoDeEmissaoSerie != null)
                        serie = estadoDeEmissaoSerie.Serie;
                }

                if (serie == null)
                {
                    if (empresa.Configuracao.SerieInterestadual != null && siglaUFOrigem != siglaUFEmissao)
                    {
                        serie = empresa.Configuracao.SerieInterestadual;
                    }
                    else if (empresa.Configuracao.SerieIntraestadual != null && siglaUFOrigem == siglaUFEmissao)
                    {
                        serie = empresa.Configuracao.SerieIntraestadual;
                    }
                }
            }

            if (serie == null)
            {
                serie = repCTe.BuscarSerieUltimoCTeEmitido(empresa.Codigo, series);

                if (serie == null)
                    serie = repSerie.BuscarUltimoRegistro(empresa.Codigo, series);
            }

            if (serie == null)
                serie = repSerie.BuscarPorEmpresaTipo(empresa.Codigo, Dominio.Enumeradores.TipoSerie.CTe);

            return serie;
        }

        public int ObterCodigoSerie(int codigoEmpresa, string siglaUFEmissao, string siglaUFOrigem, string siglaUFDestino, Repositorio.UnitOfWork unidadeDeTrabalho, int[] series = null, int codigoUsuario = 0)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);
            Repositorio.EstadosDeEmissaoSerie repEstadosDeEmissaoSerie = new Repositorio.EstadosDeEmissaoSerie(unidadeDeTrabalho);
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeDeTrabalho);
            Repositorio.EmpresaSerie repSerie = new Repositorio.EmpresaSerie(unidadeDeTrabalho);
            Repositorio.Usuario repUsuario = new Repositorio.Usuario(unidadeDeTrabalho);

            Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCodigo(codigoEmpresa);
            Dominio.Entidades.EstadosDeEmissaoSerie estadoDeEmissaoSerie = null;
            Dominio.Entidades.EmpresaSerie serie = null;
            Dominio.Entidades.Usuario usuario = null;

            if (codigoUsuario > 0)
                usuario = repUsuario.BuscarPorCodigo(codigoUsuario);

            if (usuario != null)
                serie = (from obj in usuario.Series where obj.Status.Equals("A") && obj.Tipo == Dominio.Enumeradores.TipoSerie.CTe select obj).FirstOrDefault();

            if (serie == null && empresa != null && empresa.Configuracao != null)
            {
                estadoDeEmissaoSerie = repEstadosDeEmissaoSerie.BuscarPorUF(empresa.Configuracao.Codigo, siglaUFOrigem);

                if (estadoDeEmissaoSerie != null)
                    serie = estadoDeEmissaoSerie.Serie;

                if (serie == null)
                {
                    if (empresa.Configuracao.SerieInterestadual != null && siglaUFOrigem != siglaUFEmissao)
                    {
                        serie = empresa.Configuracao.SerieInterestadual;
                    }
                    else if (empresa.Configuracao.SerieIntraestadual != null && siglaUFOrigem == siglaUFEmissao)
                    {
                        serie = empresa.Configuracao.SerieIntraestadual;
                    }
                }
            }

            if (serie == null)
            {
                //cte = repCTe.BuscarUltimoCTeEmitido(codigoEmpresa, series);
                serie = repCTe.BuscarSerieUltimoCTeEmitido(codigoEmpresa, series);

                if (serie == null)
                    serie = repSerie.BuscarUltimoRegistro(codigoEmpresa, series);
            }

            if (serie == null)
                serie = repSerie.BuscarPorEmpresaTipo(codigoEmpresa, Dominio.Enumeradores.TipoSerie.CTe);

            return serie.Codigo;
        }

        public string AdicionarNotaCTeDigitacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.NFe.v310.NotaFiscalProcessada.TNfeProc nfe, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            try
            {
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);

                if (nfe != null)
                {
                    System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                    Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                    Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                    Repositorio.ModeloDocumentoFiscal repModelo = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

                    Dominio.Entidades.DocumentosCTE documentoAnterior = repDocumento.BuscarPorCTeENFe(cte.Codigo, nfe.protNFe.infProt.chNFe);
                    if (documentoAnterior == null)
                    {
                        Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();

                        DateTime dataEmissao;
                        if (!DateTime.TryParseExact(nfe.protNFe.infProt.dhRecbto.Substring(0, 19), "yyyy-MM-ddTHH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataEmissao))
                            dataEmissao = DateTime.Now;

                        documento.ChaveNFE = nfe.protNFe.infProt.chNFe;
                        documento.DataEmissao = dataEmissao;
                        documento.Valor = decimal.Parse(nfe.NFe.infNFe.total.ICMSTot.vNF, cultura);
                        documento.ModeloDocumentoFiscal = repModelo.BuscarPorModelo(nfe.NFe.infNFe.ide.mod.ToString("D"));
                        documento.Numero = nfe.NFe.infNFe.ide.nNF;
                        documento.CTE = cte;
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumento.Inserir(documento);

                        decimal pesoNFe = 0m;

                        if (nfe.NFe.infNFe.transp != null)
                        {
                            if (nfe.NFe.infNFe.transp.vol != null)
                            {
                                decimal peso = 0;

                                foreach (MultiSoftware.NFe.v310.NotaFiscal.TNFeInfNFeTranspVol vol in nfe.NFe.infNFe.transp.vol)
                                    peso += vol.pesoB != null ? decimal.Parse(vol.pesoB, cultura) : vol.pesoL != null ? decimal.Parse(vol.pesoL, cultura) : 0;

                                pesoNFe = peso;
                            }
                        }

                        if (pesoNFe > 0)
                        {
                            Repositorio.InformacaoCargaCTE repInformacaoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
                            Dominio.Entidades.InformacaoCargaCTE informacaoCarga = repInformacaoCarga.BuscarPorCTeUnidade(cte.Codigo, "01");
                            if (informacaoCarga == null)
                                informacaoCarga = new Dominio.Entidades.InformacaoCargaCTE();

                            informacaoCarga.CTE = cte;
                            informacaoCarga.Quantidade += pesoNFe;
                            informacaoCarga.Tipo = "Kilograma";
                            informacaoCarga.UnidadeMedida = string.Format("{0:00}", (int)Dominio.Enumeradores.UnidadeMedida.KG);

                            if (informacaoCarga.Codigo == 0)
                                repInformacaoCarga.Inserir(informacaoCarga);
                            else
                                repInformacaoCarga.Atualizar(informacaoCarga);
                        }

                        cte.ValorTotalMercadoria += decimal.Parse(nfe.NFe.infNFe.total.ICMSTot.vNF, cultura);
                        repCTe.Atualizar(cte);
                    }
                    else
                    {
                        return "NF-e já adicionada ao CT-e";
                    }
                }
                return "";
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Problemas ao adicionar NFe ao CTe" + ex);
                return "Problemas ao adicionar NFe ao CTe" + ex;
            }
        }

        public string AdicionarNotaCTeDigitacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.NFe.v400.NotaFiscalProcessada.TNfeProc nfe, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            try
            {
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);

                if (nfe != null)
                {
                    System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                    Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                    Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                    Repositorio.ModeloDocumentoFiscal repModelo = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

                    Dominio.Entidades.DocumentosCTE documentoAnterior = repDocumento.BuscarPorCTeENFe(cte.Codigo, nfe.protNFe.infProt.chNFe);
                    if (documentoAnterior == null)
                    {
                        Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();

                        DateTime dataEmissao;
                        if (!DateTime.TryParseExact(nfe.protNFe.infProt.dhRecbto.Substring(0, 19), "yyyy-MM-ddTHH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataEmissao))
                            dataEmissao = DateTime.Now;

                        documento.ChaveNFE = nfe.protNFe.infProt.chNFe;
                        documento.DataEmissao = dataEmissao;
                        documento.Valor = decimal.Parse(nfe.NFe.infNFe.total.ICMSTot.vNF, cultura);
                        documento.ModeloDocumentoFiscal = repModelo.BuscarPorModelo(nfe.NFe.infNFe.ide.mod.ToString("D"));
                        documento.Numero = nfe.NFe.infNFe.ide.nNF;
                        documento.CTE = cte;
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumento.Inserir(documento);

                        decimal pesoNFe = 0m;

                        if (nfe.NFe.infNFe.transp != null)
                        {
                            if (nfe.NFe.infNFe.transp.vol != null)
                            {
                                decimal peso = 0;

                                foreach (MultiSoftware.NFe.v400.NotaFiscal.TNFeInfNFeTranspVol vol in nfe.NFe.infNFe.transp.vol)
                                    peso += vol.pesoB != null ? decimal.Parse(vol.pesoB, cultura) : vol.pesoL != null ? decimal.Parse(vol.pesoL, cultura) : 0;

                                pesoNFe = peso;
                            }
                        }

                        if (pesoNFe > 0)
                        {
                            Repositorio.InformacaoCargaCTE repInformacaoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
                            Dominio.Entidades.InformacaoCargaCTE informacaoCarga = repInformacaoCarga.BuscarPorCTeUnidade(cte.Codigo, "01");
                            if (informacaoCarga == null)
                                informacaoCarga = new Dominio.Entidades.InformacaoCargaCTE();

                            informacaoCarga.CTE = cte;
                            informacaoCarga.Quantidade += pesoNFe;
                            informacaoCarga.Tipo = "Kilograma";
                            informacaoCarga.UnidadeMedida = string.Format("{0:00}", (int)Dominio.Enumeradores.UnidadeMedida.KG);

                            if (informacaoCarga.Codigo == 0)
                                repInformacaoCarga.Inserir(informacaoCarga);
                            else
                                repInformacaoCarga.Atualizar(informacaoCarga);
                        }

                        cte.ValorTotalMercadoria += decimal.Parse(nfe.NFe.infNFe.total.ICMSTot.vNF, cultura);
                        repCTe.Atualizar(cte);
                    }
                    else
                    {
                        return "NF-e já adicionada ao CT-e";
                    }
                }
                return "";
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Problemas ao adicionar NFe ao CTe" + ex);
                return "Problemas ao adicionar NFe ao CTe" + ex;
            }
        }

        public bool AlterarValorFreteCTe(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, decimal valorFrete, decimal valorPedagio, decimal valorAdicionalEntrega, decimal percentualGris, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            try
            {
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);
                Repositorio.ComponentePrestacaoCTE repComponentePrestacaoCTE = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

                decimal valorGris = (percentualGris > 0 && cte.ValorTotalMercadoria > 0) ? Math.Round(cte.ValorTotalMercadoria * (percentualGris / 100), 2) : 0;

                cte.ValorFrete = Math.Round(valorFrete, 2, MidpointRounding.ToEven);
                cte.ValorPrestacaoServico = Math.Round(cte.ValorFrete + valorPedagio + valorAdicionalEntrega + valorGris, 2, MidpointRounding.ToEven);
                cte.ValorAReceber = Math.Round(cte.ValorFrete + valorPedagio + valorAdicionalEntrega + valorGris, 2, MidpointRounding.ToEven);

                repCTe.Atualizar(cte);

                repComponentePrestacaoCTE.DeletarPorCTe(cte.Codigo);

                this.SalvarInformacoesComponentesDaPrestacao(cte, "FRETE VALOR", cte.ValorFrete, false, true, unidadeDeTrabalho);

                if (valorPedagio > 0)
                    this.SalvarInformacoesComponentesDaPrestacao(cte, "PEDAGIO", valorPedagio, cte.LocalidadeInicioPrestacao.Estado.Sigla == "PR" ? false : true, true, unidadeDeTrabalho);

                if (valorAdicionalEntrega > 0)
                    this.SalvarInformacoesComponentesDaPrestacao(cte, "SEGURO", valorAdicionalEntrega, true, true, unidadeDeTrabalho);

                if (valorGris > 0)
                    this.SalvarInformacoesComponentesDaPrestacao(cte, "GRIS", valorGris, true, true, unidadeDeTrabalho);

                this.CalcularICMSPorTabelaDeAliquotas(ref cte, cte.SimplesNacional, unidadeDeTrabalho);

                return true;
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Problemas ao alterar valor frete CTe" + ex);
                return false;
            }
        }

        public bool CarregarTributacaoCTeSemelhante(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unitOfWork)
        {
            bool copiouInformacoes = false;

            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unitOfWork);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Repositorio.CFOP repCFOP = new Repositorio.CFOP(unitOfWork);
            Repositorio.Cliente repRemetente = new Repositorio.Cliente(unitOfWork);
            Repositorio.Cliente repDestinatario = new Repositorio.Cliente(unitOfWork);

            double cpfCnpjRemetente, cpfCnpjDestinatario = 0f;
            double.TryParse(Utilidades.String.OnlyNumbers(cte.Remetente.CPF_CNPJ), out cpfCnpjRemetente);
            double.TryParse(Utilidades.String.OnlyNumbers(cte.Destinatario.CPF_CNPJ), out cpfCnpjDestinatario);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico cteAnterior = repCTe.BuscarPorRemetenteEDestinatario(cte.Empresa.Codigo, repRemetente.BuscarPorCPFCNPJ(cpfCnpjRemetente), repDestinatario.BuscarPorCPFCNPJ(cpfCnpjDestinatario), cte.TipoAmbiente);

            if (cteAnterior == null)
                cteAnterior = repCTe.BuscarPorUFInicioPrestacaoEUFFimPrestacao(cte.Empresa.Codigo, cte.LocalidadeInicioPrestacao.Estado, cte.LocalidadeTerminoPrestacao.Estado, cte.TipoAmbiente);

            if (cteAnterior != null)
            {
                copiouInformacoes = true;

                bool copiaImpostosCTeAnterior = !(cte.Empresa.Configuracao?.NaoCopiarImpostosCTeAnterior ?? false);

                if (copiaImpostosCTeAnterior)
                {
                    cte.NaturezaDaOperacao = cteAnterior.NaturezaDaOperacao;
                    cte.CFOP = cteAnterior.CFOP;
                    cte.AliquotaICMS = cteAnterior.AliquotaICMS;
                    cte.CST = cteAnterior.CST;
                    cte.PercentualReducaoBaseCalculoICMS = cteAnterior.PercentualReducaoBaseCalculoICMS;
                }
                else
                {
                    Servicos.Embarcador.Carga.ICMS svcICMS = new Embarcador.Carga.ICMS(unitOfWork);

                    bool incluirICMS = cte.IncluirISSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim ? true : false;
                    decimal percentualInclusaoICMS = cte.PercentualICMSIncluirNoFrete;
                    decimal valorBaseICMS = cte.BaseCalculoICMS;

                    Dominio.Entidades.Localidade localidadeTermino = cte.LocalidadeTerminoPrestacao;
                    Dominio.Entidades.Localidade localidadeExterior = null;
                    if (cte.Destinatario?.Exterior ?? false)
                    {
                        localidadeExterior = repLocalidade.BuscarPorEstado("EX");
                        if (localidadeExterior != null)
                            localidadeTermino = localidadeExterior;
                    }

                    Dominio.ObjetosDeValor.Embarcador.ICMS.RegraICMS regraICMS = svcICMS.BuscarRegraICMSMultiCTe(cte.Empresa, cte.SimplesNacional, cte.Remetente.Cliente, cte.Destinatario.Cliente, cte.Tomador.Cliente, cte.LocalidadeInicioPrestacao, localidadeTermino, localidadeExterior != null, ref incluirICMS, ref percentualInclusaoICMS, valorBaseICMS, cte.TipoServico, cte.CodigoProdutoEmbarcador, unitOfWork);

                    if (regraICMS != null)
                    {
                        if (regraICMS.CFOP > 0)
                        {
                            Dominio.Entidades.CFOP cfop = repCFOP.BuscarPorCFOP(regraICMS.CFOP, Dominio.Enumeradores.TipoCFOP.Saida);
                            if (cfop != null)
                            {
                                cte.CFOP = cfop;
                                cte.NaturezaDaOperacao = cfop.NaturezaDaOperacao;
                            }
                        }
                        else
                            cte.CFOP = cteAnterior.CFOP;

                        if (!string.IsNullOrWhiteSpace(regraICMS.CST))
                        {
                            if (regraICMS.CST == "SN")
                            {
                                cte.CST = "";
                                cte.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Sim;
                            }
                            else
                                cte.CST = regraICMS.CST;
                        }
                        else
                            cte.CST = cteAnterior.CST;

                        if (!string.IsNullOrWhiteSpace(cte.CST))
                        {
                            if (regraICMS.Aliquota > 0)
                                cte.AliquotaICMS = regraICMS.Aliquota;
                            else
                                cte.AliquotaICMS = cteAnterior.AliquotaICMS;

                            if (regraICMS.PercentualReducaoBC > 0)
                                cte.PercentualReducaoBaseCalculoICMS = regraICMS.PercentualReducaoBC;
                            else
                                cte.PercentualReducaoBaseCalculoICMS = cteAnterior.PercentualReducaoBaseCalculoICMS;

                            if (regraICMS.ValorBaseCalculoICMS == 0) //Configurado para Zerar o valor da Base de Calculo
                            {
                                cte.BaseCalculoICMS = 0;
                                cte.AliquotaICMS = 0;
                            }
                        }
                    }
                }

                cte.IncluirICMSNoFrete = cteAnterior.IncluirICMSNoFrete;
                cte.PercentualICMSIncluirNoFrete = cteAnterior.PercentualICMSIncluirNoFrete;
                cte.ExibeICMSNaDACTE = cteAnterior.ExibeICMSNaDACTE;
            }

            return copiouInformacoes;
        }

        public bool CarregarInformacoesSemelhantes(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unitOfWork, bool carregarValores = true)
        {
            bool clientesIguais = false;
            bool copiouInformacoes = false;

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Repositorio.ObservacaoContribuinteCTE repObsContribuinte = new Repositorio.ObservacaoContribuinteCTE(unitOfWork);
            Repositorio.ObservacaoFiscoCTE repObsFisco = new Repositorio.ObservacaoFiscoCTE(unitOfWork);
            Repositorio.ComponentePrestacaoCTE repComponentePrestacao = new Repositorio.ComponentePrestacaoCTE(unitOfWork);
            Repositorio.SeguroCTE repSeguro = new Repositorio.SeguroCTE(unitOfWork);

            Repositorio.Cliente repRemetente = new Repositorio.Cliente(unitOfWork);
            Repositorio.Cliente repDestinatario = new Repositorio.Cliente(unitOfWork);

            double cpfCnpjRemetente, cpfCnpjDestinatario = 0f;
            double.TryParse(Utilidades.String.OnlyNumbers(cte.Remetente.CPF_CNPJ), out cpfCnpjRemetente);
            double.TryParse(Utilidades.String.OnlyNumbers(cte.Destinatario.CPF_CNPJ), out cpfCnpjDestinatario);

            string ufOrigem = cte.LocalidadeInicioPrestacao?.Estado.Sigla ?? string.Empty;
            string ufDestino = cte.LocalidadeTerminoPrestacao?.Estado.Sigla ?? string.Empty;

            bool copiaValoresCTeAnterior = !(cte.Empresa.Configuracao?.NaoCopiarValoresCTeAnterior ?? false);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico cteReferencia = null;
            if (Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoAmbiente().IdentificacaoAmbiente == "Sintravir")
                cteReferencia = repCTe.BuscarReferenciaSintravir(cte.Empresa.Codigo, cte.Remetente.CPF_CNPJ, cte.Destinatario?.CPF_CNPJ, cte.Expedidor?.CPF_CNPJ, cte.Recebedor?.CPF_CNPJ, cte.LocalidadeInicioPrestacao.Codigo, cte.LocalidadeTerminoPrestacao.Codigo, cte.TipoServico);
            else
                cteReferencia = repCTe.BuscarReferenciaPorClienteOrigemDestino(cte.Empresa.Codigo, cte.Remetente.CPF_CNPJ, ufOrigem, ufDestino, cte.TipoServico);

            if (cteReferencia != null)
            {
                copiouInformacoes = true;

                cte.CTeReferencia = cteReferencia.Codigo;
                cte.NaturezaDaOperacao = cteReferencia.NaturezaDaOperacao;
                cte.CFOP = cteReferencia.CFOP;

                cte.CST = cteReferencia.CST;
                cte.AliquotaICMS = cteReferencia.AliquotaICMS;
                cte.IncluirICMSNoFrete = cteReferencia.IncluirICMSNoFrete;
                cte.BaseCalculoICMS = cteReferencia.BaseCalculoICMS;
                cte.ValorICMS = cteReferencia.ValorICMS;
                cte.PercentualReducaoBaseCalculoICMS = cteReferencia.PercentualReducaoBaseCalculoICMS;
                cte.IncluirICMSNoFrete = cteReferencia.IncluirICMSNoFrete;
                cte.PercentualICMSIncluirNoFrete = cteReferencia.PercentualICMSIncluirNoFrete;
                cte.ExibeICMSNaDACTE = cteReferencia.ExibeICMSNaDACTE;

                cte.TipoPagamento = cteReferencia.TipoPagamento;
                cte.TipoTomador = cteReferencia.TipoTomador;
                cte.TipoServico = cteReferencia.TipoServico;
                cte.ProdutoPredominante = cteReferencia.ProdutoPredominante;
                if (string.IsNullOrWhiteSpace(cte.ObservacoesGerais))
                    cte.ObservacoesGerais = cteReferencia.ObservacoesGerais;

                if (copiaValoresCTeAnterior)
                {
                    cte.ValorFrete = cteReferencia.ValorFrete;
                    List<Dominio.Entidades.ComponentePrestacaoCTE> componentesDaPrestacao = repComponentePrestacao.BuscarPorCTe(cte.Empresa.Codigo, cteReferencia.Codigo);
                    if (componentesDaPrestacao.Count > 0)
                    {
                        foreach (Dominio.Entidades.ComponentePrestacaoCTE componente in componentesDaPrestacao)
                        {
                            Dominio.Entidades.ComponentePrestacaoCTE componentesCTe = new Dominio.Entidades.ComponentePrestacaoCTE();
                            componentesCTe.CTE = cte;
                            componentesCTe.IncluiNaBaseDeCalculoDoICMS = componente.IncluiNaBaseDeCalculoDoICMS;
                            componentesCTe.IncluiNoTotalAReceber = componente.IncluiNoTotalAReceber;
                            componentesCTe.Nome = componente.Nome;
                            componentesCTe.Valor = componente.Valor;

                            repComponentePrestacao.Inserir(componentesCTe);
                        }
                    }

                    cte.ValorPrestacaoServico = cteReferencia.ValorPrestacaoServico;
                    cte.ValorAReceber = cteReferencia.ValorAReceber;
                }

                List<Dominio.Entidades.SeguroCTE> seguros = repSeguro.BuscarPorCTe(cte.Empresa.Codigo, cteReferencia.Codigo);
                if (seguros.Count > 0 && seguros[0].NomeSeguradora != null && seguros[0].NomeSeguradora != "")
                {
                    foreach (Dominio.Entidades.SeguroCTE seguro in seguros)
                    {
                        Dominio.Entidades.SeguroCTE segurosCTe = new Dominio.Entidades.SeguroCTE();
                        segurosCTe.CTE = cte;
                        segurosCTe.Tipo = seguro.Tipo;
                        segurosCTe.NomeSeguradora = seguro.NomeSeguradora;
                        segurosCTe.CNPJSeguradora = seguro.CNPJSeguradora;
                        segurosCTe.NumeroApolice = seguro.NumeroApolice;
                        segurosCTe.NumeroAverbacao = string.Empty;
                        segurosCTe.Valor = 0;
                        repSeguro.Inserir(segurosCTe);
                    }
                }
                else this.SalvarInformacoesDeSeguroDaCarga(cte, unitOfWork);
            }
            else
            {

                bool copiaImpostosCTeAnterior = !(cte.Empresa.Configuracao?.NaoCopiarImpostosCTeAnterior ?? false);
                bool copiaSeguroCTeAnterior = !(cte.Empresa.Configuracao?.NaoCopiarSeguroCTeAnterior ?? false);
                bool copiarObservacaoFiscoContribuinteCTeAnterior = cte.Empresa.Configuracao?.CopiarObservacaoFiscoContribuinteCTeAnterior ?? false;

                Dominio.Entidades.ConhecimentoDeTransporteEletronico cteAnterior = repCTe.BuscarPorRemetenteEDestinatario(cte.Empresa.Codigo, repRemetente.BuscarPorCPFCNPJ(cpfCnpjRemetente), repDestinatario.BuscarPorCPFCNPJ(cpfCnpjDestinatario), cte.TipoAmbiente);

                if (cteAnterior == null)
                    cteAnterior = repCTe.BuscarPorUFInicioPrestacaoEUFFimPrestacao(cte.Empresa.Codigo, cte.LocalidadeInicioPrestacao.Estado, cte.LocalidadeTerminoPrestacao.Estado, cte.TipoAmbiente);
                else
                    clientesIguais = true;

                if (cteAnterior != null)
                {
                    copiouInformacoes = true;

                    List<Dominio.Entidades.ObservacaoContribuinteCTE> observacoesContribuinte = copiarObservacaoFiscoContribuinteCTeAnterior ? repObsContribuinte.BuscarPorCTe(cte.Empresa.Codigo, cteAnterior.Codigo) : new List<Dominio.Entidades.ObservacaoContribuinteCTE>();
                    List<Dominio.Entidades.ObservacaoFiscoCTE> observacoesFisco = copiarObservacaoFiscoContribuinteCTeAnterior ? repObsFisco.BuscarPorCTe(cte.Empresa.Codigo, cteAnterior.Codigo) : new List<Dominio.Entidades.ObservacaoFiscoCTE>();
                    List<Dominio.Entidades.ComponentePrestacaoCTE> componentesDaPrestacao = repComponentePrestacao.BuscarPorCTe(cte.Empresa.Codigo, cteAnterior.Codigo);
                    List<Dominio.Entidades.SeguroCTE> seguros = new List<Dominio.Entidades.SeguroCTE>();
                    if (copiaSeguroCTeAnterior)
                        seguros = repSeguro.BuscarPorCTe(cte.Empresa.Codigo, cteAnterior.Codigo);

                    if (copiaImpostosCTeAnterior)
                    {
                        cte.NaturezaDaOperacao = cteAnterior.NaturezaDaOperacao;
                        cte.CFOP = cteAnterior.CFOP;
                        cte.AliquotaICMS = cteAnterior.AliquotaICMS;
                        cte.CST = cteAnterior.CST;
                        cte.PercentualReducaoBaseCalculoICMS = cteAnterior.PercentualReducaoBaseCalculoICMS;
                    }

                    cte.IncluirICMSNoFrete = cteAnterior.IncluirICMSNoFrete;
                    cte.PercentualICMSIncluirNoFrete = cteAnterior.PercentualICMSIncluirNoFrete;
                    cte.ExibeICMSNaDACTE = cteAnterior.ExibeICMSNaDACTE;

                    if (clientesIguais)
                    {
                        cte.TipoPagamento = cteAnterior.TipoPagamento;
                        cte.TipoTomador = cteAnterior.TipoTomador;
                        if (string.IsNullOrWhiteSpace(cte.ObservacoesGerais))
                            cte.ObservacoesGerais = cteAnterior.ObservacoesGerais;
                        cte.TipoServico = cteAnterior.TipoServico;
                        cte.ProdutoPredominante = cteAnterior.ProdutoPredominante;
                        if (copiarObservacaoFiscoContribuinteCTeAnterior)
                        {
                            if (observacoesContribuinte != null && observacoesContribuinte.Count > 0)
                            {
                                int qtdObservacaoContribu = 0;
                                foreach (Dominio.Entidades.ObservacaoContribuinteCTE observacaoContribuinte in observacoesContribuinte)
                                {
                                    if (qtdObservacaoContribu == 10)
                                        break;
                                    qtdObservacaoContribu += 1;
                                    Dominio.Entidades.ObservacaoContribuinteCTE obsContribuinte = new Dominio.Entidades.ObservacaoContribuinteCTE();
                                    obsContribuinte.CTE = cte;
                                    obsContribuinte.Identificador = observacaoContribuinte.Identificador;
                                    obsContribuinte.Descricao = observacaoContribuinte.Descricao;
                                    repObsContribuinte.Inserir(obsContribuinte);
                                }
                            }

                            if (observacoesFisco != null && observacoesFisco.Count > 0)
                            {
                                int qtdObservacaoCont = 0;
                                foreach (Dominio.Entidades.ObservacaoFiscoCTE observacaoFisco in observacoesFisco)
                                {
                                    if (qtdObservacaoCont == 10)
                                        break;
                                    qtdObservacaoCont += 1;
                                    Dominio.Entidades.ObservacaoFiscoCTE obsFisco = new Dominio.Entidades.ObservacaoFiscoCTE();
                                    obsFisco.CTE = cte;
                                    obsFisco.Identificador = observacaoFisco.Identificador;
                                    obsFisco.Descricao = observacaoFisco.Descricao;
                                    repObsFisco.Inserir(obsFisco);
                                }
                            }
                        }

                        if (carregarValores && copiaValoresCTeAnterior)
                        {
                            cte.ValorFrete = cteAnterior.ValorFrete;
                            if (componentesDaPrestacao.Count > 0)
                            {
                                foreach (Dominio.Entidades.ComponentePrestacaoCTE componente in componentesDaPrestacao)
                                {
                                    Dominio.Entidades.ComponentePrestacaoCTE componentesCTe = new Dominio.Entidades.ComponentePrestacaoCTE();
                                    componentesCTe.CTE = cte;
                                    componentesCTe.IncluiNaBaseDeCalculoDoICMS = componente.IncluiNaBaseDeCalculoDoICMS;
                                    componentesCTe.IncluiNoTotalAReceber = componente.IncluiNoTotalAReceber;
                                    componentesCTe.Nome = componente.Nome;
                                    componentesCTe.Valor = componente.Valor;

                                    repComponentePrestacao.Inserir(componentesCTe);
                                }
                            }

                            cte.ValorPrestacaoServico = cteAnterior.ValorPrestacaoServico;
                            cte.ValorAReceber = cteAnterior.ValorAReceber;
                        }

                        if (seguros.Count > 0 && seguros[0].NomeSeguradora != null && seguros[0].NomeSeguradora != "")
                        {
                            foreach (Dominio.Entidades.SeguroCTE seguro in seguros)
                            {
                                Dominio.Entidades.SeguroCTE segurosCTe = new Dominio.Entidades.SeguroCTE();
                                segurosCTe.CTE = cte;
                                segurosCTe.Tipo = seguro.Tipo;
                                segurosCTe.NomeSeguradora = seguro.NomeSeguradora;
                                segurosCTe.CNPJSeguradora = seguro.CNPJSeguradora;
                                segurosCTe.NumeroApolice = seguro.NumeroApolice;
                                segurosCTe.NumeroAverbacao = string.Empty;
                                segurosCTe.Valor = 0;
                                repSeguro.Inserir(segurosCTe);
                            }
                        }
                        else this.SalvarInformacoesDeSeguroDaCarga(cte, unitOfWork);
                    }
                    else this.SalvarInformacoesDeSeguroDaCarga(cte, unitOfWork);
                }
                else this.SalvarInformacoesDeSeguroDaCarga(cte, unitOfWork);

            }

            return copiouInformacoes;
        }

        public void SalvarInformacoesDeSeguroDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.SeguroCTE repSeguro = new Repositorio.SeguroCTE(unitOfWork);
            Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();
            List<Dominio.Entidades.SeguroCTE> listaSeguros = repSeguro.BuscarPorCTe(conhecimento.Codigo);

            string tomador = conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Remetente ? conhecimento.Remetente.CPF_CNPJ : conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Destinatario ? conhecimento.Destinatario.CPF_CNPJ : "0";
            double cnpjTomador = 0;
            double.TryParse(tomador, out cnpjTomador);

            Repositorio.ApoliceDeSeguro repApoliceSeguro = new Repositorio.ApoliceDeSeguro(unitOfWork);
            List<Dominio.Entidades.ApoliceDeSeguro> listaApolices = repApoliceSeguro.BuscarPorCliente(conhecimento.Empresa.Codigo, conhecimento.Empresa.EmpresaPai != null ? conhecimento.Empresa.Codigo : 0, cnpjTomador);
            if (listaApolices.Count > 0)
            {
                if (listaSeguros.Count > 0)
                {
                    foreach (Dominio.Entidades.SeguroCTE seguroCte in listaSeguros)
                        repSeguro.Deletar(seguroCte);
                }

                Dominio.Enumeradores.TipoSeguro respSeguro = listaApolices[0].Responsavel == 0 ? Dominio.Enumeradores.TipoSeguro.Remetente :
                                                             listaApolices[0].Responsavel == 1 ? Dominio.Enumeradores.TipoSeguro.Expedidor :
                                                             listaApolices[0].Responsavel == 2 ? Dominio.Enumeradores.TipoSeguro.Recebedor :
                                                             listaApolices[0].Responsavel == 3 ? Dominio.Enumeradores.TipoSeguro.Destinatario :
                                                             listaApolices[0].Responsavel == 4 ? Dominio.Enumeradores.TipoSeguro.Emitente_CTE :
                                                             listaApolices[0].Responsavel == 5 ? Dominio.Enumeradores.TipoSeguro.Tomador_Servico :
                                                             Dominio.Enumeradores.TipoSeguro.Emitente_CTE;

                seguro.CTE = conhecimento;
                seguro.Tipo = respSeguro;
                seguro.NumeroApolice = listaApolices[0].NumeroApolice;
                seguro.NomeSeguradora = listaApolices[0].NomeSeguradora;
                seguro.CNPJSeguradora = listaApolices[0].CNPJSeguradora;

                repSeguro.Inserir(seguro);

                if (!string.IsNullOrWhiteSpace(listaApolices[0].CNPJResposavelNaObservacaoContribuinte))
                {
                    Repositorio.ObservacaoContribuinteCTE repObservacaoContribuinteCTE = new Repositorio.ObservacaoContribuinteCTE(unitOfWork);
                    Dominio.Entidades.ObservacaoContribuinteCTE obsCont = repObservacaoContribuinteCTE.BuscarPorCTeEIdentificacaoEDescricao(conhecimento.Codigo, "RESPSEG", listaApolices[0].CNPJResposavelNaObservacaoContribuinte);
                    if (obsCont == null)
                    {
                        obsCont = new Dominio.Entidades.ObservacaoContribuinteCTE();
                        obsCont.CTE = conhecimento;
                        obsCont.Identificador = "RESPSEG";
                        obsCont.Descricao = listaApolices[0].CNPJResposavelNaObservacaoContribuinte;
                        repObservacaoContribuinteCTE.Inserir(obsCont);
                    }
                }
            }
            else
            {
                if (listaSeguros.Count == 0)
                {
                    seguro.CTE = conhecimento;
                    seguro.Tipo = conhecimento.Empresa.Configuracao.ResponsavelSeguro != null ?
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Destinatario ? Dominio.Enumeradores.TipoSeguro.Destinatario :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Emitente_CTE ? Dominio.Enumeradores.TipoSeguro.Emitente_CTE :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Expedidor ? Dominio.Enumeradores.TipoSeguro.Expedidor :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Recebedor ? Dominio.Enumeradores.TipoSeguro.Recebedor :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Remetente ? Dominio.Enumeradores.TipoSeguro.Remetente :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Tomador_Servico ? Dominio.Enumeradores.TipoSeguro.Tomador_Servico : Dominio.Enumeradores.TipoSeguro.Emitente_CTE
                                  : Dominio.Enumeradores.TipoSeguro.Emitente_CTE;
                    if (conhecimento.Empresa.Configuracao.ApoliceSeguro != null && conhecimento.Empresa.Configuracao.ApoliceSeguro.Status == "A")
                    {
                        seguro.NumeroApolice = conhecimento.Empresa.Configuracao.ApoliceSeguro.NumeroApolice;
                        seguro.NomeSeguradora = conhecimento.Empresa.Configuracao.ApoliceSeguro.NomeSeguradora;
                        seguro.CNPJSeguradora = conhecimento.Empresa.Configuracao.ApoliceSeguro.CNPJSeguradora;

                        if (!string.IsNullOrWhiteSpace(conhecimento.Empresa.Configuracao.ApoliceSeguro.CNPJResposavelNaObservacaoContribuinte))
                        {
                            Repositorio.ObservacaoContribuinteCTE repObservacaoContribuinteCTE = new Repositorio.ObservacaoContribuinteCTE(unitOfWork);
                            Dominio.Entidades.ObservacaoContribuinteCTE obsCont = repObservacaoContribuinteCTE.BuscarPorCTeEIdentificacaoEDescricao(conhecimento.Codigo, "RESPSEG", listaApolices[0].CNPJResposavelNaObservacaoContribuinte);
                            if (obsCont == null)
                            {
                                obsCont = new Dominio.Entidades.ObservacaoContribuinteCTE();
                                obsCont.CTE = conhecimento;
                                obsCont.Identificador = "RESPSEG";
                                obsCont.Descricao = conhecimento.Empresa.Configuracao.ApoliceSeguro.CNPJResposavelNaObservacaoContribuinte;
                                repObservacaoContribuinteCTE.Inserir(obsCont);
                            }
                        }
                    }
                    repSeguro.Inserir(seguro);
                }
            }
        }

        public void BuscarApolicesSeguro(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, Dominio.Entidades.Empresa empresa, Repositorio.UnitOfWork unitOfWork, out Dominio.ObjetosDeValor.InformacaoSeguro seguro)
        {
            Repositorio.SeguroCTE repSeguro = new Repositorio.SeguroCTE(unitOfWork);
            List<Dominio.Entidades.SeguroCTE> listaSeguros = new List<Dominio.Entidades.SeguroCTE>();
            if (conhecimento != null)
                listaSeguros = repSeguro.BuscarPorCTe(conhecimento.Codigo);

            string tomador = conhecimento == null ? "0" : conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Remetente ? conhecimento.Remetente.CPF_CNPJ : conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Destinatario ? conhecimento.Destinatario.CPF_CNPJ : "0";
            double cnpjTomador = 0;
            double.TryParse(tomador, out cnpjTomador);

            seguro = new Dominio.ObjetosDeValor.InformacaoSeguro();
            seguro.Id = -1;
            seguro.Responsavel = Dominio.Enumeradores.TipoSeguro.Emitente_CTE;
            seguro.NumeroApolice = string.Empty;
            seguro.Seguradora = string.Empty;
            seguro.CNPJSeguradora = string.Empty;
            seguro.Excluir = false;

            Repositorio.ApoliceDeSeguro repApoliceSeguro = new Repositorio.ApoliceDeSeguro(unitOfWork);
            List<Dominio.Entidades.ApoliceDeSeguro> listaApolices = repApoliceSeguro.BuscarPorCliente(empresa.Codigo, empresa.EmpresaPai != null ? empresa.Codigo : 0, cnpjTomador);
            if (listaApolices.Count > 0)
            {
                if (listaSeguros.Count > 0)
                {
                    foreach (Dominio.Entidades.SeguroCTE seguroCte in listaSeguros)
                        repSeguro.Deletar(seguroCte);
                }

                seguro.Responsavel = listaApolices[0].Responsavel == 0 ? Dominio.Enumeradores.TipoSeguro.Remetente :
                             listaApolices[0].Responsavel == 1 ? Dominio.Enumeradores.TipoSeguro.Expedidor :
                             listaApolices[0].Responsavel == 2 ? Dominio.Enumeradores.TipoSeguro.Recebedor :
                             listaApolices[0].Responsavel == 3 ? Dominio.Enumeradores.TipoSeguro.Destinatario :
                             listaApolices[0].Responsavel == 4 ? Dominio.Enumeradores.TipoSeguro.Emitente_CTE :
                             listaApolices[0].Responsavel == 5 ? Dominio.Enumeradores.TipoSeguro.Tomador_Servico :
                             Dominio.Enumeradores.TipoSeguro.Emitente_CTE;

                seguro.DescricaoResponsavel = listaApolices[0].Responsavel == 0 ? "Remetente" :
                             listaApolices[0].Responsavel == 1 ? "Expedidor" :
                             listaApolices[0].Responsavel == 2 ? "Recebedor" :
                             listaApolices[0].Responsavel == 3 ? "Destinatario" :
                             listaApolices[0].Responsavel == 4 ? "Emitente" :
                             listaApolices[0].Responsavel == 5 ? "Tomador" :
                             "Emitente";

                seguro.NumeroApolice = listaApolices[0].NumeroApolice;
                seguro.Seguradora = listaApolices[0].NomeSeguradora;
                seguro.CNPJSeguradora = listaApolices[0].CNPJSeguradora;
            }
            else
            {
                if (listaSeguros.Count == 0)
                {
                    seguro.Responsavel = conhecimento.Empresa.Configuracao.ResponsavelSeguro != null ?
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Destinatario ? Dominio.Enumeradores.TipoSeguro.Destinatario :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Emitente_CTE ? Dominio.Enumeradores.TipoSeguro.Emitente_CTE :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Expedidor ? Dominio.Enumeradores.TipoSeguro.Expedidor :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Recebedor ? Dominio.Enumeradores.TipoSeguro.Recebedor :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Remetente ? Dominio.Enumeradores.TipoSeguro.Remetente :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Tomador_Servico ? Dominio.Enumeradores.TipoSeguro.Tomador_Servico : Dominio.Enumeradores.TipoSeguro.Emitente_CTE
                                  : Dominio.Enumeradores.TipoSeguro.Emitente_CTE;

                    seguro.DescricaoResponsavel = conhecimento.Empresa.Configuracao.ResponsavelSeguro != null ?
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Destinatario ? "Destinatario" :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Emitente_CTE ? "Emitente" :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Expedidor ? "Expedidor" :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Recebedor ? "Recebedor" :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Remetente ? "Remetente" :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Tomador_Servico ? "Tomador" : "Emitente"
                                  : "Emitente";
                    if (conhecimento.Empresa.Configuracao.ApoliceSeguro != null && conhecimento.Empresa.Configuracao.ApoliceSeguro.Status == "A")
                    {
                        seguro.NumeroApolice = conhecimento.Empresa.Configuracao.ApoliceSeguro.NumeroApolice;
                        seguro.Seguradora = conhecimento.Empresa.Configuracao.ApoliceSeguro.NomeSeguradora;
                        seguro.CNPJSeguradora = conhecimento.Empresa.Configuracao.ApoliceSeguro.CNPJSeguradora;
                    }
                }
            }
        }

        public static Dominio.Enumeradores.TipoICMS ObterEnumeradorICMS(string cst)
        {
            switch (cst)
            {
                case "91":
                    return Dominio.Enumeradores.TipoICMS.ICMS_Outras_Situacoes_90;
                case "90":
                    return Dominio.Enumeradores.TipoICMS.ICMS_Devido_A_UF_Origem_Prestação_Quando_Diferente_UF_Emitente_90;
                case "51":
                    return Dominio.Enumeradores.TipoICMS.ICMS_Diferido_51;
                case "40":
                    return Dominio.Enumeradores.TipoICMS.ICMS_Isencao_40;
                case "41":
                    return Dominio.Enumeradores.TipoICMS.ICMS_Nao_Tributado_41;
                case "00":
                    return Dominio.Enumeradores.TipoICMS.ICMS_Normal_00;
                case "60":
                    return Dominio.Enumeradores.TipoICMS.ICMS_Pagto_Atr_Tomador_3o_Previsto_Para_ST_60;
                case "20":
                    return Dominio.Enumeradores.TipoICMS.ICMS_Reducao_Base_Calculo_20;
                case "":
                    return Dominio.Enumeradores.TipoICMS.Simples_Nacional;
                default:
                    return 0;
            }
        }

        public bool AdicionarCTeNaFilaDeConsulta(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unitOfWork)
        {
            try
            {
                if (cte.SistemaEmissor != null && cte.SistemaEmissor != TipoEmissorDocumento.Integrador)
                    return true;

                string configWebServiceConsultaCTe = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoAmbiente().WebServiceConsultaCTe;
                if (configWebServiceConsultaCTe == null || configWebServiceConsultaCTe == "")
                    configWebServiceConsultaCTe = "http://localhost/CTe/";

                string postData = "CodigoCTe=" + cte.Codigo;
                byte[] bytes = Encoding.UTF8.GetBytes(postData);

                HttpWebRequest request = (HttpWebRequest)WebRequest.Create(string.Concat(configWebServiceConsultaCTe, "IntegracaoCTe/AdicionarNaFilaDeConsulta"));

                request.Method = "POST";
                request.ContentType = "application/x-www-form-urlencoded";
                request.ContentLength = bytes.Length;

                Stream requestStream = request.GetRequestStream();
                requestStream.Write(bytes, 0, bytes.Length);

                WebResponse response = request.GetResponse();

                Stream stream = response.GetResponseStream();

                StreamReader reader = new StreamReader(stream);
                string result = reader.ReadToEnd();

                stream.Dispose();
                reader.Dispose();

                Dictionary<string, object> retorno = JsonConvert.DeserializeObject<Dictionary<string, object>>(result);

                return (bool)retorno["Sucesso"];
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Problemas ao adicionar na fila: " + ex);
                return false;
            }
        }

        public int GerarCargaCTe(int codigoCTeIntegrado, string numeroUnidade, string numeroCarga, string tipoVeiculo, string tipoCarga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacaoCarga, string stringConexao, Repositorio.UnitOfWork unitOfWork)
        {
            int cargaCodigo = 0;
            try
            {
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
                Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);

                Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = repConfiguracaoTMS.BuscarConfiguracaoPadrao();
                Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorCodigo(codigoCTeIntegrado);

                AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServico = AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador;

                Dominio.ObjetosDeValor.WebService.Carga.CargaIntegracao cargaIntegracao = this.ConverterCTeEmCargaIntegracao(cte, numeroUnidade, numeroCarga, unitOfWork);

                Servicos.Embarcador.Hubs.Carga servicoHubCarga = new Servicos.Embarcador.Hubs.Carga();
                Servicos.Embarcador.Carga.Carga servicoCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);

                if (cargaIntegracao != null)
                {
                    //unidadeDeTrabalho.Start();

                    Repositorio.Embarcador.Cargas.ModeloVeicularCarga repModeloVeicularCarga = new Repositorio.Embarcador.Cargas.ModeloVeicularCarga(unitOfWork);
                    Dominio.Entidades.Embarcador.Cargas.ModeloVeicularCarga modeloVeicular = repModeloVeicularCarga.buscarPorCodigoIntegracao(!string.IsNullOrWhiteSpace(tipoVeiculo) ? tipoVeiculo : "NaoInformado");
                    if (modeloVeicular == null)
                    {
                        modeloVeicular = new Dominio.Entidades.Embarcador.Cargas.ModeloVeicularCarga();

                        string descricaoModeloVeicular = "Cadastrado pelo Envio do CTe";

                        modeloVeicular.CodigoIntegracao = !string.IsNullOrWhiteSpace(tipoVeiculo) ? tipoVeiculo : "NaoInformado";
                        modeloVeicular.Descricao = descricaoModeloVeicular;
                        modeloVeicular.Ativo = true;
                        modeloVeicular.CapacidadePesoTransporte = 1;
                        modeloVeicular.ToleranciaPesoExtra = 1;
                        modeloVeicular.VeiculoPaletizado = true;
                        modeloVeicular.NumeroEixos = 0;
                        modeloVeicular.Tipo = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModeloVeicularCarga.Geral;
                        modeloVeicular.Cubagem = 1;
                        repModeloVeicularCarga.Inserir(modeloVeicular);
                    }

                    cargaIntegracao.ModeloVeicular = new Dominio.ObjetosDeValor.Embarcador.Carga.ModeloVeicular() { CodigoIntegracao = !String.IsNullOrWhiteSpace(tipoVeiculo) ? tipoVeiculo : "NaoInformado" };
                    cargaIntegracao.TipoCargaEmbarcador = new Dominio.ObjetosDeValor.Embarcador.Carga.TipoCargaEmbarcador { CodigoIntegracao = tipoCarga };
                    if (configuracaoTMS?.TipoOperacaoPadraoCargaDistribuidor != null)
                        cargaIntegracao.TipoOperacao = new Dominio.ObjetosDeValor.Embarcador.Carga.TipoOperacao { CodigoIntegracao = configuracaoTMS.TipoOperacaoPadraoCargaDistribuidor.CodigoIntegracao };

                    Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unitOfWork);
                    Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unitOfWork);
                    Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unitOfWork);
                    Repositorio.Embarcador.Cargas.CargaPedido repCargaPedido = new Repositorio.Embarcador.Cargas.CargaPedido(unitOfWork);
                    Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unitOfWork);
                    Repositorio.Embarcador.Cargas.CargaCTe repCargaCTe = new Repositorio.Embarcador.Cargas.CargaCTe(unitOfWork);
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unitOfWork);
                    Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
                    Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe repCargaPedidoXMLNotaFiscalCTe = new Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe(unitOfWork);
                    Repositorio.DocumentosCTE repDocumentoCTE = new Repositorio.DocumentosCTE(unitOfWork);
                    Repositorio.Embarcador.Filiais.Filial repFilial = new Repositorio.Embarcador.Filiais.Filial(unitOfWork);
                    Repositorio.Embarcador.Pedidos.TipoOperacao repTipoOperacao = new Repositorio.Embarcador.Pedidos.TipoOperacao(unitOfWork);
                    Repositorio.Usuario repMotorista = new Repositorio.Usuario(unitOfWork);

                    Dominio.Entidades.Embarcador.Filiais.Filial filial = null;
                    if (cargaIntegracao.Filial != null)
                        filial = repFilial.buscarPorCodigoEmbarcador(cargaIntegracao.Filial.CodigoIntegracao);

                    Servicos.WebService.Carga.Pedido serPedidoWS = new Servicos.WebService.Carga.Pedido(unitOfWork);
                    Servicos.WebService.Carga.Carga serCargaWS = new Servicos.WebService.Carga.Carga(unitOfWork);
                    Servicos.WebService.Carga.ProdutosPedido serProdutoPedidoWS = new Servicos.WebService.Carga.ProdutosPedido(unitOfWork);

                    bool naoUtilizarCNPJTransportador = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoAmbiente().NaoUtilizarCNPJTransportador.HasValue && Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoAmbiente().NaoUtilizarCNPJTransportador.Value; //Parametro para buscar as cargas do GPA por Filial sem transportador, VIGOR usa por transportador                   
                    int.TryParse(cargaIntegracao.NumeroCarga, out int numeroCargaSequencial);

                    Dominio.Entidades.Embarcador.Cargas.Carga carga = null;
                    if (!naoUtilizarCNPJTransportador)
                        carga = repCarga.BuscarPorCodigoCargaEmbarcador(cargaIntegracao.NumeroCarga, filial?.Codigo ?? 0, naoUtilizarCNPJTransportador ? "" : cte.Empresa.CNPJ, "", false, false);
                    else if (configuracaoTMS?.TipoOperacaoPadraoCargaDistribuidor != null) //Busca cargas que não estão com o tipo de operação padrão (Casos do GPA onde cargas da Fila são enviadas via integração e deve-se apenas vincular os CTes)
                        carga = repCarga.BuscarPorCodigoCargaEmbarcadorETipoOperacaoDiferente(cargaIntegracao.NumeroCarga, filial?.Codigo ?? 0, configuracaoTMS.TipoOperacaoPadraoCargaDistribuidor.Codigo);

                    if (carga == null)
                    {
                        Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacao = (cargaIntegracao.TipoOperacao != null) ? repTipoOperacao.BuscarPorCodigoIntegracao(cargaIntegracao.TipoOperacao.CodigoIntegracao) : null;

                        unitOfWork.Start();

                        StringBuilder stMensagem = new StringBuilder();
                        int codigoCargaExistente = 0;
                        int protocoloPedidoExistente = 0;

                        Dominio.Entidades.Embarcador.Pedidos.Pedido pedido = serPedidoWS.CriarPedido(cargaIntegracao, filial, tipoOperacao, ref stMensagem, tipoServico, ref protocoloPedidoExistente, ref codigoCargaExistente, true);
                        //int cargaCodigo = 0;
                        if (stMensagem.Length == 0 || protocoloPedidoExistente > 0)
                        {
                            serProdutoPedidoWS.AdicionarProdutosPedido(pedido, configuracaoTMS, cargaIntegracao, ref stMensagem, unitOfWork);
                            Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido = serCargaWS.CriarCarga(pedido, cargaIntegracao, ref protocoloPedidoExistente, ref stMensagem, ref codigoCargaExistente, unitOfWork, tipoServico, true, true, null, configuracaoTMS, null, "", filial, tipoOperacao, validarTipoOperacaoMunicipal: false, cargaRecebidaDeintegracao: false, retornarCargaPedidoEncontrado: true);
                            int codCarga = cargaPedido != null ? cargaPedido.Carga.Codigo : 0;

                            if (cargaPedido != null)
                            {
                                serCargaWS.AdicionarProdutosCarga(cargaPedido, cargaIntegracao, ref stMensagem, unitOfWork, configuracaoTMS.UsarPesoProdutoSumarizacaoCarga);

                                if (cargaIntegracao.FecharCargaAutomaticamente && situacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.PendeciaDocumentos)
                                {
                                    //Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);
                                    //serCarga.FecharCarga(cargaPedido.Carga, unidadeDeTrabalho, tipoServico);
                                    cargaPedido.Carga.CargaFechada = true;
                                    Servicos.Log.TratarErro("15 - Fechou Carga (" + cargaPedido.Carga.Codigo + ") " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "FechamentoCarga");
                                    repCarga.Atualizar(cargaPedido.Carga);
                                }
                                cargaCodigo = cargaPedido.Carga.Codigo;
                                List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(cargaCodigo);

                                int countPedidos = repPedidoXMLNotaFiscal.BuscarPorCargaPedido(cargaPedido.Codigo).Count();
                                if (countPedidos == 0)
                                    this.AdicionarCTeNaCarga(cte, cargaIntegracao, cargaPedido.Carga, cargaPedido, unitOfWork);

                                int sequenciaNumeroCarga = 0;
                                //int.TryParse(numeroCarga, out sequenciaNumeroCarga);
                                cargaPedido.Carga.NumeroSequenciaCarga = sequenciaNumeroCarga;

                                cargaPedido.Carga.Empresa = cte.Empresa;
                                Servicos.Embarcador.Carga.RateioFrete serRateioFrete = new Servicos.Embarcador.Carga.RateioFrete(unitOfWork);


                                serRateioFrete.RatearFreteEntrePedidos(cargaPedido.Carga, cargaPedidos, configuracaoTMS, cte.ValorAReceber, false, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador, unitOfWork);

                                cargaPedido.Carga.TipoFreteEscolhido = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Embarcador;
                                cargaPedido.Carga.ValorFrete = cte.ValorAReceber;
                                cargaPedido.Carga.ValorICMS = cte.ValorICMS;
                                cargaPedido.Carga.SituacaoCarga = situacaoCarga;
                                if (situacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.PendeciaDocumentos)
                                {
                                    cargaPedido.Carga.EmitindoCTes = true;
                                    cargaPedido.Carga.PossuiPendencia = true;
                                    cargaPedido.Carga.AgImportacaoCTe = true;
                                }

                                if (cargaPedido.Carga.Veiculo?.Tipo == "T")
                                    cargaPedido.Carga.FreteDeTerceiro = true;
                                else if (cargaPedido.Carga.ProvedorOS != null)
                                    cargaPedido.Carga.FreteDeTerceiro = true;

                                repCarga.Atualizar(cargaPedido.Carga);

                                cargaPedido.ValorFrete = cte.ValorAReceber;
                                cargaPedido.BaseCalculoICMS = cte.BaseCalculoICMS;
                                cargaPedido.ValorICMS = cte.ValorICMS;
                                cargaPedido.PercentualAliquota = cte.AliquotaICMS;
                                cargaPedido.IncluirICMSBaseCalculo = cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim || cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFSe;
                                //TODO: PPC - Adicionado log temporário para identificar problema no cargaPedido.Peso.
                                Servicos.Log.TratarErro($"Pedido {cargaPedido.Pedido.NumeroPedidoEmbarcador} - CargaPedido.Codigo = {cargaPedido.Codigo} - Peso Total De.: {cargaPedido.Peso} - Para.: {cargaIntegracao.PesoBruto}. CTe.GerarCargaCTe - 1", "PesoCargaPedido");
                                cargaPedido.Peso = cargaIntegracao.PesoBruto;
                                cargaPedido.PesoLiquido = cargaIntegracao.PesoLiquido;
                                repCargaPedido.Atualizar(cargaPedido);

                                Servicos.Log.TratarErro($"9 - CargaPedido: {cargaPedido.Codigo} -> Aliquota: {cargaPedido.PercentualAliquota}", "ProcessarAliquota");

                                if (cargaPedido.Carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte)
                                {
                                    new Servicos.Embarcador.SuperApp.IntegracaoNotificacaoApp(unitOfWork).GerarIntegracaoNotificacao(cargaPedido.Carga, TipoNotificacaoApp.MotoristaPodeSeguirViagem);
                                    if (configuracaoTMS.QuandoIniciarMonitoramento == Dominio.ObjetosDeValor.Embarcador.Enumeradores.QuandoIniciarMonitoramento.AoInformarVeiculoNaCargaECargaEmTransporte)
                                        Servicos.Embarcador.Monitoramento.Monitoramento.GerarMonitoramentoEIniciar(cargaPedido.Carga, configuracaoTMS, null, "Carga em transporte", unitOfWork);
                                }

                                //Adicionado no fechamento da carga
                                //Servicos.Embarcador.Carga.FreteSubcontratacaoTerceiro svcFreteSubcontratacaoTerceiro = new Servicos.Embarcador.Carga.FreteSubcontratacaoTerceiro();
                                //svcFreteSubcontratacaoTerceiro.CalcularFreteSubcontratacao(cargaPedido.Carga, cargaPedido.Carga.TipoFreteEscolhido, unidadeDeTrabalho, false, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador, "");
                                //string retornoCIOT = Servicos.Embarcador.CIOT.CIOT.ObterCIOTCarga(cargaPedido.Carga, configuracaoTMS, unidadeDeTrabalho);
                            }
                        }

                        if (stMensagem.Length > 0)
                        {
                            Servicos.Log.TratarErro("Carga: " + cargaIntegracao.NumeroCarga + " Retornou essa mensagem: " + stMensagem.ToString());
                            unitOfWork.Rollback();
                            if (codigoCargaExistente > 0 || protocoloPedidoExistente > 0)
                            {
                                Servicos.Log.TratarErro("Carga: " + cargaIntegracao.NumeroCarga + " já existente. Código carga: " + codigoCargaExistente + " Protocolo Pedido: " + protocoloPedidoExistente);
                            }
                        }
                        else
                        {
                            unitOfWork.CommitChanges();

                            Servicos.Log.TratarErro("Carga: " + cargaIntegracao.NumeroCarga + " gerada com sucesso. Código carga: " + cargaCodigo + " Protocolo Pedido: " + pedido.Codigo);
                        }
                    }
                    else
                    {
                        cargaCodigo = carga.Codigo;
                        if (carga.Empresa == null && cargaIntegracao.TransportadoraEmitente != null && !string.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(cargaIntegracao.TransportadoraEmitente.CNPJ)))
                        {
                            carga.Empresa = repEmpresa.BuscarPorCNPJ(Utilidades.String.OnlyNumbers(cargaIntegracao.TransportadoraEmitente.CNPJ));
                            repCarga.Atualizar(carga);
                        }
                        if (carga.Veiculo == null && cargaIntegracao.Veiculo != null && !string.IsNullOrWhiteSpace(cargaIntegracao.Veiculo.Placa.Replace("-", "")))
                        {
                            Dominio.Entidades.Veiculo veiculo = repVeiculo.BuscarPorPlacaVarrendoFiliais(carga.Empresa.Codigo, cargaIntegracao.Veiculo.Placa.Replace("-", ""));
                            if (veiculo != null)
                            {
                                carga.Veiculo = veiculo;
                                repCarga.Atualizar(carga);
                            }
                        }

                        if (carga.Motoristas?.Count == 0 && cargaIntegracao.Motoristas?.Count > 0)
                        {
                            Dominio.Entidades.Usuario motoristaCTe = repMotorista.BuscarMotoristaPorCPFEEmpresa(cargaIntegracao.Motoristas.FirstOrDefault().CPF, carga.Empresa.Codigo);
                            if (motoristaCTe != null)
                            {
                                carga.Motoristas.Add(motoristaCTe);
                                repCarga.Atualizar(carga);
                            }
                        }

                        if (carga.Veiculo?.Tipo == "T")
                            carga.FreteDeTerceiro = true;
                        else if (carga.ProvedorOS != null)
                            carga.FreteDeTerceiro = true;

                        Repositorio.Embarcador.Cargas.CargaJanelaCarregamento repCargaJanelaCarregamento = new Repositorio.Embarcador.Cargas.CargaJanelaCarregamento(unitOfWork);
                        Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento cargaJanelaCarregamento = repCargaJanelaCarregamento.BuscarPorCarga(carga.Codigo);
                        if (
                            cargaJanelaCarregamento != null &&
                            (
                                cargaJanelaCarregamento.Situacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCargaJanelaCarregamento.AgAceiteTransportador ||
                                cargaJanelaCarregamento.Situacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCargaJanelaCarregamento.AgConfirmacaoTransportador ||
                                cargaJanelaCarregamento.Situacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCargaJanelaCarregamento.SemTransportador ||
                                cargaJanelaCarregamento.Situacao == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCargaJanelaCarregamento.AgEncosta
                            )
                        )
                        {
                            Servicos.Embarcador.Logistica.CargaJanelaCarregamento servicoCargaJanelaCarregamento = new Servicos.Embarcador.Logistica.CargaJanelaCarregamento(unitOfWork);

                            servicoCargaJanelaCarregamento.AlterarSituacao(cargaJanelaCarregamento, SituacaoCargaJanelaCarregamento.ProntaParaCarregamento);
                        }

                        Dominio.Entidades.Embarcador.Cargas.CargaCTe cargaCTe = repCargaCTe.BuscarPorCTeECarga(cte.Codigo, carga.Codigo);
                        if (cargaCTe == null)
                        {
                            List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> listaCargaPedido = repCargaPedido.BuscarPorCarga(carga.Codigo);

                            if (listaCargaPedido != null && listaCargaPedido.Count > 0)
                            {
                                unitOfWork.Start();

                                this.AdicionarCTeNaCarga(cte, cargaIntegracao, carga, listaCargaPedido.FirstOrDefault(), unitOfWork);


                                Servicos.Embarcador.Carga.RateioFrete serRateioFrete = new Servicos.Embarcador.Carga.RateioFrete(unitOfWork);
                                if (listaCargaPedido != null && listaCargaPedido.Count < 100)
                                    serRateioFrete.RatearFreteEntrePedidos(listaCargaPedido.FirstOrDefault().Carga, listaCargaPedido, configuracaoTMS, cte.ValorAReceber, false, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador, unitOfWork);

                                carga.ValorFreteAPagar += cte.ValorAReceber;
                                carga.ValorFrete += cte.ValorAReceber;
                                carga.ValorICMS = cte.ValorICMS;
                                if (situacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.PendeciaDocumentos)
                                {
                                    carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada;
                                    carga = servicoCarga.AtualizarStatusCustoExtra(carga, servicoHubCarga, repCarga);
                                    carga.DataEncerramentoCarga = DateTime.Now;
                                    Servicos.Auditoria.Auditoria.Auditar(new Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado { OrigemAuditado = Dominio.ObjetosDeValor.Enumerador.OrigemAuditado.Sistema, TipoAuditado = Dominio.ObjetosDeValor.Enumerador.TipoAuditado.Sistema }, carga, $"Alterou carga para situação {Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada.ObterDescricao()}", unitOfWork);
                                }
                                repCarga.Atualizar(carga);

                                Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido = listaCargaPedido.FirstOrDefault();

                                cargaPedido.ValorFreteAPagar += cte.ValorAReceber;
                                cargaPedido.ValorFrete += cte.ValorAReceber;
                                cargaPedido.BaseCalculoICMS += cte.BaseCalculoICMS;
                                cargaPedido.ValorICMS += cte.ValorICMS;
                                cargaPedido.IncluirICMSBaseCalculo = cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim || cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFSe;
                                //TODO: PPC - Adicionado log temporário para identificar problema no cargaPedido.Peso.
                                Servicos.Log.TratarErro($"Pedido {cargaPedido.Pedido.NumeroPedidoEmbarcador} - CargaPedido.Codigo = {cargaPedido.Codigo} - Peso Total De.: {cargaPedido.Peso} - Para.: {cargaPedido.Peso + cargaIntegracao.PesoBruto}. CTe.GerarCargaCTe - 2", "PesoCargaPedido");
                                cargaPedido.Peso += cargaIntegracao.PesoBruto;
                                cargaPedido.PesoLiquido += cargaIntegracao.PesoLiquido;

                                repCargaPedido.Atualizar(cargaPedido);

                                unitOfWork.CommitChanges();
                            }
                            else
                            {
                                StringBuilder stMensagem = new StringBuilder();
                                int codigoCargaExistente = 0;
                                int protocoloPedidoExistente = 0;
                                Dominio.Entidades.Embarcador.Pedidos.TipoOperacao tipoOperacao = (cargaIntegracao.TipoOperacao != null) ? repTipoOperacao.BuscarPorCodigoIntegracao(cargaIntegracao.TipoOperacao.CodigoIntegracao) : null;

                                Dominio.Entidades.Embarcador.Pedidos.Pedido pedido = serPedidoWS.CriarPedido(cargaIntegracao, filial, tipoOperacao, ref stMensagem, tipoServico, ref protocoloPedidoExistente, ref codigoCargaExistente, true);
                                //int cargaCodigo = 0;
                                if (stMensagem.Length == 0 || protocoloPedidoExistente > 0)
                                {
                                    serProdutoPedidoWS.AdicionarProdutosPedido(pedido, configuracaoTMS, cargaIntegracao, ref stMensagem, unitOfWork);
                                    Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido = serCargaWS.CriarCarga(pedido, cargaIntegracao, ref protocoloPedidoExistente, ref stMensagem, ref codigoCargaExistente, unitOfWork, tipoServico, true, true, null, configuracaoTMS, null, "", filial, tipoOperacao);
                                    int codCarga = cargaPedido != null ? cargaPedido.Carga.Codigo : 0;

                                    if (cargaPedido != null)
                                    {
                                        serCargaWS.AdicionarProdutosCarga(cargaPedido, cargaIntegracao, ref stMensagem, unitOfWork, configuracaoTMS.UsarPesoProdutoSumarizacaoCarga);

                                        if (cargaIntegracao.FecharCargaAutomaticamente && situacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.PendeciaDocumentos)
                                        {
                                            //Servicos.Embarcador.Carga.Carga serCarga = new Servicos.Embarcador.Carga.Carga(unitOfWork);
                                            //serCarga.FecharCarga(cargaPedido.Carga, unidadeDeTrabalho, tipoServico);
                                            cargaPedido.Carga.CargaFechada = true;
                                            Servicos.Log.TratarErro("16 - Fechou Carga (" + cargaPedido.Carga.Codigo + ") " + DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss.fff"), "FechamentoCarga");
                                            repCarga.Atualizar(cargaPedido.Carga);
                                        }
                                        cargaCodigo = cargaPedido.Carga.Codigo;
                                        List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> cargaPedidos = repCargaPedido.BuscarPorCarga(cargaCodigo);
                                        int countPedidos = repPedidoXMLNotaFiscal.BuscarPorCargaPedido(cargaPedido.Codigo).Count();
                                        if (countPedidos == 0)
                                            this.AdicionarCTeNaCarga(cte, cargaIntegracao, cargaPedido.Carga, cargaPedido, unitOfWork);

                                        int sequenciaCarga = 0;
                                        int.TryParse(numeroCarga, out sequenciaCarga);
                                        cargaPedido.Carga.NumeroSequenciaCarga = sequenciaCarga;
                                        cargaPedido.Carga.Empresa = cte.Empresa;

                                        Servicos.Embarcador.Carga.RateioFrete serRateioFrete = new Servicos.Embarcador.Carga.RateioFrete(unitOfWork);
                                        serRateioFrete.RatearFreteEntrePedidos(cargaPedido.Carga, cargaPedidos, configuracaoTMS, cte.ValorAReceber, false, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador, unitOfWork);

                                        cargaPedido.Carga.TipoFreteEscolhido = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Embarcador;
                                        cargaPedido.Carga.ValorFreteAPagar = cte.ValorAReceber;
                                        cargaPedido.Carga.ValorFrete = cte.ValorAReceber;
                                        cargaPedido.Carga.ValorICMS = cte.ValorICMS;
                                        if (situacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.PendeciaDocumentos)
                                        {
                                            cargaPedido.Carga.SituacaoCarga = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte;
                                            cargaPedido.Carga = servicoCarga.AtualizarStatusCustoExtra(cargaPedido.Carga, servicoHubCarga, repCarga);
                                            cargaPedido.Carga.DataMudouSituacaoParaEmTransporte = DateTime.Now;
                                            Servicos.Auditoria.Auditoria.Auditar(new Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado { OrigemAuditado = Dominio.ObjetosDeValor.Enumerador.OrigemAuditado.Sistema, TipoAuditado = Dominio.ObjetosDeValor.Enumerador.TipoAuditado.Sistema }, carga, $"Alterou carga para situação {Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte.ObterDescricao()}", unitOfWork);
                                        }
                                        repCarga.Atualizar(cargaPedido.Carga);

                                        cargaPedido.ValorFreteAPagar = cte.ValorAReceber;
                                        cargaPedido.ValorFrete = cte.ValorAReceber;
                                        cargaPedido.BaseCalculoICMS = cte.BaseCalculoICMS;
                                        cargaPedido.ValorICMS = cte.ValorICMS;
                                        cargaPedido.PercentualAliquota = cte.AliquotaICMS;
                                        cargaPedido.IncluirICMSBaseCalculo = cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim || cte.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFSe;
                                        //TODO: PPC - Adicionado log temporário para identificar problema no cargaPedido.Peso.
                                        Servicos.Log.TratarErro($"Pedido {cargaPedido.Pedido.NumeroPedidoEmbarcador} - CargaPedido.Codigo = {cargaPedido.Codigo} - Peso Total De.: {cargaPedido.Peso} - Para.: {cargaIntegracao.PesoBruto}. CTe.GerarCargaCTe - 3", "PesoCargaPedido");
                                        cargaPedido.Peso = cargaIntegracao.PesoBruto;
                                        cargaPedido.PesoLiquido = cargaIntegracao.PesoLiquido;
                                        repCargaPedido.Atualizar(cargaPedido);

                                        Servicos.Log.TratarErro($"10 - CargaPedido: {cargaPedido.Codigo} -> Aliquota: {cargaPedido.PercentualAliquota}", "ProcessarAliquota");

                                        if (cargaPedido.Carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte)
                                        {
                                            new Servicos.Embarcador.SuperApp.IntegracaoNotificacaoApp(unitOfWork).GerarIntegracaoNotificacao(carga, TipoNotificacaoApp.MotoristaPodeSeguirViagem);
                                            if (configuracaoTMS.QuandoIniciarMonitoramento == Dominio.ObjetosDeValor.Embarcador.Enumeradores.QuandoIniciarMonitoramento.AoInformarVeiculoNaCargaECargaEmTransporte)
                                                Servicos.Embarcador.Monitoramento.Monitoramento.GerarMonitoramentoEIniciar(carga, configuracaoTMS, null, "Carga em transporte", unitOfWork);
                                        }

                                    }
                                }

                                if (stMensagem.Length > 0)
                                {
                                    Servicos.Log.TratarErro("Carga: " + cargaIntegracao.NumeroCarga + " Retornou essa mensagem: " + stMensagem.ToString());
                                    unitOfWork.Rollback();
                                    if (codigoCargaExistente > 0 || protocoloPedidoExistente > 0)
                                    {
                                        Servicos.Log.TratarErro("Carga: " + cargaIntegracao.NumeroCarga + " já existente. Código carga: " + codigoCargaExistente + " Protocolo Pedido: " + protocoloPedidoExistente);
                                    }
                                }
                                else
                                {
                                    unitOfWork.CommitChanges();

                                    Servicos.Log.TratarErro("Carga: " + cargaIntegracao.NumeroCarga + " gerada com sucesso. Código carga: " + cargaCodigo + " Protocolo Pedido: " + pedido.Codigo);
                                }


                            }
                        }

                        Servicos.Log.TratarErro("Carga: " + cargaIntegracao.NumeroCarga + " gerada com mesmo número já inserida. Código carga: " + carga.Codigo);
                    }
                }
                else
                {
                    Servicos.Log.TratarErro("Não foi possível converter CTe para carga.");
                    return cargaCodigo;
                }
                return cargaCodigo;
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Carga integração não gerada");
                Servicos.Log.TratarErro(ex);
                if (unitOfWork != null)
                    unitOfWork.Rollback();
                return 0;
            }
        }

        public void AtualizarValoresCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.Embarcador.Cargas.Carga repCarga = new Repositorio.Embarcador.Cargas.Carga(unidadeDeTrabalho);
            Repositorio.Embarcador.Cargas.CargaCTe repCargaCTe = new Repositorio.Embarcador.Cargas.CargaCTe(unidadeDeTrabalho);

            carga.TabelaFrete = null;
            carga.TipoFreteEscolhido = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoFreteEscolhido.Embarcador;
            carga.ValorFreteLiquido = 0m;
            carga.ValorFrete = 0m;
            carga.ValorFreteAPagar = 0m;
            carga.ValorICMS = 0m;
            carga.ValorISS = 0m;
            carga.ValorRetencaoISS = 0m;
            carga.ValorIBSEstadual = 0m;
            carga.ValorIBSMunicipal = 0m;
            carga.ValorCBS = 0m;

            List<Dominio.Entidades.Embarcador.Cargas.CargaCTe> listaCargaCTes = repCargaCTe.BuscarPorCarga(carga.Codigo);
            foreach (Dominio.Entidades.Embarcador.Cargas.CargaCTe cargaCTe in listaCargaCTes)
            {
                carga.ValorFrete += cargaCTe.CTe.ValorFrete;
                carga.ValorFreteAPagar += cargaCTe.CTe.ValorAReceber;
                carga.ValorICMS += cargaCTe.CTe.ValorICMS;
                carga.ValorISS += cargaCTe.CTe.ValorISS;
                carga.ValorRetencaoISS += cargaCTe.CTe.ValorISSRetido;
                carga.ValorIBSEstadual += cargaCTe.CTe.ValorIBSEstadual;
                carga.ValorIBSMunicipal += cargaCTe.CTe.ValorIBSMunicipal;
                carga.ValorCBS += cargaCTe.CTe.ValorCBS;
            }

            carga.ValorFreteLiquido = carga.ValorFreteAPagar - carga.ValorICMS - carga.ValorISS;// carga.ValorFrete; //Tarefa 5296

            repCarga.Atualizar(carga);
        }

        public string RegerarDACTE(int codigoCTe, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorCodigo(codigoCTe);
            if (cte != null)
            {
                ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unitOfWork).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);

                ServicoCTe.ResultadoString retorno = svcCTe.RegerarDacte(cte.CodigoCTeIntegrador);
                if (retorno.Info.Tipo == "OK")
                    return string.Empty;
                else
                    return retorno.Info.Mensagem;
            }
            return "CTe não localizado.";
        }

        public bool IntegrareCTeOracle(Dominio.Entidades.Empresa empresa, int codigoCTe, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorCodigo(codigoCTe);

            try
            {
                byte[] data = ObterXMLAutorizacao(cte, unitOfWork);
                Stream xml = new MemoryStream(data);

                this.TransmitirCTeAnterior(empresa != null ? empresa : cte.Empresa, ref cte, xml, unitOfWork);

                return true;
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro(ex);

                return false;
            }
        }

        public object IntegrareCTeCanceladoOracle(Dominio.Entidades.Empresa empresa, int codigoCTe, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorCodigo(codigoCTe);

            try
            {
                Stream xml = new MemoryStream(Encoding.UTF8.GetBytes(cte.XMLs.Count > 0 ? cte.XMLs.Where(o => o.Tipo == Dominio.Enumeradores.TipoXMLCTe.Cancelamento).FirstOrDefault().XML ?? "" : ""));

                this.TransmitirCancelamentoCTeAnterior(empresa != null ? empresa : cte.Empresa, cte, xml, unitOfWork);

                return true;
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro(ex);

                return false;
            }
        }

        public Dominio.ObjetosDeValor.CTe.CTe ConverteObjetoCTeNFSe(Dominio.ObjetosDeValor.CTe.CTeNFSe cteNFSe)
        {
            Dominio.ObjetosDeValor.CTe.CTe cte = new Dominio.ObjetosDeValor.CTe.CTe();

            cte.CaracteristicaServico = cteNFSe.CaracteristicaServico;
            cte.CaracteristicaTransporte = cteNFSe.CaracteristicaTransporte;
            cte.CFOP = cteNFSe.CFOP;
            cte.ChaveCTESubstituicaoComplementar = cteNFSe.ChaveCTESubstituicaoComplementar;
            cte.SubstituicaoTomador = cteNFSe.SubstituicaoTomador;
            cte.CIOT = cteNFSe.CIOT;
            cte.ClienteEntrega = cteNFSe.ClienteEntrega;
            cte.ClienteRetira = cteNFSe.ClienteRetira;
            cte.CodigoControleInternoCliente = cteNFSe.CodigoControleInternoCliente;
            cte.CodigoIBGECidadeInicioPrestacao = cteNFSe.CodigoIBGECidadeInicioPrestacao;
            cte.CodigoIBGECidadeTerminoPrestacao = cteNFSe.CodigoIBGECidadeTerminoPrestacao;
            cte.CodigoTabelaFreteIntegracao = cteNFSe.CodigoTabelaFreteIntegracao;
            cte.COFINS = cteNFSe.COFINS;
            cte.ComponentesDaPrestacao = cteNFSe.ComponentesDaPrestacao;
            cte.Container = cteNFSe.Container;
            cte.DataAnulacao = cteNFSe.DataAnulacao;
            cte.DataEmissao = cteNFSe.DataEmissao;
            cte.DataPrevistaContainer = cteNFSe.DataPrevistaContainer;
            cte.DataPrevistaEntrega = cteNFSe.DataPrevistaEntrega;
            cte.Destinatario = cteNFSe.Destinatario;
            cte.DetalhesRetira = cteNFSe.DetalhesRetira;
            cte.Documentos = cteNFSe.Documentos;
            cte.DocumentosTransporteAnteriores = cteNFSe.DocumentosTransporteAnteriores;
            cte.Emitente = cteNFSe.Emitente;
            cte.ExibeICMSNaDACTE = cteNFSe.ExibeICMSNaDACTE;
            cte.Expedidor = cteNFSe.Expedidor;
            cte.ICMS = cteNFSe.ICMS;
            cte.IncluirICMSNoFrete = cteNFSe.IncluirICMSNoFrete;
            cte.indicadorGlobalizado = cteNFSe.indicadorGlobalizado;
            cte.indicadorIETomador = cteNFSe.indicadorIETomador;
            cte.LacreContainer = cteNFSe.LacreContainer;
            cte.Lotacao = cteNFSe.Lotacao;
            cte.Motoristas = cteNFSe.Motoristas;
            cte.NumeroCarga = cteNFSe.NumeroCarga;
            cte.NumeroUnidade = cteNFSe.NumeroUnidade;
            cte.ObservacaoDaCarga = cteNFSe.ObservacaoDaCarga;
            cte.ObservacoesContribuinte = cteNFSe.ObservacoesContribuinte;
            cte.ObservacoesFisco = cteNFSe.ObservacoesFisco;
            cte.ObservacoesGerais = cteNFSe.ObservacoesGerais;
            cte.OutrasCaracteristicasDaCarga = cteNFSe.OutrasCaracteristicasDaCarga;
            cte.PercentualICMSIncluirNoFrete = cteNFSe.PercentualICMSIncluirNoFrete;
            cte.PIS = cteNFSe.PIS;
            cte.ProdutoPredominante = cteNFSe.ProdutoPredominante;
            cte.ProdutosPerigosos = cteNFSe.ProdutosPerigosos;
            cte.QuantidadesCarga = cteNFSe.QuantidadesCarga;
            cte.Recebedor = cteNFSe.Recebedor;
            cte.Remetente = cteNFSe.Remetente;
            cte.Retira = cteNFSe.Retira;
            cte.Seguros = cteNFSe.Seguros;
            cte.Serie = cteNFSe.Serie;
            cte.TipoCTe = cteNFSe.TipoCTe;
            cte.TipoImpressao = cteNFSe.TipoImpressao;
            cte.TipoPagamento = cteNFSe.TipoPagamento;
            cte.TipoServico = cteNFSe.TipoServico;
            cte.TipoTomador = cteNFSe.TipoTomador;
            cte.Tomador = cteNFSe.Tomador;
            cte.ValesPedagio = cteNFSe.ValesPedagio;
            cte.ValorAReceber = cteNFSe.ValorAReceber;
            cte.ValorCargaAverbacao = cteNFSe.ValorCargaAverbacao;
            cte.ValorFrete = cteNFSe.ValorFrete;
            cte.ValorTotalMercadoria = cteNFSe.ValorTotalMercadoria;
            cte.ValorTotalPrestacaoServico = cteNFSe.ValorTotalPrestacaoServico;
            cte.Veiculos = cteNFSe.Veiculos;
            cte.Versao = cteNFSe.Versao;
            cte.CodigoTipoOperacao = cteNFSe.CodigoTipoOperacao;
            cte.Romaneio = cteNFSe.Romaneio;
            cte.TipoVeiculo = cteNFSe.TipoVeiculo;
            cte.TipoCalculo = cteNFSe.TipoCalculo;
            cte.ValorDespesa = cteNFSe.ValorDespesa;

            cte.Numero = cteNFSe.Numero;
            cte.ChaveCTe = cteNFSe.ChaveCTe;

            if (cte.Documentos != null && cte.Documentos.Count > 0)
            {
                if (!string.IsNullOrWhiteSpace(cte.Documentos.FirstOrDefault().NumeroPedido))
                {
                    Dominio.ObjetosDeValor.CTe.Observacao obsContribuinte = new Dominio.ObjetosDeValor.CTe.Observacao();
                    obsContribuinte.Descricao = cte.Documentos.FirstOrDefault().NumeroPedido;
                    obsContribuinte.Identificador = "PEDIDO";

                    if (cte.ObservacoesContribuinte == null)
                        cte.ObservacoesContribuinte = new List<Dominio.ObjetosDeValor.CTe.Observacao>();
                    cte.ObservacoesContribuinte.Add(obsContribuinte);
                }
            }

            return cte;
        }

        public System.IO.MemoryStream GerarEDIPipes(List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> listaCTes)
        {
            if (listaCTes == null || listaCTes.Count == 0)
                return null;

            Repositorio.UnitOfWork unitOfWork = new Repositorio.UnitOfWork(StringConexao);

            MemoryStream memoStream = new MemoryStream();
            StringBuilder Registro = new StringBuilder();

            string linha = "";
            foreach (Dominio.Entidades.ConhecimentoDeTransporteEletronico cte in listaCTes)
            {
                if (cte.Documentos != null && cte.Documentos.Count > 0)
                {
                    foreach (Dominio.Entidades.DocumentosCTE documentosCTe in cte.Documentos)
                    {
                        linha = "";
                        linha = string.Concat(linha, documentosCTe.ChaveNFE, "|"); //chave nfe
                        linha = string.Concat(linha, documentosCTe.CTE.TipoCTE == Dominio.Enumeradores.TipoCTE.Complemento ? "S" : "N", "|"); //Indica se é complemento
                        linha = string.Concat(linha, documentosCTe.CTE.Veiculos != null && documentosCTe.CTE.Veiculos.Count > 0 ? documentosCTe.CTE.Veiculos.FirstOrDefault().Placa_Formatada : string.Empty, "|"); //Placa do veículo
                        linha = string.Concat(linha, documentosCTe.CTE.Numero, "|"); //Número do transporte ? Enviado o número do CTe
                        linha = string.Concat(linha, "", "|"); //Local de Organização do Transporte
                        linha = string.Concat(linha, "", "|"); //Tipo do Transporte
                        linha = string.Concat(linha, "", "|"); //Tipo Custo
                        linha = string.Concat(linha, documentosCTe.CTE.CST != "60" ? documentosCTe.CTE.BaseCalculoICMS : 0, "|"); //Base Calculo ICMS
                        linha = string.Concat(linha, documentosCTe.CTE.CST == "60" ? documentosCTe.CTE.BaseCalculoICMS : 0, "|"); //Base Calculo ICMS ST
                        linha = string.Concat(linha, documentosCTe.CTE.AliquotaICMS, "|"); //Aliquota ICMS
                        linha = string.Concat(linha, documentosCTe.CTE.CST != "60" ? documentosCTe.CTE.ValorICMS : 0, "|"); //Valor ICMS
                        linha = string.Concat(linha, documentosCTe.CTE.CST != "60" ? documentosCTe.CTE.ValorICMS : 0, "|"); //Valor ICMS ST
                        linha = string.Concat(linha, "", "|"); //Valor ISS
                        linha = string.Concat(linha, documentosCTe.CTE.ValorAReceber, "|"); //Valor Total do Frete
                        linha = string.Concat(linha, "", "|"); //Codigo transportador
                        linha = string.Concat(linha, "", "|"); //Motivo complemento
                        linha = string.Concat(linha, "", "|"); //Descrição complemento
                        linha = string.Concat(linha, "", "|"); //Codigo do transporte Original gerador complemento
                        linha = string.Concat(linha, "", "|"); //Codigo do transporte principal para conjugados
                        linha = string.Concat(linha, "", "|"); //Codigo da Filial para qual deve ser emitido o CTe/XML
                        linha = string.Concat(linha, documentosCTe.DataEmissao.ToString("ddMMyyyy"), "|"); //Data emissão da NFe
                        linha = string.Concat(linha, documentosCTe.Numero, "|"); //Numero da NFe
                        linha = string.Concat(linha, documentosCTe.SerieOuSerieDaChave, "|"); //Série da NFe
                        linha = string.Concat(linha, documentosCTe.Valor, "|"); //Valor da NFe
                        linha = string.Concat(linha, documentosCTe.Peso, "|"); //Peso Bruto da NFe
                        linha = string.Concat(linha, documentosCTe.Peso, "|"); //Peso Bruto da NFe
                        linha = string.Concat(linha, documentosCTe.Valor, "|"); //Valor dos produtos
                        linha = string.Concat(linha, documentosCTe.Volume, "|"); //Quantidade de Volumes
                        linha = string.Concat(linha, documentosCTe.CTE.Remetente.CPF_CNPJ, "|"); //CNPJ Emitente
                        linha = string.Concat(linha, documentosCTe.CTE.Remetente.Localidade.CodigoIBGE, "|"); //IBGE Emitente
                        linha = string.Concat(linha, documentosCTe.CTE.Destinatario != null ? documentosCTe.CTE.Destinatario.Localidade.CodigoIBGE.ToString() : string.Empty, "|"); //IBGE Destinatario
                        linha = string.Concat(linha, documentosCTe.CTE.Destinatario != null ? documentosCTe.CTE.Destinatario.Localidade.Estado.Sigla : string.Empty, "|"); //UF eEstinatario
                        linha = string.Concat(linha, documentosCTe.CTE.Destinatario != null ? documentosCTe.CTE.Destinatario.CPF_CNPJ : string.Empty, "|"); //CNPJ Destinatario
                        linha = string.Concat(linha, documentosCTe.CTE.Destinatario != null ? documentosCTe.CTE.Destinatario.IE_RG : string.Empty, "|"); //IE Destinatario
                        linha = string.Concat(linha, documentosCTe.CTE.Destinatario != null ? documentosCTe.CTE.Destinatario.Nome : string.Empty, "|"); //Nome Destinatario
                        linha = string.Concat(linha, documentosCTe.CTE.Destinatario != null ? documentosCTe.CTE.Destinatario.Endereco : string.Empty, "|"); //Endereco Destinatario
                        linha = string.Concat(linha, documentosCTe.CTE.Destinatario != null ? documentosCTe.CTE.Destinatario.Numero : string.Empty, "|"); //Numero Destinatario
                        linha = string.Concat(linha, documentosCTe.CTE.Destinatario != null ? documentosCTe.CTE.Destinatario.Complemento : string.Empty, "|"); //Complemento Destinatario
                        linha = string.Concat(linha, documentosCTe.CTE.Destinatario != null ? documentosCTe.CTE.Destinatario.Bairro : string.Empty, "|"); //Bairro Destinatario
                        linha = string.Concat(linha, documentosCTe.CTE.Destinatario != null ? documentosCTe.CTE.Destinatario.CEP : string.Empty, "|"); //CEP Destinatario
                        linha = string.Concat(linha, documentosCTe.CTE.TipoTomador == Dominio.Enumeradores.TipoTomador.Remetente ? 1 : documentosCTe.CTE.TipoTomador == Dominio.Enumeradores.TipoTomador.Destinatario ? 2 : 0, "|"); //Mod Frete
                        linha = string.Concat(linha, 1, "|"); //TPNF 1 SAÍDA
                        linha = string.Concat(linha, 0, "|"); //Distância
                        linha = string.Concat(linha, 1, "|"); //Quantidade de Entregas
                        Registro.AppendLine(linha);
                    }
                }
            }

            string arquivo = Registro.ToString();

            memoStream.Write(System.Text.Encoding.UTF8.GetBytes(arquivo), 0, arquivo.Length);

            memoStream.Position = 0;
            unitOfWork.Dispose();

            return memoStream;
        }

        private void CalcularFretePorValorNFEs(ref List<Dominio.ObjetosDeValor.XMLNFe> notasFiscais, int codigoTabela, Dominio.Entidades.Empresa empresa, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.FretePorValor repFretePorValor = new Repositorio.FretePorValor(unitOfWork);
            Dominio.Entidades.FretePorValor fretePorValor = repFretePorValor.BuscarPorCodigo(empresa.Codigo, codigoTabela);

            if (fretePorValor != null)
            {
                decimal valorTotalNFes, pesoTotalNFes = 0;
                valorTotalNFes = notasFiscais.Sum(x => x.ValorTotal);
                pesoTotalNFes = notasFiscais.Sum(x => x.Peso);

                if (fretePorValor.TipoRateio == Dominio.Enumeradores.TipoRateioTabelaFreteValor.ValorNotaFiscal)
                {
                    foreach (Dominio.ObjetosDeValor.XMLNFe nota in notasFiscais)
                    {
                        nota.ValorFrete = (nota.ValorTotal / valorTotalNFes) * fretePorValor.ValorMinimoFrete;

                        if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.ValorMinimoMaisPercentual && fretePorValor.PercentualSobreNF > 0)
                        {
                            nota.ValorFrete = nota.ValorFrete;
                            nota.PercentualSobreNf = fretePorValor.PercentualSobreNF;
                            nota.ValorSobreNf = (nota.ValorTotal * (fretePorValor.PercentualSobreNF / 100));
                        }
                        else
                        if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.SomentePercentualSobreNF && fretePorValor.PercentualSobreNF > 0)
                        {
                            nota.ValorFrete = (nota.ValorTotal * (fretePorValor.PercentualSobreNF / 100));
                            nota.PercentualSobreNf = fretePorValor.PercentualSobreNF;
                            nota.ValorSobreNf = 0;
                        }
                        else
                        if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.ValorMinimoGarantido && notasFiscais.Count == 1)
                        {
                            nota.ValorFrete = fretePorValor.ValorMinimoFrete > nota.ValorFrete ? fretePorValor.ValorMinimoFrete : nota.ValorFrete;
                            nota.PercentualSobreNf = 0;
                            nota.ValorSobreNf = 0;
                        }

                        nota.ValorPedagio = (nota.ValorTotal / valorTotalNFes) * fretePorValor.ValorPedagio;

                        nota.ValorFrete = nota.ValorFrete;
                        nota.ValorPedagio = nota.ValorPedagio;
                        nota.incluirICMS = fretePorValor.IncluiICMS;
                        nota.TipoRaterio = Dominio.Enumeradores.TipoRateioTabelaFreteValor.ValorNotaFiscal;
                    }
                }
                else
                if (fretePorValor.TipoRateio == Dominio.Enumeradores.TipoRateioTabelaFreteValor.Peso)
                {
                    foreach (Dominio.ObjetosDeValor.XMLNFe nota in notasFiscais)
                    {
                        nota.ValorFrete = (nota.Peso / pesoTotalNFes) * fretePorValor.ValorMinimoFrete;

                        if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.ValorMinimoMaisPercentual && fretePorValor.PercentualSobreNF > 0)
                        {
                            nota.ValorFrete = nota.ValorFrete;
                            nota.PercentualSobreNf = fretePorValor.PercentualSobreNF;
                            nota.ValorSobreNf = (nota.ValorTotal * (fretePorValor.PercentualSobreNF / 100));
                        }
                        else
                        if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.SomentePercentualSobreNF && fretePorValor.PercentualSobreNF > 0)
                        {
                            nota.ValorFrete = (nota.ValorTotal * (fretePorValor.PercentualSobreNF / 100));
                            nota.PercentualSobreNf = fretePorValor.PercentualSobreNF;
                            nota.ValorSobreNf = 0;
                        }
                        else
                        if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.ValorMinimoGarantido && notasFiscais.Count == 1)
                        {
                            nota.ValorFrete = fretePorValor.ValorMinimoFrete > nota.ValorFrete ? fretePorValor.ValorMinimoFrete : nota.ValorFrete;
                            nota.PercentualSobreNf = 0;
                            nota.ValorSobreNf = 0;
                        }

                        nota.ValorPedagio = (nota.Peso / pesoTotalNFes) * fretePorValor.ValorPedagio;

                        nota.ValorFrete = nota.ValorFrete;
                        nota.ValorPedagio = nota.ValorPedagio;
                        nota.incluirICMS = fretePorValor.IncluiICMS;
                        nota.TipoRaterio = Dominio.Enumeradores.TipoRateioTabelaFreteValor.Peso;
                    }
                }
                else
                if (fretePorValor.TipoRateio == Dominio.Enumeradores.TipoRateioTabelaFreteValor.Nenhum)
                {
                    foreach (Dominio.ObjetosDeValor.XMLNFe nota in notasFiscais)
                    {
                        nota.ValorFrete = fretePorValor.ValorMinimoFrete;

                        if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.ValorMinimoMaisPercentual && fretePorValor.PercentualSobreNF > 0)
                        {
                            nota.ValorFrete = nota.ValorFrete;
                            nota.PercentualSobreNf = fretePorValor.PercentualSobreNF;
                            nota.ValorSobreNf = (nota.ValorTotal * (fretePorValor.PercentualSobreNF / 100));
                        }
                        else
                        if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.SomentePercentualSobreNF && fretePorValor.PercentualSobreNF > 0)
                        {
                            nota.ValorFrete = (nota.ValorTotal * (fretePorValor.PercentualSobreNF / 100));
                            nota.PercentualSobreNf = fretePorValor.PercentualSobreNF;
                            nota.ValorSobreNf = 0;
                        }
                        else
                        if (fretePorValor.Tipo == Dominio.Enumeradores.TipoFreteValor.ValorMinimoGarantido)
                        {
                            nota.ValorFrete = fretePorValor.ValorMinimoFrete > nota.ValorFrete ? fretePorValor.ValorMinimoFrete : nota.ValorFrete;
                            nota.PercentualSobreNf = 0;
                            nota.ValorSobreNf = 0;
                        }

                        nota.ValorPedagio = fretePorValor.ValorPedagio;

                        nota.ValorFrete = nota.ValorFrete;
                        nota.ValorPedagio = nota.ValorPedagio;
                        nota.incluirICMS = fretePorValor.IncluiICMS;
                        nota.TipoRaterio = Dominio.Enumeradores.TipoRateioTabelaFreteValor.Nenhum;
                    }
                }
            }
        }

        private void RatearValorFreteNFEsPesoDestinatarioRemetente(ref List<Dominio.ObjetosDeValor.XMLNFe> notasFiscais, Dominio.Entidades.Empresa empresa, decimal valorFreteTotal, decimal valorPedagioTotal, decimal valorAdicionalEntregaTotal, Dominio.Enumeradores.TipoRateioTabelaFreteValor tipoRateio, Repositorio.UnitOfWork unitOfWork)
        {
            if (notasFiscais != null && notasFiscais.Count > 0 && valorFreteTotal > 0)
            {
                decimal valorFrete, valorPedagio, valorAdicionalEntrega, pesoTotalNFes, volumeTotalNFes, valorFreteNotas, valorPedagioNotas, valorAdicionalEntregaNotas, valorFreteDestinatarios, valorPedagioDestinatarios, valorAdicionalEntregaDestinatarios = 0;
                int quantidadeNotas = 0;
                bool naoRatearValorPedagio = empresa.Configuracao != null ? empresa.Configuracao.ImportacaoNaoRateiaPedagio : false;

                quantidadeNotas = notasFiscais.Count();
                pesoTotalNFes = notasFiscais.Sum(x => x.Peso);
                volumeTotalNFes = notasFiscais.Sum(x => x.Volume);
                valorFrete = valorFreteTotal;
                valorPedagio = valorPedagioTotal;
                valorAdicionalEntrega = valorAdicionalEntregaTotal;

                decimal valorMinimoCTe = 1;

                if (pesoTotalNFes > 0)
                {
                    //Rateia o frete por destinatário
                    List<Dominio.ObjetosDeValor.XMLNFeDestinatario> destinatarios = new List<Dominio.ObjetosDeValor.XMLNFeDestinatario>();
                    foreach (Dominio.ObjetosDeValor.XMLNFe nota in notasFiscais)
                    {
                        Dominio.ObjetosDeValor.XMLNFeDestinatario destinatario = destinatarios.Where(o => o.Destinatario == nota.Destinatario).Select(o => o).FirstOrDefault();
                        if (destinatario == null)
                        {
                            destinatario = new Dominio.ObjetosDeValor.XMLNFeDestinatario();
                            destinatario.Destinatario = nota.Destinatario;
                            destinatario.PesoTotal = nota.Peso;

                            destinatario.ValorFreteRateado = Math.Round((destinatario.PesoTotal / pesoTotalNFes) * valorFrete, 2, MidpointRounding.ToEven);

                            if (!naoRatearValorPedagio && valorPedagio > 0)
                                destinatario.ValorPedagioRateado = Math.Round((destinatario.PesoTotal / pesoTotalNFes) * valorPedagio, 2, MidpointRounding.ToEven);

                            if (valorAdicionalEntrega > 0)
                                destinatario.ValorAdicionalEntregaRateado = Math.Round((destinatario.PesoTotal / pesoTotalNFes) * valorAdicionalEntrega, 2, MidpointRounding.ToEven);

                            destinatarios.Add(destinatario);
                        }
                        else
                        {
                            destinatario.PesoTotal += nota.Peso;
                            destinatario.ValorFreteRateado = Math.Round((destinatario.PesoTotal / pesoTotalNFes) * valorFrete, 2, MidpointRounding.ToEven);

                            if (!naoRatearValorPedagio && valorPedagio > 0)
                                destinatario.ValorPedagioRateado = Math.Round((destinatario.PesoTotal / pesoTotalNFes) * valorPedagio, 2, MidpointRounding.ToEven);

                            if (valorAdicionalEntrega > 0)
                                destinatario.ValorAdicionalEntregaRateado = Math.Round((destinatario.PesoTotal / pesoTotalNFes) * valorAdicionalEntrega, 2, MidpointRounding.ToEven);
                        }
                    }

                    valorFreteDestinatarios = destinatarios.Sum(o => o.ValorFreteRateado);
                    if (valorFreteDestinatarios != valorFrete)
                    {
                        decimal diferenca = valorFrete - valorFreteDestinatarios;
                        destinatarios[0].ValorFreteRateado = destinatarios[0].ValorFreteRateado + diferenca;
                    }

                    valorPedagioDestinatarios = destinatarios.Sum(o => o.ValorPedagioRateado);
                    if (valorPedagioDestinatarios != valorPedagio)
                    {
                        decimal diferenca = valorPedagio - valorPedagioDestinatarios;
                        destinatarios[0].ValorPedagioRateado = destinatarios[0].ValorPedagioRateado + diferenca;
                    }

                    valorAdicionalEntregaDestinatarios = destinatarios.Sum(o => o.ValorAdicionalEntregaRateado);
                    if (valorAdicionalEntregaDestinatarios != valorAdicionalEntrega)
                    {
                        decimal diferenca = valorAdicionalEntrega - valorAdicionalEntregaDestinatarios;
                        destinatarios[0].ValorAdicionalEntregaRateado = destinatarios[0].ValorAdicionalEntregaRateado + diferenca;
                    }

                    valorFreteNotas = 0;
                    valorPedagioNotas = 0;
                    valorAdicionalEntregaNotas = 0;
                    foreach (Dominio.ObjetosDeValor.XMLNFeDestinatario dest in destinatarios)
                    {
                        List<Dominio.ObjetosDeValor.XMLNFe> notasDestinatario = notasFiscais.Where(o => o.Destinatario == dest.Destinatario).Select(o => o).ToList();
                        valorFrete = dest.ValorFreteRateado;
                        if (!naoRatearValorPedagio && dest.ValorPedagioRateado > 0)
                            valorPedagio = dest.ValorPedagioRateado;
                        if (dest.ValorAdicionalEntregaRateado > 0)
                            valorAdicionalEntrega = dest.ValorAdicionalEntregaRateado;

                        pesoTotalNFes = notasDestinatario.Sum(o => o.Peso);

                        //Após rateado por destinatário rateia o valor entre as notas
                        foreach (Dominio.ObjetosDeValor.XMLNFe notaDestino in notasDestinatario)
                        {
                            notaDestino.TipoRaterio = tipoRateio;
                            notaDestino.incluirICMS = empresa.Configuracao != null ? empresa.Configuracao.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim ? Dominio.Enumeradores.IncluiICMSFrete.Sim : Dominio.Enumeradores.IncluiICMSFrete.Nao : Dominio.Enumeradores.IncluiICMSFrete.Nao;
                            notaDestino.ValorFrete = 0;
                            if (pesoTotalNFes > 0 && notaDestino.Peso > 0)
                            {
                                notaDestino.ValorFrete = Math.Round((notaDestino.Peso / pesoTotalNFes) * valorFrete, 2, MidpointRounding.ToEven);
                                if (!naoRatearValorPedagio && valorPedagio > 0)
                                    notaDestino.ValorPedagio = Math.Round((notaDestino.Peso / pesoTotalNFes) * valorPedagio, 2, MidpointRounding.ToEven);
                                if (valorAdicionalEntrega > 0)
                                    notaDestino.ValorAdicionalEntrega = Math.Round((notaDestino.Peso / pesoTotalNFes) * valorAdicionalEntrega, 2, MidpointRounding.ToEven);
                            }

                            if (notaDestino.ValorFrete < valorMinimoCTe)
                                notaDestino.ValorFrete = valorMinimoCTe;

                            valorFreteNotas += notaDestino.ValorFrete;
                            valorPedagioNotas += notaDestino.ValorPedagio;
                            valorAdicionalEntregaNotas += notaDestino.ValorAdicionalEntrega;
                        }
                    }

                    if (valorFreteNotas != valorFreteTotal)
                    {
                        Dominio.ObjetosDeValor.XMLNFe notaDiferenca = notasFiscais.OrderByDescending(o => o.ValorFrete).FirstOrDefault();
                        decimal diferenca = valorFreteTotal - valorFreteNotas;
                        notaDiferenca.ValorFrete = notaDiferenca.ValorFrete + diferenca;
                    }

                    if (!naoRatearValorPedagio && valorPedagioNotas != valorPedagioTotal)
                    {
                        Dominio.ObjetosDeValor.XMLNFe notaDiferencaPedagio = notasFiscais.OrderByDescending(o => o.ValorPedagio).FirstOrDefault();
                        decimal diferenca = valorPedagioTotal - valorPedagioNotas;
                        notaDiferencaPedagio.ValorPedagio = notaDiferencaPedagio.ValorPedagio + diferenca;
                    }

                    if (valorPedagioTotal > 0 && naoRatearValorPedagio)
                    {
                        Dominio.ObjetosDeValor.XMLNFe notaDiferenca = notasFiscais.OrderByDescending(o => o.Peso).FirstOrDefault();
                        notaDiferenca.ValorPedagio = valorPedagioTotal;
                    }

                    if (valorAdicionalEntregaNotas != valorAdicionalEntregaTotal)
                    {
                        Dominio.ObjetosDeValor.XMLNFe notaDiferencaAdicionalEntrega = notasFiscais.OrderByDescending(o => o.ValorAdicionalEntrega).FirstOrDefault();
                        decimal diferenca = valorAdicionalEntregaTotal - valorAdicionalEntregaNotas;
                        notaDiferencaAdicionalEntrega.ValorAdicionalEntrega = notaDiferencaAdicionalEntrega.ValorAdicionalEntrega + diferenca;
                    }
                }
            }
        }

        private void RatearValorFreteNFEsValorDestinatarioRemetente(ref List<Dominio.ObjetosDeValor.XMLNFe> notasFiscais, Dominio.Entidades.Empresa empresa, decimal valorFreteTotal, decimal valorPedagioTotal, decimal valorAdicionalEntregaTotal, Dominio.Enumeradores.TipoRateioTabelaFreteValor tipoRateio, Repositorio.UnitOfWork unitOfWork)
        {
            if (notasFiscais != null && notasFiscais.Count > 0 && valorFreteTotal > 0)
            {
                decimal valorFrete, valorPedagio, valorAdicionalEntrega, valorTotalNFes, valorFreteNotas, valorPedagioNotas, valorAdicionalEntregaNotas, valorFreteDestinatarios, valorPedagioDestinatarios, valorAdicionalEntregaDestinatarios = 0;
                int quantidadeNotas = 0;
                bool naoRatearValorPedagio = empresa.Configuracao != null ? empresa.Configuracao.ImportacaoNaoRateiaPedagio : false;

                quantidadeNotas = notasFiscais.Count();
                valorTotalNFes = notasFiscais.Sum(x => x.ValorTotal);
                valorFrete = valorFreteTotal;
                valorPedagio = valorPedagioTotal;
                valorAdicionalEntrega = valorAdicionalEntregaTotal;

                decimal valorMinimoCTe = 1;

                //Rateia o frete por destinatário
                List<Dominio.ObjetosDeValor.XMLNFeDestinatario> destinatarios = new List<Dominio.ObjetosDeValor.XMLNFeDestinatario>();
                foreach (Dominio.ObjetosDeValor.XMLNFe nota in notasFiscais)
                {
                    Dominio.ObjetosDeValor.XMLNFeDestinatario destinatario = destinatarios.Where(o => o.Destinatario == nota.Destinatario).Select(o => o).FirstOrDefault();
                    if (destinatario == null)
                    {
                        destinatario = new Dominio.ObjetosDeValor.XMLNFeDestinatario();
                        destinatario.Destinatario = nota.Destinatario;
                        destinatario.ValorTotal = nota.ValorTotal;

                        destinatario.ValorFreteRateado = Math.Round((destinatario.ValorTotal / valorTotalNFes) * valorFrete, 2, MidpointRounding.ToEven);

                        if (!naoRatearValorPedagio && valorPedagio > 0)
                            destinatario.ValorPedagioRateado = Math.Round((destinatario.ValorTotal / valorTotalNFes) * valorPedagio, 2, MidpointRounding.ToEven);

                        if (valorAdicionalEntrega > 0)
                            destinatario.ValorAdicionalEntregaRateado = Math.Round((destinatario.ValorTotal / valorTotalNFes) * valorAdicionalEntrega, 2, MidpointRounding.ToEven);

                        destinatarios.Add(destinatario);
                    }
                    else
                    {
                        destinatario.ValorTotal += nota.ValorTotal;
                        destinatario.ValorFreteRateado = Math.Round((destinatario.ValorTotal / valorTotalNFes) * valorFrete, 2, MidpointRounding.ToEven);

                        if (!naoRatearValorPedagio && valorPedagio > 0)
                            destinatario.ValorPedagioRateado = Math.Round((destinatario.ValorTotal / valorTotalNFes) * valorPedagio, 2, MidpointRounding.ToEven);

                        if (valorAdicionalEntrega > 0)
                            destinatario.ValorAdicionalEntregaRateado = Math.Round((destinatario.ValorTotal / valorTotalNFes) * valorAdicionalEntrega, 2, MidpointRounding.ToEven);
                    }
                }

                valorFreteDestinatarios = destinatarios.Sum(o => o.ValorFreteRateado);
                if (valorFreteDestinatarios != valorFrete)
                {
                    decimal diferenca = valorFrete - valorFreteDestinatarios;
                    destinatarios[0].ValorFreteRateado = destinatarios[0].ValorFreteRateado + diferenca;
                }

                valorPedagioDestinatarios = destinatarios.Sum(o => o.ValorPedagioRateado);
                if (valorPedagioDestinatarios != valorPedagio)
                {
                    decimal diferenca = valorPedagio - valorPedagioDestinatarios;
                    destinatarios[0].ValorPedagioRateado = destinatarios[0].ValorPedagioRateado + diferenca;
                }

                valorAdicionalEntregaDestinatarios = destinatarios.Sum(o => o.ValorAdicionalEntregaRateado);
                if (valorAdicionalEntregaDestinatarios != valorAdicionalEntrega)
                {
                    decimal diferenca = valorAdicionalEntrega - valorAdicionalEntregaDestinatarios;
                    destinatarios[0].ValorAdicionalEntregaRateado = destinatarios[0].ValorAdicionalEntregaRateado + diferenca;
                }

                valorFreteNotas = 0;
                valorPedagioNotas = 0;
                valorAdicionalEntregaNotas = 0;
                foreach (Dominio.ObjetosDeValor.XMLNFeDestinatario dest in destinatarios)
                {
                    List<Dominio.ObjetosDeValor.XMLNFe> notasDestinatario = notasFiscais.Where(o => o.Destinatario == dest.Destinatario).Select(o => o).ToList();
                    valorFrete = dest.ValorFreteRateado;
                    if (!naoRatearValorPedagio && dest.ValorPedagioRateado > 0)
                        valorPedagio = dest.ValorPedagioRateado;
                    if (dest.ValorAdicionalEntregaRateado > 0)
                        valorAdicionalEntrega = dest.ValorAdicionalEntregaRateado;
                    valorTotalNFes = notasDestinatario.Sum(o => o.ValorTotal);

                    //Após rateado por destinatário rateia o valor entre as notas
                    foreach (Dominio.ObjetosDeValor.XMLNFe notaDestino in notasDestinatario)
                    {
                        notaDestino.TipoRaterio = tipoRateio;
                        notaDestino.incluirICMS = empresa.Configuracao != null ? empresa.Configuracao.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim ? Dominio.Enumeradores.IncluiICMSFrete.Sim : Dominio.Enumeradores.IncluiICMSFrete.Nao : Dominio.Enumeradores.IncluiICMSFrete.Nao;
                        notaDestino.ValorFrete = 0;
                        if (valorTotalNFes > 0 && notaDestino.ValorTotal > 0)
                        {
                            notaDestino.ValorFrete = Math.Round((notaDestino.ValorTotal / valorTotalNFes) * valorFrete, 2, MidpointRounding.ToEven);
                            if (!naoRatearValorPedagio && valorPedagio > 0)
                                notaDestino.ValorPedagio = Math.Round((notaDestino.ValorTotal / valorTotalNFes) * valorPedagio, 2, MidpointRounding.ToEven);
                            if (valorAdicionalEntrega > 0)
                                notaDestino.ValorAdicionalEntrega = Math.Round((notaDestino.ValorTotal / valorTotalNFes) * valorAdicionalEntrega, 2, MidpointRounding.ToEven);
                        }

                        if (notaDestino.ValorFrete < valorMinimoCTe)
                            notaDestino.ValorFrete = valorMinimoCTe;

                        valorFreteNotas += notaDestino.ValorFrete;
                        valorPedagioNotas += notaDestino.ValorPedagio;
                        valorAdicionalEntregaNotas += notaDestino.ValorAdicionalEntrega;
                    }
                }

                if (valorFreteNotas != valorFreteTotal)
                {
                    Dominio.ObjetosDeValor.XMLNFe notaDiferenca = notasFiscais.OrderByDescending(o => o.ValorFrete).FirstOrDefault();
                    decimal diferenca = valorFreteTotal - valorFreteNotas;
                    notaDiferenca.ValorFrete = notaDiferenca.ValorFrete + diferenca;
                }

                if (!naoRatearValorPedagio && valorPedagioNotas != valorPedagioTotal)
                {
                    Dominio.ObjetosDeValor.XMLNFe notaDiferencaPedagio = notasFiscais.OrderByDescending(o => o.ValorPedagio).FirstOrDefault();
                    decimal diferenca = valorPedagioTotal - valorPedagioNotas;
                    notaDiferencaPedagio.ValorPedagio = notaDiferencaPedagio.ValorPedagio + diferenca;
                }

                if (valorPedagioTotal > 0 && naoRatearValorPedagio)
                {
                    Dominio.ObjetosDeValor.XMLNFe notaDiferenca = notasFiscais.OrderByDescending(o => o.ValorTotal).FirstOrDefault();
                    notaDiferenca.ValorPedagio = valorPedagioTotal;
                }

                if (valorAdicionalEntregaNotas != valorAdicionalEntregaTotal)
                {
                    Dominio.ObjetosDeValor.XMLNFe notaDiferencaAdicionalEntrega = notasFiscais.OrderByDescending(o => o.ValorAdicionalEntrega).FirstOrDefault();
                    decimal diferenca = valorAdicionalEntregaTotal - valorAdicionalEntregaNotas;
                    notaDiferencaAdicionalEntrega.ValorAdicionalEntrega = notaDiferencaAdicionalEntrega.ValorAdicionalEntrega + diferenca;
                }
            }
        }

        private void RatearValorFreteNFEs(ref List<Dominio.ObjetosDeValor.XMLNFe> notasFiscais, Dominio.Entidades.Empresa empresa, decimal valorFrete, decimal valorPedagio, decimal valorAdicionalEntrega, Dominio.Enumeradores.TipoRateioTabelaFreteValor tipoRateio, Repositorio.UnitOfWork unitOfWork)
        {
            if (notasFiscais != null && notasFiscais.Count > 0 && valorFrete > 0)
            {
                decimal valorTotalNFes, pesoTotalNFes, volumeTotalNFes, valorFreteNotas = 0;
                decimal valorPedagioNotas = 0;
                decimal valorAdicionalNotas = 0;
                int quantidadeNotas = 0;
                quantidadeNotas = notasFiscais.Count();
                valorTotalNFes = notasFiscais.Sum(x => x.ValorTotal);
                pesoTotalNFes = notasFiscais.Sum(x => x.Peso);
                volumeTotalNFes = notasFiscais.Sum(x => x.Volume);

                foreach (Dominio.ObjetosDeValor.XMLNFe nota in notasFiscais)
                {
                    nota.TipoRaterio = tipoRateio;
                    nota.incluirICMS = empresa.Configuracao != null ? empresa.Configuracao.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim ? Dominio.Enumeradores.IncluiICMSFrete.Sim : Dominio.Enumeradores.IncluiICMSFrete.Nao : Dominio.Enumeradores.IncluiICMSFrete.Nao;
                    if (tipoRateio == Dominio.Enumeradores.TipoRateioTabelaFreteValor.Peso)
                    {
                        if (pesoTotalNFes > 0)
                        {
                            if (nota.Peso > 0)
                            {
                                nota.ValorFrete = Math.Round((nota.Peso / pesoTotalNFes) * valorFrete, 2, MidpointRounding.ToEven);
                                nota.ValorPedagio = Math.Round((nota.Peso / pesoTotalNFes) * valorPedagio, 2, MidpointRounding.ToEven);
                                nota.ValorAdicionalEntrega = Math.Round((nota.Peso / pesoTotalNFes) * valorAdicionalEntrega, 2, MidpointRounding.ToEven);
                            }
                            else
                            {
                                nota.ValorFrete = 0;
                                nota.ValorPedagio = 0;
                                nota.ValorAdicionalEntrega = 0;
                            }
                        }
                        else if (volumeTotalNFes > 0)
                        {
                            if (nota.Volume > 0)
                            {
                                nota.ValorFrete = Math.Round((nota.Volume / volumeTotalNFes) * valorFrete, 2, MidpointRounding.ToEven);
                                nota.ValorPedagio = Math.Round((nota.Volume / volumeTotalNFes) * valorPedagio, 2, MidpointRounding.ToEven);
                                nota.ValorAdicionalEntrega = Math.Round((nota.Volume / volumeTotalNFes) * valorAdicionalEntrega, 2, MidpointRounding.ToEven);
                            }
                            else
                            {
                                nota.ValorFrete = 0;
                                nota.ValorPedagio = 0;
                                nota.ValorAdicionalEntrega = 0;
                            }
                        }
                        else
                            nota.ValorFrete = 0;
                    }
                    else if (tipoRateio == Dominio.Enumeradores.TipoRateioTabelaFreteValor.Volume)
                    {
                        if (volumeTotalNFes > 0)
                        {
                            if (nota.Volume > 0)
                            {
                                nota.ValorFrete = Math.Round((nota.Volume / volumeTotalNFes) * valorFrete, 2, MidpointRounding.ToEven);
                                nota.ValorPedagio = Math.Round((nota.Volume / volumeTotalNFes) * valorPedagio, 2, MidpointRounding.ToEven);
                                nota.ValorAdicionalEntrega = Math.Round((nota.Volume / volumeTotalNFes) * valorAdicionalEntrega, 2, MidpointRounding.ToEven);
                            }
                            else
                            {
                                nota.ValorFrete = 0;
                                nota.ValorPedagio = 0;
                                nota.ValorAdicionalEntrega = 0;
                            }
                        }
                        else
                        {
                            nota.ValorFrete = 0;
                            nota.ValorPedagio = 0;
                            nota.ValorAdicionalEntrega = 0;
                        }
                    }
                    else if (tipoRateio == Dominio.Enumeradores.TipoRateioTabelaFreteValor.ValorNotaFiscal)
                    {
                        nota.ValorFrete = Math.Round((nota.ValorTotal / valorTotalNFes) * valorFrete, 2, MidpointRounding.ToEven);
                        nota.ValorPedagio = Math.Round((nota.ValorTotal / valorTotalNFes) * valorPedagio, 2, MidpointRounding.ToEven);
                        nota.ValorAdicionalEntrega = Math.Round((nota.ValorTotal / valorTotalNFes) * valorAdicionalEntrega, 2, MidpointRounding.ToEven);
                    }
                    else if (tipoRateio == Dominio.Enumeradores.TipoRateioTabelaFreteValor.PorDocumento)
                    {
                        nota.ValorFrete = Math.Round(valorFrete / quantidadeNotas, 2, MidpointRounding.ToEven);
                        nota.ValorPedagio = Math.Round(valorPedagio / quantidadeNotas, 2, MidpointRounding.ToEven);
                        nota.ValorAdicionalEntrega = Math.Round(valorAdicionalEntrega / quantidadeNotas, 2, MidpointRounding.ToEven);
                    }
                    else if (tipoRateio == Dominio.Enumeradores.TipoRateioTabelaFreteValor.PorCTe)
                    {
                        nota.ValorFrete = 0;
                        nota.ValorPedagio = 0;
                        nota.ValorAdicionalEntrega = 0;
                    }
                    else
                    {
                        nota.ValorFrete = 0;
                        nota.ValorPedagio = 0;
                        nota.ValorAdicionalEntrega = 0;
                    }

                    valorFreteNotas += nota.ValorFrete;
                    valorPedagioNotas += nota.ValorPedagio;
                    valorAdicionalNotas += nota.ValorAdicionalEntrega;
                }

                if (valorFreteNotas != valorFrete)
                {
                    decimal diferenca = valorFrete - valorFreteNotas;
                    notasFiscais[0].ValorFrete = notasFiscais[0].ValorFrete + diferenca;
                }

                if (valorPedagioNotas != valorPedagio)
                {
                    decimal diferenca = valorPedagio - valorPedagioNotas;
                    notasFiscais[0].ValorPedagio = notasFiscais[0].ValorPedagio + diferenca;
                }


                if (valorAdicionalNotas != valorAdicionalEntrega)
                {
                    decimal diferenca = valorAdicionalEntrega - valorAdicionalNotas;
                    notasFiscais[0].ValorAdicionalEntrega = notasFiscais[0].ValorAdicionalEntrega + diferenca;
                }

            }
        }

        private void SalvarInformacoesNFes(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, Dominio.ObjetosDeValor.XMLNFe notaFiscal, ref List<Dominio.ObjetosDeValor.XMLNFe> notasFiscais, bool agruparRemetente, bool agruparDestinatario, bool agruparUFDestino, bool agruparDT, ref decimal valorTotal, ref decimal pesoTotal, ref decimal volumesTotal, ref decimal cubagemTotal, ref decimal valorFreteTotal, ref decimal valorPedagioTotal, ref decimal valorAdicionalEntregaTotal, ref decimal valorSobreNFTotal, ref decimal baseICMSTotal, ref decimal valorICMSTotal, ref decimal baseICMSSTTotal, ref decimal valorICMSSTTotal, ref decimal valorAdValoremTotal, ref decimal valorDescargaTotal, ref bool cteGlobalizado, Repositorio.UnitOfWork unitOfWork)
        {
            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
            valorTotal = 0;
            pesoTotal = 0;
            volumesTotal = 0;
            cubagemTotal = 0;
            cteGlobalizado = false;
            string remetenteAnterior = string.Empty;

            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unitOfWork);
            Repositorio.ModeloDocumentoFiscal repModelo = new Repositorio.ModeloDocumentoFiscal(unitOfWork);
            List<Dominio.ObjetosDeValor.XMLNFe> notasFiltradas = new List<Dominio.ObjetosDeValor.XMLNFe>();

            if (agruparRemetente || agruparDestinatario || agruparUFDestino || agruparDT)
            {
                if (agruparDT)
                    notasFiltradas = notasFiscais.Where(n => n.NumeroDT == notaFiscal.NumeroDT).ToList();
                else if (agruparRemetente && agruparDestinatario)
                    notasFiltradas = notasFiscais.Where(n => n.Remetente == notaFiscal.Remetente && n.Destinatario == notaFiscal.Destinatario).ToList();
                else if (agruparRemetente)
                    notasFiltradas = notasFiscais.Where(n => n.Remetente == notaFiscal.Remetente).ToList();
                else if (agruparDestinatario)
                    notasFiltradas = notasFiscais.Where(n => n.Destinatario == notaFiscal.Destinatario).ToList();
                else if (agruparUFDestino)
                    notasFiltradas = notasFiscais.Where(n => n.DestinatarioUF == notaFiscal.DestinatarioUF).ToList();

                foreach (Dominio.ObjetosDeValor.XMLNFe nota in notasFiltradas)
                {
                    if (!nota.Adicionada)
                    {
                        if (nota != null)
                        {
                            DateTime.TryParseExact(nota.DataEmissao, "dd/MM/yyyy", null, System.Globalization.DateTimeStyles.None, out DateTime dataEmissao);
                            Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE
                            {
                                ChaveNFE = nota.Chave,
                                DataEmissao = dataEmissao > DateTime.MinValue ? dataEmissao : DateTime.Today,
                                Valor = nota.ValorTotal,
                                ModeloDocumentoFiscal = !string.IsNullOrWhiteSpace(nota.Chave) ? repModelo.BuscarPorModelo("55") : repModelo.BuscarPorModelo("99"),
                                Numero = nota.Numero,
                                RemetenteUF = nota.RemetenteUF,
                                DestinatarioUF = nota.DestinatarioUF,
                                Serie = nota.Serie,
                                CTE = conhecimento,
                                Peso = nota.Peso,
                                NumeroRomaneio = nota.NumeroRomaneio

                            };

                            if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                                documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                            if (!string.IsNullOrWhiteSpace(nota.Chave))
                                documento.Descricao = "OUTROS DOCUMENTOS";

                            repDocumento.Inserir(documento);

                            valorTotal += nota.ValorTotal;
                            if (conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.TipoPesoNFe == Dominio.Enumeradores.TipoPesoNFe.Liquido && nota.PesoLiquido > 0)
                                pesoTotal += nota.PesoLiquido;
                            else
                                pesoTotal += nota.Peso;

                            volumesTotal += nota.Volume;

                            cubagemTotal += nota.Cubagem;

                            if (nota.TipoRaterio == Dominio.Enumeradores.TipoRateioTabelaFreteValor.Nenhum || agruparDT)
                            {
                                valorFreteTotal = nota.ValorFrete;
                                valorPedagioTotal = nota.ValorPedagio;
                                valorAdicionalEntregaTotal = nota.ValorAdicionalEntrega;
                                valorAdValoremTotal = nota.ValorAdValorem;
                                valorDescargaTotal = nota.ValorDescarga;

                                baseICMSTotal = nota.BaseCalculoICMS;
                                valorICMSTotal = nota.ValorICMS;
                                baseICMSSTTotal = nota.BaseCalculoST;
                                valorICMSSTTotal = nota.ValorST;
                            }
                            else
                            {
                                valorFreteTotal += nota.ValorFrete;
                                valorPedagioTotal += nota.ValorPedagio;
                                valorAdicionalEntregaTotal += nota.ValorAdicionalEntrega;
                                valorAdValoremTotal += nota.ValorAdValorem;
                                valorDescargaTotal += nota.ValorDescarga;

                                baseICMSTotal += nota.BaseCalculoICMS;
                                valorICMSTotal += nota.ValorICMS;
                                baseICMSSTTotal += nota.BaseCalculoST;
                                valorICMSSTTotal += nota.ValorST;
                            }

                            valorSobreNFTotal += nota.ValorSobreNf;

                            nota.Adicionada = true;

                            if (agruparDT && !string.IsNullOrWhiteSpace(remetenteAnterior) && remetenteAnterior != notaFiscal.Remetente)
                                cteGlobalizado = true;
                            remetenteAnterior = notaFiscal.Remetente;
                        }
                    }
                }
            }
            else
            {
                if (notaFiscal != null && notaFiscal.Chave != "")
                {
                    Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();
                    documento.ChaveNFE = notaFiscal.Chave;

                    DateTime dataEmissao;
                    DateTime.TryParseExact(notaFiscal.DataEmissao, "dd/MM/yyyy", null, System.Globalization.DateTimeStyles.None, out dataEmissao);
                    documento.DataEmissao = dataEmissao > DateTime.MinValue ? dataEmissao : DateTime.Today;
                    documento.Valor = notaFiscal.ValorTotal;
                    documento.ModeloDocumentoFiscal = repModelo.BuscarPorModelo("55");
                    documento.Numero = notaFiscal.Numero;
                    documento.Serie = notaFiscal.Serie;
                    documento.CTE = conhecimento;
                    documento.NumeroRomaneio = notaFiscal.NumeroRomaneio;
                    documento.Peso = notaFiscal.Peso;
                    if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                        documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                    repDocumento.Inserir(documento);
                    valorTotal += notaFiscal.ValorTotal;
                    if (conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.TipoPesoNFe == Dominio.Enumeradores.TipoPesoNFe.Liquido && notaFiscal.PesoLiquido > 0)
                        pesoTotal += notaFiscal.PesoLiquido;
                    else
                        pesoTotal += notaFiscal.Peso;

                    volumesTotal += notaFiscal.Volume;
                    cubagemTotal += notaFiscal.Cubagem;

                    if (notaFiscal.TipoRaterio == Dominio.Enumeradores.TipoRateioTabelaFreteValor.Nenhum)
                    {
                        valorFreteTotal = notaFiscal.ValorFrete;
                        valorPedagioTotal = notaFiscal.ValorPedagio;
                        valorAdicionalEntregaTotal = notaFiscal.ValorAdicionalEntrega;

                        baseICMSTotal = notaFiscal.BaseCalculoICMS;
                        valorICMSTotal = notaFiscal.ValorICMS;
                        baseICMSSTTotal = notaFiscal.BaseCalculoST;
                        valorICMSSTTotal = notaFiscal.ValorST;
                    }
                    else
                    {
                        valorFreteTotal += notaFiscal.ValorFrete;
                        valorPedagioTotal += notaFiscal.ValorPedagio;
                        valorAdicionalEntregaTotal += notaFiscal.ValorAdicionalEntrega;

                        baseICMSTotal += notaFiscal.BaseCalculoICMS;
                        valorICMSTotal += notaFiscal.ValorICMS;
                        baseICMSSTTotal += notaFiscal.BaseCalculoST;
                        valorICMSSTTotal += notaFiscal.ValorST;
                    }

                    valorSobreNFTotal += notaFiscal.ValorSobreNf;

                    notaFiscal.Adicionada = true;
                }
            }
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, decimal peso, decimal volume, decimal cubagem, Repositorio.UnitOfWork unitOfWork)
        {
            bool adicionouPeso = false, adicionouVolume = false, adicionouCubagem = false;

            Repositorio.InformacaoCargaCTE repInformacaoCarga = new Repositorio.InformacaoCargaCTE(unitOfWork);
            Dominio.Entidades.InformacaoCargaCTE informacaoCargaPeso = new Dominio.Entidades.InformacaoCargaCTE();
            Dominio.Entidades.InformacaoCargaCTE informacaoCargaVolume = new Dominio.Entidades.InformacaoCargaCTE();
            Dominio.Entidades.InformacaoCargaCTE informacaoCargaCubagem = new Dominio.Entidades.InformacaoCargaCTE();
            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            //CTE nunca tem informações ´de carga já informadas nesta etapa
            //List<Dominio.Entidades.InformacaoCargaCTE> listaInformacaoCargaCTe = repInformacaoCarga.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo);
            //if (listaInformacaoCargaCTe.Count > 0)
            //{
            //    foreach (Dominio.Entidades.InformacaoCargaCTE informacaoCargaCTe in listaInformacaoCargaCTe)
            //    {
            //        if (informacaoCargaCTe.UnidadeMedida == "01" && peso > 0)
            //        {
            //            informacaoCargaCTe.Quantidade += peso;
            //            repInformacaoCarga.Atualizar(informacaoCargaCTe);
            //            adicionouPeso = true;
            //        }
            //        else if (informacaoCargaCTe.UnidadeMedida == "03" && volume > 0)
            //        {
            //            informacaoCargaCTe.Quantidade += volume;
            //            repInformacaoCarga.Atualizar(informacaoCargaCTe);
            //            adicionouVolume = true;
            //        }
            //    }
            //}

            if (!adicionouPeso && peso > 0)
            {
                informacaoCargaPeso.CTE = cte;
                informacaoCargaPeso.Quantidade = peso;
                informacaoCargaPeso.Tipo = cte.Empresa.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.Configuracao.DescricaoMedidaKgCTe) ? cte.Empresa.Configuracao.DescricaoMedidaKgCTe : "Kilograma";
                informacaoCargaPeso.UnidadeMedida = string.Format("{0:00}", (int)Dominio.Enumeradores.UnidadeMedida.KG);
                repInformacaoCarga.Inserir(informacaoCargaPeso);
                adicionouPeso = true;
            }

            if (!adicionouVolume && volume > 0)
            {
                informacaoCargaVolume.CTE = cte;
                informacaoCargaVolume.Quantidade = volume;
                informacaoCargaVolume.Tipo = "Unidade";
                informacaoCargaVolume.UnidadeMedida = string.Format("{0:00}", (int)Dominio.Enumeradores.UnidadeMedida.UN);
                repInformacaoCarga.Inserir(informacaoCargaVolume);
                adicionouVolume = true;
            }

            if (!adicionouCubagem && cubagem > 0)
            {
                informacaoCargaCubagem.CTE = cte;
                informacaoCargaCubagem.Quantidade = cubagem;
                informacaoCargaCubagem.Tipo = "Cubagem";
                informacaoCargaCubagem.UnidadeMedida = string.Format("{0:00}", (int)Dominio.Enumeradores.UnidadeMedida.M3);
                repInformacaoCarga.Inserir(informacaoCargaCubagem);
                adicionouCubagem = true;
            }

            if (!adicionouPeso && !adicionouVolume && !adicionouCubagem)
            {
                informacaoCargaPeso.CTE = cte;
                informacaoCargaPeso.Quantidade = 1;
                informacaoCargaPeso.Tipo = cte.Empresa.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.Configuracao.DescricaoMedidaKgCTe) ? cte.Empresa.Configuracao.DescricaoMedidaKgCTe : "Kilograma";
                informacaoCargaPeso.UnidadeMedida = string.Format("{0:00}", (int)Dominio.Enumeradores.UnidadeMedida.KG);
                repInformacaoCarga.Inserir(informacaoCargaPeso);
            }
        }

        private List<Dominio.Entidades.MotoristaCTE> SalvarInformacoesVeiculos(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.Entidades.Veiculo veiculo, Dominio.Entidades.Veiculo veiculoReboque, ref string obsPadraoVeiculo, Repositorio.UnitOfWork unitOfWork)
        {
            /* Junto com o veículo informado, pode haver um motorista configurado
             * Caso tenha, ele é retornado na função
             */
            List<Dominio.Entidades.MotoristaCTE> motoristasCTe = new List<Dominio.Entidades.MotoristaCTE>(); ;

            bool usouVeiculoPai = false;
            bool formatarPlacaComHifen = cte.Empresa.Configuracao != null ? cte.Empresa.Configuracao.FormatarPlacaComHifenNaObservacao : false;

            obsPadraoVeiculo = "";
            Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unitOfWork);
            Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unitOfWork);
            Repositorio.Estado repEstado = new Repositorio.Estado(unitOfWork);

            List<Dominio.Entidades.Veiculo> listaVeiculoPai = repVeiculo.BuscarVeiculoPai(cte.Empresa.Codigo, veiculo.Placa);
            Dominio.Entidades.VeiculoCTE veiculoCTe = new Dominio.Entidades.VeiculoCTE();

            veiculoCTe.CTE = cte;
            veiculoCTe.Veiculo = veiculo;
            veiculoCTe.SetarDadosVeiculo(veiculo);

            repVeiculoCTe.Inserir(veiculoCTe);

            if (veiculoReboque != null)
            {
                Dominio.Entidades.VeiculoCTE veiculoCTe2 = new Dominio.Entidades.VeiculoCTE();
                veiculoCTe2.CTE = cte;
                veiculoCTe2.Veiculo = veiculoReboque;
                veiculoCTe2.SetarDadosVeiculo(veiculoReboque);

                repVeiculoCTe.Inserir(veiculoCTe2);
            }
            else
            {
                if (veiculo.VeiculosVinculados.Count > 0)
                {
                    for (int i = 0; i < veiculo.VeiculosVinculados.Count; i++)
                    {
                        Dominio.Entidades.VeiculoCTE veiculoCTe2 = new Dominio.Entidades.VeiculoCTE();
                        veiculoCTe2.CTE = cte;
                        veiculoCTe2.Veiculo = veiculo.VeiculosVinculados[i];
                        veiculoCTe2.SetarDadosVeiculo(veiculo.VeiculosVinculados[i]);

                        repVeiculoCTe.Inserir(veiculoCTe2);
                    }
                }
                else if (listaVeiculoPai.FirstOrDefault() != null)
                {
                    usouVeiculoPai = true;
                    Dominio.Entidades.VeiculoCTE veiculoCTe2 = new Dominio.Entidades.VeiculoCTE();
                    veiculoCTe2.CTE = cte;
                    veiculoCTe2.Veiculo = listaVeiculoPai.FirstOrDefault();
                    veiculoCTe2.SetarDadosVeiculo(listaVeiculoPai.FirstOrDefault());

                    repVeiculoCTe.Inserir(veiculoCTe2);
                }
            }

            Dominio.Entidades.Usuario motoristaPrincipal = veiculo.Motoristas.Where(o => o.Principal).Select(o => o.Motorista).FirstOrDefault();

            if (!usouVeiculoPai && motoristaPrincipal != null)
            {
                Dominio.Entidades.MotoristaCTE motoristaCTe = new Dominio.Entidades.MotoristaCTE();

                motoristaCTe.CPFMotorista = motoristaPrincipal.CPF;
                motoristaCTe.NomeMotorista = motoristaPrincipal.Nome;

                motoristasCTe.Add(motoristaCTe);
            }
            else if (listaVeiculoPai.FirstOrDefault() != null)
            {
                motoristaPrincipal = listaVeiculoPai.FirstOrDefault().Motoristas.Where(o => o.Principal).Select(o => o.Motorista).FirstOrDefault();
                if (motoristaPrincipal != null)
                {
                    Dominio.Entidades.MotoristaCTE motoristaCTe = new Dominio.Entidades.MotoristaCTE();

                    motoristaCTe = new Dominio.Entidades.MotoristaCTE();

                    motoristaCTe.CPFMotorista = motoristaPrincipal.CPF;
                    motoristaCTe.NomeMotorista = motoristaPrincipal.Nome;

                    motoristasCTe.Add(motoristaCTe);
                }
            }

            if (veiculo.VeiculoMotoristas != null && veiculo.VeiculoMotoristas.Count > 0)
            {
                foreach (Dominio.Entidades.VeiculoMotoristas motoristaAdicional in veiculo.VeiculoMotoristas)
                {
                    Dominio.Entidades.MotoristaCTE motoristaCTe = new Dominio.Entidades.MotoristaCTE();

                    motoristaCTe.NomeMotorista = motoristaAdicional.Motorista.Nome;
                    motoristaCTe.CPFMotorista = motoristaAdicional.Motorista.CPF;

                    motoristasCTe.Add(motoristaCTe);
                }
            }

            try
            {
                if (!string.IsNullOrWhiteSpace(veiculo.ObservacaoCTe) && veiculo.Proprietario != null && veiculoReboque != null)
                {
                    obsPadraoVeiculo = veiculo.ObservacaoCTe
                            .Replace("#PlacaVeiculo#", formatarPlacaComHifen ? veiculo.Placa_Formatada : veiculo.Placa)
                            .Replace("#RENAVAMVeiculo#", veiculo.Renavam)
                            .Replace("#NomeProprietarioVeiculo#", veiculo.Proprietario.Nome)
                            .Replace("#CPFCNPJProprietarioVeiculo#", veiculo.Proprietario.CPF_CNPJ.ToString())
                            .Replace("#RNTRCProprietario#", veiculo.RNTRC.ToString())
                            .Replace("#UFVeiculo#", veiculo.Estado.Sigla)
                            .Replace("#MarcaVeiculo#", veiculo.DescricaoMarca)
                            .Replace("#PlacasVinculadas#", veiculoReboque.Placa);
                }
                else if (!usouVeiculoPai && veiculo.VeiculosVinculados.Count > 0)
                {
                    if (veiculo.Proprietario != null && veiculo.ObservacaoCTe != null && veiculo.ObservacaoCTe != "")
                    {
                        string placasVinculadas = "";

                        for (int i = 0; i < veiculo.VeiculosVinculados.Count; i++)
                        {
                            if (placasVinculadas == "")
                                placasVinculadas = formatarPlacaComHifen ? veiculo.VeiculosVinculados[i].Placa_Formatada : veiculo.VeiculosVinculados[i].Placa;
                            else
                                placasVinculadas += ", " + (formatarPlacaComHifen ? veiculo.VeiculosVinculados[i].Placa_Formatada : veiculo.VeiculosVinculados[i].Placa);
                        }

                        obsPadraoVeiculo = veiculo.ObservacaoCTe
                                .Replace("#PlacaVeiculo#", formatarPlacaComHifen ? veiculo.Placa_Formatada : veiculo.Placa)
                                .Replace("#RENAVAMVeiculo#", veiculo.Renavam)
                                .Replace("#NomeProprietarioVeiculo#", veiculo.Proprietario.Nome)
                                .Replace("#CPFCNPJProprietarioVeiculo#", veiculo.Proprietario.CPF_CNPJ.ToString())
                                .Replace("#RNTRCProprietario#", veiculo.RNTRC.ToString())
                                .Replace("#UFVeiculo#", veiculo.Estado.Sigla)
                                .Replace("#MarcaVeiculo#", veiculo.DescricaoMarca)
                                .Replace("#PlacasVinculadas#", placasVinculadas);
                    }
                }
                else if (listaVeiculoPai.FirstOrDefault() != null && listaVeiculoPai.FirstOrDefault().Proprietario != null)
                {
                    if (listaVeiculoPai.FirstOrDefault().ObservacaoCTe != null && listaVeiculoPai.FirstOrDefault().ObservacaoCTe != "")
                    {
                        string placasVinculadas = veiculo.Placa;

                        obsPadraoVeiculo = listaVeiculoPai.FirstOrDefault().ObservacaoCTe
                                .Replace("#PlacaVeiculo#", formatarPlacaComHifen ? listaVeiculoPai.FirstOrDefault().Placa_Formatada : listaVeiculoPai.FirstOrDefault().Placa)
                                .Replace("#RENAVAMVeiculo#", listaVeiculoPai.FirstOrDefault().Renavam)
                                .Replace("#NomeProprietarioVeiculo#", listaVeiculoPai.FirstOrDefault().Proprietario.Nome)
                                .Replace("#CPFCNPJProprietarioVeiculo#", listaVeiculoPai.FirstOrDefault().Proprietario.CPF_CNPJ.ToString())
                                .Replace("#RNTRCProprietario#", listaVeiculoPai.FirstOrDefault().RNTRC.ToString())
                                .Replace("#UFVeiculo#", listaVeiculoPai.FirstOrDefault().Estado.Sigla)
                                .Replace("#MarcaVeiculo#", listaVeiculoPai.FirstOrDefault().DescricaoMarca)
                                .Replace("#PlacasVinculadas#", placasVinculadas);
                    }
                }
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Erro buscando observação veiculos: " + ex);
            }

            return motoristasCTe;
        }

        private void SalvarInformacoesMotorista(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, List<Dominio.Entidades.MotoristaCTE> motoristasCTE, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.MotoristaCTE repMotoristaCTE = new Repositorio.MotoristaCTE(unitOfWork);
            if (motoristasCTE != null && motoristasCTE.Count > 0)
            {
                foreach (Dominio.Entidades.MotoristaCTE motoristaCTE in motoristasCTE)
                {
                    motoristaCTE.CTE = cte;
                    repMotoristaCTE.Inserir(motoristaCTE);
                }
            }
        }

        private void SalvarValoresFrete(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.Enumeradores.IncluiICMSFrete incluirICMS, decimal valorFrete, decimal valorAdicional, decimal valorPedagio, decimal valorAdicionalEntrega, decimal valorGris, decimal valorTAS, decimal valorDescarga, decimal valorAdvalorem, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ComponentePrestacaoCTE repComponentePrestacao = new Repositorio.ComponentePrestacaoCTE(unitOfWork);

            cte.ValorFrete = Math.Round(valorFrete, 2, MidpointRounding.ToEven);
            cte.ValorPrestacaoServico = Math.Round(cte.ValorFrete + valorPedagio + valorAdicionalEntrega + valorAdicional + valorGris, 2, MidpointRounding.ToEven);
            cte.ValorAReceber = Math.Round(cte.ValorFrete + valorPedagio + valorAdicionalEntrega + valorAdicional + valorGris, 2, MidpointRounding.ToEven);

            Dominio.Entidades.ComponentePrestacaoCTE componenteFreteValorCTe = new Dominio.Entidades.ComponentePrestacaoCTE();
            componenteFreteValorCTe.CTE = cte;
            componenteFreteValorCTe.IncluiNaBaseDeCalculoDoICMS = false;
            componenteFreteValorCTe.IncluiNoTotalAReceber = true;
            componenteFreteValorCTe.Nome = "FRETE VALOR";
            componenteFreteValorCTe.Valor = cte.ValorFrete;

            repComponentePrestacao.Inserir(componenteFreteValorCTe);

            if (valorPedagio > 0)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componentePedagioCTe = new Dominio.Entidades.ComponentePrestacaoCTE();
                componentePedagioCTe.CTE = cte;
                componentePedagioCTe.IncluiNaBaseDeCalculoDoICMS = cte.LocalidadeInicioPrestacao.Estado.Sigla == "PR" ? false : true;
                componentePedagioCTe.IncluiNoTotalAReceber = true;
                componentePedagioCTe.Nome = "PEDAGIO";
                componentePedagioCTe.Valor = Math.Round(valorPedagio, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componentePedagioCTe);
            }

            if (valorAdicionalEntrega > 0)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteAdicionalEntrega = new Dominio.Entidades.ComponentePrestacaoCTE();
                componenteAdicionalEntrega.CTE = cte;
                componenteAdicionalEntrega.IncluiNaBaseDeCalculoDoICMS = true;
                componenteAdicionalEntrega.IncluiNoTotalAReceber = true;
                componenteAdicionalEntrega.Nome = "SEGURO";
                componenteAdicionalEntrega.Valor = Math.Round(valorAdicionalEntrega, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componenteAdicionalEntrega);
            }

            if (valorAdicional > 0 || valorAdvalorem > 0)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteAdicionalValorCTe = new Dominio.Entidades.ComponentePrestacaoCTE();
                componenteAdicionalValorCTe.CTE = cte;
                componenteAdicionalValorCTe.IncluiNaBaseDeCalculoDoICMS = true;
                componenteAdicionalValorCTe.IncluiNoTotalAReceber = true;
                componenteAdicionalValorCTe.Nome = "AD VALOREM";
                componenteAdicionalValorCTe.Valor = Math.Round(valorAdicional + valorAdvalorem, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componenteAdicionalValorCTe);
            }

            if (valorGris > 0)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteGris = new Dominio.Entidades.ComponentePrestacaoCTE();
                componenteGris.CTE = cte;
                componenteGris.IncluiNaBaseDeCalculoDoICMS = true;
                componenteGris.IncluiNoTotalAReceber = true;
                componenteGris.Nome = "GRIS";
                componenteGris.Valor = Math.Round(valorGris, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componenteGris);
            }


            if (valorTAS > 0)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteTAS = new Dominio.Entidades.ComponentePrestacaoCTE();
                componenteTAS.CTE = cte;
                componenteTAS.IncluiNaBaseDeCalculoDoICMS = true;
                componenteTAS.IncluiNoTotalAReceber = true;
                componenteTAS.Nome = "TAS";
                componenteTAS.Valor = Math.Round(valorTAS, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componenteTAS);
            }

            if (valorDescarga > 0)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteDescarga = new Dominio.Entidades.ComponentePrestacaoCTE();
                componenteDescarga.CTE = cte;
                componenteDescarga.IncluiNaBaseDeCalculoDoICMS = true;
                componenteDescarga.IncluiNoTotalAReceber = true;
                componenteDescarga.Nome = "DESCARGA";
                componenteDescarga.Valor = Math.Round(valorDescarga, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componenteDescarga);
            }

            if (cte.AliquotaICMS > 0)
            {
                if (incluirICMS == Dominio.Enumeradores.IncluiICMSFrete.Sim)
                {
                    //this.CalcularInclusaoICMSNoFrete(ref cte, cte.ValorAReceber, cte.BaseCalculoICMS, cte.ValorAReceber, cte.AliquotaICMS, unitOfWork);

                    cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Sim;
                    cte.BaseCalculoICMS = cte.ValorAReceber;
                    cte.ValorICMS = Math.Round(cte.BaseCalculoICMS * (cte.AliquotaICMS / 100), 2, MidpointRounding.ToEven);
                    cte.PercentualICMSIncluirNoFrete = 100;

                    cte.BaseCalculoICMS = Math.Round(cte.ValorAReceber / (1 - (cte.AliquotaICMS / 100)), 2, MidpointRounding.ToEven);
                    cte.ValorICMS = Math.Round(cte.BaseCalculoICMS * (cte.AliquotaICMS / 100), 2, MidpointRounding.ToEven);

                    decimal valorImpostoIncluso = Math.Round(cte.BaseCalculoICMS - cte.ValorPrestacaoServico, 2, MidpointRounding.ToEven);
                    if (valorImpostoIncluso > 0)
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteImpostoCTe = new Dominio.Entidades.ComponentePrestacaoCTE();
                        componenteImpostoCTe.CTE = cte;
                        componenteImpostoCTe.IncluiNaBaseDeCalculoDoICMS = false;
                        componenteImpostoCTe.IncluiNoTotalAReceber = false;
                        componenteImpostoCTe.Nome = "IMPOSTOS";
                        componenteImpostoCTe.Valor = Math.Round(valorImpostoIncluso, 2, MidpointRounding.ToEven);

                        repComponentePrestacao.Inserir(componenteImpostoCTe);
                    }

                    cte.ValorPrestacaoServico = cte.BaseCalculoICMS;
                    cte.ValorAReceber = cte.BaseCalculoICMS;
                }
                else
                {
                    cte.IncluirICMSNoFrete = Dominio.Enumeradores.OpcaoSimNao.Nao;

                    //cte.BaseCalculoICMS = cte.ValorAReceber;
                    cte.BaseCalculoICMS = Math.Round(cte.ValorAReceber * (1 - (cte.PercentualReducaoBaseCalculoICMS / 100)), 2, MidpointRounding.ToEven);
                    cte.ValorICMS = Math.Round(cte.BaseCalculoICMS * (cte.AliquotaICMS / 100), 2, MidpointRounding.ToEven);
                }
            }
        }

        private void SalvarInformacoesDeSeguro(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.Entidades.ApoliceDeSeguro apoliceSeguro, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (apoliceSeguro != null)
            {
                Repositorio.SeguroCTE repSeguroCTE = new Repositorio.SeguroCTE(unidadeDeTrabalho);
                //Repositorio.ApoliceDeSeguro repApoliceSeguro = new Repositorio.ApoliceDeSeguro(unidadeDeTrabalho);

                Dominio.Entidades.SeguroCTE informacaoSeguro = new Dominio.Entidades.SeguroCTE();

                informacaoSeguro.NomeSeguradora = apoliceSeguro.NomeSeguradora;
                informacaoSeguro.NumeroApolice = apoliceSeguro.NumeroApolice;
                informacaoSeguro.CNPJSeguradora = apoliceSeguro.CNPJSeguradora;
                //informacaoSeguro.NumeroAverbacao = apoliceSeguro.NumeroAverberacao;
                informacaoSeguro.Tipo = apoliceSeguro.Responsavel == 0 ? Dominio.Enumeradores.TipoSeguro.Remetente :
                      apoliceSeguro.Responsavel == 1 ? Dominio.Enumeradores.TipoSeguro.Expedidor :
                      apoliceSeguro.Responsavel == 2 ? Dominio.Enumeradores.TipoSeguro.Recebedor :
                      apoliceSeguro.Responsavel == 3 ? Dominio.Enumeradores.TipoSeguro.Destinatario :
                      apoliceSeguro.Responsavel == 4 ? Dominio.Enumeradores.TipoSeguro.Emitente_CTE :
                      apoliceSeguro.Responsavel == 5 ? Dominio.Enumeradores.TipoSeguro.Tomador_Servico : Dominio.Enumeradores.TipoSeguro.Emitente_CTE;
                informacaoSeguro.Valor = cte.ValorTotalMercadoria;
                informacaoSeguro.CTE = cte;
                repSeguroCTE.Inserir(informacaoSeguro);

                if (!string.IsNullOrWhiteSpace(apoliceSeguro.CNPJResposavelNaObservacaoContribuinte))
                {
                    Repositorio.ObservacaoContribuinteCTE repObservacaoContribuinteCTE = new Repositorio.ObservacaoContribuinteCTE(unidadeDeTrabalho);
                    Dominio.Entidades.ObservacaoContribuinteCTE obsCont = repObservacaoContribuinteCTE.BuscarPorCTeEIdentificacaoEDescricao(cte.Codigo, "RESPSEG", apoliceSeguro.CNPJResposavelNaObservacaoContribuinte);
                    if (obsCont == null)
                    {
                        obsCont = new Dominio.Entidades.ObservacaoContribuinteCTE();
                        obsCont.CTE = cte;
                        obsCont.Identificador = "RESPSEG";
                        obsCont.Descricao = apoliceSeguro.CNPJResposavelNaObservacaoContribuinte;
                        repObservacaoContribuinteCTE.Inserir(obsCont);
                    }
                }
            }
        }

        public void NotificarCTeEnviado(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int quantidade, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            try
            {
                Email svcEmail = new Servicos.Email(unidadeDeTrabalho);

                string ambiente = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().IdentificacaoAmbiente;
                string assunto = ambiente + " - CT-e com status enviado";

                System.Text.StringBuilder sb = new System.Text.StringBuilder();
                sb.Append("<p>Atenção, CT-e com status enviado - ").Append(ambiente).Append(" - ").Append(DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss")).Append("<br /> <br />");
                if (cte != null)
                    sb.Append("CTe ").Append(cte.Numero).Append("/").Append(cte.Serie.Numero.ToString()).Append(" transportador ").Append(cte.Empresa.CNPJ).Append(" ").Append(cte.Empresa.RazaoSocial).Append("<br /> <br />");
                else if (quantidade > 0)
                    sb.Append("Existem ").Append(quantidade.ToString()).Append(" CTes com status Enviado.").Append("<br /> <br />");

                sb.Append("</p><br /> <br />");

                System.Text.StringBuilder ss = new System.Text.StringBuilder();
                ss.Append("MultiSoftware - http://www.multicte.com.br/ <br />");

#if DEBUG
                svcEmail.EnviarEmail(string.Empty, string.Empty, string.Empty, "infra@multisoftware.com.br", "", "", assunto, sb.ToString(), string.Empty, null, ss.ToString(), true, "cte1@multisoftware.com.br", 0, unidadeDeTrabalho);
#else
                svcEmail.EnviarEmail(string.Empty, string.Empty, string.Empty, "infra@multisoftware.com.br", "", "", assunto, sb.ToString(), string.Empty, null, ss.ToString(), true, "cte1@multisoftware.com.br", 0, unidadeDeTrabalho);
#endif
            }
            catch (Exception exptEmail)
            {
                Servicos.Log.TratarErro("Erro ao enviar e-mail notificação CT-e enviado:" + exptEmail);
            }
        }

        public string RetornarNumeroControleCTe(out int numeroSequencia, string numeroBooking, string descricaoCarrier, Dominio.Enumeradores.TipoPropostaFeeder tipoPropostaFeeder, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal tipoModal, Dominio.Enumeradores.TipoServico tipoServico, int codigoCTe, bool svmTerceiro, Repositorio.UnitOfWork unidadeDeTrabalho, bool aumentarNumeroSequencia = false, int sequenciaAnterior = 0, bool ignorarCTesImportados = false, int sequenciaAtual = 0)
        {
            numeroSequencia = 0;
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);

            if (tipoModal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Rodoviario)
            {
                return codigoCTe.ToString("D");
            }
            else if (!string.IsNullOrWhiteSpace(numeroBooking) && numeroBooking.Length >= 9)
            {
                int sequencia = 0;
                if (!aumentarNumeroSequencia && sequenciaAtual > 0)
                    sequencia = sequenciaAtual;
                else if (!aumentarNumeroSequencia)
                    sequencia = repCTe.BuscarSequenciaCTeBooking(codigoCTe, numeroBooking, tipoServico, ignorarCTesImportados);
                else
                    sequencia = sequenciaAnterior;

                Servicos.Log.TratarErro("1 - CodigoCTe " + codigoCTe.ToString(), "RetornarNumeroControleCTe");
                Servicos.Log.TratarErro("2 - Sequencia " + sequencia.ToString(), "RetornarNumeroControleCTe");
                Servicos.Log.TratarErro("2.1 - SequenciaAnterior " + sequenciaAnterior.ToString(), "RetornarNumeroControleCTe");

                if (aumentarNumeroSequencia)
                {
                    Servicos.Log.TratarErro("3 - AumentarNumeroSequencia SIM", "RetornarNumeroControleCTe");
                    sequencia += 1;
                }

                if (repCTe.ContemSequenciaControleDuplicado(codigoCTe, sequencia, numeroBooking, tipoServico, ignorarCTesImportados))
                {
                    sequencia += 1;
                    Servicos.Log.TratarErro("4 - ContemSequenciaControleDuplicado SIM", "RetornarNumeroControleCTe");
                }

                numeroSequencia = sequencia;
                string letraSequencia = this.SequenciaParaLetra(sequencia);
                if (!string.IsNullOrWhiteSpace(letraSequencia) && letraSequencia.Contains("M"))
                {
                    letraSequencia = this.SequenciaParaLetra(sequencia + 1);
                    numeroSequencia = sequencia + 1;
                    Servicos.Log.TratarErro("5 - ContemLetraM SIM", "RetornarNumeroControleCTe");
                }

                Servicos.Log.TratarErro("6 - SequenciaRetornada " + numeroSequencia.ToString(), "RetornarNumeroControleCTe");

                if (numeroBooking.Length >= 2 && char.IsLetter(numeroBooking[0]) && char.IsLetter(numeroBooking[1]))
                {
                    string siglaModal = "AQ";
                    string seqBooking = numeroBooking.Substring(4);

                    if (letraSequencia.Length == 2)
                    {
                        siglaModal = "A";
                    }
                    else if (letraSequencia.Length == 3)
                    {
                        siglaModal = "A";
                        seqBooking = seqBooking.Substring(1);
                    }

                    string numeroControle = siglaModal + seqBooking + letraSequencia;

                    Servicos.Log.TratarErro($"7 - Número Controle Duas Letras: {numeroControle}", "RetornarNumeroControleCTe");

                    return numeroControle;
                }
                else if (tipoModal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Multimodal)
                {
                    string siglaModal = "MTL";
                    string seqBooking = numeroBooking.Right(4);

                    siglaModal = letraSequencia.Length switch
                    {
                        1 => siglaModal,
                        2 => siglaModal.Substring(0, 2),
                        _ => siglaModal.Substring(0, 1)
                    };

                    return siglaModal + seqBooking + letraSequencia;
                }
                else if (tipoServico == Dominio.Enumeradores.TipoServico.ServVinculadoMultimodal && !svmTerceiro)
                {
                    string siglaModal = "SVM";
                    string seqBooking = numeroBooking.Right(4);

                    siglaModal = letraSequencia.Length switch
                    {
                        1 => siglaModal,
                        2 => siglaModal.Substring(0, 2),
                        _ => siglaModal.Substring(0, 1)
                    };

                    return siglaModal + seqBooking + letraSequencia;
                }
                else if (tipoModal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Aquaviario && !string.IsNullOrWhiteSpace(descricaoCarrier) && descricaoCarrier.Length == 2)
                {
                    string siglaModal = numeroBooking.Substring(1, 1) + descricaoCarrier;
                    string seqBooking = numeroBooking.Right(4);

                    siglaModal = letraSequencia.Length switch
                    {
                        1 => siglaModal,
                        2 when siglaModal.Length >= 2 => siglaModal.Substring(0, 2),
                        _ => siglaModal.Substring(0, 1)
                    };

                    return siglaModal + seqBooking + letraSequencia;
                }
                else if (tipoPropostaFeeder == Dominio.Enumeradores.TipoPropostaFeeder.Alianca ||
                        tipoPropostaFeeder == Dominio.Enumeradores.TipoPropostaFeeder.Mercosul)
                {
                    string siglaModal = numeroBooking.Substring(1, 1);
                    string seqBooking = numeroBooking.Substring(4, numeroBooking.Length - 4);

                    if (numeroBooking.Length == 11)
                        seqBooking = seqBooking.Remove(0, 1);

                    return siglaModal + (letraSequencia.Length == 2 ? seqBooking.Substring(1) : seqBooking) + letraSequencia;
                }
                else if (tipoPropostaFeeder == Dominio.Enumeradores.TipoPropostaFeeder.HSBR)
                {
                    string siglaModal = numeroBooking.Substring(1, 2);
                    string seqBooking = numeroBooking.Substring(5);

                    return siglaModal + (letraSequencia.Length == 2 ? seqBooking.Substring(1) : seqBooking) + letraSequencia;
                }
                else if (tipoPropostaFeeder == Dominio.Enumeradores.TipoPropostaFeeder.Outros)
                {
                    descricaoCarrier = numeroBooking.Substring(4, 2);
                    string siglaModal = numeroBooking.Substring(1, 1) + descricaoCarrier;
                    string seqBooking = numeroBooking.Right(4);

                    return siglaModal + (letraSequencia.Length == 2 ? seqBooking.Substring(1) : seqBooking) + letraSequencia;
                }
            }

            return codigoCTe.ToString("D");
        }

        public void SalvarIntegracaoRetornoCTe(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.Entidades.Empresa empresa, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.CTeIntegracaoRetorno repCTeIntegracaoRetorno = new Repositorio.CTeIntegracaoRetorno(unidadeDeTrabalho);
            if (empresa.EmpresaPai?.TiposIntegracao != null && empresa.EmpresaPai?.TiposIntegracao.Count > 0)
            {
                foreach (Dominio.Entidades.Embarcador.Cargas.TipoIntegracao tipoIntegracao in empresa.EmpresaPai?.TiposIntegracao)
                {
                    if (tipoIntegracao.Ativo && tipoIntegracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Magalog ||
                        tipoIntegracao.Ativo && tipoIntegracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.MagalogEscrituracao)
                    {
                        Dominio.Entidades.CTeIntegracaoRetorno cteIntegracaoRetorno = repCTeIntegracaoRetorno.BuscarUltipoPorPorCTeTipo(cte.Codigo, tipoIntegracao.Tipo);

                        if (cteIntegracaoRetorno == null)
                        {
                            cteIntegracaoRetorno = new Dominio.Entidades.CTeIntegracaoRetorno();
                            cteIntegracaoRetorno.SituacaoIntegracao = Dominio.Enumeradores.SituacaoCTeIntegracaoRetorno.Aguardando;
                            cteIntegracaoRetorno.CTe = cte;
                            cteIntegracaoRetorno.TipoIntegracao = tipoIntegracao;
                            repCTeIntegracaoRetorno.Inserir(cteIntegracaoRetorno);
                        }
                        else
                        {
                            cteIntegracaoRetorno.SituacaoIntegracao = Dominio.Enumeradores.SituacaoCTeIntegracaoRetorno.Aguardando;
                            repCTeIntegracaoRetorno.Atualizar(cteIntegracaoRetorno);
                        }
                    }
                }
            }

            if (!string.IsNullOrWhiteSpace(empresa.Configuracao?.WsIntegracaoEnvioCTeEmbarcadorTMS))
            {
                Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unidadeDeTrabalho);
                Dominio.Entidades.Embarcador.Cargas.TipoIntegracao tipoIntegracao = repTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.MultiEmbarcador);
                if (tipoIntegracao == null)
                {
                    tipoIntegracao = new Dominio.Entidades.Embarcador.Cargas.TipoIntegracao();
                    tipoIntegracao.Descricao = "MultiEmbarcador TMS";
                    tipoIntegracao.Tipo = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.MultiEmbarcador;
                    tipoIntegracao.Ativo = true;
                    repTipoIntegracao.Inserir(tipoIntegracao);
                }

                Dominio.Entidades.CTeIntegracaoRetorno cteIntegracaoRetorno = repCTeIntegracaoRetorno.BuscarUltipoPorPorCTeTipo(cte.Codigo, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.MultiEmbarcador);
                if (cteIntegracaoRetorno == null)
                {
                    cteIntegracaoRetorno = new Dominio.Entidades.CTeIntegracaoRetorno();
                    cteIntegracaoRetorno.SituacaoIntegracao = Dominio.Enumeradores.SituacaoCTeIntegracaoRetorno.Aguardando;
                    cteIntegracaoRetorno.CTe = cte;
                    cteIntegracaoRetorno.TipoIntegracao = tipoIntegracao;
                    repCTeIntegracaoRetorno.Inserir(cteIntegracaoRetorno);
                }
                else
                {
                    cteIntegracaoRetorno.SituacaoIntegracao = Dominio.Enumeradores.SituacaoCTeIntegracaoRetorno.Aguardando;
                    repCTeIntegracaoRetorno.Atualizar(cteIntegracaoRetorno);
                }
            }
        }

        public void AtualizarIntegracaoRetornoCTe(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.CTeIntegracaoRetorno repCTeIntegracaoRetorno = new Repositorio.CTeIntegracaoRetorno(unidadeDeTrabalho);
            List<Dominio.Entidades.CTeIntegracaoRetorno> listaIntegracoes = repCTeIntegracaoRetorno.BuscarPorCTe(cte.Codigo);
            foreach (Dominio.Entidades.CTeIntegracaoRetorno integracao in listaIntegracoes)
            {
                integracao.NumeroTentativas = 0;
                integracao.ProblemaIntegracao = string.Empty;
                integracao.SituacaoIntegracao = Dominio.Enumeradores.SituacaoCTeIntegracaoRetorno.Aguardando;
                repCTeIntegracaoRetorno.Inserir(integracao);
            }
        }

        public Dominio.Entidades.Cliente ObterEmitente(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteEmit infCteEmit, int codigoEmpresa, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);

            double cnpj = double.Parse(Utilidades.String.OnlyNumbers(infCteEmit.CNPJ));

            bool inserir = false;

            Dominio.Entidades.Cliente cliente = repCliente.BuscarPorCPFCNPJ(cnpj);

            if (cliente == null)
            {
                cliente = new Dominio.Entidades.Cliente();
                cliente.CPF_CNPJ = cnpj;
                inserir = true;
            }
            else if (cliente.NaoAtualizarDados)
                return cliente;

            cliente.Bairro = infCteEmit.enderEmit.xBairro.Length > 2 ? infCteEmit.enderEmit.xBairro.Length > 40 ? infCteEmit.enderEmit.xBairro.Substring(0, 40) : infCteEmit.enderEmit.xBairro : "Não Informado";
            cliente.CEP = infCteEmit.enderEmit.CEP;
            cliente.Complemento = infCteEmit.enderEmit.xCpl;

            cliente.Endereco = infCteEmit.enderEmit.xLgr;

            if (infCteEmit.IE != null && infCteEmit.IE != "")
                cliente.IE_RG = infCteEmit.IE;
            else
                cliente.IE_RG = "ISENTO";

            cliente.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infCteEmit.enderEmit.cMun));
            cliente.Nome = Utilidades.String.RemoveAllSpecialCharacters(infCteEmit.xNome);
            cliente.NomeFantasia = infCteEmit.xFant;
            cliente.Numero = string.IsNullOrWhiteSpace(infCteEmit.enderEmit.nro) ? "S/N" : infCteEmit.enderEmit.nro;

            string telefone = string.IsNullOrWhiteSpace(infCteEmit.enderEmit.fone) || infCteEmit.enderEmit.fone.StartsWith("00") ? string.Empty : infCteEmit.enderEmit.fone;

            if (telefone.Length <= 15)
                cliente.Telefone1 = telefone;

            cliente.Tipo = "J";
            cliente.DataUltimaAtualizacao = DateTime.Now;
            cliente.Integrado = false;

            if (cliente.Atividade == null)
                cliente.Atividade = Atividade.ObterAtividade(codigoEmpresa, cliente.Tipo, StringConexao, 0, unidadeDeTrabalho);

            if (cliente.Tipo == "F" && cliente.Atividade.Codigo == 7 && string.IsNullOrWhiteSpace(cliente.IE_RG))
                cliente.IE_RG = "ISENTO";

            if (inserir)
            {
                if (cliente.Tipo == "J" && cliente.GrupoPessoas == null)
                {
                    Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeDeTrabalho);
                    Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(cliente.CPF_CNPJ_Formatado).Remove(8, 6));
                    if (grupoPessoas != null)
                        cliente.GrupoPessoas = grupoPessoas;
                }
                if (cliente.IE_RG == "ISENTO")
                    cliente.IndicadorIE = IndicadorIE.NaoContribuinte;
                else
                    cliente.IndicadorIE = IndicadorIE.ContribuinteICMS;
                cliente.Ativo = true;
                cliente.AguardandoConferenciaInformacao = true;
                cliente.DataCadastro = DateTime.Now;

                repCliente.Inserir(cliente);
            }
            else if (!cliente.NaoAtualizarDados)
            {
                cliente.DataUltimaAtualizacao = DateTime.Now;
                cliente.Integrado = false;
                repCliente.Atualizar(cliente);
            }

            return cliente;
        }

        public Dominio.Entidades.Cliente ObterEmitente(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteEmit infCteEmit, int codigoEmpresa, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);

            double cnpj = double.Parse(Utilidades.String.OnlyNumbers(infCteEmit.Item));

            bool inserir = false;

            Dominio.Entidades.Cliente cliente = repCliente.BuscarPorCPFCNPJ(cnpj);

            if (cliente == null)
            {
                cliente = new Dominio.Entidades.Cliente();
                cliente.CPF_CNPJ = cnpj;
                inserir = true;
            }
            else if (cliente.NaoAtualizarDados)
                return cliente;

            cliente.Bairro = infCteEmit.enderEmit.xBairro.Length > 2 ? infCteEmit.enderEmit.xBairro.Length > 40 ? infCteEmit.enderEmit.xBairro.Substring(0, 40) : infCteEmit.enderEmit.xBairro : "Não Informado";
            cliente.CEP = infCteEmit.enderEmit.CEP;
            cliente.Complemento = infCteEmit.enderEmit.xCpl;

            cliente.Endereco = infCteEmit.enderEmit.xLgr;

            if (infCteEmit.IE != null && infCteEmit.IE != "")
                cliente.IE_RG = infCteEmit.IE;
            else
                cliente.IE_RG = "ISENTO";

            cliente.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infCteEmit.enderEmit.cMun));
            cliente.Nome = Utilidades.String.RemoveAllSpecialCharacters(infCteEmit.xNome);
            cliente.NomeFantasia = infCteEmit.xFant;
            cliente.Numero = string.IsNullOrWhiteSpace(infCteEmit.enderEmit.nro) ? "S/N" : infCteEmit.enderEmit.nro;

            string telefone = string.IsNullOrWhiteSpace(infCteEmit.enderEmit.fone) || infCteEmit.enderEmit.fone.StartsWith("00") ? string.Empty : infCteEmit.enderEmit.fone;

            if (telefone.Length <= 15)
                cliente.Telefone1 = telefone;

            cliente.Tipo = "J";
            cliente.DataUltimaAtualizacao = DateTime.Now;
            cliente.Integrado = false;

            if (cliente.Atividade == null)
                cliente.Atividade = Atividade.ObterAtividade(codigoEmpresa, cliente.Tipo, StringConexao, 0, unidadeDeTrabalho);

            if (cliente.Tipo == "F" && cliente.Atividade.Codigo == 7 && string.IsNullOrWhiteSpace(cliente.IE_RG))
                cliente.IE_RG = "ISENTO";

            if (inserir)
            {
                if (cliente.Tipo == "J" && cliente.GrupoPessoas == null)
                {
                    Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeDeTrabalho);
                    Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(cliente.CPF_CNPJ_Formatado).Remove(8, 6));
                    if (grupoPessoas != null)
                        cliente.GrupoPessoas = grupoPessoas;
                }
                if (cliente.IE_RG == "ISENTO")
                    cliente.IndicadorIE = IndicadorIE.NaoContribuinte;
                else
                    cliente.IndicadorIE = IndicadorIE.ContribuinteICMS;
                cliente.Ativo = true;
                cliente.AguardandoConferenciaInformacao = true;
                cliente.DataCadastro = DateTime.Now;

                repCliente.Inserir(cliente);
            }
            else if (!cliente.NaoAtualizarDados)
            {
                cliente.DataUltimaAtualizacao = DateTime.Now;
                cliente.Integrado = false;
                repCliente.Atualizar(cliente);
            }

            return cliente;
        }

        public Dominio.Entidades.Cliente ObterExpedidor(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteExped infCteExped, int codigoEmpresa, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCteExped == null)
                return null;

            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);

            double cpfCnpj = double.Parse(Utilidades.String.OnlyNumbers(infCteExped.Item));
            if (cpfCnpj == 0D)
                return null;

            bool inserir = false;

            Dominio.Entidades.Cliente cliente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);

            if (cliente == null)
            {
                cliente = new Dominio.Entidades.Cliente();
                cliente.CPF_CNPJ = cpfCnpj;
                inserir = true;
            }
            else if (cliente.NaoAtualizarDados)
                return cliente;

            cliente.Bairro = infCteExped.enderExped.xBairro.Length > 2 ? infCteExped.enderExped.xBairro.Length > 40 ? infCteExped.enderExped.xBairro.Substring(0, 40) : infCteExped.enderExped.xBairro : "Não Informado";
            cliente.CEP = infCteExped.enderExped.CEP;
            cliente.Complemento = infCteExped.enderExped.xCpl;
            cliente.Endereco = infCteExped.enderExped.xLgr;

            if (infCteExped.IE != null && infCteExped.IE != "")
                cliente.IE_RG = infCteExped.IE;
            else
                cliente.IE_RG = "ISENTO";

            cliente.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infCteExped.enderExped.cMun));
            cliente.Nome = Utilidades.String.RemoveAllSpecialCharacters(infCteExped.xNome);
            cliente.Numero = string.IsNullOrWhiteSpace(infCteExped.enderExped.nro) ? "S/N" : infCteExped.enderExped.nro;

            string telefone = string.IsNullOrWhiteSpace(infCteExped.fone) || infCteExped.fone.StartsWith("00") ? string.Empty : infCteExped.fone;

            if (telefone.Length <= 15)
                cliente.Telefone1 = telefone;

            cliente.Tipo = Utilidades.String.OnlyNumbers(infCteExped.Item).Length == 14 ? "J" : "F";

            if (cliente.Atividade == null)
                cliente.Atividade = Atividade.ObterAtividade(codigoEmpresa, cliente.Tipo, StringConexao, 0, unidadeDeTrabalho);

            if (cliente.Tipo == "F" && cliente.Atividade.Codigo == 7 && string.IsNullOrWhiteSpace(cliente.IE_RG))
                cliente.IE_RG = "ISENTO";

            if (inserir)
            {
                if (cliente.Tipo == "J" && cliente.GrupoPessoas == null)
                {
                    Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeDeTrabalho);
                    Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(cliente.CPF_CNPJ_Formatado).Remove(8, 6));
                    if (grupoPessoas != null)
                        cliente.GrupoPessoas = grupoPessoas;
                }
                if (cliente.IE_RG == "ISENTO")
                    cliente.IndicadorIE = IndicadorIE.NaoContribuinte;
                else
                    cliente.IndicadorIE = IndicadorIE.ContribuinteICMS;
                cliente.Ativo = true;
                cliente.AguardandoConferenciaInformacao = true;
                cliente.DataCadastro = DateTime.Now;
                repCliente.Inserir(cliente);
            }
            else if (!cliente.NaoAtualizarDados)
            {
                cliente.DataUltimaAtualizacao = DateTime.Now;
                cliente.Integrado = false;
                repCliente.Atualizar(cliente);
            }

            return cliente;
        }

        public Dominio.Entidades.Cliente ObterExpedidor(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteExped infCteExped, int codigoEmpresa, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCteExped == null)
                return null;

            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);

            double cpfCnpj = double.Parse(Utilidades.String.OnlyNumbers(infCteExped.Item));
            if (cpfCnpj == 0D)
                return null;

            bool inserir = false;

            Dominio.Entidades.Cliente cliente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);

            if (cliente == null)
            {
                cliente = new Dominio.Entidades.Cliente();
                cliente.CPF_CNPJ = cpfCnpj;
                inserir = true;
            }
            else if (cliente.NaoAtualizarDados)
                return cliente;

            cliente.Bairro = infCteExped.enderExped.xBairro.Length > 2 ? infCteExped.enderExped.xBairro.Length > 40 ? infCteExped.enderExped.xBairro.Substring(0, 40) : infCteExped.enderExped.xBairro : "Não Informado";
            cliente.CEP = infCteExped.enderExped.CEP;
            cliente.Complemento = infCteExped.enderExped.xCpl;
            cliente.Endereco = infCteExped.enderExped.xLgr;

            if (infCteExped.IE != null && infCteExped.IE != "")
                cliente.IE_RG = infCteExped.IE;
            else
                cliente.IE_RG = "ISENTO";

            cliente.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infCteExped.enderExped.cMun));
            cliente.Nome = Utilidades.String.RemoveAllSpecialCharacters(infCteExped.xNome);
            cliente.Numero = string.IsNullOrWhiteSpace(infCteExped.enderExped.nro) ? "S/N" : infCteExped.enderExped.nro;

            string telefone = string.IsNullOrWhiteSpace(infCteExped.fone) || infCteExped.fone.StartsWith("00") ? string.Empty : infCteExped.fone;

            if (telefone.Length <= 15)
                cliente.Telefone1 = telefone;

            cliente.Tipo = Utilidades.String.OnlyNumbers(infCteExped.Item).Length == 14 ? "J" : "F";

            if (cliente.Atividade == null)
                cliente.Atividade = Atividade.ObterAtividade(codigoEmpresa, cliente.Tipo, StringConexao, 0, unidadeDeTrabalho);

            if (cliente.Tipo == "F" && cliente.Atividade.Codigo == 7 && string.IsNullOrWhiteSpace(cliente.IE_RG))
                cliente.IE_RG = "ISENTO";

            if (inserir)
            {
                if (cliente.Tipo == "J" && cliente.GrupoPessoas == null)
                {
                    Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeDeTrabalho);
                    Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(cliente.CPF_CNPJ_Formatado).Remove(8, 6));
                    if (grupoPessoas != null)
                        cliente.GrupoPessoas = grupoPessoas;
                }
                if (cliente.IE_RG == "ISENTO")
                    cliente.IndicadorIE = IndicadorIE.NaoContribuinte;
                else
                    cliente.IndicadorIE = IndicadorIE.ContribuinteICMS;
                cliente.Ativo = true;
                cliente.AguardandoConferenciaInformacao = true;
                cliente.DataCadastro = DateTime.Now;
                repCliente.Inserir(cliente);
            }
            else if (!cliente.NaoAtualizarDados)
            {
                cliente.DataUltimaAtualizacao = DateTime.Now;
                cliente.Integrado = false;
                repCliente.Atualizar(cliente);
            }

            return cliente;
        }

        public Dominio.Entidades.Cliente ObterRecebedor(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteReceb infCteReceb, int codigoEmpresa, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCteReceb == null)
                return null;

            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);

            double cpfCnpj = double.Parse(Utilidades.String.OnlyNumbers(infCteReceb.Item));
            if (cpfCnpj == 0D)
                return null;

            bool inserir = false;

            Dominio.Entidades.Cliente cliente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);

            if (cliente == null)
            {
                cliente = new Dominio.Entidades.Cliente();
                cliente.CPF_CNPJ = cpfCnpj;
                inserir = true;
            }
            else if (cliente.NaoAtualizarDados)
                return cliente;

            cliente.Bairro = infCteReceb.enderReceb.xBairro.Length > 2 ? infCteReceb.enderReceb.xBairro.Length > 40 ? infCteReceb.enderReceb.xBairro.Substring(0, 40) : infCteReceb.enderReceb.xBairro : "Não Informado";
            cliente.CEP = infCteReceb.enderReceb.CEP;
            cliente.Complemento = infCteReceb.enderReceb.xCpl;
            cliente.Endereco = infCteReceb.enderReceb.xLgr;

            if (infCteReceb.IE != null && infCteReceb.IE != "")
                cliente.IE_RG = infCteReceb.IE;
            else
                cliente.IE_RG = "ISENTO";

            cliente.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infCteReceb.enderReceb.cMun));
            cliente.Nome = Utilidades.String.RemoveAllSpecialCharacters(infCteReceb.xNome);
            cliente.Numero = string.IsNullOrWhiteSpace(infCteReceb.enderReceb.nro) ? "S/N" : infCteReceb.enderReceb.nro;

            string telefone = string.IsNullOrWhiteSpace(infCteReceb.fone) || infCteReceb.fone.StartsWith("00") ? string.Empty : infCteReceb.fone;

            if (telefone.Length <= 15)
                cliente.Telefone1 = telefone;

            cliente.Tipo = Utilidades.String.OnlyNumbers(infCteReceb.Item).Length == 14 ? "J" : "F";

            if (cliente.Atividade == null)
                cliente.Atividade = Atividade.ObterAtividade(codigoEmpresa, cliente.Tipo, StringConexao, 0, unidadeDeTrabalho);

            if (cliente.Tipo == "F" && cliente.Atividade.Codigo == 7 && string.IsNullOrWhiteSpace(cliente.IE_RG))
                cliente.IE_RG = "ISENTO";

            if (inserir)
            {
                if (cliente.Tipo == "J" && cliente.GrupoPessoas == null)
                {
                    Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeDeTrabalho);
                    Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(cliente.CPF_CNPJ_Formatado).Remove(8, 6));
                    if (grupoPessoas != null)
                        cliente.GrupoPessoas = grupoPessoas;
                }
                if (cliente.IE_RG == "ISENTO")
                    cliente.IndicadorIE = IndicadorIE.NaoContribuinte;
                else
                    cliente.IndicadorIE = IndicadorIE.ContribuinteICMS;
                cliente.Ativo = true;
                cliente.AguardandoConferenciaInformacao = true;
                cliente.DataCadastro = DateTime.Now;
                cliente.DataUltimaAtualizacao = DateTime.Now;
                cliente.Integrado = false;
                repCliente.Inserir(cliente);
            }
            else if (!cliente.NaoAtualizarDados)
            {
                cliente.DataUltimaAtualizacao = DateTime.Now;
                cliente.Integrado = false;
                repCliente.Atualizar(cliente);
            }

            return cliente;
        }

        public Dominio.Entidades.Cliente ObterRecebedor(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteReceb infCteReceb, int codigoEmpresa, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCteReceb == null)
                return null;

            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);

            double cpfCnpj = double.Parse(Utilidades.String.OnlyNumbers(infCteReceb.Item));
            if (cpfCnpj == 0D)
                return null;

            bool inserir = false;

            Dominio.Entidades.Cliente cliente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);

            if (cliente == null)
            {
                cliente = new Dominio.Entidades.Cliente();
                cliente.CPF_CNPJ = cpfCnpj;
                inserir = true;
            }
            else if (cliente.NaoAtualizarDados)
                return cliente;

            cliente.Bairro = infCteReceb.enderReceb.xBairro.Length > 2 ? infCteReceb.enderReceb.xBairro.Length > 40 ? infCteReceb.enderReceb.xBairro.Substring(0, 40) : infCteReceb.enderReceb.xBairro : "Não Informado";
            cliente.CEP = infCteReceb.enderReceb.CEP;
            cliente.Complemento = infCteReceb.enderReceb.xCpl;
            cliente.Endereco = infCteReceb.enderReceb.xLgr;

            if (infCteReceb.IE != null && infCteReceb.IE != "")
                cliente.IE_RG = infCteReceb.IE;
            else
                cliente.IE_RG = "ISENTO";

            cliente.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infCteReceb.enderReceb.cMun));
            cliente.Nome = Utilidades.String.RemoveAllSpecialCharacters(infCteReceb.xNome);
            cliente.Numero = string.IsNullOrWhiteSpace(infCteReceb.enderReceb.nro) ? "S/N" : infCteReceb.enderReceb.nro;

            string telefone = string.IsNullOrWhiteSpace(infCteReceb.fone) || infCteReceb.fone.StartsWith("00") ? string.Empty : infCteReceb.fone;

            if (telefone.Length <= 15)
                cliente.Telefone1 = telefone;

            cliente.Tipo = Utilidades.String.OnlyNumbers(infCteReceb.Item).Length == 14 ? "J" : "F";

            if (cliente.Atividade == null)
                cliente.Atividade = Atividade.ObterAtividade(codigoEmpresa, cliente.Tipo, StringConexao, 0, unidadeDeTrabalho);

            if (cliente.Tipo == "F" && cliente.Atividade.Codigo == 7 && string.IsNullOrWhiteSpace(cliente.IE_RG))
                cliente.IE_RG = "ISENTO";

            if (inserir)
            {
                if (cliente.Tipo == "J" && cliente.GrupoPessoas == null)
                {
                    Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeDeTrabalho);
                    Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(cliente.CPF_CNPJ_Formatado).Remove(8, 6));
                    if (grupoPessoas != null)
                        cliente.GrupoPessoas = grupoPessoas;
                }
                if (cliente.IE_RG == "ISENTO")
                    cliente.IndicadorIE = IndicadorIE.NaoContribuinte;
                else
                    cliente.IndicadorIE = IndicadorIE.ContribuinteICMS;
                cliente.Ativo = true;
                cliente.AguardandoConferenciaInformacao = true;
                cliente.DataCadastro = DateTime.Now;
                cliente.DataUltimaAtualizacao = DateTime.Now;
                cliente.Integrado = false;
                repCliente.Inserir(cliente);
            }
            else if (!cliente.NaoAtualizarDados)
            {
                cliente.DataUltimaAtualizacao = DateTime.Now;
                cliente.Integrado = false;
                repCliente.Atualizar(cliente);
            }

            return cliente;
        }

        public void ProcessarCTeMultiCTe(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            try
            {
                string configWebServiceConsultaCTe = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().WebServiceConsultaCTe;
                bool configProcessarCTeMultiCTe = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().ProcessarCTeMultiCTe.HasValue ? Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().ProcessarCTeMultiCTe.Value : false;

                if (!configProcessarCTeMultiCTe)
                    return;

                if (cte.SistemaEmissor == TipoEmissorDocumento.NSTech)
                    new Servicos.Averbacao(unidadeDeTrabalho).VerificarAverbacaoEmbarcador(cte, unidadeDeTrabalho);
                else if (!string.IsNullOrWhiteSpace(configWebServiceConsultaCTe))
                {
                    bool averbaCTe = (cte.Empresa.Configuracao != null && cte.Empresa.Configuracao.AverbaAutomaticoATM == 1) || (cte.Empresa.Configuracao != null && cte.Empresa.EmpresaPai != null && cte.Empresa.EmpresaPai.Configuracao != null && cte.Empresa.EmpresaPai.Configuracao.AverbaAutomaticoATM == 1);

                    if (averbaCTe && cte.Empresa.Configuracao != null)
                    {
                        if (cte.Empresa.Configuracao.TipoCTeAverbacao == Dominio.Enumeradores.TipoCTEAverbacao.Todos)
                            averbaCTe = true;
                        else if (cte.TipoServico == Dominio.Enumeradores.TipoServico.Normal)
                            averbaCTe = cte.Empresa.Configuracao.TipoCTeAverbacao == Dominio.Enumeradores.TipoCTEAverbacao.ApenasNormal;
                        else if (cte.TipoServico == Dominio.Enumeradores.TipoServico.SubContratacao)
                            averbaCTe = cte.Empresa.Configuracao.TipoCTeAverbacao == Dominio.Enumeradores.TipoCTEAverbacao.ApenasSubcontratacao;
                        else if (cte.TipoServico == Dominio.Enumeradores.TipoServico.Redespacho)
                            averbaCTe = cte.Empresa.Configuracao.TipoCTeAverbacao == Dominio.Enumeradores.TipoCTEAverbacao.ApenasRedespacho;
                        else if (cte.TipoServico == Dominio.Enumeradores.TipoServico.RedIntermediario)
                            averbaCTe = cte.Empresa.Configuracao.TipoCTeAverbacao == Dominio.Enumeradores.TipoCTEAverbacao.ApenasRedIntermediario;
                        else if (cte.TipoServico == Dominio.Enumeradores.TipoServico.ServVinculadoMultimodal)
                            averbaCTe = cte.Empresa.Configuracao.TipoCTeAverbacao == Dominio.Enumeradores.TipoCTEAverbacao.ApenasServVinculadoMultimodal;
                        else if (cte.TipoServico == Dominio.Enumeradores.TipoServico.TransporteDePessoas)
                            averbaCTe = cte.Empresa.Configuracao.TipoCTeAverbacao == Dominio.Enumeradores.TipoCTEAverbacao.ApenasTransporteDePessoas;
                        else if (cte.TipoServico == Dominio.Enumeradores.TipoServico.TransporteDeValores)
                            averbaCTe = cte.Empresa.Configuracao.TipoCTeAverbacao == Dominio.Enumeradores.TipoCTEAverbacao.ApenasTransporteDeValores;
                        else if (cte.TipoServico == Dominio.Enumeradores.TipoServico.ExcessoDeBagagem)
                            averbaCTe = cte.Empresa.Configuracao.TipoCTeAverbacao == Dominio.Enumeradores.TipoCTEAverbacao.ApenasExcessoDeBagagem;
                    }

                    if (averbaCTe && cte.TipoCTE == Dominio.Enumeradores.TipoCTE.Normal)
                    {
                        Servicos.Averbacao svcAverbacao = new Servicos.Averbacao(unidadeDeTrabalho);
                        if (svcAverbacao.VerificaAverbacao(cte.Codigo, Dominio.Enumeradores.TipoAverbacaoCTe.Autorizacao, unidadeDeTrabalho))
                            AdicionarAverbacaoNaFilaDeConsulta(cte, configWebServiceConsultaCTe);
                    }

                    Servicos.LsTranslog svcLsTranslog = new Servicos.LsTranslog(unidadeDeTrabalho);
                    svcLsTranslog.SalvarCTeParaIntegracao(cte.Codigo, cte.Empresa.Codigo, unidadeDeTrabalho);

                    Servicos.CIOT svcCIOT = new Servicos.CIOT(unidadeDeTrabalho);
                    svcCIOT.VincularCTeCIOTEFrete(cte.Codigo, unidadeDeTrabalho);
                }
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro(ex, "ProcessarCTeMultiCTe");
            }
        }

        public void ProcessarRetornoCTeAutorizado(Dominio.ObjetosDeValor.WebService.CTe.CTeOracle cteOracle, Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado Auditado, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {
            bool autorizadoFSDA = false;

            Servicos.Embarcador.CTe.CTe serCTeTerceiro = new Servicos.Embarcador.CTe.CTe(unitOfWork);
            Servicos.Embarcador.Carga.CTeSubContratacao serCTeSubContratacao = new Servicos.Embarcador.Carga.CTeSubContratacao(unitOfWork);
            Servicos.Embarcador.Integracao.IntegracaoCarga serCargaIntegracao = new Servicos.Embarcador.Integracao.IntegracaoCarga(unitOfWork);
            Servicos.Embarcador.Carga.CargaCTe servicoCargaCTe = new Servicos.Embarcador.Carga.CargaCTe(unitOfWork);

            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoSGT = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);
            Repositorio.Embarcador.Cargas.TipoIntegracao repTipoIntegracao = new Repositorio.Embarcador.Cargas.TipoIntegracao(unitOfWork);
            Repositorio.ErroSefaz repErroSefaz = new Repositorio.ErroSefaz(unitOfWork);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Repositorio.Embarcador.CTe.CTeTerceiro repCTeTerceiro = new Repositorio.Embarcador.CTe.CTeTerceiro(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoGeral repositorioConfiguracaoGeral = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeral(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga repositorioConfiguracaoGeralCarga = new Repositorio.Embarcador.Configuracoes.ConfiguracaoGeralCarga(unitOfWork);
            Repositorio.Estado repositorioEstado = new Repositorio.Estado(unitOfWork);
            Repositorio.CTeRetornoSefaz repositorioCTeRetornoSefaz = new Repositorio.CTeRetornoSefaz(unitOfWork);

            bool armazenarEmArquivo = repConfiguracaoSGT.ArmazenarXMLCTeEmArquivo();
            bool utilizaEmissaoMultimodal = repConfiguracaoSGT.UtilizaEmissaoMultimodal();
            bool consultarDuplicidadeOracle = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoAmbiente().ConsultarDuplicidadeOracle.Value;
            bool autorizarAverbacao = false, cancelarAverbacao = false;

            int statusCTe = 0;
            int.TryParse(string.IsNullOrWhiteSpace(cteOracle.CodStatusProtocolo) ? cteOracle.CodStatusEnvio : cteOracle.CodStatusProtocolo, out statusCTe);

            unitOfWork.Start();

            try
            {
                if (cte.Status == "E" || cte.Status == "Y" || cte.Status == "F")
                {
                    bool permiteHabilitarContingenciaEPECAutomaticamente = repositorioConfiguracaoGeralCarga.ExistePermiteHabilitarContingenciaEPECAutomaticamente();

                    DateTime dataProtocolo;
                    DateTime.TryParseExact(cteOracle.DataProtocolo, "dd/MM/yyyy HH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataProtocolo);

                    DateTime dataRecibo;
                    DateTime.TryParseExact(cteOracle.DataRecibo, "dd/MM/yyyy HH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataRecibo);

                    bool duplicidade = false;

                    cte.MensagemStatus = repErroSefaz.BuscarPorCodigoDoErro(statusCTe, Dominio.Enumeradores.TipoErroSefaz.CTe);

                    if (cteOracle.StatusIntegrador.Equals("E"))
                    {
                        if (consultarDuplicidadeOracle && cteOracle.CodStatusEnvio != null && cteOracle.CodStatusEnvio.Equals("204") && (cte.SistemaEmissor ?? TipoEmissorDocumento.Integrador) == TipoEmissorDocumento.Integrador)
                        {
                            this.ConsultarDuplicidade(ref cte, unitOfWork);

                            duplicidade = true;
                        }
                        else if (cteOracle.CodStatusProtocolo != null && (cteOracle.CodStatusProtocolo.Equals("110") || cteOracle.CodStatusProtocolo.Equals("301") || cteOracle.CodStatusProtocolo.Equals("205")))
                        {
                            DateTime dataAutorizacao = dataProtocolo != DateTime.MinValue ? dataProtocolo : DateTime.Now;

                            cte.Protocolo = cteOracle.NumeroProtocolo;
                            cte.DataRetornoSefaz = dataAutorizacao;
                            cte.DataAutorizacao = dataAutorizacao;
                            cte.Chave = cteOracle.ChaveCTE;
                            cte.StatusIntegrador = cteOracle.StatusIntegrador;
                            cte.NumeroRecibo = cteOracle.NumeroRecibo;
                            cte.TipoControle = 1;

                            cte.Status = "D";
                            cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat(cteOracle.DescricaoStatusIntegrador, " - ", cteOracle.CodStatusProtocolo, " - ", cteOracle.DescricaoProtocolo));
                            cte.StatusIntegrador = cteOracle.StatusIntegrador;
                            cte.CodStatusProtocolo = cteOracle.CodStatusProtocolo;
                        }
                        else
                        {
                            cte.Status = "R";
                            if (cte.TipoEmissao == "5")
                            {
                                cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat("Rejeição contingência: ", cteOracle.DescricaoStatusIntegrador, " - ", cteOracle.CodStatusEnvio, " - ", cteOracle.DescricaoEnvio));
                                if (string.IsNullOrWhiteSpace(cte.ChaveContingencia)) //Se ainda não foi autoriszado em contingência volta o tipo de emissão para Normal
                                    cte.TipoEmissao = "1";
                                else
                                    cte.Status = "F";
                            }
                            else
                            {
                                cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat(cteOracle.DescricaoStatusIntegrador, " - ", cteOracle.CodStatusEnvio, " - ", cteOracle.DescricaoEnvio));
                                cte.StatusIntegrador = cteOracle.StatusIntegrador;
                                cte.CodStatusProtocolo = cteOracle.CodStatusProtocolo;
                            }

                            if (cte.TipoEmissao != "4" && permiteHabilitarContingenciaEPECAutomaticamente)
                            {
                                Dominio.Entidades.Estado estadoEmissor = repositorioEstado.BuscarPorSigla(cte.LocalidadeEmissao.Estado.Sigla);

                                if (estadoEmissor.DataAtivacaoContingenciaAutomatica == null && statusCTe == 8888 && (estadoEmissor.HabilitarContingenciaEPECAutomaticamente ?? false) && repositorioCTeRetornoSefaz.ExisteVariasTentativasIntegracao(cte.Codigo, 5))
                                {
                                    estadoEmissor.TipoEmissao = "4";
                                    estadoEmissor.DataAtivacaoContingenciaAutomatica = DateTime.Now;

                                    cte.TipoEmissao = "4";
                                    Servicos.Log.TratarErro($"CT-e codigo {cte.Codigo}: Reenviado por epec: {cte.MensagemStatus.CodigoDoErro}", "ReenvioCTe");
                                    cte.TentativaReenvio++;

                                    if (Emitir(ref cte, unitOfWork))
                                        AdicionarCTeNaFilaDeConsulta(cte, unitOfWork);

                                    repositorioEstado.Atualizar(estadoEmissor);

                                    return;
                                }
                            }
                        }
                    }
                    else if (cteOracle.StatusIntegrador.Equals("I") || cteOracle.StatusIntegrador.Equals("L"))
                    {
                        cte.Status = "E";
                        cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat(cteOracle.DescricaoStatusIntegrador, " - ", cteOracle.CodStatusEnvio, " - ", cteOracle.DescricaoEnvio));
                        cte.StatusIntegrador = cteOracle.StatusIntegrador;
                        cte.CodStatusProtocolo = cteOracle.CodStatusProtocolo;
                    }
                    else if (cteOracle.StatusIntegrador.Equals("F"))
                    {
                        cte.Status = "F";
                        cte.TipoEmissao = "5"; //FSDA

                        cte.QRCode = cteOracle.DigVerificador;
                        cte.Chave = cteOracle.ChaveCTE;
                        cte.ChaveContingencia = cteOracle.CodStatusProtocolo; //ChaveContingencia
                        cte.MensagemRetornoSefaz = "DACTE gerada em contingência FSDA";
                        cte.StatusIntegrador = cteOracle.StatusIntegrador;
                        cte.CodStatusProtocolo = cteOracle.CodStatusProtocolo;
                    }
                    else if (cteOracle.StatusIntegrador.Equals("P") || cteOracle.StatusIntegrador.Equals("D") || cteOracle.StatusIntegrador.Equals("M"))
                    {
                        autorizadoFSDA = cte.Status == "F";

                        cte.Status = "A";
                        cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(string.Concat(cteOracle.Info.Mensagem, " - ", cteOracle.Info.MensagemOriginal));
                        cte.Protocolo = cteOracle.NumeroProtocolo;

                        DateTime dataAutorizacao = dataProtocolo != DateTime.MinValue ? dataProtocolo : DateTime.Now;
                        cte.QRCode = cteOracle.DigVerificador;
                        cte.DataRetornoSefaz = dataAutorizacao;
                        cte.DataAutorizacao = dataAutorizacao;
                        cte.Chave = cteOracle.ChaveCTE;
                        cte.StatusIntegrador = cteOracle.StatusIntegrador;
                        cte.CodStatusProtocolo = cteOracle.CodStatusProtocolo;
                        cte.NumeroRecibo = cteOracle.NumeroRecibo;
                        cte.TipoControle = 1;
                    }

                    repCTe.Atualizar(cte);

                    if (cte.Status == "A")
                    {
                        if (cte.TipoEmissao == "4" && permiteHabilitarContingenciaEPECAutomaticamente)
                        {
                            Dominio.Entidades.Estado estadoEmissor = repositorioEstado.BuscarPorSigla(cte.LocalidadeEmissao.Estado.Sigla);

                            if (estadoEmissor.DataAtivacaoContingenciaAutomatica != null && estadoEmissor.DataAtivacaoContingenciaAutomatica.Value.AddMinutes(5) < DateTime.Now)
                            {
                                estadoEmissor.TipoEmissao = "1";
                                estadoEmissor.DataAtivacaoContingenciaAutomatica = null;

                                repositorioEstado.Atualizar(estadoEmissor);
                            }
                        }

                        autorizarAverbacao = true;
                        this.ObterESalvarDACTEOracle(cte, duplicidade ? null : cteOracle, "", unitOfWork);
                        this.ObterESalvarXMLAutorizacaoOracle(cte, armazenarEmArquivo, duplicidade ? null : cteOracle, unitOfWork);

                        //Enviar e-mail para o provedor do CT-e para Multimodal
                        if (utilizaEmissaoMultimodal)
                        {
                            int codigoCTe = cte.Codigo;
                            string stringConexao = unitOfWork.StringConexao;

                            try
                            {
                                Task.Run(() => this.EnviarEmails(codigoCTe, stringConexao, tipoServicoMultisoftware));
                            }
                            catch (Exception ex)
                            {
                                Servicos.Log.TratarErro(ex, "EmailMultiModal");
                            }

                            try
                            {
                                if (cte.TipoModal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Multimodal)
                                {
                                    Dominio.Entidades.Embarcador.CTe.CTeTerceiro cteParaSubContratacao = repCTeTerceiro.BuscarPorChave(cte.Chave);
                                    if (cteParaSubContratacao == null)
                                    {
                                        Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoGeral configuracaoGeral = repositorioConfiguracaoGeral.BuscarConfiguracaoPadrao();
                                        bool enviarCTeApenasParaTomador = (configuracaoGeral?.EnviarCTeApenasParaTomador ?? false);

                                        string retornoCTeTerceiro = "";
                                        string descricaoItemPeso = "";//serCTeSubContratacao.ObterDescricaoItemPeso(cargaPedido, unitOfWork);
                                        Dominio.ObjetosDeValor.Embarcador.CTe.CTe cteIntegracao = serCTeTerceiro.ConverterEntidadeCTeParaObjeto(cte, enviarCTeApenasParaTomador, unitOfWork);
                                        cteParaSubContratacao = serCTeSubContratacao.CriarCTeTerceiro(unitOfWork, ref retornoCTeTerceiro, null, cteIntegracao, descricaoItemPeso, false, 0, false, false, tipoServicoMultisoftware);
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Servicos.Log.TratarErro(ex, "CTeTerceiro");
                            }
                        }

                        if (cte.TipoCTE == Dominio.Enumeradores.TipoCTE.Complemento && !string.IsNullOrWhiteSpace(cte.ChaveCTESubComp))
                        {
                            Dominio.Entidades.ConhecimentoDeTransporteEletronico cteOriginal = repCTe.BuscarPorChave(cte.ChaveCTESubComp);
                            if (cteOriginal != null)
                            {
                                cteOriginal.PossuiCTeComplementar = true;
                                repCTe.Atualizar(cteOriginal);

                                Servicos.Auditoria.Auditoria.Auditar(Auditado, cteOriginal, "Informou que possui um CT-e complementar.", unitOfWork);
                            }
                        }
                        else if (cte.TipoCTE == Dominio.Enumeradores.TipoCTE.Anulacao || cte.TipoCTE == Dominio.Enumeradores.TipoCTE.Substituto)
                        {
                            Dominio.Entidades.ConhecimentoDeTransporteEletronico cteOriginal = repCTe.BuscarPorChave(cte.ChaveCTESubComp);
                            if (cteOriginal != null)
                            {
                                cteOriginal.PossuiAnulacaoSubstituicao = true;
                                repCTe.Atualizar(cteOriginal);

                                Servicos.Auditoria.Auditoria.Auditar(Auditado, cteOriginal, "Informou que possui um CT-e Anulação/Substituição.", unitOfWork);
                            }
                        }

                        servicoCargaCTe.GerarIntegracoesCargaCTeManual(cte, cte.TipoCTE != Dominio.Enumeradores.TipoCTE.Anulacao && cte.TipoCTE != Dominio.Enumeradores.TipoCTE.Substituto);

                        this.ProcessarCTeMultiCTe(cte, unitOfWork);
                    }
                    else if (cte.Status == "R")
                    {
                        cte.TentativaReenvio++;
                        cte.DataRetornoSefaz = DateTime.Now;
                        repCTe.Atualizar(cte);
                    }
                    else if (cte.Status == "D")
                        this.ObterESalvarXMLAutorizacaoOracle(cte, armazenarEmArquivo, duplicidade ? null : cteOracle, unitOfWork);
                    else if (cte.Status == "F")
                        this.ObterESalvarDACTEOracle(cte, duplicidade ? null : cteOracle, "FSDA", unitOfWork);

                    if (cteOracle.StatusIntegrador != "I")
                        this.SalvarRetornoSefaz(cte, "A", cteOracle.CodigoCTeInterno, statusCTe, string.IsNullOrWhiteSpace(cteOracle.DescricaoProtocolo) ? cteOracle.DescricaoEnvio : cteOracle.DescricaoProtocolo, unitOfWork);
                }
                else if (cte.Status == "K")
                {
                    if (statusCTe != 0)
                        this.SalvarRetornoSefaz(cte, "C", cteOracle.CodigoCTeInterno, statusCTe, string.IsNullOrWhiteSpace(cteOracle.DescricaoProtocolo) ? cteOracle.DescricaoEnvio : cteOracle.DescricaoProtocolo, unitOfWork);

                    if (statusCTe == 101)
                    {
                        DateTime dataProtocolo;
                        DateTime.TryParseExact(cteOracle.DataProtocolo, "dd/MM/yyyy HH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataProtocolo);

                        cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(cteOracle.DescricaoProtocolo);
                        cte.ProtocoloCancelamentoInutilizacao = cteOracle.NumeroProtocolo;
                        cte.Status = "C";
                        cte.Cancelado = "S";

                        DateTime dataCancelamento = dataProtocolo != DateTime.MinValue ? dataProtocolo : DateTime.Now;

                        cte.DataRetornoSefaz = dataCancelamento;
                        cte.DataCancelamento = dataCancelamento;

                        repCTe.Atualizar(cte);

                        cancelarAverbacao = true;
                        this.ObterESalvarXMLCancelamentoInutilizacao(ref cte, cteOracle, armazenarEmArquivo, unitOfWork);

                        if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS && utilizaEmissaoMultimodal && cte.TomadorPagador != null)
                            this.EnviarEmailTomador(cte, unitOfWork, true);

                        if (cte.GeradoManualmente && utilizaEmissaoMultimodal)
                            serCargaIntegracao.IniciarIntegracoesComEDI(null, tipoServicoMultisoftware, unitOfWork, cte.Codigo);

                        servicoCargaCTe.GerarIntegracoesCargaCTeManual(cte, true);
                    }
                    else if (statusCTe != 0)
                    {
                        cte.Status = "A";
                        cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(cteOracle.DescricaoProtocolo);
                    }

                    cte.MensagemStatus = repErroSefaz.BuscarPorCodigoDoErro(statusCTe, Dominio.Enumeradores.TipoErroSefaz.CTe);

                    repCTe.Atualizar(cte);
                }
                else if (cte.Status == "L")
                {
                    DateTime.TryParseExact(cteOracle.DataProtocolo, "dd/MM/yyyy HH:mm:ss", null, System.Globalization.DateTimeStyles.None, out DateTime dataProtocolo);

                    if (statusCTe != 0)
                        this.SalvarRetornoSefaz(cte, "I", cteOracle.CodigoCTeInterno, statusCTe, string.IsNullOrWhiteSpace(cteOracle.DescricaoProtocolo) ? cteOracle.DescricaoEnvio : cteOracle.DescricaoProtocolo, unitOfWork);

                    if (statusCTe == 102)
                    {
                        cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(cteOracle.DescricaoStatusIntegrador);
                        cte.ProtocoloCancelamentoInutilizacao = cteOracle.NumeroProtocolo;

                        if (dataProtocolo != DateTime.MinValue)
                            cte.DataCancelamento = dataProtocolo;
                        else
                            cte.DataCancelamento = DateTime.Now;

                        cte.Status = "I";

                        this.ObterESalvarXMLCancelamentoInutilizacao(ref cte, cteOracle, armazenarEmArquivo, unitOfWork);
                    }
                    else if (statusCTe != 0)
                    {
                        cte.Status = "R";
                        cte.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(cteOracle.DescricaoEnvio);
                    }

                    cte.MensagemStatus = repErroSefaz.BuscarPorCodigoDoErro(statusCTe, Dominio.Enumeradores.TipoErroSefaz.CTe);

                    repCTe.Atualizar(cte);
                }

                if (autorizarAverbacao)
                    this.AjustarAverbacoesParaAutorizacao(cte.Codigo, unitOfWork);
                else if (cancelarAverbacao)
                    this.AjustarAverbacoesParaCancelamento(cte.Codigo, unitOfWork);

                Servicos.Auditoria.Auditoria.Auditar(Auditado, cte, "Integrou CT-e autorizado", unitOfWork);

                unitOfWork.CommitChanges();

                if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador && (cte.Status == "R" || autorizadoFSDA || Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoAmbiente().EnviarIntegracaoMagalogNoRetorno.Value))
                {
                    int codigoCTe = cte.Codigo;
                    string stringConexao = unitOfWork.StringConexao;
                    Task.Run(() => Servicos.Embarcador.Integracao.Magalog.IntegracaoMagalog.IntegrarCTeRetornoWS(codigoCTe, stringConexao));
                    Task.Run(() => Servicos.Embarcador.Integracao.Magalog.IntegracaoMagalog.IntegrarRetornoMultiCTeWS(codigoCTe, cte.Status, stringConexao));

                }
                if (cte.Status == "R")
                {
                    if (repTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.CargoX) != null)
                        Servicos.Embarcador.Integracao.CargoX.IntegracaoCargoX.IntegrarSituacaoCTe(cte, unitOfWork);
                    else if (repTipoIntegracao.BuscarPorTipo(Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Piracanjuba) != null)
                        new Servicos.Embarcador.Integracao.Piracanjuba.IntegracaoPiracanjuba(unitOfWork, tipoServicoMultisoftware).IntegrarCTeRejeitado(cte);
                }
            }
            catch (Exception ex)
            {
                unitOfWork.Rollback();
                throw;
            }
        }

        public void ProcessarTransmisaoDocumentos(List<Dominio.Entidades.Embarcador.Cargas.CargaCTe> listaCargaCte, Repositorio.UnitOfWork unitOfWork)
        {
            foreach (Dominio.Entidades.Embarcador.Cargas.CargaCTe cargaCte in listaCargaCte)
            {
                Repositorio.Embarcador.Cargas.CargaCTe repCargaCTe = new Repositorio.Embarcador.Cargas.CargaCTe(unitOfWork);

                try
                {
                    if (cargaCte.CTe.Status == "S")
                    {
                        if (cargaCte.CTe.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.CTe)
                        {
                            Dominio.Entidades.ConhecimentoDeTransporteEletronico cteIntegrado = cargaCte.CTe;
                            this.Emitir(ref cteIntegrado, unitOfWork);
                        }
                        else if (cargaCte.CTe.ModeloDocumentoFiscal.TipoDocumentoEmissao == Dominio.Enumeradores.TipoDocumento.NFSe)
                        {
                            Servicos.NFSe servicoNFSe = new Servicos.NFSe(unitOfWork);
                            servicoNFSe.EmitirNFSe(cargaCte.CTe.Codigo, unitOfWork);
                        }
                    }

                    cargaCte.SituacaoProcessamentoThread = SituacaoProcessamentoThread.Concluido;
                }
                catch (Exception ex)
                {
                    Servicos.Log.TratarErro(ex);
                    cargaCte.SituacaoProcessamentoThread = SituacaoProcessamentoThread.Problema;
                }

                repCargaCTe.Atualizar(cargaCte);
            }
        }

        public void EnviarEmailTomador(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unitOfWork, bool cancelamento)
        {
            Repositorio.Embarcador.Email.ConfigEmailDocTransporte repConfigEmailDocTransporte = new Repositorio.Embarcador.Email.ConfigEmailDocTransporte(unitOfWork);
            Dominio.Entidades.Embarcador.Email.ConfigEmailDocTransporte email = repConfigEmailDocTransporte.BuscarEmailEnviaDocumentoAtivo(0);

            Dominio.Entidades.Cliente tomadorCTe = cte.TomadorPagador.Cliente;
            Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEnvioEmailCTe? tipoEnvioEmail = null;
            if (tomadorCTe.TipoEnvioEmail.HasValue && tomadorCTe.NaoUsarConfiguracaoEmissaoGrupo)
                tipoEnvioEmail = tomadorCTe.TipoEnvioEmail;
            else if (tomadorCTe.GrupoPessoas != null && tomadorCTe.GrupoPessoas.TipoEnvioEmail.HasValue)
                tipoEnvioEmail = tomadorCTe.GrupoPessoas.TipoEnvioEmail;

            if (email == null)
            {
                Servicos.Log.TratarErro("Não há um e-mail configurado para realizar o envio.");
                return;
            }
            try
            {
                string mensagemErro = "Erro ao enviar e-mail";
                string assunto = "CT-e " + cte.Empresa.NomeFantasia + " " + cte.Numero.ToString("D") + "/" + cte.NumeroControle;
                if (cancelamento)
                    assunto += " CANCELADO";
                string mensagemEmail = string.Empty;
                if (cancelamento)
                    mensagemEmail = @"Prezado(a) " + tomadorCTe.Nome + @" ,

                        Você recebeu o cancelamento um Conhecimento de Transporte Eletrônico (CT-e) emitido por Aliança Navegação e Logística Ltda
                        Anexo a este e-mail consta o arquivo eletrônico de cancelamento de uso. O transportador e o tomador do serviço de transporte deverão manter em arquivo digital os CT-e pelo prazo estabelecido na legislação tributária para a guarda dos documentos fiscais, devendo ser apresentados à administração tributária, quando solicitado.

                        Dados do Conhecimento de Transporte Eletrônico (CT-e)
                        Número: " + cte.Numero.ToString("D") + @"
                        Série: " + cte.Serie.Numero.ToString("D") + @"
                        Chave de Acesso: " + cte.Chave + @"
                        Situação: Cancelado o uso do CT-e

                        Como verificar a concessão do Cancelamento de Uso do CT-e?
                        Acesse www.cte.fazenda.gov.br e clique em Consultas > Resumo do Conhecimento de Transporte Eletrônico. Digite a chave de acesso informada acima. O campo Situação Atual deve estar preenchido como CANCELADO.

                        Atendimento Aliança Navegação e Logística Ltda
                        http://www.alianca.com.br

                        *** e-MAIL ENVIADO AUTOMATICAMENTE PELO NOSSO SISTEMA. FAVOR NÃO RESPONDER ***";
                else
                    mensagemEmail = @"Prezado(a) " + tomadorCTe.Nome + @" ,

                        Você recebeu um Conhecimento de Transporte Eletrônico (CT-e) emitido por Aliança Navegação e Logística Ltda
                        Anexo a este e-mail consta o arquivo eletrônico de autorização de uso. O transportador e o tomador do serviço de transporte deverão manter em arquivo digital os CT-e pelo prazo estabelecido na legislação tributária para a guarda dos documentos fiscais, devendo ser apresentados à administração tributária, quando solicitado.

                        Dados do Conhecimento de Transporte Eletrônico (CT-e)
                        Número: " + cte.Numero.ToString("D") + @"
                        Série: " + cte.Serie.Numero.ToString("D") + @"
                        Chave de Acesso: " + cte.Chave + @"
                        Situação: Autorizado o uso do CT-e

                        Como verificar a concessão da Autorização de Uso do CT-e?
                        Acesse www.cte.fazenda.gov.br e clique em Consultas > Resumo do Conhecimento de Transporte Eletrônico. Digite a chave de acesso informada acima. O campo Situação Atual deve estar preenchido como AUTORIZADO.

                        Atendimento Aliança Navegação e Logística Ltda
                        http://www.alianca.com.br

                        *** e-MAIL ENVIADO AUTOMATICAMENTE PELO NOSSO SISTEMA. FAVOR NÃO RESPONDER ***";

                List<string> emails = new List<string>();
                if (!string.IsNullOrWhiteSpace(tomadorCTe.Email))
                    emails.AddRange(tomadorCTe.Email.Split(';').ToList());

                foreach (var outroEmail in tomadorCTe.Emails)
                {
                    if (!string.IsNullOrWhiteSpace(outroEmail.Email) && outroEmail.EmailStatus == "A" && outroEmail.TipoEmail != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmail.Administrativo)
                        emails.Add(outroEmail.Email);
                }

                emails = emails.Distinct().ToList();
                if (emails.Count > 0)
                {
                    List<System.Net.Mail.Attachment> attachments = new List<System.Net.Mail.Attachment>();

                    string nomeArquivo = "";
                    byte[] data = null;
                    if (cte.ModeloDocumentoFiscal.Numero == "39")
                    {
                        nomeArquivo = cte.Numero.ToString() + "_" + cte.Serie.Numero.ToString() + ".xml";
                        Servicos.NFSe svcNFSe = new Servicos.NFSe();
                        if (cancelamento)
                            data = svcNFSe.ObterXML(cte.Codigo, Dominio.Enumeradores.TipoXMLNFSe.Cancelamento, unitOfWork);
                        else
                            data = svcNFSe.ObterXMLAutorizacaoCTe(cte.Codigo, unitOfWork);
                        if (data != null)
                        {
                            Stream stream = new MemoryStream(data);
                            attachments.Add(new System.Net.Mail.Attachment(stream, nomeArquivo));
                        }
                    }
                    else
                    {
                        nomeArquivo = string.Concat(cte.Chave, ".xml");
                        Servicos.CTe svcCTe = new Servicos.CTe(unitOfWork);
                        if (cancelamento)
                            data = svcCTe.ObterXMLCancelamento(cte, unitOfWork);
                        else
                            data = svcCTe.ObterXMLAutorizacao(cte, unitOfWork);
                        if (data != null)
                        {
                            Stream stream = new MemoryStream(data);
                            attachments.Add(new System.Net.Mail.Attachment(stream, nomeArquivo));
                        }
                    }
                    if (!tipoEnvioEmail.HasValue || tipoEnvioEmail.Value == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEnvioEmailCTe.Normal)
                    {
                        string caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoArquivo().CaminhoRelatorios, cte.Empresa.CNPJ, cte.Chave) + ".pdf";
                        if (Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF))
                        {
                            nomeArquivo = Path.GetFileName(caminhoPDF);
                            data = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminhoPDF);
                            if (data != null)
                            {
                                Stream stream = new MemoryStream(data);
                                attachments.Add(new System.Net.Mail.Attachment(stream, nomeArquivo));
                            }
                        }
                    }

                    bool sucesso = Servicos.Email.EnviarEmail(email.Email, email.Email, email.Senha, null, emails.ToArray(), null, assunto, mensagemEmail, email.Smtp, out mensagemErro, email.DisplayEmail,
                                attachments, "", email.RequerAutenticacaoSmtp, "", email.PortaSmtp, unitOfWork);

                    if (!sucesso)
                        Servicos.Log.TratarErro("Problemas ao enviar o cte para o tomador do CT-e por e-mail: " + mensagemErro);
                }
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro(ex);
            }

        }

        public void EnviarEmails(int codigoCTe, string stringConexao, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {

            Repositorio.UnitOfWork unitOfWork = new Repositorio.UnitOfWork(stringConexao);
            Servicos.Embarcador.Integracao.IntegracaoCarga serCargaIntegracao = new Servicos.Embarcador.Integracao.IntegracaoCarga(unitOfWork);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Repositorio.Embarcador.Email.ConfigEmailDocTransporte repConfigEmailDocTransporte = new Repositorio.Embarcador.Email.ConfigEmailDocTransporte(unitOfWork);
            Dominio.Entidades.Embarcador.Email.ConfigEmailDocTransporte email = repConfigEmailDocTransporte.BuscarEmailEnviaDocumentoAtivo(0);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repCTe.BuscarPorCodigo(codigoCTe);

            if (cte.ClienteProvedorOS != null)
                this.EnviarEmailAverbacao(cte, unitOfWork, stringConexao);
            if (cte.TomadorPagador != null)
                this.EnviarEmailTomador(cte, unitOfWork, false);

            if (cte.GeradoManualmente)
                serCargaIntegracao.IniciarIntegracoesComEDI(null, tipoServicoMultisoftware, unitOfWork, cte.Codigo);
        }

        public void EnviarEmailAverbacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unitOfWork, string stringConexao)
        {
            Servicos.DACTE svcDACTE = new Servicos.DACTE(unitOfWork);

            Repositorio.Embarcador.Email.ConfigEmailDocTransporte repConfigEmailDocTransporte = new Repositorio.Embarcador.Email.ConfigEmailDocTransporte(unitOfWork);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoTMS = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unitOfWork);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoTMS = repConfiguracaoTMS.BuscarConfiguracaoPadrao();
            Dominio.Entidades.Embarcador.Email.ConfigEmailDocTransporte email = repConfigEmailDocTransporte.BuscarEmailEnviaDocumentoAtivo(0);
            string diretorioDocumentosFiscais = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoArquivo().CaminhoDocumentosFiscaisEmbarcador;
            string caminhoArquivos = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoArquivo().CaminhoArquivos;

            Dominio.Entidades.Cliente provedorOS = cte.ClienteProvedorOS;

            if (email == null)
            {
                Servicos.Log.TratarErro("Não há um e-mail configurado para realizar o envio.");
                return;
            }
            try
            {
                string mensagemErro = "Erro ao enviar e-mail";
                string assunto = "Reenvio de OS " + cte.NumeroOS + " com chave de CTMC";
                string mensagemEmail = string.Empty;

                mensagemEmail = "<br/>Segue a(s) chave(s) dos CTMC da OS:<br/>";

                mensagemEmail += "<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js'></script>";
                mensagemEmail += "<script src='http://www.developerdan.com/table-to-json/javascripts/jquery.tabletojson.min.js'></script>";
                mensagemEmail += "<table style='width:100%; align='center'; border='1'; cellpadding='0'; cellspacing='0';>";
                mensagemEmail += "<thead>";
                mensagemEmail += "<th>Container</th>";
                mensagemEmail += "<th>Chave CTMC</th>";
                mensagemEmail += "</thead>";
                mensagemEmail += "<tbody>";

                if (cte.Containers != null && cte.Containers.Count > 0)
                {
                    foreach (var container in cte.Containers)
                    {
                        mensagemEmail += "<tr>";
                        mensagemEmail += "<td>" + (container.Container?.Numero ?? "") + "</td>";
                        mensagemEmail += "<td>" + cte.Chave + "</td>";
                        mensagemEmail += "</tr>";
                    }
                }
                else
                {
                    mensagemEmail += "<tr>";
                    mensagemEmail += "<td>CNTR A DEFINIR</td>";
                    mensagemEmail += "<td>" + cte.Chave + "</td>";
                    mensagemEmail += "</tr>";
                }

                mensagemEmail += "</tbody></table>";


                mensagemEmail += "<br/><br/>E -mail enviado automaticamente. Por favor, não responda.";

                List<string> emails = new List<string>();
                if (!string.IsNullOrWhiteSpace(provedorOS.Email))
                    emails.AddRange(provedorOS.Email.Split(';').ToList());

                foreach (var outroEmail in provedorOS.Emails)
                {
                    if (!string.IsNullOrWhiteSpace(outroEmail.Email) && outroEmail.EmailStatus == "A" && outroEmail.TipoEmail != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEmail.Administrativo)
                        emails.Add(outroEmail.Email);
                }


                emails = emails.Distinct().ToList();
                if (emails.Count > 0)
                {
                    List<System.Net.Mail.Attachment> attachments = new List<System.Net.Mail.Attachment>();

                    string nomeArquivo = "";
                    byte[] data = null;
                    if (cte.ModeloDocumentoFiscal.Numero == "39")
                    {
                        nomeArquivo = cte.Numero.ToString() + "_" + cte.Serie.Numero.ToString() + ".xml";
                        Servicos.NFSe svcNFSe = new Servicos.NFSe();
                        data = svcNFSe.ObterXMLAutorizacaoCTe(cte.Codigo, unitOfWork);
                        if (data != null)
                        {
                            Stream stream = new MemoryStream(data);
                            attachments.Add(new System.Net.Mail.Attachment(stream, nomeArquivo));
                        }
                    }
                    else
                    {
                        nomeArquivo = string.Concat(cte.Chave, ".xml");
                        Servicos.CTe svcCTe = new Servicos.CTe(unitOfWork);
                        data = svcCTe.ObterXMLAutorizacao(cte, unitOfWork);
                        if (data != null)
                        {
                            Stream stream = new MemoryStream(data);
                            attachments.Add(new System.Net.Mail.Attachment(stream, nomeArquivo));
                        }
                    }

                    nomeArquivo = "";
                    data = null;
                    string caminhoPDF = Utilidades.IO.FileStorageService.Storage.Combine(Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unitOfWork).ObterConfiguracaoArquivo().CaminhoRelatorios, cte.Empresa.CNPJ, cte.Chave) + ".pdf";
                    if (Utilidades.IO.FileStorageService.Storage.Exists(caminhoPDF))
                    {
                        nomeArquivo = Path.GetFileName(caminhoPDF);
                        data = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminhoPDF);
                        if (data != null)
                        {
                            Stream stream = new MemoryStream(data);
                            attachments.Add(new System.Net.Mail.Attachment(stream, nomeArquivo));
                        }
                    }
                    else
                    {
                        byte[] pdf = svcDACTE.GerarPorProcesso(cte.Codigo, null, configuracaoTMS.GerarPDFCTeCancelado);
                        if (pdf != null)
                        {
                            string nomeArquivoDownload = Servicos.Embarcador.CTe.CTe.ObterNomeArquivoDownloadCTe(cte, "pdf");

                            if (string.IsNullOrWhiteSpace(nomeArquivoDownload))
                                nomeArquivoDownload = System.IO.Path.GetFileName(caminhoPDF);

                            Stream stream = new MemoryStream(pdf);
                            attachments.Add(new System.Net.Mail.Attachment(stream, nomeArquivoDownload));
                        }
                    }

                    if (cte.XMLNotaFiscais != null && cte.XMLNotaFiscais.Count > 0)
                    {
                        var notasFiscaisOrdenadas = cte.XMLNotaFiscais.OrderBy(o => o.Numero).ToList();
                        foreach (var notaFiscal in notasFiscaisOrdenadas)
                        {
                            try
                            {
                                string xmlNotaFiscal = this.RetornarXMLNotaFiscal(notaFiscal, diretorioDocumentosFiscais, unitOfWork);
                                if (!string.IsNullOrWhiteSpace(xmlNotaFiscal))
                                {
                                    string caminhoDANFE = Utilidades.IO.FileStorageService.Storage.Combine(caminhoArquivos, "DANFE Documentos Emitidos", notaFiscal.Chave + ".pdf");

                                    if (!Utilidades.IO.FileStorageService.Storage.Exists(caminhoDANFE))
                                    {
                                        if (notaFiscal.XML.Contains("</nfeProc>"))
                                            Zeus.Embarcador.ZeusNFe.Zeus.GerarDANFE(out string erro, notaFiscal.XML, caminhoDANFE, false, false);
                                        else if (notaFiscal.XML.Contains("</NFe>"))
                                            Zeus.Embarcador.ZeusNFe.Zeus.GerarDANFE(out string erro, notaFiscal.XML, caminhoDANFE, false, true);
                                        else
                                            Zeus.Embarcador.ZeusNFe.Zeus.GerarDANFE(out string erro, notaFiscal.XML, caminhoDANFE, true, false);
                                    }

                                    if (Utilidades.IO.FileStorageService.Storage.Exists(caminhoDANFE))
                                    {
                                        nomeArquivo = string.Concat((!string.IsNullOrWhiteSpace(notaFiscal.Chave) ? notaFiscal.Chave : notaFiscal.Numero.ToString()), ".pdf");
                                        byte[] pdf = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminhoDANFE);
                                        if (pdf != null)
                                        {
                                            Stream stream = new MemoryStream(pdf);
                                            attachments.Add(new System.Net.Mail.Attachment(stream, nomeArquivo));
                                        }
                                    }

                                    byte[] bytes = Encoding.ASCII.GetBytes(xmlNotaFiscal);
                                    nomeArquivo = string.Concat((!string.IsNullOrWhiteSpace(notaFiscal.Chave) ? notaFiscal.Chave : notaFiscal.Numero.ToString()), ".xml");
                                    if (bytes != null)
                                    {
                                        Stream stream = new MemoryStream(bytes);
                                        attachments.Add(new System.Net.Mail.Attachment(stream, nomeArquivo));
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                Servicos.Log.TratarErro("CTe " + cte.Chave + " NFe" + notaFiscal.Chave + " " + ex, "EnviarEmailAverbacao");
                            }
                        }
                    }

                    bool sucesso = Servicos.Email.EnviarEmail(email.Email, email.Email, email.Senha, null, emails.ToArray(), null, assunto, mensagemEmail, email.Smtp, out mensagemErro, email.DisplayEmail,
                                attachments, "", email.RequerAutenticacaoSmtp, "", email.PortaSmtp, unitOfWork);

                    if (!sucesso)
                        Servicos.Log.TratarErro("Problemas ao enviar o cte para o provedor por e-mail: " + mensagemErro);
                }
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro(ex);
            }
        }

        public string RetornarXMLNotaFiscal(Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal notaFiscal, string diretorioDocumentosFiscais, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.Documentos.DocumentoDestinadoEmpresa repositorioDocumentoDestinadoEmpresa = new Repositorio.Embarcador.Documentos.DocumentoDestinadoEmpresa(unitOfWork);

            if (!string.IsNullOrWhiteSpace(notaFiscal.XML) && (notaFiscal.XML.Contains("</nfeProc>") || notaFiscal.XML.Contains("nfeProc")))
                return notaFiscal.XML;
            else if (!string.IsNullOrWhiteSpace(notaFiscal.Chave) && notaFiscal.Chave.Length == 44)
            {
                Dominio.Entidades.Embarcador.Documentos.DocumentoDestinadoEmpresa documentoDestinado = repositorioDocumentoDestinadoEmpresa.BuscarPorChaveETipoDocumento(
                    new Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoDocumentoDestinadoEmpresa[] { Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoDocumentoDestinadoEmpresa.NFeDestinada, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoDocumentoDestinadoEmpresa.NFeTransporte },
                    notaFiscal.Chave);
                if (documentoDestinado != null)
                {
                    string caminho = Utilidades.IO.FileStorageService.Storage.Combine(diretorioDocumentosFiscais, "NFe", "nfeProc", $"{documentoDestinado.Chave}.xml");
                    byte[] arquivo = null;

                    if (Utilidades.IO.FileStorageService.Storage.Exists(caminho))
                        arquivo = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminho);
                    else
                    {
                        Servicos.Embarcador.Documentos.DocumentoDestinadoEmpresa.ObterDocumentosDestinadosEmpresa(documentoDestinado.Empresa.Codigo, unitOfWork.StringConexao, null, out string mensagemErro, out string codigoStatusRetornoSefaz, documentoDestinado.NumeroSequencialUnico);

                        if (Utilidades.IO.FileStorageService.Storage.Exists(caminho))
                            arquivo = Utilidades.IO.FileStorageService.Storage.ReadAllBytes(caminho);
                    }

                    if (Utilidades.IO.FileStorageService.Storage.Exists(caminho))
                        return Encoding.Default.GetString(arquivo);
                    else
                    {
                        string notaSerpro = ObterNotaFiscalPorSerpro(notaFiscal.Chave, unitOfWork);
                        if (!string.IsNullOrWhiteSpace(notaSerpro))
                        {
                            notaFiscal.XML = notaSerpro;
                            repXMLNotaFiscal.Atualizar(notaFiscal);
                            return notaSerpro;
                        }
                        else
                            return "";
                    }
                }
                else
                {
                    string notaSerpro = ObterNotaFiscalPorSerpro(notaFiscal.Chave, unitOfWork);
                    if (!string.IsNullOrWhiteSpace(notaSerpro))
                    {
                        notaFiscal.XML = notaSerpro;
                        repXMLNotaFiscal.Atualizar(notaFiscal);
                        return notaSerpro;
                    }
                    else
                        return "";
                }
            }
            else
                return "";
        }

        private string ObterNotaFiscalPorSerpro(string chave, Repositorio.UnitOfWork unitOfWork)
        {
            string msgRetorno = "";
            string token = "";
            string arquivoNotaFiscal = "";
            if (!Servicos.Embarcador.Integracao.Serpro.IntegracaoSerpro.Realizarlogin(unitOfWork, out msgRetorno, out token, false))
            {
                Servicos.Log.TratarErro(msgRetorno);
                return "";
            }
            else
            {
                arquivoNotaFiscal = Servicos.Embarcador.Integracao.Serpro.IntegracaoSerpro.BaixarJSONPelaChave(unitOfWork, out msgRetorno, token, chave);
                if (string.IsNullOrWhiteSpace(arquivoNotaFiscal))
                {
                    Servicos.Log.TratarErro(msgRetorno);
                    return "";
                }
                else
                {
                    return arquivoNotaFiscal;
                }
            }
        }

        public void EfetuarDownloadXMLCTe(int codigoCTe, Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado auditado, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            using (Repositorio.UnitOfWork unitOfWork = new Repositorio.UnitOfWork(_unitOfWork.StringConexao, Dominio.ObjetosDeValor.Enumerador.TipoSessaoBancoDados.Nova))
            {
                Repositorio.ConhecimentoDeTransporteEletronico repositorioCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
                Repositorio.XMLCTe repositorioXMLCTe = new Repositorio.XMLCTe(unitOfWork);

                Servicos.Global.OrquestradorFila servicoOrquestradorFila = new Servicos.Global.OrquestradorFila(unitOfWork, Dominio.ObjetosDeValor.Embarcador.Enumeradores.IdentificadorControlePosicaoThread.EfetuarDownloadXMLCTe);

                try
                {
                    unitOfWork.Start();

                    Dominio.Entidades.ConhecimentoDeTransporteEletronico cte = repositorioCTe.BuscarPorCodigo(codigoCTe);

                    Servicos.Embarcador.EmissorDocumento.EmissorDocumentoService.GetEmissorDocumentoCTe(cte.SistemaEmissor).ObterXMLCteAutorizacao(cte, auditado, tipoServicoMultisoftware, unitOfWork);

                    bool existeXMLCTe = repositorioXMLCTe.ExisteXMLPorCTe(cte.Codigo);

                    if (!existeXMLCTe)
                        throw new ServicoException($"Não retornou XML do emissor {TipoEmissorDocumento.NSTech.ObterDescricao()} para o código do CTe {cte.Codigo}.");

                    servicoOrquestradorFila.RegistroLiberadoComSucesso(codigoCTe);

                    unitOfWork.CommitChanges();
                }
                catch (ServicoException excecao)
                {
                    unitOfWork.Rollback();
                    servicoOrquestradorFila.RegistroComFalha(codigoCTe, excecao.Message);
                }
                catch (Exception excecao)
                {
                    unitOfWork.Rollback();
                    Servicos.Log.TratarErro(excecao);
                    servicoOrquestradorFila.RegistroComFalha(codigoCTe, excecao.Message);
                }
                finally
                {
                    unitOfWork.Dispose();
                }
            }
        }

        #endregion Métodos Públicos

        #region Métodos Privados

        #region Leitura

        public Dominio.ObjetosDeValor.WebService.Carga.CargaIntegracao ConverterCTeEmCargaIntegracao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, string numeroUnidade, string numeroCarga, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Servicos.WebService.Pessoas.Pessoa serPessoa = new Servicos.WebService.Pessoas.Pessoa(unidadeDeTrabalho);
            Servicos.WebService.Empresa.Empresa serEmpresa = new Servicos.WebService.Empresa.Empresa(unidadeDeTrabalho);

            Repositorio.InformacaoCargaCTE repInformacaoCargaCTe = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
            Repositorio.MotoristaCTE repMotoristaCTe = new Repositorio.MotoristaCTE(unidadeDeTrabalho);
            Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
            Repositorio.Embarcador.Filiais.Filial repFilial = new Repositorio.Embarcador.Filiais.Filial(unidadeDeTrabalho);

            Dominio.ObjetosDeValor.WebService.Carga.CargaIntegracao cargaIntegracao = new Dominio.ObjetosDeValor.WebService.Carga.CargaIntegracao();

            string numeroDaCarga = !string.IsNullOrWhiteSpace(numeroCarga) ? numeroCarga : !string.IsNullOrWhiteSpace(cte.Chave) ? cte.Chave : "NFSE" + cte.Codigo.ToString(); ;
            string numeroDoPedido = !string.IsNullOrWhiteSpace(numeroCarga) ? numeroCarga : cte.Numero.ToString();

            cargaIntegracao.NumeroCarga = numeroDaCarga;
            cargaIntegracao.NumeroPedidoEmbarcador = numeroDoPedido + '_' + cte.Codigo.ToString(); //Alterado para gerar um pedido para cada CTe
            cargaIntegracao.CFOP = cte.CFOP.CodigoCFOP;
            cargaIntegracao.TransportadoraEmitente = serEmpresa.ConverterObjetoEmpresa(cte.Empresa);
            cargaIntegracao.UsarOutroEnderecoOrigem = false;
            cargaIntegracao.UsarOutroEnderecoDestino = false;
            cargaIntegracao.Remetente = serPessoa.ConverterObjetoParticipamenteCTe(cte.Remetente);
            cargaIntegracao.Destinatario = serPessoa.ConverterObjetoParticipamenteCTe(cte.Destinatario);
            cargaIntegracao.Tomador = serPessoa.ConverterObjetoParticipamenteCTe(cte.Tomador);
            cargaIntegracao.Recebedor = serPessoa.ConverterObjetoParticipamenteCTe(cte.Recebedor);
            cargaIntegracao.Expedidor = serPessoa.ConverterObjetoParticipamenteCTe(cte.Expedidor);

            Dominio.Entidades.Embarcador.Filiais.Filial filial = !string.IsNullOrWhiteSpace(numeroUnidade) ? repFilial.buscarPorCodigoEmbarcador(numeroUnidade) : null;
            if (filial != null)
            {
                cargaIntegracao.Filial = new Dominio.ObjetosDeValor.Embarcador.Filial.Filial
                {
                    CodigoIntegracao = numeroUnidade
                };
            }
            else
            {
                if (Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().BuscarFilialPorCNPJRemetenteDestinatarioGerarCargaCTe.HasValue && Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().BuscarFilialPorCNPJRemetenteDestinatarioGerarCargaCTe.Value)
                {
                    filial = repFilial.BuscarPorCNPJ(cte.Remetente.CPF_CNPJ_SemFormato);
                    if (filial != null)
                    {
                        cargaIntegracao.Filial = new Dominio.ObjetosDeValor.Embarcador.Filial.Filial
                        {
                            CodigoIntegracao = cte.Remetente.CPF_CNPJ_SemFormato
                        };
                    }
                    else if (filial == null && cte.Destinatario != null)
                    {
                        filial = repFilial.BuscarPorCNPJ(cte.Destinatario.CPF_CNPJ_SemFormato);

                        if (filial != null)
                        {
                            cargaIntegracao.Filial = new Dominio.ObjetosDeValor.Embarcador.Filial.Filial
                            {
                                CodigoIntegracao = cte.Destinatario.CPF_CNPJ_SemFormato
                            };
                        }
                    }
                }
            }
            if (filial == null) //Busca a primeira filial quando não localizou nenhuma
            {
                filial = repFilial.ConsultarTodas().FirstOrDefault();
                if (filial != null)
                {
                    cargaIntegracao.Filial = new Dominio.ObjetosDeValor.Embarcador.Filial.Filial
                    {
                        CodigoIntegracao = filial.CodigoFilialEmbarcador
                    };
                }
            }

            cargaIntegracao.DataCriacaoCarga = cte.DataEmissao.Value.ToString("dd/MM/yyyy HH:mm:ss");
            cargaIntegracao.DataInicioCarregamento = cte.DataEmissao.Value.ToString("dd/MM/yyyy HH:mm:ss");
            cargaIntegracao.DataFinalCarregamento = cte.DataEmissao.Value.ToString("dd/MM/yyyy HH:mm:ss");
            cargaIntegracao.DataPrevisaoEntrega = cte.DataEmissao.Value.AddDays(5).ToString("dd/MM/yyyy HH:mm:ss");
            cargaIntegracao.NumeroPaletes = 0;
            cargaIntegracao.PesoTotalPaletes = 0;
            cargaIntegracao.ValorTotalPaletes = 0;
            cargaIntegracao.PesoBruto = repInformacaoCargaCTe.ObterPesoKg(cte.Codigo);
            cargaIntegracao.CubagemTotal = 0;
            cargaIntegracao.ProdutoPredominante = new Dominio.ObjetosDeValor.Embarcador.Pedido.Produto
            {
                CodigoProduto = "1",
                DescricaoProduto = !string.IsNullOrWhiteSpace(cte.ProdutoPredominanteCTe) ? cte.ProdutoPredominanteCTe : "Diversos"
            };
            cargaIntegracao.TipoTomador = cte.TipoTomador;
            cargaIntegracao.TipoPagamento = cte.TipoPagamento;

            List<Dominio.Entidades.MotoristaCTE> listaMotoristas = repMotoristaCTe.BuscarPorCTe(cte.Codigo);
            if (listaMotoristas.Count > 0)
            {
                List<Dominio.ObjetosDeValor.Embarcador.Carga.Motorista> listaMotorista = new List<Dominio.ObjetosDeValor.Embarcador.Carga.Motorista>();

                foreach (Dominio.Entidades.MotoristaCTE motoristaCTe in listaMotoristas)
                {
                    Dominio.ObjetosDeValor.Embarcador.Carga.Motorista motorista = new Dominio.ObjetosDeValor.Embarcador.Carga.Motorista();
                    motorista.CPF = motoristaCTe.CPFMotorista;
                    motorista.Nome = motoristaCTe.NomeMotorista;
                    listaMotorista.Add(motorista);
                }
                cargaIntegracao.Motoristas = listaMotorista;
            }

            List<Dominio.Entidades.VeiculoCTE> listaVeiculos = repVeiculoCTe.BuscarPorCTe(cte.Codigo);
            if (listaVeiculos.Count > 0)
            {
                Dominio.Entidades.VeiculoCTE veiculoTracao = (from o in listaVeiculos where o.TipoVeiculo == "0" select o).FirstOrDefault();
                if (veiculoTracao == null)
                    veiculoTracao = listaVeiculos.FirstOrDefault();

                cargaIntegracao.Veiculo = new Dominio.ObjetosDeValor.Embarcador.Frota.Veiculo
                {
                    Placa = veiculoTracao.Placa,
                    Renavam = veiculoTracao.RENAVAM,
                    UF = veiculoTracao.SiglaUF,
                    CapacidadeKG = veiculoTracao.CapacidadeKG,
                    CapacidadeM3 = veiculoTracao.CapacidadeM3,
                    Tara = veiculoTracao.Tara
                };

                Dominio.Entidades.VeiculoCTE veiculoReboque = (from o in listaVeiculos where o.TipoVeiculo == "1" select o).FirstOrDefault();
                if (veiculoReboque == null && listaVeiculos.Count > 1)
                    veiculoReboque = listaVeiculos[1];

                if (veiculoReboque != null && veiculoReboque.Placa != veiculoTracao.Placa)
                {
                    Dominio.ObjetosDeValor.Embarcador.Frota.Veiculo reboque = new Dominio.ObjetosDeValor.Embarcador.Frota.Veiculo
                    {
                        Placa = veiculoReboque.Placa,
                        Renavam = veiculoReboque.RENAVAM,
                        UF = veiculoReboque.SiglaUF,
                        CapacidadeKG = veiculoReboque.CapacidadeKG,
                        CapacidadeM3 = veiculoReboque.CapacidadeM3,
                        Tara = veiculoReboque.Tara
                    };

                    cargaIntegracao.Veiculo.Reboques = new List<Dominio.ObjetosDeValor.Embarcador.Frota.Veiculo>();
                    cargaIntegracao.Veiculo.Reboques.Add(reboque);
                }
            }

            cargaIntegracao.ValorFrete = new Dominio.ObjetosDeValor.Embarcador.Frete.FreteValor
            {
                ValorPrestacaoServico = cte.ValorPrestacaoServico,
                ValorTotalAReceber = cte.ValorAReceber
            };

            cargaIntegracao.FecharCargaAutomaticamente = true;

            return cargaIntegracao;
        }

        private void AlterarComponenteImposto(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (cte.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && cte.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim)
            {
                Repositorio.ComponentePrestacaoCTE repComponente = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

                Dominio.Entidades.ComponentePrestacaoCTE componente = repComponente.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo).Where(o => o.Nome == "IMPOSTOS").FirstOrDefault();

                if (componente != null)
                {
                    componente.Valor = Math.Round(cte.ValorICMS, 2, MidpointRounding.ToEven);

                    repComponente.Atualizar(componente);
                }
            }
        }

        private void AlterarComponenteImposto(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, decimal valor, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ComponentePrestacaoCTE repComponente = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            Dominio.Entidades.ComponentePrestacaoCTE componente = repComponente.BuscarPorCTe(cte.Empresa.Codigo, cte.Codigo).Where(o => o.Nome == "IMPOSTOS").FirstOrDefault();

            if (componente != null)
            {
                componente.Valor = Math.Round(valor, 2, MidpointRounding.ToEven);

                repComponente.Atualizar(componente);
            }
        }

        private Dominio.Entidades.ConhecimentoDeTransporteEletronico GerarCTePorPreCTe(int codigoEmpresa, int codigoUsuario, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTe cte, Repositorio.UnitOfWork unidadeTrabalho)
        {
            Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeTrabalho);
            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeTrabalho);
            Repositorio.Usuario repUsuario = new Repositorio.Usuario(unidadeTrabalho);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            Dominio.Entidades.Empresa empresa = codigoEmpresa > 0 ? repEmpresa.BuscarPorCodigo(codigoEmpresa) : repEmpresa.BuscarPorCNPJ(cte.infCte.emit.CNPJ);
            Dominio.Entidades.Usuario usuario = codigoUsuario > 0 ? repUsuario.BuscarPorCodigo(codigoUsuario) : repUsuario.BuscarPrimeiroPorEmpresa(empresa.Codigo, Dominio.Enumeradores.TipoAcesso.Emissao);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();

            conhecimento.Empresa = empresa;
            conhecimento.CFOP = repCFOP.BuscarPorNumero(int.Parse(cte.infCte.ide.CFOP));
            conhecimento.NaturezaDaOperacao = conhecimento.CFOP.NaturezaDaOperacao;
            conhecimento.ValorAReceber = decimal.Parse(cte.infCte.vPrest.vRec, cultura);
            conhecimento.ValorPrestacaoServico = decimal.Parse(cte.infCte.vPrest.vTPrest, cultura);
            conhecimento.ValorFrete = conhecimento.ValorPrestacaoServico;
            conhecimento.LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.infCte.ide.cMunIni));
            conhecimento.LocalidadeEmissao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.infCte.ide.cMunEnv));
            conhecimento.LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.infCte.ide.cMunFim));
            conhecimento.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);
            conhecimento.TipoPagamento = (Dominio.Enumeradores.TipoPagamento)cte.infCte.ide.forPag;
            conhecimento.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo(string.Format("{0:00}", (int)cte.infCte.ide.mod));
            conhecimento.Serie = this.ObterSerie(empresa, conhecimento.LocalidadeEmissao.Estado.Sigla, conhecimento.LocalidadeInicioPrestacao.Estado.Sigla, conhecimento.LocalidadeTerminoPrestacao.Estado.Sigla, conhecimento.Remetente?.CPF_CNPJ ?? string.Empty, conhecimento.Destinatario?.CPF_CNPJ ?? string.Empty, conhecimento.Recebedor?.CPF_CNPJ ?? string.Empty, conhecimento.Expedidor?.CPF_CNPJ ?? string.Empty, conhecimento.TomadorPagador?.CPF_CNPJ ?? string.Empty, unidadeTrabalho);
            conhecimento.TipoImpressao = empresa.Configuracao != null && empresa.Configuracao.TipoImpressao > 0 ? empresa.Configuracao.TipoImpressao : (Dominio.Enumeradores.TipoImpressao)cte.infCte.ide.tpImp;
            conhecimento.TipoAmbiente = (Dominio.Enumeradores.TipoAmbiente)(int)cte.infCte.ide.tpAmb;
            conhecimento.TipoServico = (Dominio.Enumeradores.TipoServico)cte.infCte.ide.tpServ;
            conhecimento.TipoCTE = (Dominio.Enumeradores.TipoCTE)cte.infCte.ide.tpCTe;
            conhecimento.ChaveCTEReferenciado = cte.infCte.ide.refCTE;
            conhecimento.Retira = cte.infCte.ide.retira == MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteIdeRetira.Item1 ? Dominio.Enumeradores.OpcaoSimNao.Nao : Dominio.Enumeradores.OpcaoSimNao.Sim;
            conhecimento.DetalhesRetira = cte.infCte.ide.xDetRetira;
            conhecimento.DataEmissao = DateTime.Now;
            conhecimento.TipoControle = 1;
            conhecimento.Numero = ObterProximoNumero(conhecimento, repCTe);

            repCTe.Inserir(conhecimento);

            this.SetarDestinatario(ref conhecimento, cte.infCte.dest, unidadeTrabalho);
            this.SetarExpedidor(ref conhecimento, cte.infCte.exped, unidadeTrabalho);
            this.SetarRecebedor(ref conhecimento, cte.infCte.receb, unidadeTrabalho);
            this.SetarRemetente(ref conhecimento, cte.infCte.rem, unidadeTrabalho);

            this.ObterICMS(ref conhecimento, cte.infCte.imp);
            this.ObterInformacoesTomador(ref conhecimento, cte.infCte.ide, unidadeTrabalho);
            this.ObterInformacoesCTe(ref conhecimento, cte.infCte, unidadeTrabalho);
            this.ObterInformacoesComplementares(ref conhecimento, cte.infCte.compl, unidadeTrabalho);
            this.SalvarInformacoesComponentesDaPrestacao(conhecimento, cte.infCte.vPrest.Comp, unidadeTrabalho);
            this.SalvarInformacoesRemetente(conhecimento, cte.infCte.rem, unidadeTrabalho);

            conhecimento.Status = "S";

            SetarTomadorPagadorCTe(ref conhecimento);

            repCTe.Atualizar(conhecimento);

            unidadeTrabalho.CommitChanges();

            return conhecimento;
        }

        private Dominio.Entidades.ConhecimentoDeTransporteEletronico GerarCTePorPreCTe(int codigoEmpresa, int codigoUsuario, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTe cte, Repositorio.UnitOfWork unidadeTrabalho)
        {
            Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeTrabalho);
            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeTrabalho);
            Repositorio.Usuario repUsuario = new Repositorio.Usuario(unidadeTrabalho);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);
            Repositorio.NaturezaDaOperacao repNatureza = new Repositorio.NaturezaDaOperacao(unidadeTrabalho);

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            Dominio.Entidades.Empresa empresa = codigoEmpresa > 0 ? repEmpresa.BuscarPorCodigo(codigoEmpresa) : repEmpresa.BuscarPorCNPJ(cte.infCte.emit.CNPJ);

            if (empresa == null)
                throw new Exception("Empresa não encontrada para a geração do CT-e.");

            Dominio.Entidades.Usuario usuario = codigoUsuario > 0 ? repUsuario.BuscarPorCodigo(codigoUsuario) : repUsuario.BuscarPrimeiroPorEmpresa(empresa.Codigo, Dominio.Enumeradores.TipoAcesso.Emissao);

            if (usuario == null)
                throw new Exception("Usuário não encontrado para a geração do CT-e.");

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();

            conhecimento.Empresa = empresa;
            conhecimento.CFOP = repCFOP.BuscarPorNumero(int.Parse(cte.infCte.ide.CFOP));
            conhecimento.NaturezaDaOperacao = conhecimento.CFOP != null ? conhecimento.CFOP.NaturezaDaOperacao : repNatureza.BuscarPrimeiroRegistro();
            conhecimento.ValorAReceber = decimal.Parse(cte.infCte.vPrest.vRec, cultura);
            conhecimento.ValorPrestacaoServico = decimal.Parse(cte.infCte.vPrest.vTPrest, cultura);
            conhecimento.ValorFrete = conhecimento.ValorPrestacaoServico;
            conhecimento.LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.infCte.ide.cMunIni));
            conhecimento.LocalidadeEmissao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.infCte.ide.cMunEnv));
            conhecimento.LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.infCte.ide.cMunFim));
            conhecimento.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);
            conhecimento.TipoPagamento = (Dominio.Enumeradores.TipoPagamento)cte.infCte.ide.forPag;
            conhecimento.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo(string.Format("{0:00}", (int)cte.infCte.ide.mod));
            conhecimento.Serie = this.ObterSerie(empresa, conhecimento.LocalidadeEmissao.Estado.Sigla, conhecimento.LocalidadeInicioPrestacao.Estado.Sigla, conhecimento.LocalidadeTerminoPrestacao.Estado.Sigla, conhecimento.Remetente?.CPF_CNPJ ?? string.Empty, conhecimento.Destinatario?.CPF_CNPJ ?? string.Empty, conhecimento.Recebedor?.CPF_CNPJ ?? string.Empty, conhecimento.Expedidor?.CPF_CNPJ ?? string.Empty, conhecimento.TomadorPagador?.CPF_CNPJ ?? string.Empty, unidadeTrabalho);
            conhecimento.TipoImpressao = empresa.Configuracao != null && empresa.Configuracao.TipoImpressao > 0 ? empresa.Configuracao.TipoImpressao : (Dominio.Enumeradores.TipoImpressao)cte.infCte.ide.tpImp;
            conhecimento.TipoAmbiente = empresa.TipoAmbiente;//(Dominio.Enumeradores.TipoAmbiente)(int)cte.infCte.ide.tpAmb;
            conhecimento.TipoServico = (Dominio.Enumeradores.TipoServico)cte.infCte.ide.tpServ;
            conhecimento.TipoCTE = (Dominio.Enumeradores.TipoCTE)cte.infCte.ide.tpCTe;
            conhecimento.ChaveCTEReferenciado = cte.infCte.ide.refCTE;
            conhecimento.Retira = cte.infCte.ide.retira == MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteIdeRetira.Item1 ? Dominio.Enumeradores.OpcaoSimNao.Nao : Dominio.Enumeradores.OpcaoSimNao.Sim;
            conhecimento.DetalhesRetira = cte.infCte.ide.xDetRetira;
            conhecimento.DataEmissao = DateTime.Now;
            conhecimento.TipoControle = 1;
            conhecimento.Numero = ObterProximoNumero(conhecimento, repCTe);

            repCTe.Inserir(conhecimento);

            this.SetarDestinatario(ref conhecimento, cte.infCte.dest, unidadeTrabalho);
            this.SetarExpedidor(ref conhecimento, cte.infCte.exped, unidadeTrabalho);
            this.SetarRecebedor(ref conhecimento, cte.infCte.receb, unidadeTrabalho);
            this.SetarRemetente(ref conhecimento, cte.infCte.rem, unidadeTrabalho);

            this.ObterICMS(ref conhecimento, cte.infCte.imp);
            this.ObterInformacoesTomador(ref conhecimento, cte.infCte.ide, unidadeTrabalho);
            this.ObterInformacoesCTe(ref conhecimento, cte.infCte, unidadeTrabalho);
            this.ObterInformacoesComplementares(ref conhecimento, cte.infCte.compl, unidadeTrabalho);
            this.SalvarInformacoesComponentesDaPrestacaoPreCTe(conhecimento, cte.infCte.vPrest.Comp, unidadeTrabalho);

            conhecimento.Status = "S";

            SetarTomadorPagadorCTe(ref conhecimento);

            repCTe.Atualizar(conhecimento);

            unidadeTrabalho.CommitChanges();

            return conhecimento;
        }

        private Dominio.Entidades.ConhecimentoDeTransporteEletronico GerarCTePorPreCTe(int codigoEmpresa, int codigoUsuario, MultiSoftware.CTe.v300.ConhecimentoDeTransporteProcessado.cteProc cte, Repositorio.UnitOfWork unidadeTrabalho, bool subContratacao, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware = null)
        {
            Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeTrabalho);
            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeTrabalho);
            Repositorio.Usuario repUsuario = new Repositorio.Usuario(unidadeTrabalho);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);
            Repositorio.NaturezaDaOperacao repNatureza = new Repositorio.NaturezaDaOperacao(unidadeTrabalho);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
            Repositorio.Atividade repAtividade = new Repositorio.Atividade(unidadeTrabalho);
            Cliente svcCliente = new Cliente(StringConexao);

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            Dominio.Entidades.Empresa empresa = codigoEmpresa > 0 ? repEmpresa.BuscarPorCodigo(codigoEmpresa) : repEmpresa.BuscarPorCNPJ(cte.CTe.infCte.emit.CNPJ);

            if (empresa == null)
                throw new Exception("Empresa não encontrada para a geração do CT-e.");

            Dominio.Entidades.Usuario usuario = codigoUsuario > 0 ? repUsuario.BuscarPorCodigo(codigoUsuario) : repUsuario.BuscarPrimeiroPorEmpresa(empresa.Codigo, Dominio.Enumeradores.TipoAcesso.Emissao);

            if (usuario == null)
                throw new Exception("Usuário não encontrado para a geração do CT-e.");

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();

            conhecimento.Empresa = empresa;
            conhecimento.Versao = empresa.Configuracao != null && !string.IsNullOrWhiteSpace(empresa.Configuracao.VersaoCTe) ? empresa.Configuracao.VersaoCTe : empresa.EmpresaPai.Configuracao != null && !string.IsNullOrWhiteSpace(empresa.EmpresaPai.Configuracao.VersaoCTe) ? empresa.EmpresaPai.Configuracao.VersaoCTe : "4.00";
            conhecimento.CFOP = repCFOP.BuscarPorNumero(int.Parse(cte.CTe.infCte.ide.CFOP));
            conhecimento.NaturezaDaOperacao = conhecimento.CFOP != null ? conhecimento.CFOP.NaturezaDaOperacao : repNatureza.BuscarPrimeiroRegistro();
            conhecimento.ValorAReceber = decimal.Parse(cte.CTe.infCte.vPrest.vRec, cultura);
            conhecimento.ValorPrestacaoServico = decimal.Parse(cte.CTe.infCte.vPrest.vTPrest, cultura);
            conhecimento.ValorFrete = conhecimento.ValorPrestacaoServico;
            conhecimento.LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunIni));
            conhecimento.LocalidadeEmissao = empresa.Localidade;// repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunEnv));
            conhecimento.LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunFim));
            conhecimento.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);
            conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Pago;
            conhecimento.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("57");

            conhecimento.Serie = this.ObterSerie(empresa, conhecimento.LocalidadeEmissao.Estado.Sigla, conhecimento.LocalidadeInicioPrestacao.Estado.Sigla, conhecimento.LocalidadeTerminoPrestacao.Estado.Sigla, conhecimento.Remetente?.CPF_CNPJ ?? string.Empty, conhecimento.Destinatario?.CPF_CNPJ ?? string.Empty, conhecimento.Recebedor?.CPF_CNPJ ?? string.Empty, conhecimento.Expedidor?.CPF_CNPJ ?? string.Empty, conhecimento.TomadorPagador?.CPF_CNPJ ?? string.Empty, unidadeTrabalho, null, usuario);
            conhecimento.TipoImpressao = empresa.Configuracao != null && empresa.Configuracao.TipoImpressao > 0 ? empresa.Configuracao.TipoImpressao : (Dominio.Enumeradores.TipoImpressao)cte.CTe.infCte.ide.tpImp;
            conhecimento.TipoAmbiente = empresa.TipoAmbiente;
            conhecimento.TipoServico = subContratacao ? Dominio.Enumeradores.TipoServico.SubContratacao : (Dominio.Enumeradores.TipoServico)cte.CTe.infCte.ide.tpServ;
            conhecimento.TipoCTE = (Dominio.Enumeradores.TipoCTE)cte.CTe.infCte.ide.tpCTe;
            //conhecimento.ChaveCTEReferenciado = cte.infCte.ide.refCTE;
            conhecimento.Retira = cte.CTe.infCte.ide.retira == MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteIdeRetira.Item1 ? Dominio.Enumeradores.OpcaoSimNao.Nao : Dominio.Enumeradores.OpcaoSimNao.Sim;
            conhecimento.DetalhesRetira = cte.CTe.infCte.ide.xDetRetira;
            conhecimento.DataEmissao = DateTime.Now;
            conhecimento.TipoControle = 1;
            conhecimento.Numero = ObterProximoNumero(conhecimento, repCTe);

            repCTe.Inserir(conhecimento);

            this.SetarDestinatario(ref conhecimento, cte.CTe.infCte.dest, unidadeTrabalho, out string erro, tipoServicoMultisoftware);
            this.SetarExpedidor(ref conhecimento, cte.CTe.infCte.exped, unidadeTrabalho, out erro, tipoServicoMultisoftware);
            this.SetarRecebedor(ref conhecimento, cte.CTe.infCte.receb, unidadeTrabalho, out erro, tipoServicoMultisoftware);
            this.SetarRemetente(ref conhecimento, cte.CTe.infCte.rem, unidadeTrabalho, out erro, tipoServicoMultisoftware);

            this.ObterICMS(ref conhecimento, cte.CTe.infCte.imp);
            this.ObterInformacoesTomador(ref conhecimento, cte.CTe.infCte.ide, unidadeTrabalho, out erro, tipoServicoMultisoftware);
            this.ObterInformacoesCTe(ref conhecimento, cte.CTe.infCte, false, unidadeTrabalho);
            this.ObterInformacoesComplementares(ref conhecimento, cte.CTe.infCte.compl, unidadeTrabalho);
            this.SalvarInformacoesComponentesDaPrestacaoPreCTe(conhecimento, cte.CTe.infCte.vPrest.Comp, unidadeTrabalho);
            SetarTomadorPagadorCTe(ref conhecimento);

            Dominio.Entidades.Cliente clienteAnterior = repCliente.BuscarPorCPFCNPJ(double.Parse(cte.CTe.infCte.emit.CNPJ));
            if (clienteAnterior == null)
            {
                Dominio.Entidades.Localidade localidadeAnterior = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.emit.enderEmit.cMun));
                if (localidadeAnterior != null)
                {
                    clienteAnterior = new Dominio.Entidades.Cliente();
                    clienteAnterior.CPF_CNPJ = double.Parse(cte.CTe.infCte.emit.CNPJ);
                    clienteAnterior.IE_RG = cte.CTe.infCte.emit.IE;
                    clienteAnterior.Tipo = "J";
                    clienteAnterior.Atividade = repAtividade.BuscarPorCodigo(4);
                    clienteAnterior.Nome = cte.CTe.infCte.emit.xNome;
                    clienteAnterior.NomeFantasia = cte.CTe.infCte.emit.xFant;
                    clienteAnterior.Endereco = cte.CTe.infCte.emit.enderEmit.xLgr;
                    clienteAnterior.Bairro = cte.CTe.infCte.emit.enderEmit.xBairro;
                    clienteAnterior.Numero = cte.CTe.infCte.emit.enderEmit.nro;
                    clienteAnterior.CEP = cte.CTe.infCte.emit.enderEmit.CEP;
                    clienteAnterior.Localidade = localidadeAnterior;
                    repCliente.Inserir(clienteAnterior);
                }
            }

            if (clienteAnterior != null)
            {
                conhecimento.TipoServico = Dominio.Enumeradores.TipoServico.SubContratacao;
                conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Outros;

                Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior documentoAnterior = new Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior();
                documentoAnterior.Chave = cte.protCTe.infProt.chCTe;
                documentoAnterior.Emissor = svcCliente.ObterClienteCTE(clienteAnterior, null);

                List<Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior> listaDocumentosAnterior = new List<Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior>();
                listaDocumentosAnterior.Add(documentoAnterior);

                this.SalvarInformacoesDocumentosAnteriores(conhecimento, listaDocumentosAnterior, unidadeTrabalho, false);
                this.CalcularICMSPorTabelaDeAliquotas(ref conhecimento, empresa.OptanteSimplesNacional ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao, unidadeTrabalho);
            }

            conhecimento.Status = "S";

            repCTe.Atualizar(conhecimento);

            unidadeTrabalho.CommitChanges();

            return conhecimento;
        }

        private Dominio.Entidades.ConhecimentoDeTransporteEletronico GerarCTePorPreCTe(int codigoEmpresa, int codigoUsuario, MultiSoftware.CTe.v400.ConhecimentoDeTransporteProcessado.cteProc cte, Repositorio.UnitOfWork unidadeTrabalho, bool subContratacao, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware = null)
        {
            Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeTrabalho);
            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeTrabalho);
            Repositorio.Usuario repUsuario = new Repositorio.Usuario(unidadeTrabalho);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);
            Repositorio.NaturezaDaOperacao repNatureza = new Repositorio.NaturezaDaOperacao(unidadeTrabalho);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
            Repositorio.Atividade repAtividade = new Repositorio.Atividade(unidadeTrabalho);
            Cliente svcCliente = new Cliente(StringConexao);

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            Dominio.Entidades.Empresa empresa = codigoEmpresa > 0 ? repEmpresa.BuscarPorCodigo(codigoEmpresa) : repEmpresa.BuscarPorCNPJ(cte.CTe.infCte.emit.Item);

            if (empresa == null)
                throw new Exception("Empresa não encontrada para a geração do CT-e.");

            Dominio.Entidades.Usuario usuario = codigoUsuario > 0 ? repUsuario.BuscarPorCodigo(codigoUsuario) : repUsuario.BuscarPrimeiroPorEmpresa(empresa.Codigo, Dominio.Enumeradores.TipoAcesso.Emissao);

            if (usuario == null)
                throw new Exception("Usuário não encontrado para a geração do CT-e.");

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();

            conhecimento.Empresa = empresa;
            conhecimento.Versao = empresa.Configuracao != null && !string.IsNullOrWhiteSpace(empresa.Configuracao.VersaoCTe) ? empresa.Configuracao.VersaoCTe : empresa.EmpresaPai.Configuracao != null && !string.IsNullOrWhiteSpace(empresa.EmpresaPai.Configuracao.VersaoCTe) ? empresa.EmpresaPai.Configuracao.VersaoCTe : "4.00";
            conhecimento.CFOP = repCFOP.BuscarPorNumero(int.Parse(cte.CTe.infCte.ide.CFOP));
            conhecimento.NaturezaDaOperacao = conhecimento.CFOP != null ? conhecimento.CFOP.NaturezaDaOperacao : repNatureza.BuscarPrimeiroRegistro();
            conhecimento.ValorAReceber = decimal.Parse(cte.CTe.infCte.vPrest.vRec, cultura);
            conhecimento.ValorPrestacaoServico = decimal.Parse(cte.CTe.infCte.vPrest.vTPrest, cultura);
            conhecimento.ValorFrete = conhecimento.ValorPrestacaoServico;
            conhecimento.LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunIni));
            conhecimento.LocalidadeEmissao = empresa.Localidade;// repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunEnv));
            conhecimento.LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunFim));
            conhecimento.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);
            conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Pago;
            conhecimento.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("57");

            conhecimento.Serie = this.ObterSerie(empresa, conhecimento.LocalidadeEmissao.Estado.Sigla, conhecimento.LocalidadeInicioPrestacao.Estado.Sigla, conhecimento.LocalidadeTerminoPrestacao.Estado.Sigla, conhecimento.Remetente?.CPF_CNPJ ?? string.Empty, conhecimento.Destinatario?.CPF_CNPJ ?? string.Empty, conhecimento.Recebedor?.CPF_CNPJ ?? string.Empty, conhecimento.Expedidor?.CPF_CNPJ ?? string.Empty, conhecimento.TomadorPagador?.CPF_CNPJ ?? string.Empty, unidadeTrabalho, null, usuario);
            conhecimento.TipoImpressao = empresa.Configuracao != null && empresa.Configuracao.TipoImpressao > 0 ? empresa.Configuracao.TipoImpressao : (Dominio.Enumeradores.TipoImpressao)cte.CTe.infCte.ide.tpImp;
            conhecimento.TipoAmbiente = empresa.TipoAmbiente;
            conhecimento.TipoServico = subContratacao ? Dominio.Enumeradores.TipoServico.SubContratacao : (Dominio.Enumeradores.TipoServico)cte.CTe.infCte.ide.tpServ;
            conhecimento.TipoCTE = (Dominio.Enumeradores.TipoCTE)cte.CTe.infCte.ide.tpCTe;
            //conhecimento.ChaveCTEReferenciado = cte.infCte.ide.refCTE;
            conhecimento.Retira = cte.CTe.infCte.ide.retira == MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteIdeRetira.Item1 ? Dominio.Enumeradores.OpcaoSimNao.Nao : Dominio.Enumeradores.OpcaoSimNao.Sim;
            conhecimento.DetalhesRetira = cte.CTe.infCte.ide.xDetRetira;
            conhecimento.DataEmissao = DateTime.Now;
            conhecimento.TipoControle = 1;
            conhecimento.Numero = ObterProximoNumero(conhecimento, repCTe);

            repCTe.Inserir(conhecimento);

            this.SetarDestinatario(ref conhecimento, cte.CTe.infCte.dest, unidadeTrabalho, out string erro, tipoServicoMultisoftware);
            this.SetarExpedidor(ref conhecimento, cte.CTe.infCte.exped, unidadeTrabalho, out erro, tipoServicoMultisoftware);
            this.SetarRecebedor(ref conhecimento, cte.CTe.infCte.receb, unidadeTrabalho, out erro, tipoServicoMultisoftware);
            this.SetarRemetente(ref conhecimento, cte.CTe.infCte.rem, unidadeTrabalho, out erro, tipoServicoMultisoftware);

            this.ObterICMS(ref conhecimento, cte.CTe.infCte.imp);
            this.ObterInformacoesTomador(ref conhecimento, cte.CTe.infCte.ide, unidadeTrabalho, out erro, tipoServicoMultisoftware);
            this.ObterInformacoesCTe(ref conhecimento, cte.CTe.infCte, false, unidadeTrabalho);
            this.ObterInformacoesComplementares(ref conhecimento, cte.CTe.infCte.compl, unidadeTrabalho);
            this.SalvarInformacoesComponentesDaPrestacaoPreCTe(conhecimento, cte.CTe.infCte.vPrest.Comp, unidadeTrabalho);
            SetarTomadorPagadorCTe(ref conhecimento);

            Dominio.Entidades.Cliente clienteAnterior = repCliente.BuscarPorCPFCNPJ(double.Parse(cte.CTe.infCte.emit.Item));
            if (clienteAnterior == null)
            {
                Dominio.Entidades.Localidade localidadeAnterior = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.emit.enderEmit.cMun));
                if (localidadeAnterior != null)
                {
                    clienteAnterior = new Dominio.Entidades.Cliente();
                    clienteAnterior.CPF_CNPJ = double.Parse(cte.CTe.infCte.emit.Item);
                    clienteAnterior.IE_RG = cte.CTe.infCte.emit.IE;
                    clienteAnterior.Tipo = "J";
                    clienteAnterior.Atividade = repAtividade.BuscarPorCodigo(4);
                    clienteAnterior.Nome = cte.CTe.infCte.emit.xNome;
                    clienteAnterior.NomeFantasia = cte.CTe.infCte.emit.xFant;
                    clienteAnterior.Endereco = cte.CTe.infCte.emit.enderEmit.xLgr;
                    clienteAnterior.Bairro = cte.CTe.infCte.emit.enderEmit.xBairro;
                    clienteAnterior.Numero = cte.CTe.infCte.emit.enderEmit.nro;
                    clienteAnterior.CEP = cte.CTe.infCte.emit.enderEmit.CEP;
                    clienteAnterior.Localidade = localidadeAnterior;
                    repCliente.Inserir(clienteAnterior);
                }
            }

            if (clienteAnterior != null)
            {
                conhecimento.TipoServico = Dominio.Enumeradores.TipoServico.SubContratacao;
                conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Outros;

                Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior documentoAnterior = new Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior();
                documentoAnterior.Chave = cte.protCTe.infProt.chCTe;
                documentoAnterior.Emissor = svcCliente.ObterClienteCTE(clienteAnterior, null);

                List<Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior> listaDocumentosAnterior = new List<Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior>();
                listaDocumentosAnterior.Add(documentoAnterior);

                this.SalvarInformacoesDocumentosAnteriores(conhecimento, listaDocumentosAnterior, unidadeTrabalho, false);
                this.CalcularICMSPorTabelaDeAliquotas(ref conhecimento, empresa.OptanteSimplesNacional ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao, unidadeTrabalho);
            }

            conhecimento.Status = "S";

            repCTe.Atualizar(conhecimento);

            unidadeTrabalho.CommitChanges();

            return conhecimento;
        }

        private Dominio.Entidades.ConhecimentoDeTransporteEletronico AdicionarCTeSubcontratacao(int codigoCTe, int codigoEmpresa, int codigoUsuario, MultiSoftware.CTe.v300.ConhecimentoDeTransporteProcessado.cteProc cte, Repositorio.UnitOfWork unidadeTrabalho, bool subContratacao)
        {
            Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeTrabalho);
            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeTrabalho);
            Repositorio.Usuario repUsuario = new Repositorio.Usuario(unidadeTrabalho);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);
            Repositorio.NaturezaDaOperacao repNatureza = new Repositorio.NaturezaDaOperacao(unidadeTrabalho);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
            Repositorio.Atividade repAtividade = new Repositorio.Atividade(unidadeTrabalho);
            Cliente svcCliente = new Cliente(StringConexao);

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            Dominio.Entidades.Empresa empresa = codigoEmpresa > 0 ? repEmpresa.BuscarPorCodigo(codigoEmpresa) : repEmpresa.BuscarPorCNPJ(cte.CTe.infCte.emit.CNPJ);

            if (empresa == null)
                throw new Exception("Empresa não encontrada para a geração do CT-e.");

            Dominio.Entidades.Usuario usuario = codigoUsuario > 0 ? repUsuario.BuscarPorCodigo(codigoUsuario) : repUsuario.BuscarPrimeiroPorEmpresa(empresa.Codigo, Dominio.Enumeradores.TipoAcesso.Emissao);

            if (usuario == null)
                throw new Exception("Usuário não encontrado para a geração do CT-e.");

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = repCTe.BuscarPorCodigo(codigoCTe);

            if (conhecimento == null)
                throw new Exception("CTe não encontrado.");

            bool importarValores = !empresa.Configuracao?.NaoImportarValoresImportacaoCTe ?? true;

            conhecimento.NaturezaDaOperacao = conhecimento.CFOP != null ? conhecimento.CFOP.NaturezaDaOperacao : repNatureza.BuscarPrimeiroRegistro();
            if (importarValores)
            {
                conhecimento.ValorAReceber += decimal.Parse(cte.CTe.infCte.vPrest.vRec, cultura);
                conhecimento.ValorPrestacaoServico += decimal.Parse(cte.CTe.infCte.vPrest.vTPrest, cultura);
                conhecimento.ValorFrete = conhecimento.ValorPrestacaoServico;
            }
            conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Pago;
            conhecimento.TipoControle = 1;

            repCTe.Atualizar(conhecimento);

            this.SomarInformacoesCTeSubcontratacao(ref conhecimento, cte.CTe.infCte, importarValores, false, unidadeTrabalho);
            if (importarValores)
                this.SalvarInformacoesComponentesDaPrestacaoPreCTe(conhecimento, cte.CTe.infCte.vPrest.Comp, unidadeTrabalho);

            Dominio.Entidades.Cliente clienteAnterior = repCliente.BuscarPorCPFCNPJ(double.Parse(cte.CTe.infCte.emit.CNPJ));
            if (clienteAnterior == null)
            {
                Dominio.Entidades.Localidade localidadeAnterior = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.emit.enderEmit.cMun));
                if (localidadeAnterior != null)
                {
                    clienteAnterior = new Dominio.Entidades.Cliente();
                    clienteAnterior.CPF_CNPJ = double.Parse(cte.CTe.infCte.emit.CNPJ);
                    clienteAnterior.IE_RG = cte.CTe.infCte.emit.IE;
                    clienteAnterior.Tipo = "J";
                    clienteAnterior.Atividade = repAtividade.BuscarPorCodigo(4);
                    clienteAnterior.Nome = cte.CTe.infCte.emit.xNome;
                    clienteAnterior.NomeFantasia = cte.CTe.infCte.emit.xFant;
                    clienteAnterior.Endereco = cte.CTe.infCte.emit.enderEmit.xLgr;
                    clienteAnterior.Bairro = cte.CTe.infCte.emit.enderEmit.xBairro;
                    clienteAnterior.Numero = cte.CTe.infCte.emit.enderEmit.nro;
                    clienteAnterior.CEP = cte.CTe.infCte.emit.enderEmit.CEP;
                    clienteAnterior.Localidade = localidadeAnterior;
                    repCliente.Inserir(clienteAnterior);
                }
            }

            if (clienteAnterior != null)
            {
                conhecimento.TipoServico = Dominio.Enumeradores.TipoServico.SubContratacao;
                conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Outros;

                Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior documentoAnterior = new Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior();
                documentoAnterior.Chave = cte.protCTe.infProt.chCTe;
                documentoAnterior.Emissor = svcCliente.ObterClienteCTE(clienteAnterior, null);

                List<Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior> listaDocumentosAnterior = new List<Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior>();
                listaDocumentosAnterior.Add(documentoAnterior);

                this.SalvarInformacoesDocumentosAnteriores(conhecimento, listaDocumentosAnterior, unidadeTrabalho, false);
                this.CalcularICMSPorTabelaDeAliquotas(ref conhecimento, empresa.OptanteSimplesNacional ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao, unidadeTrabalho);
            }

            conhecimento.Status = "S";

            repCTe.Atualizar(conhecimento);

            unidadeTrabalho.CommitChanges();

            return conhecimento;
        }

        private Dominio.Entidades.ConhecimentoDeTransporteEletronico AdicionarCTeSubcontratacao(int codigoCTe, int codigoEmpresa, int codigoUsuario, MultiSoftware.CTe.v400.ConhecimentoDeTransporteProcessado.cteProc cte, Repositorio.UnitOfWork unidadeTrabalho, bool subContratacao)
        {
            Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeTrabalho);
            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeTrabalho);
            Repositorio.Usuario repUsuario = new Repositorio.Usuario(unidadeTrabalho);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);
            Repositorio.NaturezaDaOperacao repNatureza = new Repositorio.NaturezaDaOperacao(unidadeTrabalho);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
            Repositorio.Atividade repAtividade = new Repositorio.Atividade(unidadeTrabalho);
            Cliente svcCliente = new Cliente(StringConexao);

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            Dominio.Entidades.Empresa empresa = codigoEmpresa > 0 ? repEmpresa.BuscarPorCodigo(codigoEmpresa) : repEmpresa.BuscarPorCNPJ(cte.CTe.infCte.emit.Item);

            if (empresa == null)
                throw new Exception("Empresa não encontrada para a geração do CT-e.");

            Dominio.Entidades.Usuario usuario = codigoUsuario > 0 ? repUsuario.BuscarPorCodigo(codigoUsuario) : repUsuario.BuscarPrimeiroPorEmpresa(empresa.Codigo, Dominio.Enumeradores.TipoAcesso.Emissao);

            if (usuario == null)
                throw new Exception("Usuário não encontrado para a geração do CT-e.");

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = repCTe.BuscarPorCodigo(codigoCTe);

            if (conhecimento == null)
                throw new Exception("CTe não encontrado.");

            bool importarValores = !empresa.Configuracao?.NaoImportarValoresImportacaoCTe ?? true;

            conhecimento.NaturezaDaOperacao = conhecimento.CFOP != null ? conhecimento.CFOP.NaturezaDaOperacao : repNatureza.BuscarPrimeiroRegistro();
            if (importarValores)
            {
                conhecimento.ValorAReceber += decimal.Parse(cte.CTe.infCte.vPrest.vRec, cultura);
                conhecimento.ValorPrestacaoServico += decimal.Parse(cte.CTe.infCte.vPrest.vTPrest, cultura);
                conhecimento.ValorFrete = conhecimento.ValorPrestacaoServico;
            }
            conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Pago;
            conhecimento.TipoControle = 1;

            repCTe.Atualizar(conhecimento);

            this.SomarInformacoesCTeSubcontratacao(ref conhecimento, cte.CTe.infCte, importarValores, false, unidadeTrabalho);
            if (importarValores)
                this.SalvarInformacoesComponentesDaPrestacaoPreCTe(conhecimento, cte.CTe.infCte.vPrest.Comp, unidadeTrabalho);

            Dominio.Entidades.Cliente clienteAnterior = repCliente.BuscarPorCPFCNPJ(double.Parse(cte.CTe.infCte.emit.Item));
            if (clienteAnterior == null)
            {
                Dominio.Entidades.Localidade localidadeAnterior = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.emit.enderEmit.cMun));
                if (localidadeAnterior != null)
                {
                    clienteAnterior = new Dominio.Entidades.Cliente();
                    clienteAnterior.CPF_CNPJ = double.Parse(cte.CTe.infCte.emit.Item);
                    clienteAnterior.IE_RG = cte.CTe.infCte.emit.IE;
                    clienteAnterior.Tipo = "J";
                    clienteAnterior.Atividade = repAtividade.BuscarPorCodigo(4);
                    clienteAnterior.Nome = cte.CTe.infCte.emit.xNome;
                    clienteAnterior.NomeFantasia = cte.CTe.infCte.emit.xFant;
                    clienteAnterior.Endereco = cte.CTe.infCte.emit.enderEmit.xLgr;
                    clienteAnterior.Bairro = cte.CTe.infCte.emit.enderEmit.xBairro;
                    clienteAnterior.Numero = cte.CTe.infCte.emit.enderEmit.nro;
                    clienteAnterior.CEP = cte.CTe.infCte.emit.enderEmit.CEP;
                    clienteAnterior.Localidade = localidadeAnterior;
                    repCliente.Inserir(clienteAnterior);
                }
            }

            if (clienteAnterior != null)
            {
                conhecimento.TipoServico = Dominio.Enumeradores.TipoServico.SubContratacao;
                conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Outros;

                Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior documentoAnterior = new Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior();
                documentoAnterior.Chave = cte.protCTe.infProt.chCTe;
                documentoAnterior.Emissor = svcCliente.ObterClienteCTE(clienteAnterior, null);

                List<Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior> listaDocumentosAnterior = new List<Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior>();
                listaDocumentosAnterior.Add(documentoAnterior);

                this.SalvarInformacoesDocumentosAnteriores(conhecimento, listaDocumentosAnterior, unidadeTrabalho, false);
                this.CalcularICMSPorTabelaDeAliquotas(ref conhecimento, empresa.OptanteSimplesNacional ? Dominio.Enumeradores.OpcaoSimNao.Sim : Dominio.Enumeradores.OpcaoSimNao.Nao, unidadeTrabalho);
            }

            conhecimento.Status = "S";

            repCTe.Atualizar(conhecimento);

            unidadeTrabalho.CommitChanges();

            return conhecimento;
        }

        private object GerarCTeAnterior(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v104.ConhecimentoDeTransporteProcessado.cteProc cte, Stream xml, Repositorio.UnitOfWork unidadeTrabalho, bool importacaoCTeCIOT = false, bool retornaCTeJaInserido = false, bool importarCTeOracle = true, bool utilizarEmpresaDoCTe = false, string numeroControle = "")
        {
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeTrabalho);

            Dominio.Entidades.Empresa empresaUtilizar = null;

            if (utilizarEmpresaDoCTe)
                empresaUtilizar = repEmpresa.BuscarPorCNPJ(cte.CTe.infCte.emit.CNPJ);
            else
                empresaUtilizar = empresa;

            if (cte.protCTe.infProt.cStat != "100")
            {
                return string.Concat("O status (", cte.protCTe.infProt.cStat, " - ", Utilidades.String.Left(cte.protCTe.infProt.xMotivo, 60), ") do CT-e (", cte.CTe.infCte.ide.nCT, " - ", cte.CTe.infCte.ide.serie, ") é inválido para a importação.");
            }

            if (!utilizarEmpresaDoCTe && !importacaoCTeCIOT && !Utilidades.String.OnlyNumbers(cte.CTe.infCte.emit.CNPJ).Equals(Utilidades.String.OnlyNumbers(empresaUtilizar.CNPJ)))
            {
                return string.Concat("O CNPJ (", cte.CTe.infCte.emit.CNPJ, ") do emitente do CT-e (", cte.CTe.infCte.ide.nCT, " - ", cte.CTe.infCte.ide.serie, ") é diferente do CNPJ da empresa emitente (", empresaUtilizar.CNPJ, ").");
            }

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = repCTe.BuscarPorChave(empresaUtilizar.Codigo, cte.protCTe.infProt.chCTe);

            if (!importacaoCTeCIOT && conhecimento == null)
                conhecimento = repCTe.BuscarPorNumeroESerie(empresaUtilizar.Codigo, int.Parse(cte.CTe.infCte.ide.nCT), int.Parse(cte.CTe.infCte.ide.serie), "57", (Dominio.Enumeradores.TipoAmbiente)cte.protCTe.infProt.tpAmb);

            if (conhecimento != null)
            {
                unidadeTrabalho.Rollback();
                if (importacaoCTeCIOT || retornaCTeJaInserido)
                    return conhecimento;
                else
                    return string.Concat("CT-e com mesmo número e série (", cte.CTe.infCte.ide.nCT, " - ", cte.CTe.infCte.ide.serie, ") ou chave (", cte.protCTe.infProt.chCTe, ") já existe no sistema.");
            }

            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            conhecimento = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();
            conhecimento.Empresa = empresaUtilizar;
            conhecimento.TipoControle = 1;
            conhecimento.CFOP = this.ObterCFOP(int.Parse(cte.CTe.infCte.ide.CFOP), unidadeTrabalho);
            conhecimento.NaturezaDaOperacao = conhecimento.CFOP.NaturezaDaOperacao;
            conhecimento.ValorAReceber = decimal.Parse(cte.CTe.infCte.vPrest.vRec, cultura);
            conhecimento.ValorPrestacaoServico = decimal.Parse(cte.CTe.infCte.vPrest.vTPrest, cultura);
            conhecimento.ValorFrete = conhecimento.ValorPrestacaoServico;
            conhecimento.LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunIni));
            conhecimento.LocalidadeEmissao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunEnv));
            conhecimento.LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunFim));
            conhecimento.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);
            conhecimento.TipoPagamento = (Dominio.Enumeradores.TipoPagamento)cte.CTe.infCte.ide.forPag;
            conhecimento.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo(string.Format("{0:00}", (int)cte.CTe.infCte.ide.mod));
            conhecimento.Serie = this.ObterSerie(empresaUtilizar, int.Parse(cte.CTe.infCte.ide.serie), unidadeTrabalho);
            conhecimento.TipoImpressao = (Dominio.Enumeradores.TipoImpressao)cte.CTe.infCte.ide.tpImp;
            conhecimento.TipoServico = (Dominio.Enumeradores.TipoServico)cte.CTe.infCte.ide.tpServ;
            conhecimento.TipoCTE = (Dominio.Enumeradores.TipoCTE)cte.CTe.infCte.ide.tpCTe;


            conhecimento.Retira = cte.CTe.infCte.ide.retira == MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteIdeRetira.Item1 ? Dominio.Enumeradores.OpcaoSimNao.Nao : Dominio.Enumeradores.OpcaoSimNao.Sim;
            conhecimento.DetalhesRetira = cte.CTe.infCte.ide.xDetRetira;
            DateTime dataEmissao;
            DateTime.TryParseExact(cte.CTe.infCte.ide.dhEmi, "yyyy-MM-ddTHH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataEmissao);
            conhecimento.DataEmissao = dataEmissao;
            conhecimento.Numero = int.Parse(cte.CTe.infCte.ide.nCT);
            conhecimento.Status = "A";
            conhecimento.Cancelado = "N";
            conhecimento.Chave = cte.protCTe.infProt.chCTe;
            conhecimento.Protocolo = cte.protCTe.infProt.nProt;
            conhecimento.DataRetornoSefaz = cte.protCTe.infProt.dhRecbto;
            conhecimento.DataAutorizacao = cte.protCTe.infProt.dhRecbto;

            if (conhecimento.TipoCTE == Dominio.Enumeradores.TipoCTE.Anulacao)
                conhecimento.DataAnulacao = conhecimento.DataAutorizacao;

            conhecimento.Versao = cte.protCTe.versao;
            conhecimento.MensagemRetornoSefaz = "CTe Processado (Importação).";
            conhecimento.CTeImportadoEmbarcador = true;
            conhecimento.NumeroControle = numeroControle;
            conhecimento.TipoAmbiente = (Dominio.Enumeradores.TipoAmbiente)cte.protCTe.infProt.tpAmb;
            conhecimento.Log = string.Concat("CT-e importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");
            if (importacaoCTeCIOT)
                conhecimento.ObservacoesAvancadas = Utilidades.String.OnlyNumbers(cte.CTe.infCte.emit.CNPJ);

            repCTe.Inserir(conhecimento);

            if (string.IsNullOrWhiteSpace(conhecimento.NumeroControle))
                conhecimento.NumeroControle = conhecimento.Codigo.ToString("D");
            repCTe.Atualizar(conhecimento);

            this.SetarDestinatario(ref conhecimento, cte.CTe.infCte.dest, unidadeTrabalho);
            this.SetarExpedidor(ref conhecimento, cte.CTe.infCte.exped, unidadeTrabalho);
            this.SetarRecebedor(ref conhecimento, cte.CTe.infCte.receb, unidadeTrabalho);
            this.SetarRemetente(ref conhecimento, cte.CTe.infCte.rem, unidadeTrabalho);

            this.ObterICMS(ref conhecimento, cte.CTe.infCte.imp);
            this.ObterInformacoesTomador(ref conhecimento, cte.CTe.infCte.ide, unidadeTrabalho);
            this.ObterInformacoesCTe(ref conhecimento, cte.CTe.infCte, unidadeTrabalho);
            this.ObterInformacoesComplementares(ref conhecimento, cte.CTe.infCte.compl, unidadeTrabalho);
            this.SalvarInformacoesComponentesDaPrestacao(conhecimento, cte.CTe.infCte.vPrest.Comp, unidadeTrabalho);
            this.SalvarInformacoesRemetente(conhecimento, cte.CTe.infCte.rem, unidadeTrabalho);

            SetarTomadorPagadorCTe(ref conhecimento);

            repCTe.Atualizar(conhecimento);

            Repositorio.IntegracaoCTeRecebimento repIntegracaoCTeRecebimento = new Repositorio.IntegracaoCTeRecebimento(unidadeTrabalho);
            Dominio.Entidades.IntegracaoCTeRecebimento integracaoCTeRecebimento = new Dominio.Entidades.IntegracaoCTeRecebimento();
            integracaoCTeRecebimento.CTe = conhecimento;
            integracaoCTeRecebimento.Data = DateTime.Now;
            integracaoCTeRecebimento.DataStatus = DateTime.Now;
            integracaoCTeRecebimento.Status = Dominio.Enumeradores.StatusIntegracaoRecebimentoCTe.Pendente;
            integracaoCTeRecebimento.Tipo = Dominio.Enumeradores.TipoIntegracaoEnvioCTe.Autorizacao;
            repIntegracaoCTeRecebimento.Inserir(integracaoCTeRecebimento);

            unidadeTrabalho.CommitChanges();

            if (importarCTeOracle)
                return this.TransmitirCTeAnterior(empresaUtilizar, ref conhecimento, xml, unidadeTrabalho);
            else
                return conhecimento;
        }

        public object GerarCTeAnterior(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v200.ConhecimentoDeTransporteProcessado.cteProc cte, Stream xml, Repositorio.UnitOfWork unidadeTrabalho, string expressaoRegularBooking, string expressaoRegularContainer, bool importacaoCTeCIOT = false, bool retornaCTeJaInserido = false, bool importarCTeOracle = true, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware = null, bool utilizarEmpresaDoCTe = false, string numeroControle = "")
        {
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeTrabalho);

            Dominio.Entidades.Empresa empresaUtilizar = null;

            if (utilizarEmpresaDoCTe)
                empresaUtilizar = repEmpresa.BuscarPorCNPJ(cte.CTe.infCte.emit.CNPJ);
            else
                empresaUtilizar = empresa;

            if (cte.protCTe.infProt.cStat != "100")
            {
                return string.Concat("O status (", cte.protCTe.infProt.cStat, " - ", Utilidades.String.Left(cte.protCTe.infProt.xMotivo, 60), ") do CT-e (", cte.CTe.infCte.ide.nCT, " - ", cte.CTe.infCte.ide.serie, ") é inválido para a importação.");
            }

            if (!utilizarEmpresaDoCTe && !importacaoCTeCIOT && !Utilidades.String.OnlyNumbers(cte.CTe.infCte.emit.CNPJ).Equals(Utilidades.String.OnlyNumbers(empresaUtilizar.CNPJ)))
            {
                return string.Concat("O CNPJ (", cte.CTe.infCte.emit.CNPJ, ") do emitente do CT-e (", cte.CTe.infCte.ide.nCT, " - ", cte.CTe.infCte.ide.serie, ") é diferente do CNPJ da empresa emitente (", empresaUtilizar.CNPJ, ").");
            }

            unidadeTrabalho.Start();

            Dominio.Entidades.EmpresaSerie serie = this.ObterSerie(empresaUtilizar, int.Parse(cte.CTe.infCte.ide.serie), unidadeTrabalho);

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = repCTe.BuscarPorChave(empresaUtilizar.Codigo, cte.protCTe.infProt.chCTe);

            if (!importacaoCTeCIOT && conhecimento == null)
                conhecimento = repCTe.BuscarPorNumeroESerie(empresaUtilizar.Codigo, int.Parse(cte.CTe.infCte.ide.nCT), int.Parse(cte.CTe.infCte.ide.serie), "57", (Dominio.Enumeradores.TipoAmbiente)cte.protCTe.infProt.tpAmb);

            if (conhecimento != null)
            {
                unidadeTrabalho.Rollback();

                if (importacaoCTeCIOT || retornaCTeJaInserido)
                    return conhecimento;
                else
                    return string.Concat("CT-e com mesmo número e série (", cte.CTe.infCte.ide.nCT, " - ", cte.CTe.infCte.ide.serie, ") ou chave (", cte.protCTe.infProt.chCTe, ") já existe no sistema.");
            }

            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoSGT = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unidadeTrabalho);
            Repositorio.NaturezaDaOperacao repNaturezaDaOperacao = new Repositorio.NaturezaDaOperacao(unidadeTrabalho);

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            conhecimento = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();
            conhecimento.Empresa = empresaUtilizar;
            //conhecimento.CFOP = this.ObterCFOP(int.Parse(cte.CTe.infCte.ide.CFOP), unidadeTrabalho);
            //conhecimento.NaturezaDaOperacao = conhecimento.CFOP.NaturezaDaOperacao;
            conhecimento.CFOP = this.ObterCFOP(int.Parse(cte.CTe.infCte.ide.CFOP), unidadeTrabalho);
            if (conhecimento.CFOP.NaturezaDaOperacao == null)
                conhecimento.NaturezaDaOperacao = repNaturezaDaOperacao.BuscarPrimeiroRegistro();
            else
                conhecimento.NaturezaDaOperacao = conhecimento.CFOP.NaturezaDaOperacao;
            conhecimento.ValorAReceber = decimal.Parse(cte.CTe.infCte.vPrest.vRec, cultura);
            conhecimento.ValorPrestacaoServico = decimal.Parse(cte.CTe.infCte.vPrest.vTPrest, cultura);
            conhecimento.ValorFrete = conhecimento.ValorPrestacaoServico;
            conhecimento.PercentualICMSIncluirNoFrete = 100;
            conhecimento.LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunIni));
            conhecimento.LocalidadeEmissao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunEnv));
            conhecimento.LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunFim));
            conhecimento.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);
            conhecimento.TipoControle = 1;

            conhecimento.ModalTransporte.modalProcCTe = (int)cte.CTe.infCte.ide.modal;

            conhecimento.TipoPagamento = (Dominio.Enumeradores.TipoPagamento)cte.CTe.infCte.ide.forPag;
            conhecimento.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo(string.Format("{0:00}", (int)cte.CTe.infCte.ide.mod));
            conhecimento.Serie = serie;
            conhecimento.TipoImpressao = (Dominio.Enumeradores.TipoImpressao)cte.CTe.infCte.ide.tpImp;
            conhecimento.TipoServico = (Dominio.Enumeradores.TipoServico)cte.CTe.infCte.ide.tpServ;
            conhecimento.TipoCTE = (Dominio.Enumeradores.TipoCTE)cte.CTe.infCte.ide.tpCTe;
            conhecimento.Retira = cte.CTe.infCte.ide.retira == MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteIdeRetira.Item1 ? Dominio.Enumeradores.OpcaoSimNao.Nao : Dominio.Enumeradores.OpcaoSimNao.Sim;
            conhecimento.DetalhesRetira = cte.CTe.infCte.ide.xDetRetira;

            this.SetarDestinatario(ref conhecimento, cte.CTe.infCte.dest, unidadeTrabalho);
            this.SetarExpedidor(ref conhecimento, cte.CTe.infCte.exped, unidadeTrabalho);
            this.SetarRecebedor(ref conhecimento, cte.CTe.infCte.receb, unidadeTrabalho);
            this.SetarRemetente(ref conhecimento, cte.CTe.infCte.rem, unidadeTrabalho);

            DateTime dataEmissao;
            DateTime.TryParseExact(cte.CTe.infCte.ide.dhEmi, "yyyy-MM-ddTHH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataEmissao);
            conhecimento.DataEmissao = dataEmissao;
            conhecimento.Numero = int.Parse(cte.CTe.infCte.ide.nCT);
            conhecimento.Status = "A";
            conhecimento.Cancelado = "N";
            conhecimento.Chave = cte.protCTe.infProt.chCTe;
            conhecimento.Protocolo = cte.protCTe.infProt.nProt;
            conhecimento.DataRetornoSefaz = cte.protCTe.infProt.dhRecbto;
            conhecimento.DataAutorizacao = cte.protCTe.infProt.dhRecbto;

            if (conhecimento.TipoCTE == Dominio.Enumeradores.TipoCTE.Anulacao)
                conhecimento.DataAnulacao = conhecimento.DataAutorizacao;

            conhecimento.Versao = cte.protCTe.versao;
            conhecimento.MensagemRetornoSefaz = "CTe Processado (Importação).";
            conhecimento.CTeImportadoEmbarcador = true;
            conhecimento.NumeroControle = numeroControle;
            conhecimento.TipoAmbiente = (Dominio.Enumeradores.TipoAmbiente)cte.protCTe.infProt.tpAmb;
            conhecimento.Log = string.Concat("CT-e importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");
            if (importacaoCTeCIOT)
                conhecimento.ObservacoesAvancadas = Utilidades.String.OnlyNumbers(cte.CTe.infCte.emit.CNPJ);
            conhecimento.CTeSemCarga = true;

            repCTe.Inserir(conhecimento);

            if (string.IsNullOrWhiteSpace(conhecimento.NumeroControle))
                conhecimento.NumeroControle = conhecimento.Codigo.ToString("D");

            repCTe.Atualizar(conhecimento);

            this.ObterICMS(ref conhecimento, cte.CTe.infCte.imp);
            this.ObterInformacoesTomador(ref conhecimento, cte.CTe.infCte.ide, unidadeTrabalho);
            this.ObterInformacoesCTe(ref conhecimento, cte.CTe.infCte, unidadeTrabalho);
            this.ObterInformacoesComplementares(ref conhecimento, cte.CTe.infCte.compl, unidadeTrabalho);
            this.SalvarInformacoesComponentesDaPrestacao(conhecimento, cte.CTe.infCte.vPrest.Comp, unidadeTrabalho, tipoServicoMultisoftware);
            conhecimento.ExibeICMSNaDACTE = true;

            SetarTomadorPagadorCTe(ref conhecimento);
            SetarNumeroPedidoObservacaoCTe(conhecimento);
            SetarNumeroBookingObservacaoCTe(conhecimento, expressaoRegularBooking);
            SetarNumeroContainerObservacaoCTe(conhecimento, expressaoRegularContainer);

            repCTe.Atualizar(conhecimento);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoSGT = repConfiguracaoSGT.BuscarConfiguracaoPadrao();
            bool armazenarEmArquivo = configuracaoSGT != null ? configuracaoSGT.ArmazenarXMLCTeEmArquivo : false;

            Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeTrabalho);
            Dominio.Entidades.XMLCTe xmlCTe = new Dominio.Entidades.XMLCTe();
            xmlCTe.CTe = conhecimento;
            xmlCTe.Tipo = Dominio.Enumeradores.TipoXMLCTe.Autorizacao;

            xml.Position = 0;

            if (!armazenarEmArquivo)
            {
                StreamReader reader = new StreamReader(xml);
                xmlCTe.XML = reader.ReadToEnd();
                xmlCTe.XMLArmazenadoEmArquivo = false;
                //reader.Dispose();
            }
            else
            {
                xmlCTe.XML = "";
                xmlCTe.XMLArmazenadoEmArquivo = true;

                string arquivo = CriarERetornarCaminhoXMLCTe(conhecimento, "A", unidadeTrabalho);
                using (Stream fileXML = Utilidades.IO.FileStorageService.Storage.Create(arquivo))
                    xml.CopyTo(fileXML);
            }

            repXMLCTe.Inserir(xmlCTe);

            Repositorio.IntegracaoCTeRecebimento repIntegracaoCTeRecebimento = new Repositorio.IntegracaoCTeRecebimento(unidadeTrabalho);
            Dominio.Entidades.IntegracaoCTeRecebimento integracaoCTeRecebimento = new Dominio.Entidades.IntegracaoCTeRecebimento();
            integracaoCTeRecebimento.CTe = conhecimento;
            integracaoCTeRecebimento.Data = DateTime.Now;
            integracaoCTeRecebimento.DataStatus = DateTime.Now;
            integracaoCTeRecebimento.Status = Dominio.Enumeradores.StatusIntegracaoRecebimentoCTe.Pendente;
            integracaoCTeRecebimento.Tipo = Dominio.Enumeradores.TipoIntegracaoEnvioCTe.Autorizacao;
            repIntegracaoCTeRecebimento.Inserir(integracaoCTeRecebimento);

            unidadeTrabalho.CommitChanges();

            if (importarCTeOracle)
                return this.TransmitirCTeAnterior(empresaUtilizar, ref conhecimento, xml, unidadeTrabalho);
            else
                return conhecimento;
        }

        public object GerarCTeAnterior(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v300.ConhecimentoDeTransporteProcessado.cteProc cte, Stream xml, Repositorio.UnitOfWork unidadeTrabalho, string expressaoRegularBooking, string expressaoRegularContainer, bool importacaoCTeCIOT = false, bool retornaCTeJaInserido = false, bool importarCTeOracle = true, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware = null, bool utilizarEmpresaDoCTe = false, bool cteSemNotaFiscal = false, string numeroControle = "")
        {
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumento = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);
            Repositorio.DocumentosCTE repDocumentoCTe = new Repositorio.DocumentosCTE(unidadeTrabalho);

            Dominio.Entidades.Empresa empresaUtilizar = null;

            if (utilizarEmpresaDoCTe)
                empresaUtilizar = repEmpresa.BuscarPorCNPJ(cte.CTe.infCte.emit.CNPJ);
            else
                empresaUtilizar = empresa;

            if (cte.protCTe.infProt.cStat != "100")
                return string.Concat("O status (", cte.protCTe.infProt.cStat, " - ", Utilidades.String.Left(cte.protCTe.infProt.xMotivo, 60), ") do CT-e (", cte.CTe.infCte.ide.nCT, " - ", cte.CTe.infCte.ide.serie, ") é inválido para a importação.");

            if (!utilizarEmpresaDoCTe && !importacaoCTeCIOT && !Utilidades.String.OnlyNumbers(cte.CTe.infCte.emit.CNPJ).Equals(Utilidades.String.OnlyNumbers(empresaUtilizar.CNPJ)))
                return string.Concat("O CNPJ (", cte.CTe.infCte.emit.CNPJ, ") do emitente do CT-e (", cte.CTe.infCte.ide.nCT, " - ", cte.CTe.infCte.ide.serie, ") é diferente do CNPJ da empresa emitente (", empresaUtilizar.CNPJ, ").");

            Dominio.Entidades.EmpresaSerie serie = this.ObterSerie(empresaUtilizar, int.Parse(cte.CTe.infCte.ide.serie), unidadeTrabalho);

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = repCTe.BuscarPorChave(empresaUtilizar.Codigo, cte.protCTe.infProt.chCTe);

            if (!importacaoCTeCIOT && conhecimento == null)
                conhecimento = repCTe.BuscarPorNumeroESerie(empresaUtilizar.Codigo, int.Parse(cte.CTe.infCte.ide.nCT), int.Parse(cte.CTe.infCte.ide.serie), "57", cte.protCTe.infProt.tpAmb == MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TAmb.Item1 ? Dominio.Enumeradores.TipoAmbiente.Producao : Dominio.Enumeradores.TipoAmbiente.Homologacao);

            if (conhecimento != null)
            {
                if (string.IsNullOrWhiteSpace(conhecimento.Chave))
                {
                    conhecimento.Chave = cte.protCTe.infProt.chCTe;

                    repCTe.Atualizar(conhecimento);
                }

                if (!repDocumentoCTe.ExistePorCTe(conhecimento.Codigo))
                    GerarOutroDocumentoCTe(conhecimento, unidadeTrabalho);

                if (unidadeTrabalho.IsActiveTransaction())
                    unidadeTrabalho.CommitChanges();

                if (importacaoCTeCIOT || retornaCTeJaInserido)
                    return conhecimento;
                else
                    return string.Concat("CT-e com mesmo número e série (", cte.CTe.infCte.ide.nCT, " - ", cte.CTe.infCte.ide.serie, ") ou chave (", cte.protCTe.infProt.chCTe, ") já existe no sistema.");
            }

            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);
            Repositorio.NaturezaDaOperacao repNaturezaDaOperacao = new Repositorio.NaturezaDaOperacao(unidadeTrabalho);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoSGT = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unidadeTrabalho);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoOcorrencia repConfiguracaoOcorrencia = new Repositorio.Embarcador.Configuracoes.ConfiguracaoOcorrencia(unidadeTrabalho);
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoOcorrencia configuracaoOcorrencia = repConfiguracaoOcorrencia.BuscarConfiguracaoPadrao();

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            conhecimento = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();
            conhecimento.QRCode = cte.CTe.infCTeSupl?.qrCodCTe;
            conhecimento.Empresa = empresaUtilizar;
            conhecimento.CFOP = this.ObterCFOP(int.Parse(cte.CTe.infCte.ide.CFOP), unidadeTrabalho);
            if (conhecimento.CFOP.NaturezaDaOperacao == null)
                conhecimento.NaturezaDaOperacao = repNaturezaDaOperacao.BuscarPrimeiroRegistro();
            else
                conhecimento.NaturezaDaOperacao = conhecimento.CFOP.NaturezaDaOperacao;
            conhecimento.ValorAReceber = decimal.Parse(cte.CTe.infCte.vPrest.vRec, cultura);
            conhecimento.ValorPrestacaoServico = decimal.Parse(cte.CTe.infCte.vPrest.vTPrest, cultura);
            conhecimento.ValorFrete = conhecimento.ValorPrestacaoServico;
            conhecimento.PercentualICMSIncluirNoFrete = 100;
            conhecimento.LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunIni));
            conhecimento.LocalidadeEmissao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunEnv));
            conhecimento.LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunFim));

            conhecimento.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);
            conhecimento.TipoControle = 1;

            conhecimento.ModalTransporte.modalProcCTe = (int)cte.CTe.infCte.ide.modal;

            conhecimento.TipoModal = ObterTipoModal((int)cte.CTe.infCte.ide.modal);

            conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Pago;
            conhecimento.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("57");
            conhecimento.Serie = serie;
            conhecimento.TipoImpressao = (Dominio.Enumeradores.TipoImpressao)cte.CTe.infCte.ide.tpImp;
            conhecimento.TipoServico = (Dominio.Enumeradores.TipoServico)cte.CTe.infCte.ide.tpServ;
            conhecimento.TipoCTE = (Dominio.Enumeradores.TipoCTE)cte.CTe.infCte.ide.tpCTe;
            conhecimento.Retira = cte.CTe.infCte.ide.retira == MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteIdeRetira.Item1 ? Dominio.Enumeradores.OpcaoSimNao.Nao : Dominio.Enumeradores.OpcaoSimNao.Sim;
            conhecimento.DetalhesRetira = cte.CTe.infCte.ide.xDetRetira;

            if (!SetarDestinatario(ref conhecimento, cte.CTe.infCte.dest, unidadeTrabalho, out string erro, tipoServicoMultisoftware))
                return erro;

            if (!SetarExpedidor(ref conhecimento, cte.CTe.infCte.exped, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                return erro;

            if (!SetarRecebedor(ref conhecimento, cte.CTe.infCte.receb, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                return erro;

            if (!SetarRemetente(ref conhecimento, cte.CTe.infCte.rem, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                return erro;

            DateTime dataEmissao;
            DateTime.TryParseExact(cte.CTe.infCte.ide.dhEmi, "yyyy-MM-ddTHH:mm:sszzz", null, System.Globalization.DateTimeStyles.None, out dataEmissao);
            conhecimento.DataEmissao = dataEmissao;
            conhecimento.Numero = int.Parse(cte.CTe.infCte.ide.nCT);
            conhecimento.Status = "A";
            conhecimento.Cancelado = "N";
            conhecimento.Chave = cte.protCTe.infProt.chCTe;
            conhecimento.Protocolo = cte.protCTe.infProt.nProt;
            conhecimento.DataRetornoSefaz = cte.protCTe.infProt.dhRecbto;
            conhecimento.DataAutorizacao = cte.protCTe.infProt.dhRecbto;

            if (conhecimento.TipoCTE == Dominio.Enumeradores.TipoCTE.Anulacao)
                conhecimento.DataAnulacao = conhecimento.DataAutorizacao;

            conhecimento.Versao = cte.protCTe.versao;
            conhecimento.MensagemRetornoSefaz = "CTe Processado (Importação).";
            conhecimento.CTeImportadoEmbarcador = true;
            conhecimento.NumeroControle = numeroControle;
            conhecimento.TipoAmbiente = cte.protCTe.infProt.tpAmb == MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TAmb.Item1 ? Dominio.Enumeradores.TipoAmbiente.Producao : Dominio.Enumeradores.TipoAmbiente.Homologacao;
            conhecimento.Log = string.Concat("CT-e importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");

            if (importacaoCTeCIOT)
                conhecimento.ObservacoesAvancadas = Utilidades.String.OnlyNumbers(cte.CTe.infCte.emit.CNPJ);

            conhecimento.CTeSemCarga = true;

            repCTe.Inserir(conhecimento);

            if (string.IsNullOrWhiteSpace(conhecimento.NumeroControle))
                conhecimento.NumeroControle = conhecimento.Codigo.ToString("D");

            repCTe.Atualizar(conhecimento);

            this.ObterICMS(ref conhecimento, cte.CTe.infCte.imp);

            if (!ObterInformacoesTomador(ref conhecimento, cte.CTe.infCte.ide, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                return erro;

            this.ObterInformacoesCTe(ref conhecimento, cte.CTe.infCte, (configuracaoOcorrencia?.SalvarDocumentosDoCteAnteriorAoImportarCTeComplementar ?? false), unidadeTrabalho);
            this.ObterInformacoesComplementares(ref conhecimento, cte.CTe.infCte.compl, unidadeTrabalho);
            this.ObterInformacoesDocumentosAnteriores(ref conhecimento, cte.CTe.infCte, unidadeTrabalho);
            this.SalvarInformacoesComponentesDaPrestacao(conhecimento, cte.CTe.infCte.vPrest.Comp, unidadeTrabalho, tipoServicoMultisoftware);

            if (!repDocumentoCTe.ExistePorCTe(conhecimento.Codigo))
                GerarOutroDocumentoCTe(conhecimento, unidadeTrabalho);

            conhecimento.ExibeICMSNaDACTE = true;

            if (conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Outros)
                conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Outros;
            else if (conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Destinatario || conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Recebedor)
                conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.A_Pagar;
            else
                conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Pago;

            SetarTomadorPagadorCTe(ref conhecimento);
            SetarNumeroPedidoObservacaoCTe(conhecimento);
            SetarNumeroBookingObservacaoCTe(conhecimento, expressaoRegularBooking);
            SetarNumeroContainerObservacaoCTe(conhecimento, expressaoRegularContainer);

            repCTe.Atualizar(conhecimento);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoSGT = repConfiguracaoSGT.BuscarConfiguracaoPadrao();
            bool armazenarEmArquivo = configuracaoSGT != null ? configuracaoSGT.ArmazenarXMLCTeEmArquivo : false;

            Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeTrabalho);
            Dominio.Entidades.XMLCTe xmlCTe = new Dominio.Entidades.XMLCTe();
            xmlCTe.CTe = conhecimento;
            xmlCTe.Tipo = Dominio.Enumeradores.TipoXMLCTe.Autorizacao;

            xml.Position = 0;

            if (!armazenarEmArquivo)
            {
                StreamReader reader = new StreamReader(xml);
                xmlCTe.XML = reader.ReadToEnd();
                xmlCTe.XMLArmazenadoEmArquivo = false;
                //reader.Dispose();
            }
            else
            {
                xmlCTe.XML = "";
                xmlCTe.XMLArmazenadoEmArquivo = true;
                string arquivo = CriarERetornarCaminhoXMLCTe(conhecimento, "A", unidadeTrabalho);
                using (Stream fileXML = Utilidades.IO.FileStorageService.Storage.Create(arquivo))
                    xml.CopyTo(fileXML);
            }

            repXMLCTe.Inserir(xmlCTe);

            Repositorio.IntegracaoCTeRecebimento repIntegracaoCTeRecebimento = new Repositorio.IntegracaoCTeRecebimento(unidadeTrabalho);
            Dominio.Entidades.IntegracaoCTeRecebimento integracaoCTeRecebimento = new Dominio.Entidades.IntegracaoCTeRecebimento();
            integracaoCTeRecebimento.CTe = conhecimento;
            integracaoCTeRecebimento.Data = DateTime.Now;
            integracaoCTeRecebimento.DataStatus = DateTime.Now;
            integracaoCTeRecebimento.Status = Dominio.Enumeradores.StatusIntegracaoRecebimentoCTe.Pendente;
            integracaoCTeRecebimento.Tipo = Dominio.Enumeradores.TipoIntegracaoEnvioCTe.Autorizacao;
            repIntegracaoCTeRecebimento.Inserir(integracaoCTeRecebimento);

            unidadeTrabalho.CommitChanges();

            this.SalvarMovimentoDoFinanceiro(conhecimento, empresaUtilizar.Codigo, unidadeTrabalho, true);

            if (importarCTeOracle)
                return this.TransmitirCTeAnterior(empresaUtilizar, ref conhecimento, xml, unidadeTrabalho);
            else
                return conhecimento;
        }

        public object GerarCTeAnterior(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v400.ConhecimentoDeTransporteProcessado.cteProc cte, Stream xml, Repositorio.UnitOfWork unidadeTrabalho, string expressaoRegularBooking, string expressaoRegularContainer, bool importacaoCTeCIOT = false, bool retornaCTeJaInserido = false, bool importarCTeOracle = true, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware = null, bool utilizarEmpresaDoCTe = false, bool cteSemNotaFiscal = false, string numeroControle = "")
        {
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumento = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);
            Repositorio.DocumentosCTE repDocumentoCTe = new Repositorio.DocumentosCTE(unidadeTrabalho);

            Dominio.Entidades.Empresa empresaUtilizar = null;

            if (utilizarEmpresaDoCTe)
            {
                empresaUtilizar = repEmpresa.BuscarPorCNPJ(cte.CTe.infCte.emit.Item);
                if (empresaUtilizar == null)
                    return string.Concat("O CNPJ (", cte.CTe.infCte.emit.Item, ") do emitente do CT-e (", cte.CTe.infCte.ide.nCT, " - ", cte.CTe.infCte.ide.serie, ") não cadastrado como empresa.");
            }
            else
                empresaUtilizar = empresa;

            if (cte.protCTe.infProt.cStat != "100")
                return string.Concat("O status (", cte.protCTe.infProt.cStat, " - ", Utilidades.String.Left(cte.protCTe.infProt.xMotivo, 60), ") do CT-e (", cte.CTe.infCte.ide.nCT, " - ", cte.CTe.infCte.ide.serie, ") é inválido para a importação.");

            if (!utilizarEmpresaDoCTe && !importacaoCTeCIOT && !Utilidades.String.OnlyNumbers(cte.CTe.infCte.emit.Item).Equals(Utilidades.String.OnlyNumbers(empresaUtilizar.CNPJ)))
                return string.Concat("O CNPJ (", cte.CTe.infCte.emit.Item, ") do emitente do CT-e (", cte.CTe.infCte.ide.nCT, " - ", cte.CTe.infCte.ide.serie, ") é diferente do CNPJ da empresa emitente (", empresaUtilizar.CNPJ, ").");

            Dominio.Entidades.EmpresaSerie serie = this.ObterSerie(empresaUtilizar, int.Parse(cte.CTe.infCte.ide.serie), unidadeTrabalho);

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = repCTe.BuscarPorChave(empresaUtilizar.Codigo, cte.protCTe.infProt.chCTe);

            if (!importacaoCTeCIOT && conhecimento == null)
                conhecimento = repCTe.BuscarPorNumeroESerie(empresaUtilizar.Codigo, int.Parse(cte.CTe.infCte.ide.nCT), int.Parse(cte.CTe.infCte.ide.serie), "57", cte.protCTe.infProt.tpAmb == MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TAmb.Item1 ? Dominio.Enumeradores.TipoAmbiente.Producao : Dominio.Enumeradores.TipoAmbiente.Homologacao);

            if (conhecimento != null)
            {
                if (string.IsNullOrWhiteSpace(conhecimento.Chave))
                {
                    conhecimento.Chave = cte.protCTe.infProt.chCTe;
                    repCTe.Atualizar(conhecimento);
                }

                if (!repDocumentoCTe.ExistePorCTe(conhecimento.Codigo))
                    GerarOutroDocumentoCTe(conhecimento, unidadeTrabalho);

                if (unidadeTrabalho.IsActiveTransaction())
                    unidadeTrabalho.CommitChanges();

                if (importacaoCTeCIOT || retornaCTeJaInserido)
                    return conhecimento;
                else
                    return string.Concat("CT-e com mesmo número e série (", cte.CTe.infCte.ide.nCT, " - ", cte.CTe.infCte.ide.serie, ") ou chave (", cte.protCTe.infProt.chCTe, ") já existe no sistema.");
            }

            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);
            Repositorio.NaturezaDaOperacao repNaturezaDaOperacao = new Repositorio.NaturezaDaOperacao(unidadeTrabalho);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoSGT = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unidadeTrabalho);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoOcorrencia repConfiguracaoOcorrencia = new Repositorio.Embarcador.Configuracoes.ConfiguracaoOcorrencia(unidadeTrabalho);
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoOcorrencia configuracaoOcorrencia = repConfiguracaoOcorrencia.BuscarConfiguracaoPadrao();

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            conhecimento = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();
            conhecimento.QRCode = cte.CTe.infCTeSupl?.qrCodCTe;
            conhecimento.Empresa = empresaUtilizar;
            conhecimento.CFOP = this.ObterCFOP(int.Parse(cte.CTe.infCte.ide.CFOP), unidadeTrabalho);
            if (conhecimento.CFOP.NaturezaDaOperacao == null)
                conhecimento.NaturezaDaOperacao = repNaturezaDaOperacao.BuscarPrimeiroRegistro();
            else
                conhecimento.NaturezaDaOperacao = conhecimento.CFOP.NaturezaDaOperacao;
            conhecimento.ValorAReceber = decimal.Parse(cte.CTe.infCte.vPrest.vRec, cultura);
            conhecimento.ValorPrestacaoServico = decimal.Parse(cte.CTe.infCte.vPrest.vTPrest, cultura);
            conhecimento.ValorTotalDocumentoFiscal = decimal.Parse(cte.CTe.infCte.imp?.vTotDFe ?? "0", cultura);
            conhecimento.ValorFrete = conhecimento.ValorPrestacaoServico;
            conhecimento.PercentualICMSIncluirNoFrete = 100;
            conhecimento.LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunIni));
            conhecimento.LocalidadeEmissao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunEnv));
            conhecimento.LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.infCte.ide.cMunFim));

            conhecimento.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);
            conhecimento.TipoControle = 1;

            conhecimento.ModalTransporte.modalProcCTe = (int)cte.CTe.infCte.ide.modal;

            conhecimento.TipoModal = ObterTipoModal((int)cte.CTe.infCte.ide.modal);

            conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Pago;
            conhecimento.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("57");
            conhecimento.Serie = serie;
            conhecimento.TipoImpressao = (Dominio.Enumeradores.TipoImpressao)cte.CTe.infCte.ide.tpImp;
            conhecimento.TipoServico = (Dominio.Enumeradores.TipoServico)cte.CTe.infCte.ide.tpServ;
            conhecimento.TipoCTE = (Dominio.Enumeradores.TipoCTE)cte.CTe.infCte.ide.tpCTe;
            conhecimento.Retira = cte.CTe.infCte.ide.retira == MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteIdeRetira.Item1 ? Dominio.Enumeradores.OpcaoSimNao.Nao : Dominio.Enumeradores.OpcaoSimNao.Sim;
            conhecimento.DetalhesRetira = cte.CTe.infCte.ide.xDetRetira;

            if (!SetarDestinatario(ref conhecimento, cte.CTe.infCte.dest, unidadeTrabalho, out string erro, tipoServicoMultisoftware))
                return erro;

            if (!SetarExpedidor(ref conhecimento, cte.CTe.infCte.exped, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                return erro;

            if (!SetarRecebedor(ref conhecimento, cte.CTe.infCte.receb, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                return erro;

            if (!SetarRemetente(ref conhecimento, cte.CTe.infCte.rem, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                return erro;

            DateTime.TryParseExact(cte.CTe.infCte.ide.dhEmi, "yyyy-MM-ddTHH:mm:sszzz", null, System.Globalization.DateTimeStyles.None, out DateTime dataEmissao);
            DateTime.TryParseExact(cte.protCTe.infProt.dhRecbto, "yyyy-MM-ddTHH:mm:sszzz", null, System.Globalization.DateTimeStyles.None, out DateTime dataRecebimento);
            conhecimento.DataEmissao = dataEmissao;
            conhecimento.Numero = int.Parse(cte.CTe.infCte.ide.nCT);
            conhecimento.Status = "A";
            conhecimento.Cancelado = "N";
            conhecimento.Chave = cte.protCTe.infProt.chCTe;
            conhecimento.Protocolo = cte.protCTe.infProt.nProt;
            conhecimento.DataRetornoSefaz = dataRecebimento;
            conhecimento.DataAutorizacao = dataRecebimento;

            if (conhecimento.TipoCTE == Dominio.Enumeradores.TipoCTE.Anulacao)
                conhecimento.DataAnulacao = conhecimento.DataAutorizacao;

            conhecimento.Versao = cte.protCTe.versao;
            conhecimento.MensagemRetornoSefaz = "CTe Processado (Importação).";
            conhecimento.CTeImportadoEmbarcador = true;
            conhecimento.NumeroControle = numeroControle;
            conhecimento.TipoAmbiente = cte.protCTe.infProt.tpAmb == MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TAmb.Item1 ? Dominio.Enumeradores.TipoAmbiente.Producao : Dominio.Enumeradores.TipoAmbiente.Homologacao;
            conhecimento.Log = string.Concat("CT-e importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");

            if (importacaoCTeCIOT)
                conhecimento.ObservacoesAvancadas = Utilidades.String.OnlyNumbers(cte.CTe.infCte.emit.Item);

            conhecimento.CTeSemCarga = true;

            repCTe.Inserir(conhecimento);

            if (string.IsNullOrWhiteSpace(conhecimento.NumeroControle))
                conhecimento.NumeroControle = conhecimento.Codigo.ToString("D");

            repCTe.Atualizar(conhecimento);

            this.ObterICMS(ref conhecimento, cte.CTe.infCte.imp);
            this.ObterIBSCBS(conhecimento, cte.CTe.infCte.imp);

            if (!ObterInformacoesTomador(ref conhecimento, cte.CTe.infCte.ide, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                return erro;

            this.ObterInformacoesCTe(ref conhecimento, cte.CTe.infCte, (configuracaoOcorrencia?.SalvarDocumentosDoCteAnteriorAoImportarCTeComplementar ?? false), unidadeTrabalho);
            this.ObterInformacoesComplementares(ref conhecimento, cte.CTe.infCte.compl, unidadeTrabalho);
            this.ObterInformacoesDocumentosAnteriores(ref conhecimento, cte.CTe.infCte, unidadeTrabalho);
            this.SalvarInformacoesComponentesDaPrestacao(conhecimento, cte.CTe.infCte.vPrest.Comp, unidadeTrabalho, tipoServicoMultisoftware);

            if (!repDocumentoCTe.ExistePorCTe(conhecimento.Codigo))
                GerarOutroDocumentoCTe(conhecimento, unidadeTrabalho);

            conhecimento.ExibeICMSNaDACTE = true;

            if (conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Outros)
                conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Outros;
            else if (conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Destinatario || conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Recebedor)
                conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.A_Pagar;
            else
                conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Pago;

            SetarTomadorPagadorCTe(ref conhecimento);
            SetarNumeroPedidoObservacaoCTe(conhecimento);
            SetarNumeroBookingObservacaoCTe(conhecimento, expressaoRegularBooking);
            SetarNumeroContainerObservacaoCTe(conhecimento, expressaoRegularContainer);

            repCTe.Atualizar(conhecimento);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoSGT = repConfiguracaoSGT.BuscarConfiguracaoPadrao();
            bool armazenarEmArquivo = configuracaoSGT != null ? configuracaoSGT.ArmazenarXMLCTeEmArquivo : false;

            Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeTrabalho);
            Dominio.Entidades.XMLCTe xmlCTe = new Dominio.Entidades.XMLCTe();
            xmlCTe.CTe = conhecimento;
            xmlCTe.Tipo = Dominio.Enumeradores.TipoXMLCTe.Autorizacao;

            xml.Position = 0;

            if (!armazenarEmArquivo)
            {
                StreamReader reader = new StreamReader(xml);
                xmlCTe.XML = reader.ReadToEnd();
                xmlCTe.XMLArmazenadoEmArquivo = false;
                //reader.Dispose();
            }
            else
            {
                xmlCTe.XML = "";
                xmlCTe.XMLArmazenadoEmArquivo = true;
                string arquivo = CriarERetornarCaminhoXMLCTe(conhecimento, "A", unidadeTrabalho);
                using (Stream fileXML = Utilidades.IO.FileStorageService.Storage.Create(arquivo))
                    xml.CopyTo(fileXML);
            }

            repXMLCTe.Inserir(xmlCTe);

            Repositorio.IntegracaoCTeRecebimento repIntegracaoCTeRecebimento = new Repositorio.IntegracaoCTeRecebimento(unidadeTrabalho);
            Dominio.Entidades.IntegracaoCTeRecebimento integracaoCTeRecebimento = new Dominio.Entidades.IntegracaoCTeRecebimento();
            integracaoCTeRecebimento.CTe = conhecimento;
            integracaoCTeRecebimento.Data = DateTime.Now;
            integracaoCTeRecebimento.DataStatus = DateTime.Now;
            integracaoCTeRecebimento.Status = Dominio.Enumeradores.StatusIntegracaoRecebimentoCTe.Pendente;
            integracaoCTeRecebimento.Tipo = Dominio.Enumeradores.TipoIntegracaoEnvioCTe.Autorizacao;
            repIntegracaoCTeRecebimento.Inserir(integracaoCTeRecebimento);

            if (unidadeTrabalho.IsActiveTransaction())
                unidadeTrabalho.CommitChanges();

            this.SalvarMovimentoDoFinanceiro(conhecimento, empresaUtilizar.Codigo, unidadeTrabalho, true);

            if (importarCTeOracle)
                return this.TransmitirCTeAnterior(empresaUtilizar, ref conhecimento, xml, unidadeTrabalho);
            else
                return conhecimento;
        }

        public object GerarCTeAnterior(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v400.ConhecimentoDeTransporteProcessado.cteSimpProc cte, Stream xml, Repositorio.UnitOfWork unidadeTrabalho, string expressaoRegularBooking, string expressaoRegularContainer, bool importacaoCTeCIOT = false, bool retornaCTeJaInserido = false, bool importarCTeOracle = true, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware = null, bool utilizarEmpresaDoCTe = false, bool cteSemNotaFiscal = false, string numeroControle = "")
        {
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumento = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);
            Repositorio.DocumentosCTE repDocumentoCTe = new Repositorio.DocumentosCTE(unidadeTrabalho);

            Dominio.Entidades.Empresa empresaUtilizar = null;

            if (utilizarEmpresaDoCTe)
            {
                empresaUtilizar = repEmpresa.BuscarPorCNPJ(cte.CTeSimp.infCte.emit.Item);
                if (empresaUtilizar == null)
                    return string.Concat("O CNPJ (", cte.CTeSimp.infCte.emit.Item, ") do emitente do CT-e (", cte.CTeSimp.infCte.ide.nCT, " - ", cte.CTeSimp.infCte.ide.serie, ") não cadastrado como empresa.");
            }
            else
                empresaUtilizar = empresa;

            if (cte.protCTe.infProt.cStat != "100")
                return string.Concat("O status (", cte.protCTe.infProt.cStat, " - ", Utilidades.String.Left(cte.protCTe.infProt.xMotivo, 60), ") do CT-e (", cte.CTeSimp.infCte.ide.nCT, " - ", cte.CTeSimp.infCte.ide.serie, ") é inválido para a importação.");

            if (!utilizarEmpresaDoCTe && !importacaoCTeCIOT && !Utilidades.String.OnlyNumbers(cte.CTeSimp.infCte.emit.Item).Equals(Utilidades.String.OnlyNumbers(empresaUtilizar.CNPJ)))
                return string.Concat("O CNPJ (", cte.CTeSimp.infCte.emit.Item, ") do emitente do CT-e (", cte.CTeSimp.infCte.ide.nCT, " - ", cte.CTeSimp.infCte.ide.serie, ") é diferente do CNPJ da empresa emitente (", empresaUtilizar.CNPJ, ").");

            Dominio.Entidades.EmpresaSerie serie = this.ObterSerie(empresaUtilizar, int.Parse(cte.CTeSimp.infCte.ide.serie), unidadeTrabalho);

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = repCTe.BuscarPorChave(empresaUtilizar.Codigo, cte.protCTe.infProt.chCTe);

            if (!importacaoCTeCIOT && conhecimento == null)
                conhecimento = repCTe.BuscarPorNumeroESerie(empresaUtilizar.Codigo, int.Parse(cte.CTeSimp.infCte.ide.nCT), int.Parse(cte.CTeSimp.infCte.ide.serie), "57", cte.protCTe.infProt.tpAmb == MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TAmb.Item1 ? Dominio.Enumeradores.TipoAmbiente.Producao : Dominio.Enumeradores.TipoAmbiente.Homologacao);

            if (conhecimento != null)
            {
                if (string.IsNullOrWhiteSpace(conhecimento.Chave))
                {
                    conhecimento.Chave = cte.protCTe.infProt.chCTe;
                    repCTe.Atualizar(conhecimento);
                }

                if (!repDocumentoCTe.ExistePorCTe(conhecimento.Codigo))
                    GerarOutroDocumentoCTe(conhecimento, unidadeTrabalho);

                if (unidadeTrabalho.IsActiveTransaction())
                    unidadeTrabalho.CommitChanges();

                if (importacaoCTeCIOT || retornaCTeJaInserido)
                    return conhecimento;
                else
                    return string.Concat("CT-e com mesmo número e série (", cte.CTeSimp.infCte.ide.nCT, " - ", cte.CTeSimp.infCte.ide.serie, ") ou chave (", cte.protCTe.infProt.chCTe, ") já existe no sistema.");
            }

            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);
            Repositorio.NaturezaDaOperacao repNaturezaDaOperacao = new Repositorio.NaturezaDaOperacao(unidadeTrabalho);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoSGT = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unidadeTrabalho);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoOcorrencia repConfiguracaoOcorrencia = new Repositorio.Embarcador.Configuracoes.ConfiguracaoOcorrencia(unidadeTrabalho);
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoOcorrencia configuracaoOcorrencia = repConfiguracaoOcorrencia.BuscarConfiguracaoPadrao();

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            conhecimento = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();
            conhecimento.QRCode = cte.CTeSimp.infCTeSupl?.qrCodCTe;
            conhecimento.Empresa = empresaUtilizar;
            conhecimento.CFOP = this.ObterCFOP(int.Parse(cte.CTeSimp.infCte.ide.CFOP), unidadeTrabalho);
            if (conhecimento.CFOP.NaturezaDaOperacao == null)
                conhecimento.NaturezaDaOperacao = repNaturezaDaOperacao.BuscarPrimeiroRegistro();
            else
                conhecimento.NaturezaDaOperacao = conhecimento.CFOP.NaturezaDaOperacao;
            conhecimento.ValorFrete = conhecimento.ValorPrestacaoServico;
            conhecimento.PercentualICMSIncluirNoFrete = 100;
            conhecimento.LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTeSimp.infCte.det.OrderBy(o => o.nItem).FirstOrDefault().cMunIni));
            conhecimento.LocalidadeEmissao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTeSimp.infCte.ide.cMunEnv));
            conhecimento.LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTeSimp.infCte.det.OrderByDescending(o => o.nItem).FirstOrDefault().cMunFim));

            conhecimento.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);
            conhecimento.TipoControle = 1;

            conhecimento.ModalTransporte.modalProcCTe = (int)cte.CTeSimp.infCte.ide.modal;

            conhecimento.TipoModal = ObterTipoModal((int)cte.CTeSimp.infCte.ide.modal);

            conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Pago;
            conhecimento.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("57");
            conhecimento.Serie = serie;
            conhecimento.TipoImpressao = (Dominio.Enumeradores.TipoImpressao)cte.CTeSimp.infCte.ide.tpImp;
            conhecimento.TipoServico = (Dominio.Enumeradores.TipoServico)cte.CTeSimp.infCte.ide.tpServ;

            if (cte.CTeSimp.infCte.ide.tpCTe == MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TFinCTeSimp.Item6)
                throw new Exception("Importação para este tipo de ct-e não homologado");

            conhecimento.TipoCTE = cte.CTeSimp.infCte.ide.tpCTe == MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TFinCTeSimp.Item5 ? TipoCTE.Simplificado : TipoCTE.SimplificadoSubstituto;
            conhecimento.Retira = cte.CTeSimp.infCte.ide.retira == MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteIdeRetira.Item1 ? Dominio.Enumeradores.OpcaoSimNao.Nao : Dominio.Enumeradores.OpcaoSimNao.Sim;
            conhecimento.DetalhesRetira = cte.CTeSimp.infCte.ide.xDetRetira;

            string erro = String.Empty;

            if (!ObterInformacoesTomador(ref conhecimento, cte.CTeSimp.infCte.toma, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                return erro;

            DateTime.TryParseExact(cte.CTeSimp.infCte.ide.dhEmi, "yyyy-MM-ddTHH:mm:sszzz", null, System.Globalization.DateTimeStyles.None, out DateTime dataEmissao);
            DateTime.TryParseExact(cte.protCTe.infProt.dhRecbto, "yyyy-MM-ddTHH:mm:sszzz", null, System.Globalization.DateTimeStyles.None, out DateTime dataRecebimento);
            conhecimento.DataEmissao = dataEmissao;
            conhecimento.Numero = int.Parse(cte.CTeSimp.infCte.ide.nCT);
            conhecimento.Status = "A";
            conhecimento.Cancelado = "N";
            conhecimento.Chave = cte.protCTe.infProt.chCTe;
            conhecimento.Protocolo = cte.protCTe.infProt.nProt;
            conhecimento.DataRetornoSefaz = dataRecebimento;
            conhecimento.DataAutorizacao = dataRecebimento;

            if (conhecimento.TipoCTE == Dominio.Enumeradores.TipoCTE.Anulacao)
                conhecimento.DataAnulacao = conhecimento.DataAutorizacao;

            conhecimento.Versao = cte.protCTe.versao;
            conhecimento.MensagemRetornoSefaz = "CTe Processado (Importação).";
            conhecimento.CTeImportadoEmbarcador = true;
            conhecimento.NumeroControle = numeroControle;
            conhecimento.TipoAmbiente = cte.protCTe.infProt.tpAmb == MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TAmb.Item1 ? Dominio.Enumeradores.TipoAmbiente.Producao : Dominio.Enumeradores.TipoAmbiente.Homologacao;
            conhecimento.Log = string.Concat("CT-e importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");

            if (importacaoCTeCIOT)
                conhecimento.ObservacoesAvancadas = Utilidades.String.OnlyNumbers(cte.CTeSimp.infCte.emit.Item);

            conhecimento.CTeSemCarga = true;

            repCTe.Inserir(conhecimento);

            if (string.IsNullOrWhiteSpace(conhecimento.NumeroControle))
                conhecimento.NumeroControle = conhecimento.Codigo.ToString("D");

            repCTe.Atualizar(conhecimento);

            this.ObterICMS(ref conhecimento, cte.CTeSimp.infCte.imp);
            this.ObterIBSCBS(ref conhecimento, cte.CTeSimp.infCte.imp);
            this.ObterInformacoesComplementares(ref conhecimento, cte.CTeSimp.infCte.compl, unidadeTrabalho);

            conhecimento.ValorTotalMercadoria = 0;
            this.SalvarInformacoesDeQuantidadeDaCarga(conhecimento, cte.CTeSimp.infCte.infCarga.infQ, unidadeTrabalho);

            if (conhecimento.ModalTransporte.modalProcCTe == 1 || conhecimento.ModalTransporte.modalProcCTe == 0) //todo: quando implementar outras modalidade remover isso, aqui apenas ignora o modal se for diferente de rodoviario
                this.SalvarInformacoesModalRodoviario(ref conhecimento, cte.CTeSimp.infCte.infModal, unidadeTrabalho);

            this.SalvarInformacoesEntregas(conhecimento, cte.CTeSimp.infCte.det != null ? cte.CTeSimp.infCte.det.ToList() : null, unidadeTrabalho);

            if (!repDocumentoCTe.ExistePorCTe(conhecimento.Codigo))
                GerarOutroDocumentoCTe(conhecimento, unidadeTrabalho);

            conhecimento.ExibeICMSNaDACTE = true;

            if (conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Outros)
                conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Outros;
            else if (conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Destinatario || conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Recebedor)
                conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.A_Pagar;
            else
                conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Pago;

            SetarTomadorPagadorCTe(ref conhecimento);
            SetarNumeroPedidoObservacaoCTe(conhecimento);
            SetarNumeroBookingObservacaoCTe(conhecimento, expressaoRegularBooking);
            SetarNumeroContainerObservacaoCTe(conhecimento, expressaoRegularContainer);

            repCTe.Atualizar(conhecimento);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoSGT = repConfiguracaoSGT.BuscarConfiguracaoPadrao();
            bool armazenarEmArquivo = configuracaoSGT != null ? configuracaoSGT.ArmazenarXMLCTeEmArquivo : false;

            Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeTrabalho);
            Dominio.Entidades.XMLCTe xmlCTe = new Dominio.Entidades.XMLCTe();
            xmlCTe.CTe = conhecimento;
            xmlCTe.Tipo = Dominio.Enumeradores.TipoXMLCTe.Autorizacao;

            xml.Position = 0;

            if (!armazenarEmArquivo)
            {
                StreamReader reader = new StreamReader(xml);
                xmlCTe.XML = reader.ReadToEnd();
                xmlCTe.XMLArmazenadoEmArquivo = false;
                //reader.Dispose();
            }
            else
            {
                xmlCTe.XML = "";
                xmlCTe.XMLArmazenadoEmArquivo = true;
                string arquivo = CriarERetornarCaminhoXMLCTe(conhecimento, "A", unidadeTrabalho);
                using (Stream fileXML = Utilidades.IO.FileStorageService.Storage.Create(arquivo))
                    xml.CopyTo(fileXML);
            }

            repXMLCTe.Inserir(xmlCTe);

            Repositorio.IntegracaoCTeRecebimento repIntegracaoCTeRecebimento = new Repositorio.IntegracaoCTeRecebimento(unidadeTrabalho);
            Dominio.Entidades.IntegracaoCTeRecebimento integracaoCTeRecebimento = new Dominio.Entidades.IntegracaoCTeRecebimento();
            integracaoCTeRecebimento.CTe = conhecimento;
            integracaoCTeRecebimento.Data = DateTime.Now;
            integracaoCTeRecebimento.DataStatus = DateTime.Now;
            integracaoCTeRecebimento.Status = Dominio.Enumeradores.StatusIntegracaoRecebimentoCTe.Pendente;
            integracaoCTeRecebimento.Tipo = Dominio.Enumeradores.TipoIntegracaoEnvioCTe.Autorizacao;
            repIntegracaoCTeRecebimento.Inserir(integracaoCTeRecebimento);

            if (unidadeTrabalho.IsActiveTransaction())
                unidadeTrabalho.CommitChanges();

            this.SalvarMovimentoDoFinanceiro(conhecimento, empresaUtilizar.Codigo, unidadeTrabalho, true);

            if (importarCTeOracle)
                return this.TransmitirCTeAnterior(empresaUtilizar, ref conhecimento, xml, unidadeTrabalho);
            else
                return conhecimento;
        }

        public object GerarCTeAnterior(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v300.ConhecimentoDeTransporteProcessado.cteOSProc cte, Stream xml, Repositorio.UnitOfWork unidadeTrabalho, bool importacaoCTeCIOT = false, bool retornaCTeJaInserido = false, bool importarCTeOracle = true, bool utilizarEmpresaDoCTe = false)
        {
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeTrabalho);

            Dominio.Entidades.Empresa empresaUtilizar = null;

            if (utilizarEmpresaDoCTe)
                empresaUtilizar = repEmpresa.BuscarPorCNPJ(cte.CTeOS.infCte.emit.CNPJ);
            else
                empresaUtilizar = empresa;

            if (cte.protCTe.infProt.cStat != "100")
            {
                return string.Concat("O status (", cte.protCTe.infProt.cStat, " - ", Utilidades.String.Left(cte.protCTe.infProt.xMotivo, 60), ") do CT-e (", cte.CTeOS.infCte.ide.nCT, " - ", cte.CTeOS.infCte.ide.serie, ") é inválido para a importação.");
            }

            if (!importacaoCTeCIOT && !Utilidades.String.OnlyNumbers(cte.CTeOS.infCte.emit.CNPJ).Equals(Utilidades.String.OnlyNumbers(empresaUtilizar.CNPJ)))
            {
                return string.Concat("O CNPJ (", cte.CTeOS.infCte.emit.CNPJ, ") do emitente do CT-e (", cte.CTeOS.infCte.ide.nCT, " - ", cte.CTeOS.infCte.ide.serie, ") é diferente do CNPJ da empresa emitente (", empresaUtilizar.CNPJ, ").");
            }

            Dominio.Entidades.EmpresaSerie serie = this.ObterSerie(empresaUtilizar, int.Parse(cte.CTeOS.infCte.ide.serie), unidadeTrabalho);

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = repCTe.BuscarPorChave(empresaUtilizar.Codigo, cte.protCTe.infProt.chCTe);

            if (!importacaoCTeCIOT && conhecimento == null)
                conhecimento = repCTe.BuscarPorNumeroESerie(empresaUtilizar.Codigo, int.Parse(cte.CTeOS.infCte.ide.nCT), int.Parse(cte.CTeOS.infCte.ide.serie), "67", cte.protCTe.infProt.tpAmb == MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TAmb.Item1 ? Dominio.Enumeradores.TipoAmbiente.Producao : Dominio.Enumeradores.TipoAmbiente.Homologacao);

            if (conhecimento != null)
            {
                unidadeTrabalho.Rollback();
                if (importacaoCTeCIOT || retornaCTeJaInserido)
                    return conhecimento;
                else
                    return string.Concat("CT-e com mesmo número e série (", cte.CTeOS.infCte.ide.nCT, " - ", cte.CTeOS.infCte.ide.serie, ") ou chave (", cte.protCTe.infProt.chCTe, ") já existe no sistema.");
            }

            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);
            Repositorio.NaturezaDaOperacao repNaturezaDaOperacao = new Repositorio.NaturezaDaOperacao(unidadeTrabalho);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoSGT = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unidadeTrabalho);

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            conhecimento = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();
            conhecimento.Empresa = empresaUtilizar;
            conhecimento.CFOP = this.ObterCFOP(int.Parse(cte.CTeOS.infCte.ide.CFOP), unidadeTrabalho);
            if (conhecimento.CFOP.NaturezaDaOperacao == null)
                conhecimento.NaturezaDaOperacao = repNaturezaDaOperacao.BuscarPrimeiroRegistro();
            else
                conhecimento.NaturezaDaOperacao = conhecimento.CFOP.NaturezaDaOperacao;
            conhecimento.ValorAReceber = decimal.Parse(cte.CTeOS.infCte.vPrest.vRec, cultura);
            conhecimento.ValorPrestacaoServico = decimal.Parse(cte.CTeOS.infCte.vPrest.vTPrest, cultura);
            conhecimento.ValorFrete = conhecimento.ValorPrestacaoServico;
            conhecimento.PercentualICMSIncluirNoFrete = 100;
            conhecimento.LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTeOS.infCte.ide.cMunIni));
            conhecimento.LocalidadeEmissao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTeOS.infCte.ide.cMunEnv));
            conhecimento.LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTeOS.infCte.ide.cMunFim));
            conhecimento.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);
            conhecimento.TipoControle = 1;

            conhecimento.ModalTransporte.modalProcCTe = (int)cte.CTeOS.infCte.ide.modal;

            conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Pago;// (Dominio.Enumeradores.TipoPagamento)cte.CTe.infCte.ide.forPag;
            conhecimento.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("67");
            conhecimento.Serie = serie;
            conhecimento.TipoImpressao = (Dominio.Enumeradores.TipoImpressao)cte.CTeOS.infCte.ide.tpImp;
            conhecimento.TipoServico = (Dominio.Enumeradores.TipoServico)cte.CTeOS.infCte.ide.tpServ;
            conhecimento.TipoCTE = (Dominio.Enumeradores.TipoCTE)cte.CTeOS.infCte.ide.tpCTe;
            conhecimento.Retira = Dominio.Enumeradores.OpcaoSimNao.Nao;

            this.SetarClienteCTeOS(ref conhecimento, cte.CTeOS.infCte.toma, unidadeTrabalho);

            DateTime dataEmissao;
            DateTime.TryParseExact(cte.CTeOS.infCte.ide.dhEmi, "yyyy-MM-ddTHH:mm:sszzz", null, System.Globalization.DateTimeStyles.None, out dataEmissao);
            conhecimento.DataEmissao = dataEmissao;
            conhecimento.Numero = int.Parse(cte.CTeOS.infCte.ide.nCT);
            conhecimento.Status = "A";
            conhecimento.Cancelado = "N";
            conhecimento.Chave = cte.protCTe.infProt.chCTe;
            conhecimento.Protocolo = cte.protCTe.infProt.nProt;
            DateTime.TryParseExact(cte.protCTe.infProt.dhRecbto, "yyyy-MM-ddTHH:mm:sszzz", null, System.Globalization.DateTimeStyles.None, out DateTime dataRetorno);
            conhecimento.DataRetornoSefaz = dataRetorno;
            DateTime.TryParseExact(cte.protCTe.infProt.dhRecbto, "yyyy-MM-ddTHH:mm:sszzz", null, System.Globalization.DateTimeStyles.None, out DateTime dataAutorizacao);
            conhecimento.DataAutorizacao = dataAutorizacao;

            if (conhecimento.TipoCTE == Dominio.Enumeradores.TipoCTE.Anulacao)
                conhecimento.DataAnulacao = dataAutorizacao;

            conhecimento.Versao = cte.protCTe.versao;
            conhecimento.MensagemRetornoSefaz = "CTe OS Processado (Importação).";
            conhecimento.TipoAmbiente = cte.protCTe.infProt.tpAmb == MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TAmb.Item1 ? Dominio.Enumeradores.TipoAmbiente.Producao : Dominio.Enumeradores.TipoAmbiente.Homologacao;
            conhecimento.Log = string.Concat("CT-e importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");
            if (importacaoCTeCIOT)
                conhecimento.ObservacoesAvancadas = Utilidades.String.OnlyNumbers(cte.CTeOS.infCte.emit.CNPJ);
            conhecimento.CTeSemCarga = true;

            repCTe.Inserir(conhecimento);

            this.ObterICMS(ref conhecimento, cte.CTeOS.infCte.imp);
            this.ObterInformacoesTomador(ref conhecimento, cte.CTeOS.infCte.ide, unidadeTrabalho);
            this.ObterInformacoesCTe(ref conhecimento, cte.CTeOS.infCte, unidadeTrabalho);
            this.ObterInformacoesComplementares(ref conhecimento, cte.CTeOS.infCte.compl, unidadeTrabalho);
            //this.ObterInformacoesDocumentosAnteriores(ref conhecimento, cte.CTe.infCte, unidadeTrabalho);
            this.SalvarInformacoesComponentesDaPrestacao(conhecimento, cte.CTeOS.infCte.vPrest.Comp, unidadeTrabalho);
            conhecimento.ExibeICMSNaDACTE = true;

            SetarTomadorPagadorCTe(ref conhecimento);

            repCTe.Atualizar(conhecimento);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoSGT = repConfiguracaoSGT.BuscarConfiguracaoPadrao();
            bool armazenarEmArquivo = configuracaoSGT != null ? configuracaoSGT.ArmazenarXMLCTeEmArquivo : false;

            Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeTrabalho);
            Dominio.Entidades.XMLCTe xmlCTe = new Dominio.Entidades.XMLCTe();
            xmlCTe.CTe = conhecimento;
            xmlCTe.Tipo = Dominio.Enumeradores.TipoXMLCTe.Autorizacao;

            xml.Position = 0;

            if (!armazenarEmArquivo)
            {
                StreamReader reader = new StreamReader(xml);
                xmlCTe.XML = reader.ReadToEnd();
                xmlCTe.XMLArmazenadoEmArquivo = false;
            }
            else
            {
                xmlCTe.XML = "";
                xmlCTe.XMLArmazenadoEmArquivo = true;
                string arquivo = CriarERetornarCaminhoXMLCTe(conhecimento, "A", unidadeTrabalho);
                using (Stream fileXML = Utilidades.IO.FileStorageService.Storage.Create(arquivo))
                    xml.CopyTo(fileXML);
            }

            repXMLCTe.Inserir(xmlCTe);

            Repositorio.IntegracaoCTeRecebimento repIntegracaoCTeRecebimento = new Repositorio.IntegracaoCTeRecebimento(unidadeTrabalho);
            Dominio.Entidades.IntegracaoCTeRecebimento integracaoCTeRecebimento = new Dominio.Entidades.IntegracaoCTeRecebimento();
            integracaoCTeRecebimento.CTe = conhecimento;
            integracaoCTeRecebimento.Data = DateTime.Now;
            integracaoCTeRecebimento.DataStatus = DateTime.Now;
            integracaoCTeRecebimento.Status = Dominio.Enumeradores.StatusIntegracaoRecebimentoCTe.Pendente;
            integracaoCTeRecebimento.Tipo = Dominio.Enumeradores.TipoIntegracaoEnvioCTe.Autorizacao;
            repIntegracaoCTeRecebimento.Inserir(integracaoCTeRecebimento);

            unidadeTrabalho.CommitChanges();

            if (importarCTeOracle)
                return this.TransmitirCTeAnterior(empresaUtilizar, ref conhecimento, xml, unidadeTrabalho);
            else
                return conhecimento;
        }

        public object GerarCTeAnterior(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v400.ConhecimentoDeTransporteProcessado.cteOSProc cte, Stream xml, Repositorio.UnitOfWork unidadeTrabalho, bool importacaoCTeCIOT = false, bool retornaCTeJaInserido = false, bool importarCTeOracle = true, bool utilizarEmpresaDoCTe = false)
        {
            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeTrabalho);

            Dominio.Entidades.Empresa empresaUtilizar = null;

            if (utilizarEmpresaDoCTe)
                empresaUtilizar = repEmpresa.BuscarPorCNPJ(cte.CTeOS.infCte.emit.CNPJ);
            else
                empresaUtilizar = empresa;

            if (cte.protCTe.infProt.cStat != "100")
            {
                return string.Concat("O status (", cte.protCTe.infProt.cStat, " - ", Utilidades.String.Left(cte.protCTe.infProt.xMotivo, 60), ") do CT-e (", cte.CTeOS.infCte.ide.nCT, " - ", cte.CTeOS.infCte.ide.serie, ") é inválido para a importação.");
            }

            if (!importacaoCTeCIOT && !Utilidades.String.OnlyNumbers(cte.CTeOS.infCte.emit.CNPJ).Equals(Utilidades.String.OnlyNumbers(empresaUtilizar.CNPJ)))
            {
                return string.Concat("O CNPJ (", cte.CTeOS.infCte.emit.CNPJ, ") do emitente do CT-e (", cte.CTeOS.infCte.ide.nCT, " - ", cte.CTeOS.infCte.ide.serie, ") é diferente do CNPJ da empresa emitente (", empresaUtilizar.CNPJ, ").");
            }

            Dominio.Entidades.EmpresaSerie serie = this.ObterSerie(empresaUtilizar, int.Parse(cte.CTeOS.infCte.ide.serie), unidadeTrabalho);

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = repCTe.BuscarPorChave(empresaUtilizar.Codigo, cte.protCTe.infProt.chCTe);

            if (!importacaoCTeCIOT && conhecimento == null)
                conhecimento = repCTe.BuscarPorNumeroESerie(empresaUtilizar.Codigo, int.Parse(cte.CTeOS.infCte.ide.nCT), int.Parse(cte.CTeOS.infCte.ide.serie), "67", cte.protCTe.infProt.tpAmb == MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TAmb.Item1 ? Dominio.Enumeradores.TipoAmbiente.Producao : Dominio.Enumeradores.TipoAmbiente.Homologacao);

            if (conhecimento != null)
            {
                unidadeTrabalho.Rollback();
                if (importacaoCTeCIOT || retornaCTeJaInserido)
                    return conhecimento;
                else
                    return string.Concat("CT-e com mesmo número e série (", cte.CTeOS.infCte.ide.nCT, " - ", cte.CTeOS.infCte.ide.serie, ") ou chave (", cte.protCTe.infProt.chCTe, ") já existe no sistema.");
            }

            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);
            Repositorio.NaturezaDaOperacao repNaturezaDaOperacao = new Repositorio.NaturezaDaOperacao(unidadeTrabalho);
            Repositorio.Embarcador.Configuracao.ConfiguracaoTMS repConfiguracaoSGT = new Repositorio.Embarcador.Configuracao.ConfiguracaoTMS(unidadeTrabalho);

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            conhecimento = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();
            conhecimento.Empresa = empresaUtilizar;
            conhecimento.CFOP = this.ObterCFOP(int.Parse(cte.CTeOS.infCte.ide.CFOP), unidadeTrabalho);
            if (conhecimento.CFOP.NaturezaDaOperacao == null)
                conhecimento.NaturezaDaOperacao = repNaturezaDaOperacao.BuscarPrimeiroRegistro();
            else
                conhecimento.NaturezaDaOperacao = conhecimento.CFOP.NaturezaDaOperacao;
            conhecimento.ValorAReceber = decimal.Parse(cte.CTeOS.infCte.vPrest.vRec, cultura);
            conhecimento.ValorPrestacaoServico = decimal.Parse(cte.CTeOS.infCte.vPrest.vTPrest, cultura);
            conhecimento.ValorFrete = conhecimento.ValorPrestacaoServico;
            conhecimento.PercentualICMSIncluirNoFrete = 100;
            conhecimento.LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTeOS.infCte.ide.cMunIni));
            conhecimento.LocalidadeEmissao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTeOS.infCte.ide.cMunEnv));
            conhecimento.LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTeOS.infCte.ide.cMunFim));
            conhecimento.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);
            conhecimento.TipoControle = 1;

            conhecimento.ModalTransporte.modalProcCTe = (int)cte.CTeOS.infCte.ide.modal;

            conhecimento.TipoPagamento = Dominio.Enumeradores.TipoPagamento.Pago;// (Dominio.Enumeradores.TipoPagamento)cte.CTe.infCte.ide.forPag;
            conhecimento.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("67");
            conhecimento.Serie = serie;
            conhecimento.TipoImpressao = (Dominio.Enumeradores.TipoImpressao)cte.CTeOS.infCte.ide.tpImp;
            conhecimento.TipoServico = (Dominio.Enumeradores.TipoServico)cte.CTeOS.infCte.ide.tpServ;
            conhecimento.TipoCTE = (Dominio.Enumeradores.TipoCTE)cte.CTeOS.infCte.ide.tpCTe;
            conhecimento.Retira = Dominio.Enumeradores.OpcaoSimNao.Nao;

            this.SetarClienteCTeOS(ref conhecimento, cte.CTeOS.infCte.toma, unidadeTrabalho);

            DateTime dataEmissao;
            DateTime.TryParseExact(cte.CTeOS.infCte.ide.dhEmi, "yyyy-MM-ddTHH:mm:sszzz", null, System.Globalization.DateTimeStyles.None, out dataEmissao);
            conhecimento.DataEmissao = dataEmissao;
            conhecimento.Numero = int.Parse(cte.CTeOS.infCte.ide.nCT);
            conhecimento.Status = "A";
            conhecimento.Cancelado = "N";
            conhecimento.Chave = cte.protCTe.infProt.chCTe;
            conhecimento.Protocolo = cte.protCTe.infProt.nProt;
            DateTime.TryParseExact(cte.protCTe.infProt.dhRecbto, "yyyy-MM-ddTHH:mm:sszzz", null, System.Globalization.DateTimeStyles.None, out DateTime dataRetorno);
            conhecimento.DataRetornoSefaz = dataRetorno;
            DateTime.TryParseExact(cte.protCTe.infProt.dhRecbto, "yyyy-MM-ddTHH:mm:sszzz", null, System.Globalization.DateTimeStyles.None, out DateTime dataAutorizacao);
            conhecimento.DataAutorizacao = dataAutorizacao;

            if (conhecimento.TipoCTE == Dominio.Enumeradores.TipoCTE.Anulacao)
                conhecimento.DataAnulacao = dataAutorizacao;

            conhecimento.Versao = cte.protCTe.versao;
            conhecimento.MensagemRetornoSefaz = "CTe OS Processado (Importação).";
            conhecimento.TipoAmbiente = cte.protCTe.infProt.tpAmb == MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TAmb.Item1 ? Dominio.Enumeradores.TipoAmbiente.Producao : Dominio.Enumeradores.TipoAmbiente.Homologacao;
            conhecimento.Log = string.Concat("CT-e importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");
            if (importacaoCTeCIOT)
                conhecimento.ObservacoesAvancadas = Utilidades.String.OnlyNumbers(cte.CTeOS.infCte.emit.CNPJ);
            conhecimento.CTeSemCarga = true;

            repCTe.Inserir(conhecimento);

            this.ObterICMS(ref conhecimento, cte.CTeOS.infCte.imp);
            this.ObterIBSCBS(ref conhecimento, cte.CTeOS.infCte.imp);
            this.ObterInformacoesTomador(ref conhecimento, cte.CTeOS.infCte.ide, unidadeTrabalho);
            this.ObterInformacoesCTe(ref conhecimento, cte.CTeOS.infCte, unidadeTrabalho);
            this.ObterInformacoesComplementares(ref conhecimento, cte.CTeOS.infCte.compl, unidadeTrabalho);
            //this.ObterInformacoesDocumentosAnteriores(ref conhecimento, cte.CTe.infCte, unidadeTrabalho);
            this.SalvarInformacoesComponentesDaPrestacao(conhecimento, cte.CTeOS.infCte.vPrest.Comp, unidadeTrabalho);
            conhecimento.ExibeICMSNaDACTE = true;

            SetarTomadorPagadorCTe(ref conhecimento);

            repCTe.Atualizar(conhecimento);

            Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS configuracaoSGT = repConfiguracaoSGT.BuscarConfiguracaoPadrao();
            bool armazenarEmArquivo = configuracaoSGT != null ? configuracaoSGT.ArmazenarXMLCTeEmArquivo : false;

            Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeTrabalho);
            Dominio.Entidades.XMLCTe xmlCTe = new Dominio.Entidades.XMLCTe();
            xmlCTe.CTe = conhecimento;
            xmlCTe.Tipo = Dominio.Enumeradores.TipoXMLCTe.Autorizacao;

            xml.Position = 0;

            if (!armazenarEmArquivo)
            {
                StreamReader reader = new StreamReader(xml);
                xmlCTe.XML = reader.ReadToEnd();
                xmlCTe.XMLArmazenadoEmArquivo = false;
            }
            else
            {
                xmlCTe.XML = "";
                xmlCTe.XMLArmazenadoEmArquivo = true;
                string arquivo = CriarERetornarCaminhoXMLCTe(conhecimento, "A", unidadeTrabalho);
                using (Stream fileXML = Utilidades.IO.FileStorageService.Storage.Create(arquivo))
                    xml.CopyTo(fileXML);
            }

            repXMLCTe.Inserir(xmlCTe);

            Repositorio.IntegracaoCTeRecebimento repIntegracaoCTeRecebimento = new Repositorio.IntegracaoCTeRecebimento(unidadeTrabalho);
            Dominio.Entidades.IntegracaoCTeRecebimento integracaoCTeRecebimento = new Dominio.Entidades.IntegracaoCTeRecebimento();
            integracaoCTeRecebimento.CTe = conhecimento;
            integracaoCTeRecebimento.Data = DateTime.Now;
            integracaoCTeRecebimento.DataStatus = DateTime.Now;
            integracaoCTeRecebimento.Status = Dominio.Enumeradores.StatusIntegracaoRecebimentoCTe.Pendente;
            integracaoCTeRecebimento.Tipo = Dominio.Enumeradores.TipoIntegracaoEnvioCTe.Autorizacao;
            repIntegracaoCTeRecebimento.Inserir(integracaoCTeRecebimento);

            unidadeTrabalho.CommitChanges();

            if (importarCTeOracle)
                return this.TransmitirCTeAnterior(empresaUtilizar, ref conhecimento, xml, unidadeTrabalho);
            else
                return conhecimento;
        }

        private object GerarCTeEnvio(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v200.Envio.TEnviCTe cte, Stream xml, string chCTe, string nProt, string cStat, string tpAmb, string tipoVeiculo, Repositorio.UnitOfWork unidadeTrabalho, string numeroControle = "")
        {
            if (cStat != "100")
            {
                return string.Concat("O status (", nProt, " - ) do CT-e (", chCTe, " - ) é inválido para a importação.");
            }

            Dominio.Entidades.EmpresaSerie serie = this.ObterSerie(empresa, int.Parse(cte.CTe.FirstOrDefault().infCte.ide.serie), unidadeTrabalho);

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);
            Repositorio.IntegracaoCTeRecebimento repIntegracaoCTeRecebimento = new Repositorio.IntegracaoCTeRecebimento(unidadeTrabalho);
            Dominio.Entidades.IntegracaoCTeRecebimento integracaoCTeRecebimento = new Dominio.Entidades.IntegracaoCTeRecebimento();

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = repCTe.BuscarPorChave(empresa.Codigo, chCTe);

            if (conhecimento != null)
            {
                unidadeTrabalho.Rollback();

                integracaoCTeRecebimento.CTe = conhecimento;
                integracaoCTeRecebimento.Data = DateTime.Now;
                integracaoCTeRecebimento.DataStatus = DateTime.Now;
                integracaoCTeRecebimento.Status = Dominio.Enumeradores.StatusIntegracaoRecebimentoCTe.Pendente;
                integracaoCTeRecebimento.Tipo = Dominio.Enumeradores.TipoIntegracaoEnvioCTe.Autorizacao;
                integracaoCTeRecebimento.TipoVeiculo = tipoVeiculo;
                repIntegracaoCTeRecebimento.Inserir(integracaoCTeRecebimento);

                return conhecimento;
            }

            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unidadeTrabalho);

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            conhecimento = new Dominio.Entidades.ConhecimentoDeTransporteEletronico();
            conhecimento.Empresa = empresa;
            conhecimento.CFOP = this.ObterCFOP(int.Parse(cte.CTe.FirstOrDefault().infCte.ide.CFOP), unidadeTrabalho);
            conhecimento.NaturezaDaOperacao = conhecimento.CFOP.NaturezaDaOperacao;
            conhecimento.ValorAReceber = decimal.Parse(cte.CTe.FirstOrDefault().infCte.vPrest.vRec, cultura);
            conhecimento.ValorPrestacaoServico = decimal.Parse(cte.CTe.FirstOrDefault().infCte.vPrest.vTPrest, cultura);
            conhecimento.ValorFrete = conhecimento.ValorPrestacaoServico;
            conhecimento.PercentualICMSIncluirNoFrete = 100;
            conhecimento.LocalidadeInicioPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.FirstOrDefault().infCte.ide.cMunIni));
            conhecimento.LocalidadeEmissao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.FirstOrDefault().infCte.ide.cMunEnv));
            conhecimento.LocalidadeTerminoPrestacao = repLocalidade.BuscarPorCodigoIBGE(int.Parse(cte.CTe.FirstOrDefault().infCte.ide.cMunFim));
            conhecimento.ModalTransporte = repModalTransporte.BuscarPorCodigo(1, false);
            conhecimento.TipoControle = 1;

            conhecimento.ModalTransporte.modalProcCTe = (int)cte.CTe.FirstOrDefault().infCte.ide.modal;

            conhecimento.TipoPagamento = (Dominio.Enumeradores.TipoPagamento)cte.CTe.FirstOrDefault().infCte.ide.forPag;
            conhecimento.ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("57"); //repModeloDocumentoFiscal.BuscarPorModelo(string.Format("{0:00}", (int)cte.CTe.FirstOrDefault().infCte.ide.mod)); /
            conhecimento.Serie = serie;
            conhecimento.TipoImpressao = (Dominio.Enumeradores.TipoImpressao)cte.CTe.FirstOrDefault().infCte.ide.tpImp;
            conhecimento.TipoServico = (Dominio.Enumeradores.TipoServico)cte.CTe.FirstOrDefault().infCte.ide.tpServ;
            conhecimento.TipoCTE = (Dominio.Enumeradores.TipoCTE)cte.CTe.FirstOrDefault().infCte.ide.tpCTe;

            conhecimento.Retira = cte.CTe.FirstOrDefault().infCte.ide.retira == MultiSoftware.CTe.v200.Envio.TCTeInfCteIdeRetira.Item1 ? Dominio.Enumeradores.OpcaoSimNao.Nao : Dominio.Enumeradores.OpcaoSimNao.Sim;
            conhecimento.DetalhesRetira = cte.CTe.FirstOrDefault().infCte.ide.xDetRetira;

            this.SetarDestinatario(ref conhecimento, cte.CTe.FirstOrDefault().infCte.dest, unidadeTrabalho);
            this.SetarExpedidor(ref conhecimento, cte.CTe.FirstOrDefault().infCte.exped, unidadeTrabalho);
            this.SetarRecebedor(ref conhecimento, cte.CTe.FirstOrDefault().infCte.receb, unidadeTrabalho);
            this.SetarRemetente(ref conhecimento, cte.CTe.FirstOrDefault().infCte.rem, unidadeTrabalho);

            DateTime dataEmissao;
            DateTime.TryParseExact(cte.CTe.FirstOrDefault().infCte.ide.dhEmi, "yyyy-MM-ddTHH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataEmissao);
            conhecimento.DataEmissao = dataEmissao;
            conhecimento.Numero = int.Parse(cte.CTe.FirstOrDefault().infCte.ide.nCT);
            conhecimento.Status = "A";
            conhecimento.Cancelado = "N";
            conhecimento.Chave = chCTe;
            conhecimento.Protocolo = nProt;

            DateTime dataAutorizacao = DateTime.Now;

            conhecimento.DataRetornoSefaz = dataAutorizacao;
            conhecimento.DataAutorizacao = dataAutorizacao;
            conhecimento.Versao = "2.00";
            conhecimento.MensagemRetornoSefaz = "CTe Processado (Importação).";
            conhecimento.CTeImportadoEmbarcador = true;
            conhecimento.NumeroControle = numeroControle;
            conhecimento.TipoAmbiente = tpAmb == "1" ? Dominio.Enumeradores.TipoAmbiente.Producao : Dominio.Enumeradores.TipoAmbiente.Homologacao;
            conhecimento.Log = string.Concat("CT-e importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");

            repCTe.Inserir(conhecimento);

            if (string.IsNullOrWhiteSpace(conhecimento.NumeroControle))
                conhecimento.NumeroControle = conhecimento.Codigo.ToString("D");

            repCTe.Atualizar(conhecimento);

            this.ObterICMS(ref conhecimento, cte.CTe.FirstOrDefault().infCte.imp);
            this.ObterInformacoesTomador(ref conhecimento, cte.CTe.FirstOrDefault().infCte.ide, unidadeTrabalho);
            this.ObterInformacoesCTe(ref conhecimento, cte.CTe.FirstOrDefault().infCte, unidadeTrabalho);
            this.ObterInformacoesComplementares(ref conhecimento, cte.CTe.FirstOrDefault().infCte.compl, unidadeTrabalho);
            this.SalvarInformacoesComponentesDaPrestacao(conhecimento, cte.CTe.FirstOrDefault().infCte.vPrest.Comp, unidadeTrabalho);
            conhecimento.ExibeICMSNaDACTE = true;

            SetarTomadorPagadorCTe(ref conhecimento);

            repCTe.Atualizar(conhecimento);

            //Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeTrabalho);
            //Dominio.Entidades.XMLCTe xmlCTe = new Dominio.Entidades.XMLCTe();
            //xmlCTe.CTe = conhecimento;
            //xmlCTe.Tipo = Dominio.Enumeradores.TipoXMLCTe.Autorizacao;

            //xml.Position = 0;
            //StreamReader reader = new StreamReader(xml);
            //xmlCTe.XML = reader.ReadToEnd();

            //repXMLCTe.Inserir(xmlCTe);

            integracaoCTeRecebimento.CTe = conhecimento;
            integracaoCTeRecebimento.Data = DateTime.Now;
            integracaoCTeRecebimento.DataStatus = DateTime.Now;
            integracaoCTeRecebimento.Status = Dominio.Enumeradores.StatusIntegracaoRecebimentoCTe.Pendente;
            integracaoCTeRecebimento.Tipo = Dominio.Enumeradores.TipoIntegracaoEnvioCTe.Autorizacao;
            integracaoCTeRecebimento.TipoVeiculo = tipoVeiculo;
            repIntegracaoCTeRecebimento.Inserir(integracaoCTeRecebimento);

            unidadeTrabalho.CommitChanges();

            return conhecimento;
            //return this.TransmitirCTeAnterior(empresa, ref conhecimento, xml, unidadeTrabalho);
        }

        private object TransmitirCTeAnterior(Dominio.Entidades.Empresa empresa, ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Stream xml, Repositorio.UnitOfWork unitOfWork)
        {
            ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unitOfWork).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);
            ServicoCTe.Cte cteTransmitir = this.ObterCTeParaEmissao(cte, empresa, unitOfWork);

            cteTransmitir.Protocolo = cte.Protocolo;
            cteTransmitir.DataIntegracaoSefaz = cte.DataRetornoSefaz.HasValue ? cte.DataRetornoSefaz.Value.ToString("dd/MM/yyyy HH:mm:ss") : string.Empty;
            cteTransmitir.ID = cte.Chave;

            if (xml != null)
            {
                xml.Position = 0;
                System.IO.StreamReader strReader = new StreamReader(xml);

                cteTransmitir.Xml = new ServicoCTe.Xml();
                cteTransmitir.Xml.Arquivo = strReader.ReadToEnd();
                cteTransmitir.Xml.Chave = cte.Chave;
            }

            ServicoCTe.ResultadoInteger retorno = svcCTe.ImportaCteAnterior(cteTransmitir);

            if (retorno.Valor <= 0)
            {
                Servicos.Log.TratarErro(retorno.Info.MensagemOriginal);

                return "Conhecimento salvo, porém ocorreram erros ao integrar os dados.";
            }
            else
            {
                Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);

                cte.CodigoCTeIntegrador = retorno.Valor;
                cte.StatusIntegrador = "Z";

                repCTe.Atualizar(cte);

                return cte;
            }
        }

        private bool TransmitirCancelamentoCTeAnterior(Dominio.Entidades.Empresa empresa, Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Stream xml, Repositorio.UnitOfWork unitOfWork)
        {
            try
            {
                ServicoCTe.uCteServiceTSSoapClient svcCTe = new Servicos.Embarcador.Integracao.ConfiguracaoWebService(unitOfWork).ObterClient<ServicoCTe.uCteServiceTSSoapClient, ServicoCTe.uCteServiceTSSoap>(TipoWebServiceIntegracao.Oracle_uCTeServiceTS);
                ServicoCTe.Cte cteTransmitir = this.ObterCTeParaEmissao(cte, empresa, unitOfWork);

                xml.Position = 0;
                System.IO.StreamReader strReader = new StreamReader(xml);

                cteTransmitir.Protocolo = cte.ProtocoloCancelamentoInutilizacao;
                cteTransmitir.DataIntegracaoSefaz = cte.DataRetornoSefaz.HasValue ? cte.DataRetornoSefaz.Value.ToString("dd/MM/yyyy HH:mm:ss") : string.Empty;
                cteTransmitir.Xml = new ServicoCTe.Xml();
                cteTransmitir.Xml.Arquivo = strReader.ReadToEnd();
                cteTransmitir.Xml.Chave = cte.Chave;
                cteTransmitir.ID = cte.Chave;

                ServicoCTe.ResultadoInteger retorno = svcCTe.ImportaCancelamentoCteAnterior(cteTransmitir);

                if (retorno.Valor <= 0)
                {
                    Servicos.Log.TratarErro("Erro ao integrar dados de cancelamento CTe: " + retorno.Info.MensagemOriginal);

                    return false;
                }
                else
                    return true;
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Erro ao integrar dados de cancelamento CTe: " + ex);
                return false;
            }
        }

        private object GerarCTeAnteriorInutilizado(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v104.ConhecimentoDeTransporteInutilizado.TProcInutCTe cteInutilizado, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (cteInutilizado.retInutCTe.infInut.cStat != "102")
            {
                unidadeTrabalho.Rollback();
                return string.Concat("O status (", cteInutilizado.retInutCTe.infInut.cStat, " - ", Utilidades.String.Left(cteInutilizado.retInutCTe.infInut.xMotivo, 60),
                                     ") da faixa de números de ", cteInutilizado.inutCTe.infInut.nCTIni, " à ", cteInutilizado.inutCTe.infInut.nCTFin, " da série ",
                                     cteInutilizado.inutCTe.infInut.serie, " e do modelo ", cteInutilizado.inutCTe.infInut.mod, " é inválido para a importação.");
            }

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            int numeroInicial = int.Parse(cteInutilizado.inutCTe.infInut.nCTIni);
            int numeroFinal = int.Parse(cteInutilizado.inutCTe.infInut.nCTFin);
            int serie = int.Parse(cteInutilizado.inutCTe.infInut.serie);
            string modelo = ((int)cteInutilizado.inutCTe.infInut.mod).ToString();
            Dominio.Enumeradores.TipoAmbiente tipoAmbiente = (Dominio.Enumeradores.TipoAmbiente)cteInutilizado.inutCTe.infInut.tpAmb;

            for (int i = numeroInicial; i <= numeroFinal; i++)
            {
                Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = repCTe.Buscar(empresa.Codigo, i, serie, modelo, tipoAmbiente);

                if (conhecimento != null)
                {
                    conhecimento.Status = "I";
                    conhecimento.Cancelado = "N";
                    conhecimento.ProtocoloCancelamentoInutilizacao = cteInutilizado.retInutCTe.infInut.nProt;
                    conhecimento.Log += string.Concat(" / CT-e de inutilização importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");
                    conhecimento.DataRetornoSefaz = cteInutilizado.retInutCTe.infInut.dhRecbto;
                    conhecimento.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(cteInutilizado.retInutCTe.infInut.xMotivo);
                    conhecimento.ObservacaoCancelamento = cteInutilizado.inutCTe.infInut.xJust;

                    repCTe.Atualizar(conhecimento);
                }
            }

            unidadeTrabalho.CommitChanges();
            return null;
        }

        private object GerarCTeAnteriorInutilizado(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v300.ConhecimentoDeTransporteInutilizado.TProcInutCTe cteInutilizado, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (cteInutilizado.retInutCTe.infInut.cStat != "102")
            {
                unidadeTrabalho.Rollback();
                return string.Concat("O status (", cteInutilizado.retInutCTe.infInut.cStat, " - ", Utilidades.String.Left(cteInutilizado.retInutCTe.infInut.xMotivo, 60),
                                     ") da faixa de números de ", cteInutilizado.inutCTe.infInut.nCTIni, " à ", cteInutilizado.inutCTe.infInut.nCTFin, " da série ",
                                     cteInutilizado.inutCTe.infInut.serie, " e do modelo ", cteInutilizado.inutCTe.infInut.mod, " é inválido para a importação.");
            }

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            int numeroInicial = int.Parse(cteInutilizado.inutCTe.infInut.nCTIni);
            int numeroFinal = int.Parse(cteInutilizado.inutCTe.infInut.nCTFin);
            int serie = int.Parse(cteInutilizado.inutCTe.infInut.serie);
            string modelo = ((int)cteInutilizado.inutCTe.infInut.mod).ToString();
            Dominio.Enumeradores.TipoAmbiente tipoAmbiente = (Dominio.Enumeradores.TipoAmbiente)cteInutilizado.inutCTe.infInut.tpAmb;

            for (int i = numeroInicial; i <= numeroFinal; i++)
            {
                Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = repCTe.Buscar(empresa.Codigo, i, serie, modelo, tipoAmbiente);

                if (conhecimento != null)
                {
                    conhecimento.Status = "I";
                    conhecimento.Cancelado = "N";
                    conhecimento.ProtocoloCancelamentoInutilizacao = cteInutilizado.retInutCTe.infInut.nProt;
                    conhecimento.Log += string.Concat(" / CT-e de inutilização importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");
                    conhecimento.DataRetornoSefaz = cteInutilizado.retInutCTe.infInut.dhRecbto;
                    conhecimento.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(cteInutilizado.retInutCTe.infInut.xMotivo);
                    conhecimento.ObservacaoCancelamento = cteInutilizado.inutCTe.infInut.xJust;

                    repCTe.Atualizar(conhecimento);
                }
            }

            unidadeTrabalho.CommitChanges();
            return null;
        }

        private object GerarCTeAnteriorInutilizado(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v200.ConhecimentoDeTransporteInutilizado.TProcInutCTe cteInutilizado, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (cteInutilizado.retInutCTe.infInut.cStat != "102")
            {
                unidadeTrabalho.Rollback();
                return string.Concat("O status (", cteInutilizado.retInutCTe.infInut.cStat, " - ", Utilidades.String.Left(cteInutilizado.retInutCTe.infInut.xMotivo, 60),
                                     ") da faixa de números de ", cteInutilizado.inutCTe.infInut.nCTIni, " à ", cteInutilizado.inutCTe.infInut.nCTFin, " da série ",
                                     cteInutilizado.inutCTe.infInut.serie, " e do modelo ", cteInutilizado.inutCTe.infInut.mod, " é inválido para a importação.");
            }

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            int numeroInicial = int.Parse(cteInutilizado.inutCTe.infInut.nCTIni);
            int numeroFinal = int.Parse(cteInutilizado.inutCTe.infInut.nCTFin);
            int serie = int.Parse(cteInutilizado.inutCTe.infInut.serie);
            string modelo = ((int)cteInutilizado.inutCTe.infInut.mod).ToString();
            Dominio.Enumeradores.TipoAmbiente tipoAmbiente = (Dominio.Enumeradores.TipoAmbiente)cteInutilizado.inutCTe.infInut.tpAmb;

            for (int i = numeroInicial; i <= numeroFinal; i++)
            {
                Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = repCTe.Buscar(empresa.Codigo, i, serie, modelo, tipoAmbiente);

                if (conhecimento != null)
                {
                    conhecimento.Status = "I";
                    conhecimento.Cancelado = "N";
                    conhecimento.ProtocoloCancelamentoInutilizacao = cteInutilizado.retInutCTe.infInut.nProt;
                    conhecimento.Log += string.Concat(" / CT-e de inutilização importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");
                    conhecimento.DataRetornoSefaz = cteInutilizado.retInutCTe.infInut.dhRecbto;
                    conhecimento.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(cteInutilizado.retInutCTe.infInut.xMotivo);
                    conhecimento.ObservacaoCancelamento = cteInutilizado.inutCTe.infInut.xJust;

                    repCTe.Atualizar(conhecimento);
                }
            }

            unidadeTrabalho.CommitChanges();
            return null;
        }

        private object GerarCTeAnteriorCancelado(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v104.ConhecimentoDeTransporteCancelado.TProcCancCTe cteCancelado, Repositorio.UnitOfWork unidadeTrabalho, bool utilizarEmpresaDoCTe = false)
        {
            if (cteCancelado.retCancCTe.infCanc.cStat != "101")
            {
                unidadeTrabalho.Rollback();
                return string.Concat("O status (", cteCancelado.retCancCTe.infCanc.cStat, " - ", Utilidades.String.Left(cteCancelado.retCancCTe.infCanc.xMotivo, 60), ") do CT-e (", cteCancelado.cancCTe.infCanc.chCTe, ") é inválido para a importação.");
            }

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = null;

            if (!utilizarEmpresaDoCTe)
                conhecimento = repCTe.BuscarPorChave(empresa.Codigo, cteCancelado.retCancCTe.infCanc.chCTe);
            else
                conhecimento = repCTe.BuscarPorChave(cteCancelado.retCancCTe.infCanc.chCTe);

            if (conhecimento == null)
            {
                unidadeTrabalho.Rollback();
                return string.Concat("CT-e (", cteCancelado.retCancCTe.infCanc.chCTe, ") não encontrado.");
            }

            conhecimento.Cancelado = "S";
            conhecimento.Status = "C";
            conhecimento.ProtocoloCancelamentoInutilizacao = cteCancelado.retCancCTe.infCanc.nProt;
            conhecimento.Log += string.Concat(" / CT-e de cancelamento importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");

            DateTime dataCancelamento = cteCancelado.retCancCTe.infCanc.dhRecbto;

            conhecimento.DataRetornoSefaz = dataCancelamento;
            conhecimento.DataCancelamento = dataCancelamento;
            conhecimento.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(cteCancelado.retCancCTe.infCanc.xMotivo);
            conhecimento.ObservacaoCancelamento = cteCancelado.cancCTe.infCanc.xJust;

            repCTe.Atualizar(conhecimento);

            Repositorio.IntegracaoCTeRecebimento repIntegracaoCTeRecebimento = new Repositorio.IntegracaoCTeRecebimento(unidadeTrabalho);
            Dominio.Entidades.IntegracaoCTeRecebimento integracaoCTeRecebimento = new Dominio.Entidades.IntegracaoCTeRecebimento();
            integracaoCTeRecebimento.CTe = conhecimento;
            integracaoCTeRecebimento.Data = DateTime.Now;
            integracaoCTeRecebimento.DataStatus = DateTime.Now;
            integracaoCTeRecebimento.Status = Dominio.Enumeradores.StatusIntegracaoRecebimentoCTe.Aprovado;
            integracaoCTeRecebimento.Tipo = Dominio.Enumeradores.TipoIntegracaoEnvioCTe.Cancelamento;
            repIntegracaoCTeRecebimento.Inserir(integracaoCTeRecebimento);

            unidadeTrabalho.CommitChanges();

            return conhecimento;
        }

        private object GerarCTeAnteriorEvento(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v200.Eventos.TProcEvento procEvento, Stream xml, Repositorio.UnitOfWork unidadeDetrabalho, bool utilizarEmpresaDoCTe = false)
        {
            if (procEvento != null)
            {
                if (procEvento.retEventoCTe.infEvento.tpEvento == "110111")
                    return this.GerarCTeAnteriorEventoCancelamento(empresa, procEvento, xml, unidadeDetrabalho, utilizarEmpresaDoCTe);
            }

            return null;
        }

        private object GerarCTeAnteriorEvento(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v300.Eventos.TProcEvento procEvento, Stream xml, Repositorio.UnitOfWork unidadeDetrabalho, bool utilizarEmpresaDoCTe = false, bool importarCTeOracle = false)
        {
            if (procEvento != null)
            {
                if (procEvento.retEventoCTe.infEvento.tpEvento == "110111")
                    return this.GerarCTeAnteriorEventoCancelamento(empresa, procEvento, xml, unidadeDetrabalho, utilizarEmpresaDoCTe, importarCTeOracle);
            }

            return null;
        }

        private object GerarCTeAnteriorEvento(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v400.Eventos.TProcEvento procEvento, Stream xml, Repositorio.UnitOfWork unidadeDetrabalho, bool utilizarEmpresaDoCTe = false, bool importarCTeOracle = false)
        {
            if (procEvento != null)
            {
                if (procEvento.retEventoCTe.infEvento.tpEvento == "110111")
                    return this.GerarCTeAnteriorEventoCancelamento(empresa, procEvento, xml, unidadeDetrabalho, utilizarEmpresaDoCTe, importarCTeOracle);
            }

            return null;
        }

        public string CancelarConhencimentoImportado(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.Eventos.TProcEvento procEvento, Stream xml, Repositorio.UnitOfWork unidadeTrabalho, bool enviarParaOracle = true)
        {
            if (conhecimento == null)
                return string.Concat("CT-e (", procEvento.retEventoCTe.infEvento.chCTe, ") não encontrado.");

            Repositorio.Embarcador.Ocorrencias.CargaOcorrenciaDocumento repCargaOcorrenciaDocumento = new Repositorio.Embarcador.Ocorrencias.CargaOcorrenciaDocumento(unidadeTrabalho);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);
            Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeTrabalho);
            Repositorio.IntegracaoCTeRecebimento repIntegracaoCTeRecebimento = new Repositorio.IntegracaoCTeRecebimento(unidadeTrabalho);

            if (repCargaOcorrenciaDocumento.ExisteOcorrenciaPendenteEmissaoPorCTeImportado(conhecimento.Codigo))
                return $"Existe uma ocorrência pendente de emissão para o CT-e ({conhecimento.Chave}), não sendo possível importar o cancelamento.";

            XmlSerializer serializer = new XmlSerializer(typeof(MultiSoftware.CTe.v200.Eventos.Cancelamento.evCancCTe));
            byte[] data = Encoding.Default.GetBytes(procEvento.eventoCTe.infEvento.detEvento.Any.OuterXml);

            using (System.IO.MemoryStream memStream = new System.IO.MemoryStream(data, 0, data.Length))
            {
                MultiSoftware.CTe.v200.Eventos.Cancelamento.evCancCTe evCancCTe = (MultiSoftware.CTe.v200.Eventos.Cancelamento.evCancCTe)serializer.Deserialize(memStream);
                conhecimento.ObservacaoCancelamento = evCancCTe.xJust;
            }

            DateTime dataEvento;
            DateTime.TryParseExact(procEvento.retEventoCTe.infEvento.dhRegEvento, "yyyy-MM-ddTHH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataEvento);

            conhecimento.Cancelado = "S";
            conhecimento.Status = "C";
            conhecimento.ProtocoloCancelamentoInutilizacao = procEvento.retEventoCTe.infEvento.nProt;
            conhecimento.Log += string.Concat(" / CT-e de cancelamento importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");
            conhecimento.DataRetornoSefaz = dataEvento;
            conhecimento.DataCancelamento = dataEvento;
            conhecimento.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(procEvento.retEventoCTe.infEvento.xMotivo);

            repCTe.Atualizar(conhecimento);

            Dominio.Entidades.XMLCTe xmlCTe = repXMLCTe.BuscarPorCTe(conhecimento.Codigo, Dominio.Enumeradores.TipoXMLCTe.Cancelamento);

            if (xmlCTe == null)
            {
                using (StreamReader reader = new StreamReader(xml))
                {
                    xml.Position = 0;

                    xmlCTe = new Dominio.Entidades.XMLCTe
                    {
                        CTe = conhecimento,
                        Tipo = Dominio.Enumeradores.TipoXMLCTe.Cancelamento,
                        XML = reader.ReadToEnd(),
                        XMLArmazenadoEmArquivo = false
                    };

                    repXMLCTe.Inserir(xmlCTe);
                }
            }


            Dominio.Entidades.IntegracaoCTeRecebimento integracaoCTeRecebimento = new Dominio.Entidades.IntegracaoCTeRecebimento
            {
                CTe = conhecimento,
                Data = DateTime.Now,
                DataStatus = DateTime.Now,
                Status = Dominio.Enumeradores.StatusIntegracaoRecebimentoCTe.Aprovado,
                Tipo = Dominio.Enumeradores.TipoIntegracaoEnvioCTe.Cancelamento
            };

            repIntegracaoCTeRecebimento.Inserir(integracaoCTeRecebimento);

            if (enviarParaOracle)
                this.TransmitirCancelamentoCTeAnterior(conhecimento.Empresa, conhecimento, xml, unidadeTrabalho);

            return "";
        }

        public string CancelarConhencimentoImportado(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.Eventos.TProcEvento procEvento, Stream xml, Repositorio.UnitOfWork unidadeTrabalho, bool enviarParaOracle = true)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);
            Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeTrabalho);
            Repositorio.IntegracaoCTeRecebimento repIntegracaoCTeRecebimento = new Repositorio.IntegracaoCTeRecebimento(unidadeTrabalho);
            Repositorio.Embarcador.Ocorrencias.CargaOcorrenciaDocumento repCargaOcorrenciaDocumento = new Repositorio.Embarcador.Ocorrencias.CargaOcorrenciaDocumento(unidadeTrabalho);

            if (conhecimento == null)
                return string.Concat("CT-e (", procEvento.retEventoCTe.infEvento.chCTe, ") não encontrado.");

            if (repCargaOcorrenciaDocumento.ExisteOcorrenciaPendenteEmissaoPorCTeImportado(conhecimento.Codigo))
                return $"Existe uma ocorrência pendente de emissão para o CT-e ({conhecimento.Chave}), não sendo possível importar o cancelamento.";

            XmlSerializer serializer = new XmlSerializer(typeof(MultiSoftware.CTe.v300.Eventos.Cancelamento.evCancCTe));
            byte[] data = Encoding.Default.GetBytes(procEvento.eventoCTe.infEvento.detEvento.Any.OuterXml);

            try
            {
                using (System.IO.MemoryStream memStream = new System.IO.MemoryStream(data, 0, data.Length))
                {
                    MultiSoftware.CTe.v300.Eventos.Cancelamento.evCancCTe evCancCTe = (MultiSoftware.CTe.v300.Eventos.Cancelamento.evCancCTe)serializer.Deserialize(memStream);

                    conhecimento.ObservacaoCancelamento = evCancCTe.xJust;
                }
            }
            catch
            {
                data = Encoding.Default.GetBytes(Utilidades.String.RemoveDiacritics(procEvento.eventoCTe.infEvento.detEvento.Any.OuterXml));
                using (System.IO.MemoryStream memStream = new System.IO.MemoryStream(data, 0, data.Length))
                {
                    MultiSoftware.CTe.v300.Eventos.Cancelamento.evCancCTe evCancCTe = (MultiSoftware.CTe.v300.Eventos.Cancelamento.evCancCTe)serializer.Deserialize(memStream);

                    conhecimento.ObservacaoCancelamento = evCancCTe.xJust;
                }
            }

            string dateFormat = "yyyy-MM-ddTHH:mm:ss" + (procEvento.retEventoCTe.infEvento.dhRegEvento.Length > 19 ? "zzz" : "");
            DateTime.TryParseExact(procEvento.retEventoCTe.infEvento.dhRegEvento, dateFormat, null, System.Globalization.DateTimeStyles.None, out DateTime dataEvento);

            conhecimento.Cancelado = "S";
            conhecimento.Status = "C";
            conhecimento.ProtocoloCancelamentoInutilizacao = procEvento.retEventoCTe.infEvento.nProt;
            conhecimento.Log += string.Concat(" / CT-e de cancelamento importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");
            conhecimento.DataRetornoSefaz = dataEvento;
            conhecimento.DataCancelamento = dataEvento;
            conhecimento.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(procEvento.retEventoCTe.infEvento.xMotivo);

            repCTe.Atualizar(conhecimento);

            Dominio.Entidades.XMLCTe xmlCTe = repXMLCTe.BuscarPorCTe(conhecimento.Codigo, Dominio.Enumeradores.TipoXMLCTe.Cancelamento);

            if (xmlCTe == null)
            {
                using (StreamReader reader = new StreamReader(xml))
                {
                    xml.Position = 0;

                    xmlCTe = new Dominio.Entidades.XMLCTe()
                    {
                        CTe = conhecimento,
                        Tipo = Dominio.Enumeradores.TipoXMLCTe.Cancelamento,
                        XML = reader.ReadToEnd()
                    };

                    repXMLCTe.Inserir(xmlCTe);
                }
            }

            Dominio.Entidades.IntegracaoCTeRecebimento integracaoCTeRecebimento = new Dominio.Entidades.IntegracaoCTeRecebimento()
            {
                CTe = conhecimento,
                Data = DateTime.Now,
                DataStatus = DateTime.Now,
                Status = Dominio.Enumeradores.StatusIntegracaoRecebimentoCTe.Aprovado,
                Tipo = Dominio.Enumeradores.TipoIntegracaoEnvioCTe.Cancelamento
            };

            repIntegracaoCTeRecebimento.Inserir(integracaoCTeRecebimento);

            if (enviarParaOracle)
                this.TransmitirCancelamentoCTeAnterior(conhecimento.Empresa, conhecimento, xml, unidadeTrabalho);

            return "";
        }

        public string CancelarConhencimentoImportado(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.Eventos.TProcEvento procEvento, Stream xml, Repositorio.UnitOfWork unidadeTrabalho, bool enviarParaOracle = true)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);
            Repositorio.XMLCTe repXMLCTe = new Repositorio.XMLCTe(unidadeTrabalho);
            Repositorio.IntegracaoCTeRecebimento repIntegracaoCTeRecebimento = new Repositorio.IntegracaoCTeRecebimento(unidadeTrabalho);
            Repositorio.Embarcador.Ocorrencias.CargaOcorrenciaDocumento repCargaOcorrenciaDocumento = new Repositorio.Embarcador.Ocorrencias.CargaOcorrenciaDocumento(unidadeTrabalho);

            if (conhecimento == null)
                return string.Concat("CT-e (", procEvento.retEventoCTe.infEvento.chCTe, ") não encontrado.");

            if (repCargaOcorrenciaDocumento.ExisteOcorrenciaPendenteEmissaoPorCTeImportado(conhecimento.Codigo))
                return $"Existe uma ocorrência pendente de emissão para o CT-e ({conhecimento.Chave}), não sendo possível importar o cancelamento.";

            XmlSerializer serializer = new XmlSerializer(typeof(MultiSoftware.CTe.v400.Eventos.Cancelamento.evCancCTe));
            byte[] data = Encoding.Default.GetBytes(procEvento.eventoCTe.infEvento.detEvento.Any.OuterXml);

            try
            {
                using (System.IO.MemoryStream memStream = new System.IO.MemoryStream(data, 0, data.Length))
                {
                    MultiSoftware.CTe.v400.Eventos.Cancelamento.evCancCTe evCancCTe = (MultiSoftware.CTe.v400.Eventos.Cancelamento.evCancCTe)serializer.Deserialize(memStream);

                    conhecimento.ObservacaoCancelamento = evCancCTe.xJust;
                }
            }
            catch
            {
                data = Encoding.Default.GetBytes(Utilidades.String.RemoveDiacritics(procEvento.eventoCTe.infEvento.detEvento.Any.OuterXml));
                using (System.IO.MemoryStream memStream = new System.IO.MemoryStream(data, 0, data.Length))
                {
                    MultiSoftware.CTe.v400.Eventos.Cancelamento.evCancCTe evCancCTe = (MultiSoftware.CTe.v400.Eventos.Cancelamento.evCancCTe)serializer.Deserialize(memStream);

                    conhecimento.ObservacaoCancelamento = evCancCTe.xJust;
                }
            }

            string dateFormat = "yyyy-MM-ddTHH:mm:ss" + (procEvento.retEventoCTe.infEvento.dhRegEvento.Length > 19 ? "zzz" : "");
            DateTime.TryParseExact(procEvento.retEventoCTe.infEvento.dhRegEvento, dateFormat, null, System.Globalization.DateTimeStyles.None, out DateTime dataEvento);

            conhecimento.Cancelado = "S";
            conhecimento.Status = "C";
            conhecimento.ProtocoloCancelamentoInutilizacao = procEvento.retEventoCTe.infEvento.nProt;
            conhecimento.Log += string.Concat(" / CT-e de cancelamento importado com sucesso em ", DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss"), ".");
            conhecimento.DataRetornoSefaz = dataEvento;
            conhecimento.DataCancelamento = dataEvento;
            conhecimento.MensagemRetornoSefaz = Utilidades.String.ReplaceInvalidCharacters(procEvento.retEventoCTe.infEvento.xMotivo);

            repCTe.Atualizar(conhecimento);

            Dominio.Entidades.XMLCTe xmlCTe = repXMLCTe.BuscarPorCTe(conhecimento.Codigo, Dominio.Enumeradores.TipoXMLCTe.Cancelamento);

            if (xmlCTe == null)
            {
                using (StreamReader reader = new StreamReader(xml))
                {
                    xml.Position = 0;

                    xmlCTe = new Dominio.Entidades.XMLCTe()
                    {
                        CTe = conhecimento,
                        Tipo = Dominio.Enumeradores.TipoXMLCTe.Cancelamento,
                        XML = reader.ReadToEnd()
                    };

                    repXMLCTe.Inserir(xmlCTe);
                }
            }

            Dominio.Entidades.IntegracaoCTeRecebimento integracaoCTeRecebimento = new Dominio.Entidades.IntegracaoCTeRecebimento()
            {
                CTe = conhecimento,
                Data = DateTime.Now,
                DataStatus = DateTime.Now,
                Status = Dominio.Enumeradores.StatusIntegracaoRecebimentoCTe.Aprovado,
                Tipo = Dominio.Enumeradores.TipoIntegracaoEnvioCTe.Cancelamento
            };

            repIntegracaoCTeRecebimento.Inserir(integracaoCTeRecebimento);

            if (enviarParaOracle)
                this.TransmitirCancelamentoCTeAnterior(conhecimento.Empresa, conhecimento, xml, unidadeTrabalho);

            return "";
        }

        public void SalvarArquivoEmTxt(string pasta, string nome, string conteudo)
        {
            try
            {
                System.DateTime dt = DateTime.Now;
                string file = nome + ".txt";

                pasta = Utilidades.IO.FileStorageService.Storage.Combine(pasta, file);

                Utilidades.IO.FileStorageService.Storage.WriteLine(pasta, conteudo);
            }
            catch
            {
            }
        }

        private object GerarCTeAnteriorEventoCancelamento(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v200.Eventos.TProcEvento procEvento, Stream xml, Repositorio.UnitOfWork unidadeTrabalho, bool utilizarEmpresaDoCTe = false)
        {
            if (procEvento.retEventoCTe.infEvento.cStat != "135")
            {
                unidadeTrabalho.Rollback();
                return string.Concat("O status (", procEvento.retEventoCTe.infEvento.cStat, " - ", Utilidades.String.Left(procEvento.retEventoCTe.infEvento.xMotivo, 60), ") do CT-e (", procEvento.retEventoCTe.infEvento.chCTe, ") é inválido para a importação.");
            }

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = null;

            if (!utilizarEmpresaDoCTe)
                conhecimento = repCTe.BuscarPorChave(empresa.Codigo, procEvento.retEventoCTe.infEvento.chCTe);
            else
                conhecimento = repCTe.BuscarPorChave(procEvento.retEventoCTe.infEvento.chCTe);

            string retorno = CancelarConhencimentoImportado(conhecimento, procEvento, xml, unidadeTrabalho);

            if (!string.IsNullOrWhiteSpace(retorno))
            {
                unidadeTrabalho.Rollback();
                return retorno;
            }

            unidadeTrabalho.CommitChanges();

            return conhecimento;
        }

        private object GerarCTeAnteriorEventoCancelamento(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v300.Eventos.TProcEvento procEvento, Stream xml, Repositorio.UnitOfWork unidadeTrabalho, bool utilizarEmpresaDoCTe = false, bool importarCTeOracle = false)
        {
            if (procEvento.retEventoCTe.infEvento.cStat != "135")
            {
                unidadeTrabalho.Rollback();
                return string.Concat("O status (", procEvento.retEventoCTe.infEvento.cStat, " - ", Utilidades.String.Left(procEvento.retEventoCTe.infEvento.xMotivo, 60), ") do CT-e (", procEvento.retEventoCTe.infEvento.chCTe, ") é inválido para a importação.");
            }

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = null;

            if (!utilizarEmpresaDoCTe)
                conhecimento = repCTe.BuscarPorChave(empresa.Codigo, procEvento.retEventoCTe.infEvento.chCTe);
            else
                conhecimento = repCTe.BuscarPorChave(procEvento.retEventoCTe.infEvento.chCTe);

            string retorno = CancelarConhencimentoImportado(conhecimento, procEvento, xml, unidadeTrabalho);

            if (!string.IsNullOrWhiteSpace(retorno))
            {
                unidadeTrabalho.Rollback();
                return retorno;
            }

            unidadeTrabalho.CommitChanges();

            if (importarCTeOracle)
            {
                Servicos.CTe svCTe = new Servicos.CTe(unidadeTrabalho);
                svCTe.IntegrareCTeCanceladoOracle(null, conhecimento.Codigo, unidadeTrabalho);
            }

            return conhecimento;
        }

        private object GerarCTeAnteriorEventoCancelamento(Dominio.Entidades.Empresa empresa, MultiSoftware.CTe.v400.Eventos.TProcEvento procEvento, Stream xml, Repositorio.UnitOfWork unidadeTrabalho, bool utilizarEmpresaDoCTe = false, bool importarCTeOracle = false)
        {
            if (procEvento.retEventoCTe.infEvento.cStat != "135")
            {
                unidadeTrabalho.Rollback();
                return string.Concat("O status (", procEvento.retEventoCTe.infEvento.cStat, " - ", Utilidades.String.Left(procEvento.retEventoCTe.infEvento.xMotivo, 60), ") do CT-e (", procEvento.retEventoCTe.infEvento.chCTe, ") é inválido para a importação.");
            }

            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeTrabalho);

            Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento = null;

            if (!utilizarEmpresaDoCTe)
                conhecimento = repCTe.BuscarPorChave(empresa.Codigo, procEvento.retEventoCTe.infEvento.chCTe);
            else
                conhecimento = repCTe.BuscarPorChave(procEvento.retEventoCTe.infEvento.chCTe);

            string retorno = CancelarConhencimentoImportado(conhecimento, procEvento, xml, unidadeTrabalho);

            if (!string.IsNullOrWhiteSpace(retorno))
            {
                unidadeTrabalho.Rollback();
                return retorno;
            }

            unidadeTrabalho.CommitChanges();

            if (importarCTeOracle)
            {
                Servicos.CTe svCTe = new Servicos.CTe(unidadeTrabalho);
                svCTe.IntegrareCTeCanceladoOracle(null, conhecimento.Codigo, unidadeTrabalho);
            }

            return conhecimento;
        }

        private void ObterInformacoesComplementares(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteCompl infCTeCompl, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTeCompl != null)
            {
                conhecimento.CaracteristicaServico = infCTeCompl.xCaracSer;
                conhecimento.CaracteristicaTransporte = infCTeCompl.xCaracAd;
                conhecimento.ObservacoesGerais = infCTeCompl.xObs;
                this.SalvarObservacoesContribuinte(conhecimento, infCTeCompl.ObsCont, unidadeTrabalho);
                this.SalvarObservacoesFisco(conhecimento, infCTeCompl.ObsFisco, unidadeTrabalho);
            }
        }

        private void ObterInformacoesComplementares(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteCompl infCTeCompl, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTeCompl != null)
            {
                conhecimento.CaracteristicaServico = infCTeCompl.xCaracSer;
                conhecimento.CaracteristicaTransporte = infCTeCompl.xCaracAd;
                conhecimento.ObservacoesGerais = infCTeCompl.xObs;
                this.SalvarObservacoesContribuinte(conhecimento, infCTeCompl.ObsCont, unidadeTrabalho);
                this.SalvarObservacoesFisco(conhecimento, infCTeCompl.ObsFisco, unidadeTrabalho);
            }
        }

        private void ObterInformacoesComplementares(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteCompl infCTeCompl, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTeCompl != null)
            {
                conhecimento.CaracteristicaServico = infCTeCompl.xCaracSer;
                conhecimento.CaracteristicaTransporte = infCTeCompl.xCaracAd;
                conhecimento.ObservacoesGerais = infCTeCompl.xObs;
                this.SalvarObservacoesContribuinte(conhecimento, infCTeCompl.ObsCont, unidadeTrabalho);
                this.SalvarObservacoesFisco(conhecimento, infCTeCompl.ObsFisco, unidadeTrabalho);
            }
        }

        private void ObterInformacoesComplementares(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteCompl infCTeCompl, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTeCompl != null)
            {
                conhecimento.CaracteristicaServico = infCTeCompl.xCaracSer;
                conhecimento.CaracteristicaTransporte = infCTeCompl.xCaracAd;
                conhecimento.ObservacoesGerais = infCTeCompl.xObs;
                this.SalvarObservacoesContribuinte(conhecimento, infCTeCompl.ObsCont, unidadeTrabalho);
                this.SalvarObservacoesFisco(conhecimento, infCTeCompl.ObsFisco, unidadeTrabalho);
            }
        }

        private void ObterInformacoesComplementares(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteCompl infCTeCompl, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTeCompl != null)
            {
                conhecimento.CaracteristicaServico = infCTeCompl.xCaracSer;
                conhecimento.CaracteristicaTransporte = infCTeCompl.xCaracAd;
                conhecimento.ObservacoesGerais = infCTeCompl.xObs;
                this.SalvarObservacoesContribuinte(conhecimento, infCTeCompl.ObsCont, unidadeTrabalho);
                this.SalvarObservacoesFisco(conhecimento, infCTeCompl.ObsFisco, unidadeTrabalho);
            }
        }

        private void ObterInformacoesComplementares(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCteCompl infCTeCompl, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTeCompl != null)
            {
                conhecimento.CaracteristicaServico = infCTeCompl.xCaracSer;
                conhecimento.CaracteristicaTransporte = infCTeCompl.xCaracAd;
                conhecimento.ObservacoesGerais = infCTeCompl.xObs;
            }
        }

        private void ObterInformacoesComplementares(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCteCompl infCTeCompl, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTeCompl != null)
            {
                conhecimento.CaracteristicaServico = infCTeCompl.xCaracSer;
                conhecimento.CaracteristicaTransporte = infCTeCompl.xCaracAd;
                conhecimento.ObservacoesGerais = infCTeCompl.xObs;
            }
        }

        private void ObterInformacoesComplementares(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.Envio.TCTeInfCteCompl infCTeCompl, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTeCompl != null)
            {
                conhecimento.CaracteristicaServico = infCTeCompl.xCaracSer;
                conhecimento.CaracteristicaTransporte = infCTeCompl.xCaracAd;
                conhecimento.ObservacoesGerais = infCTeCompl.xObs;
                this.SalvarObservacoesContribuinte(conhecimento, infCTeCompl.ObsCont, unidadeTrabalho);
                this.SalvarObservacoesFisco(conhecimento, infCTeCompl.ObsFisco, unidadeTrabalho);
            }
        }

        private void SalvarObservacoesContribuinte(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteComplObsCont[] infObsCont, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infObsCont != null)
            {
                Repositorio.ObservacaoContribuinteCTE repObsContribuinte = new Repositorio.ObservacaoContribuinteCTE(unidadeTrabalho);
                foreach (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteComplObsCont obs in infObsCont)
                {
                    Dominio.Entidades.ObservacaoContribuinteCTE observacao = new Dominio.Entidades.ObservacaoContribuinteCTE();
                    observacao.CTE = conhecimento;
                    observacao.Descricao = obs.xTexto;
                    observacao.Identificador = obs.xCampo;
                    repObsContribuinte.Inserir(observacao);
                }
            }
        }

        private void SalvarObservacoesContribuinte(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteComplObsCont[] infObsCont, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infObsCont != null)
            {
                Repositorio.ObservacaoContribuinteCTE repObsContribuinte = new Repositorio.ObservacaoContribuinteCTE(unidadeTrabalho);
                foreach (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteComplObsCont obs in infObsCont)
                {
                    Dominio.Entidades.ObservacaoContribuinteCTE observacao = new Dominio.Entidades.ObservacaoContribuinteCTE();
                    observacao.CTE = conhecimento;
                    observacao.Descricao = obs.xTexto;
                    observacao.Identificador = obs.xCampo;
                    repObsContribuinte.Inserir(observacao);
                }
            }
        }

        private void SalvarObservacoesContribuinte(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteComplObsCont[] infObsCont, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infObsCont != null)
            {
                Repositorio.ObservacaoContribuinteCTE repObsContribuinte = new Repositorio.ObservacaoContribuinteCTE(unidadeTrabalho);
                foreach (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteComplObsCont obs in infObsCont)
                {
                    Dominio.Entidades.ObservacaoContribuinteCTE observacao = new Dominio.Entidades.ObservacaoContribuinteCTE();
                    observacao.CTE = conhecimento;
                    observacao.Descricao = obs.xTexto;
                    observacao.Identificador = obs.xCampo;
                    repObsContribuinte.Inserir(observacao);
                }
            }
        }

        private void SalvarObservacoesContribuinte(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteComplObsCont[] infObsCont, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infObsCont != null)
            {
                Repositorio.ObservacaoContribuinteCTE repObsContribuinte = new Repositorio.ObservacaoContribuinteCTE(unidadeTrabalho);
                foreach (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteComplObsCont obs in infObsCont)
                {
                    Dominio.Entidades.ObservacaoContribuinteCTE observacao = new Dominio.Entidades.ObservacaoContribuinteCTE();
                    observacao.CTE = conhecimento;
                    observacao.Descricao = obs.xTexto;
                    observacao.Identificador = obs.xCampo;
                    repObsContribuinte.Inserir(observacao);
                }
            }
        }

        private void SalvarObservacoesContribuinte(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteComplObsCont[] infObsCont, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infObsCont != null)
            {
                Repositorio.ObservacaoContribuinteCTE repObsContribuinte = new Repositorio.ObservacaoContribuinteCTE(unidadeTrabalho);
                foreach (MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteComplObsCont obs in infObsCont)
                {
                    Dominio.Entidades.ObservacaoContribuinteCTE observacao = new Dominio.Entidades.ObservacaoContribuinteCTE();
                    observacao.CTE = conhecimento;
                    observacao.Descricao = obs.xTexto;
                    observacao.Identificador = obs.xCampo;
                    repObsContribuinte.Inserir(observacao);
                }
            }
        }

        private void SalvarObservacoesContribuinte(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.Envio.TCTeInfCteComplObsCont[] infObsCont, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infObsCont != null)
            {
                Repositorio.ObservacaoContribuinteCTE repObsContribuinte = new Repositorio.ObservacaoContribuinteCTE(unidadeTrabalho);
                foreach (MultiSoftware.CTe.v200.Envio.TCTeInfCteComplObsCont obs in infObsCont)
                {
                    Dominio.Entidades.ObservacaoContribuinteCTE observacao = new Dominio.Entidades.ObservacaoContribuinteCTE();
                    observacao.CTE = conhecimento;
                    observacao.Descricao = obs.xTexto;
                    observacao.Identificador = obs.xCampo;
                    repObsContribuinte.Inserir(observacao);
                }
            }
        }

        private void SalvarObservacoesFisco(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.Envio.TCTeInfCteComplObsFisco[] infObsFisco, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infObsFisco != null)
            {
                Repositorio.ObservacaoFiscoCTE repObsFisco = new Repositorio.ObservacaoFiscoCTE(unidadeTrabalho);
                foreach (MultiSoftware.CTe.v200.Envio.TCTeInfCteComplObsFisco obs in infObsFisco)
                {
                    Dominio.Entidades.ObservacaoFiscoCTE observacao = new Dominio.Entidades.ObservacaoFiscoCTE();
                    observacao.CTE = conhecimento;
                    observacao.Descricao = obs.xTexto;
                    observacao.Identificador = obs.xCampo;
                    repObsFisco.Inserir(observacao);
                }

            }
        }

        private void SalvarObservacoesFisco(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteComplObsFisco[] infObsFisco, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infObsFisco != null)
            {
                Repositorio.ObservacaoFiscoCTE repObsFisco = new Repositorio.ObservacaoFiscoCTE(unidadeTrabalho);
                foreach (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteComplObsFisco obs in infObsFisco)
                {
                    Dominio.Entidades.ObservacaoFiscoCTE observacao = new Dominio.Entidades.ObservacaoFiscoCTE();
                    observacao.CTE = conhecimento;
                    observacao.Descricao = obs.xTexto;
                    observacao.Identificador = obs.xCampo;
                    repObsFisco.Inserir(observacao);
                }

            }
        }

        private void SalvarObservacoesFisco(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteComplObsFisco[] infObsFisco, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infObsFisco != null)
            {
                Repositorio.ObservacaoFiscoCTE repObsFisco = new Repositorio.ObservacaoFiscoCTE(unidadeTrabalho);
                foreach (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteComplObsFisco obs in infObsFisco)
                {
                    Dominio.Entidades.ObservacaoFiscoCTE observacao = new Dominio.Entidades.ObservacaoFiscoCTE();
                    observacao.CTE = conhecimento;
                    observacao.Descricao = obs.xTexto;
                    observacao.Identificador = obs.xCampo;
                    repObsFisco.Inserir(observacao);
                }
            }
        }

        private void SalvarObservacoesFisco(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteComplObsFisco[] infObsFisco, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infObsFisco != null)
            {
                Repositorio.ObservacaoFiscoCTE repObsFisco = new Repositorio.ObservacaoFiscoCTE(unidadeTrabalho);
                foreach (MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteComplObsFisco obs in infObsFisco)
                {
                    Dominio.Entidades.ObservacaoFiscoCTE observacao = new Dominio.Entidades.ObservacaoFiscoCTE();
                    observacao.CTE = conhecimento;
                    observacao.Descricao = obs.xTexto;
                    observacao.Identificador = obs.xCampo;
                    repObsFisco.Inserir(observacao);
                }

            }
        }

        private void SalvarObservacoesContribuinte(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.CTe.Observacao> observacoes, Repositorio.UnitOfWork unidadeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (observacoes != null)
            {
                Repositorio.ObservacaoContribuinteCTE repObsContribuinte = new Repositorio.ObservacaoContribuinteCTE(unidadeTrabalho);

                foreach (Dominio.ObjetosDeValor.CTe.Observacao obs in observacoes)
                {
                    Dominio.Entidades.ObservacaoContribuinteCTE observacao = new Dominio.Entidades.ObservacaoContribuinteCTE();
                    observacao.CTE = conhecimento;
                    observacao.Descricao = obs.Descricao;
                    observacao.Identificador = obs.Identificador;

                    repObsContribuinte.Inserir(observacao);
                }
            }

            string obsPadraoContribuinte = this.BuscarObservacaoPadrao(conhecimento, Dominio.Enumeradores.TipoObservacao.Contribuinte, conhecimento.LocalidadeInicioPrestacao.Estado.Sigla, conhecimento.LocalidadeTerminoPrestacao.Estado.Sigla, conhecimento.CST, conhecimento.ValorICMS, unidadeTrabalho, tipoServicoMultisoftware);
            if (!string.IsNullOrWhiteSpace(obsPadraoContribuinte))
            {
                Repositorio.ObservacaoContribuinteCTE repObsContribuinte = new Repositorio.ObservacaoContribuinteCTE(unidadeTrabalho);

                Dominio.Entidades.ObservacaoContribuinteCTE observacao = new Dominio.Entidades.ObservacaoContribuinteCTE();
                observacao.CTE = conhecimento;
                observacao.Descricao = obsPadraoContribuinte;
                observacao.Identificador = "ObsContAutomatica";

                repObsContribuinte.Inserir(observacao);
            }
        }

        private void SalvarObservacoesFisco(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteComplObsFisco[] infObsFisco, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infObsFisco != null)
            {
                Repositorio.ObservacaoFiscoCTE repObsFisco = new Repositorio.ObservacaoFiscoCTE(unidadeTrabalho);
                foreach (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteComplObsFisco obs in infObsFisco)
                {
                    Dominio.Entidades.ObservacaoFiscoCTE observacao = new Dominio.Entidades.ObservacaoFiscoCTE();
                    observacao.CTE = conhecimento;
                    observacao.Descricao = obs.xTexto;
                    observacao.Identificador = obs.xCampo;
                    repObsFisco.Inserir(observacao);
                }

            }
        }

        private void SalvarObservacoesFisco(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteComplObsFisco[] infObsFisco, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infObsFisco != null)
            {
                Repositorio.ObservacaoFiscoCTE repObsFisco = new Repositorio.ObservacaoFiscoCTE(unidadeTrabalho);
                foreach (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteComplObsFisco obs in infObsFisco)
                {
                    Dominio.Entidades.ObservacaoFiscoCTE observacao = new Dominio.Entidades.ObservacaoFiscoCTE();
                    observacao.CTE = conhecimento;
                    observacao.Descricao = obs.xTexto;
                    observacao.Identificador = obs.xCampo;
                    repObsFisco.Inserir(observacao);
                }

            }
        }

        private void SalvarObservacoesFisco(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.CTe.Observacao> observacoes, Repositorio.UnitOfWork unidadeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware = null)
        {
            if (observacoes != null)
            {
                Repositorio.ObservacaoFiscoCTE repObsFisco = new Repositorio.ObservacaoFiscoCTE(unidadeTrabalho);

                foreach (Dominio.ObjetosDeValor.CTe.Observacao obs in observacoes)
                {
                    Dominio.Entidades.ObservacaoFiscoCTE observacao = new Dominio.Entidades.ObservacaoFiscoCTE();
                    observacao.CTE = conhecimento;
                    observacao.Descricao = obs.Descricao;
                    observacao.Identificador = obs.Identificador;

                    repObsFisco.Inserir(observacao);
                }
            }

            string obsPadraoFisco = this.BuscarObservacaoPadrao(conhecimento, Dominio.Enumeradores.TipoObservacao.Fisco, conhecimento.LocalidadeInicioPrestacao.Estado.Sigla, conhecimento.LocalidadeTerminoPrestacao.Estado.Sigla, conhecimento.CST, conhecimento.ValorICMS, unidadeTrabalho, tipoServicoMultisoftware);
            if (!string.IsNullOrWhiteSpace(obsPadraoFisco))
            {
                Repositorio.ObservacaoContribuinteCTE repObsContribuinte = new Repositorio.ObservacaoContribuinteCTE(unidadeTrabalho);

                Dominio.Entidades.ObservacaoContribuinteCTE observacao = new Dominio.Entidades.ObservacaoContribuinteCTE();
                observacao.CTE = conhecimento;
                observacao.Descricao = obsPadraoFisco;
                observacao.Identificador = "ObsFiscoAutomatica";

                repObsContribuinte.Inserir(observacao);
            }
        }

        private void SalvarDadosSubstituicao(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (conhecimento.TipoCTE == TipoCTE.Substituto && !string.IsNullOrWhiteSpace(conhecimento.ChaveCTESubComp))
            {
                Repositorio.DocumentosAnulacaoCTE repDocAnulacaoCTe = new Repositorio.DocumentosAnulacaoCTE(unidadeTrabalho);

                Dominio.Entidades.DocumentosAnulacaoCTE documentoAnulacao = new Dominio.Entidades.DocumentosAnulacaoCTE();
                documentoAnulacao.CTE = conhecimento;
                documentoAnulacao.Tipo = Dominio.Enumeradores.TipoDocumentoAnulacao.CTe;
                documentoAnulacao.ContribuinteICMS = Dominio.Enumeradores.OpcaoSimNao.Nao;
                documentoAnulacao.Chave = conhecimento.ChaveCTESubComp;
                documentoAnulacao.ModeloDocumentoFiscal = conhecimento.ModeloDocumentoFiscal;
                repDocAnulacaoCTe.Inserir(documentoAnulacao);
            }
        }

        private void SalvarInformacoesRemetente(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteRem infRem, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infRem.Items != null)
            {
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumentoCTe = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModeloDocumento = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                foreach (object item in infRem.Items)
                {
                    Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();
                    Type tipoItem = item.GetType();
                    if (tipoItem == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteRemInfNF))
                    {
                        MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteRemInfNF nf = (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteRemInfNF)item;

                        documento.BaseCalculoICMS = decimal.Parse(nf.vBC, cultura);
                        documento.BaseCalculoICMSST = decimal.Parse(nf.vBCST, cultura);
                        documento.CFOP = nf.nCFOP;
                        documento.CTE = conhecimento;
                        documento.DataEmissao = DateTime.ParseExact(nf.dEmi, "yyyy-MM-dd", null);
                        string modelo = nf.mod.ToString("D");
                        documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo(modelo.Length == 1 ? string.Format("{0:00}", int.Parse(modelo)) : modelo);
                        documento.Numero = nf.nDoc;
                        documento.Peso = nf.nPeso != null ? decimal.Parse(nf.nPeso, cultura) : 0m;
                        documento.PINSuframa = nf.PIN;
                        documento.Serie = nf.serie;
                        documento.Valor = decimal.Parse(nf.vNF, cultura);
                        documento.ValorICMS = decimal.Parse(nf.vICMS, cultura);
                        documento.ValorICMSST = decimal.Parse(nf.vST, cultura);
                        documento.ValorProdutos = decimal.Parse(nf.vProd, cultura);
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumentoCTe.Inserir(documento);
                    }
                    else if (tipoItem == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteRemInfNFe))
                    {
                        MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteRemInfNFe nfe = (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteRemInfNFe)item;

                        documento.ChaveNFE = nfe.chave;
                        DateTime dataEmissao = new DateTime();
                        if (DateTime.TryParseExact(nfe.chave.Substring(2, 4), "yyMM", null, System.Globalization.DateTimeStyles.None, out dataEmissao))
                            documento.DataEmissao = dataEmissao;
                        else
                            documento.DataEmissao = DateTime.Now;
                        documento.Numero = int.Parse(nfe.chave.Substring(25, 9)).ToString();
                        documento.CTE = conhecimento;
                        documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo("55");
                        documento.PINSuframa = nfe.PIN;
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumentoCTe.Inserir(documento);
                    }
                    else if (tipoItem == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteRemInfOutros))
                    {
                        MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteRemInfOutros outros = (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteRemInfOutros)item;

                        documento.CTE = conhecimento;
                        if (outros.dEmi != null)
                            documento.DataEmissao = DateTime.ParseExact(outros.dEmi, "yyyy-MM-dd", null);
                        else
                            documento.DataEmissao = DateTime.Now;
                        documento.Descricao = outros.descOutros != null ? outros.descOutros : string.Empty;
                        documento.Numero = outros.nDoc != null ? outros.nDoc : string.Empty;
                        documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo(outros.tpDoc.ToString("D"));
                        documento.Valor = outros.vDocFisc != null ? decimal.Parse(outros.vDocFisc, cultura) : 0;
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumentoCTe.Inserir(documento);
                    }
                }
            }
        }

        private void SalvarInformacoesDocumentos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDoc infDoc, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infDoc != null)
            {
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumentoCTe = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModeloDocumento = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                foreach (object item in infDoc.Items)
                {
                    Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();
                    Type tipoItem = item.GetType();
                    if (tipoItem == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNF))
                    {
                        MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNF nf = (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNF)item;

                        documento.BaseCalculoICMS = decimal.Parse(nf.vBC, cultura);
                        documento.BaseCalculoICMSST = decimal.Parse(nf.vBCST, cultura);
                        documento.CFOP = nf.nCFOP;
                        documento.CTE = conhecimento;
                        documento.DataEmissao = DateTime.ParseExact(nf.dEmi, "yyyy-MM-dd", null);

                        string modelo = nf.mod.ToString("D");
                        documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo(modelo.Length == 1 ? string.Format("{0:00}", int.Parse(modelo)) : modelo);

                        documento.Numero = nf.nDoc;
                        documento.Peso = nf.nPeso != null ? decimal.Parse(nf.nPeso, cultura) : 0m;
                        documento.PINSuframa = nf.PIN;
                        documento.Serie = nf.serie;
                        documento.Valor = decimal.Parse(nf.vNF, cultura);
                        documento.ValorICMS = decimal.Parse(nf.vICMS, cultura);
                        documento.ValorICMSST = decimal.Parse(nf.vST, cultura);
                        documento.ValorProdutos = decimal.Parse(nf.vProd, cultura);
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumentoCTe.Inserir(documento);
                    }
                    else if (tipoItem == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNFe))
                    {
                        MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNFe nfe = (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNFe)item;

                        documento.ChaveNFE = nfe.chave;

                        DateTime dataEmissao = new DateTime();

                        if (DateTime.TryParseExact(nfe.chave.Substring(2, 4), "yyMM", null, System.Globalization.DateTimeStyles.None, out dataEmissao))
                            documento.DataEmissao = dataEmissao;
                        else
                            documento.DataEmissao = DateTime.Now;

                        documento.Numero = int.Parse(nfe.chave.Substring(25, 9)).ToString();
                        documento.Serie = int.Parse(nfe.chave.Substring(22, 3)).ToString();
                        documento.CTE = conhecimento;
                        documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo("55");
                        documento.PINSuframa = nfe.PIN;
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumentoCTe.Inserir(documento);
                    }
                    else if (tipoItem == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfOutros))
                    {
                        MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfOutros outros = (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfOutros)item;

                        documento.CTE = conhecimento;

                        if (outros.dEmi != null)
                            documento.DataEmissao = DateTime.ParseExact(outros.dEmi, "yyyy-MM-dd", null);
                        else
                            documento.DataEmissao = DateTime.Now;

                        documento.Descricao = outros.descOutros != null ? outros.descOutros : string.Empty;
                        documento.Numero = outros.nDoc != null ? outros.nDoc : string.Empty;
                        documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo(outros.tpDoc.ToString("D"));
                        documento.Valor = outros.vDocFisc != null ? decimal.Parse(outros.vDocFisc, cultura) : 0;
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumentoCTe.Inserir(documento);
                    }
                }
            }
        }

        private void SalvarInformacoesSubstituicao(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfCteSub infCTeSub, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeSub != null)
            {
                conhecimento.ChaveCTESubComp = infCTeSub.chCte;
            }
        }

        private void SalvarInformacoesSubstituicao(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfCteSub infCTeSub, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeSub != null)
            {
                conhecimento.ChaveCTESubComp = infCTeSub.chCte;
            }
        }

        private void SalvarInformacoesDocumentos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDoc infDoc, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infDoc != null)
            {
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumentoCTe = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModeloDocumento = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                foreach (object item in infDoc.Items)
                {
                    Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();
                    Type tipoItem = item.GetType();
                    if (tipoItem == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNF))
                    {
                        MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNF nf = (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNF)item;

                        documento.BaseCalculoICMS = decimal.Parse(nf.vBC, cultura);
                        documento.BaseCalculoICMSST = decimal.Parse(nf.vBCST, cultura);
                        documento.CFOP = nf.nCFOP;
                        documento.CTE = conhecimento;
                        documento.DataEmissao = DateTime.ParseExact(nf.dEmi, "yyyy-MM-dd", null);

                        string modelo = nf.mod.ToString("D");
                        documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo(modelo.Length == 1 ? string.Format("{0:00}", int.Parse(modelo)) : modelo);

                        documento.Numero = nf.nDoc;
                        documento.Peso = nf.nPeso != null ? decimal.Parse(nf.nPeso, cultura) : 0m;
                        documento.PINSuframa = nf.PIN;
                        documento.Serie = nf.serie;
                        documento.Valor = decimal.Parse(nf.vNF, cultura);
                        documento.ValorICMS = decimal.Parse(nf.vICMS, cultura);
                        documento.ValorICMSST = decimal.Parse(nf.vST, cultura);
                        documento.ValorProdutos = decimal.Parse(nf.vProd, cultura);
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumentoCTe.Inserir(documento);
                    }
                    else if (tipoItem == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNFe))
                    {
                        MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNFe nfe = (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNFe)item;

                        documento.ChaveNFE = nfe.chave;

                        DateTime dataEmissao = new DateTime();

                        if (DateTime.TryParseExact(nfe.chave.Substring(2, 4), "yyMM", null, System.Globalization.DateTimeStyles.None, out dataEmissao))
                            documento.DataEmissao = dataEmissao;
                        else
                            documento.DataEmissao = DateTime.Now;

                        documento.Numero = int.Parse(nfe.chave.Substring(25, 9)).ToString();
                        documento.Serie = int.Parse(nfe.chave.Substring(22, 3)).ToString();
                        documento.CTE = conhecimento;
                        documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo("55");
                        documento.PINSuframa = nfe.PIN;
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumentoCTe.Inserir(documento);
                    }
                    else if (tipoItem == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfOutros))
                    {
                        MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfOutros outros = (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfOutros)item;

                        documento.CTE = conhecimento;

                        if (outros.dEmi != null)
                            documento.DataEmissao = DateTime.ParseExact(outros.dEmi, "yyyy-MM-dd", null);
                        else
                            documento.DataEmissao = DateTime.Now;

                        documento.Descricao = outros.descOutros != null ? outros.descOutros : string.Empty;
                        documento.Numero = outros.nDoc != null ? outros.nDoc : string.Empty;
                        Dominio.Entidades.ModeloDocumentoFiscal modelo = repModeloDocumento.BuscarPorModelo(outros.tpDoc.ToString("D"));
                        if (modelo == null)
                            modelo = repModeloDocumento.BuscarPorModelo("99");
                        documento.ModeloDocumentoFiscal = modelo;
                        documento.Valor = outros.vDocFisc != null ? decimal.Parse(outros.vDocFisc, cultura) : 0;
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumentoCTe.Inserir(documento);
                    }
                }
            }
        }

        private void SalvarInformacoesDocumentos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDoc infDoc, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infDoc != null)
            {
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumentoCTe = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModeloDocumento = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                foreach (object item in infDoc.Items)
                {
                    Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();
                    Type tipoItem = item.GetType();
                    if (tipoItem == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNF))
                    {
                        MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNF nf = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNF)item;

                        documento.BaseCalculoICMS = decimal.Parse(nf.vBC, cultura);
                        documento.BaseCalculoICMSST = decimal.Parse(nf.vBCST, cultura);
                        documento.CFOP = nf.nCFOP;
                        documento.CTE = conhecimento;
                        documento.DataEmissao = DateTime.ParseExact(nf.dEmi, "yyyy-MM-dd", null);

                        string modelo = nf.mod.ToString("D");
                        documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo(modelo.Length == 1 ? string.Format("{0:00}", int.Parse(modelo)) : modelo);

                        documento.Numero = nf.nDoc;
                        documento.Peso = nf.nPeso != null ? decimal.Parse(nf.nPeso, cultura) : 0m;
                        documento.PINSuframa = nf.PIN;
                        documento.Serie = nf.serie;
                        documento.Valor = decimal.Parse(nf.vNF, cultura);
                        documento.ValorICMS = decimal.Parse(nf.vICMS, cultura);
                        documento.ValorICMSST = decimal.Parse(nf.vST, cultura);
                        documento.ValorProdutos = decimal.Parse(nf.vProd, cultura);
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumentoCTe.Inserir(documento);
                    }
                    else if (tipoItem == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNFe))
                    {
                        MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNFe nfe = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfNFe)item;

                        documento.ChaveNFE = nfe.chave;

                        DateTime dataEmissao = new DateTime();

                        if (DateTime.TryParseExact(nfe.chave.Substring(2, 4), "yyMM", null, System.Globalization.DateTimeStyles.None, out dataEmissao))
                            documento.DataEmissao = dataEmissao;
                        else
                            documento.DataEmissao = DateTime.Now;

                        documento.Numero = int.Parse(nfe.chave.Substring(25, 9)).ToString();
                        documento.Serie = int.Parse(nfe.chave.Substring(22, 3)).ToString();
                        documento.CTE = conhecimento;
                        documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo("55");
                        documento.PINSuframa = nfe.PIN;
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumentoCTe.Inserir(documento);
                    }
                    else if (tipoItem == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfOutros))
                    {
                        MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfOutros outros = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfDocInfOutros)item;

                        documento.CTE = conhecimento;

                        if (outros.dEmi != null)
                            documento.DataEmissao = DateTime.ParseExact(outros.dEmi, "yyyy-MM-dd", null);
                        else
                            documento.DataEmissao = DateTime.Now;

                        documento.Descricao = outros.descOutros != null ? outros.descOutros : string.Empty;
                        documento.Numero = !string.IsNullOrEmpty(outros.nDoc) ? Regex.Replace(outros.nDoc, @"\D", "") : string.Empty;

                        Dominio.Entidades.ModeloDocumentoFiscal modelo = repModeloDocumento.BuscarPorModelo(outros.tpDoc.ToString("D"));
                        if (modelo == null)
                            modelo = repModeloDocumento.BuscarPorModelo("99");
                        documento.ModeloDocumentoFiscal = modelo;
                        documento.Valor = outros.vDocFisc != null ? decimal.Parse(outros.vDocFisc, cultura) : 0;
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumentoCTe.Inserir(documento);
                    }
                }
            }
        }

        private void SalvarInformacoesDocumentos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCteInfCTeNormInfDocRef[] infDoc, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infDoc != null)
            {
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumentoCTe = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModeloDocumento = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                foreach (MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCteInfCTeNormInfDocRef item in infDoc)
                {
                    Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();

                    documento.CTE = conhecimento;
                    documento.DataEmissao = DateTime.ParseExact(item.dEmi, "yyyy-MM-dd", null);

                    documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo("01");

                    documento.Numero = item.nDoc;
                    documento.Peso = 0m;
                    documento.Serie = item.serie;
                    documento.Valor = decimal.Parse(item.vDoc, cultura);
                    if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                        documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                    repDocumentoCTe.Inserir(documento);
                }
            }
        }

        private void SalvarInformacoesDocumentos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCteInfCTeNormInfDocRef[] infDoc, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            throw new NotImplementedException("Método não implementado, precisa exemplo de CT-e para validar.");
            //if (infDoc != null)
            //{
            //    Repositorio.DocumentosCTE repDocumentoCTe = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
            //    Repositorio.ModeloDocumentoFiscal repModeloDocumento = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

            //    System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            //    foreach (var item in infDoc)
            //    {
            //        Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();

            //        documento.CTE = conhecimento;
            //        documento.DataEmissao = DateTime.ParseExact(item.dEmi, "yyyy-MM-dd", null);

            //        documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo("01");

            //        documento.Numero = item.nDoc;
            //        documento.Peso = 0m;
            //        documento.Serie = item.serie;
            //        documento.Valor = decimal.Parse(item.vDoc, cultura);

            //        repDocumentoCTe.Inserir(documento);
            //    }
            //}
        }

        private void SalvarInformacoesDocumentos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNormInfDoc infDoc, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infDoc != null)
            {
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumentoCTe = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModeloDocumento = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                foreach (object item in infDoc.Items)
                {
                    Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();
                    Type tipoItem = item.GetType();
                    if (tipoItem == typeof(MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNormInfDocInfNF))
                    {
                        MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNormInfDocInfNF nf = (MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNormInfDocInfNF)item;

                        documento.BaseCalculoICMS = decimal.Parse(nf.vBC, cultura);
                        documento.BaseCalculoICMSST = decimal.Parse(nf.vBCST, cultura);
                        documento.CFOP = nf.nCFOP;
                        documento.CTE = conhecimento;
                        documento.DataEmissao = DateTime.ParseExact(nf.dEmi, "yyyy-MM-dd", null);

                        string modelo = nf.mod.ToString("D");
                        documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo(modelo.Length == 1 ? string.Format("{0:00}", int.Parse(modelo)) : modelo);

                        documento.Numero = nf.nDoc;
                        documento.Peso = nf.nPeso != null ? decimal.Parse(nf.nPeso, cultura) : 0m;
                        documento.PINSuframa = nf.PIN;
                        documento.Serie = nf.serie;
                        documento.Valor = decimal.Parse(nf.vNF, cultura);
                        documento.ValorICMS = decimal.Parse(nf.vICMS, cultura);
                        documento.ValorICMSST = decimal.Parse(nf.vST, cultura);
                        documento.ValorProdutos = decimal.Parse(nf.vProd, cultura);
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumentoCTe.Inserir(documento);
                    }
                    else if (tipoItem == typeof(MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNormInfDocInfNFe))
                    {
                        MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNormInfDocInfNFe nfe = (MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNormInfDocInfNFe)item;

                        documento.ChaveNFE = nfe.chave;

                        DateTime dataEmissao = new DateTime();

                        if (DateTime.TryParseExact(nfe.chave.Substring(2, 4), "yyMM", null, System.Globalization.DateTimeStyles.None, out dataEmissao))
                            documento.DataEmissao = dataEmissao;
                        else
                            documento.DataEmissao = DateTime.Now;

                        documento.Numero = int.Parse(nfe.chave.Substring(25, 9)).ToString();
                        documento.Serie = int.Parse(nfe.chave.Substring(22, 3)).ToString();
                        documento.CTE = conhecimento;
                        documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo("55");
                        documento.PINSuframa = nfe.PIN;
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumentoCTe.Inserir(documento);
                    }
                    else if (tipoItem == typeof(MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNormInfDocInfOutros))
                    {
                        MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNormInfDocInfOutros outros = (MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNormInfDocInfOutros)item;

                        documento.CTE = conhecimento;

                        if (outros.dEmi != null)
                            documento.DataEmissao = DateTime.ParseExact(outros.dEmi, "yyyy-MM-dd", null);
                        else
                            documento.DataEmissao = DateTime.Now;

                        documento.Descricao = outros.descOutros != null ? outros.descOutros : string.Empty;
                        documento.Numero = outros.nDoc != null ? outros.nDoc : string.Empty;
                        documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo(outros.tpDoc.ToString("D"));
                        documento.Valor = outros.vDocFisc != null ? decimal.Parse(outros.vDocFisc, cultura) : 0;
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumentoCTe.Inserir(documento);
                    }
                }
            }
        }

        private void SalvarInformacoesEntregas(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteDet> infDet, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            decimal valorTotalAReceber = 0;
            decimal valorTotalPrestacaoServico = 0;

            if (infDet != null)
            {
                Repositorio.EntregaCTe repEntregaCTe = new Repositorio.EntregaCTe(unidadeDeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumentoCTe = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModeloDocumento = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);
                Repositorio.EntregaCTeDocumento repEntregaCTeDocumento = new Repositorio.EntregaCTeDocumento(unidadeDeTrabalho);
                Repositorio.EntregaCTeComponentePrestacao repEntregaCTeComponentePrestacao = new Repositorio.EntregaCTeComponentePrestacao(unidadeDeTrabalho);
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                foreach (MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteDet det in infDet)
                {
                    Dominio.Entidades.EntregaCTe entregaCTe = new Dominio.Entidades.EntregaCTe();
                    entregaCTe.CTE = conhecimento;
                    entregaCTe.Origem = repLocalidade.BuscarPorCodigoIBGE(int.Parse(det.cMunIni));
                    entregaCTe.Destino = repLocalidade.BuscarPorCodigoIBGE(int.Parse(det.cMunFim));
                    entregaCTe.ValorFrete = decimal.Parse(det.vPrest, cultura);
                    entregaCTe.ValorPrestacaoServico = decimal.Parse(det.vPrest, cultura);
                    entregaCTe.ValorAReceber = decimal.Parse(det.vRec, cultura);
                    repEntregaCTe.Inserir(entregaCTe);

                    valorTotalAReceber += entregaCTe.ValorAReceber;
                    valorTotalPrestacaoServico += entregaCTe.ValorPrestacaoServico;

                    foreach (object item in det.Items)
                    {
                        Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();
                        Type tipoItem = item.GetType();
                        if (tipoItem == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteDetInfNFe))
                        {
                            MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteDetInfNFe nfe = (MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteDetInfNFe)item;

                            documento.ChaveNFE = nfe.chNFe;

                            DateTime dataEmissao = new DateTime();

                            if (DateTime.TryParseExact(nfe.chNFe.Substring(2, 4), "yyMM", null, System.Globalization.DateTimeStyles.None, out dataEmissao))
                                documento.DataEmissao = dataEmissao;
                            else
                                documento.DataEmissao = DateTime.Now;

                            documento.Numero = int.Parse(nfe.chNFe.Substring(25, 9)).ToString();
                            documento.Serie = int.Parse(nfe.chNFe.Substring(22, 3)).ToString();
                            documento.CTE = conhecimento;
                            documento.ModeloDocumentoFiscal = repModeloDocumento.BuscarPorModelo("55");
                            documento.PINSuframa = nfe.PIN;
                            if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                                documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                            repDocumentoCTe.Inserir(documento);

                            Dominio.Entidades.EntregaCTeDocumento entregaCTeDocumento = new Dominio.Entidades.EntregaCTeDocumento();
                            entregaCTeDocumento.EntregaCTe = entregaCTe;
                            entregaCTeDocumento.DocumentosCTE = documento;
                            repEntregaCTeDocumento.Inserir(entregaCTeDocumento);
                        }
                        else if (tipoItem == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteDetInfDocAnt))
                        {
                            throw new Exception("Processo não homologado.");
                        }
                    }

                    if (det.Comp != null)
                    {
                        foreach (MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteDetComp comp in det.Comp)
                        {
                            if (!comp.xNome.ToUpper().Contains("VALOR FRETE") && !comp.xNome.ToUpper().Contains("FRETE VALOR") && !comp.xNome.ToUpper().Contains("IMPOSTOS"))
                            {
                                Dominio.Entidades.EntregaCTeComponentePrestacao entregaCTeCompPrest = new Dominio.Entidades.EntregaCTeComponentePrestacao();
                                entregaCTeCompPrest.EntregaCTe = entregaCTe;
                                entregaCTeCompPrest.NomeCTe = comp.xNome;
                                entregaCTeCompPrest.Valor = Math.Round(decimal.Parse(comp.vComp, cultura), 2, MidpointRounding.ToEven);
                                entregaCTeCompPrest.IncluiNaBaseDeCalculoDoICMS = false;
                                entregaCTeCompPrest.IncluiNoTotalAReceber = false;
                                repEntregaCTeComponentePrestacao.Inserir(entregaCTeCompPrest);
                            }
                        }
                    }

                    Dominio.Entidades.EntregaCTeComponentePrestacao entregaCTeCompPrestFrete = new Dominio.Entidades.EntregaCTeComponentePrestacao();
                    entregaCTeCompPrestFrete.EntregaCTe = entregaCTe;
                    entregaCTeCompPrestFrete.NomeCTe = "FRETE VALOR";
                    entregaCTeCompPrestFrete.Valor = entregaCTe.ValorFrete;
                    entregaCTeCompPrestFrete.IncluiNaBaseDeCalculoDoICMS = false;
                    entregaCTeCompPrestFrete.IncluiNoTotalAReceber = true;
                    repEntregaCTeComponentePrestacao.Inserir(entregaCTeCompPrestFrete);
                }
            }

            conhecimento.ValorAReceber = valorTotalAReceber;
            conhecimento.ValorPrestacaoServico = valorTotalPrestacaoServico;
        }

        private void ObterInformacoesTomador(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteIde infCTeIde, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTeIde.Item != null)
            {
                Type tipoTomador = infCTeIde.Item.GetType();
                if (tipoTomador == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteIdeToma03))
                {
                    MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteIdeToma03 tomador = (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteIdeToma03)infCTeIde.Item;
                    conhecimento.TipoTomador = (Dominio.Enumeradores.TipoTomador)tomador.toma;
                }
                else if (tipoTomador == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteIdeToma4))
                {
                    MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteIdeToma4 tomador = (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteIdeToma4)infCTeIde.Item;
                    conhecimento.TipoTomador = (Dominio.Enumeradores.TipoTomador)tomador.toma;
                    this.SetarTomador(ref conhecimento, tomador, unidadeTrabalho);
                }
            }
        }

        private void ObterInformacoesTomador(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteIde infCTeIde, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTeIde.Item != null)
            {
                Type tipoTomador = infCTeIde.Item.GetType();
                if (tipoTomador == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteIdeToma03))
                {
                    MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteIdeToma03 tomador = (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteIdeToma03)infCTeIde.Item;
                    conhecimento.TipoTomador = (Dominio.Enumeradores.TipoTomador)tomador.toma;
                }
                else if (tipoTomador == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteIdeToma4))
                {
                    MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteIdeToma4 tomador = (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteIdeToma4)infCTeIde.Item;
                    conhecimento.TipoTomador = (Dominio.Enumeradores.TipoTomador)tomador.toma;
                    this.SetarTomador(ref conhecimento, tomador, unidadeTrabalho);
                }
            }
        }

        private bool ObterInformacoesTomador(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteIde infCTeIde, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infCTeIde.Item != null)
            {
                Type tipoTomador = infCTeIde.Item.GetType();
                if (tipoTomador == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteIdeToma3))
                {
                    MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteIdeToma3 tomador = (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteIdeToma3)infCTeIde.Item;
                    if (tomador.toma == MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteIdeToma3Toma.Item0)
                        conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Remetente;
                    else if (tomador.toma == MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteIdeToma3Toma.Item1)
                        conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Expedidor;
                    else if (tomador.toma == MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteIdeToma3Toma.Item2)
                        conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Recebedor;
                    else if (tomador.toma == MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteIdeToma3Toma.Item3)
                        conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Destinatario;
                }
                else if (tipoTomador == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteIdeToma4))
                {
                    MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteIdeToma4 tomador = (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteIdeToma4)infCTeIde.Item;
                    conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Outros;

                    if (!SetarTomador(ref conhecimento, tomador, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                        return false;
                }
            }

            erro = string.Empty;
            return true;
        }

        private bool ObterInformacoesTomador(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteIde infCTeIde, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infCTeIde.Item != null)
            {
                Type tipoTomador = infCTeIde.Item.GetType();
                if (tipoTomador == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteIdeToma3))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteIdeToma3 tomador = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteIdeToma3)infCTeIde.Item;
                    if (tomador.toma == MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteIdeToma3Toma.Item0)
                        conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Remetente;
                    else if (tomador.toma == MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteIdeToma3Toma.Item1)
                        conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Expedidor;
                    else if (tomador.toma == MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteIdeToma3Toma.Item2)
                        conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Recebedor;
                    else if (tomador.toma == MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteIdeToma3Toma.Item3)
                        conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Destinatario;
                }
                else if (tipoTomador == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteIdeToma4))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteIdeToma4 tomador = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteIdeToma4)infCTeIde.Item;
                    conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Outros;

                    if (!SetarTomador(ref conhecimento, tomador, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                        return false;
                }
            }

            erro = string.Empty;
            return true;
        }

        private bool ObterInformacoesTomador(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteToma infCTeToma, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {

            MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteTomaToma tomador = infCTeToma.toma;
            if (tomador == MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteTomaToma.Item0)
            {
                conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Remetente;

                if (!SetarRemetente(ref conhecimento, infCTeToma, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                    return false;
            }
            else if (tomador == MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteTomaToma.Item1)
            {
                conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Expedidor;

                if (!SetarExpedidor(ref conhecimento, infCTeToma, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                    return false;
            }
            else if (tomador == MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteTomaToma.Item2)
            {
                conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Recebedor;

                if (!SetarRecebedor(ref conhecimento, infCTeToma, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                    return false;
            }
            else if (tomador == MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteTomaToma.Item3)
            {
                conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Destinatario;

                if (!SetarDestinatario(ref conhecimento, infCTeToma, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                    return false;
            }
            else if (tomador == MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteTomaToma.Item4)
            {
                conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Outros;

                if (!SetarTomador(ref conhecimento, infCTeToma, unidadeTrabalho, out erro, tipoServicoMultisoftware))
                    return false;
            }

            erro = string.Empty;
            return true;
        }

        private void ObterInformacoesTomador(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCteIde infCTeIde, Repositorio.UnitOfWork unidadeTrabalho)
        {
            conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Remetente;
        }

        private void ObterInformacoesTomador(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCteIde infCTeIde, Repositorio.UnitOfWork unidadeTrabalho)
        {
            conhecimento.TipoTomador = Dominio.Enumeradores.TipoTomador.Remetente;
        }

        private void ObterInformacoesTomador(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.Envio.TCTeInfCteIde infCTeIde, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTeIde.Item != null)
            {
                Type tipoTomador = infCTeIde.Item.GetType();
                if (tipoTomador == typeof(MultiSoftware.CTe.v200.Envio.TCTeInfCteIdeToma03))
                {
                    MultiSoftware.CTe.v200.Envio.TCTeInfCteIdeToma03 tomador = (MultiSoftware.CTe.v200.Envio.TCTeInfCteIdeToma03)infCTeIde.Item;
                    conhecimento.TipoTomador = (Dominio.Enumeradores.TipoTomador)tomador.toma;
                }
                else if (tipoTomador == typeof(MultiSoftware.CTe.v200.Envio.TCTeInfCteIdeToma4))
                {
                    MultiSoftware.CTe.v200.Envio.TCTeInfCteIdeToma4 tomador = (MultiSoftware.CTe.v200.Envio.TCTeInfCteIdeToma4)infCTeIde.Item;
                    conhecimento.TipoTomador = (Dominio.Enumeradores.TipoTomador)tomador.toma;
                    this.SetarTomador(ref conhecimento, tomador, unidadeTrabalho);
                }
            }
        }

        private void SetarClienteCTeOS(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCteToma infToma, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infToma != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infToma.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente remetente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosremetente = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (remetente == null)
                    {
                        remetente = new Dominio.Entidades.Cliente();

                        remetente.CPF_CNPJ = cpfCnpj;
                        remetente.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        remetente.Bairro = infToma.enderToma.xBairro;
                        remetente.CEP = infToma.enderToma.CEP;
                        remetente.Complemento = infToma.enderToma.xCpl;
                        remetente.DataCadastro = DateTime.Now;
                        remetente.Email = infToma.email;
                        remetente.Endereco = infToma.enderToma.xLgr;
                        remetente.IE_RG = infToma.IE;
                        remetente.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infToma.enderToma.cMun));
                        remetente.Nome = infToma.xNome;
                        remetente.Numero = infToma.enderToma.nro;
                        remetente.Telefone1 = Utilidades.String.OnlyNumbers(infToma.fone);
                        remetente.Tipo = infToma.Item.Length == 14 ? "J" : "F";

                        if (remetente.Tipo == "J" && remetente.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(remetente.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                remetente.GrupoPessoas = grupoPessoas;
                            }
                        }
                        remetente.Ativo = true;
                        repCliente.Inserir(remetente);
                    }

                    cte.SetarParticipante(remetente, Dominio.Enumeradores.TipoTomador.Remetente, null, dadosremetente);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(1058);

                    if (pais == null)
                        throw new Exception("O país do destinatário é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infToma.enderToma.xBairro;
                    cliente.Cidade = infToma.enderToma.xMun;
                    cliente.Complemento = infToma.enderToma.xCpl;
                    cliente.Emails = infToma.email;
                    cliente.Endereco = infToma.enderToma.xLgr;
                    cliente.RazaoSocial = infToma.xNome;
                    cliente.Numero = infToma.enderToma.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Remetente, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Remetente);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Remetente);

                    repParticipante.Deletar(part);
                }
            }
        }

        private void SetarClienteCTeOS(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCteToma infToma, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infToma != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infToma.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente remetente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosremetente = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (remetente == null)
                    {
                        remetente = new Dominio.Entidades.Cliente();

                        remetente.CPF_CNPJ = cpfCnpj;
                        remetente.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        remetente.Bairro = infToma.enderToma.xBairro;
                        remetente.CEP = infToma.enderToma.CEP;
                        remetente.Complemento = infToma.enderToma.xCpl;
                        remetente.DataCadastro = DateTime.Now;
                        remetente.Email = infToma.email;
                        remetente.Endereco = infToma.enderToma.xLgr;
                        remetente.IE_RG = infToma.IE;
                        remetente.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infToma.enderToma.cMun));
                        remetente.Nome = infToma.xNome;
                        remetente.Numero = infToma.enderToma.nro;
                        remetente.Telefone1 = Utilidades.String.OnlyNumbers(infToma.fone);
                        remetente.Tipo = infToma.Item.Length == 14 ? "J" : "F";

                        if (remetente.Tipo == "J" && remetente.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(remetente.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                remetente.GrupoPessoas = grupoPessoas;
                            }
                        }
                        remetente.Ativo = true;
                        repCliente.Inserir(remetente);
                    }

                    cte.SetarParticipante(remetente, Dominio.Enumeradores.TipoTomador.Remetente, null, dadosremetente);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(1058);

                    if (pais == null)
                        throw new Exception("O país do destinatário é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infToma.enderToma.xBairro;
                    cliente.Cidade = infToma.enderToma.xMun;
                    cliente.Complemento = infToma.enderToma.xCpl;
                    cliente.Emails = infToma.email;
                    cliente.Endereco = infToma.enderToma.xLgr;
                    cliente.RazaoSocial = infToma.xNome;
                    cliente.Numero = infToma.enderToma.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Remetente, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Remetente);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Remetente);

                    repParticipante.Deletar(part);
                }
            }
        }

        private void SetarDestinatario(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteDest infDest, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infDest != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infDest.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente destinatario = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosDestinatario = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (destinatario == null)
                    {
                        destinatario = new Dominio.Entidades.Cliente();

                        destinatario.CPF_CNPJ = cpfCnpj;
                        destinatario.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        destinatario.Bairro = infDest.enderDest.xBairro;
                        destinatario.CEP = infDest.enderDest.CEP;
                        destinatario.Complemento = infDest.enderDest.xCpl;
                        destinatario.DataCadastro = DateTime.Now;
                        destinatario.Email = infDest.email;
                        destinatario.Endereco = infDest.enderDest.xLgr;
                        destinatario.IE_RG = infDest.IE;
                        destinatario.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infDest.enderDest.cMun));
                        destinatario.Nome = infDest.xNome;
                        destinatario.Numero = infDest.enderDest.nro;
                        destinatario.Telefone1 = Utilidades.String.OnlyNumbers(infDest.fone);
                        destinatario.Tipo = infDest.Item.Length == 14 ? "J" : "F";

                        if (destinatario.Tipo == "J" && destinatario.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(destinatario.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                destinatario.GrupoPessoas = grupoPessoas;
                            }
                        }
                        destinatario.Ativo = true;
                        repCliente.Inserir(destinatario);
                    }

                    cte.SetarParticipante(destinatario, Dominio.Enumeradores.TipoTomador.Destinatario, null, dadosDestinatario);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(int.Parse(infDest.enderDest.cPais));

                    if (pais == null)
                        throw new Exception("O país do destinatário é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infDest.enderDest.xBairro;
                    cliente.Cidade = infDest.enderDest.xMun;
                    cliente.Complemento = infDest.enderDest.xCpl;
                    cliente.Emails = infDest.email;
                    cliente.Endereco = infDest.enderDest.xLgr;
                    cliente.RazaoSocial = infDest.xNome;
                    cliente.Numero = infDest.enderDest.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Destinatario, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Destinatario);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Destinatario);

                    repParticipante.Deletar(part);
                }
            }
        }

        private void SetarDestinatario(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteDest infDest, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infDest != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infDest.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente destinatario = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosDestinatario = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (destinatario == null)
                    {
                        destinatario = new Dominio.Entidades.Cliente();

                        destinatario.CPF_CNPJ = cpfCnpj;
                        destinatario.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        destinatario.Bairro = infDest.enderDest.xBairro;
                        destinatario.CEP = infDest.enderDest.CEP;
                        destinatario.Complemento = infDest.enderDest.xCpl;
                        destinatario.DataCadastro = DateTime.Now;
                        destinatario.Email = infDest.email;
                        destinatario.Endereco = infDest.enderDest.xLgr;
                        destinatario.IE_RG = infDest.IE;
                        destinatario.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infDest.enderDest.cMun));
                        destinatario.Nome = infDest.xNome;
                        destinatario.Numero = infDest.enderDest.nro;
                        destinatario.Telefone1 = Utilidades.String.OnlyNumbers(infDest.fone);
                        destinatario.Tipo = infDest.Item.Length == 14 ? "J" : "F";

                        if (destinatario.Tipo == "J" && destinatario.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(destinatario.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                destinatario.GrupoPessoas = grupoPessoas;
                            }
                        }
                        destinatario.Ativo = true;
                        repCliente.Inserir(destinatario);
                    }

                    cte.SetarParticipante(destinatario, Dominio.Enumeradores.TipoTomador.Destinatario, null, dadosDestinatario);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(int.Parse(infDest.enderDest.cPais));

                    if (pais == null)
                        throw new Exception("O país do destinatário é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infDest.enderDest.xBairro;
                    cliente.Cidade = infDest.enderDest.xMun;
                    cliente.Complemento = infDest.enderDest.xCpl;
                    cliente.Emails = infDest.email;
                    cliente.Endereco = infDest.enderDest.xLgr;
                    cliente.RazaoSocial = infDest.xNome;
                    cliente.Numero = infDest.enderDest.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Destinatario, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Destinatario);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Destinatario);

                    repParticipante.Deletar(part);
                }
            }
        }

        private bool SetarDestinatario(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteDest infDest, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infDest != null)
            {
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                double.TryParse(infDest.Item, out double cpfCnpj);

                if (cpfCnpj > 0D)
                {

                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);

                    Dominio.Entidades.Cliente destinatario = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosDestinatario = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (destinatario == null)
                    {
                        destinatario = new Dominio.Entidades.Cliente();

                        destinatario.CPF_CNPJ = cpfCnpj;
                        destinatario.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        destinatario.Bairro = infDest.enderDest.xBairro;
                        destinatario.CEP = infDest.enderDest.CEP;
                        destinatario.Complemento = infDest.enderDest.xCpl;
                        destinatario.DataCadastro = DateTime.Now;
                        destinatario.Email = infDest.email;
                        destinatario.Endereco = infDest.enderDest.xLgr;
                        destinatario.IE_RG = infDest.IE;
                        destinatario.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infDest.enderDest.cMun));

                        if (destinatario.Localidade == null)
                            Servicos.Log.TratarErro($"Localidade não encontrada na base: {infDest.enderDest.cMun} - {infDest.enderDest.xMun}.");

                        destinatario.Nome = infDest.xNome;
                        destinatario.Numero = infDest.enderDest.nro;
                        destinatario.Telefone1 = Utilidades.String.OnlyNumbers(infDest.fone);
                        destinatario.Tipo = infDest.Item.Length == 14 ? "J" : "F";

                        if (destinatario.Tipo == "J" && destinatario.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(destinatario.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                destinatario.GrupoPessoas = grupoPessoas;
                            }
                        }
                        destinatario.Ativo = true;

                        repCliente.Inserir(destinatario);
                    }

                    cte.SetarParticipante(destinatario, Dominio.Enumeradores.TipoTomador.Destinatario, null, dadosDestinatario);
                }
                else
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(infDest.enderDest.cPais))
                        pais = repPais.BuscarPorCodigo(infDest.enderDest.cPais.ToInt());

                    if (pais == null)
                        pais = repPais.BuscarPorNome(infDest.enderDest.xPais);

                    if (pais == null && !string.IsNullOrWhiteSpace(infDest.enderDest.xPais))
                        throw new Exception($"O país ({infDest.enderDest.cPais} - {infDest.enderDest.xPais}) do destinatário não foi encontrado na base.");

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorNomeEndereco(infDest.xNome, infDest.enderDest.xLgr);

                    if (cliente == null)
                        cliente = repPessoaExteriorOutraDescricao.BuscarPessoaPorRazaoSocialEEndereco(infDest.xNome, infDest.enderDest.xLgr);

                    if (cliente == null && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        erro = $"Não foi encontrado um participante do exterior com o nome {infDest.xNome} e o endereço {infDest.enderDest.xLgr}.";
                        return false;
                    }

                    if (cliente == null)
                    {
                        cliente = new Dominio.Entidades.Cliente()
                        {
                            Tipo = "E",
                            Atividade = ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho),
                            Ativo = true,
                            Bairro = infDest.enderDest.xBairro,
                            Cidade = infDest.enderDest.xMun,
                            Complemento = infDest.enderDest.xCpl,
                            Email = infDest.email,
                            Endereco = infDest.enderDest.xLgr,
                            DataCadastro = DateTime.Now,
                            IE_RG = "ISENTO",
                            IndicadorIE = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte,
                            CPF_CNPJ = repCliente.BuscarPorProximoExterior(),
                            Localidade = repLocalidade.BuscarPorCodigoIBGE(infDest.enderDest.cMun.ToInt()),
                            Nome = infDest.xNome,
                            Numero = infDest.enderDest.nro,
                            Pais = pais,
                            Telefone1 = infDest.fone
                        };

                        repCliente.Inserir(cliente);
                    }

                    Dominio.ObjetosDeValor.CTe.Cliente objCliente = new Dominio.ObjetosDeValor.CTe.Cliente
                    {
                        Bairro = infDest.enderDest.xBairro,
                        Cidade = infDest.enderDest.xMun,
                        Complemento = infDest.enderDest.xCpl,
                        Emails = infDest.email,
                        Endereco = infDest.enderDest.xLgr,
                        RazaoSocial = infDest.xNome,
                        Numero = infDest.enderDest.nro
                    };

                    cte.SetarParticipanteExportacao(objCliente, Dominio.Enumeradores.TipoTomador.Destinatario, pais, cliente.Atividade, cliente.Localidade, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Destinatario);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Destinatario);

                    repParticipante.Deletar(part);
                }
            }

            erro = string.Empty;
            return true;
        }

        private bool SetarDestinatario(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteDest infDest, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infDest != null)
            {
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                double.TryParse(infDest.Item, out double cpfCnpj);

                if (cpfCnpj > 0D)
                {

                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);

                    Dominio.Entidades.Cliente destinatario = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosDestinatario = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (destinatario == null)
                    {
                        destinatario = new Dominio.Entidades.Cliente();

                        destinatario.CPF_CNPJ = cpfCnpj;
                        destinatario.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        destinatario.Bairro = infDest.enderDest.xBairro;
                        destinatario.CEP = infDest.enderDest.CEP;
                        destinatario.Complemento = infDest.enderDest.xCpl;
                        destinatario.DataCadastro = DateTime.Now;
                        destinatario.Email = infDest.email;
                        destinatario.Endereco = infDest.enderDest.xLgr;
                        destinatario.IE_RG = infDest.IE;
                        destinatario.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infDest.enderDest.cMun));

                        if (destinatario.Localidade == null)
                            Servicos.Log.TratarErro($"Localidade não encontrada na base: {infDest.enderDest.cMun} - {infDest.enderDest.xMun}.");

                        destinatario.Nome = infDest.xNome;
                        destinatario.Numero = infDest.enderDest.nro;
                        destinatario.Telefone1 = Utilidades.String.OnlyNumbers(infDest.fone);
                        destinatario.Tipo = infDest.Item.Length == 14 ? "J" : "F";

                        if (destinatario.Tipo == "J" && destinatario.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(destinatario.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                destinatario.GrupoPessoas = grupoPessoas;
                            }
                        }
                        destinatario.Ativo = true;

                        repCliente.Inserir(destinatario);
                    }

                    cte.SetarParticipante(destinatario, Dominio.Enumeradores.TipoTomador.Destinatario, null, dadosDestinatario);
                }
                else
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(infDest.enderDest.cPais))
                        pais = repPais.BuscarPorCodigo(infDest.enderDest.cPais.ToInt());

                    if (pais == null)
                        pais = repPais.BuscarPorNome(infDest.enderDest.xPais);

                    if (pais == null && !string.IsNullOrWhiteSpace(infDest.enderDest.xPais))
                        throw new Exception($"O país ({infDest.enderDest.cPais} - {infDest.enderDest.xPais}) do destinatário não foi encontrado na base.");

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorNomeEndereco(infDest.xNome, infDest.enderDest.xLgr);

                    if (cliente == null)
                        cliente = repPessoaExteriorOutraDescricao.BuscarPessoaPorRazaoSocialEEndereco(infDest.xNome, infDest.enderDest.xLgr);

                    if (cliente == null && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        erro = $"Não foi encontrado um participante do exterior com o nome {infDest.xNome} e o endereço {infDest.enderDest.xLgr}.";
                        return false;
                    }

                    if (cliente == null)
                    {
                        cliente = new Dominio.Entidades.Cliente()
                        {
                            Tipo = "E",
                            Atividade = ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho),
                            Ativo = true,
                            Bairro = infDest.enderDest.xBairro,
                            Cidade = infDest.enderDest.xMun,
                            Complemento = infDest.enderDest.xCpl,
                            Email = infDest.email,
                            Endereco = infDest.enderDest.xLgr,
                            DataCadastro = DateTime.Now,
                            IE_RG = "ISENTO",
                            IndicadorIE = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte,
                            CPF_CNPJ = repCliente.BuscarPorProximoExterior(),
                            Localidade = repLocalidade.BuscarPorCodigoIBGE(infDest.enderDest.cMun.ToInt()),
                            Nome = infDest.xNome,
                            Numero = infDest.enderDest.nro,
                            Pais = pais,
                            Telefone1 = infDest.fone
                        };

                        repCliente.Inserir(cliente);
                    }

                    Dominio.ObjetosDeValor.CTe.Cliente objCliente = new Dominio.ObjetosDeValor.CTe.Cliente
                    {
                        Bairro = infDest.enderDest.xBairro,
                        Cidade = infDest.enderDest.xMun,
                        Complemento = infDest.enderDest.xCpl,
                        Emails = infDest.email,
                        Endereco = infDest.enderDest.xLgr,
                        RazaoSocial = infDest.xNome,
                        Numero = infDest.enderDest.nro
                    };

                    cte.SetarParticipanteExportacao(objCliente, Dominio.Enumeradores.TipoTomador.Destinatario, pais, cliente.Atividade, cliente.Localidade, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Destinatario);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Destinatario);

                    repParticipante.Deletar(part);
                }
            }

            erro = string.Empty;
            return true;
        }

        private bool SetarDestinatario(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteToma infToma, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infToma != null)
            {
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                double.TryParse(infToma.Item, out double cpfCnpj);

                if (cpfCnpj > 0D)
                {
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);

                    Dominio.Entidades.Cliente tomador = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosTomador = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (tomador == null)
                    {
                        tomador = new Dominio.Entidades.Cliente();

                        tomador.CPF_CNPJ = cpfCnpj;
                        tomador.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        tomador.Bairro = infToma.enderToma.xBairro;
                        tomador.CEP = infToma.enderToma.CEP;
                        tomador.Complemento = infToma.enderToma.xCpl;
                        tomador.DataCadastro = DateTime.Now;
                        tomador.Email = infToma.email;
                        tomador.Endereco = infToma.enderToma.xLgr;
                        tomador.IE_RG = infToma.IE;
                        tomador.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infToma.enderToma.cMun));

                        if (tomador.Localidade == null)
                            Servicos.Log.TratarErro($"Localidade não encontrada na base: {infToma.enderToma.cMun} - {infToma.enderToma.xMun}.");

                        tomador.Nome = infToma.xNome;
                        tomador.NomeFantasia = dadosTomador != null && !string.IsNullOrWhiteSpace(dadosTomador.NomeFantasia) ? dadosTomador.NomeFantasia : infToma.xNome;
                        tomador.Numero = infToma.enderToma.nro;
                        tomador.Telefone1 = Utilidades.String.OnlyNumbers(infToma.fone);
                        tomador.Tipo = infToma.Item.Length == 14 ? "J" : "F";

                        if (tomador.Tipo == "J" && tomador.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(tomador.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                tomador.GrupoPessoas = grupoPessoas;
                            }
                        }
                        tomador.Ativo = true;
                        repCliente.Inserir(tomador);
                    }

                    cte.SetarParticipante(tomador, Dominio.Enumeradores.TipoTomador.Destinatario, null, dadosTomador);
                }
                else
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(infToma.enderToma.cPais))
                        pais = repPais.BuscarPorCodigo(infToma.enderToma.cPais.ToInt());

                    if (pais == null)
                        pais = repPais.BuscarPorNome(infToma.enderToma.xPais);

                    if (pais == null)
                        throw new Exception($"O país ({infToma.enderToma.cPais} - {infToma.enderToma.xPais}) do tomador não foi encontrado na base.");

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorNomeEndereco(infToma.xNome, infToma.enderToma.xLgr);

                    if (cliente == null)
                        cliente = repPessoaExteriorOutraDescricao.BuscarPessoaPorRazaoSocialEEndereco(infToma.xNome, infToma.enderToma.xLgr);

                    if (cliente == null && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        erro = $"Não foi encontrada uma pessoa do exterior com o nome {infToma.xNome} e o endereço {infToma.enderToma.xLgr}.";
                        return false;
                    }

                    if (cliente == null)
                    {
                        cliente = new Dominio.Entidades.Cliente()
                        {
                            Tipo = "E",
                            Atividade = ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho),
                            Ativo = true,
                            Bairro = infToma.enderToma.xBairro,
                            Cidade = infToma.enderToma.xMun,
                            Complemento = infToma.enderToma.xCpl,
                            Email = infToma.email,
                            Endereco = infToma.enderToma.xLgr,
                            DataCadastro = DateTime.Now,
                            IE_RG = "ISENTO",
                            IndicadorIE = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte,
                            CPF_CNPJ = repCliente.BuscarPorProximoExterior(),
                            Localidade = repLocalidade.BuscarPorCodigoIBGE(infToma.enderToma.cMun.ToInt()),
                            Nome = infToma.xNome,
                            Numero = infToma.enderToma.nro,
                            Pais = pais,
                            Telefone1 = infToma.fone
                        };

                        repCliente.Inserir(cliente);
                    }

                    Dominio.ObjetosDeValor.CTe.Cliente objCliente = new Dominio.ObjetosDeValor.CTe.Cliente
                    {
                        Bairro = infToma.enderToma.xBairro,
                        Cidade = infToma.enderToma.xMun,
                        Complemento = infToma.enderToma.xCpl,
                        Emails = infToma.email,
                        Endereco = infToma.enderToma.xLgr,
                        RazaoSocial = infToma.xNome,
                        Numero = infToma.enderToma.nro
                    };

                    cte.SetarParticipanteExportacao(objCliente, Dominio.Enumeradores.TipoTomador.Destinatario, pais, cliente.Atividade, cliente.Localidade, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Destinatario);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Destinatario);

                    repParticipante.Deletar(part);
                }
            }

            erro = string.Empty;
            return true;
        }

        private void SetarDestinatario(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v200.Envio.TCTeInfCteDest infDest, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infDest != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infDest.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente destinatario = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosDestinatario = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (destinatario == null)
                    {
                        destinatario = new Dominio.Entidades.Cliente();

                        destinatario.CPF_CNPJ = cpfCnpj;
                        destinatario.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        destinatario.Bairro = infDest.enderDest.xBairro;
                        destinatario.CEP = infDest.enderDest.CEP;
                        destinatario.Complemento = infDest.enderDest.xCpl;
                        destinatario.DataCadastro = DateTime.Now;
                        destinatario.Email = infDest.email;
                        destinatario.Endereco = infDest.enderDest.xLgr;
                        destinatario.IE_RG = infDest.IE;
                        destinatario.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infDest.enderDest.cMun));
                        destinatario.Nome = infDest.xNome;
                        destinatario.Numero = infDest.enderDest.nro;
                        destinatario.Telefone1 = Utilidades.String.OnlyNumbers(infDest.fone);
                        destinatario.Tipo = infDest.Item.Length == 14 ? "J" : "F";

                        if (destinatario.Tipo == "J" && destinatario.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(destinatario.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                destinatario.GrupoPessoas = grupoPessoas;
                            }
                        }
                        destinatario.Ativo = true;
                        repCliente.Inserir(destinatario);
                    }

                    cte.SetarParticipante(destinatario, Dominio.Enumeradores.TipoTomador.Destinatario, null, dadosDestinatario);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(int.Parse(infDest.enderDest.cPais));

                    if (pais == null)
                        throw new Exception("O país do destinatário é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infDest.enderDest.xBairro;
                    cliente.Cidade = infDest.enderDest.xMun;
                    cliente.Complemento = infDest.enderDest.xCpl;
                    cliente.Emails = infDest.email;
                    cliente.Endereco = infDest.enderDest.xLgr;
                    cliente.RazaoSocial = infDest.xNome;
                    cliente.Numero = infDest.enderDest.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Destinatario, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Destinatario);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Destinatario);

                    repParticipante.Deletar(part);
                }
            }
        }

        private void SetarExpedidor(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteExped infExp, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infExp != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infExp.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente expedidor = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosExpedidor = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (expedidor == null)
                    {
                        expedidor = new Dominio.Entidades.Cliente();

                        expedidor.CPF_CNPJ = cpfCnpj;
                        expedidor.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        expedidor.Bairro = infExp.enderExped.xBairro;
                        expedidor.CEP = infExp.enderExped.CEP;
                        expedidor.Complemento = infExp.enderExped.xCpl;
                        expedidor.DataCadastro = DateTime.Now;
                        expedidor.Email = infExp.email;
                        expedidor.Endereco = infExp.enderExped.xLgr;
                        expedidor.IE_RG = infExp.IE;
                        expedidor.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infExp.enderExped.cMun));
                        expedidor.Nome = infExp.xNome;
                        expedidor.Numero = infExp.enderExped.nro;
                        expedidor.Telefone1 = Utilidades.String.OnlyNumbers(infExp.fone);
                        expedidor.Tipo = infExp.Item.Length == 14 ? "J" : "F";

                        if (expedidor.Tipo == "J" && expedidor.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(expedidor.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                expedidor.GrupoPessoas = grupoPessoas;
                            }
                        }
                        expedidor.Ativo = true;
                        repCliente.Inserir(expedidor);
                    }

                    cte.SetarParticipante(expedidor, Dominio.Enumeradores.TipoTomador.Expedidor, null, dadosExpedidor);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(int.Parse(infExp.enderExped.cPais));

                    if (pais == null)
                        throw new Exception("O país do expedidor é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infExp.enderExped.xBairro;
                    cliente.Cidade = infExp.enderExped.xMun;
                    cliente.Complemento = infExp.enderExped.xCpl;
                    cliente.Emails = infExp.email;
                    cliente.Endereco = infExp.enderExped.xLgr;
                    cliente.RazaoSocial = infExp.xNome;
                    cliente.Numero = infExp.enderExped.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Expedidor, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Expedidor);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Expedidor);

                    repParticipante.Deletar(part);
                }
            }
        }

        private void SetarExpedidor(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteExped infExp, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infExp != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infExp.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente expedidor = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosExpedidor = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (expedidor == null)
                    {
                        expedidor = new Dominio.Entidades.Cliente();

                        expedidor.CPF_CNPJ = cpfCnpj;
                        expedidor.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        expedidor.Bairro = infExp.enderExped.xBairro;
                        expedidor.CEP = infExp.enderExped.CEP;
                        expedidor.Complemento = infExp.enderExped.xCpl;
                        expedidor.DataCadastro = DateTime.Now;
                        expedidor.Email = infExp.email;
                        expedidor.Endereco = infExp.enderExped.xLgr;
                        expedidor.IE_RG = infExp.IE;
                        expedidor.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infExp.enderExped.cMun));
                        expedidor.Nome = infExp.xNome;
                        expedidor.Numero = infExp.enderExped.nro;
                        expedidor.Telefone1 = Utilidades.String.OnlyNumbers(infExp.fone);
                        expedidor.Tipo = infExp.Item.Length == 14 ? "J" : "F";

                        if (expedidor.Tipo == "J" && expedidor.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(expedidor.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                expedidor.GrupoPessoas = grupoPessoas;
                            }
                        }
                        expedidor.Ativo = true;
                        repCliente.Inserir(expedidor);
                    }

                    cte.SetarParticipante(expedidor, Dominio.Enumeradores.TipoTomador.Expedidor, null, dadosExpedidor);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(int.Parse(infExp.enderExped.cPais));

                    if (pais == null)
                        throw new Exception("O país do expedidor é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infExp.enderExped.xBairro;
                    cliente.Cidade = infExp.enderExped.xMun;
                    cliente.Complemento = infExp.enderExped.xCpl;
                    cliente.Emails = infExp.email;
                    cliente.Endereco = infExp.enderExped.xLgr;
                    cliente.RazaoSocial = infExp.xNome;
                    cliente.Numero = infExp.enderExped.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Expedidor, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Expedidor);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Expedidor);

                    repParticipante.Deletar(part);
                }
            }
        }

        private bool SetarExpedidor(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteExped infExp, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infExp != null)
            {
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                double.TryParse(infExp.Item, out double cpfCnpj);

                if (cpfCnpj > 0D)
                {
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);

                    Dominio.Entidades.Cliente expedidor = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosExpedidor = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (expedidor == null)
                    {
                        expedidor = new Dominio.Entidades.Cliente();

                        expedidor.CPF_CNPJ = cpfCnpj;
                        expedidor.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        expedidor.Bairro = infExp.enderExped.xBairro;
                        expedidor.CEP = infExp.enderExped.CEP;
                        expedidor.Complemento = infExp.enderExped.xCpl;
                        expedidor.DataCadastro = DateTime.Now;
                        expedidor.Email = infExp.email;
                        expedidor.Endereco = infExp.enderExped.xLgr;
                        expedidor.IE_RG = infExp.IE;
                        expedidor.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infExp.enderExped.cMun));

                        if (expedidor.Localidade == null)
                            Servicos.Log.TratarErro($"Localidade não encontrada na base: {infExp.enderExped.cMun} - {infExp.enderExped.xMun}.");

                        expedidor.Nome = infExp.xNome;
                        expedidor.Numero = infExp.enderExped.nro;
                        expedidor.Telefone1 = Utilidades.String.OnlyNumbers(infExp.fone);
                        expedidor.Tipo = infExp.Item.Length == 14 ? "J" : "F";

                        if (expedidor.Tipo == "J" && expedidor.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(expedidor.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                expedidor.GrupoPessoas = grupoPessoas;
                            }
                        }
                        expedidor.Ativo = true;
                        repCliente.Inserir(expedidor);
                    }

                    cte.SetarParticipante(expedidor, Dominio.Enumeradores.TipoTomador.Expedidor, null, dadosExpedidor);
                }
                else
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(infExp.enderExped.cPais))
                        pais = repPais.BuscarPorCodigo(infExp.enderExped.cPais.ToInt());

                    if (pais == null)
                        pais = repPais.BuscarPorNome(infExp.enderExped.xPais.ToUpper());

                    if (pais == null)
                        throw new Exception($"O país ({infExp.enderExped.cPais} - {infExp.enderExped.xPais}) do expedidor não foi encontrado na base.");

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorNomeEndereco(infExp.xNome, infExp.enderExped.xLgr);

                    if (cliente == null)
                        cliente = repPessoaExteriorOutraDescricao.BuscarPessoaPorRazaoSocialEEndereco(infExp.xNome, infExp.enderExped.xLgr);

                    if (cliente == null && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        erro = $"Não foi encontrada uma pessoa do exterior com o nome {infExp.xNome} e o endereço {infExp.enderExped.xLgr}.";
                        return false;
                    }

                    if (cliente == null)
                    {
                        cliente = new Dominio.Entidades.Cliente()
                        {
                            Tipo = "E",
                            Atividade = ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho),
                            Ativo = true,
                            Bairro = infExp.enderExped.xBairro,
                            Cidade = infExp.enderExped.xMun,
                            Complemento = infExp.enderExped.xCpl,
                            Email = infExp.email,
                            Endereco = infExp.enderExped.xLgr,
                            DataCadastro = DateTime.Now,
                            IE_RG = "ISENTO",
                            IndicadorIE = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte,
                            CPF_CNPJ = repCliente.BuscarPorProximoExterior(),
                            Localidade = repLocalidade.BuscarPorCodigoIBGE(infExp.enderExped.cMun.ToInt()),
                            Nome = infExp.xNome,
                            Numero = infExp.enderExped.nro,
                            Pais = pais,
                            Telefone1 = infExp.fone
                        };

                        repCliente.Inserir(cliente);
                    }

                    Dominio.ObjetosDeValor.CTe.Cliente objCliente = new Dominio.ObjetosDeValor.CTe.Cliente
                    {
                        Bairro = infExp.enderExped.xBairro,
                        Cidade = infExp.enderExped.xMun,
                        Complemento = infExp.enderExped.xCpl,
                        Emails = infExp.email,
                        Endereco = infExp.enderExped.xLgr,
                        RazaoSocial = infExp.xNome,
                        Numero = infExp.enderExped.nro
                    };

                    cte.SetarParticipanteExportacao(objCliente, Dominio.Enumeradores.TipoTomador.Expedidor, pais, cliente.Atividade, cliente.Localidade, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Expedidor);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Expedidor);

                    repParticipante.Deletar(part);
                }
            }

            erro = string.Empty;
            return true;
        }

        private bool SetarExpedidor(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteExped infExp, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infExp != null)
            {
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                double.TryParse(infExp.Item, out double cpfCnpj);

                if (cpfCnpj > 0D)
                {
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);

                    Dominio.Entidades.Cliente expedidor = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosExpedidor = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (expedidor == null)
                    {
                        expedidor = new Dominio.Entidades.Cliente();

                        expedidor.CPF_CNPJ = cpfCnpj;
                        expedidor.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        expedidor.Bairro = infExp.enderExped.xBairro;
                        expedidor.CEP = infExp.enderExped.CEP;
                        expedidor.Complemento = infExp.enderExped.xCpl;
                        expedidor.DataCadastro = DateTime.Now;
                        expedidor.Email = infExp.email;
                        expedidor.Endereco = infExp.enderExped.xLgr;
                        expedidor.IE_RG = infExp.IE;
                        expedidor.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infExp.enderExped.cMun));

                        if (expedidor.Localidade == null)
                            Servicos.Log.TratarErro($"Localidade não encontrada na base: {infExp.enderExped.cMun} - {infExp.enderExped.xMun}.");

                        expedidor.Nome = infExp.xNome;
                        expedidor.Numero = infExp.enderExped.nro;
                        expedidor.Telefone1 = Utilidades.String.OnlyNumbers(infExp.fone);
                        expedidor.Tipo = infExp.Item.Length == 14 ? "J" : "F";

                        if (expedidor.Tipo == "J" && expedidor.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(expedidor.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                expedidor.GrupoPessoas = grupoPessoas;
                            }
                        }
                        expedidor.Ativo = true;
                        repCliente.Inserir(expedidor);
                    }

                    cte.SetarParticipante(expedidor, Dominio.Enumeradores.TipoTomador.Expedidor, null, dadosExpedidor);
                }
                else
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(infExp.enderExped.cPais))
                        pais = repPais.BuscarPorCodigo(infExp.enderExped.cPais.ToInt());

                    if (pais == null)
                        pais = repPais.BuscarPorNome(infExp.enderExped.xPais.ToUpper());

                    if (pais == null)
                        throw new Exception($"O país ({infExp.enderExped.cPais} - {infExp.enderExped.xPais}) do expedidor não foi encontrado na base.");

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorNomeEndereco(infExp.xNome, infExp.enderExped.xLgr);

                    if (cliente == null)
                        cliente = repPessoaExteriorOutraDescricao.BuscarPessoaPorRazaoSocialEEndereco(infExp.xNome, infExp.enderExped.xLgr);

                    if (cliente == null && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        erro = $"Não foi encontrada uma pessoa do exterior com o nome {infExp.xNome} e o endereço {infExp.enderExped.xLgr}.";
                        return false;
                    }

                    if (cliente == null)
                    {
                        cliente = new Dominio.Entidades.Cliente()
                        {
                            Tipo = "E",
                            Atividade = ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho),
                            Ativo = true,
                            Bairro = infExp.enderExped.xBairro,
                            Cidade = infExp.enderExped.xMun,
                            Complemento = infExp.enderExped.xCpl,
                            Email = infExp.email,
                            Endereco = infExp.enderExped.xLgr,
                            DataCadastro = DateTime.Now,
                            IE_RG = "ISENTO",
                            IndicadorIE = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte,
                            CPF_CNPJ = repCliente.BuscarPorProximoExterior(),
                            Localidade = repLocalidade.BuscarPorCodigoIBGE(infExp.enderExped.cMun.ToInt()),
                            Nome = infExp.xNome,
                            Numero = infExp.enderExped.nro,
                            Pais = pais,
                            Telefone1 = infExp.fone
                        };

                        repCliente.Inserir(cliente);
                    }

                    Dominio.ObjetosDeValor.CTe.Cliente objCliente = new Dominio.ObjetosDeValor.CTe.Cliente
                    {
                        Bairro = infExp.enderExped.xBairro,
                        Cidade = infExp.enderExped.xMun,
                        Complemento = infExp.enderExped.xCpl,
                        Emails = infExp.email,
                        Endereco = infExp.enderExped.xLgr,
                        RazaoSocial = infExp.xNome,
                        Numero = infExp.enderExped.nro
                    };

                    cte.SetarParticipanteExportacao(objCliente, Dominio.Enumeradores.TipoTomador.Expedidor, pais, cliente.Atividade, cliente.Localidade, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Expedidor);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Expedidor);

                    repParticipante.Deletar(part);
                }
            }

            erro = string.Empty;
            return true;
        }

        private bool SetarExpedidor(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteToma infToma, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infToma != null)
            {
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                double.TryParse(infToma.Item, out double cpfCnpj);

                if (cpfCnpj > 0D)
                {
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);

                    Dominio.Entidades.Cliente tomador = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosTomador = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (tomador == null)
                    {
                        tomador = new Dominio.Entidades.Cliente();

                        tomador.CPF_CNPJ = cpfCnpj;
                        tomador.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        tomador.Bairro = infToma.enderToma.xBairro;
                        tomador.CEP = infToma.enderToma.CEP;
                        tomador.Complemento = infToma.enderToma.xCpl;
                        tomador.DataCadastro = DateTime.Now;
                        tomador.Email = infToma.email;
                        tomador.Endereco = infToma.enderToma.xLgr;
                        tomador.IE_RG = infToma.IE;
                        tomador.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infToma.enderToma.cMun));

                        if (tomador.Localidade == null)
                            Servicos.Log.TratarErro($"Localidade não encontrada na base: {infToma.enderToma.cMun} - {infToma.enderToma.xMun}.");

                        tomador.Nome = infToma.xNome;
                        tomador.NomeFantasia = dadosTomador != null && !string.IsNullOrWhiteSpace(dadosTomador.NomeFantasia) ? dadosTomador.NomeFantasia : infToma.xNome;
                        tomador.Numero = infToma.enderToma.nro;
                        tomador.Telefone1 = Utilidades.String.OnlyNumbers(infToma.fone);
                        tomador.Tipo = infToma.Item.Length == 14 ? "J" : "F";

                        if (tomador.Tipo == "J" && tomador.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(tomador.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                tomador.GrupoPessoas = grupoPessoas;
                            }
                        }
                        tomador.Ativo = true;
                        repCliente.Inserir(tomador);
                    }

                    cte.SetarParticipante(tomador, Dominio.Enumeradores.TipoTomador.Expedidor, null, dadosTomador);
                }
                else
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(infToma.enderToma.cPais))
                        pais = repPais.BuscarPorCodigo(infToma.enderToma.cPais.ToInt());

                    if (pais == null)
                        pais = repPais.BuscarPorNome(infToma.enderToma.xPais);

                    if (pais == null)
                        throw new Exception($"O país ({infToma.enderToma.cPais} - {infToma.enderToma.xPais}) do tomador não foi encontrado na base.");

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorNomeEndereco(infToma.xNome, infToma.enderToma.xLgr);

                    if (cliente == null)
                        cliente = repPessoaExteriorOutraDescricao.BuscarPessoaPorRazaoSocialEEndereco(infToma.xNome, infToma.enderToma.xLgr);

                    if (cliente == null && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        erro = $"Não foi encontrada uma pessoa do exterior com o nome {infToma.xNome} e o endereço {infToma.enderToma.xLgr}.";
                        return false;
                    }

                    if (cliente == null)
                    {
                        cliente = new Dominio.Entidades.Cliente()
                        {
                            Tipo = "E",
                            Atividade = ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho),
                            Ativo = true,
                            Bairro = infToma.enderToma.xBairro,
                            Cidade = infToma.enderToma.xMun,
                            Complemento = infToma.enderToma.xCpl,
                            Email = infToma.email,
                            Endereco = infToma.enderToma.xLgr,
                            DataCadastro = DateTime.Now,
                            IE_RG = "ISENTO",
                            IndicadorIE = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte,
                            CPF_CNPJ = repCliente.BuscarPorProximoExterior(),
                            Localidade = repLocalidade.BuscarPorCodigoIBGE(infToma.enderToma.cMun.ToInt()),
                            Nome = infToma.xNome,
                            Numero = infToma.enderToma.nro,
                            Pais = pais,
                            Telefone1 = infToma.fone
                        };

                        repCliente.Inserir(cliente);
                    }

                    Dominio.ObjetosDeValor.CTe.Cliente objCliente = new Dominio.ObjetosDeValor.CTe.Cliente
                    {
                        Bairro = infToma.enderToma.xBairro,
                        Cidade = infToma.enderToma.xMun,
                        Complemento = infToma.enderToma.xCpl,
                        Emails = infToma.email,
                        Endereco = infToma.enderToma.xLgr,
                        RazaoSocial = infToma.xNome,
                        Numero = infToma.enderToma.nro
                    };

                    cte.SetarParticipanteExportacao(objCliente, Dominio.Enumeradores.TipoTomador.Expedidor, pais, cliente.Atividade, cliente.Localidade, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Expedidor);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Expedidor);

                    repParticipante.Deletar(part);
                }
            }

            erro = string.Empty;
            return true;
        }

        private void SetarExpedidor(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v200.Envio.TCTeInfCteExped infExp, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infExp != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infExp.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente expedidor = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosExpedidor = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (expedidor == null)
                    {
                        expedidor = new Dominio.Entidades.Cliente();

                        expedidor.CPF_CNPJ = cpfCnpj;
                        expedidor.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        expedidor.Bairro = infExp.enderExped.xBairro;
                        expedidor.CEP = infExp.enderExped.CEP;
                        expedidor.Complemento = infExp.enderExped.xCpl;
                        expedidor.DataCadastro = DateTime.Now;
                        expedidor.Email = infExp.email;
                        expedidor.Endereco = infExp.enderExped.xLgr;
                        expedidor.IE_RG = infExp.IE;
                        expedidor.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infExp.enderExped.cMun));
                        expedidor.Nome = infExp.xNome;
                        expedidor.Numero = infExp.enderExped.nro;
                        expedidor.Telefone1 = Utilidades.String.OnlyNumbers(infExp.fone);
                        expedidor.Tipo = infExp.Item.Length == 14 ? "J" : "F";

                        if (expedidor.Tipo == "J" && expedidor.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(expedidor.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                expedidor.GrupoPessoas = grupoPessoas;
                            }
                        }
                        expedidor.Ativo = true;
                        repCliente.Inserir(expedidor);
                    }

                    cte.SetarParticipante(expedidor, Dominio.Enumeradores.TipoTomador.Expedidor, null, dadosExpedidor);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(int.Parse(infExp.enderExped.cPais));

                    if (pais == null)
                        throw new Exception("O país do expedidor é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infExp.enderExped.xBairro;
                    cliente.Cidade = infExp.enderExped.xMun;
                    cliente.Complemento = infExp.enderExped.xCpl;
                    cliente.Emails = infExp.email;
                    cliente.Endereco = infExp.enderExped.xLgr;
                    cliente.RazaoSocial = infExp.xNome;
                    cliente.Numero = infExp.enderExped.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Expedidor, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Expedidor);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Expedidor);

                    repParticipante.Deletar(part);
                }
            }
        }

        private void SetarRecebedor(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteReceb infReceb, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infReceb != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infReceb.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente recebedor = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosRecebedor = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (recebedor == null)
                    {
                        recebedor = new Dominio.Entidades.Cliente();

                        recebedor.CPF_CNPJ = cpfCnpj;
                        recebedor.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        recebedor.Bairro = infReceb.enderReceb.xBairro;
                        recebedor.CEP = infReceb.enderReceb.CEP;
                        recebedor.Complemento = infReceb.enderReceb.xCpl;
                        recebedor.DataCadastro = DateTime.Now;
                        recebedor.Email = infReceb.email;
                        recebedor.Endereco = infReceb.enderReceb.xLgr;
                        recebedor.IE_RG = infReceb.IE;
                        recebedor.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infReceb.enderReceb.cMun));
                        recebedor.Nome = infReceb.xNome;
                        recebedor.Numero = infReceb.enderReceb.nro;
                        recebedor.Telefone1 = Utilidades.String.OnlyNumbers(infReceb.fone);
                        recebedor.Tipo = infReceb.Item.Length == 14 ? "J" : "F";

                        if (recebedor.Tipo == "J" && recebedor.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(recebedor.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                recebedor.GrupoPessoas = grupoPessoas;
                            }
                        }
                        recebedor.Ativo = true;
                        repCliente.Inserir(recebedor);
                    }

                    cte.SetarParticipante(recebedor, Dominio.Enumeradores.TipoTomador.Recebedor, null, dadosRecebedor);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(int.Parse(infReceb.enderReceb.cPais));

                    if (pais == null)
                        throw new Exception("O país do recebedor é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infReceb.enderReceb.xBairro;
                    cliente.Cidade = infReceb.enderReceb.xMun;
                    cliente.Complemento = infReceb.enderReceb.xCpl;
                    cliente.Emails = infReceb.email;
                    cliente.Endereco = infReceb.enderReceb.xLgr;
                    cliente.RazaoSocial = infReceb.xNome;
                    cliente.Numero = infReceb.enderReceb.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Recebedor, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Recebedor);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Recebedor);

                    repParticipante.Deletar(part);
                }
            }
        }

        private void SetarRecebedor(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteReceb infReceb, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infReceb != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infReceb.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente recebedor = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosRecebedor = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (recebedor == null)
                    {
                        recebedor = new Dominio.Entidades.Cliente();

                        recebedor.CPF_CNPJ = cpfCnpj;
                        recebedor.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        recebedor.Bairro = infReceb.enderReceb.xBairro;
                        recebedor.CEP = infReceb.enderReceb.CEP;
                        recebedor.Complemento = infReceb.enderReceb.xCpl;
                        recebedor.DataCadastro = DateTime.Now;
                        recebedor.Email = infReceb.email;
                        recebedor.Endereco = infReceb.enderReceb.xLgr;
                        recebedor.IE_RG = infReceb.IE;
                        recebedor.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infReceb.enderReceb.cMun));
                        recebedor.Nome = infReceb.xNome;
                        recebedor.Numero = infReceb.enderReceb.nro;
                        recebedor.Telefone1 = Utilidades.String.OnlyNumbers(infReceb.fone);
                        recebedor.Tipo = infReceb.Item.Length == 14 ? "J" : "F";

                        if (recebedor.Tipo == "J" && recebedor.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(recebedor.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                recebedor.GrupoPessoas = grupoPessoas;
                            }
                        }
                        recebedor.Ativo = true;
                        repCliente.Inserir(recebedor);
                    }

                    cte.SetarParticipante(recebedor, Dominio.Enumeradores.TipoTomador.Recebedor, null, dadosRecebedor);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(int.Parse(infReceb.enderReceb.cPais));

                    if (pais == null)
                        throw new Exception("O país do recebedor é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infReceb.enderReceb.xBairro;
                    cliente.Cidade = infReceb.enderReceb.xMun;
                    cliente.Complemento = infReceb.enderReceb.xCpl;
                    cliente.Emails = infReceb.email;
                    cliente.Endereco = infReceb.enderReceb.xLgr;
                    cliente.RazaoSocial = infReceb.xNome;
                    cliente.Numero = infReceb.enderReceb.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Recebedor, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Recebedor);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Recebedor);

                    repParticipante.Deletar(part);
                }
            }
        }

        private bool SetarRecebedor(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteReceb infReceb, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infReceb != null)
            {
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                double.TryParse(infReceb.Item, out double cpfCnpj);

                if (cpfCnpj > 0D)
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);

                    Dominio.Entidades.Cliente recebedor = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosRecebedor = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (recebedor == null)
                    {
                        recebedor = new Dominio.Entidades.Cliente();

                        recebedor.CPF_CNPJ = cpfCnpj;
                        recebedor.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        recebedor.Bairro = infReceb.enderReceb.xBairro;
                        recebedor.CEP = infReceb.enderReceb.CEP;
                        recebedor.Complemento = infReceb.enderReceb.xCpl;
                        recebedor.DataCadastro = DateTime.Now;
                        recebedor.Email = infReceb.email;
                        recebedor.Endereco = infReceb.enderReceb.xLgr;
                        recebedor.IE_RG = infReceb.IE;
                        recebedor.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infReceb.enderReceb.cMun));

                        if (recebedor.Localidade == null)
                            Servicos.Log.TratarErro($"Localidade não encontrada na base: {infReceb.enderReceb.cMun} - {infReceb.enderReceb.xMun}.");

                        recebedor.Nome = infReceb.xNome;
                        recebedor.Numero = infReceb.enderReceb.nro;
                        recebedor.Telefone1 = Utilidades.String.OnlyNumbers(infReceb.fone);
                        recebedor.Tipo = infReceb.Item.Length == 14 ? "J" : "F";

                        if (recebedor.Tipo == "J" && recebedor.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(recebedor.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                recebedor.GrupoPessoas = grupoPessoas;
                            }
                        }
                        recebedor.Ativo = true;
                        repCliente.Inserir(recebedor);
                    }

                    cte.SetarParticipante(recebedor, Dominio.Enumeradores.TipoTomador.Recebedor, null, dadosRecebedor);
                }
                else
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(infReceb.enderReceb.cPais))
                        pais = repPais.BuscarPorCodigo(infReceb.enderReceb.cPais.ToInt());

                    if (pais == null)
                        pais = repPais.BuscarPorNome(infReceb.enderReceb.xPais);

                    if (pais == null)
                        throw new Exception($"O país ({infReceb.enderReceb.cPais} - {infReceb.enderReceb.xPais}) do recebedor não foi encontrado na base.");

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorNomeEndereco(infReceb.xNome, infReceb.enderReceb.xLgr);

                    if (cliente == null)
                        cliente = repPessoaExteriorOutraDescricao.BuscarPessoaPorRazaoSocialEEndereco(infReceb.xNome, infReceb.enderReceb.xLgr);

                    if (cliente == null && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        erro = $"Não foi encontrada uma pessoa do exterior com o nome {infReceb.xNome} e o endereço {infReceb.enderReceb.xLgr}.";
                        return false;
                    }

                    if (cliente == null)
                    {
                        cliente = new Dominio.Entidades.Cliente()
                        {
                            Tipo = "E",
                            Atividade = ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho),
                            Ativo = true,
                            Bairro = infReceb.enderReceb.xBairro,
                            Cidade = infReceb.enderReceb.xMun,
                            Complemento = infReceb.enderReceb.xCpl,
                            Email = infReceb.email,
                            Endereco = infReceb.enderReceb.xLgr,
                            DataCadastro = DateTime.Now,
                            IE_RG = "ISENTO",
                            IndicadorIE = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte,
                            CPF_CNPJ = repCliente.BuscarPorProximoExterior(),
                            Localidade = repLocalidade.BuscarPorCodigoIBGE(infReceb.enderReceb.cMun.ToInt()),
                            Nome = infReceb.xNome,
                            Numero = infReceb.enderReceb.nro,
                            Pais = pais,
                            Telefone1 = infReceb.fone
                        };

                        repCliente.Inserir(cliente);
                    }

                    Dominio.ObjetosDeValor.CTe.Cliente objCliente = new Dominio.ObjetosDeValor.CTe.Cliente
                    {
                        Bairro = infReceb.enderReceb.xBairro,
                        Cidade = infReceb.enderReceb.xMun,
                        Complemento = infReceb.enderReceb.xCpl,
                        Emails = infReceb.email,
                        Endereco = infReceb.enderReceb.xLgr,
                        RazaoSocial = infReceb.xNome,
                        Numero = infReceb.enderReceb.nro
                    };

                    cte.SetarParticipanteExportacao(objCliente, Dominio.Enumeradores.TipoTomador.Recebedor, pais, cliente.Atividade, cliente.Localidade, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Recebedor);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Recebedor);

                    repParticipante.Deletar(part);
                }
            }

            erro = string.Empty;
            return true;
        }

        private bool SetarRecebedor(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteReceb infReceb, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infReceb != null)
            {
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                double.TryParse(infReceb.Item, out double cpfCnpj);

                if (cpfCnpj > 0D)
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);

                    Dominio.Entidades.Cliente recebedor = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosRecebedor = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (recebedor == null)
                    {
                        recebedor = new Dominio.Entidades.Cliente();

                        recebedor.CPF_CNPJ = cpfCnpj;
                        recebedor.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        recebedor.Bairro = infReceb.enderReceb.xBairro;
                        recebedor.CEP = infReceb.enderReceb.CEP;
                        recebedor.Complemento = infReceb.enderReceb.xCpl;
                        recebedor.DataCadastro = DateTime.Now;
                        recebedor.Email = infReceb.email;
                        recebedor.Endereco = infReceb.enderReceb.xLgr;
                        recebedor.IE_RG = infReceb.IE;
                        recebedor.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infReceb.enderReceb.cMun));

                        if (recebedor.Localidade == null)
                            Servicos.Log.TratarErro($"Localidade não encontrada na base: {infReceb.enderReceb.cMun} - {infReceb.enderReceb.xMun}.");

                        recebedor.Nome = infReceb.xNome;
                        recebedor.Numero = infReceb.enderReceb.nro;
                        recebedor.Telefone1 = Utilidades.String.OnlyNumbers(infReceb.fone);
                        recebedor.Tipo = infReceb.Item.Length == 14 ? "J" : "F";

                        if (recebedor.Tipo == "J" && recebedor.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(recebedor.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                recebedor.GrupoPessoas = grupoPessoas;
                            }
                        }
                        recebedor.Ativo = true;
                        repCliente.Inserir(recebedor);
                    }

                    cte.SetarParticipante(recebedor, Dominio.Enumeradores.TipoTomador.Recebedor, null, dadosRecebedor);
                }
                else
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(infReceb.enderReceb.cPais))
                        pais = repPais.BuscarPorCodigo(infReceb.enderReceb.cPais.ToInt());

                    if (pais == null)
                        pais = repPais.BuscarPorNome(infReceb.enderReceb.xPais);

                    if (pais == null)
                        throw new Exception($"O país ({infReceb.enderReceb.cPais} - {infReceb.enderReceb.xPais}) do recebedor não foi encontrado na base.");

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorNomeEndereco(infReceb.xNome, infReceb.enderReceb.xLgr);

                    if (cliente == null)
                        cliente = repPessoaExteriorOutraDescricao.BuscarPessoaPorRazaoSocialEEndereco(infReceb.xNome, infReceb.enderReceb.xLgr);

                    if (cliente == null && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        erro = $"Não foi encontrada uma pessoa do exterior com o nome {infReceb.xNome} e o endereço {infReceb.enderReceb.xLgr}.";
                        return false;
                    }

                    if (cliente == null)
                    {
                        cliente = new Dominio.Entidades.Cliente()
                        {
                            Tipo = "E",
                            Atividade = ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho),
                            Ativo = true,
                            Bairro = infReceb.enderReceb.xBairro,
                            Cidade = infReceb.enderReceb.xMun,
                            Complemento = infReceb.enderReceb.xCpl,
                            Email = infReceb.email,
                            Endereco = infReceb.enderReceb.xLgr,
                            DataCadastro = DateTime.Now,
                            IE_RG = "ISENTO",
                            IndicadorIE = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte,
                            CPF_CNPJ = repCliente.BuscarPorProximoExterior(),
                            Localidade = repLocalidade.BuscarPorCodigoIBGE(infReceb.enderReceb.cMun.ToInt()),
                            Nome = infReceb.xNome,
                            Numero = infReceb.enderReceb.nro,
                            Pais = pais,
                            Telefone1 = infReceb.fone
                        };

                        repCliente.Inserir(cliente);
                    }

                    Dominio.ObjetosDeValor.CTe.Cliente objCliente = new Dominio.ObjetosDeValor.CTe.Cliente
                    {
                        Bairro = infReceb.enderReceb.xBairro,
                        Cidade = infReceb.enderReceb.xMun,
                        Complemento = infReceb.enderReceb.xCpl,
                        Emails = infReceb.email,
                        Endereco = infReceb.enderReceb.xLgr,
                        RazaoSocial = infReceb.xNome,
                        Numero = infReceb.enderReceb.nro
                    };

                    cte.SetarParticipanteExportacao(objCliente, Dominio.Enumeradores.TipoTomador.Recebedor, pais, cliente.Atividade, cliente.Localidade, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Recebedor);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Recebedor);

                    repParticipante.Deletar(part);
                }
            }

            erro = string.Empty;
            return true;
        }

        private bool SetarRecebedor(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteToma infToma, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infToma != null)
            {
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                double.TryParse(infToma.Item, out double cpfCnpj);

                if (cpfCnpj > 0D)
                {
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);

                    Dominio.Entidades.Cliente tomador = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosTomador = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (tomador == null)
                    {
                        tomador = new Dominio.Entidades.Cliente();

                        tomador.CPF_CNPJ = cpfCnpj;
                        tomador.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        tomador.Bairro = infToma.enderToma.xBairro;
                        tomador.CEP = infToma.enderToma.CEP;
                        tomador.Complemento = infToma.enderToma.xCpl;
                        tomador.DataCadastro = DateTime.Now;
                        tomador.Email = infToma.email;
                        tomador.Endereco = infToma.enderToma.xLgr;
                        tomador.IE_RG = infToma.IE;
                        tomador.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infToma.enderToma.cMun));

                        if (tomador.Localidade == null)
                            Servicos.Log.TratarErro($"Localidade não encontrada na base: {infToma.enderToma.cMun} - {infToma.enderToma.xMun}.");

                        tomador.Nome = infToma.xNome;
                        tomador.NomeFantasia = dadosTomador != null && !string.IsNullOrWhiteSpace(dadosTomador.NomeFantasia) ? dadosTomador.NomeFantasia : infToma.xNome;
                        tomador.Numero = infToma.enderToma.nro;
                        tomador.Telefone1 = Utilidades.String.OnlyNumbers(infToma.fone);
                        tomador.Tipo = infToma.Item.Length == 14 ? "J" : "F";

                        if (tomador.Tipo == "J" && tomador.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(tomador.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                tomador.GrupoPessoas = grupoPessoas;
                            }
                        }
                        tomador.Ativo = true;
                        repCliente.Inserir(tomador);
                    }

                    cte.SetarParticipante(tomador, Dominio.Enumeradores.TipoTomador.Recebedor, null, dadosTomador);
                }
                else
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(infToma.enderToma.cPais))
                        pais = repPais.BuscarPorCodigo(infToma.enderToma.cPais.ToInt());

                    if (pais == null)
                        pais = repPais.BuscarPorNome(infToma.enderToma.xPais);

                    if (pais == null)
                        throw new Exception($"O país ({infToma.enderToma.cPais} - {infToma.enderToma.xPais}) do tomador não foi encontrado na base.");

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorNomeEndereco(infToma.xNome, infToma.enderToma.xLgr);

                    if (cliente == null)
                        cliente = repPessoaExteriorOutraDescricao.BuscarPessoaPorRazaoSocialEEndereco(infToma.xNome, infToma.enderToma.xLgr);

                    if (cliente == null && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        erro = $"Não foi encontrada uma pessoa do exterior com o nome {infToma.xNome} e o endereço {infToma.enderToma.xLgr}.";
                        return false;
                    }

                    if (cliente == null)
                    {
                        cliente = new Dominio.Entidades.Cliente()
                        {
                            Tipo = "E",
                            Atividade = ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho),
                            Ativo = true,
                            Bairro = infToma.enderToma.xBairro,
                            Cidade = infToma.enderToma.xMun,
                            Complemento = infToma.enderToma.xCpl,
                            Email = infToma.email,
                            Endereco = infToma.enderToma.xLgr,
                            DataCadastro = DateTime.Now,
                            IE_RG = "ISENTO",
                            IndicadorIE = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte,
                            CPF_CNPJ = repCliente.BuscarPorProximoExterior(),
                            Localidade = repLocalidade.BuscarPorCodigoIBGE(infToma.enderToma.cMun.ToInt()),
                            Nome = infToma.xNome,
                            Numero = infToma.enderToma.nro,
                            Pais = pais,
                            Telefone1 = infToma.fone
                        };

                        repCliente.Inserir(cliente);
                    }

                    Dominio.ObjetosDeValor.CTe.Cliente objCliente = new Dominio.ObjetosDeValor.CTe.Cliente
                    {
                        Bairro = infToma.enderToma.xBairro,
                        Cidade = infToma.enderToma.xMun,
                        Complemento = infToma.enderToma.xCpl,
                        Emails = infToma.email,
                        Endereco = infToma.enderToma.xLgr,
                        RazaoSocial = infToma.xNome,
                        Numero = infToma.enderToma.nro
                    };

                    cte.SetarParticipanteExportacao(objCliente, Dominio.Enumeradores.TipoTomador.Recebedor, pais, cliente.Atividade, cliente.Localidade, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Recebedor);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Recebedor);

                    repParticipante.Deletar(part);
                }
            }

            erro = string.Empty;
            return true;
        }

        private void SetarRecebedor(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v200.Envio.TCTeInfCteReceb infReceb, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infReceb != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infReceb.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente recebedor = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosRecebedor = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (recebedor == null)
                    {
                        recebedor = new Dominio.Entidades.Cliente();

                        recebedor.CPF_CNPJ = cpfCnpj;
                        recebedor.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        recebedor.Bairro = infReceb.enderReceb.xBairro;
                        recebedor.CEP = infReceb.enderReceb.CEP;
                        recebedor.Complemento = infReceb.enderReceb.xCpl;
                        recebedor.DataCadastro = DateTime.Now;
                        recebedor.Email = infReceb.email;
                        recebedor.Endereco = infReceb.enderReceb.xLgr;
                        recebedor.IE_RG = infReceb.IE;
                        recebedor.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infReceb.enderReceb.cMun));
                        recebedor.Nome = infReceb.xNome;
                        recebedor.Numero = infReceb.enderReceb.nro;
                        recebedor.Telefone1 = Utilidades.String.OnlyNumbers(infReceb.fone);
                        recebedor.Tipo = infReceb.Item.Length == 14 ? "J" : "F";

                        if (recebedor.Tipo == "J" && recebedor.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(recebedor.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                recebedor.GrupoPessoas = grupoPessoas;
                            }
                        }
                        recebedor.Ativo = true;
                        repCliente.Inserir(recebedor);
                    }

                    cte.SetarParticipante(recebedor, Dominio.Enumeradores.TipoTomador.Recebedor, null, dadosRecebedor);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(int.Parse(infReceb.enderReceb.cPais));

                    if (pais == null)
                        throw new Exception("O país do recebedor é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infReceb.enderReceb.xBairro;
                    cliente.Cidade = infReceb.enderReceb.xMun;
                    cliente.Complemento = infReceb.enderReceb.xCpl;
                    cliente.Emails = infReceb.email;
                    cliente.Endereco = infReceb.enderReceb.xLgr;
                    cliente.RazaoSocial = infReceb.xNome;
                    cliente.Numero = infReceb.enderReceb.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Recebedor, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Recebedor);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Recebedor);

                    repParticipante.Deletar(part);
                }
            }
        }

        private void SetarRemetente(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteRem infRem, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infRem != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infRem.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente remetente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosRemetente = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (remetente == null)
                    {
                        remetente = new Dominio.Entidades.Cliente();

                        remetente.CPF_CNPJ = cpfCnpj;
                        remetente.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        remetente.Bairro = infRem.enderReme.xBairro;
                        remetente.CEP = infRem.enderReme.CEP;
                        remetente.Complemento = infRem.enderReme.xCpl;
                        remetente.DataCadastro = DateTime.Now;
                        remetente.Email = infRem.email;
                        remetente.Endereco = infRem.enderReme.xLgr;
                        remetente.IE_RG = infRem.IE;
                        remetente.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infRem.enderReme.cMun));
                        remetente.Nome = infRem.xNome;
                        remetente.NomeFantasia = dadosRemetente != null && !string.IsNullOrWhiteSpace(dadosRemetente.NomeFantasia) ? dadosRemetente.NomeFantasia : infRem.xFant;
                        remetente.Numero = infRem.enderReme.nro;
                        remetente.Telefone1 = Utilidades.String.OnlyNumbers(infRem.fone);
                        remetente.Tipo = infRem.Item.Length == 14 ? "J" : "F";

                        if (remetente.Tipo == "J" && remetente.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(remetente.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                remetente.GrupoPessoas = grupoPessoas;
                            }
                        }
                        remetente.Ativo = true;
                        repCliente.Inserir(remetente);
                    }

                    cte.SetarParticipante(remetente, Dominio.Enumeradores.TipoTomador.Remetente, null, dadosRemetente);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(int.Parse(infRem.enderReme.cPais));

                    if (pais == null)
                        throw new Exception("O país do remetente é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infRem.enderReme.xBairro;
                    cliente.Cidade = infRem.enderReme.xMun;
                    cliente.Complemento = infRem.enderReme.xCpl;
                    cliente.Emails = infRem.email;
                    cliente.Endereco = infRem.enderReme.xLgr;
                    cliente.RazaoSocial = infRem.xNome;
                    cliente.Numero = infRem.enderReme.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Remetente, repPais.BuscarPorCodigo(int.Parse(infRem.enderReme.cPais)));
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Remetente);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Remetente);

                    repParticipante.Deletar(part);
                }
            }
        }

        private void SetarRemetente(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteRem infRem, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infRem != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infRem.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente remetente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosRemetente = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (remetente == null)
                    {
                        remetente = new Dominio.Entidades.Cliente();
                        remetente.CPF_CNPJ = cpfCnpj;
                        remetente.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        remetente.Bairro = infRem.enderReme.xBairro;
                        remetente.CEP = infRem.enderReme.CEP;
                        remetente.Complemento = infRem.enderReme.xCpl;
                        remetente.DataCadastro = DateTime.Now;
                        remetente.Email = infRem.email;
                        remetente.Endereco = infRem.enderReme.xLgr;
                        remetente.IE_RG = infRem.IE;
                        remetente.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infRem.enderReme.cMun));
                        remetente.Nome = infRem.xNome;
                        remetente.NomeFantasia = dadosRemetente != null && !string.IsNullOrWhiteSpace(dadosRemetente.NomeFantasia) ? dadosRemetente.NomeFantasia : infRem.xFant;
                        remetente.Numero = infRem.enderReme.nro;
                        remetente.Telefone1 = Utilidades.String.OnlyNumbers(infRem.fone);
                        remetente.Tipo = infRem.Item.Length == 14 ? "J" : "F";

                        if (remetente.Tipo == "J" && remetente.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(remetente.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                remetente.GrupoPessoas = grupoPessoas;
                            }
                        }
                        remetente.Ativo = true;
                        repCliente.Inserir(remetente);
                    }

                    cte.SetarParticipante(remetente, Dominio.Enumeradores.TipoTomador.Remetente, null, dadosRemetente);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(int.Parse(infRem.enderReme.cPais));

                    if (pais == null)
                        throw new Exception("O país do remetente é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infRem.enderReme.xBairro;
                    cliente.Cidade = infRem.enderReme.xMun;
                    cliente.Complemento = infRem.enderReme.xCpl;
                    cliente.Emails = infRem.email;
                    cliente.Endereco = infRem.enderReme.xLgr;
                    cliente.RazaoSocial = infRem.xNome;
                    cliente.Numero = infRem.enderReme.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Remetente, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Remetente);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Remetente);

                    repParticipante.Deletar(part);
                }
            }
        }

        private bool SetarRemetente(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteRem infRem, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infRem != null)
            {
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);

                double.TryParse(infRem.Item, out double cpfCnpj);

                if (cpfCnpj > 0D)
                {
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);

                    Dominio.Entidades.Cliente remetente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosRemetente = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (remetente == null)
                    {
                        remetente = new Dominio.Entidades.Cliente();
                        remetente.CPF_CNPJ = cpfCnpj;
                        remetente.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        remetente.Bairro = infRem.enderReme.xBairro;
                        remetente.CEP = infRem.enderReme.CEP;
                        remetente.Complemento = infRem.enderReme.xCpl;
                        remetente.DataCadastro = DateTime.Now;
                        remetente.Email = infRem.email;
                        remetente.Endereco = infRem.enderReme.xLgr;
                        remetente.IE_RG = infRem.IE;
                        remetente.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infRem.enderReme.cMun));

                        if (remetente.Localidade == null)
                            Servicos.Log.TratarErro($"Localidade não encontrada na base: {infRem.enderReme.cMun} - {infRem.enderReme.xMun}.");

                        remetente.Nome = infRem.xNome;
                        remetente.NomeFantasia = dadosRemetente != null && !string.IsNullOrWhiteSpace(dadosRemetente.NomeFantasia) ? dadosRemetente.NomeFantasia : infRem.xFant;
                        remetente.Numero = infRem.enderReme.nro;
                        remetente.Telefone1 = Utilidades.String.OnlyNumbers(infRem.fone);
                        remetente.Tipo = infRem.Item.Length == 14 ? "J" : "F";

                        if (remetente.Tipo == "J" && remetente.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(remetente.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                remetente.GrupoPessoas = grupoPessoas;
                            }
                        }
                        remetente.Ativo = true;
                        repCliente.Inserir(remetente);
                    }

                    cte.SetarParticipante(remetente, Dominio.Enumeradores.TipoTomador.Remetente, null, dadosRemetente);
                }
                else
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(infRem.enderReme.cPais))
                        pais = repPais.BuscarPorCodigo(infRem.enderReme.cPais.ToInt());

                    if (pais == null)
                        pais = repPais.BuscarPorNome(infRem.enderReme.xPais.ToUpper());

                    if (pais == null)
                        throw new Exception($"O país ({infRem.enderReme.cPais} - {infRem.enderReme.xPais}) do destinatário não foi encontrado na base.");

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorNomeEndereco(infRem.xNome, infRem.enderReme.xLgr);

                    if (cliente == null)
                        cliente = repPessoaExteriorOutraDescricao.BuscarPessoaPorRazaoSocialEEndereco(infRem.xNome, infRem.enderReme.xLgr);

                    if (cliente == null && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        erro = $"Não foi encontrada uma pessoa do exterior com o nome {infRem.xNome} e o endereço {infRem.enderReme.xLgr}.";
                        return false;
                    }

                    if (cliente == null)
                    {
                        cliente = new Dominio.Entidades.Cliente()
                        {
                            Tipo = "E",
                            Atividade = ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho),
                            Ativo = true,
                            Bairro = infRem.enderReme.xBairro,
                            Cidade = infRem.enderReme.xMun,
                            Complemento = infRem.enderReme.xCpl,
                            Email = infRem.email,
                            Endereco = infRem.enderReme.xLgr,
                            DataCadastro = DateTime.Now,
                            IE_RG = "ISENTO",
                            IndicadorIE = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte,
                            CPF_CNPJ = repCliente.BuscarPorProximoExterior(),
                            Localidade = repLocalidade.BuscarPorCodigoIBGE(infRem.enderReme.cMun.ToInt()),
                            Nome = infRem.xNome,
                            Numero = infRem.enderReme.nro,
                            Pais = pais,
                            Telefone1 = infRem.fone
                        };

                        repCliente.Inserir(cliente);
                    }

                    Dominio.ObjetosDeValor.CTe.Cliente objCliente = new Dominio.ObjetosDeValor.CTe.Cliente
                    {
                        Bairro = infRem.enderReme.xBairro,
                        Cidade = infRem.enderReme.xMun,
                        Complemento = infRem.enderReme.xCpl,
                        Emails = infRem.email,
                        Endereco = infRem.enderReme.xLgr,
                        RazaoSocial = infRem.xNome,
                        Numero = infRem.enderReme.nro
                    };

                    cte.SetarParticipanteExportacao(objCliente, Dominio.Enumeradores.TipoTomador.Remetente, pais, cliente.Atividade, cliente.Localidade, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Remetente);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Remetente);

                    repParticipante.Deletar(part);
                }
            }

            erro = string.Empty;
            return true;
        }

        private bool SetarRemetente(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteRem infRem, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infRem != null)
            {
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);

                double.TryParse(infRem.Item, out double cpfCnpj);

                if (cpfCnpj > 0D)
                {
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);

                    Dominio.Entidades.Cliente remetente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosRemetente = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (remetente == null)
                    {
                        remetente = new Dominio.Entidades.Cliente();
                        remetente.CPF_CNPJ = cpfCnpj;
                        remetente.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        remetente.Bairro = infRem.enderReme.xBairro;
                        remetente.CEP = infRem.enderReme.CEP;
                        remetente.Complemento = infRem.enderReme.xCpl;
                        remetente.DataCadastro = DateTime.Now;
                        remetente.Email = infRem.email;
                        remetente.Endereco = infRem.enderReme.xLgr;
                        remetente.IE_RG = infRem.IE;
                        remetente.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infRem.enderReme.cMun));

                        if (remetente.Localidade == null)
                            Servicos.Log.TratarErro($"Localidade não encontrada na base: {infRem.enderReme.cMun} - {infRem.enderReme.xMun}.");

                        remetente.Nome = infRem.xNome;
                        remetente.NomeFantasia = dadosRemetente != null && !string.IsNullOrWhiteSpace(dadosRemetente.NomeFantasia) ? dadosRemetente.NomeFantasia : infRem.xFant;
                        remetente.Numero = infRem.enderReme.nro;
                        remetente.Telefone1 = Utilidades.String.OnlyNumbers(infRem.fone);
                        remetente.Tipo = infRem.Item.Length == 14 ? "J" : "F";

                        if (remetente.Tipo == "J" && remetente.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(remetente.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                remetente.GrupoPessoas = grupoPessoas;
                            }
                        }
                        remetente.Ativo = true;
                        repCliente.Inserir(remetente);
                    }

                    cte.SetarParticipante(remetente, Dominio.Enumeradores.TipoTomador.Remetente, null, dadosRemetente);
                }
                else
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(infRem.enderReme.cPais))
                        pais = repPais.BuscarPorCodigo(infRem.enderReme.cPais.ToInt());

                    if (pais == null)
                        pais = repPais.BuscarPorNome(infRem.enderReme.xPais.ToUpper());

                    if (pais == null)
                        throw new Exception($"O país ({infRem.enderReme.cPais} - {infRem.enderReme.xPais}) do destinatário não foi encontrado na base.");

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorNomeEndereco(infRem.xNome, infRem.enderReme.xLgr);

                    if (cliente == null)
                        cliente = repPessoaExteriorOutraDescricao.BuscarPessoaPorRazaoSocialEEndereco(infRem.xNome, infRem.enderReme.xLgr);

                    if (cliente == null && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        erro = $"Não foi encontrada uma pessoa do exterior com o nome {infRem.xNome} e o endereço {infRem.enderReme.xLgr}.";
                        return false;
                    }

                    if (cliente == null)
                    {
                        cliente = new Dominio.Entidades.Cliente()
                        {
                            Tipo = "E",
                            Atividade = ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho),
                            Ativo = true,
                            Bairro = infRem.enderReme.xBairro,
                            Cidade = infRem.enderReme.xMun,
                            Complemento = infRem.enderReme.xCpl,
                            Email = infRem.email,
                            Endereco = infRem.enderReme.xLgr,
                            DataCadastro = DateTime.Now,
                            IE_RG = "ISENTO",
                            IndicadorIE = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte,
                            CPF_CNPJ = repCliente.BuscarPorProximoExterior(),
                            Localidade = repLocalidade.BuscarPorCodigoIBGE(infRem.enderReme.cMun.ToInt()),
                            Nome = infRem.xNome,
                            Numero = infRem.enderReme.nro,
                            Pais = pais,
                            Telefone1 = infRem.fone
                        };

                        repCliente.Inserir(cliente);
                    }

                    Dominio.ObjetosDeValor.CTe.Cliente objCliente = new Dominio.ObjetosDeValor.CTe.Cliente
                    {
                        Bairro = infRem.enderReme.xBairro,
                        Cidade = infRem.enderReme.xMun,
                        Complemento = infRem.enderReme.xCpl,
                        Emails = infRem.email,
                        Endereco = infRem.enderReme.xLgr,
                        RazaoSocial = infRem.xNome,
                        Numero = infRem.enderReme.nro
                    };

                    cte.SetarParticipanteExportacao(objCliente, Dominio.Enumeradores.TipoTomador.Remetente, pais, cliente.Atividade, cliente.Localidade, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Remetente);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Remetente);

                    repParticipante.Deletar(part);
                }
            }

            erro = string.Empty;
            return true;
        }

        private bool SetarRemetente(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteToma infToma, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infToma != null)
            {
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                double.TryParse(infToma.Item, out double cpfCnpj);

                if (cpfCnpj > 0D)
                {
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);

                    Dominio.Entidades.Cliente tomador = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosTomador = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (tomador == null)
                    {
                        tomador = new Dominio.Entidades.Cliente();

                        tomador.CPF_CNPJ = cpfCnpj;
                        tomador.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        tomador.Bairro = infToma.enderToma.xBairro;
                        tomador.CEP = infToma.enderToma.CEP;
                        tomador.Complemento = infToma.enderToma.xCpl;
                        tomador.DataCadastro = DateTime.Now;
                        tomador.Email = infToma.email;
                        tomador.Endereco = infToma.enderToma.xLgr;
                        tomador.IE_RG = infToma.IE;
                        tomador.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infToma.enderToma.cMun));

                        if (tomador.Localidade == null)
                            Servicos.Log.TratarErro($"Localidade não encontrada na base: {infToma.enderToma.cMun} - {infToma.enderToma.xMun}.");

                        tomador.Nome = infToma.xNome;
                        tomador.NomeFantasia = dadosTomador != null && !string.IsNullOrWhiteSpace(dadosTomador.NomeFantasia) ? dadosTomador.NomeFantasia : infToma.xNome;
                        tomador.Numero = infToma.enderToma.nro;
                        tomador.Telefone1 = Utilidades.String.OnlyNumbers(infToma.fone);
                        tomador.Tipo = infToma.Item.Length == 14 ? "J" : "F";

                        if (tomador.Tipo == "J" && tomador.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(tomador.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                tomador.GrupoPessoas = grupoPessoas;
                            }
                        }
                        tomador.Ativo = true;
                        repCliente.Inserir(tomador);
                    }

                    cte.SetarParticipante(tomador, Dominio.Enumeradores.TipoTomador.Remetente, null, dadosTomador);
                }
                else
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(infToma.enderToma.cPais))
                        pais = repPais.BuscarPorCodigo(infToma.enderToma.cPais.ToInt());

                    if (pais == null)
                        pais = repPais.BuscarPorNome(infToma.enderToma.xPais);

                    if (pais == null)
                        throw new Exception($"O país ({infToma.enderToma.cPais} - {infToma.enderToma.xPais}) do tomador não foi encontrado na base.");

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorNomeEndereco(infToma.xNome, infToma.enderToma.xLgr);

                    if (cliente == null)
                        cliente = repPessoaExteriorOutraDescricao.BuscarPessoaPorRazaoSocialEEndereco(infToma.xNome, infToma.enderToma.xLgr);

                    if (cliente == null && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        erro = $"Não foi encontrada uma pessoa do exterior com o nome {infToma.xNome} e o endereço {infToma.enderToma.xLgr}.";
                        return false;
                    }

                    if (cliente == null)
                    {
                        cliente = new Dominio.Entidades.Cliente()
                        {
                            Tipo = "E",
                            Atividade = ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho),
                            Ativo = true,
                            Bairro = infToma.enderToma.xBairro,
                            Cidade = infToma.enderToma.xMun,
                            Complemento = infToma.enderToma.xCpl,
                            Email = infToma.email,
                            Endereco = infToma.enderToma.xLgr,
                            DataCadastro = DateTime.Now,
                            IE_RG = "ISENTO",
                            IndicadorIE = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte,
                            CPF_CNPJ = repCliente.BuscarPorProximoExterior(),
                            Localidade = repLocalidade.BuscarPorCodigoIBGE(infToma.enderToma.cMun.ToInt()),
                            Nome = infToma.xNome,
                            Numero = infToma.enderToma.nro,
                            Pais = pais,
                            Telefone1 = infToma.fone
                        };

                        repCliente.Inserir(cliente);
                    }

                    Dominio.ObjetosDeValor.CTe.Cliente objCliente = new Dominio.ObjetosDeValor.CTe.Cliente
                    {
                        Bairro = infToma.enderToma.xBairro,
                        Cidade = infToma.enderToma.xMun,
                        Complemento = infToma.enderToma.xCpl,
                        Emails = infToma.email,
                        Endereco = infToma.enderToma.xLgr,
                        RazaoSocial = infToma.xNome,
                        Numero = infToma.enderToma.nro
                    };

                    cte.SetarParticipanteExportacao(objCliente, Dominio.Enumeradores.TipoTomador.Remetente, pais, cliente.Atividade, cliente.Localidade, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Remetente);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Remetente);

                    repParticipante.Deletar(part);
                }
            }

            erro = string.Empty;
            return true;
        }

        private void SetarRemetente(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v200.Envio.TCTeInfCteRem infRem, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infRem != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infRem.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente remetente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosRemetente = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (remetente == null)
                    {
                        remetente = new Dominio.Entidades.Cliente();
                        remetente.CPF_CNPJ = cpfCnpj;
                        remetente.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        remetente.Bairro = infRem.enderReme.xBairro;
                        remetente.CEP = infRem.enderReme.CEP;
                        remetente.Complemento = infRem.enderReme.xCpl;
                        remetente.DataCadastro = DateTime.Now;
                        remetente.Email = infRem.email;
                        remetente.Endereco = infRem.enderReme.xLgr;
                        remetente.IE_RG = infRem.IE;
                        remetente.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infRem.enderReme.cMun));
                        remetente.Nome = infRem.xNome;
                        remetente.NomeFantasia = dadosRemetente != null && !string.IsNullOrWhiteSpace(dadosRemetente.NomeFantasia) ? dadosRemetente.NomeFantasia : infRem.xFant;
                        remetente.Numero = infRem.enderReme.nro;
                        remetente.Telefone1 = Utilidades.String.OnlyNumbers(infRem.fone);
                        remetente.Tipo = infRem.Item.Length == 14 ? "J" : "F";

                        if (remetente.Tipo == "J" && remetente.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(remetente.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                remetente.GrupoPessoas = grupoPessoas;
                            }
                        }
                        remetente.Ativo = true;
                        repCliente.Inserir(remetente);
                    }

                    cte.SetarParticipante(remetente, Dominio.Enumeradores.TipoTomador.Remetente, null, dadosRemetente);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(int.Parse(infRem.enderReme.cPais));

                    if (pais == null)
                        throw new Exception("O país do remetente é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infRem.enderReme.xBairro;
                    cliente.Cidade = infRem.enderReme.xMun;
                    cliente.Complemento = infRem.enderReme.xCpl;
                    cliente.Emails = infRem.email;
                    cliente.Endereco = infRem.enderReme.xLgr;
                    cliente.RazaoSocial = infRem.xNome;
                    cliente.Numero = infRem.enderReme.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Remetente, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Remetente);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Remetente);

                    repParticipante.Deletar(part);
                }
            }
        }

        private void SetarTomador(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteIdeToma4 infToma, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infToma != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infToma.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente tomador = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosTomador = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (tomador == null)
                    {
                        tomador = new Dominio.Entidades.Cliente();

                        tomador.CPF_CNPJ = cpfCnpj;
                        tomador.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        tomador.Bairro = infToma.enderToma.xBairro;
                        tomador.CEP = infToma.enderToma.CEP;
                        tomador.Complemento = infToma.enderToma.xCpl;
                        tomador.DataCadastro = DateTime.Now;
                        tomador.Email = infToma.email;
                        tomador.Endereco = infToma.enderToma.xLgr;
                        tomador.IE_RG = infToma.IE;
                        tomador.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infToma.enderToma.cMun));
                        tomador.Nome = infToma.xNome;
                        tomador.NomeFantasia = dadosTomador != null && !string.IsNullOrWhiteSpace(dadosTomador.NomeFantasia) ? dadosTomador.NomeFantasia : infToma.xFant;
                        tomador.Numero = infToma.enderToma.nro;
                        tomador.Telefone1 = Utilidades.String.OnlyNumbers(infToma.fone);
                        tomador.Tipo = infToma.Item.Length == 14 ? "J" : "F";

                        if (tomador.Tipo == "J" && tomador.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(tomador.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                tomador.GrupoPessoas = grupoPessoas;
                            }
                        }
                        tomador.Ativo = true;
                        repCliente.Inserir(tomador);
                    }

                    cte.SetarParticipante(tomador, Dominio.Enumeradores.TipoTomador.Outros, null, dadosTomador);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(int.Parse(infToma.enderToma.cPais));

                    if (pais == null)
                        throw new Exception("O país do tomador é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infToma.enderToma.xBairro;
                    cliente.Cidade = infToma.enderToma.xMun;
                    cliente.Complemento = infToma.enderToma.xCpl;
                    cliente.Emails = infToma.email;
                    cliente.Endereco = infToma.enderToma.xLgr;
                    cliente.RazaoSocial = infToma.xNome;
                    cliente.Numero = infToma.enderToma.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Outros, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Outros);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Outros);

                    repParticipante.Deletar(part);
                }
            }
        }

        private void SetarTomador(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteIdeToma4 infToma, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infToma != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infToma.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente tomador = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosTomador = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (tomador == null)
                    {
                        tomador = new Dominio.Entidades.Cliente();

                        tomador.CPF_CNPJ = cpfCnpj;
                        tomador.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        tomador.Bairro = infToma.enderToma.xBairro;
                        tomador.CEP = infToma.enderToma.CEP;
                        tomador.Complemento = infToma.enderToma.xCpl;
                        tomador.DataCadastro = DateTime.Now;
                        tomador.Email = infToma.email;
                        tomador.Endereco = infToma.enderToma.xLgr;
                        tomador.IE_RG = infToma.IE;
                        tomador.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infToma.enderToma.cMun));
                        tomador.Nome = infToma.xNome;
                        tomador.NomeFantasia = dadosTomador != null && !string.IsNullOrWhiteSpace(dadosTomador.NomeFantasia) ? dadosTomador.NomeFantasia : infToma.xFant;
                        tomador.Numero = infToma.enderToma.nro;
                        tomador.Telefone1 = Utilidades.String.OnlyNumbers(infToma.fone);
                        tomador.Tipo = infToma.Item.Length == 14 ? "J" : "F";

                        if (tomador.Tipo == "J" && tomador.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(tomador.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                tomador.GrupoPessoas = grupoPessoas;
                            }
                        }
                        tomador.Ativo = true;
                        repCliente.Inserir(tomador);
                    }

                    cte.SetarParticipante(tomador, Dominio.Enumeradores.TipoTomador.Outros, null, dadosTomador);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(int.Parse(infToma.enderToma.cPais));

                    if (pais == null)
                        throw new Exception("O país do tomador é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infToma.enderToma.xBairro;
                    cliente.Cidade = infToma.enderToma.xMun;
                    cliente.Complemento = infToma.enderToma.xCpl;
                    cliente.Emails = infToma.email;
                    cliente.Endereco = infToma.enderToma.xLgr;
                    cliente.RazaoSocial = infToma.xNome;
                    cliente.Numero = infToma.enderToma.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Outros, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Outros);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Outros);

                    repParticipante.Deletar(part);
                }
            }
        }

        private bool SetarTomador(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteIdeToma4 infToma, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infToma != null)
            {
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                double.TryParse(infToma.Item, out double cpfCnpj);

                if (cpfCnpj > 0D)
                {
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);

                    Dominio.Entidades.Cliente tomador = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosTomador = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (tomador == null)
                    {
                        tomador = new Dominio.Entidades.Cliente();

                        tomador.CPF_CNPJ = cpfCnpj;
                        tomador.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        tomador.Bairro = infToma.enderToma.xBairro;
                        tomador.CEP = infToma.enderToma.CEP;
                        tomador.Complemento = infToma.enderToma.xCpl;
                        tomador.DataCadastro = DateTime.Now;
                        tomador.Email = infToma.email;
                        tomador.Endereco = infToma.enderToma.xLgr;
                        tomador.IE_RG = infToma.IE;
                        tomador.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infToma.enderToma.cMun));

                        if (tomador.Localidade == null)
                            Servicos.Log.TratarErro($"Localidade não encontrada na base: {infToma.enderToma.cMun} - {infToma.enderToma.xMun}.");

                        tomador.Nome = infToma.xNome;
                        tomador.NomeFantasia = dadosTomador != null && !string.IsNullOrWhiteSpace(dadosTomador.NomeFantasia) ? dadosTomador.NomeFantasia : infToma.xFant;
                        tomador.Numero = infToma.enderToma.nro;
                        tomador.Telefone1 = Utilidades.String.OnlyNumbers(infToma.fone);
                        tomador.Tipo = infToma.Item.Length == 14 ? "J" : "F";

                        if (tomador.Tipo == "J" && tomador.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(tomador.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                tomador.GrupoPessoas = grupoPessoas;
                            }
                        }
                        tomador.Ativo = true;
                        repCliente.Inserir(tomador);
                    }

                    cte.SetarParticipante(tomador, Dominio.Enumeradores.TipoTomador.Outros, null, dadosTomador);
                }
                else
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(infToma.enderToma.cPais))
                        pais = repPais.BuscarPorCodigo(infToma.enderToma.cPais.ToInt());

                    if (pais == null)
                        pais = repPais.BuscarPorNome(infToma.enderToma.xPais);

                    if (pais == null)
                        throw new Exception($"O país ({infToma.enderToma.cPais} - {infToma.enderToma.xPais}) do tomador não foi encontrado na base.");

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorNomeEndereco(infToma.xNome, infToma.enderToma.xLgr);

                    if (cliente == null)
                        cliente = repPessoaExteriorOutraDescricao.BuscarPessoaPorRazaoSocialEEndereco(infToma.xNome, infToma.enderToma.xLgr);

                    if (cliente == null && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        erro = $"Não foi encontrada uma pessoa do exterior com o nome {infToma.xNome} e o endereço {infToma.enderToma.xLgr}.";
                        return false;
                    }

                    if (cliente == null)
                    {
                        cliente = new Dominio.Entidades.Cliente()
                        {
                            Tipo = "E",
                            Atividade = ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho),
                            Ativo = true,
                            Bairro = infToma.enderToma.xBairro,
                            Cidade = infToma.enderToma.xMun,
                            Complemento = infToma.enderToma.xCpl,
                            Email = infToma.email,
                            Endereco = infToma.enderToma.xLgr,
                            DataCadastro = DateTime.Now,
                            IE_RG = "ISENTO",
                            IndicadorIE = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte,
                            CPF_CNPJ = repCliente.BuscarPorProximoExterior(),
                            Localidade = repLocalidade.BuscarPorCodigoIBGE(infToma.enderToma.cMun.ToInt()),
                            Nome = infToma.xNome,
                            Numero = infToma.enderToma.nro,
                            Pais = pais,
                            Telefone1 = infToma.fone
                        };

                        repCliente.Inserir(cliente);
                    }

                    Dominio.ObjetosDeValor.CTe.Cliente objCliente = new Dominio.ObjetosDeValor.CTe.Cliente
                    {
                        Bairro = infToma.enderToma.xBairro,
                        Cidade = infToma.enderToma.xMun,
                        Complemento = infToma.enderToma.xCpl,
                        Emails = infToma.email,
                        Endereco = infToma.enderToma.xLgr,
                        RazaoSocial = infToma.xNome,
                        Numero = infToma.enderToma.nro
                    };

                    cte.SetarParticipanteExportacao(objCliente, Dominio.Enumeradores.TipoTomador.Outros, pais, cliente.Atividade, cliente.Localidade, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Outros);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Outros);

                    repParticipante.Deletar(part);
                }
            }

            erro = string.Empty;
            return true;
        }

        private bool SetarTomador(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteIdeToma4 infToma, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infToma != null)
            {
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                double.TryParse(infToma.Item, out double cpfCnpj);

                if (cpfCnpj > 0D)
                {
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);

                    Dominio.Entidades.Cliente tomador = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosTomador = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (tomador == null)
                    {
                        tomador = new Dominio.Entidades.Cliente();

                        tomador.CPF_CNPJ = cpfCnpj;
                        tomador.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        tomador.Bairro = infToma.enderToma.xBairro;
                        tomador.CEP = infToma.enderToma.CEP;
                        tomador.Complemento = infToma.enderToma.xCpl;
                        tomador.DataCadastro = DateTime.Now;
                        tomador.Email = infToma.email;
                        tomador.Endereco = infToma.enderToma.xLgr;
                        tomador.IE_RG = infToma.IE;
                        tomador.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infToma.enderToma.cMun));

                        if (tomador.Localidade == null)
                            Servicos.Log.TratarErro($"Localidade não encontrada na base: {infToma.enderToma.cMun} - {infToma.enderToma.xMun}.");

                        tomador.Nome = infToma.xNome;
                        tomador.NomeFantasia = dadosTomador != null && !string.IsNullOrWhiteSpace(dadosTomador.NomeFantasia) ? dadosTomador.NomeFantasia : infToma.xFant;
                        tomador.Numero = infToma.enderToma.nro;
                        tomador.Telefone1 = Utilidades.String.OnlyNumbers(infToma.fone);
                        tomador.Tipo = infToma.Item.Length == 14 ? "J" : "F";

                        if (tomador.Tipo == "J" && tomador.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(tomador.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                tomador.GrupoPessoas = grupoPessoas;
                            }
                        }
                        tomador.Ativo = true;
                        repCliente.Inserir(tomador);
                    }

                    cte.SetarParticipante(tomador, Dominio.Enumeradores.TipoTomador.Outros, null, dadosTomador);
                }
                else
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(infToma.enderToma.cPais))
                        pais = repPais.BuscarPorCodigo(infToma.enderToma.cPais.ToInt());

                    if (pais == null)
                        pais = repPais.BuscarPorNome(infToma.enderToma.xPais);

                    if (pais == null)
                        throw new Exception($"O país ({infToma.enderToma.cPais} - {infToma.enderToma.xPais}) do tomador não foi encontrado na base.");

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorNomeEndereco(infToma.xNome, infToma.enderToma.xLgr);

                    if (cliente == null)
                        cliente = repPessoaExteriorOutraDescricao.BuscarPessoaPorRazaoSocialEEndereco(infToma.xNome, infToma.enderToma.xLgr);

                    if (cliente == null && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        erro = $"Não foi encontrada uma pessoa do exterior com o nome {infToma.xNome} e o endereço {infToma.enderToma.xLgr}.";
                        return false;
                    }

                    if (cliente == null)
                    {
                        cliente = new Dominio.Entidades.Cliente()
                        {
                            Tipo = "E",
                            Atividade = ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho),
                            Ativo = true,
                            Bairro = infToma.enderToma.xBairro,
                            Cidade = infToma.enderToma.xMun,
                            Complemento = infToma.enderToma.xCpl,
                            Email = infToma.email,
                            Endereco = infToma.enderToma.xLgr,
                            DataCadastro = DateTime.Now,
                            IE_RG = "ISENTO",
                            IndicadorIE = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte,
                            CPF_CNPJ = repCliente.BuscarPorProximoExterior(),
                            Localidade = repLocalidade.BuscarPorCodigoIBGE(infToma.enderToma.cMun.ToInt()),
                            Nome = infToma.xNome,
                            Numero = infToma.enderToma.nro,
                            Pais = pais,
                            Telefone1 = infToma.fone
                        };

                        repCliente.Inserir(cliente);
                    }

                    Dominio.ObjetosDeValor.CTe.Cliente objCliente = new Dominio.ObjetosDeValor.CTe.Cliente
                    {
                        Bairro = infToma.enderToma.xBairro,
                        Cidade = infToma.enderToma.xMun,
                        Complemento = infToma.enderToma.xCpl,
                        Emails = infToma.email,
                        Endereco = infToma.enderToma.xLgr,
                        RazaoSocial = infToma.xNome,
                        Numero = infToma.enderToma.nro
                    };

                    cte.SetarParticipanteExportacao(objCliente, Dominio.Enumeradores.TipoTomador.Outros, pais, cliente.Atividade, cliente.Localidade, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Outros);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Outros);

                    repParticipante.Deletar(part);
                }
            }

            erro = string.Empty;
            return true;
        }

        private bool SetarTomador(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteToma infToma, Repositorio.UnitOfWork unidadeTrabalho, out string erro, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (infToma != null)
            {
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                double.TryParse(infToma.Item, out double cpfCnpj);

                if (cpfCnpj > 0D)
                {
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);

                    Dominio.Entidades.Cliente tomador = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosTomador = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (tomador == null)
                    {
                        tomador = new Dominio.Entidades.Cliente();

                        tomador.CPF_CNPJ = cpfCnpj;
                        tomador.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        tomador.Bairro = infToma.enderToma.xBairro;
                        tomador.CEP = infToma.enderToma.CEP;
                        tomador.Complemento = infToma.enderToma.xCpl;
                        tomador.DataCadastro = DateTime.Now;
                        tomador.Email = infToma.email;
                        tomador.Endereco = infToma.enderToma.xLgr;
                        tomador.IE_RG = infToma.IE;
                        tomador.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infToma.enderToma.cMun));

                        if (tomador.Localidade == null)
                            Servicos.Log.TratarErro($"Localidade não encontrada na base: {infToma.enderToma.cMun} - {infToma.enderToma.xMun}.");

                        tomador.Nome = infToma.xNome;
                        tomador.NomeFantasia = dadosTomador != null && !string.IsNullOrWhiteSpace(dadosTomador.NomeFantasia) ? dadosTomador.NomeFantasia : infToma.xNome;
                        tomador.Numero = infToma.enderToma.nro;
                        tomador.Telefone1 = Utilidades.String.OnlyNumbers(infToma.fone);
                        tomador.Tipo = infToma.Item.Length == 14 ? "J" : "F";

                        if (tomador.Tipo == "J" && tomador.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(tomador.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                tomador.GrupoPessoas = grupoPessoas;
                            }
                        }
                        tomador.Ativo = true;
                        repCliente.Inserir(tomador);
                    }

                    cte.SetarParticipante(tomador, Dominio.Enumeradores.TipoTomador.Outros, null, dadosTomador);
                }
                else
                {
                    Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao repPessoaExteriorOutraDescricao = new Repositorio.Embarcador.Pessoas.PessoaExteriorOutraDescricao(unidadeTrabalho);
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(infToma.enderToma.cPais))
                        pais = repPais.BuscarPorCodigo(infToma.enderToma.cPais.ToInt());

                    if (pais == null)
                        pais = repPais.BuscarPorNome(infToma.enderToma.xPais);

                    if (pais == null)
                        throw new Exception($"O país ({infToma.enderToma.cPais} - {infToma.enderToma.xPais}) do tomador não foi encontrado na base.");

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorNomeEndereco(infToma.xNome, infToma.enderToma.xLgr);

                    if (cliente == null)
                        cliente = repPessoaExteriorOutraDescricao.BuscarPessoaPorRazaoSocialEEndereco(infToma.xNome, infToma.enderToma.xLgr);

                    if (cliente == null && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        erro = $"Não foi encontrada uma pessoa do exterior com o nome {infToma.xNome} e o endereço {infToma.enderToma.xLgr}.";
                        return false;
                    }

                    if (cliente == null)
                    {
                        cliente = new Dominio.Entidades.Cliente()
                        {
                            Tipo = "E",
                            Atividade = ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho),
                            Ativo = true,
                            Bairro = infToma.enderToma.xBairro,
                            Cidade = infToma.enderToma.xMun,
                            Complemento = infToma.enderToma.xCpl,
                            Email = infToma.email,
                            Endereco = infToma.enderToma.xLgr,
                            DataCadastro = DateTime.Now,
                            IE_RG = "ISENTO",
                            IndicadorIE = Dominio.ObjetosDeValor.Embarcador.Enumeradores.IndicadorIE.NaoContribuinte,
                            CPF_CNPJ = repCliente.BuscarPorProximoExterior(),
                            Localidade = repLocalidade.BuscarPorCodigoIBGE(infToma.enderToma.cMun.ToInt()),
                            Nome = infToma.xNome,
                            Numero = infToma.enderToma.nro,
                            Pais = pais,
                            Telefone1 = infToma.fone
                        };

                        repCliente.Inserir(cliente);
                    }

                    Dominio.ObjetosDeValor.CTe.Cliente objCliente = new Dominio.ObjetosDeValor.CTe.Cliente
                    {
                        Bairro = infToma.enderToma.xBairro,
                        Cidade = infToma.enderToma.xMun,
                        Complemento = infToma.enderToma.xCpl,
                        Emails = infToma.email,
                        Endereco = infToma.enderToma.xLgr,
                        RazaoSocial = infToma.xNome,
                        Numero = infToma.enderToma.nro
                    };

                    cte.SetarParticipanteExportacao(objCliente, Dominio.Enumeradores.TipoTomador.Outros, pais, cliente.Atividade, cliente.Localidade, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Outros);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Outros);

                    repParticipante.Deletar(part);
                }
            }

            erro = string.Empty;
            return true;
        }

        private void SetarTomador(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, MultiSoftware.CTe.v200.Envio.TCTeInfCteIdeToma4 infToma, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infToma != null)
            {
                double cpfCnpj = 0;
                double.TryParse(infToma.Item, out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeTrabalho);
                    Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeTrabalho);

                    Dominio.Entidades.Cliente tomador = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.DadosCliente dadosTomador = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                    if (tomador == null)
                    {
                        tomador = new Dominio.Entidades.Cliente();

                        tomador.CPF_CNPJ = cpfCnpj;
                        tomador.Atividade = this.ObterAtividade(cte.Empresa.Codigo, unidadeTrabalho);
                        tomador.Bairro = infToma.enderToma.xBairro;
                        tomador.CEP = infToma.enderToma.CEP;
                        tomador.Complemento = infToma.enderToma.xCpl;
                        tomador.DataCadastro = DateTime.Now;
                        tomador.Email = infToma.email;
                        tomador.Endereco = infToma.enderToma.xLgr;
                        tomador.IE_RG = infToma.IE;
                        tomador.Localidade = repLocalidade.BuscarPorCodigoIBGE(int.Parse(infToma.enderToma.cMun));
                        tomador.Nome = infToma.xNome;
                        tomador.NomeFantasia = dadosTomador != null && !string.IsNullOrWhiteSpace(dadosTomador.NomeFantasia) ? dadosTomador.NomeFantasia : infToma.xFant;
                        tomador.Numero = infToma.enderToma.nro;
                        tomador.Telefone1 = Utilidades.String.OnlyNumbers(infToma.fone);
                        tomador.Tipo = infToma.Item.Length == 14 ? "J" : "F";

                        if (tomador.Tipo == "J" && tomador.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(tomador.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                tomador.GrupoPessoas = grupoPessoas;
                            }
                        }

                        tomador.Ativo = true;
                        repCliente.Inserir(tomador);
                    }

                    cte.SetarParticipante(tomador, Dominio.Enumeradores.TipoTomador.Outros, null, dadosTomador);
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeTrabalho);

                    Dominio.Entidades.Pais pais = repPais.BuscarPorCodigo(int.Parse(infToma.enderToma.cPais));

                    if (pais == null)
                        throw new Exception("O país do tomador é inválido.");

                    Dominio.ObjetosDeValor.Cliente cliente = new Dominio.ObjetosDeValor.Cliente();

                    cliente.Bairro = infToma.enderToma.xBairro;
                    cliente.Cidade = infToma.enderToma.xMun;
                    cliente.Complemento = infToma.enderToma.xCpl;
                    cliente.Emails = infToma.email;
                    cliente.Endereco = infToma.enderToma.xLgr;
                    cliente.RazaoSocial = infToma.xNome;
                    cliente.Numero = infToma.enderToma.nro;

                    cte.SetarParticipanteExportacao(cliente, Dominio.Enumeradores.TipoTomador.Outros, pais);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(Dominio.Enumeradores.TipoTomador.Outros);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeTrabalho);

                    cte.SetarParticipante(null, Dominio.Enumeradores.TipoTomador.Outros);

                    repParticipante.Deletar(part);
                }
            }
        }

        public void ObterParticipante(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.ObjetosDeValor.CTe.Cliente participante, Dominio.Enumeradores.TipoTomador tipo, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (participante != null)
            {
                Repositorio.Atividade repAtividade = new Repositorio.Atividade(unidadeDeTrabalho);
                Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
                Dominio.ObjetosDeValor.Endereco endereco = null;
                if (!participante.Exportacao)
                {
                    double cpfCnpj = 0;
                    double.TryParse(Utilidades.String.OnlyNumbers(participante.CPFCNPJ), out cpfCnpj);

                    if (cpfCnpj > 0)
                    {
                        Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);
                        Repositorio.DadosCliente repDadosCliente = new Repositorio.DadosCliente(unidadeDeTrabalho);

                        Dominio.Entidades.Cliente cliente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                        Dominio.Entidades.DadosCliente dadosCliente = repDadosCliente.Buscar(cte.Empresa.Codigo, cpfCnpj);

                        bool inserir = false;

                        if (cliente == null)
                        {
                            inserir = true;
                            cliente = new Dominio.Entidades.Cliente();
                        }

                        if (!participante.NaoAtualizarDadosCadastrais || inserir)
                        {
                            cliente.CPF_CNPJ = cpfCnpj;
                            if (Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().SempreUsarAtividadeCliente.HasValue &&
                                Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().SempreUsarAtividadeCliente.Value)
                                cliente.Atividade = participante.CodigoAtividade > 0 ? repAtividade.BuscarPorCodigo(participante.CodigoAtividade) : this.ObterAtividade(cte.Empresa.Codigo, unidadeDeTrabalho);
                            if (inserir)
                                cliente.DataCadastro = DateTime.Now;
                            cliente.EmailContatoStatus = participante.StatusEmailsContato ? "A" : "I";
                            cliente.IE_RG = participante.RGIE;
                            cliente.Nome = Utilidades.String.Left(participante.RazaoSocial, 60);
                            if (!inserir)
                            {
                                if (!Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().AtualizarFantasiaClienteIntegracaoCTe.HasValue || Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().AtualizarFantasiaClienteIntegracaoCTe.Value)
                                    cliente.NomeFantasia = Utilidades.String.Left(participante.NomeFantasia, 60);
                            }
                            else
                                cliente.NomeFantasia = Utilidades.String.Left(participante.NomeFantasia, 60);

                            cliente.Tipo = Utilidades.String.OnlyNumbers(participante.CPFCNPJ).Length == 11 ? "F" : "J";
                            //cliente.CodigoIntegracao = participante.CodigoCliente;

                            if (!participante.NaoAtualizarEndereco || inserir)
                            {
                                cliente.Atividade = participante.CodigoAtividade > 0 ? repAtividade.BuscarPorCodigo(participante.CodigoAtividade) : this.ObterAtividade(cte.Empresa.Codigo, unidadeDeTrabalho);
                                cliente.Email = !string.IsNullOrWhiteSpace(participante.Emails) ? participante.Emails : (!inserir ? cliente.Email : string.Empty);
                                cliente.EmailStatus = !string.IsNullOrWhiteSpace(participante.Emails) ? (participante.StatusEmails ? "A" : "I") : (!inserir ? cliente.EmailStatus : "A");
                                cliente.EmailContador = participante.EmailsContador;
                                cliente.EmailContadorStatus = participante.StatusEmailsContador ? "A" : "I";
                                cliente.EmailContato = participante.EmailsContato;

                                cliente.Ativo = true;
                                cliente.CEP = participante.CEP;
                                cliente.Complemento = !string.IsNullOrWhiteSpace(participante.Complemento) && participante.Complemento.Length > 2 ? Utilidades.String.Left(participante.Complemento, 60) : null;
                                cliente.Bairro = Utilidades.String.Left(participante.Bairro, 60);
                                cliente.Endereco = Utilidades.String.Left(participante.Endereco, 255);
                                if (participante.CodigoIBGECidade != 9999999 || inserir)
                                    cliente.Localidade = repLocalidade.BuscarPorCodigoIBGE(participante.CodigoIBGECidade);
                                cliente.Numero = Utilidades.String.Left(participante.Numero, 60);
                                cliente.Telefone1 = Utilidades.String.OnlyNumbers(participante.Telefone1);
                                cliente.Telefone2 = Utilidades.String.OnlyNumbers(participante.Telefone2);
                            }

                            if (inserir)
                            {
                                if (cliente.Tipo == "J" && cliente.GrupoPessoas == null)
                                {
                                    Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeDeTrabalho);
                                    Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(cliente.CPF_CNPJ_Formatado).Remove(8, 6));
                                    if (grupoPessoas != null)
                                    {
                                        cliente.GrupoPessoas = grupoPessoas;
                                    }
                                }
                                cliente.DataUltimaAtualizacao = DateTime.Now;
                                cliente.Integrado = false;
                                repCliente.Inserir(cliente);
                            }
                            else
                            {
                                if (!participante.NaoAtualizarEndereco)
                                {
                                    cliente.DataUltimaAtualizacao = DateTime.Now;
                                    cliente.Integrado = false;
                                    repCliente.Atualizar(cliente);
                                }
                                else
                                {
                                    endereco = new Dominio.ObjetosDeValor.Endereco();
                                    endereco.Complemento = !string.IsNullOrWhiteSpace(participante.Complemento) && participante.Complemento.Length > 2 ? Utilidades.String.Left(participante.Complemento, 60) : null;
                                    endereco.Bairro = Utilidades.String.Left(participante.Bairro, 60);
                                    endereco.Logradouro = Utilidades.String.Left(participante.Endereco, 255);
                                    if (participante.CodigoIBGECidade != 9999999 || inserir)
                                        endereco.Cidade = repLocalidade.BuscarPorCodigoIBGE(participante.CodigoIBGECidade);
                                    endereco.Numero = Utilidades.String.Left(participante.Numero, 60);
                                    endereco.Telefone = Utilidades.String.OnlyNumbers(participante.Telefone1);
                                    endereco.CEP = participante.CEP;
                                    endereco.CodigoEnderecoEmbarcador = Utilidades.String.Left(participante.CodigoEndereco, 50);
                                }
                            }
                        }

                        cte.SetarParticipante(cliente, tipo, endereco, dadosCliente, participante);
                    }
                }
                else
                {
                    Repositorio.Pais repPais = new Repositorio.Pais(unidadeDeTrabalho);
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);

                    Dominio.Entidades.Localidade localidadeExt = null;
                    Dominio.Entidades.Pais pais = null;

                    if (!string.IsNullOrWhiteSpace(participante.CodigoLocalidadeEmbarcador))
                    {
                        localidadeExt = repLocalidade.buscarPorCodigoEmbarcador(participante.CodigoLocalidadeEmbarcador);

                        if (localidadeExt != null && localidadeExt.Pais != null)
                            pais = repPais.BuscarPorCodigo(localidadeExt.Pais.Codigo);
                    }

                    if (pais == null)
                        pais = repPais.BuscarPorSigla(participante.CodigoPais);

                    Dominio.Entidades.Cliente cliente = participante.Codigo > 0D ? repCliente.BuscarPorCPFCNPJ(participante.Codigo) : null;

                    try
                    {
                        if (pais == null && cliente != null && cliente.Pais != null)
                            pais = repPais.BuscarPorCodigo(cliente.Pais.Codigo);
                        else if (pais == null && cliente != null && cliente.Localidade != null && cliente.Localidade.Pais != null)
                            pais = repPais.BuscarPorCodigo(cliente.Localidade.Pais.Codigo);
                    }
                    catch (Exception ex)
                    {
                        Servicos.Log.TratarErro(ex);
                    }

                    cte.SetarParticipanteExportacao(participante, tipo, pais, (participante.CodigoAtividade > 0 ? repAtividade.BuscarPorCodigo(participante.CodigoAtividade) : this.ObterAtividade(cte.Empresa.Codigo, unidadeDeTrabalho)), localidadeExt, cliente);
                }
            }
            else
            {
                Dominio.Entidades.ParticipanteCTe part = cte.ObterParticipante(tipo);

                if (part != null)
                {
                    Repositorio.ParticipanteCTe repParticipante = new Repositorio.ParticipanteCTe(unidadeDeTrabalho);

                    cte.SetarParticipante(null, tipo);

                    repParticipante.Deletar(part);
                }
            }
        }

        public Dominio.Entidades.Cliente ObterCliente(Dominio.Entidades.Empresa empresa, Dominio.ObjetosDeValor.CTe.Cliente cli, Repositorio.UnitOfWork unidadeDeTrabalho, bool naoAtualizar = false)
        {
            if (cli != null)
            {
                double cpfCnpj = 0;
                double.TryParse(Utilidades.String.OnlyNumbers(cli.CPFCNPJ), out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);

                    Repositorio.Atividade repAtividade = new Repositorio.Atividade(unidadeDeTrabalho);

                    bool inserir = false;

                    if (cliente == null)
                    {
                        inserir = true;
                        cliente = new Dominio.Entidades.Cliente();
                        cliente.Atividade = cli.CodigoAtividade > 0 ? repAtividade.BuscarPorCodigo(cli.CodigoAtividade) : this.ObterAtividade(empresa.Codigo, unidadeDeTrabalho);
                    }
                    else if (naoAtualizar || cliente.NaoAtualizarDados)
                        return cliente;

                    cliente.CPF_CNPJ = cpfCnpj;
                    cliente.Bairro = cli.Bairro;
                    cliente.CEP = cli.CEP;
                    cliente.Complemento = cli.Complemento;
                    cliente.Email = cli.Emails;
                    cliente.EmailStatus = cli.StatusEmails ? "A" : "I";
                    cliente.EmailContador = cli.EmailsContador;
                    cliente.EmailContadorStatus = cli.StatusEmailsContador ? "A" : "I";
                    cliente.EmailContato = cli.EmailsContato;
                    cliente.EmailContatoStatus = cli.StatusEmailsContato ? "A" : "I";
                    cliente.Endereco = cli.Endereco;
                    if (!string.IsNullOrWhiteSpace(cli.RGIE) && cli.RGIE.Length > 14)
                        cli.RGIE = cli.RGIE.Replace(".", "");
                    cliente.IE_RG = !string.IsNullOrWhiteSpace(cli.RGIE) ? cli.RGIE : string.Empty;
                    cliente.Localidade = repLocalidade.BuscarPorCodigoIBGE(cli.CodigoIBGECidade);
                    cliente.Nome = cli.RazaoSocial;
                    cliente.Ativo = true;
                    cliente.NomeFantasia = cli.NomeFantasia;
                    cliente.Numero = cli.Numero;
                    cliente.Telefone1 = Utilidades.String.OnlyNumbers(cli.Telefone1);
                    cliente.Telefone2 = Utilidades.String.OnlyNumbers(cli.Telefone2);
                    cliente.Tipo = Utilidades.String.OnlyNumbers(cli.CPFCNPJ).Length == 14 ? "J" : "F";

                    if (inserir)
                    {
                        if (cliente.Tipo == "J" && cliente.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeDeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(cliente.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                cliente.GrupoPessoas = grupoPessoas;
                            }
                        }
                        cliente.DataCadastro = DateTime.Now;
                        cliente.DataUltimaAtualizacao = DateTime.Now;
                        cliente.Integrado = false;
                        repCliente.Inserir(cliente);
                    }
                    else if (!cliente.NaoAtualizarDados)
                    {
                        cliente.DataUltimaAtualizacao = DateTime.Now;
                        cliente.Integrado = false;
                        repCliente.Atualizar(cliente);
                    }

                    return cliente;
                }
            }

            return null;
        }

        public Dominio.Entidades.Cliente ObterClienteEmpresa(Dominio.Entidades.Empresa empresa, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (empresa != null)
            {
                double cpfCnpj = 0;
                double.TryParse(Utilidades.String.OnlyNumbers(empresa.CNPJ), out cpfCnpj);

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);

                    Repositorio.Atividade repAtividade = new Repositorio.Atividade(unidadeDeTrabalho);

                    bool inserir = false;

                    if (cliente == null)
                    {
                        inserir = true;
                        cliente = new Dominio.Entidades.Cliente();
                        cliente.Atividade = this.ObterAtividade(empresa.Codigo, unidadeDeTrabalho);
                    }

                    cliente.CPF_CNPJ = cpfCnpj;
                    cliente.Bairro = empresa.Bairro;
                    cliente.CEP = empresa.CEP;
                    cliente.Complemento = empresa.Complemento;
                    cliente.Email = empresa.Email;
                    cliente.EmailStatus = empresa.StatusEmail;
                    cliente.EmailContador = empresa.EmailContador;
                    cliente.EmailContadorStatus = empresa.StatusEmailContador;
                    cliente.EmailContato = empresa.EmailAdministrativo;
                    cliente.EmailContatoStatus = empresa.StatusEmailAdministrativo;
                    cliente.Endereco = empresa.Endereco;
                    if (!string.IsNullOrWhiteSpace(empresa.InscricaoEstadual) && empresa.InscricaoEstadual.Length > 14)
                        empresa.InscricaoEstadual = empresa.InscricaoEstadual.Replace(".", "");
                    cliente.IE_RG = !string.IsNullOrWhiteSpace(empresa.InscricaoEstadual) ? empresa.InscricaoEstadual : "S/N";
                    cliente.Localidade = empresa.Localidade;
                    cliente.Nome = empresa.RazaoSocial;
                    cliente.Ativo = true;
                    cliente.NomeFantasia = empresa.NomeFantasia;
                    cliente.Numero = empresa.Numero;
                    cliente.Telefone1 = Utilidades.String.OnlyNumbers(empresa.Telefone);
                    cliente.Telefone2 = Utilidades.String.OnlyNumbers(empresa.TelefoneContato);
                    cliente.Tipo = "J";

                    if (inserir)
                    {
                        if (cliente.Tipo == "J" && cliente.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeDeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(cliente.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                cliente.GrupoPessoas = grupoPessoas;
                            }
                        }
                        cliente.DataCadastro = DateTime.Now;
                        cliente.DataUltimaAtualizacao = DateTime.Now;
                        cliente.Integrado = false;
                        repCliente.Inserir(cliente);
                    }
                    else if (!cliente.NaoAtualizarDados)
                    {
                        cliente.DataUltimaAtualizacao = DateTime.Now;
                        cliente.Integrado = false;
                        repCliente.Atualizar(cliente);
                    }

                    return cliente;
                }
            }

            return null;
        }

        private void ObterICMS(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteImp infImp)
        {
            if (infImp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Type tipoICMS = infImp.ICMS.Item.GetType();
                if (tipoICMS == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMS00))
                {
                    MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMS00 impICMS00 = (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMS00)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS00.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS00.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS00.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS00.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMS20))
                {
                    MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMS20 impICMS20 = (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMS20)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS20.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS20.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS20.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS20.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMS45))
                {
                    MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMS45 impICMS45 = (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMS45)infImp.ICMS.Item;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS45.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMS60))
                {
                    MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMS60 impICMS60 = (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMS60)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS60.pICMSSTRet, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS60.vBCSTRet, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS60.vICMSSTRet, cultura);
                    conhecimento.ValorPresumido = impICMS60.vCred != null ? decimal.Parse(impICMS60.vCred, cultura) : 0m;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS60.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMS90))
                {
                    MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMS90 impICMS90 = (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMS90)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS90.pICMS, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMS90.pRedBC != null ? decimal.Parse(impICMS90.pRedBC, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS90.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS90.vICMS, cultura);
                    conhecimento.ValorPresumido = impICMS90.vCred != null ? decimal.Parse(impICMS90.vCred, cultura) : 0m;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS90.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMSOutraUF))
                {
                    MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMSOutraUF impICMSOutraUF = (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMSOutraUF)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMSOutraUF.pICMSOutraUF, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMSOutraUF.pRedBCOutraUF != null ? decimal.Parse(impICMSOutraUF.pRedBCOutraUF, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMSOutraUF.vBCOutraUF, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMSOutraUF.vICMSOutraUF, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMSOutraUF.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TImpICMSSN))
                {
                    conhecimento.CST = string.Empty;
                    conhecimento.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Sim;
                }
            }
        }

        private void ObterICMS(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteImp infImp)
        {
            if (infImp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Type tipoICMS = infImp.ICMS.Item.GetType();
                if (tipoICMS == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMS00))
                {
                    MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMS00 impICMS00 = (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMS00)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS00.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS00.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS00.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS00.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMS20))
                {
                    MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMS20 impICMS20 = (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMS20)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS20.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS20.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS20.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS20.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMS45))
                {
                    MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMS45 impICMS45 = (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMS45)infImp.ICMS.Item;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS45.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMS60))
                {
                    MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMS60 impICMS60 = (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMS60)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS60.pICMSSTRet, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS60.vBCSTRet, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS60.vICMSSTRet, cultura);
                    conhecimento.ValorPresumido = impICMS60.vCred != null ? decimal.Parse(impICMS60.vCred, cultura) : 0m;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS60.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMS90))
                {
                    MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMS90 impICMS90 = (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMS90)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS90.pICMS, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMS90.pRedBC != null ? decimal.Parse(impICMS90.pRedBC, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS90.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS90.vICMS, cultura);
                    conhecimento.ValorPresumido = impICMS90.vCred != null ? decimal.Parse(impICMS90.vCred, cultura) : 0m;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS90.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMSOutraUF))
                {
                    MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMSOutraUF impICMSOutraUF = (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMSOutraUF)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMSOutraUF.pICMSOutraUF, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMSOutraUF.pRedBCOutraUF != null ? decimal.Parse(impICMSOutraUF.pRedBCOutraUF, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMSOutraUF.vBCOutraUF, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMSOutraUF.vICMSOutraUF, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMSOutraUF.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TImpICMSSN))
                {
                    conhecimento.CST = string.Empty;
                    conhecimento.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Sim;
                }
            }
        }

        private void ObterICMS(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteImp infImp)
        {
            if (infImp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Type tipoICMS = infImp.ICMS.Item.GetType();
                if (tipoICMS == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMS00))
                {
                    MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMS00 impICMS00 = (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMS00)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS00.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS00.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS00.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS00.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMS20))
                {
                    MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMS20 impICMS20 = (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMS20)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS20.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS20.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS20.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS20.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMS45))
                {
                    MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMS45 impICMS45 = (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMS45)infImp.ICMS.Item;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS45.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMS60))
                {
                    MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMS60 impICMS60 = (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMS60)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS60.pICMSSTRet, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS60.vBCSTRet, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS60.vICMSSTRet, cultura);
                    conhecimento.ValorPresumido = impICMS60.vCred != null ? decimal.Parse(impICMS60.vCred, cultura) : 0m;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS60.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMS90))
                {
                    MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMS90 impICMS90 = (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMS90)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS90.pICMS, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMS90.pRedBC != null ? decimal.Parse(impICMS90.pRedBC, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS90.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS90.vICMS, cultura);
                    conhecimento.ValorPresumido = impICMS90.vCred != null ? decimal.Parse(impICMS90.vCred, cultura) : 0m;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS90.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMSOutraUF))
                {
                    MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMSOutraUF impICMSOutraUF = (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMSOutraUF)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMSOutraUF.pICMSOutraUF, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMSOutraUF.pRedBCOutraUF != null ? decimal.Parse(impICMSOutraUF.pRedBCOutraUF, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMSOutraUF.vBCOutraUF, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMSOutraUF.vICMSOutraUF, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMSOutraUF.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TImpICMSSN))
                {
                    conhecimento.CST = string.Empty;
                    conhecimento.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Sim;
                }
            }
        }

        private void ObterICMS(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteImp infImp)
        {
            if (infImp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Type tipoICMS = infImp.ICMS.Item.GetType();
                if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS00))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS00 impICMS00 = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS00)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS00.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS00.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS00.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS00.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS20))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS20 impICMS20 = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS20)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS20.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS20.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS20.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS20.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS45))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS45 impICMS45 = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS45)infImp.ICMS.Item;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS45.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS60))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS60 impICMS60 = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS60)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS60.pICMSSTRet, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS60.vBCSTRet, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS60.vICMSSTRet, cultura);
                    conhecimento.ValorPresumido = impICMS60.vCred != null ? decimal.Parse(impICMS60.vCred, cultura) : 0m;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS60.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS90))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS90 impICMS90 = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS90)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS90.pICMS, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMS90.pRedBC != null ? decimal.Parse(impICMS90.pRedBC, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS90.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS90.vICMS, cultura);
                    conhecimento.ValorPresumido = impICMS90.vCred != null ? decimal.Parse(impICMS90.vCred, cultura) : 0m;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS90.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMSOutraUF))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMSOutraUF impICMSOutraUF = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMSOutraUF)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMSOutraUF.pICMSOutraUF, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMSOutraUF.pRedBCOutraUF != null ? decimal.Parse(impICMSOutraUF.pRedBCOutraUF, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMSOutraUF.vBCOutraUF, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMSOutraUF.vICMSOutraUF, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMSOutraUF.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMSSN))
                {
                    conhecimento.CST = string.Empty;
                    conhecimento.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Sim;
                }
            }
        }

        private void ObterICMS(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteImp infImp)
        {
            if (infImp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Type tipoICMS = infImp.ICMS.Item.GetType();
                if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS00))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS00 impICMS00 = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS00)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS00.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS00.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS00.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS00.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS20))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS20 impICMS20 = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS20)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS20.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS20.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS20.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS20.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS45))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS45 impICMS45 = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS45)infImp.ICMS.Item;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS45.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS60))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS60 impICMS60 = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS60)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS60.pICMSSTRet, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS60.vBCSTRet, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS60.vICMSSTRet, cultura);
                    conhecimento.ValorPresumido = impICMS60.vCred != null ? decimal.Parse(impICMS60.vCred, cultura) : 0m;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS60.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS90))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS90 impICMS90 = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMS90)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS90.pICMS, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMS90.pRedBC != null ? decimal.Parse(impICMS90.pRedBC, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS90.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS90.vICMS, cultura);
                    conhecimento.ValorPresumido = impICMS90.vCred != null ? decimal.Parse(impICMS90.vCred, cultura) : 0m;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS90.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMSOutraUF))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMSOutraUF impICMSOutraUF = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMSOutraUF)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMSOutraUF.pICMSOutraUF, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMSOutraUF.pRedBCOutraUF != null ? decimal.Parse(impICMSOutraUF.pRedBCOutraUF, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMSOutraUF.vBCOutraUF, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMSOutraUF.vICMSOutraUF, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMSOutraUF.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TImpICMSSN))
                {
                    conhecimento.CST = string.Empty;
                    conhecimento.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Sim;
                }
            }
        }

        private void ObterIBSCBS(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteImp infImp)
        {
            if (infImp == null || infImp.IBSCBS == null)
                return;

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            conhecimento.CSTIBSCBS = infImp.IBSCBS.CST;
            conhecimento.ClassificacaoTributariaIBSCBS = infImp.IBSCBS.cClassTrib;

            if (infImp.IBSCBS.gIBSCBS == null)
                return;

            conhecimento.BaseCalculoIBSCBS = decimal.Parse(infImp.IBSCBS.gIBSCBS.vBC, cultura);
            conhecimento.AliquotaIBSEstadual = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSUF.pIBSUF, cultura);
            conhecimento.PercentualReducaoIBSEstadual = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSUF.gRed?.pRedAliq ?? "0", cultura);
            conhecimento.ValorIBSEstadual = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSUF.vIBSUF, cultura);
            conhecimento.AliquotaIBSMunicipal = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSMun.pIBSMun, cultura);
            conhecimento.PercentualReducaoIBSMunicipal = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSMun.gRed?.pRedAliq ?? "0", cultura);
            conhecimento.ValorIBSMunicipal = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSMun.vIBSMun, cultura);
            conhecimento.AliquotaCBS = decimal.Parse(infImp.IBSCBS.gIBSCBS.gCBS.pCBS, cultura);
            conhecimento.PercentualReducaoCBS = decimal.Parse(infImp.IBSCBS.gIBSCBS.gCBS.gRed?.pRedAliq ?? "0", cultura);
            conhecimento.ValorCBS = decimal.Parse(infImp.IBSCBS.gIBSCBS.gCBS.vCBS, cultura);
        }

        private void ObterICMS(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCteImp infImp)
        {
            if (infImp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Type tipoICMS = infImp.ICMS.Item.GetType();
                if (tipoICMS == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMS00))
                {
                    MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMS00 impICMS00 = (MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMS00)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS00.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS00.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS00.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS00.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMS20))
                {
                    MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMS20 impICMS20 = (MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMS20)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS20.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS20.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS20.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS20.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMS45))
                {
                    MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMS45 impICMS45 = (MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMS45)infImp.ICMS.Item;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS45.CST);
                }
                //else if (tipoICMS == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMS60))
                //{
                //    MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMS60 impICMS60 = (MultiSoftware.CTe.v300.ConhecimentoDeTransportOSe.TImpOSICMS60)infImp.ICMS.Item;
                //    conhecimento.AliquotaICMS = decimal.Parse(impICMS60.pICMSSTRet, cultura);
                //    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS60.vBCSTRet, cultura);
                //    conhecimento.ValorICMS = decimal.Parse(impICMS60.vICMSSTRet, cultura);
                //    conhecimento.ValorPresumido = impICMS60.vCred != null ? decimal.Parse(impICMS60.vCred, cultura) : 0m;
                //    conhecimento.CST = string.Format("{0:00}", (int)impICMS60.CST);
                //}
                else if (tipoICMS == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMS90))
                {
                    MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMS90 impICMS90 = (MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMS90)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS90.pICMS, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMS90.pRedBC != null ? decimal.Parse(impICMS90.pRedBC, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS90.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS90.vICMS, cultura);
                    conhecimento.ValorPresumido = impICMS90.vCred != null ? decimal.Parse(impICMS90.vCred, cultura) : 0m;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS90.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMSOutraUF))
                {
                    MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMSOutraUF impICMSOutraUF = (MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMSOutraUF)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMSOutraUF.pICMSOutraUF, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMSOutraUF.pRedBCOutraUF != null ? decimal.Parse(impICMSOutraUF.pRedBCOutraUF, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMSOutraUF.vBCOutraUF, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMSOutraUF.vICMSOutraUF, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMSOutraUF.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TImpOSICMSSN))
                {
                    conhecimento.CST = string.Empty;
                    conhecimento.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Sim;
                }
            }
        }

        private void ObterICMS(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCteImp infImp)
        {
            if (infImp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Type tipoICMS = infImp.ICMS.Item.GetType();
                if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMS00))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMS00 impICMS00 = (MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMS00)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS00.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS00.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS00.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS00.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMS20))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMS20 impICMS20 = (MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMS20)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS20.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS20.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS20.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS20.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMS45))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMS45 impICMS45 = (MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMS45)infImp.ICMS.Item;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS45.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMS90))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMS90 impICMS90 = (MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMS90)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS90.pICMS, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMS90.pRedBC != null ? decimal.Parse(impICMS90.pRedBC, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS90.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS90.vICMS, cultura);
                    conhecimento.ValorPresumido = impICMS90.vCred != null ? decimal.Parse(impICMS90.vCred, cultura) : 0m;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS90.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMSOutraUF))
                {
                    MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMSOutraUF impICMSOutraUF = (MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMSOutraUF)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMSOutraUF.pICMSOutraUF, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMSOutraUF.pRedBCOutraUF != null ? decimal.Parse(impICMSOutraUF.pRedBCOutraUF, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMSOutraUF.vBCOutraUF, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMSOutraUF.vICMSOutraUF, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMSOutraUF.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TImpOSICMSSN))
                {
                    conhecimento.CST = string.Empty;
                    conhecimento.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Sim;
                }
            }
        }

        private void ObterIBSCBS(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCteImp infImp)
        {
            if (infImp == null || infImp.IBSCBS == null)
                return;

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            conhecimento.CSTIBSCBS = infImp.IBSCBS.CST;
            conhecimento.ClassificacaoTributariaIBSCBS = infImp.IBSCBS.cClassTrib;

            if (infImp.IBSCBS.gIBSCBS == null)
                return;

            conhecimento.BaseCalculoIBSCBS = decimal.Parse(infImp.IBSCBS.gIBSCBS.vBC, cultura);
            conhecimento.AliquotaIBSEstadual = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSUF.pIBSUF, cultura);
            conhecimento.PercentualReducaoIBSEstadual = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSUF.gRed?.pRedAliq ?? "0", cultura);
            conhecimento.ValorIBSEstadual = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSUF.vIBSUF, cultura);
            conhecimento.AliquotaIBSMunicipal = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSMun.pIBSMun, cultura);
            conhecimento.PercentualReducaoIBSMunicipal = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSMun.gRed?.pRedAliq ?? "0", cultura);
            conhecimento.ValorIBSMunicipal = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSMun.vIBSMun, cultura);
            conhecimento.AliquotaCBS = decimal.Parse(infImp.IBSCBS.gIBSCBS.gCBS.pCBS, cultura);
            conhecimento.PercentualReducaoCBS = decimal.Parse(infImp.IBSCBS.gIBSCBS.gCBS.gRed?.pRedAliq ?? "0", cultura);
            conhecimento.ValorCBS = decimal.Parse(infImp.IBSCBS.gIBSCBS.gCBS.vCBS, cultura);
        }


        private void ObterICMS(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.Envio.TCTeInfCteImp infImp)
        {
            if (infImp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Type tipoICMS = infImp.ICMS.Item.GetType();
                if (tipoICMS == typeof(MultiSoftware.CTe.v200.Envio.TImpICMS00))
                {
                    MultiSoftware.CTe.v200.Envio.TImpICMS00 impICMS00 = (MultiSoftware.CTe.v200.Envio.TImpICMS00)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS00.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS00.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS00.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS00.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v200.Envio.TImpICMS20))
                {
                    MultiSoftware.CTe.v200.Envio.TImpICMS20 impICMS20 = (MultiSoftware.CTe.v200.Envio.TImpICMS20)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS20.pICMS, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS20.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS20.vICMS, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS20.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v200.Envio.TImpICMS45))
                {
                    MultiSoftware.CTe.v200.Envio.TImpICMS45 impICMS45 = (MultiSoftware.CTe.v200.Envio.TImpICMS45)infImp.ICMS.Item;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS45.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v200.Envio.TImpICMS60))
                {
                    MultiSoftware.CTe.v200.Envio.TImpICMS60 impICMS60 = (MultiSoftware.CTe.v200.Envio.TImpICMS60)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS60.pICMSSTRet, cultura);
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS60.vBCSTRet, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS60.vICMSSTRet, cultura);
                    conhecimento.ValorPresumido = impICMS60.vCred != null ? decimal.Parse(impICMS60.vCred, cultura) : 0m;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS60.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v200.Envio.TImpICMS90))
                {
                    MultiSoftware.CTe.v200.Envio.TImpICMS90 impICMS90 = (MultiSoftware.CTe.v200.Envio.TImpICMS90)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMS90.pICMS, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMS90.pRedBC != null ? decimal.Parse(impICMS90.pRedBC, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMS90.vBC, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMS90.vICMS, cultura);
                    conhecimento.ValorPresumido = impICMS90.vCred != null ? decimal.Parse(impICMS90.vCred, cultura) : 0m;
                    conhecimento.CST = string.Format("{0:00}", (int)impICMS90.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v200.Envio.TImpICMSOutraUF))
                {
                    MultiSoftware.CTe.v200.Envio.TImpICMSOutraUF impICMSOutraUF = (MultiSoftware.CTe.v200.Envio.TImpICMSOutraUF)infImp.ICMS.Item;
                    conhecimento.AliquotaICMS = decimal.Parse(impICMSOutraUF.pICMSOutraUF, cultura);
                    conhecimento.PercentualReducaoBaseCalculoICMS = impICMSOutraUF.pRedBCOutraUF != null ? decimal.Parse(impICMSOutraUF.pRedBCOutraUF, cultura) : 0m;
                    conhecimento.BaseCalculoICMS = decimal.Parse(impICMSOutraUF.vBCOutraUF, cultura);
                    conhecimento.ValorICMS = decimal.Parse(impICMSOutraUF.vICMSOutraUF, cultura);
                    conhecimento.CST = string.Format("{0:00}", (int)impICMSOutraUF.CST);
                }
                else if (tipoICMS == typeof(MultiSoftware.CTe.v200.Envio.TImpICMSSN))
                {
                    conhecimento.CST = string.Empty;
                    conhecimento.SimplesNacional = Dominio.Enumeradores.OpcaoSimNao.Sim;
                }
            }
        }

        private void ObterInformacoesCTe(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCte infCTe, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTe != null)
            {
                foreach (object item in infCTe.Items)
                {
                    Type tipoInfoCTe = item.GetType();
                    if (tipoInfoCTe == typeof(MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm))
                    {
                        this.ObterInformacoesCTeNormal(ref conhecimento, (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm)item, unidadeTrabalho);
                    }
                }
            }
        }

        private void ObterInformacoesCTe(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCte infCTe, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTe != null)
            {
                Type tipoInfoCTe = infCTe.Item.GetType();
                if (tipoInfoCTe == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm))
                {
                    this.ObterInformacoesCTeNormal(ref conhecimento, (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm)infCTe.Item, unidadeTrabalho);
                }
                else
                {
                    if (tipoInfoCTe == typeof(MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCteComp))
                    {
                        this.ObterInformacoesCTeComplementar(ref conhecimento, (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCteComp)infCTe.Item, unidadeTrabalho);
                    }
                }
            }
        }

        private void ObterInformacoesDocumentosAnteriores(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCte infCTe, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.DocumentoDeTransporteAnteriorCTe repDocumento = new Repositorio.DocumentoDeTransporteAnteriorCTe(unidadeDeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModelo = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);

            if (infCTe.ide.tpServ != MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteIdeTpServ.Item0 && infCTe.Item.GetType() == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm))
            {
                MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm info = (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm)infCTe.Item;
                MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormEmiDocAnt[] docsAnt = info.docAnt;

                if (docsAnt != null)
                {
                    List<Dominio.Entidades.Cliente> emissores = new List<Dominio.Entidades.Cliente>();

                    for (int i = 0; i < docsAnt.Length; i++)
                    {
                        MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormEmiDocAnt infDoc = docsAnt[i];
                        MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormEmiDocAntIdDocAnt[] idDocs = infDoc.idDocAnt;

                        if (idDocs != null)
                        {
                            for (int j = 0; j < idDocs.Length; j++)
                            {
                                MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormEmiDocAntIdDocAnt idDoc = idDocs[j];

                                for (int h = 0; h < idDoc.Items.Length; h++)
                                {
                                    object idDocAntTipo = idDoc.Items[h];

                                    if (idDocAntTipo.GetType() == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormEmiDocAntIdDocAntIdDocAntEle))
                                    {
                                        MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormEmiDocAntIdDocAntIdDocAntEle ele = (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormEmiDocAntIdDocAntIdDocAntEle)idDocAntTipo;

                                        Dominio.Entidades.DocumentoDeTransporteAnteriorCTe documento = new Dominio.Entidades.DocumentoDeTransporteAnteriorCTe();

                                        documento.Chave = ele.chCTe;
                                        documento.CTe = conhecimento;
                                        documento.DataEmissao = DateTime.Now;

                                        string cpnj = documento.Chave.Substring(6, 14);

                                        double.TryParse(Utilidades.String.OnlyNumbers(cpnj), out double cnpjcjc);

                                        documento.Emissor = emissores.FirstOrDefault(o => o.CPF_CNPJ == cnpjcjc);

                                        if (documento.Emissor == null)
                                        {
                                            documento.Emissor = repCliente.BuscarPorCPFCNPJ(cnpjcjc);

                                            if (documento.Emissor != null)
                                                emissores.Add(documento.Emissor);
                                            else
                                                throw new ServicoException($"Emissor [{cpnj}] do documento anterior [{documento.Chave}] não está cadastrado.");
                                        }

                                        documento.Numero = documento.Chave.Substring(25, 9);
                                        documento.Serie = documento.Chave.Substring(22, 3);

                                        repDocumento.Inserir(documento);
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        private void ObterInformacoesDocumentosAnteriores(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCte infCTe, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.DocumentoDeTransporteAnteriorCTe repDocumento = new Repositorio.DocumentoDeTransporteAnteriorCTe(unidadeDeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModelo = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);

            if (infCTe.ide.tpServ != MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteIdeTpServ.Item0 && infCTe.Items.FirstOrDefault()?.GetType() == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm))
            {
                MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm info = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm)infCTe.Items.First();
                MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormEmiDocAnt[] docsAnt = info.docAnt;
                if (docsAnt != null)
                {
                    List<Dominio.Entidades.Cliente> emissores = new List<Dominio.Entidades.Cliente>();

                    for (int i = 0; i < docsAnt.Length; i++)
                    {
                        MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormEmiDocAnt infDoc = docsAnt[i];
                        MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormEmiDocAntIdDocAnt[] idDocs = infDoc.idDocAnt;

                        if (idDocs != null)
                        {
                            for (int j = 0; j < idDocs.Length; j++)
                            {
                                MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormEmiDocAntIdDocAnt idDoc = idDocs[j];

                                for (int h = 0; h < idDoc.Items.Length; h++)
                                {
                                    object idDocAntTipo = idDoc.Items[h];

                                    if (idDocAntTipo.GetType() == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormEmiDocAntIdDocAntIdDocAntEle))
                                    {
                                        MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormEmiDocAntIdDocAntIdDocAntEle ele = (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormEmiDocAntIdDocAntIdDocAntEle)idDocAntTipo;

                                        Dominio.Entidades.DocumentoDeTransporteAnteriorCTe documento = new Dominio.Entidades.DocumentoDeTransporteAnteriorCTe();

                                        documento.Chave = ele.chCTe;
                                        documento.CTe = conhecimento;
                                        documento.DataEmissao = DateTime.Now;

                                        string cpnj = documento.Chave.Substring(6, 14);

                                        double.TryParse(Utilidades.String.OnlyNumbers(cpnj), out double cnpjcjc);

                                        documento.Emissor = emissores.FirstOrDefault(o => o.CPF_CNPJ == cnpjcjc);

                                        if (documento.Emissor == null)
                                        {
                                            documento.Emissor = repCliente.BuscarPorCPFCNPJ(cnpjcjc);

                                            if (documento.Emissor != null)
                                                emissores.Add(documento.Emissor);
                                            else
                                                throw new ServicoException($"Emissor [{cpnj}] do documento anterior [{documento.Chave}] não está cadastrado.");
                                        }

                                        documento.Numero = documento.Chave.Substring(25, 9);
                                        documento.Serie = documento.Chave.Substring(22, 3);

                                        repDocumento.Inserir(documento);
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        private void ObterInformacoesCTe(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCte infCTe, bool vincularNotasCTeComplementado, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTe != null)
            {
                Type tipoInfoCTe = infCTe.Item.GetType();
                if (tipoInfoCTe == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm))
                    this.ObterInformacoesCTeNormal(ref conhecimento, (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm)infCTe.Item, true, unidadeTrabalho);
                else if (tipoInfoCTe == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCteComp))
                    this.ObterInformacoesCTeComplementar(ref conhecimento, (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCteComp)infCTe.Item, vincularNotasCTeComplementado, unidadeTrabalho);
                else if (tipoInfoCTe == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCteAnu))
                    this.ObterInformacoesCTeAnulacao(ref conhecimento, (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCteAnu)infCTe.Item, unidadeTrabalho);
            }
        }

        private void ObterInformacoesCTe(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCte infCTe, bool vincularNotasCTeComplementado, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTe != null)
            {
                Type tipoInfoCTe = infCTe.Items.FirstOrDefault()?.GetType();
                if (tipoInfoCTe == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm))
                    this.ObterInformacoesCTeNormal(ref conhecimento, (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm)infCTe.Items.First(), true, unidadeTrabalho);
                else if (tipoInfoCTe == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCteComp))
                    this.ObterInformacoesCTeComplementar(ref conhecimento, (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCteComp)infCTe.Items.First(), vincularNotasCTeComplementado, unidadeTrabalho);
            }
        }

        private void SomarInformacoesCTeSubcontratacao(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCte infCTe, bool importarValores, bool vincularNotasCTeComplementado, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTe != null)
            {
                Type tipoInfoCTe = infCTe.Item.GetType();
                if (tipoInfoCTe == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm))
                {
                    this.ObterInformacoesCTeNormal(ref conhecimento, (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm)infCTe.Item, importarValores, unidadeTrabalho);
                }
                else
                {
                    if (tipoInfoCTe == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCteComp))
                    {
                        this.ObterInformacoesCTeComplementar(ref conhecimento, (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCteComp)infCTe.Item, vincularNotasCTeComplementado, unidadeTrabalho);
                    }
                }
            }
        }

        private void SomarInformacoesCTeSubcontratacao(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCte infCTe, bool importarValores, bool vincularNotasCTeComplementado, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTe != null)
            {
                Type tipoInfoCTe = infCTe.Items.FirstOrDefault()?.GetType();
                if (tipoInfoCTe == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm))
                {
                    this.ObterInformacoesCTeNormal(ref conhecimento, (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm)infCTe.Items.First(), importarValores, unidadeTrabalho);
                }
                else
                {
                    if (tipoInfoCTe == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCteComp))
                    {
                        this.ObterInformacoesCTeComplementar(ref conhecimento, (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCteComp)infCTe.Items.First(), vincularNotasCTeComplementado, unidadeTrabalho);
                    }
                }
            }
        }

        private void ObterInformacoesCTe(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCte infCTe, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTe != null)
            {
                Type tipoInfoCTe = infCTe.Item.GetType();
                if (tipoInfoCTe == typeof(MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCteInfCTeNorm))
                {
                    this.ObterInformacoesCTeNormal(ref conhecimento, (MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCteInfCTeNorm)infCTe.Item, unidadeTrabalho);
                }
            }
        }

        private void ObterInformacoesCTe(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCte infCTe, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTe != null)
            {
                Type tipoInfoCTe = infCTe.Items.FirstOrDefault().GetType();
                if (tipoInfoCTe == typeof(MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCteInfCTeNorm))
                {
                    this.ObterInformacoesCTeNormal(ref conhecimento, (MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCteInfCTeNorm)infCTe.Items.First(), unidadeTrabalho);
                }
            }
        }

        private void ObterInformacoesCTe(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.Envio.TCTeInfCte infCTe, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infCTe != null)
            {
                Type tipoInfoCTe = infCTe.Item.GetType();
                if (tipoInfoCTe == typeof(MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNorm))
                {
                    this.ObterInformacoesCTeNormal(ref conhecimento, (MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNorm)infCTe.Item, unidadeTrabalho);
                }
                else
                {
                    if (tipoInfoCTe == typeof(MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCteComp))
                    {
                        this.ObterInformacoesCTeComplementar(ref conhecimento, (MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCteComp)infCTe.Item, unidadeTrabalho);
                    }
                }
            }
        }

        private void ObterInformacoesCTeComplementar(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCteComp infCTeComple, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeComple != null)
            {
                conhecimento.ChaveCTESubComp = infCTeComple.chave;
            }
        }

        private void ObterInformacoesCTeComplementar(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCteComp infCTeComple, bool vincularNotasCTeComplementado, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeComple != null)
            {
                conhecimento.ChaveCTESubComp = infCTeComple.chCTe;

                if (vincularNotasCTeComplementado)
                {
                    Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                    Repositorio.DocumentosCTE repDocumentosCTE = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                    List<Dominio.Entidades.DocumentosCTE> documentosCTeComplementado = repDocumentosCTE.BuscarPorChaveCTe(conhecimento.Empresa.Codigo, infCTeComple.chCTe);
                    if (documentosCTeComplementado != null)
                    {
                        foreach (Dominio.Entidades.DocumentosCTE documentoAnterior in documentosCTeComplementado)
                        {
                            Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();

                            documento.ChaveNFE = documentoAnterior.ChaveNFE;
                            if (documentoAnterior.DataEmissao > DateTime.MinValue)
                                documento.DataEmissao = documentoAnterior.DataEmissao;
                            else
                                documento.DataEmissao = DateTime.Now;

                            documento.Numero = documentoAnterior.Numero;
                            documento.Serie = documentoAnterior.Serie;
                            documento.CTE = conhecimento;
                            documento.ModeloDocumentoFiscal = documentoAnterior.ModeloDocumentoFiscal;
                            documento.PINSuframa = documentoAnterior.PINSuframa;
                            if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                                documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                            repDocumentosCTE.Inserir(documento);
                        }
                    }
                }
            }
        }

        private void ObterInformacoesCTeComplementar(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCteComp infCTeComple, bool vincularNotasCTeComplementado, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeComple != null)
            {
                conhecimento.ChaveCTESubComp = infCTeComple.chCTe;

                if (vincularNotasCTeComplementado)
                {
                    Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                    Repositorio.DocumentosCTE repDocumentosCTE = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                    List<Dominio.Entidades.DocumentosCTE> documentosCTeComplementado = repDocumentosCTE.BuscarPorChaveCTe(conhecimento.Empresa.Codigo, infCTeComple.chCTe);
                    if (documentosCTeComplementado != null)
                    {
                        foreach (Dominio.Entidades.DocumentosCTE documentoAnterior in documentosCTeComplementado)
                        {
                            Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();

                            documento.ChaveNFE = documentoAnterior.ChaveNFE;
                            if (documentoAnterior.DataEmissao > DateTime.MinValue)
                                documento.DataEmissao = documentoAnterior.DataEmissao;
                            else
                                documento.DataEmissao = DateTime.Now;

                            documento.Numero = documentoAnterior.Numero;
                            documento.Serie = documentoAnterior.Serie;
                            documento.CTE = conhecimento;
                            documento.ModeloDocumentoFiscal = documentoAnterior.ModeloDocumentoFiscal;
                            documento.PINSuframa = documentoAnterior.PINSuframa;
                            if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                                documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                            repDocumentosCTE.Inserir(documento);
                        }
                    }
                }
            }
        }

        private void ObterInformacoesCTeAnulacao(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCteAnu infCTeAnu, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeAnu != null)
            {
                conhecimento.ChaveCTESubComp = infCTeAnu.chCte;
            }
        }

        private void ObterInformacoesCTeComplementar(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCteComp infCTeComple, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeComple != null)
            {
                conhecimento.ChaveCTESubComp = infCTeComple.chave;
            }
        }

        private void ObterInformacoesCTeNormal(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm infCTeNormal, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeNormal != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                conhecimento.ValorTotalMercadoria = decimal.Parse(infCTeNormal.infCarga.vCarga, cultura);
                conhecimento.ProdutoPredominante = infCTeNormal.infCarga.proPred;
                conhecimento.OutrasCaracteristicasDaCarga = infCTeNormal.infCarga.xOutCat;
                this.SalvarInformacoesDeQuantidadeDaCarga(conhecimento, infCTeNormal.infCarga.infQ, unidadeDeTrabalho);
                this.SalvarInformacoesDeSeguroDaCarga(conhecimento, infCTeNormal.seg, unidadeDeTrabalho);
                this.SalvarInformacoesModalRodoviario(ref conhecimento, infCTeNormal.infModal, unidadeDeTrabalho);
            }
        }

        private void ObterInformacoesCTeNormal(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm infCTeNormal, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeNormal != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                conhecimento.ValorTotalMercadoria = decimal.Parse(infCTeNormal.infCarga.vCarga, cultura);
                conhecimento.ProdutoPredominante = infCTeNormal.infCarga.proPred;
                conhecimento.OutrasCaracteristicasDaCarga = infCTeNormal.infCarga.xOutCat;
                this.SalvarInformacoesDeQuantidadeDaCarga(conhecimento, infCTeNormal.infCarga.infQ, unidadeDeTrabalho);
                this.SalvarInformacoesDeSeguroDaCarga(conhecimento, infCTeNormal.seg, unidadeDeTrabalho);

                if (conhecimento.ModalTransporte.modalProcCTe == 1 || conhecimento.ModalTransporte.modalProcCTe == 0) //todo: quando implementar outras modalidade remover isso, aqui apenas ignora o modal se for diferente de rodoviario
                    this.SalvarInformacoesModalRodoviario(ref conhecimento, infCTeNormal.infModal, unidadeDeTrabalho);

                this.SalvarInformacoesDocumentos(conhecimento, infCTeNormal.infDoc, unidadeDeTrabalho);
            }
        }

        private void ObterInformacoesCTeNormal(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm infCTeNormal, bool importarValores, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeNormal != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                if (importarValores)
                    conhecimento.ValorTotalMercadoria += decimal.Parse(infCTeNormal.infCarga.vCarga, cultura);
                conhecimento.ProdutoPredominante = infCTeNormal.infCarga.proPred;
                conhecimento.OutrasCaracteristicasDaCarga = infCTeNormal.infCarga.xOutCat;

                if (importarValores)
                    SalvarInformacoesDeQuantidadeDaCarga(conhecimento, infCTeNormal.infCarga.infQ, unidadeDeTrabalho);

                if (conhecimento.ModalTransporte.modalProcCTe == 1 || conhecimento.ModalTransporte.modalProcCTe == 0) //todo: quando implementar outras modalidade remover isso, aqui apenas ignora o modal se for diferente de rodoviario
                    SalvarInformacoesModalRodoviario(ref conhecimento, infCTeNormal.infModal, unidadeDeTrabalho);

                SalvarInformacoesDocumentos(conhecimento, infCTeNormal.infDoc, unidadeDeTrabalho);
                SalvarInformacoesSubstituicao(conhecimento, infCTeNormal.infCteSub, unidadeDeTrabalho);
            }
        }

        private void ObterInformacoesCTeNormal(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm infCTeNormal, bool importarValores, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeNormal != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                if (importarValores)
                    conhecimento.ValorTotalMercadoria += decimal.Parse(infCTeNormal.infCarga.vCarga, cultura);
                conhecimento.ProdutoPredominante = infCTeNormal.infCarga.proPred;
                conhecimento.OutrasCaracteristicasDaCarga = infCTeNormal.infCarga.xOutCat;

                if (importarValores)
                    SalvarInformacoesDeQuantidadeDaCarga(conhecimento, infCTeNormal.infCarga.infQ, unidadeDeTrabalho);

                if (conhecimento.ModalTransporte.modalProcCTe == 1 || conhecimento.ModalTransporte.modalProcCTe == 0) //todo: quando implementar outras modalidade remover isso, aqui apenas ignora o modal se for diferente de rodoviario
                    SalvarInformacoesModalRodoviario(ref conhecimento, infCTeNormal.infModal, unidadeDeTrabalho);

                SalvarInformacoesDocumentos(conhecimento, infCTeNormal.infDoc, unidadeDeTrabalho);
                SalvarInformacoesSubstituicao(conhecimento, infCTeNormal.infCteSub, unidadeDeTrabalho);
            }
        }

        private void SomarInformacoesCTeNormalSubcontratacao(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm infCTeNormal, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeNormal != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                conhecimento.ValorTotalMercadoria += decimal.Parse(infCTeNormal.infCarga.vCarga, cultura);
                this.SalvarInformacoesDeQuantidadeDaCarga(conhecimento, infCTeNormal.infCarga.infQ, unidadeDeTrabalho);

                this.SalvarInformacoesDocumentos(conhecimento, infCTeNormal.infDoc, unidadeDeTrabalho);
            }
        }

        private void SomarInformacoesCTeNormalSubcontratacao(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNorm infCTeNormal, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeNormal != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                conhecimento.ValorTotalMercadoria += decimal.Parse(infCTeNormal.infCarga.vCarga, cultura);
                this.SalvarInformacoesDeQuantidadeDaCarga(conhecimento, infCTeNormal.infCarga.infQ, unidadeDeTrabalho);

                this.SalvarInformacoesDocumentos(conhecimento, infCTeNormal.infDoc, unidadeDeTrabalho);
            }
        }

        private void ObterInformacoesCTeNormal(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCteInfCTeNorm infCTeNormal, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeNormal != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                conhecimento.ValorTotalMercadoria = 0;
                conhecimento.CaracteristicaServico = infCTeNormal.infServico.xDescServ.Length > 30 ? infCTeNormal.infServico.xDescServ.Substring(0, 30) : infCTeNormal.infServico.xDescServ;
                this.SalvarInformacoesDeQuantidadeDaCarga(conhecimento, infCTeNormal.infServico.infQ, unidadeDeTrabalho);


                if (conhecimento.ModalTransporte.modalProcCTe == 1 || conhecimento.ModalTransporte.modalProcCTe == 0) //todo: quando implementar outras modalidade remover isso, aqui apenas ignora o modal se for diferente de rodoviario
                    this.SalvarInformacoesModalRodoviario(ref conhecimento, infCTeNormal.infModal, unidadeDeTrabalho);

                this.SalvarInformacoesDocumentos(conhecimento, infCTeNormal.infDocRef, unidadeDeTrabalho);
            }
        }

        private void ObterInformacoesCTeNormal(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCteInfCTeNorm infCTeNormal, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeNormal != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                conhecimento.ValorTotalMercadoria = 0;
                conhecimento.CaracteristicaServico = infCTeNormal.infServico.xDescServ.Length > 30 ? infCTeNormal.infServico.xDescServ.Substring(0, 30) : infCTeNormal.infServico.xDescServ;
                this.SalvarInformacoesDeQuantidadeDaCarga(conhecimento, infCTeNormal.infServico.infQ, unidadeDeTrabalho);


                if (conhecimento.ModalTransporte.modalProcCTe == 1 || conhecimento.ModalTransporte.modalProcCTe == 0) //todo: quando implementar outras modalidade remover isso, aqui apenas ignora o modal se for diferente de rodoviario
                    this.SalvarInformacoesModalRodoviario(ref conhecimento, infCTeNormal.infModal, unidadeDeTrabalho);

                this.SalvarInformacoesDocumentos(conhecimento, infCTeNormal.infDocRef, unidadeDeTrabalho);
            }
        }

        private void ObterInformacoesCTeNormal(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNorm infCTeNormal, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infCTeNormal != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                conhecimento.ValorTotalMercadoria = decimal.Parse(infCTeNormal.infCarga.vCarga, cultura);
                conhecimento.ProdutoPredominante = infCTeNormal.infCarga.proPred;
                conhecimento.OutrasCaracteristicasDaCarga = infCTeNormal.infCarga.xOutCat;
                this.SalvarInformacoesDeQuantidadeDaCarga(conhecimento, infCTeNormal.infCarga.infQ, unidadeDeTrabalho);
                this.SalvarInformacoesDeSeguroDaCarga(conhecimento, infCTeNormal.seg, unidadeDeTrabalho);

                if (conhecimento.ModalTransporte.modalProcCTe == 1 || conhecimento.ModalTransporte.modalProcCTe == 0) //todo: quando implementar outras modalidade remover isso, aqui apenas ignora o modal se for diferente de rodoviario
                    this.SalvarInformacoesModalRodoviario(ref conhecimento, infCTeNormal.infModal, unidadeDeTrabalho);

                this.SalvarInformacoesDocumentos(conhecimento, infCTeNormal.infDoc, unidadeDeTrabalho);
            }
        }

        private void SalvarInformacoesComponentesDaPrestacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteVPrestComp[] infCTeComp, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ComponentePrestacaoCTE repCompPrestCTe = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            if (infCTeComp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                foreach (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteVPrestComp comp in infCTeComp)
                {
                    if (!comp.xNome.ToUpper().Contains("VALOR FRETE") && !comp.xNome.ToUpper().Contains("FRETE VALOR") && !comp.xNome.ToUpper().Contains("IMPOSTOS"))
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteDaPrestacao = new Dominio.Entidades.ComponentePrestacaoCTE();

                        componenteDaPrestacao.CTE = conhecimento;
                        componenteDaPrestacao.Nome = comp.xNome;
                        componenteDaPrestacao.Valor = Math.Round(decimal.Parse(comp.vComp, cultura), 2, MidpointRounding.ToEven);
                        componenteDaPrestacao.IncluiNaBaseDeCalculoDoICMS = false;
                        componenteDaPrestacao.IncluiNoTotalAReceber = false;

                        repCompPrestCTe.Inserir(componenteDaPrestacao);
                    }
                }
            }

            if ((conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && conhecimento.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim) || (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0))
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteImpostos = new Dominio.Entidades.ComponentePrestacaoCTE();
                componenteImpostos.CTE = conhecimento;
                componenteImpostos.Nome = "IMPOSTOS";
                componenteImpostos.Valor = Math.Round(conhecimento.ValorICMS, 2, MidpointRounding.ToEven);
                componenteImpostos.IncluiNaBaseDeCalculoDoICMS = false;

                if (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0)
                    componenteImpostos.IncluiNoTotalAReceber = true;
                else
                    componenteImpostos.IncluiNoTotalAReceber = false;

                repCompPrestCTe.Inserir(componenteImpostos);
            }

            Dominio.Entidades.ComponentePrestacaoCTE componentePadrao = new Dominio.Entidades.ComponentePrestacaoCTE();

            componentePadrao.CTE = conhecimento;
            componentePadrao.Nome = "FRETE VALOR";
            componentePadrao.Valor = Math.Round(conhecimento.ValorFrete, 2, MidpointRounding.ToEven);
            componentePadrao.IncluiNaBaseDeCalculoDoICMS = false;
            componentePadrao.IncluiNoTotalAReceber = true;

            repCompPrestCTe.Inserir(componentePadrao);
        }

        private void SalvarInformacoesComponentesDaPrestacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCteVPrestComp[] infCTeComp, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ComponentePrestacaoCTE repCompPrestCTe = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            if (infCTeComp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                foreach (MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCteVPrestComp comp in infCTeComp)
                {
                    if (!comp.xNome.ToUpper().Contains("VALOR FRETE") && !comp.xNome.ToUpper().Contains("FRETE VALOR") && !comp.xNome.ToUpper().Contains("IMPOSTOS"))
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteDaPrestacao = new Dominio.Entidades.ComponentePrestacaoCTE();

                        componenteDaPrestacao.CTE = conhecimento;
                        componenteDaPrestacao.Nome = comp.xNome;
                        componenteDaPrestacao.Valor = Math.Round(decimal.Parse(comp.vComp, cultura), 2, MidpointRounding.ToEven);
                        componenteDaPrestacao.IncluiNaBaseDeCalculoDoICMS = false;
                        componenteDaPrestacao.IncluiNoTotalAReceber = false;

                        repCompPrestCTe.Inserir(componenteDaPrestacao);
                    }
                }
            }

            if ((conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && conhecimento.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim) || (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0))
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteImpostos = new Dominio.Entidades.ComponentePrestacaoCTE();
                componenteImpostos.CTE = conhecimento;
                componenteImpostos.Nome = "IMPOSTOS";
                componenteImpostos.Valor = Math.Round(conhecimento.ValorICMS, 2, MidpointRounding.ToEven);
                componenteImpostos.IncluiNaBaseDeCalculoDoICMS = false;

                if (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0)
                    componenteImpostos.IncluiNoTotalAReceber = true;
                else
                    componenteImpostos.IncluiNoTotalAReceber = false;

                repCompPrestCTe.Inserir(componenteImpostos);
            }

            Dominio.Entidades.ComponentePrestacaoCTE componentePadrao = new Dominio.Entidades.ComponentePrestacaoCTE();

            componentePadrao.CTE = conhecimento;
            componentePadrao.Nome = "FRETE VALOR";
            componentePadrao.Valor = Math.Round(conhecimento.ValorFrete, 2, MidpointRounding.ToEven);
            componentePadrao.IncluiNaBaseDeCalculoDoICMS = false;
            componentePadrao.IncluiNoTotalAReceber = true;

            repCompPrestCTe.Inserir(componentePadrao);
        }

        private void SalvarInformacoesComponentesDaPrestacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCteVPrestComp[] infCTeComp, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ComponentePrestacaoCTE repCompPrestCTe = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            if (infCTeComp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                foreach (MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCteVPrestComp comp in infCTeComp)
                {
                    if (!comp.xNome.ToUpper().Contains("VALOR FRETE") && !comp.xNome.ToUpper().Contains("FRETE VALOR") && !comp.xNome.ToUpper().Contains("IMPOSTOS"))
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteDaPrestacao = new Dominio.Entidades.ComponentePrestacaoCTE();

                        componenteDaPrestacao.CTE = conhecimento;
                        componenteDaPrestacao.Nome = comp.xNome;
                        componenteDaPrestacao.Valor = Math.Round(decimal.Parse(comp.vComp, cultura), 2, MidpointRounding.ToEven);
                        componenteDaPrestacao.IncluiNaBaseDeCalculoDoICMS = false;
                        componenteDaPrestacao.IncluiNoTotalAReceber = false;

                        repCompPrestCTe.Inserir(componenteDaPrestacao);
                    }
                }
            }

            if ((conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && conhecimento.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim) || (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0))
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteImpostos = new Dominio.Entidades.ComponentePrestacaoCTE();
                componenteImpostos.CTE = conhecimento;
                componenteImpostos.Nome = "IMPOSTOS";
                componenteImpostos.Valor = Math.Round(conhecimento.ValorICMS, 2, MidpointRounding.ToEven);
                componenteImpostos.IncluiNaBaseDeCalculoDoICMS = false;

                if (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0)
                    componenteImpostos.IncluiNoTotalAReceber = true;
                else
                    componenteImpostos.IncluiNoTotalAReceber = false;

                repCompPrestCTe.Inserir(componenteImpostos);
            }

            Dominio.Entidades.ComponentePrestacaoCTE componentePadrao = new Dominio.Entidades.ComponentePrestacaoCTE();

            componentePadrao.CTE = conhecimento;
            componentePadrao.Nome = "FRETE VALOR";
            componentePadrao.Valor = Math.Round(conhecimento.ValorFrete, 2, MidpointRounding.ToEven);
            componentePadrao.IncluiNaBaseDeCalculoDoICMS = false;
            componentePadrao.IncluiNoTotalAReceber = true;

            repCompPrestCTe.Inserir(componentePadrao);
        }

        private void SalvarInformacoesComponentesDaPrestacaoPreCTe(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteVPrestComp[] infCTeComp, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ComponentePrestacaoCTE repCompPrestCTe = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            if (infCTeComp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                foreach (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteVPrestComp comp in infCTeComp)
                {
                    if (!comp.xNome.ToUpper().Contains("VALOR FRETE") && !comp.xNome.ToUpper().Contains("FRETE VALOR") && !comp.xNome.ToUpper().Contains("IMPOSTOS"))
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteDaPrestacao = new Dominio.Entidades.ComponentePrestacaoCTE();

                        componenteDaPrestacao.CTE = conhecimento;
                        componenteDaPrestacao.Nome = comp.xNome;
                        componenteDaPrestacao.Valor = Math.Round(decimal.Parse(comp.vComp, cultura), 2, MidpointRounding.ToEven);
                        componenteDaPrestacao.IncluiNaBaseDeCalculoDoICMS = false;
                        componenteDaPrestacao.IncluiNoTotalAReceber = false;

                        repCompPrestCTe.Inserir(componenteDaPrestacao);
                    }
                }
            }

            if ((conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && conhecimento.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim) || (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0))
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteImpostos = new Dominio.Entidades.ComponentePrestacaoCTE();
                componenteImpostos.CTE = conhecimento;
                componenteImpostos.Nome = "IMPOSTOS";
                componenteImpostos.Valor = Math.Round(conhecimento.ValorICMS, 2, MidpointRounding.ToEven);
                componenteImpostos.IncluiNaBaseDeCalculoDoICMS = false;

                if (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0)
                    componenteImpostos.IncluiNoTotalAReceber = true;
                else
                    componenteImpostos.IncluiNoTotalAReceber = false;

                repCompPrestCTe.Inserir(componenteImpostos);
            }

            Dominio.Entidades.ComponentePrestacaoCTE componentePadrao = new Dominio.Entidades.ComponentePrestacaoCTE();

            componentePadrao.CTE = conhecimento;
            componentePadrao.Nome = "FRETE VALOR";
            componentePadrao.Valor = Math.Round(conhecimento.ValorFrete, 2, MidpointRounding.ToEven);
            componentePadrao.IncluiNaBaseDeCalculoDoICMS = false;
            componentePadrao.IncluiNoTotalAReceber = true;

            repCompPrestCTe.Inserir(componentePadrao);
        }

        private void SalvarInformacoesComponentesDaPrestacaoPreCTe(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteVPrestComp[] infCTeComp, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ComponentePrestacaoCTE repCompPrestCTe = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            if (infCTeComp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                foreach (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteVPrestComp comp in infCTeComp)
                {
                    if (!comp.xNome.ToUpper().Contains("VALOR FRETE") && !comp.xNome.ToUpper().Contains("FRETE VALOR") && !comp.xNome.ToUpper().Contains("IMPOSTOS"))
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteDaPrestacao = repCompPrestCTe.BuscarPrimeiroPorCTeDescricao(conhecimento.Codigo, comp.xNome);
                        if (componenteDaPrestacao == null)
                            componenteDaPrestacao = new Dominio.Entidades.ComponentePrestacaoCTE();

                        componenteDaPrestacao.CTE = conhecimento;
                        componenteDaPrestacao.Nome = comp.xNome;
                        componenteDaPrestacao.Valor += Math.Round(decimal.Parse(comp.vComp, cultura), 2, MidpointRounding.ToEven);
                        componenteDaPrestacao.IncluiNaBaseDeCalculoDoICMS = false;
                        componenteDaPrestacao.IncluiNoTotalAReceber = false;

                        if (componenteDaPrestacao.Codigo > 0)
                            repCompPrestCTe.Atualizar(componenteDaPrestacao);
                        else
                            repCompPrestCTe.Inserir(componenteDaPrestacao);
                    }
                }
            }

            if ((conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && conhecimento.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim) || (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0))
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteImpostos = repCompPrestCTe.BuscarPrimeiroPorCTeDescricao(conhecimento.Codigo, "IMPOSTOS");
                if (componenteImpostos == null)
                    componenteImpostos = new Dominio.Entidades.ComponentePrestacaoCTE();
                componenteImpostos.CTE = conhecimento;
                componenteImpostos.Nome = "IMPOSTOS";
                componenteImpostos.Valor = Math.Round(conhecimento.ValorICMS, 2, MidpointRounding.ToEven);
                componenteImpostos.IncluiNaBaseDeCalculoDoICMS = false;

                if (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0)
                    componenteImpostos.IncluiNoTotalAReceber = true;
                else
                    componenteImpostos.IncluiNoTotalAReceber = false;

                if (componenteImpostos.Codigo > 0)
                    repCompPrestCTe.Atualizar(componenteImpostos);
                repCompPrestCTe.Inserir(componenteImpostos);
            }

            Dominio.Entidades.ComponentePrestacaoCTE componentePadrao = repCompPrestCTe.BuscarPrimeiroPorCTeDescricao(conhecimento.Codigo, "FRETE VALOR");
            if (componentePadrao == null)
                componentePadrao = new Dominio.Entidades.ComponentePrestacaoCTE();

            componentePadrao.CTE = conhecimento;
            componentePadrao.Nome = "FRETE VALOR";
            componentePadrao.Valor += Math.Round(conhecimento.ValorFrete, 2, MidpointRounding.ToEven);
            componentePadrao.IncluiNaBaseDeCalculoDoICMS = false;
            componentePadrao.IncluiNoTotalAReceber = true;

            if (componentePadrao.Codigo > 0)
                repCompPrestCTe.Atualizar(componentePadrao);
            repCompPrestCTe.Inserir(componentePadrao);
        }

        private void SalvarInformacoesComponentesDaPrestacaoPreCTe(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteVPrestComp[] infCTeComp, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ComponentePrestacaoCTE repCompPrestCTe = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            if (infCTeComp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                foreach (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteVPrestComp comp in infCTeComp)
                {
                    if (!comp.xNome.ToUpper().Contains("VALOR FRETE") && !comp.xNome.ToUpper().Contains("FRETE VALOR") && !comp.xNome.ToUpper().Contains("IMPOSTOS"))
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteDaPrestacao = repCompPrestCTe.BuscarPrimeiroPorCTeDescricao(conhecimento.Codigo, comp.xNome);
                        if (componenteDaPrestacao == null)
                            componenteDaPrestacao = new Dominio.Entidades.ComponentePrestacaoCTE();

                        componenteDaPrestacao.CTE = conhecimento;
                        componenteDaPrestacao.Nome = comp.xNome;
                        componenteDaPrestacao.Valor += Math.Round(decimal.Parse(comp.vComp, cultura), 2, MidpointRounding.ToEven);
                        componenteDaPrestacao.IncluiNaBaseDeCalculoDoICMS = false;
                        componenteDaPrestacao.IncluiNoTotalAReceber = false;

                        if (componenteDaPrestacao.Codigo > 0)
                            repCompPrestCTe.Atualizar(componenteDaPrestacao);
                        else
                            repCompPrestCTe.Inserir(componenteDaPrestacao);
                    }
                }
            }

            if ((conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && conhecimento.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim) || (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0))
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteImpostos = repCompPrestCTe.BuscarPrimeiroPorCTeDescricao(conhecimento.Codigo, "IMPOSTOS");
                if (componenteImpostos == null)
                    componenteImpostos = new Dominio.Entidades.ComponentePrestacaoCTE();
                componenteImpostos.CTE = conhecimento;
                componenteImpostos.Nome = "IMPOSTOS";
                componenteImpostos.Valor = Math.Round(conhecimento.ValorICMS, 2, MidpointRounding.ToEven);
                componenteImpostos.IncluiNaBaseDeCalculoDoICMS = false;

                if (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0)
                    componenteImpostos.IncluiNoTotalAReceber = true;
                else
                    componenteImpostos.IncluiNoTotalAReceber = false;

                if (componenteImpostos.Codigo > 0)
                    repCompPrestCTe.Atualizar(componenteImpostos);
                repCompPrestCTe.Inserir(componenteImpostos);
            }

            Dominio.Entidades.ComponentePrestacaoCTE componentePadrao = repCompPrestCTe.BuscarPrimeiroPorCTeDescricao(conhecimento.Codigo, "FRETE VALOR");
            if (componentePadrao == null)
                componentePadrao = new Dominio.Entidades.ComponentePrestacaoCTE();

            componentePadrao.CTE = conhecimento;
            componentePadrao.Nome = "FRETE VALOR";
            componentePadrao.Valor += Math.Round(conhecimento.ValorFrete, 2, MidpointRounding.ToEven);
            componentePadrao.IncluiNaBaseDeCalculoDoICMS = false;
            componentePadrao.IncluiNoTotalAReceber = true;

            if (componentePadrao.Codigo > 0)
                repCompPrestCTe.Atualizar(componentePadrao);
            repCompPrestCTe.Inserir(componentePadrao);
        }

        private void SalvarInformacoesComponentesDaPrestacaoPreCTe(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCteVPrestComp[] infCTeComp, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ComponentePrestacaoCTE repCompPrestCTe = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            if (infCTeComp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                foreach (MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCteVPrestComp comp in infCTeComp)
                {
                    if (!comp.xNome.ToUpper().Contains("VALOR FRETE") && !comp.xNome.ToUpper().Contains("FRETE VALOR") && !comp.xNome.ToUpper().Contains("IMPOSTOS"))
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteDaPrestacao = new Dominio.Entidades.ComponentePrestacaoCTE();

                        componenteDaPrestacao.CTE = conhecimento;
                        componenteDaPrestacao.Nome = comp.xNome;
                        componenteDaPrestacao.Valor = Math.Round(decimal.Parse(comp.vComp, cultura), 2, MidpointRounding.ToEven);
                        componenteDaPrestacao.IncluiNaBaseDeCalculoDoICMS = false;
                        componenteDaPrestacao.IncluiNoTotalAReceber = false;

                        repCompPrestCTe.Inserir(componenteDaPrestacao);
                    }
                }
            }

            if ((conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && conhecimento.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim) || (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0))
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteImpostos = new Dominio.Entidades.ComponentePrestacaoCTE();
                componenteImpostos.CTE = conhecimento;
                componenteImpostos.Nome = "IMPOSTOS";
                componenteImpostos.Valor = Math.Round(conhecimento.ValorICMS, 2, MidpointRounding.ToEven);
                componenteImpostos.IncluiNaBaseDeCalculoDoICMS = false;

                if (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0)
                    componenteImpostos.IncluiNoTotalAReceber = true;
                else
                    componenteImpostos.IncluiNoTotalAReceber = false;

                repCompPrestCTe.Inserir(componenteImpostos);
            }

            Dominio.Entidades.ComponentePrestacaoCTE componentePadrao = new Dominio.Entidades.ComponentePrestacaoCTE();

            componentePadrao.CTE = conhecimento;
            componentePadrao.Nome = "FRETE VALOR";
            componentePadrao.Valor = Math.Round(conhecimento.ValorFrete, 2, MidpointRounding.ToEven);
            componentePadrao.IncluiNaBaseDeCalculoDoICMS = false;
            componentePadrao.IncluiNoTotalAReceber = true;

            repCompPrestCTe.Inserir(componentePadrao);
        }

        private void SalvarInformacoesComponentesDaPrestacaoPreCTe(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCteVPrestComp[] infCTeComp, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ComponentePrestacaoCTE repCompPrestCTe = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            if (infCTeComp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                foreach (MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCteVPrestComp comp in infCTeComp)
                {
                    if (!comp.xNome.ToUpper().Contains("VALOR FRETE") && !comp.xNome.ToUpper().Contains("FRETE VALOR") && !comp.xNome.ToUpper().Contains("IMPOSTOS"))
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteDaPrestacao = new Dominio.Entidades.ComponentePrestacaoCTE();

                        componenteDaPrestacao.CTE = conhecimento;
                        componenteDaPrestacao.Nome = comp.xNome;
                        componenteDaPrestacao.Valor = Math.Round(decimal.Parse(comp.vComp, cultura), 2, MidpointRounding.ToEven);
                        componenteDaPrestacao.IncluiNaBaseDeCalculoDoICMS = false;
                        componenteDaPrestacao.IncluiNoTotalAReceber = false;

                        repCompPrestCTe.Inserir(componenteDaPrestacao);
                    }
                }
            }

            if ((conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && conhecimento.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim) || (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0))
            {
                Dominio.Entidades.ComponentePrestacaoCTE componenteImpostos = new Dominio.Entidades.ComponentePrestacaoCTE();
                componenteImpostos.CTE = conhecimento;
                componenteImpostos.Nome = "IMPOSTOS";
                componenteImpostos.Valor = Math.Round(conhecimento.ValorICMS, 2, MidpointRounding.ToEven);
                componenteImpostos.IncluiNaBaseDeCalculoDoICMS = false;

                if (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0)
                    componenteImpostos.IncluiNoTotalAReceber = true;
                else
                    componenteImpostos.IncluiNoTotalAReceber = false;

                repCompPrestCTe.Inserir(componenteImpostos);
            }

            Dominio.Entidades.ComponentePrestacaoCTE componentePadrao = new Dominio.Entidades.ComponentePrestacaoCTE();

            componentePadrao.CTE = conhecimento;
            componentePadrao.Nome = "FRETE VALOR";
            componentePadrao.Valor = Math.Round(conhecimento.ValorFrete, 2, MidpointRounding.ToEven);
            componentePadrao.IncluiNaBaseDeCalculoDoICMS = false;
            componentePadrao.IncluiNoTotalAReceber = true;

            repCompPrestCTe.Inserir(componentePadrao);
        }

        private void SalvarInformacoesComponentesDaPrestacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteVPrestComp[] infCTeComp, Repositorio.UnitOfWork unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            Repositorio.ComponentePrestacaoCTE repCompPrestCTe = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            bool adicionadoComponenteValorFrete = false;
            bool adicionadoComponenteImpostos = false;

            if (infCTeComp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                foreach (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteVPrestComp comp in infCTeComp)
                {
                    Dominio.Entidades.ComponentePrestacaoCTE componenteDaPrestacao = new Dominio.Entidades.ComponentePrestacaoCTE();

                    componenteDaPrestacao.CTE = conhecimento;
                    componenteDaPrestacao.Nome = comp.xNome;
                    componenteDaPrestacao.Valor = Math.Round(decimal.Parse(comp.vComp, cultura), 2, MidpointRounding.ToEven);
                    componenteDaPrestacao.IncluiNaBaseDeCalculoDoICMS = false;

                    if (!tipoServicoMultisoftware.HasValue || tipoServicoMultisoftware != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        if (comp.xNome.ToUpper().Contains("VALOR FRETE") || comp.xNome.ToUpper().Contains("FRETE VALOR"))
                            componenteDaPrestacao.IncluiNoTotalAReceber = true;
                        else
                            componenteDaPrestacao.IncluiNoTotalAReceber = false;

                        if (comp.xNome.ToUpper().Contains("VALOR FRETE") || comp.xNome.ToUpper().Contains("FRETE VALOR"))
                            adicionadoComponenteValorFrete = true;

                        if (comp.xNome.ToUpper().Contains("IMPOSTOS"))
                            adicionadoComponenteImpostos = true;
                    }

                    repCompPrestCTe.Inserir(componenteDaPrestacao);
                }
            }

            if (!tipoServicoMultisoftware.HasValue || tipoServicoMultisoftware != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
            {
                if (!adicionadoComponenteImpostos)
                {
                    if ((conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && conhecimento.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim) || (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0))
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteImpostos = new Dominio.Entidades.ComponentePrestacaoCTE();
                        componenteImpostos.CTE = conhecimento;
                        componenteImpostos.Nome = "IMPOSTOS";
                        componenteImpostos.Valor = Math.Round(conhecimento.ValorICMS, 2, MidpointRounding.ToEven);
                        componenteImpostos.IncluiNaBaseDeCalculoDoICMS = false;

                        if (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0)
                            componenteImpostos.IncluiNoTotalAReceber = true;
                        else
                            componenteImpostos.IncluiNoTotalAReceber = false;

                        repCompPrestCTe.Inserir(componenteImpostos);
                    }
                }

                if (!adicionadoComponenteValorFrete)
                {
                    Dominio.Entidades.ComponentePrestacaoCTE componentePadrao = new Dominio.Entidades.ComponentePrestacaoCTE();

                    componentePadrao.CTE = conhecimento;
                    componentePadrao.Nome = "FRETE VALOR";
                    componentePadrao.Valor = Math.Round(conhecimento.ValorFrete, 2, MidpointRounding.ToEven);
                    componentePadrao.IncluiNaBaseDeCalculoDoICMS = false;
                    componentePadrao.IncluiNoTotalAReceber = true;

                    repCompPrestCTe.Inserir(componentePadrao);
                }
            }
        }

        private void SalvarInformacoesComponentesDaPrestacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteVPrestComp[] infCTeComp, Repositorio.UnitOfWork unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            Repositorio.ComponentePrestacaoCTE repCompPrestCTe = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            bool adicionadoComponenteValorFrete = false;
            bool adicionadoComponenteImpostos = false;

            if (infCTeComp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                foreach (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteVPrestComp comp in infCTeComp)
                {
                    Dominio.Entidades.ComponentePrestacaoCTE componenteDaPrestacao = new Dominio.Entidades.ComponentePrestacaoCTE();

                    componenteDaPrestacao.CTE = conhecimento;
                    componenteDaPrestacao.Nome = comp.xNome;
                    componenteDaPrestacao.Valor = Math.Round(decimal.Parse(comp.vComp, cultura), 2, MidpointRounding.ToEven);
                    componenteDaPrestacao.IncluiNaBaseDeCalculoDoICMS = false;

                    if (!tipoServicoMultisoftware.HasValue || tipoServicoMultisoftware != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        if (comp.xNome.ToUpper().Contains("VALOR FRETE") || comp.xNome.ToUpper().Contains("FRETE VALOR"))
                            componenteDaPrestacao.IncluiNoTotalAReceber = true;
                        else
                            componenteDaPrestacao.IncluiNoTotalAReceber = false;

                        if (comp.xNome.ToUpper().Contains("VALOR FRETE") || comp.xNome.ToUpper().Contains("FRETE VALOR"))
                            adicionadoComponenteValorFrete = true;

                        if (comp.xNome.ToUpper().Contains("IMPOSTOS"))
                            adicionadoComponenteImpostos = true;
                    }

                    repCompPrestCTe.Inserir(componenteDaPrestacao);
                }
            }

            if (!tipoServicoMultisoftware.HasValue || tipoServicoMultisoftware != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
            {
                if (!adicionadoComponenteImpostos)
                {
                    if ((conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && conhecimento.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim) || (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0))
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteImpostos = new Dominio.Entidades.ComponentePrestacaoCTE();
                        componenteImpostos.CTE = conhecimento;
                        componenteImpostos.Nome = "IMPOSTOS";
                        componenteImpostos.Valor = Math.Round(conhecimento.ValorICMS, 2, MidpointRounding.ToEven);
                        componenteImpostos.IncluiNaBaseDeCalculoDoICMS = false;

                        if (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0)
                            componenteImpostos.IncluiNoTotalAReceber = true;
                        else
                            componenteImpostos.IncluiNoTotalAReceber = false;

                        repCompPrestCTe.Inserir(componenteImpostos);
                    }
                }

                if (!adicionadoComponenteValorFrete)
                {
                    Dominio.Entidades.ComponentePrestacaoCTE componentePadrao = new Dominio.Entidades.ComponentePrestacaoCTE();

                    componentePadrao.CTE = conhecimento;
                    componentePadrao.Nome = "FRETE VALOR";
                    componentePadrao.Valor = Math.Round(conhecimento.ValorFrete, 2, MidpointRounding.ToEven);
                    componentePadrao.IncluiNaBaseDeCalculoDoICMS = false;
                    componentePadrao.IncluiNoTotalAReceber = true;

                    repCompPrestCTe.Inserir(componentePadrao);
                }
            }
        }

        private void SalvarInformacoesComponentesDaPrestacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteVPrestComp[] infCTeComp, Repositorio.UnitOfWork unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            Repositorio.ComponentePrestacaoCTE repCompPrestCTe = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            bool adicionadoComponenteValorFrete = false;
            bool adicionadoComponenteImpostos = false;

            if (infCTeComp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                foreach (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteVPrestComp comp in infCTeComp)
                {
                    Dominio.Entidades.ComponentePrestacaoCTE componenteDaPrestacao = new Dominio.Entidades.ComponentePrestacaoCTE();

                    componenteDaPrestacao.CTE = conhecimento;
                    componenteDaPrestacao.Nome = comp.xNome;
                    componenteDaPrestacao.Valor = Math.Round(decimal.Parse(comp.vComp, cultura), 2, MidpointRounding.ToEven);
                    componenteDaPrestacao.IncluiNaBaseDeCalculoDoICMS = false;

                    if (!tipoServicoMultisoftware.HasValue || tipoServicoMultisoftware != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                    {
                        if (comp.xNome.ToUpper().Contains("VALOR FRETE") || comp.xNome.ToUpper().Contains("FRETE VALOR"))
                            componenteDaPrestacao.IncluiNoTotalAReceber = true;
                        else
                            componenteDaPrestacao.IncluiNoTotalAReceber = false;

                        if (comp.xNome.ToUpper().Contains("VALOR FRETE") || comp.xNome.ToUpper().Contains("FRETE VALOR"))
                            adicionadoComponenteValorFrete = true;

                        if (comp.xNome.ToUpper().Contains("IMPOSTOS"))
                            adicionadoComponenteImpostos = true;
                    }

                    repCompPrestCTe.Inserir(componenteDaPrestacao);
                }
            }

            if (!tipoServicoMultisoftware.HasValue || tipoServicoMultisoftware != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
            {
                if (!adicionadoComponenteImpostos)
                {
                    if ((conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && conhecimento.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim) || (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0))
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteImpostos = new Dominio.Entidades.ComponentePrestacaoCTE();
                        componenteImpostos.CTE = conhecimento;
                        componenteImpostos.Nome = "IMPOSTOS";
                        componenteImpostos.Valor = Math.Round(conhecimento.ValorICMS, 2, MidpointRounding.ToEven);
                        componenteImpostos.IncluiNaBaseDeCalculoDoICMS = false;

                        if (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0)
                            componenteImpostos.IncluiNoTotalAReceber = true;
                        else
                            componenteImpostos.IncluiNoTotalAReceber = false;

                        repCompPrestCTe.Inserir(componenteImpostos);
                    }
                }

                if (!adicionadoComponenteValorFrete)
                {
                    Dominio.Entidades.ComponentePrestacaoCTE componentePadrao = new Dominio.Entidades.ComponentePrestacaoCTE();

                    componentePadrao.CTE = conhecimento;
                    componentePadrao.Nome = "FRETE VALOR";
                    componentePadrao.Valor = Math.Round(conhecimento.ValorFrete, 2, MidpointRounding.ToEven);
                    componentePadrao.IncluiNaBaseDeCalculoDoICMS = false;
                    componentePadrao.IncluiNoTotalAReceber = true;

                    repCompPrestCTe.Inserir(componentePadrao);
                }
            }
        }

        private bool ValidarEmissaoImpostosIBSCBS(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ConhecimentoDeTransporteEletronico repositorioConhecimentoDeTransporteEletronico = new Repositorio.ConhecimentoDeTransporteEletronico(unitOfWork);
            Repositorio.Embarcador.Configuracoes.ConfiguracaoIntegracaoEmissorDocumento repConfiguracaoIntegracaoEmissorDocumento = new Repositorio.Embarcador.Configuracoes.ConfiguracaoIntegracaoEmissorDocumento(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoIntegracaoEmissorDocumento configuracaoIntegracaoEmissorDocumento = repConfiguracaoIntegracaoEmissorDocumento.BuscarConfiguracaoPadrao();

            if (!cte.Empresa.OptanteSimplesNacional && ((string.IsNullOrEmpty(cte.CSTIBSCBS) || string.IsNullOrEmpty(cte.ClassificacaoTributariaIBSCBS)) && (DateTime.Now >= configuracaoIntegracaoEmissorDocumento.DataLiberacaoImpostos || (cte.Empresa?.Configuracao?.EnviarNovoImposto ?? false))))
            {
                if (cte != null) Servicos.Auditoria.Auditoria.Auditar(new Dominio.ObjetosDeValor.Embarcador.Auditoria.Auditado { OrigemAuditado = Dominio.ObjetosDeValor.Enumerador.OrigemAuditado.Sistema, TipoAuditado = Dominio.ObjetosDeValor.Enumerador.TipoAuditado.Sistema }, cte, "Para a emissão do CT-e, é necessário informar os novos Impostos de CBS/IBS", unitOfWork);

                cte.MensagemRetornoSefaz = "Para a emissão do CT-e, é necessário informar os novos Impostos de CBS/IBS";
                cte.MensagemStatus = null;
                cte.Status = "R";
                repositorioConhecimentoDeTransporteEletronico.Atualizar(cte);
                return false;
            }

            return true;
        }

        private void ObterIBSCBS(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteImp infImp)
        {
            if (infImp == null || infImp.IBSCBS == null)
                return;

            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            conhecimento.CSTIBSCBS = infImp.IBSCBS.CST;
            conhecimento.ClassificacaoTributariaIBSCBS = infImp.IBSCBS.cClassTrib;

            if (infImp.IBSCBS.gIBSCBS == null)
                return;

            conhecimento.BaseCalculoIBSCBS = decimal.Parse(infImp.IBSCBS.gIBSCBS.vBC, cultura);
            conhecimento.AliquotaIBSEstadual = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSUF.pIBSUF, cultura);
            conhecimento.ValorIBSEstadual = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSUF.vIBSUF, cultura);
            conhecimento.AliquotaIBSMunicipal = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSMun.pIBSMun, cultura);
            conhecimento.ValorIBSMunicipal = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSMun.vIBSMun, cultura);
            conhecimento.AliquotaCBS = decimal.Parse(infImp.IBSCBS.gIBSCBS.gCBS.pCBS, cultura);
            conhecimento.ValorCBS = decimal.Parse(infImp.IBSCBS.gIBSCBS.gCBS.vCBS, cultura);

            conhecimento.PercentualReducaoIBSEstadual = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSUF.gRed?.pRedAliq ?? "0", cultura);
            conhecimento.PercentualReducaoIBSMunicipal = decimal.Parse(infImp.IBSCBS.gIBSCBS.gIBSMun.gRed?.pRedAliq ?? "0", cultura);
            conhecimento.PercentualReducaoCBS = decimal.Parse(infImp.IBSCBS.gIBSCBS.gCBS.gRed?.pRedAliq ?? "0", cultura);
        }

        private void SalvarInformacoesComponentesDaPrestacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.Envio.TCTeInfCteVPrestComp[] infCTeComp, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ComponentePrestacaoCTE repCompPrestCTe = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            bool adicionadoComponenteValorFrete = false;
            bool adicionadoComponenteImpostos = false;

            if (infCTeComp != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                foreach (MultiSoftware.CTe.v200.Envio.TCTeInfCteVPrestComp comp in infCTeComp)
                {
                    Dominio.Entidades.ComponentePrestacaoCTE componenteDaPrestacao = new Dominio.Entidades.ComponentePrestacaoCTE();

                    componenteDaPrestacao.CTE = conhecimento;
                    componenteDaPrestacao.Nome = comp.xNome;
                    componenteDaPrestacao.Valor = Math.Round(decimal.Parse(comp.vComp, cultura), 2, MidpointRounding.ToEven);
                    componenteDaPrestacao.IncluiNaBaseDeCalculoDoICMS = false;


                    if (comp.xNome.ToUpper().Contains("VALOR FRETE") || comp.xNome.ToUpper().Contains("FRETE VALOR"))
                        componenteDaPrestacao.IncluiNoTotalAReceber = true;
                    else
                        componenteDaPrestacao.IncluiNoTotalAReceber = false;

                    repCompPrestCTe.Inserir(componenteDaPrestacao);
                    if (comp.xNome.ToUpper().Contains("VALOR FRETE") || comp.xNome.ToUpper().Contains("FRETE VALOR"))
                        adicionadoComponenteValorFrete = true;
                    if (comp.xNome.ToUpper().Contains("IMPOSTOS"))
                        adicionadoComponenteImpostos = true;
                }
            }

            if (!adicionadoComponenteImpostos)
            {
                if ((conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && conhecimento.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim) || (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0))
                {
                    Dominio.Entidades.ComponentePrestacaoCTE componenteImpostos = new Dominio.Entidades.ComponentePrestacaoCTE();
                    componenteImpostos.CTE = conhecimento;
                    componenteImpostos.Nome = "IMPOSTOS";
                    componenteImpostos.Valor = Math.Round(conhecimento.ValorICMS, 2, MidpointRounding.ToEven);
                    componenteImpostos.IncluiNaBaseDeCalculoDoICMS = false;

                    if (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0)
                        componenteImpostos.IncluiNoTotalAReceber = true;
                    else
                        componenteImpostos.IncluiNoTotalAReceber = false;

                    repCompPrestCTe.Inserir(componenteImpostos);
                }
            }

            if (!adicionadoComponenteValorFrete)
            {
                Dominio.Entidades.ComponentePrestacaoCTE componentePadrao = new Dominio.Entidades.ComponentePrestacaoCTE();

                componentePadrao.CTE = conhecimento;
                componentePadrao.Nome = "FRETE VALOR";
                componentePadrao.Valor = Math.Round(conhecimento.ValorFrete, 2, MidpointRounding.ToEven);
                componentePadrao.IncluiNaBaseDeCalculoDoICMS = false;
                componentePadrao.IncluiNoTotalAReceber = true;

                repCompPrestCTe.Inserir(componentePadrao);
            }
        }

        private void SalvarInformacoesComponentesDaPrestacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.NDDigital.v104.Emissao.Registro13110> infCTeComp, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ComponentePrestacaoCTE repCompPrestCTe = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            if (infCTeComp != null)
            {
                foreach (Dominio.NDDigital.v104.Emissao.Registro13110 comp in infCTeComp)
                {
                    if (!comp.xNome.ToUpper().Contains("VALOR FRETE") && !comp.xNome.ToUpper().Contains("FRETE VALOR") && !comp.xNome.ToUpper().Contains("IMPOSTOS"))
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteDaPrestacao = new Dominio.Entidades.ComponentePrestacaoCTE();

                        componenteDaPrestacao.CTE = conhecimento;
                        componenteDaPrestacao.Nome = comp.xNome;
                        componenteDaPrestacao.Valor = Math.Round(comp.vComp, 2, MidpointRounding.ToEven);
                        componenteDaPrestacao.IncluiNaBaseDeCalculoDoICMS = false;
                        componenteDaPrestacao.IncluiNoTotalAReceber = false;

                        repCompPrestCTe.Inserir(componenteDaPrestacao);
                    }
                }
            }

            //Valor dos impostos já é adicionado na função calcular impostos
            //if ((conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Nao && conhecimento.IncluirICMSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim) || (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0))
            //{
            //    Dominio.Entidades.ComponentePrestacaoCTE componenteImpostos = new Dominio.Entidades.ComponentePrestacaoCTE();
            //    componenteImpostos.CTE = conhecimento;
            //    componenteImpostos.Nome = "IMPOSTOS";
            //    componenteImpostos.Valor = Math.Round(conhecimento.ValorICMS, 2, MidpointRounding.ToEven);
            //    componenteImpostos.IncluiNaBaseDeCalculoDoICMS = false;

            //    if (conhecimento.SimplesNacional == Dominio.Enumeradores.OpcaoSimNao.Sim && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.PercentualImpostoSimplesNacional > 0)
            //        componenteImpostos.IncluiNoTotalAReceber = true;
            //    else
            //        componenteImpostos.IncluiNoTotalAReceber = false;

            //    repCompPrestCTe.Inserir(componenteImpostos);
            //}

            Dominio.Entidades.ComponentePrestacaoCTE componentePadrao = new Dominio.Entidades.ComponentePrestacaoCTE();

            componentePadrao.CTE = conhecimento;
            componentePadrao.Nome = "FRETE VALOR";
            componentePadrao.Valor = Math.Round(conhecimento.ValorFrete, 2, MidpointRounding.ToEven);
            componentePadrao.IncluiNaBaseDeCalculoDoICMS = false;
            componentePadrao.IncluiNoTotalAReceber = true;

            repCompPrestCTe.Inserir(componentePadrao);
        }

        private void SalvarInformacoesComponentesDaPrestacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, Dominio.ObjetosDeValor.CTe.CTe cteIntegracao, Repositorio.UnitOfWork unidadeDeTrabalho, string descricaoComponentePadrao, string descricaoComponenteImposto)
        {
            if (string.IsNullOrWhiteSpace(descricaoComponentePadrao))
                descricaoComponentePadrao = "FRETE VALOR";
            else
                descricaoComponentePadrao = Utilidades.String.Left(descricaoComponentePadrao, 15);

            if (string.IsNullOrWhiteSpace(descricaoComponenteImposto))
                descricaoComponenteImposto = "IMPOSTOS";
            else
                descricaoComponenteImposto = Utilidades.String.Left(descricaoComponenteImposto, 15);

            Repositorio.Embarcador.Frete.ComponenteFrete repComponenteFrete = new Repositorio.Embarcador.Frete.ComponenteFrete(unidadeDeTrabalho);
            Repositorio.ComponentePrestacaoCTE repCompPrestCTe = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);

            decimal somaComponentes = 0;

            if (cteIntegracao.ComponentesDaPrestacao != null)
            {
                foreach (Dominio.ObjetosDeValor.CTe.ComponentePrestacao comp in cteIntegracao.ComponentesDaPrestacao)
                {
                    if (!comp.Descricao.ToUpper().Contains("VALOR FRETE") && !comp.Descricao.ToUpper().Contains(descricaoComponentePadrao) && !comp.Descricao.ToUpper().Contains(descricaoComponenteImposto))
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteDaPrestacao = new Dominio.Entidades.ComponentePrestacaoCTE
                        {
                            CTE = conhecimento,
                            Nome = Utilidades.String.Left(comp.Descricao, 15),
                            Valor = Math.Round(comp.Valor, 2, MidpointRounding.ToEven),
                            IncluiNaBaseDeCalculoDoICMS = comp.IncluiBaseCalculoICMS,
                            IncluiNoTotalAReceber = comp.IncluiValorAReceber
                        };

                        if (comp.CodigoComponenteFrete > 0)
                            componenteDaPrestacao.ComponenteFrete = repComponenteFrete.BuscarPorCodigo(comp.CodigoComponenteFrete);



                        repCompPrestCTe.Inserir(componenteDaPrestacao);

                        somaComponentes += componenteDaPrestacao.Valor;
                    }
                }
            }
            if (conhecimento.ModeloDocumentoFiscal.Numero == "57" || somaComponentes != conhecimento.ValorFrete)
            {
                List<Dominio.Entidades.ComponentePrestacaoCTE> componentes = repCompPrestCTe.BuscarPorCTeDescricao(conhecimento.Codigo, descricaoComponentePadrao);

                if (componentes.Count == 0)
                {
                    Dominio.Entidades.ComponentePrestacaoCTE componentePadrao = new Dominio.Entidades.ComponentePrestacaoCTE
                    {
                        CTE = conhecimento,
                        Nome = Utilidades.String.Left(descricaoComponentePadrao, 15),
                        Valor = Math.Round(conhecimento.ValorFrete, 2, MidpointRounding.ToEven),
                        IncluiNaBaseDeCalculoDoICMS = false,
                        IncluiNoTotalAReceber = true
                    };

                    repCompPrestCTe.Inserir(componentePadrao);
                }
            }
        }

        private void SalvarInformacoesComponentesDaPrestacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.Embarcador.Frete.ComponenteAdicional> componentes, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ComponentePrestacaoCTE repCompPrestCTe = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);
            decimal somaComponentes = 0;

            if (componentes != null && componentes.Count > 0)
            {
                foreach (Dominio.ObjetosDeValor.Embarcador.Frete.ComponenteAdicional comp in componentes)
                {
                    if (!comp.Componente.Descricao.ToUpper().Contains("VALOR FRETE") && !comp.Componente.Descricao.ToUpper().Contains("FRETE VALOR") && !comp.Componente.Descricao.ToUpper().Contains("IMPOSTOS"))
                    {
                        Dominio.Entidades.ComponentePrestacaoCTE componenteDaPrestacao = new Dominio.Entidades.ComponentePrestacaoCTE();
                        componenteDaPrestacao.CTE = conhecimento;
                        componenteDaPrestacao.Nome = comp.Componente.Descricao;
                        componenteDaPrestacao.Valor = comp.ValorComponente;
                        componenteDaPrestacao.IncluiNaBaseDeCalculoDoICMS = comp.IncluirBaseCalculoICMS;
                        componenteDaPrestacao.IncluiNoTotalAReceber = comp.IncluirTotalReceber;
                        somaComponentes += componenteDaPrestacao.Valor;
                        repCompPrestCTe.Inserir(componenteDaPrestacao);
                    }
                }
            }
            if (conhecimento.ModeloDocumentoFiscal.Numero == "57" || somaComponentes != conhecimento.ValorFrete)
            {
                List<Dominio.Entidades.ComponentePrestacaoCTE> componentesCTe = repCompPrestCTe.BuscarPorCTeDescricao(conhecimento.Codigo, "FRETE VALOR");

                if (componentesCTe.Count == 0)
                {
                    Dominio.Entidades.ComponentePrestacaoCTE componentePadrao = new Dominio.Entidades.ComponentePrestacaoCTE();
                    componentePadrao.CTE = conhecimento;
                    componentePadrao.Nome = "FRETE VALOR";
                    componentePadrao.Valor = conhecimento.ValorFrete;
                    componentePadrao.IncluiNaBaseDeCalculoDoICMS = false;
                    componentePadrao.IncluiNoTotalAReceber = true;
                    repCompPrestCTe.Inserir(componentePadrao);
                }
            }
        }

        private void SalvarInformacoesComponentesDaPrestacao(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, string descricao, decimal valor, bool incluiICMS, bool incluiTotal, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.ComponentePrestacaoCTE repComponentePrestacao = new Repositorio.ComponentePrestacaoCTE(unidadeDeTrabalho);
            Dominio.Entidades.ComponentePrestacaoCTE componente = repComponentePrestacao.BuscarPorCTe(conhecimento.Empresa.Codigo, conhecimento.Codigo).Where(o => o.Nome == descricao).FirstOrDefault();

            if (componente != null)
            {
                componente.Valor = Math.Round(valor, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Atualizar(componente);
            }
            else
            {
                componente = new Dominio.Entidades.ComponentePrestacaoCTE();

                componente.CTE = conhecimento;
                componente.IncluiNaBaseDeCalculoDoICMS = incluiICMS;
                componente.IncluiNoTotalAReceber = incluiTotal;
                componente.Nome = descricao;
                componente.Valor = Math.Round(valor, 2, MidpointRounding.ToEven);

                repComponentePrestacao.Inserir(componente);
            }
        }

        private void SalvarInformacoesModalRodoviario(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfModal infModal, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infModal != null)
            {
                System.Xml.Serialization.XmlSerializer serializer = new System.Xml.Serialization.XmlSerializer(typeof(MultiSoftware.CTe.v104.ModalRodoviario.rodo));
                byte[] data = Encoding.Default.GetBytes(infModal.Any.OuterXml);
                System.IO.MemoryStream memStream = new System.IO.MemoryStream(data, 0, data.Length);
                MultiSoftware.CTe.v104.ModalRodoviario.rodo modalRodoviario = (MultiSoftware.CTe.v104.ModalRodoviario.rodo)serializer.Deserialize(memStream);
                conhecimento.CIOT = modalRodoviario.CIOT;
                DateTime dataPrevista = new DateTime();
                DateTime.TryParseExact(modalRodoviario.dPrev, "yyyy-MM-dd", null, System.Globalization.DateTimeStyles.None, out dataPrevista);
                conhecimento.DataPrevistaEntrega = dataPrevista;
                conhecimento.Lotacao = (Dominio.Enumeradores.OpcaoSimNao)modalRodoviario.lota;
                conhecimento.RNTRC = modalRodoviario.RNTRC;
                this.SalvarInformacoesVeiculos(conhecimento, modalRodoviario.veic, unidadeTrabalho);
                this.SalvarInformacoesMotoristas(conhecimento, modalRodoviario.moto, unidadeTrabalho);
            }
        }

        private void SalvarInformacoesModalRodoviario(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfModal infModal, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infModal != null)
            {
                System.Xml.Serialization.XmlSerializer serializer = new System.Xml.Serialization.XmlSerializer(typeof(MultiSoftware.CTe.v200.ModalRodoviario.rodo));
                byte[] data = Encoding.UTF8.GetBytes(infModal.Any.OuterXml);
                System.IO.MemoryStream memStream = new System.IO.MemoryStream(data, 0, data.Length);
                MultiSoftware.CTe.v200.ModalRodoviario.rodo modalRodoviario = (MultiSoftware.CTe.v200.ModalRodoviario.rodo)serializer.Deserialize(memStream);
                conhecimento.CIOT = modalRodoviario.CIOT;
                DateTime dataPrevista = new DateTime();
                DateTime.TryParseExact(modalRodoviario.dPrev, "yyyy-MM-dd", null, System.Globalization.DateTimeStyles.None, out dataPrevista);
                conhecimento.DataPrevistaEntrega = dataPrevista;
                conhecimento.Lotacao = (Dominio.Enumeradores.OpcaoSimNao)modalRodoviario.lota;
                conhecimento.RNTRC = modalRodoviario.RNTRC;
                this.SalvarInformacoesVeiculos(conhecimento, modalRodoviario.veic, unidadeTrabalho);
                this.SalvarInformacoesMotoristas(conhecimento, modalRodoviario.moto, unidadeTrabalho);
            }
        }

        private void SalvarInformacoesModalRodoviario(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfModal infModal, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infModal != null)
            {
                try
                {
                    System.Xml.Serialization.XmlSerializer serializer = new System.Xml.Serialization.XmlSerializer(typeof(MultiSoftware.CTe.v300.ModalRodoviario.rodo));
                    byte[] data = Encoding.UTF8.GetBytes(infModal.Any.OuterXml);
                    System.IO.MemoryStream memStream = new System.IO.MemoryStream(data, 0, data.Length);
                    MultiSoftware.CTe.v300.ModalRodoviario.rodo modalRodoviario = (MultiSoftware.CTe.v300.ModalRodoviario.rodo)serializer.Deserialize(memStream);
                    conhecimento.RNTRC = conhecimento.TipoServico == Dominio.Enumeradores.TipoServico.SubContratacao ? conhecimento.Empresa.RegistroANTT : modalRodoviario.RNTRC;
                }
                catch (Exception ex)
                {
                    Servicos.Log.TratarErro("SalvarInformacoesModalRodoviario: " + ex);
                    return;
                }
            }
        }

        private void SalvarInformacoesModalRodoviario(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfModal infModal, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infModal != null)
            {
                try
                {
                    System.Xml.Serialization.XmlSerializer serializer = new System.Xml.Serialization.XmlSerializer(typeof(MultiSoftware.CTe.v400.ModalRodoviario.rodo));
                    byte[] data = Encoding.UTF8.GetBytes(infModal.Any.OuterXml);
                    System.IO.MemoryStream memStream = new System.IO.MemoryStream(data, 0, data.Length);
                    MultiSoftware.CTe.v400.ModalRodoviario.rodo modalRodoviario = (MultiSoftware.CTe.v400.ModalRodoviario.rodo)serializer.Deserialize(memStream);
                    conhecimento.RNTRC = conhecimento.TipoServico == Dominio.Enumeradores.TipoServico.SubContratacao ? conhecimento.Empresa.RegistroANTT : modalRodoviario.RNTRC;
                }
                catch (Exception ex)
                {
                    Servicos.Log.TratarErro("SalvarInformacoesModalRodoviario: " + ex);
                    return;
                }
            }
        }

        private void SalvarInformacoesModalRodoviario(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteInfModal infModal, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infModal != null)
            {
                try
                {
                    System.Xml.Serialization.XmlSerializer serializer = new System.Xml.Serialization.XmlSerializer(typeof(MultiSoftware.CTe.v400.ModalRodoviario.rodo));
                    byte[] data = Encoding.UTF8.GetBytes(infModal.Any.OuterXml);
                    System.IO.MemoryStream memStream = new System.IO.MemoryStream(data, 0, data.Length);
                    MultiSoftware.CTe.v400.ModalRodoviario.rodo modalRodoviario = (MultiSoftware.CTe.v400.ModalRodoviario.rodo)serializer.Deserialize(memStream);
                    conhecimento.RNTRC = conhecimento.TipoServico == Dominio.Enumeradores.TipoServico.SubContratacao ? conhecimento.Empresa.RegistroANTT : modalRodoviario.RNTRC;
                }
                catch (Exception ex)
                {
                    Servicos.Log.TratarErro("SalvarInformacoesModalRodoviario: " + ex);
                    return;
                }
            }
        }

        private void SalvarInformacoesModalRodoviario(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCteInfCTeNormInfModal infModal, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infModal != null)
            {
                System.Xml.Serialization.XmlSerializer serializer = new System.Xml.Serialization.XmlSerializer(typeof(MultiSoftware.CTe.v300.ModalRodoviario.rodoOS));
                byte[] data = Encoding.UTF8.GetBytes(infModal.Any.OuterXml);
                System.IO.MemoryStream memStream = new System.IO.MemoryStream(data, 0, data.Length);
                MultiSoftware.CTe.v300.ModalRodoviario.rodoOS modalRodoviario = (MultiSoftware.CTe.v300.ModalRodoviario.rodoOS)serializer.Deserialize(memStream);
                conhecimento.DataPrevistaEntrega = DateTime.Now;
                conhecimento.Lotacao = Dominio.Enumeradores.OpcaoSimNao.Nao;
                conhecimento.RNTRC = conhecimento.Empresa.RegistroANTT;
                this.SalvarInformacoesVeiculos(conhecimento, modalRodoviario.veic, unidadeTrabalho);
            }
        }

        private void SalvarInformacoesModalRodoviario(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCteInfCTeNormInfModal infModal, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infModal != null)
            {
                System.Xml.Serialization.XmlSerializer serializer = new System.Xml.Serialization.XmlSerializer(typeof(MultiSoftware.CTe.v400.ModalRodoviario.rodoOS));
                byte[] data = Encoding.UTF8.GetBytes(infModal.Any.OuterXml);
                System.IO.MemoryStream memStream = new System.IO.MemoryStream(data, 0, data.Length);
                MultiSoftware.CTe.v400.ModalRodoviario.rodoOS modalRodoviario = (MultiSoftware.CTe.v400.ModalRodoviario.rodoOS)serializer.Deserialize(memStream);
                conhecimento.DataPrevistaEntrega = DateTime.Now;
                conhecimento.Lotacao = Dominio.Enumeradores.OpcaoSimNao.Nao;
                conhecimento.RNTRC = conhecimento.Empresa.RegistroANTT;
                this.SalvarInformacoesVeiculos(conhecimento, modalRodoviario.veic, unidadeTrabalho);
            }
        }

        private void SalvarInformacoesModalRodoviario(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNormInfModal infModal, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infModal != null)
            {
                System.Xml.Serialization.XmlSerializer serializer = new System.Xml.Serialization.XmlSerializer(typeof(MultiSoftware.CTe.v200.ModalRodoviario.rodo));
                byte[] data = Encoding.UTF8.GetBytes(infModal.Any.OuterXml);
                System.IO.MemoryStream memStream = new System.IO.MemoryStream(data, 0, data.Length);
                MultiSoftware.CTe.v200.ModalRodoviario.rodo modalRodoviario = (MultiSoftware.CTe.v200.ModalRodoviario.rodo)serializer.Deserialize(memStream);
                conhecimento.CIOT = modalRodoviario.CIOT;
                DateTime dataPrevista = new DateTime();
                DateTime.TryParseExact(modalRodoviario.dPrev, "yyyy-MM-dd", null, System.Globalization.DateTimeStyles.None, out dataPrevista);
                conhecimento.DataPrevistaEntrega = dataPrevista;
                conhecimento.Lotacao = (Dominio.Enumeradores.OpcaoSimNao)modalRodoviario.lota;
                conhecimento.RNTRC = modalRodoviario.RNTRC;
                this.SalvarInformacoesVeiculos(conhecimento, modalRodoviario.veic, unidadeTrabalho);
                this.SalvarInformacoesMotoristas(conhecimento, modalRodoviario.moto, unidadeTrabalho);
            }
        }

        private void SalvarInformacoesMotoristas(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v104.ModalRodoviario.rodoMoto[] infMoto, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infMoto != null)
            {
                Repositorio.MotoristaCTE repMotoristaCTe = new Repositorio.MotoristaCTE(unidadeDeTrabalho);
                foreach (MultiSoftware.CTe.v104.ModalRodoviario.rodoMoto moto in infMoto)
                {
                    Dominio.Entidades.MotoristaCTE motorista = new Dominio.Entidades.MotoristaCTE();
                    motorista.CPFMotorista = moto.CPF;
                    motorista.CTE = conhecimento;
                    motorista.NomeMotorista = moto.xNome;
                    repMotoristaCTe.Inserir(motorista);
                }
            }
        }

        private void SalvarInformacoesMotoristas(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ModalRodoviario.rodoMoto[] infMoto, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infMoto != null)
            {
                Repositorio.MotoristaCTE repMotoristaCTe = new Repositorio.MotoristaCTE(unidadeDeTrabalho);
                foreach (MultiSoftware.CTe.v200.ModalRodoviario.rodoMoto moto in infMoto)
                {
                    Dominio.Entidades.MotoristaCTE motorista = new Dominio.Entidades.MotoristaCTE();
                    motorista.CPFMotorista = moto.CPF;
                    motorista.CTE = conhecimento;
                    motorista.NomeMotorista = moto.xNome;
                    repMotoristaCTe.Inserir(motorista);
                }
            }
        }

        private void SalvarInformacoesMotoristas(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.CTe.Motorista> motoristas, Repositorio.UnitOfWork unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            if (motoristas != null && motoristas.Count() > 0)
            {
                Repositorio.MotoristaCTE repMotoristaCTe = new Repositorio.MotoristaCTE(unidadeDeTrabalho);
                Repositorio.Usuario repMotorista = new Repositorio.Usuario(unidadeDeTrabalho);

                foreach (Dominio.ObjetosDeValor.CTe.Motorista moto in motoristas)
                {
                    Dominio.Entidades.MotoristaCTE motorista = new Dominio.Entidades.MotoristaCTE();

                    motorista.CPFMotorista = moto.CPF;
                    motorista.CTE = conhecimento;
                    if (!string.IsNullOrWhiteSpace(moto.Nome))
                        motorista.NomeMotorista = moto.Nome.Length > 80 ? moto.Nome.Substring(0, 80) : moto.Nome;
                    else
                    {
                        Dominio.Entidades.Usuario motoristaCadastro = repMotorista.BuscarMotoristaPorCPF(conhecimento.Empresa.Codigo, moto.CPF);
                        motorista.NomeMotorista = motoristaCadastro != null ? motoristaCadastro.Nome : "Sem nome informado";
                    }

                    repMotoristaCTe.Inserir(motorista);

                    if (Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().CadastrarMotoristaIntegracaoCTe.HasValue && Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().CadastrarMotoristaIntegracaoCTe.Value)
                    {
                        Repositorio.Setor repSetor = new Repositorio.Setor(unidadeDeTrabalho);
                        Dominio.Entidades.Usuario cadastrarMotorista = repMotorista.BuscarMotoristaPorCPF(conhecimento.Empresa.Codigo, motorista.CPFMotorista);
                        if (tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                            cadastrarMotorista = repMotorista.BuscarPorCPF(motorista.CPFMotorista);

                        if (cadastrarMotorista == null)
                        {
                            cadastrarMotorista = new Dominio.Entidades.Usuario();
                            cadastrarMotorista.CPF = Utilidades.String.OnlyNumbers(motorista.CPFMotorista);
                            cadastrarMotorista.Nome = Utilidades.String.Left(motorista.NomeMotorista, 80);
                            cadastrarMotorista.Empresa = conhecimento.Empresa;
                            cadastrarMotorista.Localidade = conhecimento.Empresa.Localidade;
                            cadastrarMotorista.Setor = repSetor.BuscarPorCodigo(1);
                            cadastrarMotorista.Status = "A";
                            cadastrarMotorista.Tipo = "M";

                            repMotorista.Inserir(cadastrarMotorista);
                        }
                    }
                }

            }
        }

        private void SalvarInformacoesModais(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, Dominio.ObjetosDeValor.CTe.CTe cte, Repositorio.UnitOfWork unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            Servicos.CTe servicoCte = new Servicos.CTe(unidadeDeTrabalho);

            Repositorio.Embarcador.Pedidos.TipoTerminalImportacao repTipoTerminalImportacao = new Repositorio.Embarcador.Pedidos.TipoTerminalImportacao(unidadeDeTrabalho);
            Repositorio.Embarcador.Pedidos.PedidoViagemNavio repPedidoViagemNavio = new Repositorio.Embarcador.Pedidos.PedidoViagemNavio(unidadeDeTrabalho);
            Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);
            Repositorio.Embarcador.Pedidos.Navio repNavio = new Repositorio.Embarcador.Pedidos.Navio(unidadeDeTrabalho);
            Repositorio.Embarcador.Pedidos.Porto repPorto = new Repositorio.Embarcador.Pedidos.Porto(unidadeDeTrabalho);
            Repositorio.Embarcador.CTe.CTeBalsa repCTeBalsa = new Repositorio.Embarcador.CTe.CTeBalsa(unidadeDeTrabalho);
            Repositorio.ContainerCTE repContainerCTE = new Repositorio.ContainerCTE(unidadeDeTrabalho);
            Repositorio.Embarcador.Pedidos.Container repContainer = new Repositorio.Embarcador.Pedidos.Container(unidadeDeTrabalho);
            Repositorio.Embarcador.CTe.CTeContainerDocumento repCTeContainerDocumento = new Repositorio.Embarcador.CTe.CTeContainerDocumento(unidadeDeTrabalho);
            Repositorio.ModalTransporte repModalTransporte = new Repositorio.ModalTransporte(unidadeDeTrabalho);
            Repositorio.ConhecimentoDeTransporteEletronico repCTe = new Repositorio.ConhecimentoDeTransporteEletronico(unidadeDeTrabalho);
            Repositorio.DocumentosCTE repDocumentosCTE = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
            Repositorio.Embarcador.Logistica.CentroCustoViagem repCentroCustoViagem = new Repositorio.Embarcador.Logistica.CentroCustoViagem(unidadeDeTrabalho);
            Repositorio.Embarcador.Pedidos.PedidoViagemNavioSchedule repPedidoNavioSchedule = new Repositorio.Embarcador.Pedidos.PedidoViagemNavioSchedule(unidadeDeTrabalho);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);

            if (cte.PortoDestino?.Codigo > 0)
                conhecimento.PortoDestino = repPorto.BuscarPorCodigo(cte.PortoDestino.Codigo);
            if (cte.PortoOrigem?.Codigo > 0)
                conhecimento.PortoOrigem = repPorto.BuscarPorCodigo(cte.PortoOrigem.Codigo);

            if (cte.PortoPassagemUm?.Codigo > 0)
                conhecimento.PortoPassagemUm = repPorto.BuscarPorCodigo(cte.PortoPassagemUm.Codigo);
            if (cte.PortoPassagemDois?.Codigo > 0)
                conhecimento.PortoPassagemDois = repPorto.BuscarPorCodigo(cte.PortoPassagemDois.Codigo);
            if (cte.PortoPassagemTres?.Codigo > 0)
                conhecimento.PortoPassagemTres = repPorto.BuscarPorCodigo(cte.PortoPassagemTres.Codigo);
            if (cte.PortoPassagemQuatro?.Codigo > 0)
                conhecimento.PortoPassagemQuatro = repPorto.BuscarPorCodigo(cte.PortoPassagemQuatro.Codigo);
            if (cte.PortoPassagemCinco?.Codigo > 0)
                conhecimento.PortoPassagemCinco = repPorto.BuscarPorCodigo(cte.PortoPassagemCinco.Codigo);

            if (cte.TerminalOrigem?.CodigoTerminal > 0)
                conhecimento.TerminalOrigem = repTipoTerminalImportacao.BuscarPorCodigo(cte.TerminalOrigem.CodigoTerminal);
            if (cte.TerminalDestino?.CodigoTerminal > 0)
                conhecimento.TerminalDestino = repTipoTerminalImportacao.BuscarPorCodigo(cte.TerminalDestino.CodigoTerminal);
            if (cte.Viagem?.CodigoViagem > 0)
                conhecimento.Viagem = repPedidoViagemNavio.BuscarPorCodigo(cte.Viagem.CodigoViagem);
            if (cte.ViagemPassagemUm?.CodigoViagem > 0)
                conhecimento.ViagemPassagemUm = repPedidoViagemNavio.BuscarPorCodigo(cte.ViagemPassagemUm.CodigoViagem);
            if (cte.ViagemPassagemDois?.CodigoViagem > 0)
                conhecimento.ViagemPassagemDois = repPedidoViagemNavio.BuscarPorCodigo(cte.ViagemPassagemDois.CodigoViagem);
            if (cte.ViagemPassagemTres?.CodigoViagem > 0)
                conhecimento.ViagemPassagemTres = repPedidoViagemNavio.BuscarPorCodigo(cte.ViagemPassagemTres.CodigoViagem);
            if (cte.ViagemPassagemQuatro?.CodigoViagem > 0)
                conhecimento.ViagemPassagemQuatro = repPedidoViagemNavio.BuscarPorCodigo(cte.ViagemPassagemQuatro.CodigoViagem);
            if (cte.ViagemPassagemCinco?.CodigoViagem > 0)
                conhecimento.ViagemPassagemCinco = repPedidoViagemNavio.BuscarPorCodigo(cte.ViagemPassagemCinco.CodigoViagem);

            conhecimento.NumeroOS = cte.NumeroOS;
            conhecimento.Embarque = cte.Embarque;
            conhecimento.MasterBL = cte.MasterBL;
            conhecimento.NumeroDI = cte.NumeroDI;
            conhecimento.BookingReference = cte.BookingReference;
            conhecimento.TipoOSConvertido = cte.TipoOSConvertido;
            conhecimento.TipoOS = cte.TipoOS;

            if (cte.CentroDeCustoViagem != null && cte.CentroDeCustoViagem.Codigo > 0)
                conhecimento.CentroDeCustoViagem = repCentroCustoViagem.BuscarPorCodigo(cte.CentroDeCustoViagem.Codigo);

            if (cte.ClienteProvedorOS != null && !string.IsNullOrWhiteSpace(cte.ClienteProvedorOS.CPFCNPJ))
            {
                double.TryParse(cte.ClienteProvedorOS.CPFCNPJ, out double cnpj);
                if (cnpj > 0)
                    conhecimento.ClienteProvedorOS = repCliente.BuscarPorCPFCNPJ(cnpj);
            }
            conhecimento.NumeroBooking = cte.NumeroBooking;
            conhecimento.DescricaoCarrier = cte.DescricaoCarrier;
            conhecimento.TipoPropostaFeeder = cte.TipoPropostaFeeder;
            conhecimento.SVMTerceiro = cte.SVMTerceiro;
            conhecimento.SVMProprio = cte.SVMProprio;
            conhecimento.NumeroControle = servicoCte.RetornarNumeroControleCTe(out int numeroSequencia, cte.NumeroBooking, cte.DescricaoCarrier, cte.TipoPropostaFeeder, cte.TipoModal, cte.TipoServico, conhecimento.Codigo, cte.SVMTerceiro, unidadeDeTrabalho);
            conhecimento.SequenciaBooking = numeroSequencia;

            if ((cte.ViagemPassagemCinco?.Codigo ?? cte.ViagemPassagemQuatro?.Codigo ?? cte.ViagemPassagemTres?.Codigo ?? cte.ViagemPassagemDois?.Codigo ?? cte.ViagemPassagemUm?.Codigo ?? cte.Viagem?.Codigo ?? cte.PortoDestino?.Codigo ?? cte.TerminalDestino?.Codigo ?? 0) > 0)
                conhecimento.PedidoViagemNavioSchedule = repPedidoNavioSchedule.BuscarPorCodigo(repCTe.BuscarCodigoSchedule(cte.ViagemPassagemCinco?.Codigo ?? 0, cte.ViagemPassagemQuatro?.Codigo ?? 0, cte.ViagemPassagemTres?.Codigo ?? 0, cte.ViagemPassagemDois?.Codigo ?? 0, cte.ViagemPassagemUm?.Codigo ?? 0, cte.Viagem?.Codigo ?? 0, cte.PortoDestino?.Codigo ?? 0, cte.TerminalDestino?.Codigo ?? 0));

            if ((!string.IsNullOrWhiteSpace(cte.NumeroBooking) || !string.IsNullOrWhiteSpace(cte.NumeroOS)) && repCTe.ContemNumeroControleDuplicado(conhecimento.NumeroControle, conhecimento.Empresa?.Codigo ?? 0, conhecimento.Codigo))
            {
                conhecimento.NumeroControle = servicoCte.RetornarNumeroControleCTe(out numeroSequencia, cte.NumeroBooking, cte.DescricaoCarrier, cte.TipoPropostaFeeder, cte.TipoModal, cte.TipoServico, conhecimento.Codigo, cte.SVMTerceiro, unidadeDeTrabalho, true, conhecimento.SequenciaBooking);
                conhecimento.SequenciaBooking = numeroSequencia;

                if (repCTe.ContemNumeroControleDuplicado(conhecimento.NumeroControle, conhecimento.Empresa?.Codigo ?? 0, conhecimento.Codigo))
                {
                    bool contemNumeroDuplicado = true;
                    int count = 0;
                    while (contemNumeroDuplicado)
                    {
                        conhecimento.NumeroControle = servicoCte.RetornarNumeroControleCTe(out numeroSequencia, cte.NumeroBooking, cte.DescricaoCarrier, cte.TipoPropostaFeeder, cte.TipoModal, cte.TipoServico, conhecimento.Codigo, cte.SVMTerceiro, unidadeDeTrabalho, true, conhecimento.SequenciaBooking);
                        conhecimento.SequenciaBooking = numeroSequencia;
                        contemNumeroDuplicado = repCTe.ContemNumeroControleDuplicado(conhecimento.NumeroControle, conhecimento.Empresa?.Codigo ?? 0, conhecimento.Codigo);
                        count++;
                        if (count > 100)
                            break;
                    }
                }
            }

            if (cte.TipoModal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Rodoviario)
            {
                conhecimento.TipoModal = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Rodoviario;
                conhecimento.ModalTransporte = repModalTransporte.BuscarPorNumero((int)conhecimento.TipoModal > 0 ? conhecimento.TipoModal.ToString("D") : "1");
            }
            else if (cte.TipoModal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Aquaviario)
            {
                conhecimento.TipoModal = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Aquaviario;
                conhecimento.ModalTransporte = repModalTransporte.BuscarPorNumero((int)conhecimento.TipoModal > 0 ? conhecimento.TipoModal.ToString("D") : "1");
                conhecimento.ValorPrestacaoAFRMM = cte.ValorPrestacaoAFRMM;
                conhecimento.ValorAdicionalAFRMM = cte.ValorAdicionalAFRMM;
                if (cte.Navio?.CodigoNavio > 0)
                    conhecimento.Navio = repNavio.BuscarPorCodigo(cte.Navio.CodigoNavio);
                conhecimento.NumeroViagem = cte.NumeroViagem;
                conhecimento.Direcao = cte.Direcao;

                if (cte.Balsas != null && cte.Balsas.Count > 0)
                {
                    foreach (Dominio.ObjetosDeValor.CTe.Balsa balsa in cte.Balsas)
                    {
                        if (balsa.Codigo == 0)
                        {
                            Dominio.Entidades.Embarcador.CTe.CTeBalsa cteBalsa = new Dominio.Entidades.Embarcador.CTe.CTeBalsa();
                            cteBalsa.ConhecimentoDeTransporteEletronico = conhecimento;
                            cteBalsa.Descricao = balsa.Descricao;

                            repCTeBalsa.Inserir(cteBalsa);
                        }
                    }
                }
            }
            else if (cte.TipoModal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Multimodal)
            {
                conhecimento.TipoModal = Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Multimodal;
                conhecimento.ModalTransporte = repModalTransporte.BuscarPorNumero((int)conhecimento.TipoModal > 0 ? conhecimento.TipoModal.ToString("D") : "1");
                conhecimento.NumeroCOTM = cte.NumeroCOTM;
                if (cte.Navio?.CodigoNavio > 0)
                    conhecimento.Navio = repNavio.BuscarPorCodigo(cte.Navio.CodigoNavio);
            }

            if (cte.Containeres != null && cte.Containeres.Count > 0)
            {
                bool contemNFe = cte.Containeres.Any(c => c.Documentos.Any(d => d.Tipo == Dominio.Enumeradores.TipoDocumentoCTe.NFe));
                bool contemNF = cte.Containeres.Any(c => c.Documentos.Any(d => d.Tipo == Dominio.Enumeradores.TipoDocumentoCTe.NF));
                bool contemOutros = cte.Containeres.Any(c => c.Documentos.Any(d => d.Tipo == Dominio.Enumeradores.TipoDocumentoCTe.Outros));

                foreach (Dominio.ObjetosDeValor.CTe.Container container in cte.Containeres)
                {
                    if (container.Codigo == 0)
                    {
                        Dominio.Entidades.ContainerCTE containerCTE = new Dominio.Entidades.ContainerCTE();
                        containerCTE.Container = repContainer.BuscarPorCodigo(container.CodigoContainer);
                        containerCTE.Numero = Utilidades.String.SanitizeString(!string.IsNullOrWhiteSpace(container.Numero) && container.Numero.Length > 20 ? container.Numero.Substring(0, 19) : container.Numero);
                        containerCTE.CTE = conhecimento;
                        containerCTE.DataPrevista = container.DataPrevista;
                        containerCTE.Lacre1 = !string.IsNullOrWhiteSpace(container.Lacre1) && container.Lacre1.Length > 20 ? container.Lacre1.Substring(0, 19) : container.Lacre1;
                        containerCTE.Lacre2 = !string.IsNullOrWhiteSpace(container.Lacre2) && container.Lacre2.Length > 20 ? container.Lacre2.Substring(0, 19) : container.Lacre2;
                        containerCTE.Lacre3 = !string.IsNullOrWhiteSpace(container.Lacre3) && container.Lacre3.Length > 20 ? container.Lacre3.Substring(0, 19) : container.Lacre3;

                        if (!string.IsNullOrWhiteSpace(containerCTE.Lacre1))
                            containerCTE.Lacre1 = Utilidades.String.SanitizeString(containerCTE.Lacre1.Replace(";", "").Replace("-", "").Replace(" ", ""));
                        if (!string.IsNullOrWhiteSpace(containerCTE.Lacre2))
                            containerCTE.Lacre2 = Utilidades.String.SanitizeString(containerCTE.Lacre2.Replace(";", "").Replace("-", "").Replace(" ", ""));
                        if (!string.IsNullOrWhiteSpace(containerCTE.Lacre3))
                            containerCTE.Lacre3 = Utilidades.String.SanitizeString(containerCTE.Lacre3.Replace(";", "").Replace("-", "").Replace(" ", ""));

                        repContainerCTE.Inserir(containerCTE);

                        foreach (Dominio.ObjetosDeValor.CTe.Documento documento in container.Documentos)
                        {
                            if (contemNFe && (documento.Tipo == TipoDocumentoCTe.NF || documento.Tipo == TipoDocumentoCTe.Outros || string.IsNullOrWhiteSpace(documento.ChaveNFE)))
                                continue;

                            Dominio.Entidades.Embarcador.CTe.CTeContainerDocumento cteContainerDocumento = new Dominio.Entidades.Embarcador.CTe.CTeContainerDocumento();
                            if (!string.IsNullOrWhiteSpace(documento.ChaveNFE) && documento.ChaveNFE.Length > 44)
                                cteContainerDocumento.Chave = documento.ChaveNFE.Substring(0, 44);
                            else
                                cteContainerDocumento.Chave = documento.ChaveNFE;
                            cteContainerDocumento.ContainerCTE = containerCTE;
                            if (!string.IsNullOrWhiteSpace(documento.ChaveNFE) && !string.IsNullOrWhiteSpace(documento.Numero) && documento.Numero.Length > 20)
                                cteContainerDocumento.Numero = documento.Numero.Substring(0, 20);
                            else
                                cteContainerDocumento.Numero = documento.Numero;
                            if (!string.IsNullOrWhiteSpace(documento.ChaveNFE) && documento.Serie != null && documento.Serie.Length > 3)
                                cteContainerDocumento.Serie = documento.Serie.Substring(0, 3);
                            else
                                cteContainerDocumento.Serie = documento.Serie;
                            cteContainerDocumento.TipoDocumento = documento.Tipo;
                            cteContainerDocumento.UnidadeMedidaRateada = 0;

                            cteContainerDocumento.DocumentosCTE = repDocumentosCTE.BuscarPorCTeENFe(conhecimento.Codigo, cteContainerDocumento.Chave);
                            if (cteContainerDocumento.DocumentosCTE == null)
                                cteContainerDocumento.DocumentosCTE = repDocumentosCTE.BuscarPorCTeENumero(conhecimento.Codigo, cteContainerDocumento.Numero);

                            if (!string.IsNullOrWhiteSpace(cteContainerDocumento.Chave))
                                cteContainerDocumento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(cteContainerDocumento.Chave);

                            repCTeContainerDocumento.Inserir(cteContainerDocumento);

                        }

                    }
                }
            }

        }

        private void SalvarInformacoesMotoristas(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.Motorista> motoristas, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (motoristas != null && motoristas.Count() > 0)
            {
                Repositorio.MotoristaCTE repMotoristaCTe = new Repositorio.MotoristaCTE(unidadeDeTrabalho);

                foreach (Dominio.ObjetosDeValor.Motorista motora in motoristas)
                {
                    Dominio.Entidades.MotoristaCTE motorista = new Dominio.Entidades.MotoristaCTE();

                    motorista.CPFMotorista = motora.CPF;
                    motorista.CTE = conhecimento;
                    motorista.NomeMotorista = motora.Nome;

                    repMotoristaCTe.Inserir(motorista);
                }
            }
        }

        private void SalvarInformacoesMotoristas(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, Dominio.Entidades.Veiculo veiculo, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Dominio.Entidades.Usuario motoristaPrincipal = veiculo.Motoristas.Where(o => o.Principal).Select(o => o.Motorista).FirstOrDefault();

            if (motoristaPrincipal != null)
            {
                Repositorio.MotoristaCTE repMotorista = new Repositorio.MotoristaCTE(unidadeDeTrabalho);

                Dominio.Entidades.MotoristaCTE motorista = new Dominio.Entidades.MotoristaCTE();

                motorista.CTE = conhecimento;
                motorista.NomeMotorista = motoristaPrincipal.Nome;
                motorista.CPFMotorista = motoristaPrincipal.CPF;

                repMotorista.Inserir(motorista);
            }

            if (veiculo.VeiculoMotoristas != null && veiculo.VeiculoMotoristas.Count > 0)
            {
                Repositorio.MotoristaCTE repMotorista = new Repositorio.MotoristaCTE(unidadeDeTrabalho);

                foreach (Dominio.Entidades.VeiculoMotoristas motoristaAdicional in veiculo.VeiculoMotoristas)
                {
                    Dominio.Entidades.MotoristaCTE motorista = new Dominio.Entidades.MotoristaCTE();

                    motorista.CTE = conhecimento;
                    motorista.NomeMotorista = motoristaAdicional.Motorista.Nome;
                    motorista.CPFMotorista = motoristaAdicional.Motorista.CPF;

                    repMotorista.Inserir(motorista);
                }
            }
        }

        private void SalvarInformacoesVeiculos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v104.ModalRodoviario.rodoVeic[] infVeic, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infVeic != null)
            {
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
                Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unidadeDeTrabalho);
                Repositorio.Estado repEstado = new Repositorio.Estado(unidadeDeTrabalho);
                foreach (MultiSoftware.CTe.v104.ModalRodoviario.rodoVeic veic in infVeic)
                {
                    Dominio.Entidades.Veiculo veiculo = repVeiculo.BuscarPorPlaca(conhecimento.Empresa.Codigo, veic.placa);

                    if (veiculo == null)
                    {
                        veiculo = new Dominio.Entidades.Veiculo();
                        veiculo.Empresa = conhecimento.Empresa;
                        veiculo.CapacidadeKG = int.Parse(veic.capKG);
                        veiculo.CapacidadeM3 = int.Parse(veic.capM3);
                        veiculo.Placa = veic.placa;
                        veiculo.Renavam = veic.RENAVAM;
                        veiculo.Tipo = veic.tpProp.ToString();
                        veiculo.Tara = int.Parse(veic.tara);
                        veiculo.TipoCarroceria = string.Format("{0:00}", (int)veic.tpCar);
                        veiculo.TipoRodado = string.Format("{0:00}", (int)veic.tpRod);
                        veiculo.TipoVeiculo = string.Format("{0:0}", (int)veic.tpVeic);
                        veiculo.Estado = repEstado.BuscarPorSigla(veic.UF.ToString("G"));
                        veiculo.Ativo = true;

                        repVeiculo.Inserir(veiculo);
                    }

                    Dominio.Entidades.VeiculoCTE veiculoCTe = new Dominio.Entidades.VeiculoCTE();

                    veiculoCTe.CTE = conhecimento;
                    veiculoCTe.Veiculo = veiculo;
                    veiculoCTe.SetarDadosVeiculo(veiculo);

                    repVeiculoCTe.Inserir(veiculoCTe);
                }
            }
        }

        private void SalvarInformacoesVeiculos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ModalRodoviario.rodoVeic[] infVeic, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infVeic != null)
            {
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
                Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unidadeDeTrabalho);
                Repositorio.Estado repEstado = new Repositorio.Estado(unidadeDeTrabalho);

                bool atualizarVeiculo = conhecimento.Empresa.Configuracao != null ? conhecimento.Empresa.Configuracao.AtualizaVeiculoImpXMLCTe : false;

                foreach (MultiSoftware.CTe.v200.ModalRodoviario.rodoVeic veic in infVeic)
                {
                    Dominio.Entidades.Veiculo veiculo = repVeiculo.BuscarPorPlaca(conhecimento.Empresa.Codigo, veic.placa);
                    bool inserir = false;

                    if (veiculo == null)
                        veiculo = repVeiculo.BuscarPorPlacaESemEmpresa(veic.placa);

                    if (veiculo == null)
                    {
                        veiculo = new Dominio.Entidades.Veiculo();
                        inserir = true;

                        veiculo.Empresa = conhecimento.Empresa;
                        veiculo.Placa = veic.placa;
                    }

                    if (inserir || atualizarVeiculo)
                    {
                        bool situacaoAnterior = veiculo.Ativo;
                        veiculo.Ativo = true;
                        if (int.Parse(veic.capKG) > 0)
                            veiculo.CapacidadeKG = int.Parse(veic.capKG);
                        if (int.Parse(veic.capM3) > 0)
                            veiculo.CapacidadeM3 = int.Parse(veic.capM3);
                        if (veic.RENAVAM != null && veic.RENAVAM != "")
                            veiculo.Renavam = veic.RENAVAM;
                        if (int.Parse(veic.tara) > 0)
                            veiculo.Tara = int.Parse(veic.tara);
                        veiculo.TipoCarroceria = string.Format("{0:00}", (int)veic.tpCar);
                        veiculo.TipoRodado = string.Format("{0:00}", (int)veic.tpRod);
                        veiculo.TipoVeiculo = string.Format("{0:0}", (int)veic.tpVeic);
                        veiculo.Estado = repEstado.BuscarPorSigla(veic.UF.ToString("G"));
                        veiculo.Tipo = veic.tpProp.ToString();
                        if (veiculo.Tipo == "T")
                        {
                            if (veic.prop != null)
                            {
                                veiculo.Proprietario = this.ObterProprietario(veic.prop, unidadeDeTrabalho);
                                veiculo.TipoProprietario = (Dominio.Enumeradores.TipoProprietarioVeiculo)veic.prop.tpProp;
                                if (veiculo.Proprietario != null)
                                    veiculo.RNTRC = int.Parse(veic.prop.RNTRC);
                            }
                        }

                        if (inserir)
                            repVeiculo.Inserir(veiculo);
                        else
                        {
                            Servicos.Embarcador.Veiculo.VeiculoHistorico.InserirHistoricoVeiculo(veiculo, situacaoAnterior, MetodosAlteracaoVeiculo.SalvarInformacoesVeiculosV200_CTE, null, unidadeDeTrabalho);

                            repVeiculo.Atualizar(veiculo);
                        }
                    }

                    Dominio.Entidades.VeiculoCTE veiculoCTe = new Dominio.Entidades.VeiculoCTE();

                    veiculoCTe.CTE = conhecimento;
                    veiculoCTe.Veiculo = veiculo;
                    veiculoCTe.SetarDadosVeiculo(veiculo);

                    repVeiculoCTe.Inserir(veiculoCTe);
                }
            }
        }

        private void SalvarInformacoesVeiculos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ModalRodoviario.rodoOSVeic veic, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (veic != null)
            {
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
                Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unidadeDeTrabalho);
                Repositorio.Estado repEstado = new Repositorio.Estado(unidadeDeTrabalho);

                bool atualizarVeiculo = conhecimento.Empresa.Configuracao != null ? conhecimento.Empresa.Configuracao.AtualizaVeiculoImpXMLCTe : false;

                Dominio.Entidades.Veiculo veiculo = repVeiculo.BuscarPorPlaca(conhecimento.Empresa.Codigo, veic.placa);
                bool inserir = false;

                if (veiculo == null)
                    veiculo = repVeiculo.BuscarPorPlacaESemEmpresa(veic.placa);

                if (veiculo == null)
                {
                    veiculo = new Dominio.Entidades.Veiculo();
                    inserir = true;

                    veiculo.Empresa = conhecimento.Empresa;
                    veiculo.Placa = veic.placa;
                }

                if (inserir || atualizarVeiculo)
                {
                    bool situacaoAnterior = veiculo.Ativo;
                    veiculo.Ativo = true;
                    if (veic.RENAVAM != null && veic.RENAVAM != "")
                        veiculo.Renavam = veic.RENAVAM;
                    veiculo.TipoCarroceria = "00";
                    veiculo.TipoRodado = "00";
                    veiculo.TipoVeiculo = "0";
                    veiculo.Estado = repEstado.BuscarPorSigla(veic.UF.ToString("G"));
                    veiculo.Tipo = veic.prop != null ? "T" : "P";
                    if (veiculo.Tipo == "T")
                    {
                        if (veic.prop != null)
                        {
                            veiculo.Proprietario = this.ObterProprietario(veic.prop, unidadeDeTrabalho);
                            veiculo.TipoProprietario = (Dominio.Enumeradores.TipoProprietarioVeiculo)veic.prop.tpProp;
                        }
                    }

                    if (inserir)
                        repVeiculo.Inserir(veiculo);
                    else
                    {
                        Servicos.Embarcador.Veiculo.VeiculoHistorico.InserirHistoricoVeiculo(veiculo, situacaoAnterior, MetodosAlteracaoVeiculo.SalvarInformacoesVeiculosV300_CTE, null, unidadeDeTrabalho);

                        repVeiculo.Atualizar(veiculo);
                    }
                }

                Dominio.Entidades.VeiculoCTE veiculoCTe = new Dominio.Entidades.VeiculoCTE();

                veiculoCTe.CTE = conhecimento;
                veiculoCTe.Veiculo = veiculo;
                veiculoCTe.SetarDadosVeiculo(veiculo);

                repVeiculoCTe.Inserir(veiculoCTe);
            }
        }

        private void SalvarInformacoesVeiculos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ModalRodoviario.rodoOSVeic veic, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (veic != null)
            {
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
                Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unidadeDeTrabalho);
                Repositorio.Estado repEstado = new Repositorio.Estado(unidadeDeTrabalho);

                bool atualizarVeiculo = conhecimento.Empresa.Configuracao != null ? conhecimento.Empresa.Configuracao.AtualizaVeiculoImpXMLCTe : false;

                Dominio.Entidades.Veiculo veiculo = repVeiculo.BuscarPorPlaca(conhecimento.Empresa.Codigo, veic.placa);
                bool inserir = false;

                if (veiculo == null)
                    veiculo = repVeiculo.BuscarPorPlacaESemEmpresa(veic.placa);

                if (veiculo == null)
                {
                    veiculo = new Dominio.Entidades.Veiculo();
                    inserir = true;

                    veiculo.Empresa = conhecimento.Empresa;
                    veiculo.Placa = veic.placa;
                }

                if (inserir || atualizarVeiculo)
                {
                    bool situacaoAnterior = veiculo.Ativo;
                    veiculo.Ativo = true;
                    if (veic.RENAVAM != null && veic.RENAVAM != "")
                        veiculo.Renavam = veic.RENAVAM;
                    veiculo.TipoCarroceria = "00";
                    veiculo.TipoRodado = "00";
                    veiculo.TipoVeiculo = "0";
                    veiculo.Estado = repEstado.BuscarPorSigla(veic.UF.ToString("G"));
                    veiculo.Tipo = veic.prop != null ? "T" : "P";
                    if (veiculo.Tipo == "T")
                    {
                        if (veic.prop != null)
                        {
                            veiculo.Proprietario = this.ObterProprietario(veic.prop, unidadeDeTrabalho);
                            veiculo.TipoProprietario = (Dominio.Enumeradores.TipoProprietarioVeiculo)veic.prop.tpProp;
                        }
                    }

                    if (inserir)
                        repVeiculo.Inserir(veiculo);
                    else
                    {
                        Servicos.Embarcador.Veiculo.VeiculoHistorico.InserirHistoricoVeiculo(veiculo, situacaoAnterior, MetodosAlteracaoVeiculo.SalvarInformacoesVeiculosV400_CTE, null, unidadeDeTrabalho);

                        repVeiculo.Atualizar(veiculo);
                    }
                }

                Dominio.Entidades.VeiculoCTE veiculoCTe = new Dominio.Entidades.VeiculoCTE();

                veiculoCTe.CTE = conhecimento;
                veiculoCTe.Veiculo = veiculo;
                veiculoCTe.SetarDadosVeiculo(veiculo);

                repVeiculoCTe.Inserir(veiculoCTe);
            }
        }

        private Dominio.Entidades.Cliente ObterProprietario(MultiSoftware.CTe.v200.ModalRodoviario.rodoVeicProp prop, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (prop != null)
            {
                double cpfCnpj = double.Parse(Utilidades.String.OnlyNumbers(prop.Item));

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
                    Repositorio.Estado repEstado = new Repositorio.Estado(unidadeDeTrabalho);

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.Estado estado = null;

                    Repositorio.Atividade repAtividade = new Repositorio.Atividade(unidadeDeTrabalho);

                    bool inserir = false;

                    if (cliente == null)
                    {
                        inserir = true;
                        cliente = new Dominio.Entidades.Cliente();

                        cliente.CPF_CNPJ = cpfCnpj;
                        cliente.Atividade = repAtividade.BuscarPorCodigo(1);
                        cliente.Bairro = "BAIRRO";
                        cliente.CEP = "88888888";
                        cliente.DataCadastro = DateTime.Now;
                        cliente.EmailStatus = "I";
                        cliente.EmailContadorStatus = "I";
                        cliente.EmailContatoStatus = "I";
                        cliente.Endereco = "ENDERECO";

                        estado = repEstado.BuscarPorSigla(prop.UF.ToString());
                        cliente.Localidade = repLocalidade.BuscarPrimeiraPorUF(estado.Sigla);

                        cliente.Numero = "S/N";
                        cliente.Tipo = Utilidades.String.OnlyNumbers(prop.Item).Length == 14 ? "J" : "F";
                    }
                    cliente.Ativo = true;
                    cliente.IE_RG = prop.IE != null ? Utilidades.String.OnlyNumbers(prop.IE) : "ISENTO";
                    cliente.Nome = prop.xNome;
                    cliente.NomeFantasia = prop.xNome;

                    if (cliente.Localidade.Estado.Sigla != prop.UF.ToString())
                    {
                        estado = repEstado.BuscarPorSigla(prop.UF.ToString());
                        cliente.Localidade = repLocalidade.BuscarPrimeiraPorUF(estado.Sigla);
                    }

                    if (inserir)
                    {
                        if (cliente.Tipo == "J" && cliente.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeDeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(cliente.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                cliente.GrupoPessoas = grupoPessoas;
                            }
                        }
                        cliente.DataUltimaAtualizacao = DateTime.Now;
                        cliente.Integrado = false;
                        repCliente.Inserir(cliente);
                    }
                    else if (!cliente.NaoAtualizarDados)
                    {
                        cliente.DataUltimaAtualizacao = DateTime.Now;
                        cliente.Integrado = false;
                        repCliente.Atualizar(cliente);
                    }

                    return cliente;
                }
            }

            return null;
        }

        private Dominio.Entidades.Cliente ObterProprietario(MultiSoftware.CTe.v300.ModalRodoviario.rodoOSVeicProp prop, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (prop != null)
            {
                double cpfCnpj = double.Parse(Utilidades.String.OnlyNumbers(prop.Item));

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
                    Repositorio.Estado repEstado = new Repositorio.Estado(unidadeDeTrabalho);

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.Estado estado = null;

                    Repositorio.Atividade repAtividade = new Repositorio.Atividade(unidadeDeTrabalho);

                    bool inserir = false;

                    if (cliente == null)
                    {
                        inserir = true;
                        cliente = new Dominio.Entidades.Cliente();

                        cliente.CPF_CNPJ = cpfCnpj;
                        cliente.Atividade = repAtividade.BuscarPorCodigo(1);
                        cliente.Bairro = "BAIRRO";
                        cliente.CEP = "88888888";
                        cliente.DataCadastro = DateTime.Now;
                        cliente.EmailStatus = "I";
                        cliente.EmailContadorStatus = "I";
                        cliente.EmailContatoStatus = "I";
                        cliente.Endereco = "ENDERECO";

                        estado = repEstado.BuscarPorSigla(prop.UF.ToString());
                        cliente.Localidade = repLocalidade.BuscarPrimeiraPorUF(estado.Sigla);

                        cliente.Numero = "S/N";
                        cliente.Tipo = Utilidades.String.OnlyNumbers(prop.Item).Length == 14 ? "J" : "F";
                    }
                    cliente.Ativo = true;
                    cliente.IE_RG = prop.IE != null ? Utilidades.String.OnlyNumbers(prop.IE) : "ISENTO";
                    cliente.Nome = prop.xNome;
                    cliente.NomeFantasia = prop.xNome;

                    if (cliente.Localidade.Estado.Sigla != prop.UF.ToString())
                    {
                        estado = repEstado.BuscarPorSigla(prop.UF.ToString());
                        cliente.Localidade = repLocalidade.BuscarPrimeiraPorUF(estado.Sigla);
                    }

                    if (inserir)
                    {
                        if (cliente.Tipo == "J" && cliente.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeDeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(cliente.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                cliente.GrupoPessoas = grupoPessoas;
                            }
                        }
                        repCliente.Inserir(cliente);
                    }
                    else if (!cliente.NaoAtualizarDados)
                    {
                        cliente.DataUltimaAtualizacao = DateTime.Now;
                        cliente.Integrado = false;
                        repCliente.Atualizar(cliente);
                    }

                    return cliente;
                }
            }

            return null;
        }

        private Dominio.Entidades.Cliente ObterProprietario(MultiSoftware.CTe.v400.ModalRodoviario.rodoOSVeicProp prop, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (prop != null)
            {
                double cpfCnpj = double.Parse(Utilidades.String.OnlyNumbers(prop.Item));

                if (cpfCnpj > 0)
                {
                    Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);
                    Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
                    Repositorio.Estado repEstado = new Repositorio.Estado(unidadeDeTrabalho);

                    Dominio.Entidades.Cliente cliente = repCliente.BuscarPorCPFCNPJ(cpfCnpj);
                    Dominio.Entidades.Estado estado = null;

                    Repositorio.Atividade repAtividade = new Repositorio.Atividade(unidadeDeTrabalho);

                    bool inserir = false;

                    if (cliente == null)
                    {
                        inserir = true;
                        cliente = new Dominio.Entidades.Cliente();

                        cliente.CPF_CNPJ = cpfCnpj;
                        cliente.Atividade = repAtividade.BuscarPorCodigo(1);
                        cliente.Bairro = "BAIRRO";
                        cliente.CEP = "88888888";
                        cliente.DataCadastro = DateTime.Now;
                        cliente.EmailStatus = "I";
                        cliente.EmailContadorStatus = "I";
                        cliente.EmailContatoStatus = "I";
                        cliente.Endereco = "ENDERECO";

                        estado = repEstado.BuscarPorSigla(prop.UF.ToString());
                        cliente.Localidade = repLocalidade.BuscarPrimeiraPorUF(estado.Sigla);

                        cliente.Numero = "S/N";
                        cliente.Tipo = Utilidades.String.OnlyNumbers(prop.Item).Length == 14 ? "J" : "F";
                    }
                    cliente.Ativo = true;
                    cliente.IE_RG = prop.IE != null ? Utilidades.String.OnlyNumbers(prop.IE) : "ISENTO";
                    cliente.Nome = prop.xNome;
                    cliente.NomeFantasia = prop.xNome;

                    if (cliente.Localidade.Estado.Sigla != prop.UF.ToString())
                    {
                        estado = repEstado.BuscarPorSigla(prop.UF.ToString());
                        cliente.Localidade = repLocalidade.BuscarPrimeiraPorUF(estado.Sigla);
                    }

                    if (inserir)
                    {
                        if (cliente.Tipo == "J" && cliente.GrupoPessoas == null)
                        {
                            Repositorio.Embarcador.Pessoas.GrupoPessoas repGrupoPessoas = new Repositorio.Embarcador.Pessoas.GrupoPessoas(unidadeDeTrabalho);
                            Dominio.Entidades.Embarcador.Pessoas.GrupoPessoas grupoPessoas = repGrupoPessoas.BuscarPorRaizCNPJ(Utilidades.String.OnlyNumbers(cliente.CPF_CNPJ_Formatado).Remove(8, 6));
                            if (grupoPessoas != null)
                            {
                                cliente.GrupoPessoas = grupoPessoas;
                            }
                        }
                        repCliente.Inserir(cliente);
                    }
                    else if (!cliente.NaoAtualizarDados)
                    {
                        cliente.DataUltimaAtualizacao = DateTime.Now;
                        cliente.Integrado = false;
                        repCliente.Atualizar(cliente);
                    }

                    return cliente;
                }
            }

            return null;
        }

        private void SalvarInformacoesVeiculos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, Dominio.NDDigital.v104.Emissao.Registro15900 infModal, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infModal != null && infModal.rodo != null && infModal.rodo.veic != null)
            {
                Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unidadeDeTrabalho);
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
                Repositorio.Estado repEstado = new Repositorio.Estado(unidadeDeTrabalho);
                Repositorio.Embarcador.Veiculos.VeiculoMotorista repVeiculoMotorista = new Repositorio.Embarcador.Veiculos.VeiculoMotorista(unidadeDeTrabalho);

                Dominio.Entidades.Veiculo veiculoPai = null;

                foreach (Dominio.NDDigital.v104.Emissao.Registro16400 veic in infModal.rodo.veic)
                {
                    Dominio.Entidades.Veiculo veiculo = repVeiculo.BuscarPorPlaca(conhecimento.Empresa.Codigo, veic.placa);

                    if (veiculo == null)
                        veiculo = new Dominio.Entidades.Veiculo();

                    veiculo.CapacidadeKG = veic.capKG;
                    veiculo.CapacidadeM3 = veic.capM3;
                    veiculo.Empresa = conhecimento.Empresa;
                    veiculo.Estado = repEstado.BuscarPorSigla(veic.UF);
                    veiculo.Placa = veic.placa.ToUpper();
                    bool situacaoAnterior = veiculo.Ativo;
                    veiculo.Ativo = true;
                    veiculo.Renavam = veic.RENAVAM;
                    veiculo.Tara = veic.tara;
                    veiculo.Tipo = veic.tpProp;
                    veiculo.TipoCarroceria = veic.tpCar;
                    veiculo.TipoRodado = veic.tpRod;
                    veiculo.TipoVeiculo = veic.tpVeic;

                    if (veiculo.TipoVeiculo == "0")
                    {
                        //if (infModal.rodo.moto != null && infModal.rodo.moto.Count() > 0)
                        //{
                        //    veiculo.CPFMotorista = infModal.rodo.moto[0].CPF;
                        //    veiculo.NomeMotorista = infModal.rodo.moto[0].xNome;

                        //    repVeiculo.Atualizar(veiculo);
                        //}

                        veiculoPai = veiculo;
                    }

                    if (veiculo.Codigo > 0)
                    {
                        Servicos.Embarcador.Veiculo.VeiculoHistorico.InserirHistoricoVeiculo(veiculo, situacaoAnterior, MetodosAlteracaoVeiculo.SalvarInformacoesVeiculosV104_CTE, null, unidadeDeTrabalho);
                        repVeiculo.Atualizar(veiculo);
                    }
                    else
                        repVeiculo.Inserir(veiculo);

                    if (veiculoPai != null && veiculo.TipoVeiculo == "1" && !(from obj in veiculoPai.VeiculosVinculados where obj.Placa.ToLower().Equals(veiculo.Placa.ToLower()) select obj).Any())
                    {
                        veiculoPai.VeiculosVinculados.Add(veiculo);

                        repVeiculo.Atualizar(veiculoPai);
                    }

                    Dominio.Entidades.VeiculoCTE veiculoCTe = new Dominio.Entidades.VeiculoCTE();

                    veiculoCTe.CTE = conhecimento;
                    veiculoCTe.Veiculo = veiculo;
                    veiculoCTe.SetarDadosVeiculo(veiculo);

                    repVeiculoCTe.Inserir(veiculoCTe);
                }

                //if (veiculoPai != null && !string.IsNullOrWhiteSpace(veiculoPai.CPFMotorista) && !string.IsNullOrWhiteSpace(veiculoPai.NomeMotorista))
                //{
                //    Repositorio.MotoristaCTE repMotoristaCTe = new Repositorio.MotoristaCTE(unidadeDeTrabalho);

                //    Dominio.Entidades.MotoristaCTE motorista = new Dominio.Entidades.MotoristaCTE();

                //    motorista.CPFMotorista = veiculoPai.CPFMotorista;
                //    motorista.NomeMotorista = veiculoPai.NomeMotorista;
                //    motorista.CTE = conhecimento;

                //    repMotoristaCTe.Inserir(motorista);
                //}
            }
        }

        private void SalvarInformacoesVeiculos(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, Dominio.ObjetosDeValor.CTe.CTe cte, Repositorio.UnitOfWork unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            bool configCTeUtilizaProprietarioCadastro = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().CTeUtilizaProprietarioCadastro.HasValue && Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().CTeUtilizaProprietarioCadastro.Value;

            bool configCTeCarregarVinculosVeiculosCadastro = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().CTeCarregarVinculosVeiculosCadastro.HasValue && Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().CTeCarregarVinculosVeiculosCadastro.Value;

            bool atualizaTipoVeiculo = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().CTeAtualizaTipoVeiculo.HasValue && Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().CTeAtualizaTipoVeiculo.Value;
            bool naoAtualizarCadastroVeiculo = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().NaoAtualizarCadastroVeiculo.HasValue && Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().NaoAtualizarCadastroVeiculo.Value;

            bool utilizaEmpresaVeiculoComoProprietario = conhecimento.Empresa.Configuracao?.UtilizaEmpresaVeiculoComoProprietario ?? false;

            if (cte.Veiculos != null && cte.Veiculos.Count() > 0)
            {
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
                Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unidadeDeTrabalho);
                Repositorio.Estado repEstado = new Repositorio.Estado(unidadeDeTrabalho);
                Repositorio.Embarcador.Veiculos.VeiculoMotorista repVeiculoMotorista = new Repositorio.Embarcador.Veiculos.VeiculoMotorista(unidadeDeTrabalho);

                List<Dominio.Entidades.Veiculo> veiculosCadastrados = new List<Dominio.Entidades.Veiculo>();

                foreach (Dominio.ObjetosDeValor.CTe.Veiculo veic in cte.Veiculos)
                {
                    bool veiculoPossuiCadastro = false;

                    Dominio.Entidades.Veiculo veiculo = null;

                    if (veic.CodigoVeiculo > 0)
                        veiculo = repVeiculo.BuscarPorCodigo(veic.CodigoVeiculo);

                    if (veiculo == null && tipoServicoMultisoftware.HasValue && tipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                        veiculo = repVeiculo.BuscarPorPlacaESemEmpresa(veic.Placa);

                    Dominio.Entidades.Cliente proprietarioEmpresa = null;
                    if (veiculo == null && utilizaEmpresaVeiculoComoProprietario)
                    {
                        veiculo = repVeiculo.BuscarPorPlacaEmpresaDiferente(veic.Placa, conhecimento.Empresa.Codigo);
                        if (veiculo != null)
                        {
                            proprietarioEmpresa = this.ObterClienteEmpresa(veiculo.Empresa, unidadeDeTrabalho);
                            if (proprietarioEmpresa == null)
                            {
                                veiculo = null;
                                Servicos.Log.TratarErro("Não foi possivel localizar/cadastrar ");
                            }
                        }
                    }

                    if (veiculo == null)
                        veiculo = repVeiculo.BuscarPorPlaca(conhecimento.Empresa.Codigo, veic.Placa);

                    if (veiculo == null)
                    {
                        veiculo = new Dominio.Entidades.Veiculo();
                        veiculo.Empresa = conhecimento.Empresa;
                        veiculoPossuiCadastro = false;
                    }
                    else
                        veiculoPossuiCadastro = true;

                    if (!veiculoPossuiCadastro || !tipoServicoMultisoftware.HasValue || (tipoServicoMultisoftware.Value != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS && tipoServicoMultisoftware.Value != AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador))
                    {
                        if (!naoAtualizarCadastroVeiculo || !veiculoPossuiCadastro)
                        {
                            veiculo.CapacidadeKG = veic.CapacidadeKG > 0 ? veic.CapacidadeKG : veiculo.CapacidadeKG;
                            veiculo.CapacidadeM3 = veic.CapacidadeM3 > 0 ? veic.CapacidadeM3 : veiculo.CapacidadeM3;
                            veiculo.Placa = veic.Placa;
                            veiculo.Renavam = string.IsNullOrWhiteSpace(veic.Renavam) ? veiculo.Renavam : veic.Renavam;
                            veiculo.Tara = veic.Tara > 0 ? veic.Tara : veiculo.Tara;
                            veiculo.TipoCarroceria = !string.IsNullOrWhiteSpace(veic.TipoCarroceria) ? veic.TipoCarroceria : veiculo != null && !string.IsNullOrWhiteSpace(veiculo.TipoCarroceria) ? veiculo.TipoCarroceria : "02";
                            veiculo.TipoRodado = !string.IsNullOrWhiteSpace(veic.TipoRodado) ? veic.TipoRodado : veiculo != null && !string.IsNullOrWhiteSpace(veiculo.TipoRodado) ? veiculo.TipoRodado : "01";

                            if (atualizaTipoVeiculo || !veiculoPossuiCadastro)
                                veiculo.TipoVeiculo = !string.IsNullOrWhiteSpace(veic.TipoVeiculo) ? veic.TipoVeiculo : veiculo != null && !string.IsNullOrWhiteSpace(veiculo.TipoVeiculo) ? veiculo.TipoVeiculo : "0";

                            bool situacaoAnterior = veiculo.Ativo;

                            veiculo.Ativo = true;
                            veiculo.Estado = !string.IsNullOrWhiteSpace(veic.UF) ? repEstado.BuscarPorSigla(veic.UF) : veiculo != null && veiculo.Estado != null ? veiculo.Estado : conhecimento.Empresa.Localidade.Estado;
                            veiculo.Chassi = string.IsNullOrWhiteSpace(veic.Chassi) ? veiculo.Chassi : veic.Chassi;

                            if (configCTeUtilizaProprietarioCadastro)
                            {
                                veiculo.Proprietario = veic.Proprietario != null ? this.ObterCliente(conhecimento.Empresa, veic.Proprietario, unidadeDeTrabalho) : veiculo.Proprietario;
                                if (veiculo.Proprietario != null)
                                    veiculo.Tipo = "T";
                                else
                                    veiculo.Tipo = "P";
                            }
                            else
                            {
                                veiculo.Tipo = !string.IsNullOrWhiteSpace(veic.TipoPropriedade) ? veic.TipoPropriedade : veiculo != null && !string.IsNullOrWhiteSpace(veiculo.Tipo) ? veiculo.Tipo : "P";
                                if (veic.Proprietario == null || conhecimento.Empresa.CNPJ == veic.Proprietario.CPFCNPJ)
                                    veiculo.Tipo = "P";
                                else
                                    veiculo.Proprietario = this.ObterCliente(conhecimento.Empresa, veic.Proprietario, unidadeDeTrabalho);
                            }

                            veiculo.TipoProprietario = veic.TipoProprietario;
                            veiculo.RNTRC = veic.RNTRCProprietario > 0 && veiculo.Proprietario != null ? veic.RNTRCProprietario : veiculo.RNTRC;
                            veiculo.CIOT = cte.CIOT != null ? cte.CIOT : veiculo.CIOT;

                            if (veiculo.Codigo <= 0)
                                repVeiculo.Inserir(veiculo);
                            else
                            {
                                Servicos.Embarcador.Veiculo.VeiculoHistorico.InserirHistoricoVeiculo(veiculo, situacaoAnterior, MetodosAlteracaoVeiculo.SalvarInformacoesVeiculosCTE_CTE, null, unidadeDeTrabalho);
                                repVeiculo.Atualizar(veiculo);
                            }
                        }
                    }

                    veiculosCadastrados.Add(veiculo);

                    Dominio.Entidades.VeiculoCTE veiculoCTe = new Dominio.Entidades.VeiculoCTE();

                    veiculoCTe.CTE = conhecimento;
                    veiculoCTe.Veiculo = veiculo;
                    veiculoCTe.SetarDadosVeiculo(veiculo, (veiculo.Empresa != null && conhecimento.Empresa.Codigo != veiculo.Empresa.Codigo ? proprietarioEmpresa : null));

                    repVeiculoCTe.Inserir(veiculoCTe);

                    if (((veiculo.Tipo == "T" && veiculo.Proprietario != null) || (proprietarioEmpresa != null)) && !string.IsNullOrWhiteSpace(veiculo.CIOT))
                        conhecimento.CIOT = Utilidades.String.Left(veiculo.CIOT, 12);
                }

                if (veiculosCadastrados.Count() > 0 && (cte.Motoristas == null || cte.Motoristas.Count() <= 0))
                {
                    Dominio.Entidades.Veiculo veiculo = repVeiculoMotorista.BuscarPrimeiroVeiculoComMotorista(veiculosCadastrados.Select(c => c.Codigo).ToList());

                    if (veiculo != null)
                        this.SalvarInformacoesMotoristas(conhecimento, veiculo, unidadeDeTrabalho);
                }

                //Carregar vinculos dos veiculos cadastrados
                if (configCTeCarregarVinculosVeiculosCadastro && veiculosCadastrados.Count() > 0)
                {
                    foreach (Dominio.Entidades.Veiculo veiculo in veiculosCadastrados)
                    {
                        if (veiculo.VeiculosVinculados != null && veiculo.VeiculosVinculados.Count > 0)
                        {
                            foreach (Dominio.Entidades.Veiculo vinculo in veiculo.VeiculosVinculados)
                            {
                                if ((from obj in cte.Veiculos where obj.Placa == vinculo.Placa select obj).Count() == 0)
                                {
                                    Dominio.Entidades.VeiculoCTE veiculoCTe = new Dominio.Entidades.VeiculoCTE();

                                    veiculoCTe.CTE = conhecimento;
                                    veiculoCTe.Veiculo = vinculo;
                                    veiculoCTe.SetarDadosVeiculo(vinculo);

                                    repVeiculoCTe.Inserir(veiculoCTe);
                                }
                            }
                        }
                    }
                }
            }
        }

        private void SalvarInformacoesVeiculos(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.Embarcador.Frota.Veiculo> veiculos, Repositorio.UnitOfWork unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware)
        {
            WebService.Frota.Veiculo svcvVeiculo = new WebService.Frota.Veiculo(unidadeDeTrabalho);

            if (veiculos != null && veiculos.Count() > 0)
            {
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
                Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unidadeDeTrabalho);
                Repositorio.Embarcador.Veiculos.VeiculoMotorista repVeiculoMotorista = new Repositorio.Embarcador.Veiculos.VeiculoMotorista(unidadeDeTrabalho);

                List<Dominio.Entidades.Veiculo> veiculosCadastrados = new List<Dominio.Entidades.Veiculo>();

                foreach (Dominio.ObjetosDeValor.Embarcador.Frota.Veiculo veic in veiculos)
                {
                    string mensagem = "";
                    Dominio.Entidades.Veiculo veiculo = svcvVeiculo.SalvarVeiculo(veic, conhecimento.Empresa, false, ref mensagem, unidadeDeTrabalho, tipoServicoMultisoftware);

                    if (!string.IsNullOrWhiteSpace(mensagem))
                    {
                        Servicos.Log.TratarErro(mensagem);
                        throw new ArgumentNullException("Não foi possível inserir o Veículo.");
                    }
                    veiculosCadastrados.Add(veiculo);
                    Dominio.Entidades.VeiculoCTE veiculoCTe = new Dominio.Entidades.VeiculoCTE();

                    veiculoCTe.CTE = conhecimento;
                    veiculoCTe.Veiculo = veiculo;
                    veiculoCTe.SetarDadosVeiculo(veiculo);

                    repVeiculoCTe.Inserir(veiculoCTe);
                }

                if (veiculosCadastrados.Count() > 0 && (conhecimento.Motoristas == null || conhecimento.Motoristas.Count() <= 0))
                {
                    Dominio.Entidades.Veiculo veiculo = repVeiculoMotorista.BuscarVeiculoPorCPFMotorista(conhecimento.Motoristas.FirstOrDefault().CPFMotorista);

                    if (veiculo != null)
                        this.SalvarInformacoesMotoristas(conhecimento, veiculo, unidadeDeTrabalho);
                }
            }
        }

        private void SalvarInformacoesVeiculos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<MultiSoftware.NFe.NotaFiscal.TVeiculo> veiculos, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (veiculos != null && veiculos.Count() > 0)
            {
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
                Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unidadeDeTrabalho);

                foreach (MultiSoftware.NFe.NotaFiscal.TVeiculo veic in veiculos)
                {
                    if (veic != null)
                    {
                        Dominio.Entidades.Veiculo veiculo = repVeiculo.BuscarPorPlaca(conhecimento.Empresa.Codigo, veic.placa);

                        if (veiculo != null)
                        {
                            Dominio.Entidades.VeiculoCTE veiculoCTe = new Dominio.Entidades.VeiculoCTE();

                            veiculoCTe.CTE = conhecimento;
                            veiculoCTe.Veiculo = veiculo;
                            veiculoCTe.SetarDadosVeiculo(veiculo);

                            repVeiculoCTe.Inserir(veiculoCTe);

                            this.SalvarInformacoesReboques(conhecimento, veiculo.VeiculosVinculados.ToList(), unidadeDeTrabalho);

                            this.SalvarInformacoesMotoristas(conhecimento, veiculo, unidadeDeTrabalho);
                        }
                    }
                }
            }
        }

        private void SalvarInformacoesVeiculos(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<MultiSoftware.NFe.v310.NotaFiscal.TVeiculo> veiculos, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (veiculos != null && veiculos.Count() > 0)
            {
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
                Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unidadeDeTrabalho);

                foreach (MultiSoftware.NFe.v310.NotaFiscal.TVeiculo veic in veiculos)
                {
                    if (veic != null)
                    {
                        Dominio.Entidades.Veiculo veiculo = repVeiculo.BuscarPorPlaca(conhecimento.Empresa.Codigo, veic.placa);

                        if (veiculo != null)
                        {
                            Dominio.Entidades.VeiculoCTE veiculoCTe = new Dominio.Entidades.VeiculoCTE();

                            veiculoCTe.CTE = conhecimento;
                            veiculoCTe.Veiculo = veiculo;
                            veiculoCTe.SetarDadosVeiculo(veiculo);

                            repVeiculoCTe.Inserir(veiculoCTe);

                            conhecimento.Lotacao = Dominio.Enumeradores.OpcaoSimNao.Sim;
                            if (veiculo.Tipo == "T" && veiculo.Proprietario != null && !string.IsNullOrWhiteSpace(veiculo.CIOT))
                                conhecimento.CIOT = Utilidades.String.Left(veiculo.CIOT, 12);

                            this.SalvarInformacoesReboques(conhecimento, veiculo.VeiculosVinculados.ToList(), unidadeDeTrabalho);

                            this.SalvarInformacoesMotoristas(conhecimento, veiculo, unidadeDeTrabalho);
                        }
                    }
                }
            }
        }

        private void SalvarInformacoesVeiculos(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<MultiSoftware.NFe.v400.NotaFiscal.TVeiculo> veiculos, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (veiculos != null && veiculos.Count() > 0)
            {
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
                Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unidadeDeTrabalho);

                foreach (MultiSoftware.NFe.v400.NotaFiscal.TVeiculo veic in veiculos)
                {
                    if (veic != null)
                    {
                        Dominio.Entidades.Veiculo veiculo = repVeiculo.BuscarPorPlaca(conhecimento.Empresa.Codigo, veic.placa);

                        if (veiculo != null)
                        {
                            Dominio.Entidades.VeiculoCTE veiculoCTe = new Dominio.Entidades.VeiculoCTE();

                            veiculoCTe.CTE = conhecimento;
                            veiculoCTe.Veiculo = veiculo;
                            veiculoCTe.SetarDadosVeiculo(veiculo);

                            repVeiculoCTe.Inserir(veiculoCTe);

                            conhecimento.Lotacao = Dominio.Enumeradores.OpcaoSimNao.Sim;
                            if (veiculo.Tipo == "T" && veiculo.Proprietario != null && !string.IsNullOrWhiteSpace(veiculo.CIOT))
                                conhecimento.CIOT = Utilidades.String.Left(veiculo.CIOT, 12);

                            this.SalvarInformacoesReboques(conhecimento, veiculo.VeiculosVinculados.ToList(), unidadeDeTrabalho);

                            this.SalvarInformacoesMotoristas(conhecimento, veiculo, unidadeDeTrabalho);
                        }
                    }
                }
            }
        }

        private void SalvarInformacoesVeiculos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.Entidades.Veiculo> veiculos, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (veiculos != null && veiculos.Count > 0)
            {
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);

                foreach (Dominio.Entidades.Veiculo veiculo in veiculos)
                {
                    Dominio.Entidades.VeiculoCTE veiculoCTe = new Dominio.Entidades.VeiculoCTE();

                    veiculoCTe.CTE = conhecimento;
                    veiculoCTe.Veiculo = veiculo;
                    veiculoCTe.SetarDadosVeiculo(veiculo);

                    repVeiculoCTe.Inserir(veiculoCTe);

                    this.SalvarInformacoesReboques(conhecimento, veiculo.VeiculosVinculados.ToList(), unidadeDeTrabalho);

                    this.SalvarInformacoesMotoristas(conhecimento, veiculo, unidadeDeTrabalho);
                }
            }
        }

        private void SalvarInformacoesReboques(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.Entidades.Veiculo> veiculos, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (veiculos != null && veiculos.Count() > 0)
            {
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);

                foreach (Dominio.Entidades.Veiculo reboque in veiculos)
                {
                    Dominio.Entidades.VeiculoCTE reboqueCTe = new Dominio.Entidades.VeiculoCTE();

                    reboqueCTe.CTE = conhecimento;
                    reboqueCTe.Veiculo = reboque;
                    reboqueCTe.SetarDadosVeiculo(reboque);

                    repVeiculoCTe.Inserir(reboqueCTe);
                }
            }
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfCargaInfQ[] infQuant, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infQuant != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Repositorio.InformacaoCargaCTE repInfoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
                foreach (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfCargaInfQ informacaoQuantidade in infQuant)
                {
                    Dominio.Entidades.InformacaoCargaCTE infoQuantCarga = new Dominio.Entidades.InformacaoCargaCTE();
                    infoQuantCarga.CTE = conhecimento;
                    infoQuantCarga.UnidadeMedida = string.Format("{0:00}", (int)informacaoQuantidade.cUnid);
                    infoQuantCarga.Tipo = informacaoQuantidade.tpMed;
                    infoQuantCarga.Quantidade = decimal.Parse(informacaoQuantidade.qCarga, cultura);
                    repInfoCarga.Inserir(infoQuantCarga);
                }
            }
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfCargaInfQ[] infQuant, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infQuant != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Repositorio.InformacaoCargaCTE repInfoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
                foreach (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfCargaInfQ informacaoQuantidade in infQuant)
                {
                    Dominio.Entidades.InformacaoCargaCTE infoQuantCarga = new Dominio.Entidades.InformacaoCargaCTE();
                    infoQuantCarga.CTE = conhecimento;
                    infoQuantCarga.UnidadeMedida = string.Format("{0:00}", (int)informacaoQuantidade.cUnid);
                    infoQuantCarga.Tipo = informacaoQuantidade.tpMed;
                    infoQuantCarga.Quantidade = decimal.Parse(informacaoQuantidade.qCarga, cultura);
                    repInfoCarga.Inserir(infoQuantCarga);
                }
            }
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfCargaInfQ[] infQuant, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infQuant != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Repositorio.InformacaoCargaCTE repInfoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
                foreach (MultiSoftware.CTe.v300.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfCargaInfQ informacaoQuantidade in infQuant)
                {
                    Dominio.Entidades.InformacaoCargaCTE infoQuantCarga = null;
                    if (Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().AgruparQuantidadesImportacaoCTe.HasValue && Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().AgruparQuantidadesImportacaoCTe.Value)
                        infoQuantCarga = new Dominio.Entidades.InformacaoCargaCTE();
                    else
                    {
                        repInfoCarga.BuscarPorCTeUnidade(conhecimento.Codigo, string.Format("{0:00}", (int)informacaoQuantidade.cUnid));
                        if (infoQuantCarga == null)
                            infoQuantCarga = new Dominio.Entidades.InformacaoCargaCTE();
                    }
                    infoQuantCarga.CTE = conhecimento;
                    infoQuantCarga.UnidadeMedida = string.Format("{0:00}", (int)informacaoQuantidade.cUnid);
                    infoQuantCarga.Tipo = informacaoQuantidade.tpMed;
                    infoQuantCarga.Quantidade += decimal.Parse(informacaoQuantidade.qCarga, cultura);

                    if (infoQuantCarga.Codigo > 0)
                        repInfoCarga.Atualizar(infoQuantCarga);
                    else
                        repInfoCarga.Inserir(infoQuantCarga);

                    if (infoQuantCarga.UnidadeMedida == "03")
                        conhecimento.Volumes += infoQuantCarga.Quantidade;
                }
            }
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfCargaInfQ[] infQuant, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infQuant != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Repositorio.InformacaoCargaCTE repInfoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
                foreach (MultiSoftware.CTe.v400.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormInfCargaInfQ informacaoQuantidade in infQuant)
                {
                    Dominio.Entidades.InformacaoCargaCTE infoQuantCarga = null;
                    if (Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().AgruparQuantidadesImportacaoCTe.HasValue && Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().AgruparQuantidadesImportacaoCTe.Value)
                        infoQuantCarga = new Dominio.Entidades.InformacaoCargaCTE();
                    else
                    {
                        repInfoCarga.BuscarPorCTeUnidade(conhecimento.Codigo, string.Format("{0:00}", (int)informacaoQuantidade.cUnid));
                        if (infoQuantCarga == null)
                            infoQuantCarga = new Dominio.Entidades.InformacaoCargaCTE();
                    }
                    infoQuantCarga.CTE = conhecimento;
                    infoQuantCarga.UnidadeMedida = string.Format("{0:00}", (int)informacaoQuantidade.cUnid);
                    infoQuantCarga.Tipo = informacaoQuantidade.tpMed;
                    infoQuantCarga.Quantidade += decimal.Parse(informacaoQuantidade.qCarga, cultura);

                    if (infoQuantCarga.Codigo > 0)
                        repInfoCarga.Atualizar(infoQuantCarga);
                    else
                        repInfoCarga.Inserir(infoQuantCarga);

                    if (infoQuantCarga.UnidadeMedida == "03")
                        conhecimento.Volumes += infoQuantCarga.Quantidade;
                }
            }
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteInfCargaInfQ[] infQuant, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infQuant != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Repositorio.InformacaoCargaCTE repInfoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
                foreach (MultiSoftware.CTe.v400.ConhecimentoDeTransporteSimplificado.TCTeSimpInfCteInfCargaInfQ informacaoQuantidade in infQuant)
                {
                    Dominio.Entidades.InformacaoCargaCTE infoQuantCarga = null;
                    if (Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().AgruparQuantidadesImportacaoCTe.HasValue && Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeDeTrabalho).ObterConfiguracaoAmbiente().AgruparQuantidadesImportacaoCTe.Value)
                        infoQuantCarga = new Dominio.Entidades.InformacaoCargaCTE();
                    else
                    {
                        repInfoCarga.BuscarPorCTeUnidade(conhecimento.Codigo, string.Format("{0:00}", (int)informacaoQuantidade.cUnid));
                        if (infoQuantCarga == null)
                            infoQuantCarga = new Dominio.Entidades.InformacaoCargaCTE();
                    }
                    infoQuantCarga.CTE = conhecimento;
                    infoQuantCarga.UnidadeMedida = string.Format("{0:00}", (int)informacaoQuantidade.cUnid);
                    infoQuantCarga.Tipo = informacaoQuantidade.tpMed.ToString();
                    infoQuantCarga.Quantidade += decimal.Parse(informacaoQuantidade.qCarga, cultura);

                    if (infoQuantCarga.Codigo > 0)
                        repInfoCarga.Atualizar(infoQuantCarga);
                    else
                        repInfoCarga.Inserir(infoQuantCarga);

                    if (infoQuantCarga.UnidadeMedida == "03")
                        conhecimento.Volumes += infoQuantCarga.Quantidade;
                }
            }
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v300.ConhecimentoDeTransporteOS.TCTeOSInfCteInfCTeNormInfServicoInfQ infQuant, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infQuant != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Repositorio.InformacaoCargaCTE repInfoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);

                Dominio.Entidades.InformacaoCargaCTE infoQuantCarga = new Dominio.Entidades.InformacaoCargaCTE();
                infoQuantCarga.CTE = conhecimento;
                infoQuantCarga.UnidadeMedida = "04";
                infoQuantCarga.Tipo = "UN";
                infoQuantCarga.Quantidade = decimal.Parse(infQuant.qCarga, cultura);
                repInfoCarga.Inserir(infoQuantCarga);

            }
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v400.ConhecimentoDeTransporteOS.TCTeOSInfCteInfCTeNormInfServicoInfQ infQuant, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infQuant != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Repositorio.InformacaoCargaCTE repInfoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);

                Dominio.Entidades.InformacaoCargaCTE infoQuantCarga = new Dominio.Entidades.InformacaoCargaCTE();
                infoQuantCarga.CTE = conhecimento;
                infoQuantCarga.UnidadeMedida = "04";
                infoQuantCarga.Tipo = "UN";
                infoQuantCarga.Quantidade = decimal.Parse(infQuant.qCarga, cultura);
                repInfoCarga.Inserir(infoQuantCarga);

            }
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNormInfCargaInfQ[] infQuant, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (infQuant != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Repositorio.InformacaoCargaCTE repInfoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
                foreach (MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNormInfCargaInfQ informacaoQuantidade in infQuant)
                {
                    Dominio.Entidades.InformacaoCargaCTE infoQuantCarga = new Dominio.Entidades.InformacaoCargaCTE();
                    infoQuantCarga.CTE = conhecimento;
                    infoQuantCarga.UnidadeMedida = string.Format("{0:00}", (int)informacaoQuantidade.cUnid);
                    infoQuantCarga.Tipo = informacaoQuantidade.tpMed;
                    infoQuantCarga.Quantidade = decimal.Parse(informacaoQuantidade.qCarga, cultura);
                    repInfoCarga.Inserir(infoQuantCarga);
                }
            }
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.NFe.NotaFiscal.TNFeInfNFeTranspVol[] volumes, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (volumes != null)
            {
                Repositorio.InformacaoCargaCTE repInformacaoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
                Dominio.Entidades.InformacaoCargaCTE informacaoCarga = new Dominio.Entidades.InformacaoCargaCTE();
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                decimal peso = 0;

                foreach (MultiSoftware.NFe.NotaFiscal.TNFeInfNFeTranspVol vol in volumes)
                    peso += vol.pesoB != null ? decimal.Parse(vol.pesoB, cultura) : vol.pesoL != null ? decimal.Parse(vol.pesoL, cultura) : 0;

                informacaoCarga.CTE = conhecimento;
                informacaoCarga.Quantidade = peso;
                informacaoCarga.Tipo = "Kilograma";
                informacaoCarga.UnidadeMedida = string.Format("{0:00}", (int)Dominio.Enumeradores.UnidadeMedida.KG);

                repInformacaoCarga.Inserir(informacaoCarga);
            }
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.NFeAdmin> notasFiscais, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.InformacaoCargaCTE repInformacaoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
            Dominio.Entidades.InformacaoCargaCTE informacaoCarga = new Dominio.Entidades.InformacaoCargaCTE();
            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            decimal peso = 0;

            foreach (Dominio.ObjetosDeValor.NFeAdmin notaFiscal in notasFiscais)
            {
                if (notaFiscal.NFe2 != null)
                {
                    if (notaFiscal.NFe2.NFe.infNFe.transp != null && notaFiscal.NFe2.NFe.infNFe.transp.vol != null)
                    {
                        foreach (MultiSoftware.NFe.NotaFiscal.TNFeInfNFeTranspVol vol in notaFiscal.NFe2.NFe.infNFe.transp.vol)
                            peso += vol.pesoB != null ? decimal.Parse(vol.pesoB, cultura) : vol.pesoL != null ? decimal.Parse(vol.pesoL, cultura) : 0;
                    }
                }
                else if (notaFiscal.NFe3 != null)
                {
                    if (notaFiscal.NFe3.NFe.infNFe.transp != null && notaFiscal.NFe3.NFe.infNFe.transp.vol != null)
                    {
                        foreach (MultiSoftware.NFe.v310.NotaFiscal.TNFeInfNFeTranspVol vol in notaFiscal.NFe3.NFe.infNFe.transp.vol)
                            peso += vol.pesoB != null ? decimal.Parse(vol.pesoB, cultura) : vol.pesoL != null ? decimal.Parse(vol.pesoL, cultura) : 0;
                    }
                }
                else if (notaFiscal.NFe4 != null)
                {
                    if (notaFiscal.NFe4.NFe.infNFe.transp != null && notaFiscal.NFe4.NFe.infNFe.transp.vol != null)
                    {
                        foreach (MultiSoftware.NFe.v400.NotaFiscal.TNFeInfNFeTranspVol vol in notaFiscal.NFe4.NFe.infNFe.transp.vol)
                            peso += vol.pesoB != null ? decimal.Parse(vol.pesoB, cultura) : vol.pesoL != null ? decimal.Parse(vol.pesoL, cultura) : 0;
                    }
                }
            }

            informacaoCarga.CTE = conhecimento;
            informacaoCarga.Quantidade = peso;
            informacaoCarga.Tipo = "Kilograma";
            informacaoCarga.UnidadeMedida = string.Format("{0:00}", (int)Dominio.Enumeradores.UnidadeMedida.KG);

            repInformacaoCarga.Inserir(informacaoCarga);
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.NFe.v400.NotaFiscal.TNFeInfNFeTranspVol[] volumes, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (volumes != null)
            {
                Repositorio.InformacaoCargaCTE repInformacaoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
                Dominio.Entidades.InformacaoCargaCTE informacaoCarga = new Dominio.Entidades.InformacaoCargaCTE();
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                decimal peso = 0;
                decimal quantidade = 0;

                foreach (MultiSoftware.NFe.v400.NotaFiscal.TNFeInfNFeTranspVol vol in volumes)
                {
                    peso += vol.pesoB != null ? decimal.Parse(vol.pesoB, cultura) : vol.pesoL != null ? decimal.Parse(vol.pesoL, cultura) : 0;
                    quantidade += vol.qVol != null ? decimal.Parse(vol.qVol, cultura) : 0;
                }

                informacaoCarga.CTE = conhecimento;
                informacaoCarga.Quantidade = peso;
                informacaoCarga.Tipo = "Kilograma";
                informacaoCarga.UnidadeMedida = string.Format("{0:00}", (int)Dominio.Enumeradores.UnidadeMedida.KG);

                repInformacaoCarga.Inserir(informacaoCarga);

                if (quantidade > 0)
                {
                    Dominio.Entidades.InformacaoCargaCTE informacaoCargaQtd = new Dominio.Entidades.InformacaoCargaCTE();
                    informacaoCargaQtd.CTE = conhecimento;
                    informacaoCargaQtd.Quantidade = quantidade;
                    informacaoCargaQtd.Tipo = "Unidade";
                    informacaoCargaQtd.UnidadeMedida = string.Format("{0:00}", (int)Dominio.Enumeradores.UnidadeMedida.UN);

                    repInformacaoCarga.Inserir(informacaoCargaQtd);
                }
            }
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.NFe.v310.NotaFiscal.TNFeInfNFeTranspVol[] volumes, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (volumes != null)
            {
                Repositorio.InformacaoCargaCTE repInformacaoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);
                Dominio.Entidades.InformacaoCargaCTE informacaoCarga = new Dominio.Entidades.InformacaoCargaCTE();
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                decimal peso = 0;
                decimal quantidade = 0;

                foreach (MultiSoftware.NFe.v310.NotaFiscal.TNFeInfNFeTranspVol vol in volumes)
                {
                    peso += vol.pesoB != null ? decimal.Parse(vol.pesoB, cultura) : vol.pesoL != null ? decimal.Parse(vol.pesoL, cultura) : 0;
                    quantidade += vol.qVol != null ? decimal.Parse(vol.qVol, cultura) : 0;
                }

                informacaoCarga.CTE = conhecimento;
                informacaoCarga.Quantidade = peso;
                informacaoCarga.Tipo = "Kilograma";
                informacaoCarga.UnidadeMedida = string.Format("{0:00}", (int)Dominio.Enumeradores.UnidadeMedida.KG);

                repInformacaoCarga.Inserir(informacaoCarga);

                if (quantidade > 0)
                {
                    Dominio.Entidades.InformacaoCargaCTE informacaoCargaQtd = new Dominio.Entidades.InformacaoCargaCTE();
                    informacaoCargaQtd.CTE = conhecimento;
                    informacaoCargaQtd.Quantidade = quantidade;
                    informacaoCargaQtd.Tipo = "Unidade";
                    informacaoCargaQtd.UnidadeMedida = string.Format("{0:00}", (int)Dominio.Enumeradores.UnidadeMedida.UN);

                    repInformacaoCarga.Inserir(informacaoCargaQtd);
                }
            }
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.NDDigital.v104.Emissao.Registro15110> volumes, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (volumes != null)
            {
                Repositorio.InformacaoCargaCTE repInformacaoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);

                foreach (Dominio.NDDigital.v104.Emissao.Registro15110 volume in volumes)
                {
                    Dominio.Entidades.InformacaoCargaCTE informacaoCarga = new Dominio.Entidades.InformacaoCargaCTE();

                    informacaoCarga.CTE = conhecimento;
                    informacaoCarga.Quantidade = volume.qCarga;
                    informacaoCarga.Tipo = volume.tpMed;
                    informacaoCarga.UnidadeMedida = volume.cUnid;

                    repInformacaoCarga.Inserir(informacaoCarga);
                }
            }
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.CTe.QuantidadeCarga> quantidades, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (quantidades != null)
            {
                Repositorio.InformacaoCargaCTE repInformacaoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);

                foreach (Dominio.ObjetosDeValor.CTe.QuantidadeCarga quantidade in quantidades)
                {
                    Dominio.Entidades.InformacaoCargaCTE informacaoCarga = new Dominio.Entidades.InformacaoCargaCTE();

                    informacaoCarga.CTE = conhecimento;
                    informacaoCarga.Quantidade = Math.Round(quantidade.Quantidade, 4, MidpointRounding.ToEven);
                    informacaoCarga.Tipo = quantidade.Descricao;
                    informacaoCarga.UnidadeMedida = quantidade.UnidadeMedida;

                    repInformacaoCarga.Inserir(informacaoCarga);
                }
            }
        }

        private void SalvarInformacoesDeQuantidadeDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.Embarcador.CTe.QuantidadeCarga> quantidades, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (quantidades != null)
            {
                Repositorio.InformacaoCargaCTE repInformacaoCarga = new Repositorio.InformacaoCargaCTE(unidadeDeTrabalho);

                foreach (Dominio.ObjetosDeValor.Embarcador.CTe.QuantidadeCarga quantidade in quantidades)
                {
                    Dominio.Entidades.InformacaoCargaCTE informacaoCarga = new Dominio.Entidades.InformacaoCargaCTE();

                    informacaoCarga.CTE = conhecimento;
                    informacaoCarga.Quantidade = quantidade.Quantidade;
                    informacaoCarga.Tipo = quantidade.Medida;
                    informacaoCarga.UnidadeMedida = string.Format("{0:00}", (int)quantidade.Unidade);

                    repInformacaoCarga.Inserir(informacaoCarga);
                }
            }
        }

        private void SalvarInformacoesDeSeguroDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormSeg[] infSeg, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infSeg != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Repositorio.SeguroCTE repSeguro = new Repositorio.SeguroCTE(unidadeTrabalho);
                foreach (MultiSoftware.CTe.v104.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormSeg informacaoSeguro in infSeg)
                {
                    Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();
                    seguro.CTE = conhecimento;
                    seguro.NomeSeguradora = informacaoSeguro.xSeg;
                    seguro.NumeroApolice = informacaoSeguro.nApol;
                    seguro.NumeroAverbacao = informacaoSeguro.nAver;
                    seguro.Tipo = (Dominio.Enumeradores.TipoSeguro)informacaoSeguro.respSeg;
                    seguro.Valor = informacaoSeguro.vCarga != null ? decimal.Parse(informacaoSeguro.vCarga, cultura) : 0m;
                    repSeguro.Inserir(seguro);
                }
            }
        }

        private void SalvarInformacoesDeSeguroDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormSeg[] infSeg, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infSeg != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Repositorio.SeguroCTE repSeguro = new Repositorio.SeguroCTE(unidadeTrabalho);
                foreach (MultiSoftware.CTe.v200.ConhecimentoDeTransporte.TCTeInfCteInfCTeNormSeg informacaoSeguro in infSeg)
                {
                    Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();
                    seguro.CTE = conhecimento;
                    seguro.NomeSeguradora = informacaoSeguro.xSeg;
                    seguro.NumeroApolice = informacaoSeguro.nApol;
                    seguro.NumeroAverbacao = informacaoSeguro.nAver;
                    seguro.Tipo = (Dominio.Enumeradores.TipoSeguro)informacaoSeguro.respSeg;
                    seguro.Valor = informacaoSeguro.vCarga != null ? decimal.Parse(informacaoSeguro.vCarga, cultura) : 0m;
                    repSeguro.Inserir(seguro);
                }
            }
        }

        private void SalvarInformacoesDeSeguroDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNormSeg[] infSeg, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (infSeg != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Repositorio.SeguroCTE repSeguro = new Repositorio.SeguroCTE(unidadeTrabalho);
                foreach (MultiSoftware.CTe.v200.Envio.TCTeInfCteInfCTeNormSeg informacaoSeguro in infSeg)
                {
                    Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();
                    seguro.CTE = conhecimento;
                    seguro.NomeSeguradora = informacaoSeguro.xSeg;
                    seguro.NumeroApolice = informacaoSeguro.nApol;
                    seguro.NumeroAverbacao = informacaoSeguro.nAver;
                    seguro.Tipo = (Dominio.Enumeradores.TipoSeguro)informacaoSeguro.respSeg;
                    seguro.Valor = informacaoSeguro.vCarga != null ? decimal.Parse(informacaoSeguro.vCarga, cultura) : 0m;
                    repSeguro.Inserir(seguro);
                }
            }
        }

        private void SalvarInformacoesDeSeguroDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, Dominio.Enumeradores.TipoSeguro? tipoSeguro, Repositorio.UnitOfWork unidadeDeTrabalho, Dominio.Entidades.ApoliceDeSeguro apoliceSeguro = null)
        {
            Repositorio.SeguroCTE repSeguro = new Repositorio.SeguroCTE(unidadeDeTrabalho);
            Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();

            seguro.CTE = conhecimento;
            seguro.Tipo = tipoSeguro != null ?
                          tipoSeguro == Dominio.Enumeradores.TipoSeguro.Destinatario ? Dominio.Enumeradores.TipoSeguro.Destinatario :
                          tipoSeguro == Dominio.Enumeradores.TipoSeguro.Emitente_CTE ? Dominio.Enumeradores.TipoSeguro.Emitente_CTE :
                          tipoSeguro == Dominio.Enumeradores.TipoSeguro.Expedidor ? Dominio.Enumeradores.TipoSeguro.Expedidor :
                          tipoSeguro == Dominio.Enumeradores.TipoSeguro.Recebedor ? Dominio.Enumeradores.TipoSeguro.Recebedor :
                          tipoSeguro == Dominio.Enumeradores.TipoSeguro.Remetente ? Dominio.Enumeradores.TipoSeguro.Remetente :
                          tipoSeguro == Dominio.Enumeradores.TipoSeguro.Tomador_Servico ? Dominio.Enumeradores.TipoSeguro.Tomador_Servico : Dominio.Enumeradores.TipoSeguro.Remetente
                          : Dominio.Enumeradores.TipoSeguro.Remetente;
            seguro.NumeroApolice = apoliceSeguro != null ? apoliceSeguro.NumeroApolice : string.Empty;
            seguro.NomeSeguradora = apoliceSeguro != null ? apoliceSeguro.NomeSeguradora : string.Empty;
            seguro.CNPJSeguradora = apoliceSeguro != null ? apoliceSeguro.CNPJSeguradora : string.Empty;

            repSeguro.Inserir(seguro);
        }

        private void SalvarInformacoesDeSeguroDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.NDDigital.v104.Emissao.Registro15400> seguros, Repositorio.UnitOfWork unidadeTrabalho)
        {
            if (seguros != null && seguros.Count() > 0)
            {
                Repositorio.SeguroCTE repSeguro = new Repositorio.SeguroCTE(unidadeTrabalho);
                foreach (Dominio.NDDigital.v104.Emissao.Registro15400 informacaoSeguro in seguros)
                {
                    Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();

                    seguro.CTE = conhecimento;
                    seguro.NomeSeguradora = informacaoSeguro.xSeg;
                    seguro.NumeroApolice = informacaoSeguro.nApol;
                    seguro.NumeroAverbacao = informacaoSeguro.nAver;
                    seguro.Tipo = (Dominio.Enumeradores.TipoSeguro)informacaoSeguro.respSeg;
                    seguro.Valor = informacaoSeguro.vCarga;

                    repSeguro.Inserir(seguro);
                }
            }
        }

        private void SalvarInformacoesDeSeguroDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.CTe.Seguro> seguros, Repositorio.UnitOfWork unidadeTrabalho)
        {
            Repositorio.SeguroCTE repSeguro = new Repositorio.SeguroCTE(unidadeTrabalho);

            bool inseriuSeguro = false;

            if (seguros != null)
            {
                foreach (Dominio.ObjetosDeValor.CTe.Seguro informacaoSeguro in seguros)
                {
                    inseriuSeguro = true;

                    Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();
                    seguro.CTE = conhecimento;
                    seguro.NomeSeguradora = Utilidades.String.Left(informacaoSeguro.NomeSeguradora, 30);
                    seguro.NumeroApolice = informacaoSeguro.NumeroApolice;
                    seguro.NumeroAverbacao = informacaoSeguro.NumeroAverbacao;
                    seguro.Tipo = informacaoSeguro.Tipo;
                    seguro.Valor = informacaoSeguro.Valor;
                    seguro.CNPJSeguradora = informacaoSeguro.CNPJSeguradora; //Utilizado no MDFe 3.0

                    repSeguro.Inserir(seguro);
                }
            }

            bool configProcessarCTeMultiCTe = Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeTrabalho).ObterConfiguracaoAmbiente().ProcessarCTeMultiCTe.HasValue ? Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeTrabalho).ObterConfiguracaoAmbiente().ProcessarCTeMultiCTe.Value : false;

            if (inseriuSeguro || configProcessarCTeMultiCTe)
                return;

            string tomador = conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Remetente ? conhecimento.Remetente.CPF_CNPJ : conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Destinatario ? conhecimento.Destinatario.CPF_CNPJ : "0";
            double cnpjTomador = 0;
            double.TryParse(tomador, out cnpjTomador);

            Repositorio.ApoliceDeSeguro repApoliceSeguro = new Repositorio.ApoliceDeSeguro(unidadeTrabalho);
            List<Dominio.Entidades.ApoliceDeSeguro> listaApolices = repApoliceSeguro.BuscarPorCliente(conhecimento.Empresa.Codigo, conhecimento.Empresa.EmpresaPai != null ? conhecimento.Empresa.Codigo : 0, cnpjTomador);
            if (listaApolices.Count > 0)
            {
                Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();
                seguro.CTE = conhecimento;
                seguro.NumeroApolice = listaApolices[0].NumeroApolice;
                seguro.NomeSeguradora = Utilidades.String.Left(listaApolices[0].NomeSeguradora, 30);
                seguro.CNPJSeguradora = listaApolices[0].CNPJSeguradora;

                if (listaApolices[0].Responsavel >= 0)
                    seguro.Tipo = (Dominio.Enumeradores.TipoSeguro)listaApolices[0].Responsavel;
                else
                    seguro.Tipo = conhecimento.Empresa.Configuracao.ResponsavelSeguro != null ?
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Destinatario ? Dominio.Enumeradores.TipoSeguro.Destinatario :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Emitente_CTE ? Dominio.Enumeradores.TipoSeguro.Emitente_CTE :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Expedidor ? Dominio.Enumeradores.TipoSeguro.Expedidor :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Recebedor ? Dominio.Enumeradores.TipoSeguro.Recebedor :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Remetente ? Dominio.Enumeradores.TipoSeguro.Remetente :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Tomador_Servico ? Dominio.Enumeradores.TipoSeguro.Tomador_Servico : Dominio.Enumeradores.TipoSeguro.Remetente
                                  : Dominio.Enumeradores.TipoSeguro.Remetente;

                repSeguro.Inserir(seguro);
                inseriuSeguro = true;
            }
            else if (conhecimento.Empresa?.Configuracao?.ApoliceSeguro != null)
            {
                if (conhecimento.Empresa.Configuracao.ApoliceSeguro.Cliente == null)
                {
                    inseriuSeguro = true;

                    Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();
                    seguro.CTE = conhecimento;
                    seguro.NomeSeguradora = Utilidades.String.Left(conhecimento.Empresa.Configuracao.ApoliceSeguro.NomeSeguradora, 30);
                    seguro.NumeroApolice = conhecimento.Empresa.Configuracao.ApoliceSeguro.NumeroApolice;
                    seguro.CNPJSeguradora = conhecimento.Empresa.Configuracao.ApoliceSeguro.CNPJSeguradora; //Utilizado no MDFe 3.0
                    seguro.NumeroAverbacao = string.Empty;
                    seguro.Tipo = Dominio.Enumeradores.TipoSeguro.Emitente_CTE;
                    seguro.Valor = conhecimento.ValorTotalMercadoria;

                    repSeguro.Inserir(seguro);
                }
                else if ((conhecimento.TipoPagamento == Dominio.Enumeradores.TipoPagamento.Pago && conhecimento.Empresa.Configuracao.ApoliceSeguro.Cliente.CPF_CNPJ_SemFormato == conhecimento.Remetente.CPF_CNPJ) || (conhecimento.TipoPagamento == Dominio.Enumeradores.TipoPagamento.A_Pagar && conhecimento.Empresa.Configuracao.ApoliceSeguro.Cliente.CPF_CNPJ_SemFormato == conhecimento.Destinatario.CPF_CNPJ))
                {
                    inseriuSeguro = true;

                    Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();
                    seguro.CTE = conhecimento;
                    seguro.NomeSeguradora = Utilidades.String.Left(conhecimento.Empresa.Configuracao.ApoliceSeguro.NomeSeguradora, 30);
                    seguro.NumeroApolice = conhecimento.Empresa.Configuracao.ApoliceSeguro.NumeroApolice;
                    seguro.CNPJSeguradora = conhecimento.Empresa.Configuracao.ApoliceSeguro.CNPJSeguradora; //Utilizado no MDFe 3.0
                    seguro.NumeroAverbacao = string.Empty;

                    if (conhecimento.TipoPagamento == Dominio.Enumeradores.TipoPagamento.Pago && conhecimento.Empresa.Configuracao.ApoliceSeguro.Cliente.CPF_CNPJ_SemFormato == conhecimento.Remetente.CPF_CNPJ)
                        seguro.Tipo = Dominio.Enumeradores.TipoSeguro.Remetente;
                    else
                        seguro.Tipo = Dominio.Enumeradores.TipoSeguro.Destinatario;

                    seguro.Valor = conhecimento.ValorTotalMercadoria;

                    repSeguro.Inserir(seguro);
                }
            }

            if (inseriuSeguro)
                return;

            if (conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.ResponsavelSeguro != null)
            {
                inseriuSeguro = true;
                Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();
                seguro.CTE = conhecimento;
                seguro.NomeSeguradora = "";
                seguro.NumeroApolice = "";
                seguro.NumeroAverbacao = "";
                seguro.Tipo = conhecimento.Empresa.Configuracao.ResponsavelSeguro != null ?
                              conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Destinatario ? Dominio.Enumeradores.TipoSeguro.Destinatario :
                              conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Emitente_CTE ? Dominio.Enumeradores.TipoSeguro.Emitente_CTE :
                              conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Expedidor ? Dominio.Enumeradores.TipoSeguro.Expedidor :
                              conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Recebedor ? Dominio.Enumeradores.TipoSeguro.Recebedor :
                              conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Remetente ? Dominio.Enumeradores.TipoSeguro.Remetente :
                              conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Tomador_Servico ? Dominio.Enumeradores.TipoSeguro.Tomador_Servico : Dominio.Enumeradores.TipoSeguro.Remetente
                              : Dominio.Enumeradores.TipoSeguro.Remetente;
                seguro.Valor = 0;
                seguro.CNPJSeguradora = "";

                repSeguro.Inserir(seguro);
            }
        }

        private void SalvarInformacoesDeSeguroDaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.Embarcador.CTe.Seguro> seguros, Repositorio.UnitOfWork unidadeTrabalho)
        {
            Repositorio.SeguroCTE repSeguro = new Repositorio.SeguroCTE(unidadeTrabalho);

            bool inseriuSeguro = false;

            string tomador = conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Remetente ? conhecimento.Remetente.CPF_CNPJ : conhecimento.TipoTomador == Dominio.Enumeradores.TipoTomador.Destinatario ? conhecimento.Destinatario.CPF_CNPJ : "0";
            double cnpjTomador = 0;
            double.TryParse(tomador, out cnpjTomador);

            Repositorio.ApoliceDeSeguro repApoliceSeguro = new Repositorio.ApoliceDeSeguro(unidadeTrabalho);
            List<Dominio.Entidades.ApoliceDeSeguro> listaApolices = repApoliceSeguro.BuscarPorCliente(conhecimento.Empresa.Codigo, conhecimento.Empresa.EmpresaPai != null ? conhecimento.Empresa.Codigo : 0, cnpjTomador);
            if (listaApolices.Count > 0)
            {
                Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();
                seguro.CTE = conhecimento;
                seguro.NumeroApolice = listaApolices[0].NumeroApolice;
                seguro.NomeSeguradora = Utilidades.String.Left(listaApolices[0].NomeSeguradora, 30);
                seguro.CNPJSeguradora = listaApolices[0].CNPJSeguradora;

                if (listaApolices[0].Responsavel >= 0)
                    seguro.Tipo = (Dominio.Enumeradores.TipoSeguro)listaApolices[0].Responsavel;
                else
                    seguro.Tipo = conhecimento.Empresa.Configuracao.ResponsavelSeguro != null ?
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Destinatario ? Dominio.Enumeradores.TipoSeguro.Destinatario :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Emitente_CTE ? Dominio.Enumeradores.TipoSeguro.Emitente_CTE :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Expedidor ? Dominio.Enumeradores.TipoSeguro.Expedidor :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Recebedor ? Dominio.Enumeradores.TipoSeguro.Recebedor :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Remetente ? Dominio.Enumeradores.TipoSeguro.Remetente :
                                  conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Tomador_Servico ? Dominio.Enumeradores.TipoSeguro.Tomador_Servico : Dominio.Enumeradores.TipoSeguro.Remetente
                                  : Dominio.Enumeradores.TipoSeguro.Remetente;

                repSeguro.Inserir(seguro);
                inseriuSeguro = true;
            }
            else if (conhecimento.Empresa.Configuracao.ApoliceSeguro != null)
            {
                if (conhecimento.Empresa.Configuracao.ApoliceSeguro.Cliente == null)
                {
                    inseriuSeguro = true;

                    Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();
                    seguro.CTE = conhecimento;
                    seguro.NomeSeguradora = Utilidades.String.Left(conhecimento.Empresa.Configuracao.ApoliceSeguro.NomeSeguradora, 30);
                    seguro.NumeroApolice = conhecimento.Empresa.Configuracao.ApoliceSeguro.NumeroApolice;
                    seguro.CNPJSeguradora = conhecimento.Empresa.Configuracao.ApoliceSeguro.CNPJSeguradora; //Utilizado no MDFe 3.0
                    seguro.NumeroAverbacao = string.Empty;
                    seguro.Tipo = Dominio.Enumeradores.TipoSeguro.Emitente_CTE;
                    seguro.Valor = conhecimento.ValorTotalMercadoria;

                    repSeguro.Inserir(seguro);
                }
                else if ((conhecimento.TipoPagamento == Dominio.Enumeradores.TipoPagamento.Pago && conhecimento.Empresa.Configuracao.ApoliceSeguro.Cliente.CPF_CNPJ_SemFormato == conhecimento.Remetente.CPF_CNPJ) || (conhecimento.TipoPagamento == Dominio.Enumeradores.TipoPagamento.A_Pagar && conhecimento.Empresa.Configuracao.ApoliceSeguro.Cliente.CPF_CNPJ_SemFormato == conhecimento.Destinatario.CPF_CNPJ))
                {
                    inseriuSeguro = true;

                    Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();
                    seguro.CTE = conhecimento;
                    seguro.NomeSeguradora = Utilidades.String.Left(conhecimento.Empresa.Configuracao.ApoliceSeguro.NomeSeguradora, 30);
                    seguro.NumeroApolice = conhecimento.Empresa.Configuracao.ApoliceSeguro.NumeroApolice;
                    seguro.CNPJSeguradora = conhecimento.Empresa.Configuracao.ApoliceSeguro.CNPJSeguradora; //Utilizado no MDFe 3.0
                    seguro.NumeroAverbacao = string.Empty;

                    if (conhecimento.TipoPagamento == Dominio.Enumeradores.TipoPagamento.Pago && conhecimento.Empresa.Configuracao.ApoliceSeguro.Cliente.CPF_CNPJ_SemFormato == conhecimento.Remetente.CPF_CNPJ)
                        seguro.Tipo = Dominio.Enumeradores.TipoSeguro.Remetente;
                    else
                        seguro.Tipo = Dominio.Enumeradores.TipoSeguro.Destinatario;

                    seguro.Valor = conhecimento.ValorTotalMercadoria;

                    repSeguro.Inserir(seguro);
                }
            }

            if (!inseriuSeguro && seguros != null)
            {
                foreach (Dominio.ObjetosDeValor.Embarcador.CTe.Seguro informacaoSeguro in seguros)
                {
                    inseriuSeguro = true;
                    Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();
                    seguro.CTE = conhecimento;
                    seguro.NomeSeguradora = Utilidades.String.Left(informacaoSeguro.Seguradora, 30);
                    seguro.NumeroApolice = informacaoSeguro.Apolice;
                    seguro.NumeroAverbacao = informacaoSeguro.Averbacao;
                    seguro.Tipo = informacaoSeguro.ResponsavelSeguro;
                    seguro.Valor = informacaoSeguro.Valor;
                    //seguro.CNPJSeguradora = informacaoSeguro.CNPJSeguradora; //Utilizado no MDFe 3.0

                    repSeguro.Inserir(seguro);
                }
            }

            if (!inseriuSeguro && conhecimento.Empresa.Configuracao != null && conhecimento.Empresa.Configuracao.ResponsavelSeguro != null)
            {
                inseriuSeguro = true;
                Dominio.Entidades.SeguroCTE seguro = new Dominio.Entidades.SeguroCTE();
                seguro.CTE = conhecimento;
                seguro.NomeSeguradora = "";
                seguro.NumeroApolice = "";
                seguro.NumeroAverbacao = "";
                seguro.Tipo = conhecimento.Empresa.Configuracao.ResponsavelSeguro != null ?
                              conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Destinatario ? Dominio.Enumeradores.TipoSeguro.Destinatario :
                              conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Emitente_CTE ? Dominio.Enumeradores.TipoSeguro.Emitente_CTE :
                              conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Expedidor ? Dominio.Enumeradores.TipoSeguro.Expedidor :
                              conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Recebedor ? Dominio.Enumeradores.TipoSeguro.Recebedor :
                              conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Remetente ? Dominio.Enumeradores.TipoSeguro.Remetente :
                              conhecimento.Empresa.Configuracao.ResponsavelSeguro == Dominio.Enumeradores.TipoSeguro.Tomador_Servico ? Dominio.Enumeradores.TipoSeguro.Tomador_Servico : Dominio.Enumeradores.TipoSeguro.Remetente
                              : Dominio.Enumeradores.TipoSeguro.Remetente;
                seguro.Valor = 0;
                seguro.CNPJSeguradora = "";

                repSeguro.Inserir(seguro);
            }
        }

        private void SalvarInformacoesNFes(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.NFe.NotaFiscalProcessada.TNfeProc nfe, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (nfe != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModelo = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);
                Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();

                documento.ChaveNFE = nfe.protNFe.infProt.chNFe;
                documento.DataEmissao = nfe.protNFe.infProt.dhRecbto;
                documento.Valor = decimal.Parse(nfe.NFe.infNFe.total.ICMSTot.vNF, cultura);
                documento.ModeloDocumentoFiscal = repModelo.BuscarPorModelo(nfe.NFe.infNFe.ide.mod.ToString("D"));
                documento.Numero = nfe.NFe.infNFe.ide.nNF;
                documento.CTE = conhecimento;
                if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                    documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);


                repDocumento.Inserir(documento);
            }
        }

        private void SalvarInformacoesNFes(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.NFe.v310.NotaFiscalProcessada.TNfeProc nfe, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (nfe != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModelo = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

                Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();

                DateTime dataEmissao;

                if (!DateTime.TryParseExact(nfe.protNFe.infProt.dhRecbto.Substring(0, 19), "yyyy-MM-ddTHH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataEmissao))
                    dataEmissao = DateTime.Now;

                documento.ChaveNFE = nfe.protNFe.infProt.chNFe;
                documento.DataEmissao = dataEmissao;
                documento.Valor = decimal.Parse(nfe.NFe.infNFe.total.ICMSTot.vNF, cultura);
                documento.ModeloDocumentoFiscal = repModelo.BuscarPorModelo(nfe.NFe.infNFe.ide.mod.ToString("D"));
                documento.Numero = nfe.NFe.infNFe.ide.nNF;
                documento.CTE = conhecimento;
                if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                    documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                repDocumento.Inserir(documento);
            }
        }

        private void SalvarInformacoesNFes(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, MultiSoftware.NFe.v400.NotaFiscalProcessada.TNfeProc nfe, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (nfe != null)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModelo = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

                Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();

                DateTime dataEmissao;

                if (!DateTime.TryParseExact(nfe.protNFe.infProt.dhRecbto.Substring(0, 19), "yyyy-MM-ddTHH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataEmissao))
                    dataEmissao = DateTime.Now;

                documento.ChaveNFE = nfe.protNFe.infProt.chNFe;
                documento.DataEmissao = dataEmissao;
                documento.Valor = decimal.Parse(nfe.NFe.infNFe.total.ICMSTot.vNF, cultura);
                documento.ModeloDocumentoFiscal = repModelo.BuscarPorModelo(nfe.NFe.infNFe.ide.mod.ToString("D"));
                documento.Numero = nfe.NFe.infNFe.ide.nNF;
                documento.CTE = conhecimento;
                if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                    documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                repDocumento.Inserir(documento);
            }
        }

        private void SalvarInformacoesNFes(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.NDDigital.v104.Emissao.Registro12130> nfes, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (nfes != null && nfes.Count() > 0)
            {
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModelo = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

                foreach (Dominio.NDDigital.v104.Emissao.Registro12130 nfe in nfes)
                {
                    DateTime data = DateTime.ParseExact(nfe.chave.Substring(2, 4), "yyMM", null);

                    Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();

                    documento.ChaveNFE = nfe.chave;
                    documento.DataEmissao = new DateTime(data.Year, data.Month, DateTime.Now.Day);
                    documento.ModeloDocumentoFiscal = repModelo.BuscarPorModelo("55");
                    documento.Numero = nfe.chave.Substring(25, 9);
                    documento.CTE = conhecimento;
                    if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                        documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                    repDocumento.Inserir(documento);
                }
            }
        }

        private void SalvarInformacoesNFes(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.NFeAdmin> notasFiscais, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            foreach (Dominio.ObjetosDeValor.NFeAdmin notaFiscal in notasFiscais)
            {
                System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModelo = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);
                Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();

                if (notaFiscal.NFe2 != null)
                {
                    documento.ChaveNFE = notaFiscal.NFe2.protNFe.infProt.chNFe;
                    documento.DataEmissao = notaFiscal.NFe2.protNFe.infProt.dhRecbto;
                    documento.Valor = decimal.Parse(notaFiscal.NFe2.NFe.infNFe.total.ICMSTot.vNF, cultura);
                    documento.ModeloDocumentoFiscal = repModelo.BuscarPorModelo(notaFiscal.NFe2.NFe.infNFe.ide.mod.ToString("D"));
                    documento.Numero = notaFiscal.NFe2.NFe.infNFe.ide.nNF;
                }
                else if (notaFiscal.NFe3 != null)
                {
                    documento.ChaveNFE = notaFiscal.NFe3.protNFe.infProt.chNFe;
                    documento.DataEmissao = DateTime.ParseExact(notaFiscal.NFe3.protNFe.infProt.dhRecbto.Split('T')[0], "yyyy-MM-dd", null);
                    documento.Valor = decimal.Parse(notaFiscal.NFe3.NFe.infNFe.total.ICMSTot.vNF, cultura);
                    documento.ModeloDocumentoFiscal = repModelo.BuscarPorModelo(notaFiscal.NFe3.NFe.infNFe.ide.mod.ToString("D"));
                    documento.Numero = notaFiscal.NFe3.NFe.infNFe.ide.nNF;
                }
                else if (notaFiscal.NFe4 != null)
                {
                    documento.ChaveNFE = notaFiscal.NFe4.protNFe.infProt.chNFe;
                    documento.DataEmissao = DateTime.ParseExact(notaFiscal.NFe4.protNFe.infProt.dhRecbto.Split('T')[0], "yyyy-MM-dd", null);
                    documento.Valor = decimal.Parse(notaFiscal.NFe4.NFe.infNFe.total.ICMSTot.vNF, cultura);
                    documento.ModeloDocumentoFiscal = repModelo.BuscarPorModelo(notaFiscal.NFe4.NFe.infNFe.ide.mod.ToString("D"));
                    documento.Numero = notaFiscal.NFe4.NFe.infNFe.ide.nNF;
                }

                if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                    documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                documento.CTE = conhecimento;

                repDocumento.Inserir(documento);
            }
        }

        private void SalvarInformacoesNFs(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.NDDigital.v104.Emissao.Registro12120> nfs, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (nfs != null && nfs.Count() > 0)
            {
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModelo = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

                foreach (Dominio.NDDigital.v104.Emissao.Registro12120 nf in nfs)
                {
                    Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();

                    documento.BaseCalculoICMS = nf.vBC;
                    documento.BaseCalculoICMSST = nf.vBCST;
                    documento.CFOP = string.Format("{0:0000}", nf.nCFOP);
                    documento.CTE = conhecimento;
                    documento.DataEmissao = nf.dEmi;
                    documento.ModeloDocumentoFiscal = repModelo.BuscarPorModelo(string.Format("{0:00}", nf.mod));
                    documento.Numero = nf.nDoc;
                    documento.Peso = nf.nPeso;
                    documento.PINSuframa = nf.PIN > 0 ? nf.PIN.ToString() : string.Empty;
                    documento.Serie = nf.serie;
                    documento.Valor = nf.vNF;
                    documento.ValorICMS = nf.vICMS;
                    documento.ValorICMSST = nf.vST;
                    documento.ValorProdutos = nf.vProd;
                    if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                        documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                    repDocumento.Inserir(documento);
                }
            }
        }

        private void SalvarInformacoesDocumentos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.Embarcador.CTe.NFe> documentos, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (documentos != null)
            {
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModelo = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

                foreach (Dominio.ObjetosDeValor.Embarcador.CTe.NFe doc in documentos)
                {
                    if (!string.IsNullOrWhiteSpace(doc.Chave))
                    {
                        Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();

                        documento.CTE = conhecimento;
                        documento.ChaveNFE = doc.Chave;
                        documento.DataEmissao = DateTime.Now;
                        documento.ModeloDocumentoFiscal = repModelo.BuscarPorModelo("57");
                        documento.Numero = doc.Chave.Substring(25, 9);
                        documento.Serie = doc.Chave.Substring(22, 3);
                        if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                            documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                        repDocumento.Inserir(documento);
                    }
                }
            }
        }

        private void SalvarInformacoesDocumentos(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.CTe.Documento> documentos, Repositorio.UnitOfWork unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            if (documentos != null)
            {
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModelo = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

                conhecimento.XMLNotaFiscais = new List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal>();

                Dominio.Entidades.ModeloDocumentoFiscal modeloDocumento = null;

                bool sumarizarValorNotas = (conhecimento.ValorTotalMercadoria == 0);

                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> ListaXMLNotaFiscal = repXMLNotaFiscalEletronica.BuscaPorChaves(documentos.Where(x => !string.IsNullOrWhiteSpace(x.ChaveNFE)).Select(x => x.ChaveNFE).ToList());


                foreach (Dominio.ObjetosDeValor.CTe.Documento doc in documentos)
                {
                    if (modeloDocumento == null || modeloDocumento.Numero != doc.ModeloDocumentoFiscal)
                        modeloDocumento = repModelo.BuscarPorModelo(doc.ModeloDocumentoFiscal);

                    repDocumento.Inserir(this.SalvarInformacaoDocumento(conhecimento, modeloDocumento, doc, unidadeDeTrabalho, ListaXMLNotaFiscal));

                    if (sumarizarValorNotas)
                        conhecimento.ValorTotalMercadoria = doc.Valor;

                    //if (doc.protocoloNFe > 0)
                    //{
                    //    Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xmlNotaFiscal = repXMLNotaFiscal.BuscarPorCodigo(doc.protocoloNFe);
                    //    if (xmlNotaFiscal != null)
                    //        conhecimento.XMLNotaFiscais.Add(xmlNotaFiscal);
                    //    else
                    //    {
                    //        Servicos.Log.TratarErro("protocolo " + doc.protocoloNFe);
                    //        Servicos.Log.TratarErro("CT-e " + conhecimento.Codigo);
                    //    }
                    //}
                }
            }
        }

        private Dominio.Entidades.DocumentosCTE SalvarInformacaoDocumento(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, Dominio.Entidades.ModeloDocumentoFiscal modeloDocumento, Dominio.ObjetosDeValor.CTe.Documento doc, Repositorio.UnitOfWork unidadeDeTrabalho, List<Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal> ListaXMLNotaFiscal = null)
        {
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
            Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();

            documento.BaseCalculoICMS = doc.BaseCalculoICMS;
            documento.BaseCalculoICMSST = doc.BaseCalculoICMSST;
            documento.CFOP = doc.CFOP;
            documento.ChaveNFE = doc.ChaveNFE;
            documento.ProtocoloNFe = doc.ProtocoloAutorizacao;
            documento.NumeroRomaneio = doc.NumeroRomaneio;
            documento.NumeroPedido = doc.NumeroPedido;
            documento.CTE = conhecimento;

            DateTime dataEmissao;
            if (!DateTime.TryParseExact(doc.DataEmissao, "dd/MM/yyyy HH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataEmissao))
                dataEmissao = DateTime.Now;

            documento.DataEmissao = dataEmissao;
            documento.Descricao = doc.Descricao;
            documento.ItemPrincipal = doc.ItemPrincipal;
            documento.ModeloDocumentoFiscal = modeloDocumento;
            documento.Numero = doc.Numero != null ? doc.Numero : doc.ChaveNFE.Substring(25, 9);
            documento.Peso = doc.Peso;
            documento.PINSuframa = doc.PINSuframa;
            documento.NCMPredominante = doc.NCMPredominante;
            documento.Serie = doc.Serie;
            documento.Valor = doc.Valor;
            documento.ValorICMS = doc.ValorICMS;
            documento.ValorICMSST = doc.ValorICMSST;
            documento.ValorProdutos = doc.ValorProdutos;
            documento.Volume = doc.Volume;
            documento.NumeroReferenciaEDI = doc.NumeroReferenciaEDI;
            documento.NumeroControleCliente = doc.NumeroControleCliente;

            if (ListaXMLNotaFiscal != null)
            {
                if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                    documento.XMLNotaFiscal = ListaXMLNotaFiscal.Where(x => x.Chave == documento.ChaveNFE).FirstOrDefault();
            }
            else
            {
                if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                    documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);
            }


            return documento;
        }

        private void SalvarInformacoesOutrosDocumentos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.NDDigital.v104.Emissao.Registro12140> outros, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (outros != null && outros.Count() > 0)
            {
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscalEletronica = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.ModeloDocumentoFiscal repModelo = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

                foreach (Dominio.NDDigital.v104.Emissao.Registro12140 outro in outros)
                {
                    Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE();

                    documento.DataEmissao = outro.dEmi;
                    documento.Descricao = outro.descOutros;
                    documento.ModeloDocumentoFiscal = repModelo.BuscarPorModelo(string.Format("{0:00}", outro.tpDoc));
                    documento.Numero = outro.nDoc;
                    documento.Valor = outro.vDocFisc;
                    if (!string.IsNullOrWhiteSpace(documento.ChaveNFE))
                        documento.XMLNotaFiscal = repXMLNotaFiscalEletronica.BuscarPorChave(documento.ChaveNFE);

                    repDocumento.Inserir(documento);
                }
            }
        }

        private void SalvarInformacoesDocumentosAnteriores(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior> documentosAnteriores, Repositorio.UnitOfWork unidadeDeTrabalho, bool ativarTransacao)
        {
            if (documentosAnteriores != null)
            {
                Repositorio.DocumentoDeTransporteAnteriorCTe repDocumento = new Repositorio.DocumentoDeTransporteAnteriorCTe(unidadeDeTrabalho);
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);

                if (ativarTransacao && conhecimento.TipoServico == Dominio.Enumeradores.TipoServico.ServVinculadoMultimodal && conhecimento.TipoModal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Aquaviario)
                    return;//para cargas SVM's os documentos serão gerados depois em outra transação
                else
                {
                    List<Dominio.Entidades.Cliente> emissores = new List<Dominio.Entidades.Cliente>();

                    foreach (Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior doc in documentosAnteriores)
                    {
                        Dominio.Entidades.DocumentoDeTransporteAnteriorCTe documento = new Dominio.Entidades.DocumentoDeTransporteAnteriorCTe();

                        documento.Chave = doc.Chave;
                        documento.CTe = conhecimento;

                        DateTime dataEmissao;
                        DateTime.TryParseExact(doc.DataEmissao, "dd/MM/yyyy HH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataEmissao);

                        if (dataEmissao != DateTime.MinValue)
                            documento.DataEmissao = dataEmissao;

                        documento.Emissor = emissores.Where(o => o.CPF_CNPJ == (doc.Emissor?.CPFCNPJ?.ToDouble(0D) ?? 0D)).FirstOrDefault() ?? this.ObterCliente(conhecimento.Empresa, doc.Emissor, unidadeDeTrabalho, true);

                        if (!emissores.Any(o => o.CPF_CNPJ == documento.Emissor.CPF_CNPJ))
                            emissores.Add(documento.Emissor);

                        documento.Numero = doc.Numero;
                        documento.Serie = doc.Serie;
                        documento.Tipo = doc.Tipo;

                        repDocumento.Inserir(documento);
                    }
                }
            }
        }

        private void SalvarInformacoesDocumentosAnterioresPapel(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.Embarcador.CTe.DocumentoAnteriorPapel> documentoAnteriorPapel, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (documentoAnteriorPapel != null)
            {
                Repositorio.DocumentoDeTransporteAnteriorCTe repDocumento = new Repositorio.DocumentoDeTransporteAnteriorCTe(unidadeDeTrabalho);
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);

                foreach (Dominio.ObjetosDeValor.Embarcador.CTe.DocumentoAnteriorPapel doc in documentoAnteriorPapel)
                {
                    Dominio.Entidades.DocumentoDeTransporteAnteriorCTe documento = new Dominio.Entidades.DocumentoDeTransporteAnteriorCTe();
                    documento.CTe = conhecimento;
                    documento.Emissor = repCliente.BuscarPorCPFCNPJ(double.Parse(Utilidades.String.OnlyNumbers(doc.Emitente.CPFCNPJ)));
                    documento.DataEmissao = doc.DataEmissao;
                    documento.Numero = doc.Numero;
                    documento.Serie = doc.Serie;
                    documento.Tipo = doc.TipoDocumentoTransportaAnteriorPapel;

                    repDocumento.Inserir(documento);
                }
            }
        }

        private void SalvarInformacoesEntregas(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.CTe.Entrega> entregas, string descricaoComponentePadrao, string descricaoComponenteImposto, Repositorio.UnitOfWork unidadeDeTrabalho, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware? tipoServicoMultisoftware)
        {
            Repositorio.EntregaCTe repEntregaCTe = new Repositorio.EntregaCTe(unidadeDeTrabalho);
            Repositorio.EntregaCTeComponentePrestacao repEntregaCTeComponentePrestacao = new Repositorio.EntregaCTeComponentePrestacao(unidadeDeTrabalho);
            Repositorio.EntregaCTeDocumento repEntregaCTeDocumento = new Repositorio.EntregaCTeDocumento(unidadeDeTrabalho);
            Repositorio.EntregaCTeDocumentoTransporteAnterior repEntregaCTeDocumentoTransporteAnterior = new Repositorio.EntregaCTeDocumentoTransporteAnterior(unidadeDeTrabalho);
            Repositorio.Localidade repLocalidade = new Repositorio.Localidade(unidadeDeTrabalho);
            Repositorio.Embarcador.Frete.ComponenteFrete repositorioComponenteFrete = new Repositorio.Embarcador.Frete.ComponenteFrete(unidadeDeTrabalho);
            Repositorio.DocumentosCTE repDocumento = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
            Repositorio.DocumentoDeTransporteAnteriorCTe repDocumentoAnterior = new Repositorio.DocumentoDeTransporteAnteriorCTe(unidadeDeTrabalho);
            Repositorio.ModeloDocumentoFiscal repModelo = new Repositorio.ModeloDocumentoFiscal(unidadeDeTrabalho);

            bool sumarizarValorNotas = (conhecimento.ValorTotalMercadoria == 0);

            foreach (Dominio.ObjetosDeValor.CTe.Entrega entrega in entregas)
            {
                Dominio.Entidades.EntregaCTe entregaCTe = new Dominio.Entidades.EntregaCTe();

                entregaCTe.CTE = conhecimento;
                entregaCTe.Origem = repLocalidade.BuscarPorCodigo(entrega.codigoLocalidadeOrigem);
                entregaCTe.Destino = repLocalidade.BuscarPorCodigo(entrega.codigoLocalidadeDestino);
                entregaCTe.ValorFrete = entrega.ValorFrete;
                entregaCTe.ValorPrestacaoServico = entrega.ValorPrestacaoServico;
                entregaCTe.ValorAReceber = entrega.ValorAReceber;

                repEntregaCTe.Inserir(entregaCTe);

                #region Componentes Prestação Serviço

                decimal somaComponentes = 0;

                if ((entrega.ComponentesPrestacao?.Count() ?? 0) > 0)
                {
                    foreach (Dominio.ObjetosDeValor.CTe.EntregaComponentePrestacao componentesPrestacao in entrega.ComponentesPrestacao)
                    {
                        Dominio.Entidades.EntregaCTeComponentePrestacao entregaCTeCompPrest = new Dominio.Entidades.EntregaCTeComponentePrestacao();
                        entregaCTeCompPrest.EntregaCTe = entregaCTe;
                        entregaCTeCompPrest.ComponenteFrete = repositorioComponenteFrete.BuscarPorCodigo(componentesPrestacao.CodigoComponenteFrete);
                        entregaCTeCompPrest.NomeCTe = componentesPrestacao.Descricao;
                        entregaCTeCompPrest.Valor = componentesPrestacao.Valor;
                        entregaCTeCompPrest.IncluiNaBaseDeCalculoDoICMS = componentesPrestacao.IncluiBaseCalculoICMS;
                        entregaCTeCompPrest.IncluiNoTotalAReceber = componentesPrestacao.IncluiValorAReceber;
                        repEntregaCTeComponentePrestacao.Inserir(entregaCTeCompPrest);
                    }
                }

                if (somaComponentes != entrega.ValorFrete)
                {
                    if (string.IsNullOrWhiteSpace(descricaoComponentePadrao))
                        descricaoComponentePadrao = "FRETE VALOR";
                    else
                        descricaoComponentePadrao = Utilidades.String.Left(descricaoComponentePadrao, 15);

                    Dominio.Entidades.EntregaCTeComponentePrestacao entregaCTeCompPrest = new Dominio.Entidades.EntregaCTeComponentePrestacao();
                    entregaCTeCompPrest.EntregaCTe = entregaCTe;
                    entregaCTeCompPrest.ComponenteFrete = null;
                    entregaCTeCompPrest.NomeCTe = Utilidades.String.Left(descricaoComponentePadrao, 15);
                    entregaCTeCompPrest.Valor = entrega.ValorFrete;
                    entregaCTeCompPrest.IncluiNaBaseDeCalculoDoICMS = false;
                    entregaCTeCompPrest.IncluiNoTotalAReceber = true;
                    repEntregaCTeComponentePrestacao.Inserir(entregaCTeCompPrest);
                }

                #endregion Componentes Prestação Serviço

                if ((entrega.Documentos?.Count() ?? 0) > 0)
                {
                    Dominio.Entidades.ModeloDocumentoFiscal modeloDocumento = null;

                    foreach (Dominio.ObjetosDeValor.CTe.Documento doc in entrega.Documentos)
                    {
                        if (modeloDocumento == null || modeloDocumento.Numero != doc.ModeloDocumentoFiscal)
                            modeloDocumento = repModelo.BuscarPorModelo(doc.ModeloDocumentoFiscal);

                        Dominio.Entidades.DocumentosCTE documento = this.SalvarInformacaoDocumento(conhecimento, modeloDocumento, doc, unidadeDeTrabalho);

                        repDocumento.Inserir(documento);

                        Dominio.Entidades.EntregaCTeDocumento entregaCTeDocumento = new Dominio.Entidades.EntregaCTeDocumento();
                        entregaCTeDocumento.EntregaCTe = entregaCTe;
                        entregaCTeDocumento.DocumentosCTE = documento;
                        repEntregaCTeDocumento.Inserir(entregaCTeDocumento);

                        if (sumarizarValorNotas)
                            conhecimento.ValorTotalMercadoria = doc.Valor;
                    }
                }

                if ((entrega.DocumentosTransporteAnteriores?.Count() ?? 0) > 0)
                {
                    List<Dominio.Entidades.Cliente> emissores = new List<Dominio.Entidades.Cliente>();

                    foreach (Dominio.ObjetosDeValor.CTe.DocumentoTransporteAnterior docAnt in entrega.DocumentosTransporteAnteriores)
                    {
                        Dominio.Entidades.DocumentoDeTransporteAnteriorCTe documento = new Dominio.Entidades.DocumentoDeTransporteAnteriorCTe();
                        documento.Chave = docAnt.Chave;
                        documento.CTe = conhecimento;

                        DateTime dataEmissao;
                        DateTime.TryParseExact(docAnt.DataEmissao, "dd/MM/yyyy HH:mm:ss", null, System.Globalization.DateTimeStyles.None, out dataEmissao);
                        if (dataEmissao != DateTime.MinValue)
                            documento.DataEmissao = dataEmissao;

                        documento.Emissor = emissores.Where(o => o.CPF_CNPJ == (docAnt.Emissor?.CPFCNPJ?.ToDouble(0D) ?? 0D)).FirstOrDefault() ?? this.ObterCliente(conhecimento.Empresa, docAnt.Emissor, unidadeDeTrabalho, true);
                        if (!emissores.Any(o => o.CPF_CNPJ == documento.Emissor.CPF_CNPJ))
                            emissores.Add(documento.Emissor);
                        documento.Numero = docAnt.Numero;
                        documento.Serie = docAnt.Serie;
                        documento.Tipo = docAnt.Tipo;
                        repDocumentoAnterior.Inserir(documento);

                        Dominio.Entidades.EntregaCTeDocumentoTransporteAnterior entregaCTeDocumentoTransporteAnterior = new Dominio.Entidades.EntregaCTeDocumentoTransporteAnterior();
                        entregaCTeDocumentoTransporteAnterior.EntregaCTe = entregaCTe;
                        entregaCTeDocumentoTransporteAnterior.DocumentoTransporteAnterior = documento;
                        repEntregaCTeDocumentoTransporteAnterior.Inserir(entregaCTeDocumentoTransporteAnterior);
                    }
                }
            }
        }

        private void SalvarInformacoesProdutosPerigosos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.CTe.ProdutoPerigoso> produtos, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (produtos != null)
            {
                Repositorio.ProdutoPerigosoCTE repProduto = new Repositorio.ProdutoPerigosoCTE(unidadeDeTrabalho);

                foreach (Dominio.ObjetosDeValor.CTe.ProdutoPerigoso prod in produtos)
                {
                    Dominio.Entidades.ProdutoPerigosoCTE produto = new Dominio.Entidades.ProdutoPerigosoCTE();

                    produto.ClasseRisco = prod.ClasseRisco;
                    produto.CTE = conhecimento;
                    produto.Grupo = prod.GrupoEmbalagem;
                    produto.NomeApropriado = prod.NomeApropriado;
                    produto.NumeroONU = prod.NumeroONU;
                    produto.PontoFulgor = prod.PontoFulgor;
                    produto.Quantidade = prod.QuantidadeTotal;
                    produto.Volumes = prod.QuantidadeTipo;

                    repProduto.Inserir(produto);
                }
            }
        }

        private void SalvarInformacoesProdutosPerigosos(Dominio.Entidades.ConhecimentoDeTransporteEletronico conhecimento, List<Dominio.ObjetosDeValor.Embarcador.CTe.ProdutoPerigoso> produtos, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (produtos != null)
            {
                Repositorio.ProdutoPerigosoCTE repProduto = new Repositorio.ProdutoPerigosoCTE(unidadeDeTrabalho);

                foreach (Dominio.ObjetosDeValor.Embarcador.CTe.ProdutoPerigoso prod in produtos)
                {
                    Dominio.Entidades.ProdutoPerigosoCTE produto = new Dominio.Entidades.ProdutoPerigosoCTE();

                    produto.ClasseRisco = prod.ClasseRisco;
                    produto.CTE = conhecimento;
                    produto.Grupo = prod.Grupo;
                    produto.NomeApropriado = prod.NomeApropriado;
                    produto.NumeroONU = prod.NumeroONU;
                    produto.PontoFulgor = prod.PontoFulgor;
                    produto.Quantidade = prod.Quantidade;
                    produto.Volumes = prod.Volumes;

                    repProduto.Inserir(produto);
                }
            }
        }

        private void SalvarInformacoesValePedagio(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, List<Dominio.ObjetosDeValor.CTe.ValePedagio> valesPedagios, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            if (valesPedagios != null && valesPedagios.Count() > 0)
            {
                Repositorio.ValePedagioCTe repValePedagio = new Repositorio.ValePedagioCTe(unidadeDeTrabalho);

                foreach (Dominio.ObjetosDeValor.CTe.ValePedagio valePedagio in valesPedagios)
                {
                    Dominio.Entidades.ValePedagioCTe valePedagioCTe = new Dominio.Entidades.ValePedagioCTe();

                    valePedagioCTe.CTe = cte;
                    valePedagioCTe.CNPJFornecedor = valePedagio.CNPJFornecedor;
                    valePedagioCTe.CNPJResponsavel = valePedagio.CNPJResponsavel;
                    valePedagioCTe.NumeroComprovante = valePedagio.NumeroComprovante;
                    valePedagioCTe.ValorValePedagio = valePedagio.ValorValePedagio;

                    repValePedagio.Inserir(valePedagioCTe);
                }
            }
        }

        #endregion

        #region Geração

        private bool AdicionarAverbacaoNaFilaDeConsulta(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, string webServiceConsultaCTe)
        {
            try
            {
                string postData = "CodigoCTe=" + (cte != null ? cte.Codigo : 0);
                byte[] bytes = Encoding.UTF8.GetBytes(postData);

                HttpWebRequest request = (HttpWebRequest)WebRequest.Create(string.Concat(webServiceConsultaCTe, "IntegracaoCTe/AdicionarAverbacaoNaFilaDeConsulta"));

                request.Method = "POST";
                request.ContentType = "application/x-www-form-urlencoded";
                request.ContentLength = bytes.Length;

                Stream requestStream = request.GetRequestStream();
                requestStream.Write(bytes, 0, bytes.Length);

                WebResponse response = request.GetResponse();

                Stream stream = response.GetResponseStream();

                StreamReader reader = new StreamReader(stream);
                string result = reader.ReadToEnd();

                stream.Dispose();
                reader.Dispose();

                Dictionary<string, object> retorno = JsonConvert.DeserializeObject<Dictionary<string, object>>(result);

                return (bool)retorno["Sucesso"];
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro(ex, "AdicionarAverbacaoNaFilaDeConsulta");
                return false;
            }
        }

        private ServicoCTe.Cte ObterCTeParaEmissao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.Entidades.Empresa empresa, Repositorio.UnitOfWork unitOfWork)
        {
            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");

            ServicoCTe.Cte cteImportar = new ServicoCTe.Cte();

            string emailsProprietarioVeiculo = string.Empty;

            ServicoCTe.DadosCadastrais destinatario = this.ObterClienteParaEmissao(cte, Dominio.Enumeradores.TipoTomador.Destinatario);
            if (destinatario != null)
            {
                cteImportar.Destinatario = new List<ServicoCTe.DadosCadastrais>();
                cteImportar.Destinatario.Add(destinatario);
            }

            cteImportar.LocalEntrega = this.ObterLocalDeEntregaParaEmissao(cte);

            ServicoCTe.DadosCadastrais remetente = this.ObterClienteParaEmissao(cte, Dominio.Enumeradores.TipoTomador.Remetente);
            if (remetente != null)
            {
                cteImportar.Remetente = new List<ServicoCTe.DadosCadastrais>();
                cteImportar.Remetente.Add(remetente);
            }

            cteImportar.EmpresaEmitente = this.ObterEmpresaEmitente(cte.Empresa);
            cteImportar.IE_ST = ObterInscricaoST(cte.Empresa, cte.LocalidadeInicioPrestacao, unitOfWork);
            cteImportar.CodigoRegimeTributario = cte.Empresa.RegimeTributarioCTe.GetHashCode();

            if (cte.TipoTomador == Dominio.Enumeradores.TipoTomador.Outros)
            {
                ServicoCTe.DadosCadastrais tomador = this.ObterClienteParaEmissao(cte, Dominio.Enumeradores.TipoTomador.Outros);
                if (tomador != null)
                {
                    cteImportar.Tomador = new List<ServicoCTe.DadosCadastrais>();
                    cteImportar.Tomador.Add(tomador);
                }
            }

            ServicoCTe.DadosCadastrais expedidor = this.ObterClienteParaEmissao(cte, Dominio.Enumeradores.TipoTomador.Expedidor);
            if (expedidor != null)
            {
                cteImportar.Expedidor = new List<ServicoCTe.DadosCadastrais>();
                cteImportar.Expedidor.Add(expedidor);
            }

            ServicoCTe.DadosCadastrais recebedor = this.ObterClienteParaEmissao(cte, Dominio.Enumeradores.TipoTomador.Recebedor);
            if (recebedor != null)
            {
                cteImportar.Recebedor = new List<ServicoCTe.DadosCadastrais>();
                cteImportar.Recebedor.Add(recebedor);
            }

            TimeZoneInfo fusoHorarioEmpresa = TimeZoneInfo.FindSystemTimeZoneById(empresa.FusoHorario);
            bool horarioVerao = fusoHorarioEmpresa.IsDaylightSavingTime(cte.DataEmissao.HasValue ? cte.DataEmissao.Value : DateTime.Today);
            cteImportar.FusoHorario = horarioVerao ? AjustarFuso(fusoHorarioEmpresa.BaseUtcOffset.Hours + 1, fusoHorarioEmpresa.BaseUtcOffset.Minutes) : AjustarFuso(fusoHorarioEmpresa.BaseUtcOffset.Hours, fusoHorarioEmpresa.BaseUtcOffset.Minutes);

            cteImportar.DocumentosAnteriores = new List<ServicoCTe.EmissorDocumentoTransporteAnterior>();
            cteImportar.DocumentosAnteriores = this.ObterDocumentosAnterioresParaEmissao(cte, empresa, unitOfWork);

            cteImportar.Fatura = this.ObterFaturaParaEmissao(cte, empresa.Codigo, unitOfWork);

            cteImportar.ProdutosPerigosos = this.ObterProdutosPerigososParaEmissao(cte, empresa.Codigo, unitOfWork);

            cteImportar.InfCarga = new List<ServicoCTe.InformacoesCarga>();
            cteImportar.InfCarga.Add(this.ObterInformacaoDaCargaParaEmissao(cte, empresa.Codigo, unitOfWork));

            cteImportar.Imposto = new List<ServicoCTe.Impostos>();
            cteImportar.Imposto.Add(this.ObterImpostosParaEmissao(cte, unitOfWork));

            cteImportar.ModalRodo = new List<ServicoCTe.ModalRodoviario>();
            cteImportar.ModalRodo.Add(this.ObterModalRodoviarioParaEmissao(cte, empresa.Codigo, unitOfWork, ref emailsProprietarioVeiculo));

            cteImportar.ModalAqua = new List<ServicoCTe.ModalAquaviario>();
            cteImportar.ModalAqua.Add(this.ObterModalAquaviarioParaEmissao(cte, empresa.Codigo, unitOfWork));

            if (!string.IsNullOrWhiteSpace(emailsProprietarioVeiculo) && cteImportar.Remetente != null && cteImportar.Remetente.Count > 0)
            {
                if (!string.IsNullOrWhiteSpace(cteImportar.Remetente.FirstOrDefault().Email))
                    cteImportar.Remetente.FirstOrDefault().Email += string.Concat(emailsProprietarioVeiculo, ";");
                else
                    cteImportar.Remetente.FirstOrDefault().Email = emailsProprietarioVeiculo;
            }


            cteImportar.Ide = new List<ServicoCTe.Identificacao>();
            cteImportar.Ide.Add(this.ObterIdentificacaoParaEmissao(cte));

            cteImportar.Seguro = new List<ServicoCTe.Seguros>();
            cteImportar.Seguro = this.ObterSegurosParaEmissao(cte, empresa.Codigo, unitOfWork);

            cteImportar.ValoresPrest = new List<ServicoCTe.ValoresPrestacao>();
            cteImportar.ValoresPrest.Add(this.ObterValorDaPrestacaoParaEmissao(cte, empresa.Codigo, unitOfWork));

            cteImportar.NFs = new List<ServicoCTe.NotasFiscais>();
            cteImportar.NFs = this.ObterNotasFiscaisRemetenteParaEmissao(cte, empresa, unitOfWork);

            cteImportar.ComplContFisc = new List<ServicoCTe.ObservacoesContFisc>();
            cteImportar.ComplContFisc.AddRange(this.ObterObservacoesDoContribuinte(cte, empresa.Codigo, unitOfWork));
            cteImportar.ComplContFisc.AddRange(this.ObterObservacoesDoFisco(cte, empresa.Codigo, unitOfWork));

            cteImportar.DadosComplementares = this.ObterDadosComplementares(cte);

            cteImportar.Percursos = new List<ServicoCTe.PercursoCTe>();
            cteImportar.Percursos.AddRange(this.ObterPercurso(cte, empresa.Codigo, unitOfWork));

            if (!string.IsNullOrWhiteSpace(cte.ObservacoesGerais) || !string.IsNullOrWhiteSpace(cte.ObservacoesAvancadas))
                cteImportar.ComplContFisc.Add(this.ObterObservacaoGeral(cte));

            if (cte.TipoCTE == Dominio.Enumeradores.TipoCTE.Anulacao)
            {
                cteImportar.ChavesAnula_Subs_Compl = new List<ServicoCTe.Chaves>();
                ServicoCTe.Chaves chaves = new ServicoCTe.Chaves();
                chaves.ChaveAnulacao = cte.ChaveCTESubComp;
                chaves.ChaveSubstituto = string.Empty;
                chaves.ChaveComplementar = string.Empty;
                cteImportar.ChavesAnula_Subs_Compl.Add(chaves);
            }
            else if (cte.TipoCTE == Dominio.Enumeradores.TipoCTE.Complemento)
            {
                cteImportar.ChavesAnula_Subs_Compl = new List<ServicoCTe.Chaves>();
                ServicoCTe.Chaves chaves = new ServicoCTe.Chaves();
                chaves.ChaveAnulacao = string.Empty;
                chaves.ChaveSubstituto = string.Empty;
                chaves.ChaveComplementar = cte.ChaveCTESubComp;
                cteImportar.ChavesAnula_Subs_Compl.Add(chaves);
            }
            else if (cte.TipoCTE == Dominio.Enumeradores.TipoCTE.Substituto)
            {
                Repositorio.DocumentosAnulacaoCTE repDocumentosAnulacaoCTe = new Repositorio.DocumentosAnulacaoCTE(unitOfWork);

                Dominio.Entidades.DocumentosAnulacaoCTE documentoAnulacao = repDocumentosAnulacaoCTe.BuscarPorCTe(empresa.Codigo, cte.Codigo);

                if (documentoAnulacao != null)
                {
                    cteImportar.ChavesAnula_Subs_Compl = new List<ServicoCTe.Chaves>();
                    ServicoCTe.Chaves chaves = new ServicoCTe.Chaves();
                    chaves.ChaveAnulacao = documentoAnulacao.Chave;
                    chaves.ChaveSubstituto = cte.ChaveCTESubComp;
                    chaves.ChaveComplementar = string.Empty;
                    cteImportar.ChavesAnula_Subs_Compl.Add(chaves);
                }
            }

            double versao = 3;
            if (!string.IsNullOrWhiteSpace(cte.Versao))
                versao = double.Parse(cte.Versao, cultura);

            cteImportar.ID = string.Empty;
            cteImportar.Versao = versao;
            cteImportar.DataEntrega = new ServicoCTe.Entrega();

            cteImportar.DataIntegracao = DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss");
            cteImportar.DataIntegracaoSefaz = string.Empty;
            cteImportar.Status = string.Empty;
            cteImportar.TipoEnvio = cte.TipoEnvio;
            cteImportar.ChaveContingencia = cte.ChaveContingencia;
            cteImportar.Chave = cte.Chave;
            cteImportar.SempreAdicionarRemetenteDestinatario = 2;

            if (cte.TipoServico == Dominio.Enumeradores.TipoServico.ServVinculadoMultimodal && cte.TipoModal == TipoModal.Aquaviario && cte.Empresa?.FormaRateioSVM == FormaRateioSVM.UmCTeMultimodalParaUmCTeAquaviario && !string.IsNullOrWhiteSpace(cte.NumeroControle) && cte.NumeroControle.StartsWith("SVM"))
                cteImportar.SempreAdicionarRemetenteDestinatario = 1;

            cteImportar.Xml = new ServicoCTe.Xml();

            if (cte.TomadorPagador?.GrupoPessoas?.AutorizadosDownloadDFe != null && cte.TomadorPagador.GrupoPessoas.AutorizadosDownloadDFe.Count > 0)
                cteImportar.CnpjsAutorizados = string.Join(";", cte.Tomador.GrupoPessoas.AutorizadosDownloadDFe.Select(o => o.CPF_CNPJ_SemFormato));

            if (cte.TomadorPagador?.Cliente?.NaoUsarConfiguracaoEmissaoGrupo == true)
            {
                if (cte.TomadorPagador.Cliente.TipoEnvioEmail != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEnvioEmailCTe.Normal)
                    cteImportar.TipoEmail = (int)(cte.TomadorPagador.Cliente.TipoEnvioEmail ?? Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEnvioEmailCTe.Normal);
            }
            else if (cte.TomadorPagador?.GrupoPessoas != null && cte.TomadorPagador.GrupoPessoas.TipoEnvioEmail.HasValue && cte.TomadorPagador.GrupoPessoas.TipoEnvioEmail != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoEnvioEmailCTe.Normal)
            {
                cteImportar.TipoEmail = (int)cte.TomadorPagador.GrupoPessoas.TipoEnvioEmail;
            }

            return cteImportar;
        }

        private ServicoCTe.DadosComplementares ObterDadosComplementares(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte)
        {
            ServicoCTe.DadosComplementares dadosComplementares = new ServicoCTe.DadosComplementares();

            dadosComplementares.CaracteristicaAdicionalServico = cte.CaracteristicaServico;
            dadosComplementares.CaracteristicaAdicionalTransporte = cte.CaracteristicaTransporte;

            dadosComplementares.EmitenteCTe = Utilidades.String.Left(cte.Usuario?.Nome, 20) ?? "";
            dadosComplementares.FluxoOrigem = Utilidades.String.Left(cte.PortoOrigem?.Descricao, 60) ?? "";
            dadosComplementares.FluxoDestino = Utilidades.String.Left(cte.PortoDestino?.Descricao, 60) ?? "";

            dadosComplementares.FluxoPassagem = ""; //Tamanho 15
            dadosComplementares.FluxoPassagem = Utilidades.String.Left(cte.PortoPassagemUm?.Descricao, 15) ?? "";
            dadosComplementares.FluxoPassagem2 = Utilidades.String.Left(cte.PortoPassagemDois?.Descricao, 15) ?? "";
            dadosComplementares.FluxoPassagem3 = Utilidades.String.Left(cte.PortoPassagemTres?.Descricao, 15) ?? "";
            dadosComplementares.FluxoPassagem4 = Utilidades.String.Left(cte.PortoPassagemQuatro?.Descricao, 15) ?? "";
            dadosComplementares.FluxoPassagem5 = Utilidades.String.Left(cte.PortoPassagemCinco?.Descricao, 15) ?? "";

            dadosComplementares.FluxoRota = ""; //Tamanho 10

            return dadosComplementares;
        }

        private List<ServicoCTe.ProdutoPerigoso> ObterProdutosPerigososParaEmissao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ProdutoPerigosoCTE repProdutosPerigososCTe = new Repositorio.ProdutoPerigosoCTE(unitOfWork);

            List<Dominio.Entidades.ProdutoPerigosoCTE> produtosPerigosos = repProdutosPerigososCTe.BuscarPorCTe(codigoEmpresa, cte.Codigo);

            List<ServicoCTe.ProdutoPerigoso> listaProdutos = new List<ServicoCTe.ProdutoPerigoso>();

            foreach (Dominio.Entidades.ProdutoPerigosoCTE produtoPerigoso in produtosPerigosos)
            {
                ServicoCTe.ProdutoPerigoso prodPerig = new ServicoCTe.ProdutoPerigoso();

                prodPerig.ClasseRisco = produtoPerigoso.ClasseRisco;
                prodPerig.GrupoEmbalagem = produtoPerigoso.Grupo;
                prodPerig.NomeApropriado = produtoPerigoso.NomeApropriado;
                prodPerig.NumeroONU = produtoPerigoso.NumeroONU.ToString();
                prodPerig.PontoFulgor = produtoPerigoso.PontoFulgor;
                prodPerig.QuantidadeTipo = produtoPerigoso.Volumes;
                prodPerig.QuantidadeTotal = produtoPerigoso.Quantidade;

                listaProdutos.Add(prodPerig);
            }

            return listaProdutos;
        }

        private string AjustarFuso(int hora, int minutos)
        {
            string minutosString = minutos.ToString();

            if (minutosString.Length == 1)
                minutosString = string.Concat("0", minutosString);

            switch (hora)
            {
                case -12:
                    return "-12:" + minutosString;
                case -11:
                    return "-11:" + minutosString;
                case -10:
                    return "-10:" + minutosString;
                case -9:
                    return "-09:" + minutosString;
                case -8:
                    return "-08:" + minutosString;
                case -7:
                    return "-07:" + minutosString;
                case -6:
                    return "-06:" + minutosString;
                case -5:
                    return "-05:" + minutosString;
                case -4:
                    return "-04:" + minutosString;
                case -3:
                    return "-03:" + minutosString;
                case -2:
                    return "-02:" + minutosString;
                case -1:
                    return "-01:" + minutosString;
                case 0:
                    return "00:" + minutosString;
                case 1:
                    return "+01:" + minutosString;
                case 2:
                    return "+02:" + minutosString;
                case 3:
                    return "+03:" + minutosString;
                case 4:
                    return "+04:" + minutosString;
                case 5:
                    return "+05:" + minutosString;
                case 6:
                    return "+06:" + minutosString;
                case 7:
                    return "+07:" + minutosString;
                case 8:
                    return "+08:" + minutosString;
                case 9:
                    return "+09:" + minutosString;
                case 10:
                    return "+10:" + minutosString;
                case 11:
                    return "+11:" + minutosString;
                case 12:
                    return "+12:" + minutosString;
                case 13:
                    return "+13:" + minutosString;
                default:
                    return "-03:00";
            }

        }

        private ServicoCTe.Fatura ObterFaturaParaEmissao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.CobrancaCTe repCobrancaCTe = new Repositorio.CobrancaCTe(unitOfWork);
            Repositorio.ParcelaCobrancaCTe repParcelaCobrancaCTe = new Repositorio.ParcelaCobrancaCTe(unitOfWork);

            Dominio.Entidades.CobrancaCTe cobranca = repCobrancaCTe.BuscarPorCTe(codigoEmpresa, cte.Codigo);

            ServicoCTe.Fatura fatura = new ServicoCTe.Fatura();

            fatura.Duplicatas = new List<ServicoCTe.Duplicata>();

            if (cobranca != null)
            {

                fatura.Numero = cobranca.Numero;
                fatura.ValorDesconto = cobranca.ValorDesconto;
                fatura.ValorLiquido = cobranca.ValorLiquido;
                fatura.ValorOriginal = cobranca.Valor;

                List<Dominio.Entidades.ParcelaCobrancaCTe> parcelas = repParcelaCobrancaCTe.BuscarPorCTe(codigoEmpresa, cte.Codigo);

                if (parcelas.Count > 0)
                {
                    fatura.Duplicatas = new List<ServicoCTe.Duplicata>();

                    foreach (Dominio.Entidades.ParcelaCobrancaCTe parcela in parcelas)
                    {
                        ServicoCTe.Duplicata duplicata = new ServicoCTe.Duplicata();
                        duplicata.DataVencimento = parcela.DataVencimento.ToString("yyyy-MM-dd");
                        duplicata.Numero = parcela.Numero.ToString();
                        duplicata.Valor = parcela.Valor;
                        fatura.Duplicatas.Add(duplicata);
                    }
                }

            }

            return fatura;
        }

        private List<ServicoCTe.EmissorDocumentoTransporteAnterior> ObterDocumentosAnterioresParaEmissao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.Entidades.Empresa empresa, Repositorio.UnitOfWork unitOfWork)
        {
            List<ServicoCTe.EmissorDocumentoTransporteAnterior> retorno = new List<ServicoCTe.EmissorDocumentoTransporteAnterior>();

            Repositorio.DocumentoDeTransporteAnteriorCTe repDocumentoAnteriorCTe = new Repositorio.DocumentoDeTransporteAnteriorCTe(unitOfWork);

            List<Dominio.Entidades.DocumentoDeTransporteAnteriorCTe> documentosAnteriores = repDocumentoAnteriorCTe.BuscarPorCTe(empresa.Codigo, cte.Codigo);
            List<Dominio.Entidades.Cliente> emissores = (from obj in documentosAnteriores select obj.Emissor).Distinct().ToList();

            foreach (Dominio.Entidades.Cliente emissor in emissores)
            {
                ServicoCTe.EmissorDocumentoTransporteAnterior emissorDocAnt = new ServicoCTe.EmissorDocumentoTransporteAnterior();

                emissorDocAnt.CNPJ = emissor.Tipo == "J" ? string.Format("{0:00000000000000}", emissor.CPF_CNPJ) : string.Empty;
                emissorDocAnt.CPF = emissor.Tipo == "F" ? string.Format("{0:00000000000}", emissor.CPF_CNPJ) : string.Empty;
                emissorDocAnt.IE = string.IsNullOrWhiteSpace(emissor.IE_RG) || emissor.IE_RG.ToLower().Contains("isento") ? "00000000000000" : Utilidades.String.OnlyNumbers(emissor.IE_RG);
                emissorDocAnt.Nome = Utilidades.String.Left(emissor.Nome, 60);
                emissorDocAnt.UF = emissor.Localidade.Estado.Sigla;

                emissorDocAnt.Documentos = new List<ServicoCTe.DocumentoTransporteAnterior>();

                List<Dominio.Entidades.DocumentoDeTransporteAnteriorCTe> documentosEmissor = (from obj in documentosAnteriores where obj.Emissor == emissor select obj).ToList();

                foreach (Dominio.Entidades.DocumentoDeTransporteAnteriorCTe doc in documentosEmissor)
                {
                    ServicoCTe.DocumentoTransporteAnterior documentoAnt = new ServicoCTe.DocumentoTransporteAnterior();

                    if (!string.IsNullOrWhiteSpace(doc.Chave))
                    {
                        if (!empresa.IgnorarDocumentosDuplicadosNaEmissaoCTe || !emissorDocAnt.Documentos.Any(d => d.Chave == doc.Chave))
                        {
                            documentoAnt.Chave = doc.Chave;
                            emissorDocAnt.Documentos.Add(documentoAnt);
                        }
                    }
                    else
                    {
                        documentoAnt.DataEmissao = doc.DataEmissao != null ? doc.DataEmissao.Value.ToString("yyyy-MM-dd") : "";
                        documentoAnt.Numero = doc.Numero;
                        documentoAnt.Serie = doc.Serie;
                        documentoAnt.Tipo = doc.Tipo;
                        emissorDocAnt.Documentos.Add(documentoAnt);
                    }
                }

                retorno.Add(emissorDocAnt);
            }

            return retorno;
        }

        private ServicoCTe.LocalEntrega ObterLocalDeEntregaParaEmissao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte)
        {
            ServicoCTe.LocalEntrega localEntrega = new ServicoCTe.LocalEntrega();
            if (cte.ClienteEntrega != null)
            {
                localEntrega.Bairro = Utilidades.String.Left(cte.ClienteEntrega.Bairro, 60);
                localEntrega.Cidade = Utilidades.String.Left(cte.ClienteEntrega.Localidade.Descricao, 60);
                localEntrega.CNPJ = cte.ClienteEntrega.Tipo == "J" ? string.Format("{0:00000000000000}", cte.ClienteEntrega.CPF_CNPJ) : string.Empty;
                localEntrega.CodigoCidadeIBGE = cte.ClienteEntrega.Localidade.CodigoIBGE;
                localEntrega.Complemento = Utilidades.String.Left(cte.ClienteEntrega.Complemento, 60);
                localEntrega.CPF = cte.ClienteEntrega.Tipo == "F" ? string.Format("{0:00000000000}", cte.ClienteEntrega.CPF_CNPJ) : string.Empty;
                localEntrega.Logradouro = Utilidades.String.Left(cte.ClienteEntrega.Endereco, 255);
                localEntrega.NomeRazao = Utilidades.String.Left(cte.ClienteEntrega.Nome, 60);
                localEntrega.Numero = Utilidades.String.Left(cte.ClienteEntrega.Numero, 60);
                localEntrega.UF = cte.ClienteEntrega.Localidade.Estado.Sigla;
            }
            return localEntrega;
        }

        private ServicoCTe.DadosCadastrais ObterClienteParaEmissao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.Enumeradores.TipoTomador tipo)
        {
            Dominio.Entidades.ParticipanteCTe cliente = cte.ObterParticipante(tipo);

            if (cliente != null)
                return this.ObterCliente(cliente, tipo);

            return null;
        }

        private ServicoCTe.DadosCadastrais ObterCliente(Dominio.Entidades.ParticipanteCTe participante, Dominio.Enumeradores.TipoTomador tipo)
        {
            ServicoCTe.DadosCadastrais dados = new ServicoCTe.DadosCadastrais();

            if (!participante.Exterior)
            {
                if (participante.Tipo == Dominio.Enumeradores.TipoPessoa.Juridica)
                {
                    dados.CNPJ = participante.CPF_CNPJ_SemFormato;
                    dados.CPF = string.Empty;
                }
                else
                {
                    dados.CPF = participante.CPF_CNPJ_SemFormato;
                    dados.CNPJ = string.Empty;
                }

                dados.CodigoPais = participante.Pais != null ? participante.Pais.Codigo : 1058;
                dados.Cep = Utilidades.String.OnlyNumbers(participante.CEP);
                dados.Cidade = Utilidades.String.Left(participante.Localidade.Descricao, 60);
                dados.CodigoCidadeIBGE = participante.Localidade.CodigoIBGE;
                dados.Pais = participante.Pais != null ? Utilidades.String.Left(participante.Pais.Nome, 60) : Utilidades.String.Left(participante.Localidade.Estado.Pais.Nome, 60);
                dados.Telefone = Utilidades.String.Left(Utilidades.String.OnlyNumbers(participante.Telefone1), 14);
                dados.UF = participante.Localidade.Estado.Sigla;

                string emails = string.Empty;

                if (participante.EmailStatus && !string.IsNullOrWhiteSpace(participante.Email))
                    emails += string.Concat(participante.Email, ";");
                else if (participante.Cliente != null && participante.Cliente.GrupoPessoas != null && participante.Cliente.GrupoPessoas.EnviarXMLCTePorEmail && !string.IsNullOrWhiteSpace(participante.Cliente.GrupoPessoas.Email))
                    emails += string.Concat(participante.Cliente.GrupoPessoas.Email, ";");

                if (participante.EmailContadorStatus && !string.IsNullOrWhiteSpace(participante.EmailContador))
                    emails += string.Concat(participante.EmailContador, ";");

                if (participante.EmailContatoStatus && !string.IsNullOrWhiteSpace(participante.EmailContato))
                    emails += string.Concat(participante.EmailContato, ";");// emails += participante.EmailContato;

                if (participante.EmailTransportadorStatus && !string.IsNullOrWhiteSpace(participante.EmailTransportador))
                    emails += string.Concat(participante.EmailTransportador, ";");

                dados.Email = Utilidades.String.Left(emails, 1000);

                string ie = participante.IE_RG; //Utilidades.String.OnlyNumbers()

                dados.IE = string.IsNullOrWhiteSpace(ie) ? "" : Utilidades.String.Left(ie, 14);
                dados.NomeFantasia = Utilidades.String.Left(participante.NomeFantasia, 60);
                dados.Suframa = string.IsNullOrWhiteSpace(Utilidades.String.OnlyNumbers(participante.InscricaoSuframa)) ? -1 : int.Parse(Utilidades.String.OnlyNumbers(participante.InscricaoSuframa));
            }
            else
            {
                dados.CNPJ = "00000000000000";
                dados.Cep = string.Empty;
                dados.Cidade = Utilidades.String.Left(participante.Cidade, 60);
                dados.CodigoCidadeIBGE = 9999999;
                dados.CodigoPais = participante.Pais != null ? participante.Pais.Codigo : -1;

                if (participante.EmailStatus && !string.IsNullOrWhiteSpace(participante.Email))
                    dados.Email = participante.Email;

                dados.IE = participante.IE_RG;
                dados.NomeFantasia = string.Empty;
                dados.Pais = participante.Pais != null ? Utilidades.String.Left(participante.Pais.Nome, 60) : "EXTERIOR";
                dados.Suframa = -1;
                dados.Telefone = string.Empty;
                dados.UF = "EX";
            }

            dados.NomeRazao = Utilidades.String.Left(participante.Nome, 60);
            dados.Bairro = String.IsNullOrWhiteSpace(participante.Bairro) ? "BAIRRO" : participante.Bairro.Length < 2 ? "BAIRRO " + participante.Bairro : Utilidades.String.Left(participante.Bairro, 60);
            dados.Complemento = !String.IsNullOrWhiteSpace(participante.Complemento) && participante.Complemento.Length > 2 ? Utilidades.String.Left(participante.Complemento, 60) : String.Empty;
            dados.Numero = !string.IsNullOrWhiteSpace(participante.Numero) ? Utilidades.String.Left(participante.Numero, 60) : "S/N";
            dados.Logradouro = String.IsNullOrWhiteSpace(participante.Endereco) ? "RUA" : participante.Endereco.Length < 2 ? "RUA " + Utilidades.String.RemoveSpecialCharacters(participante.Endereco) : Utilidades.String.Left(Utilidades.String.RemoveSpecialCharacters(participante.Endereco), 255);
            dados.Tomador = tipo == Dominio.Enumeradores.TipoTomador.Outros ? 4 : -1;
            dados.Tipo = this.ObterTipoCliente(tipo);

            return dados;
        }

        private string ObterTipoCliente(Dominio.Enumeradores.TipoTomador tipo)
        {
            switch (tipo)
            {
                case Dominio.Enumeradores.TipoTomador.Destinatario:
                    return "D";
                case Dominio.Enumeradores.TipoTomador.Expedidor:
                    return "E";
                case Dominio.Enumeradores.TipoTomador.Outros:
                    return "T";
                case Dominio.Enumeradores.TipoTomador.Recebedor:
                    return "B";
                case Dominio.Enumeradores.TipoTomador.Remetente:
                    return "R";
                default:
                    return "";
            }
        }

        private Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal ObterTipoModal(int codigoModal)
        {
            switch (codigoModal)
            {
                case 1:
                    return Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Rodoviario;
                case 2:
                    return Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Aereo;
                case 3:
                    return Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Aquaviario;
                case 4:
                    return Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Ferroviario;
                case 5:
                    return Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Dutoviario;
                case 6:
                    return Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Multimodal;
                default:
                    return Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Rodoviario;
            }
        }

        private ServicoCTe.ModalRodoviario ObterModalRodoviarioParaEmissao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork, ref string emailsProprietarioVeiculo)
        {
            emailsProprietarioVeiculo = string.Empty;

            Repositorio.MotoristaCTE repMotoristaCTe = new Repositorio.MotoristaCTE(unitOfWork);
            Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unitOfWork);

            List<Dominio.Entidades.MotoristaCTE> motoristasCTe = repMotoristaCTe.BuscarPorCTe(codigoEmpresa, cte.Codigo);
            List<Dominio.Entidades.VeiculoCTE> veiculosCTe = repVeiculoCTe.BuscarPorCTe(codigoEmpresa, cte.Codigo);

            ServicoCTe.ModalRodoviario modalRodoviario = new ServicoCTe.ModalRodoviario();

            modalRodoviario.CIOT = cte.CIOT;
            modalRodoviario.DataPrevisaoEntrega = cte.DataPrevistaEntrega != null ? cte.DataPrevistaEntrega.Value.ToString("yyyy-MM-dd") : string.Empty;
            modalRodoviario.Lacre = cte.LacreContainer;
            modalRodoviario.Lotacao = cte.Lotacao.ToString("d");
            modalRodoviario.RNTRC = cte.RNTRC;

            if (veiculosCTe.Count > 0)
            {
                Repositorio.Embarcador.Configuracoes.ConfiguracaoCargaEmissaoDocumento repConfiguracaoCargaEmissaoDocumento = new Repositorio.Embarcador.Configuracoes.ConfiguracaoCargaEmissaoDocumento(unitOfWork);

                Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoCargaEmissaoDocumento configuracaoCargaEmissaoDocumento = repConfiguracaoCargaEmissaoDocumento.BuscarConfiguracaoPadrao();

                modalRodoviario.VeiculoLotacao = (from obj in veiculosCTe
                                                  select new ServicoCTe.Veiculo
                                                  {
                                                      CapacidadeKG = obj.CapacidadeKG,
                                                      CapacidadeM3 = obj.CapacidadeM3,
                                                      CodigoVeiculo = obj.Veiculo.Codigo.ToString(),
                                                      MotoristaVeiculo = motoristasCTe.Count > 0 ? (from motorista in motoristasCTe select new ServicoCTe.Motorista { CPF = Utilidades.String.Left(motorista.CPFMotorista, 11), Nome = Utilidades.String.Left(motorista.NomeMotorista, 60) }).ToList() : null,
                                                      Placa = obj.Placa.ToUpper(),
                                                      Renavan = !string.IsNullOrWhiteSpace(obj.RENAVAM) && obj.RENAVAM.Length > 11 ? Utilidades.String.Right(obj.RENAVAM, 11) : obj.RENAVAM,
                                                      Tara = obj.Tara,
                                                      TipoCarroceria = !string.IsNullOrWhiteSpace(obj.TipoCarroceria) ? int.Parse(obj.TipoCarroceria) : 0,
                                                      TipoProprietarioVeiculo = obj.TipoPropriedade,
                                                      TipoRodado = !string.IsNullOrWhiteSpace(obj.TipoRodado) ? int.Parse(obj.TipoRodado) : 3,
                                                      TipoVeiculo = !string.IsNullOrWhiteSpace(obj.TipoVeiculo) ? int.Parse(obj.TipoVeiculo) : 0,
                                                      UF = obj.Estado.Sigla,
                                                      ProprietVeiculo = obj.TipoPropriedade.Equals("T") && obj.Proprietario != null ?
                                                                        new List<ServicoCTe.ProprietarioVeiculo>() {
                                                                            new ServicoCTe.ProprietarioVeiculo() {
                                                                                CNPJ= obj.Proprietario.CPF_CNPJ.Length == 14? obj.Proprietario.CPF_CNPJ: string.Empty,
                                                                                CPF = obj.Proprietario.CPF_CNPJ.Length == 11? obj.Proprietario.CPF_CNPJ: string.Empty,
                                                                                IE = string.IsNullOrWhiteSpace(obj.Proprietario.IE) || obj.Proprietario.IE.ToLower().Contains("isento")? "ISENTO": Utilidades.String.OnlyNumbers(obj.Proprietario.IE),
                                                                                Nome_RazaoSocial = obj.Proprietario.Nome.Length >= 60 ? obj.Proprietario.Nome.Substring(0,60) : obj.Proprietario.Nome,
                                                                                RNTRC = string.IsNullOrWhiteSpace(obj.Proprietario.RNTRC)? 0:  int.Parse(obj.Proprietario.RNTRC),
                                                                                TipoProprietario = (int)obj.Proprietario.Tipo,
                                                                                UF = obj.Proprietario.Estado.Sigla,
                                                                                TAF = obj.Veiculo?.TAF,
                                                                                NroRegEstadual = obj.Veiculo?.NroRegEstadual
                                                                            }
                                                                        } : null
                                                  }).ToList();


                if (!(configuracaoCargaEmissaoDocumento?.NaoEnviarEmailDocumentoEmitidoProprietarioVeiculo ?? false))
                    emailsProprietarioVeiculo = veiculosCTe.FirstOrDefault().Veiculo != null && veiculosCTe.FirstOrDefault().Veiculo.Tipo == "T" && veiculosCTe.FirstOrDefault().Veiculo.Proprietario != null && veiculosCTe.FirstOrDefault().Veiculo.Proprietario.EmailStatus == "A" ? veiculosCTe.FirstOrDefault().Veiculo.Proprietario.Email : string.Empty;
            }

            return modalRodoviario;
        }

        private ServicoCTe.ModalAquaviario ObterModalAquaviarioParaEmissao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ContainerCTE repContainerCTE = new Repositorio.ContainerCTE(unitOfWork);
            Repositorio.Embarcador.CTe.CTeContainerDocumento repCTeContainerDocumento = new Repositorio.Embarcador.CTe.CTeContainerDocumento(unitOfWork);

            ServicoCTe.ModalAquaviario modalAquaviario = new ServicoCTe.ModalAquaviario();
            if (cte.TipoModal != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Aquaviario && cte.TipoModal != Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Multimodal)
                return modalAquaviario;

            modalAquaviario.AFRMM = cte.ValorAdicionalAFRMM.HasValue ? cte.ValorAdicionalAFRMM.Value : 0;
            modalAquaviario.Navio = cte.Navio?.Descricao ?? "";
            modalAquaviario.Viagem = cte.Viagem?.NumeroViagem.ToString("D") ?? "";
            modalAquaviario.Irin = cte.Navio?.Irin ?? "";
            modalAquaviario.Direcao = Dominio.ObjetosDeValor.Embarcador.Enumeradores.DirecaoViagemMultimodalHelper.ObterAbreviacao(cte.Viagem?.DirecaoViagemMultimodal ?? Dominio.ObjetosDeValor.Embarcador.Enumeradores.DirecaoViagemMultimodal.Norte);

            if (cte.Balsas != null && cte.Balsas.Count > 0)
            {
                for (int i = 0; i < cte.Balsas.Count; i++)
                {
                    if (i == 0)
                        modalAquaviario.Balsa1 = cte.Balsas[i].Descricao;
                    if (i == 1)
                        modalAquaviario.Balsa2 = cte.Balsas[i].Descricao;
                    if (i == 2)
                        modalAquaviario.Balsa3 = cte.Balsas[i].Descricao;
                }
            }
            modalAquaviario.Conteiners = new List<ServicoCTe.Container>();
            List<Dominio.Entidades.ContainerCTE> containerCTEs = repContainerCTE.BuscarPorCTe(cte.Codigo);
            if (containerCTEs != null && containerCTEs.Count > 0)
            {
                //bool contemNFe = containerCTEs.Any(c => c.Documentos.Any(d => d.TipoDocumento == TipoDocumentoCTe.NFe));                
                foreach (Dominio.Entidades.ContainerCTE container in containerCTEs)
                {
                    List<Dominio.Entidades.Embarcador.CTe.CTeContainerDocumento> notas = repCTeContainerDocumento.BuscarPorContainerCTe(container.Codigo);

                    List<Servicos.ServicoCTe.NotasFiscais> documentos = new List<ServicoCTe.NotasFiscais>();
                    if (notas != null && notas.Count > 0)
                    {
                        foreach (Dominio.Entidades.Embarcador.CTe.CTeContainerDocumento documento in notas)
                        {
                            //if (contemNFe && (documento.TipoDocumento == TipoDocumentoCTe.NF || documento.TipoDocumento == TipoDocumentoCTe.Outros || string.IsNullOrWhiteSpace(documento.Chave)))
                            //    continue;
                            documentos.Add(new ServicoCTe.NotasFiscais()
                            {
                                Serie = !string.IsNullOrWhiteSpace(documento.Serie) ? documento.Serie : "1",
                                NumeroNotaFiscal = documento.Numero,
                                ChaveNFE = documento.Chave,
                                UnidadeRateada = 0,//documento.UnidadeMedidaRateada,
                                TipoDocumento = documento.TipoDocumento == Dominio.Enumeradores.TipoDocumentoCTe.NF ? "NF" : "NFe"
                            });
                        }
                    }
                    modalAquaviario.Conteiners.Add(new ServicoCTe.Container()
                    {
                        Lacre1 = !string.IsNullOrWhiteSpace(container.Lacre1) ? Utilidades.String.RemoveDiacritics(container.Lacre1) : container.Lacre1,
                        Lacre2 = !string.IsNullOrWhiteSpace(container.Lacre2) ? Utilidades.String.RemoveDiacritics(container.Lacre2) : container.Lacre2,
                        Lacre3 = !string.IsNullOrWhiteSpace(container.Lacre3) ? Utilidades.String.RemoveDiacritics(container.Lacre3) : container.Lacre3,
                        Numweo = !string.IsNullOrWhiteSpace(container.Numero) ? Utilidades.String.RemoveDiacritics(container.Numero.Replace("-", "").Replace(" ", "")) : (container.Container?.Numero ?? "").Replace("-", "").Replace(" ", ""),
                        Documentos = documentos
                    });
                }
            }

            return modalAquaviario;
        }

        private ServicoCTe.Identificacao ObterIdentificacaoParaEmissao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte)
        {
            string tipoEmissao = cte.TipoEmissao;

            if (cte.TipoCTE == TipoCTE.Normal && !string.IsNullOrWhiteSpace(cte.Empresa.Localidade.Estado.TipoEmissao) && cte.Empresa.Localidade.Estado.TipoEmissao != "1")
                tipoEmissao = cte.Empresa.Localidade.Estado.TipoEmissao;

            //if (cte.Status == "Q")
            //    tipoEmissao = "1"; //Quando CTe é atualizado em EPEC, precisa reenviar como tipo Normal

            string destinoExterior = string.Empty;
            if (cte.LocalidadeTerminoPrestacao.CodigoIBGE == 9999999)
            {
                //if (cte.Recebedor != null)
                //{
                //    if (cte.Recebedor.Exterior)
                //        if (!string.IsNullOrWhiteSpace(cte.Recebedor.Cidade))
                //            destinoExterior = cte.Recebedor.Cidade;
                //        else
                //            destinoExterior = cte.Recebedor.Pais?.Descricao;
                //}
                //else if (cte.Destinatario != null)
                //{
                //    if (cte.Destinatario.Exterior)
                //        if (!string.IsNullOrWhiteSpace(cte.Destinatario.Cidade))
                //            destinoExterior = cte.Destinatario.Cidade;
                //        else
                //            destinoExterior = cte.Destinatario.Pais?.Descricao;
                //}
                destinoExterior = "EXTERIOR";
            }

            ServicoCTe.Identificacao identificacao = new ServicoCTe.Identificacao();

            identificacao.CFOP = cte.CFOP.CodigoCFOP;
            identificacao.CodigoCidadeEnvio = cte.LocalidadeEmissao.CodigoIBGE;
            identificacao.CodigoCidadeFim = cte.LocalidadeTerminoPrestacao.CodigoIBGE;
            identificacao.CodigoCidadeInicio = cte.LocalidadeInicioPrestacao.CodigoIBGE;
            identificacao.CodigoCte = string.Format("{0:0000000}", cte.Numero);
            identificacao.CodigoIBGE_UF = cte.Empresa.Localidade.Estado.CodigoIBGE;
            identificacao.DataEmissaoCte = cte.DataEmissao != null ? cte.DataEmissao.Value.ToString("dd/MM/yyyy HH:mm:ss", CultureInfo.InvariantCulture) : string.Empty;
            identificacao.DetalheRetira = !string.IsNullOrWhiteSpace(cte.DetalhesRetira) ? cte.DetalhesRetira.Length > 80 ? cte.DetalhesRetira.Substring(0, 80) : cte.DetalhesRetira : string.Empty;
            identificacao.DigitoChave = 0;
            identificacao.FormaPagamento = (int)cte.TipoPagamento;
            identificacao.FormatoImpressao = (int)cte.TipoImpressao;
            identificacao.Modal = cte.ModalTransporte.Numero;
            identificacao.Modelo = int.Parse(cte.ModeloDocumentoFiscal.Numero);
            identificacao.NaturezaOperacao = cte.NaturezaDaOperacao.Descricao;
            identificacao.NomeCidadeEnvio = cte.LocalidadeEmissao.Descricao;
            identificacao.NomeCidadeFim = string.IsNullOrWhiteSpace(destinoExterior) ? cte.LocalidadeTerminoPrestacao.Descricao : destinoExterior;
            identificacao.NomeCidadeInicio = cte.LocalidadeInicioPrestacao.Descricao;
            identificacao.NumeroCte = cte.Numero;
            identificacao.Retira = cte.Retira == Dominio.Enumeradores.OpcaoSimNao.Sim ? 0 : 1;
            identificacao.Serie = cte.Serie.Numero;
            identificacao.TipoAmbiente = (int)cte.TipoAmbiente;
            identificacao.TipoCte = (int)cte.TipoCTE;
            identificacao.TipoEmissao = string.IsNullOrWhiteSpace(tipoEmissao) ? 1 : int.Parse(tipoEmissao);
            identificacao.TipoProcessamentoEmissao = 0;
            identificacao.TipoServico = (int)cte.TipoServico;
            identificacao.Tomador = (int)cte.TipoTomador;
            identificacao.UFEnvio = cte.LocalidadeEmissao.Estado.Sigla;
            identificacao.UFFim = cte.LocalidadeTerminoPrestacao.Estado.Sigla;
            identificacao.UFInicio = cte.LocalidadeInicioPrestacao.Estado.Sigla;
            identificacao.IndGlobalizado = cte.IndicadorGlobalizado == Dominio.Enumeradores.OpcaoSimNao.Sim ? 1 : 0;
            identificacao.IndIETomador = cte.IndicadorIETomador != null ? (int)cte.IndicadorIETomador : 0;
            identificacao.TipoFretamento = cte.TipoFretamento != null ? (int)cte.TipoFretamento : 0;
            identificacao.DataHoraViagem = cte.DataHoraViagem != null ? cte.DataHoraViagem.Value.ToString("dd/MM/yyyy HH:mm:ss") : string.Empty;
            identificacao.COTM = cte.Empresa.COTM;
            identificacao.IndNegociavel = cte.IndicadorNegociavel != null ? (int)cte.IndicadorNegociavel : 0;
            identificacao.SubsTomador = cte.TipoCTE == Dominio.Enumeradores.TipoCTE.Substituto && cte.SubstituicaoTomador ? 1 : 0;

            return identificacao;
        }

        private ServicoCTe.Impostos ObterImpostosParaEmissao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unitOfWork)
        {
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoIntegracaoEmissorDocumento configuracaoIntegracaoEmissorDocumento = new Repositorio.Embarcador.Configuracoes.ConfiguracaoIntegracaoEmissorDocumento(unitOfWork).BuscarConfiguracaoPadrao();
            ServicoCTe.Impostos imposto = new ServicoCTe.Impostos();

            imposto.Aliquota = Math.Round((double)cte.AliquotaICMS, 2, MidpointRounding.AwayFromZero);
            imposto.CST = cte.CST;
            imposto.InformacoesAdicionais = cte.InformacaoAdicionalFisco;
            imposto.PercentualReducaoBC = Math.Round((double)cte.PercentualReducaoBaseCalculoICMS, 2, MidpointRounding.AwayFromZero);
            imposto.SimplesNacional = cte.SimplesNacional.ToString("d");
            imposto.Tipo = cte.CST;
            imposto.ValorBaseCalculo = Math.Round((double)cte.BaseCalculoICMS, 2, MidpointRounding.AwayFromZero);
            imposto.ValorBC_ICMS_ST_Retido = Math.Round((double)cte.BaseCalculoICMS, 2, MidpointRounding.AwayFromZero);
            imposto.ValorCredito = Math.Round((double)cte.ValorPresumido, 2, MidpointRounding.AwayFromZero);
            imposto.valorICMS = Math.Round((double)cte.ValorICMS, 2, MidpointRounding.AwayFromZero);
            imposto.ValorICMS_OutraUF = Math.Round((double)cte.ValorICMS, 2, MidpointRounding.AwayFromZero);
            imposto.ValorICMS_ST_Retido = Math.Round((double)cte.ValorICMS, 2, MidpointRounding.AwayFromZero);
            imposto.ExibeICMSNaDACTE = cte.ExibeICMSNaDACTE;

            imposto.AliquotaICMSInterestadual = cte.AliquotaICMS;
            imposto.AliquotaICMSUFFim = cte.AliquotaICMSInterna;
            imposto.BaseCalculoICMSUFFim = cte.BaseCalculoICMS;
            imposto.PercentualPartilhaICMS = cte.PercentualICMSPartilha;
            imposto.ValorICMSUFFim = cte.ValorICMSUFDestino;
            imposto.ValorICMSUFInicio = cte.ValorICMSUFOrigem;
            imposto.ValorICMSFCPFIM = cte.ValorICMSFCPFim;

            imposto.ValorCOFINS = cte.ValorCOFINS;
            imposto.ValorPIS = cte.ValorPIS;
            imposto.ValorINSS = cte.ValorINSS;
            imposto.ValorIR = cte.ValorIR;
            imposto.ValorCSLL = cte.ValorCSLL;
            imposto.ValorIcmsDesoneracao = cte.ValorICMSDesoneracao;
            imposto.CodigoBeneficio = cte.CodigoBeneficio;

            if (cte.OutrasAliquotas == null || cte.SimplesNacional == OpcaoSimNao.Sim || DateTime.Now <= configuracaoIntegracaoEmissorDocumento.DataLiberacaoImpostos)
                return imposto;

            imposto.CSTIBSCBS = cte.CSTIBSCBS;
            imposto.ClassificacaoTributariaIBSCBS = cte.ClassificacaoTributariaIBSCBS;
            imposto.ExigeIBSCBS = false;

            if (cte.CSTIBSCBS == "410")
                return imposto;

            imposto.ExigeIBSCBS = true;
            imposto.BaseCalculoIBSCBS = cte.BaseCalculoIBSCBS;

            imposto.AliquotaIBSEstadual = cte.AliquotaIBSEstadual;
            imposto.PercentualReducaoIBSEstadual = cte.PercentualReducaoIBSEstadual;
            imposto.AliquotaIBSEstadualEfetiva = cte.AliquotaIBSEstadualEfetiva;
            imposto.ValorIBSEstadual = cte.ValorIBSEstadual;

            imposto.AliquotaIBSMunicipal = cte.AliquotaIBSMunicipal;
            imposto.PercentualReducaoIBSMunicipal = cte.PercentualReducaoIBSMunicipal;
            imposto.AliquotaIBSMunicipalEfetiva = cte.AliquotaIBSMunicipalEfetiva;
            imposto.ValorIBSMunicipal = cte.ValorIBSMunicipal;

            imposto.ValorIBS = cte.ValorIBSEstadual + cte.ValorIBSMunicipal;

            imposto.AliquotaCBS = cte.AliquotaCBS;
            imposto.AliquotaCBSEfetiva = cte.AliquotaCBSEfetiva;
            imposto.PercentualReducaoCBS = cte.PercentualReducaoCBS;
            imposto.ValorCBS = cte.ValorCBS;

            return imposto;
        }

        private List<ServicoCTe.Seguros> ObterSegurosParaEmissao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.SeguroCTE repSeguro = new Repositorio.SeguroCTE(unitOfWork);

            List<Dominio.Entidades.SeguroCTE> listaSeguros = repSeguro.BuscarPorCTe(codigoEmpresa, cte.Codigo);

            if (listaSeguros.Count > 0)
            {
                List<ServicoCTe.Seguros> listaSegurosRetorno = new List<ServicoCTe.Seguros>();

                foreach (Dominio.Entidades.SeguroCTE seguro in listaSeguros)
                {
                    ServicoCTe.Seguros segRetorno = new ServicoCTe.Seguros();

                    segRetorno.NumeroApolice = string.IsNullOrWhiteSpace(seguro.NumeroApolice) ? cte.ModalTransporte?.Numero == "06" ? "99999" : string.Empty : seguro.NumeroApolice;
                    segRetorno.NumeroAverbacao = string.IsNullOrWhiteSpace(seguro.NumeroAverbacao) ? cte.ModalTransporte?.Numero == "06" ? "99999" : string.Empty : seguro.NumeroAverbacao.Length > 20 ? seguro.NumeroAverbacao.Substring(0, 20) : seguro.NumeroAverbacao;
                    segRetorno.Responsavel = (int)seguro.Tipo;
                    segRetorno.Seguradora = seguro.NomeSeguradora;
                    segRetorno.ValorCarga = Math.Round((double)seguro.Valor, 2, MidpointRounding.AwayFromZero);
                    segRetorno.CNPJ = seguro.CNPJSeguradora;

                    listaSegurosRetorno.Add(segRetorno);
                }

                return listaSegurosRetorno;
            }
            else
            {
                return null;
            }
        }

        private ServicoCTe.ValoresPrestacao ObterValorDaPrestacaoParaEmissao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork)
        {
            ServicoCTe.ValoresPrestacao valorDaPrestacao = new ServicoCTe.ValoresPrestacao();

            valorDaPrestacao.valorReceber = Math.Round((double)cte.ValorAReceber, 2, MidpointRounding.AwayFromZero);
            valorDaPrestacao.ValorTotal = Math.Round((double)cte.ValorPrestacaoServico, 2, MidpointRounding.AwayFromZero);

            /// <summary>
            /// O total geral do DFe deverá ser a soma do total da prestação + IBS + CBS
            /// Exceção: Em 2026 não somar IBS e CBS
            /// </summary>
            DateTime dataLiberacaoSomarIBSCBSTotalDocumentoFiscal = new Repositorio.Embarcador.Configuracoes.ConfiguracaoIntegracaoEmissorDocumento(unitOfWork).BuscarConfiguracaoPadrao().DataLiberacaoSomarIBSCBSTotalDocumentoFiscal;
            decimal valorTotalDocumento = dataLiberacaoSomarIBSCBSTotalDocumentoFiscal == DateTime.MinValue || DateTime.Now.Year < dataLiberacaoSomarIBSCBSTotalDocumentoFiscal.Year ? 0 : (cte.ValorIBSMunicipal + cte.ValorIBSEstadual + cte.ValorCBS);
            valorDaPrestacao.ValorTotalDocumentoFiscal = Math.Round((double)(cte.ValorPrestacaoServico + valorTotalDocumento), 2, MidpointRounding.AwayFromZero);

            Repositorio.ComponentePrestacaoCTE repComponentesPrestacao = new Repositorio.ComponentePrestacaoCTE(unitOfWork);
            List<Dominio.Entidades.ComponentePrestacaoCTE> listaComponentesDaPrestacao = repComponentesPrestacao.BuscarPorCTe(codigoEmpresa, cte.Codigo);

            if (listaComponentesDaPrestacao.Count > 0)
            {
                valorDaPrestacao.Complementos = new List<ServicoCTe.ComplementoValoresPrestacao>();
                foreach (Dominio.Entidades.ComponentePrestacaoCTE componente in listaComponentesDaPrestacao)
                {
                    ServicoCTe.ComplementoValoresPrestacao complemento = new ServicoCTe.ComplementoValoresPrestacao();
                    complemento.NomeComponente = cte.TipoCTE == Dominio.Enumeradores.TipoCTE.Complemento && componente.Nome == "FRETE VALOR" && !string.IsNullOrWhiteSpace(cte.DescricaoComplemento) ? cte.DescricaoComplemento.ToUpper() : componente.Nome;
                    complemento.ValorComponente = Math.Round((double)componente.Valor, 2, MidpointRounding.AwayFromZero);
                    valorDaPrestacao.Complementos.Add(complemento);
                }
            }

            return valorDaPrestacao;
        }

        private ServicoCTe.InformacoesCarga ObterInformacaoDaCargaParaEmissao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork)
        {
            ServicoCTe.InformacoesCarga infoCarga = new ServicoCTe.InformacoesCarga();

            infoCarga.OutrasCaracteristicas = cte.OutrasCaracteristicasDaCarga;
            infoCarga.ProdutoPredominante = cte.ProdutoPredominante;
            infoCarga.ValorTotalCarga = Math.Round((double)cte.ValorTotalMercadoria, 2, MidpointRounding.AwayFromZero);
            infoCarga.ValorCargaAverbacao = cte.ValorCarbaAverbacao > 0 ? Math.Round((double)cte.ValorCarbaAverbacao, 2, MidpointRounding.AwayFromZero) : infoCarga.ValorTotalCarga;

            Repositorio.InformacaoCargaCTE repInformacaoDaCarga = new Repositorio.InformacaoCargaCTE(unitOfWork);

            List<Dominio.Entidades.InformacaoCargaCTE> listaInformacaoCarga = repInformacaoDaCarga.BuscarPorCTe(codigoEmpresa, cte.Codigo);

            if (listaInformacaoCarga.Count > 0)
            {
                infoCarga.QtdeCarga = new List<ServicoCTe.QuantidadesCarga>();

                foreach (Dominio.Entidades.InformacaoCargaCTE informacao in listaInformacaoCarga)
                {
                    ServicoCTe.QuantidadesCarga quantidade = new ServicoCTe.QuantidadesCarga();

                    quantidade.Quantidade = informacao.Quantidade;
                    if (informacao.UnidadeMedida == "99")
                        quantidade.Unidade = "00";
                    else
                        quantidade.Unidade = informacao.UnidadeMedida;
                    if (quantidade.Unidade == "01" && cte.Empresa.Configuracao != null && !string.IsNullOrWhiteSpace(cte.Empresa.Configuracao.DescricaoMedidaKgCTe) && (informacao.Tipo == "KG" || informacao.Tipo == "Quilograma"))
                        quantidade.TipoMedida = cte.Empresa.Configuracao.DescricaoMedidaKgCTe;
                    else
                        quantidade.TipoMedida = informacao.Tipo;

                    infoCarga.QtdeCarga.Add(quantidade);

                }
            }

            return infoCarga;
        }

        private List<ServicoCTe.NotasFiscais> ObterNotasFiscaisRemetenteParaEmissao(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.Entidades.Empresa empresa, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.DocumentosCTE repDocumentosCTe = new Repositorio.DocumentosCTE(unitOfWork);
            Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unitOfWork);
            Repositorio.Embarcador.CTe.CTeContainerDocumento repCTeContainerDocumento = new Repositorio.Embarcador.CTe.CTeContainerDocumento(unitOfWork);

            List<Dominio.Entidades.DocumentosCTE> listaDocumentos = repDocumentosCTe.BuscarPorCTe(empresa.Codigo, cte.Codigo);

            if (listaDocumentos.Count > 0)
            {
                List<ServicoCTe.NotasFiscais> listaNotasRetorno = new List<ServicoCTe.NotasFiscais>();

                foreach (Dominio.Entidades.DocumentosCTE documento in listaDocumentos)
                {
                    ServicoCTe.NotasFiscais notaFiscal = new ServicoCTe.NotasFiscais();

                    notaFiscal.BairroRet = string.Empty;
                    notaFiscal.CFOP = -1;
                    notaFiscal.ChaveNFE = string.Empty;
                    notaFiscal.CidadeRet = string.Empty;
                    notaFiscal.CNPJ_Retirada = string.Empty;
                    notaFiscal.CodigoCidadeRet = -1;
                    notaFiscal.ComplementoRet = string.Empty;
                    notaFiscal.CPF_Retirada = string.Empty;
                    notaFiscal.DataEmissaoNF = string.Empty;
                    notaFiscal.DescricaoOutros = string.Empty;
                    notaFiscal.LogradouroRet = string.Empty;
                    notaFiscal.Modelo = documento.ModeloDocumentoFiscal != null ? documento.ModeloDocumentoFiscal.Numero.ToString() : "55";
                    notaFiscal.NomeRazaoRet = string.Empty;
                    notaFiscal.NumeroNotaFiscal = string.Empty;
                    notaFiscal.NumeroRet = string.Empty;
                    notaFiscal.Pedido = string.Empty;
                    notaFiscal.Peso = -1;
                    notaFiscal.PIN_Suframa = -1;
                    notaFiscal.Romaneio = string.Empty;
                    notaFiscal.Serie = string.Empty;
                    notaFiscal.TipoDocumento = string.Empty;
                    notaFiscal.UFRet = string.Empty;
                    notaFiscal.ValorBaseCalculo = -1;
                    notaFiscal.ValorBCST = -1;
                    notaFiscal.ValorICMS = -1;
                    notaFiscal.ValorProdutos = -1;
                    notaFiscal.ValorST = -1;
                    notaFiscal.ValorTotalNotaFiscal = -1;

                    if (documento.ModeloDocumentoFiscal == null || documento.ModeloDocumentoFiscal.Numero.Equals("55"))
                    {
                        notaFiscal.ChaveNFE = documento.ChaveNFE;
                        notaFiscal.TipoDocumento = "1";
                    }
                    else if (documento.ModeloDocumentoFiscal.Numero.Equals("00") || documento.ModeloDocumentoFiscal.Numero.Equals("99"))
                    {
                        int.TryParse(documento.Numero, out int numeroDocumento);

                        notaFiscal.DataEmissaoNF = documento.DataEmissao.ToString("yyyy-MM-dd");
                        notaFiscal.DescricaoOutros = documento.Descricao;
                        notaFiscal.NumeroNotaFiscal = numeroDocumento == 0 && !string.IsNullOrWhiteSpace(documento.Numero) ? Utilidades.String.Left(documento.Numero, 20) : numeroDocumento.ToString();
                        notaFiscal.TipoDocumento = "2";
                        notaFiscal.ValorTotalNotaFiscal = Math.Round((double)documento.Valor, 2, MidpointRounding.AwayFromZero);
                    }
                    else if (documento.ModeloDocumentoFiscal.Numero.Equals("01") || documento.ModeloDocumentoFiscal.Numero.Equals("04"))
                    {
                        int pin = 0;
                        int.TryParse(documento.PINSuframa, out pin);
                        int.TryParse(documento.Numero, out int numeroDocumento);

                        notaFiscal.CFOP = !string.IsNullOrWhiteSpace(documento.CFOP) ? int.Parse(documento.CFOP) : -1;
                        notaFiscal.DataEmissaoNF = documento.DataEmissao.ToString("yyyy-MM-dd");
                        notaFiscal.NumeroNotaFiscal = numeroDocumento == 0 && !string.IsNullOrWhiteSpace(documento.Numero) ? Utilidades.String.Left(documento.Numero, 20) : numeroDocumento.ToString();
                        notaFiscal.Peso = Math.Round((double)documento.Peso, 2, MidpointRounding.AwayFromZero);
                        notaFiscal.PIN_Suframa = string.IsNullOrWhiteSpace(documento.PINSuframa) ? -1 : pin;
                        notaFiscal.Serie = documento.Serie;
                        notaFiscal.TipoDocumento = "0";
                        notaFiscal.ValorBaseCalculo = Math.Round((double)documento.BaseCalculoICMS, 2, MidpointRounding.AwayFromZero);
                        notaFiscal.ValorBCST = Math.Round((double)documento.BaseCalculoICMSST, 2, MidpointRounding.AwayFromZero);
                        notaFiscal.ValorICMS = Math.Round((double)documento.ValorICMS, 2, MidpointRounding.AwayFromZero);
                        notaFiscal.ValorProdutos = Math.Round((double)documento.ValorProdutos, 2, MidpointRounding.AwayFromZero);
                        notaFiscal.ValorST = Math.Round((double)documento.ValorICMSST, 2, MidpointRounding.AwayFromZero);
                        notaFiscal.ValorTotalNotaFiscal = Math.Round((double)documento.Valor, 2, MidpointRounding.AwayFromZero);
                    }
                    if (documento.CTE != null)
                    {
                        Dominio.Entidades.Embarcador.CTe.CTeContainerDocumento containerDocumento = repCTeContainerDocumento.BuscarPorCTeChave(documento.CTE.Codigo, notaFiscal.ChaveNFE);
                        if (containerDocumento != null)
                        {
                            notaFiscal.IdentificacaoUnidadeCarga = containerDocumento.ContainerCTE.Container?.Numero ?? "";
                            notaFiscal.Lacre1 = containerDocumento.ContainerCTE.Lacre1;
                            notaFiscal.Lacre2 = containerDocumento.ContainerCTE.Lacre2;
                            notaFiscal.Lacre3 = containerDocumento.ContainerCTE.Lacre3;
                        }
                    }
                    if (notaFiscal.PIN_Suframa <= 0 && (cte.TipoModal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Aquaviario || cte.TipoModal == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoModal.Multimodal))
                    {
                        int numeroDocumento = 0;
                        int.TryParse(documento.Numero, out numeroDocumento);
                        string pinSuframaDigitado = repXMLNotaFiscal.BuscarPINSuframaPorDocumentoCTe(documento, numeroDocumento);
                        int pin = 0;
                        int.TryParse(pinSuframaDigitado, out pin);
                        notaFiscal.PIN_Suframa = string.IsNullOrWhiteSpace(pinSuframaDigitado) ? -1 : pin;
                    }

                    if (!empresa.IgnorarDocumentosDuplicadosNaEmissaoCTe)
                        listaNotasRetorno.Add(notaFiscal);
                    else if (string.IsNullOrWhiteSpace(notaFiscal.ChaveNFE) || !listaNotasRetorno.Any(d => d.ChaveNFE == notaFiscal.ChaveNFE))
                        listaNotasRetorno.Add(notaFiscal);
                }

                return listaNotasRetorno;
            }
            else
            {
                return null;
            }
        }

        private ServicoCTe.Empresa ObterEmpresaEmitente(Dominio.Entidades.Empresa empresa)
        {
            ServicoCTe.Empresa empresaEmitente = new ServicoCTe.Empresa();
            empresaEmitente.Bairro = Utilidades.String.Left(empresa.Bairro, 60);
            empresaEmitente.Cep = Utilidades.String.OnlyNumbers(empresa.CEP);
            empresaEmitente.Cidade = Utilidades.String.Left(empresa.Localidade.Descricao, 60);
            empresaEmitente.CNPJ = Utilidades.String.OnlyNumbers(empresa.CNPJ);
            empresaEmitente.CodigoCidadeIBGE = empresa.Localidade.CodigoIBGE;
            empresaEmitente.Complemento = Utilidades.String.Left(empresa.Complemento, 60);
            empresaEmitente.EmailContador = empresa.EmailContador;
            empresaEmitente.EmailEmitente = empresa.Email;
            empresaEmitente.EnviaEmailContador = empresa.StatusEmail;
            empresaEmitente.EnviaEmailEmitente = empresa.StatusEmailContador;
            empresaEmitente.IE = string.IsNullOrWhiteSpace(empresa.InscricaoEstadual) ? "ISENTO" : empresa.InscricaoEstadual;
            empresaEmitente.Logradouro = Utilidades.String.Left(empresa.Endereco, 255);
            empresaEmitente.NomeContador = Utilidades.String.Left(empresa.NomeContador, 60);
            empresaEmitente.NomeFantasia = Utilidades.String.Left(empresa.NomeFantasia, 60);
            empresaEmitente.NomeRazao = Utilidades.String.Left(empresa.RazaoSocial, 60);
            empresaEmitente.Numero = Utilidades.String.Left(empresa.Numero, 60);
            empresaEmitente.Status = empresa.Status;
            empresaEmitente.Telefone = Utilidades.String.OnlyNumbers(empresa.Telefone);
            empresaEmitente.TelefoneContador = Utilidades.String.OnlyNumbers(empresa.TelefoneContador);
            empresaEmitente.UF = empresa.Localidade.Estado.Sigla;
            return empresaEmitente;
        }

        private string ObterInscricaoST(Dominio.Entidades.Empresa empresa, Dominio.Entidades.Localidade origem, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Transportadores.TransportadorInscricaoST repTransportadorInscricaoST = new Repositorio.Embarcador.Transportadores.TransportadorInscricaoST(unitOfWork);

            Dominio.Entidades.Embarcador.Transportadores.TransportadorInscricaoST transportadorInscricaoST = repTransportadorInscricaoST.BuscarPorEmpresaEEstado(empresa.Codigo, origem.Estado.Sigla);

            return transportadorInscricaoST?.InscricaoST ?? null;
        }

        private List<ServicoCTe.PercursoCTe> ObterPercurso(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.PercursoCTe repPercursoCTe = new Repositorio.PercursoCTe(unitOfWork);

            List<Dominio.Entidades.PercursoCTe> listaPercurso = repPercursoCTe.BuscarPorCTe(cte.Codigo);
            List<ServicoCTe.PercursoCTe> listaPercursoIntegrar = new List<ServicoCTe.PercursoCTe>();

            foreach (Dominio.Entidades.PercursoCTe percurso in listaPercurso)
            {
                ServicoCTe.PercursoCTe percursoIntegrar = new ServicoCTe.PercursoCTe();

                percursoIntegrar.UF = percurso.Estado.Sigla;

                listaPercursoIntegrar.Add(percursoIntegrar);
            }

            return listaPercursoIntegrar;
        }

        private List<ServicoCTe.ObservacoesContFisc> ObterObservacoesDoContribuinte(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ObservacaoContribuinteCTE repObservacaoContribuinteCTe = new Repositorio.ObservacaoContribuinteCTE(unitOfWork);

            List<Dominio.Entidades.ObservacaoContribuinteCTE> listaObservacoes = repObservacaoContribuinteCTe.BuscarPorCTe(codigoEmpresa, cte.Codigo);
            List<ServicoCTe.ObservacoesContFisc> listaObservacoesContribuinte = new List<ServicoCTe.ObservacoesContFisc>();

            int qtdObservacos = 0;
            foreach (Dominio.Entidades.ObservacaoContribuinteCTE observacao in listaObservacoes)
            {
                if (qtdObservacos < 10)//Tratativa da SEFAZ
                {
                    ServicoCTe.ObservacoesContFisc obsCont = new ServicoCTe.ObservacoesContFisc();

                    obsCont.Campo = string.IsNullOrWhiteSpace(observacao.Identificador) ? "OBS CONTRIBUINTE" : observacao.Identificador.Left(20);
                    obsCont.Tipo = "C";
                    obsCont.Texto = observacao.Descricao.Left(160);

                    listaObservacoesContribuinte.Add(obsCont);
                    qtdObservacos++;
                }
            }

            return listaObservacoesContribuinte;
        }

        private List<ServicoCTe.ObservacoesContFisc> ObterObservacoesDoFisco(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, int codigoEmpresa, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.ObservacaoFiscoCTE repObservacaoFiscoCTe = new Repositorio.ObservacaoFiscoCTE(unitOfWork);

            List<Dominio.Entidades.ObservacaoFiscoCTE> listaObservacoes = repObservacaoFiscoCTe.BuscarPorCTe(codigoEmpresa, cte.Codigo);
            List<ServicoCTe.ObservacoesContFisc> listaObservacoesContribuinte = new List<ServicoCTe.ObservacoesContFisc>();

            foreach (Dominio.Entidades.ObservacaoFiscoCTE observacao in listaObservacoes)
            {
                ServicoCTe.ObservacoesContFisc obsCont = new ServicoCTe.ObservacoesContFisc();

                obsCont.Campo = string.IsNullOrWhiteSpace(observacao.Identificador) ? "OBS FISCO" : observacao.Identificador.Left(20);
                obsCont.Tipo = "F";
                obsCont.Texto = observacao.Descricao.Left(160);

                listaObservacoesContribuinte.Add(obsCont);
            }

            return listaObservacoesContribuinte;
        }

        private ServicoCTe.ObservacoesContFisc ObterObservacaoGeral(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte)
        {
            ServicoCTe.ObservacoesContFisc obsGeral = new ServicoCTe.ObservacoesContFisc();

            obsGeral.Campo = "OBSERVACAO";
            obsGeral.Tipo = "O";
            obsGeral.Texto = Utilidades.String.ReplaceInvalidCharacters(cte.ObservacoesGerais);

            if (!string.IsNullOrWhiteSpace(cte.ObservacoesAvancadas))
                obsGeral.Texto += (string.IsNullOrWhiteSpace(obsGeral.Texto) ? "" : " - ") + cte.ObservacoesAvancadas;

            //obsGeral.Texto = obsGeral.Texto.Left(160);

            return obsGeral;
        }

        #endregion

        private void GerarOutroDocumentoCTe(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.DocumentosCTE repDocumentoCTe = new Repositorio.DocumentosCTE(unitOfWork);
            Repositorio.ModeloDocumentoFiscal repModeloDocumentoFiscal = new Repositorio.ModeloDocumentoFiscal(unitOfWork);

            Dominio.Entidades.DocumentosCTE documento = new Dominio.Entidades.DocumentosCTE
            {
                CTE = cte,
                DataEmissao = cte.DataEmissao ?? DateTime.Now,
                Descricao = "Outros",
                Numero = cte.Numero.ToString("D"),
                ModeloDocumentoFiscal = repModeloDocumentoFiscal.BuscarPorModelo("99"),
                Valor = cte.ValorTotalMercadoria
            };

            repDocumentoCTe.Inserir(documento);
        }

        private string SequenciaParaLetra(int index)
        {
            try
            {
                string letters = "ABCDEFGHIJKLNOPQRSTUVWXYZ";
                int baseLength = letters.Length;
                StringBuilder result = new StringBuilder();

                int currentNumber = index - 1;

                do
                {
                    result.Insert(0, letters[currentNumber % baseLength]);
                    currentNumber /= baseLength;
                    currentNumber--;
                } while (currentNumber >= 0);

                return result.ToString();

            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Erro ao obter sequencia da letra " + index + " " + ex);
                return "A";
            }

            //try
            //{
            //    const string letters = "ABCDEFGHIJKLNOPQRSTUVWXYZ";

            //    string value = "";

            //    if (index >= letters.Length)
            //    {
            //        int pos = index / letters.Length - 1;
            //        if (pos > letters.Length)
            //        {
            //            value += "A";
            //            pos = pos - letters.Length;
            //        }
            //        value += letters[pos];
            //    }

            //    value += letters[index % letters.Length];

            //    return value;
            //}
            //catch (Exception ex)
            //{
            //    Servicos.Log.TratarErro("Erro ao obter sequencia da letra " + index + " " + ex);
            //    return "A";
            //}
        }

        public string SequenciaParaLetraOLD(int sequencia)
        {
            if (sequencia >= 13)
            {
                sequencia = sequencia + 1;
                if (sequencia >= 35)
                    sequencia = sequencia + 2;
                decimal resto = sequencia / 26;
                if (resto < 1)
                    resto = 1;
                sequencia += (int)resto;
            }

            string columnString = "";
            decimal columnNumber = sequencia;
            while (columnNumber > 0)
            {
                decimal currentLetterNumber = (columnNumber - 1) % 26;
                char currentLetter = (char)(currentLetterNumber + 65);
                columnString = currentLetter + columnString;
                columnNumber = (columnNumber - (currentLetterNumber + 1)) / 26;
            }
            return columnString;
        }

        public Dominio.Entidades.Atividade ObterAtividade(int codigoEmpresa, Repositorio.UnitOfWork unidadeDeTrabalho = null)
        {
            unidadeDeTrabalho = unidadeDeTrabalho ?? new Repositorio.UnitOfWork(StringConexao);

            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(unidadeDeTrabalho);

            Dominio.Entidades.Empresa empresa = repEmpresa.BuscarPorCodigo(codigoEmpresa);

            if (empresa.Configuracao != null && empresa.Configuracao.Atividade != null)
            {
                return empresa.Configuracao.Atividade;
            }
            else if (empresa.EmpresaPai != null && empresa.EmpresaPai.Configuracao != null && empresa.EmpresaPai.Configuracao.Atividade != null)
            {
                return empresa.EmpresaPai.Configuracao.Atividade;
            }
            else
            {
                Repositorio.Atividade repAtividade = new Repositorio.Atividade(unidadeDeTrabalho);
                return repAtividade.BuscarPorCodigo(3);
            }
        }

        /// <summary>
        /// Obtém a série existente e se não existir a cadastra.
        /// </summary>
        private Dominio.Entidades.EmpresaSerie ObterSerie(Dominio.Entidades.Empresa empresa, int serie, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.EmpresaSerie repSerie = new Repositorio.EmpresaSerie(unidadeDeTrabalho);
            Dominio.Entidades.EmpresaSerie empSerie = repSerie.BuscarPorSerie(empresa.Codigo, serie, Dominio.Enumeradores.TipoSerie.CTe);
            if (empSerie == null)
            {
                empSerie = new Dominio.Entidades.EmpresaSerie();
                empSerie.Empresa = empresa;
                empSerie.Numero = serie;
                empSerie.Status = "A";
                empSerie.Tipo = Dominio.Enumeradores.TipoSerie.CTe;
                repSerie.Inserir(empSerie);
            }
            return empSerie;
        }

        /// <summary>
        /// Obtém a CFOP existente e se não existir a cadastra.
        /// </summary>
        private Dominio.Entidades.CFOP ObterCFOP(int cfop, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            Repositorio.CFOP repCFOP = new Repositorio.CFOP(unidadeDeTrabalho);
            Repositorio.NaturezaDaOperacao repNaturezaOperacao = new Repositorio.NaturezaDaOperacao(unidadeDeTrabalho);
            Dominio.Entidades.CFOP _cfop = repCFOP.BuscarPorNumero(cfop);
            if (_cfop == null)
            {
                _cfop = new Dominio.Entidades.CFOP();
                _cfop.CodigoCFOP = cfop;
                _cfop.NaturezaDaOperacao = repNaturezaOperacao.BuscarPrimeiroRegistro();
                _cfop.Status = "A";
                repCFOP.Inserir(_cfop);
            }
            return _cfop;
        }

        private void SalvarObservacoesValePedagio(ref Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            try
            {
                Repositorio.VeiculoCTE repVeiculoCTe = new Repositorio.VeiculoCTE(unidadeDeTrabalho);
                Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unidadeDeTrabalho);

                List<Dominio.Entidades.VeiculoCTE> veiculosCTe = repVeiculoCTe.BuscarPorCTe(cte.Codigo);

                foreach (Dominio.Entidades.VeiculoCTE veiculoCTe in veiculosCTe)
                {
                    //Dominio.Entidades.Veiculo veiculo = repVeiculo.BuscarPorPlaca(cte.Empresa.Codigo, veiculoCTe.Placa);
                    //if (veiculo == null)
                    //    veiculo = repVeiculo.BuscarPorPlaca(veiculoCTe.Placa);

                    if (veiculoCTe.Veiculo != null && veiculoCTe.Veiculo.TipoVeiculo == "0" && !string.IsNullOrWhiteSpace(veiculoCTe.Veiculo.NumeroCompraValePedagio) && veiculoCTe.Veiculo.FornecedorValePedagio != null)
                    {
                        string obsValePedagioFornecedor = veiculoCTe.Veiculo.FornecedorValePedagio != null ? " Fornecedor " + veiculoCTe.Veiculo.FornecedorValePedagio.CPF_CNPJ_SemFormato + " " + veiculoCTe.Veiculo.FornecedorValePedagio.Nome : string.Empty;
                        string obsValePedagioResponsavel = veiculoCTe.Veiculo.ResponsavelValePedagio != null ? " Responsável " + veiculoCTe.Veiculo.ResponsavelValePedagio.CPF_CNPJ_SemFormato + " " + veiculoCTe.Veiculo.ResponsavelValePedagio.Nome : string.Empty;
                        string obsValePedagioNumeroCompra = veiculoCTe.Veiculo.NumeroCompraValePedagio != null ? " Número Comprovante Compra " + veiculoCTe.Veiculo.NumeroCompraValePedagio : string.Empty;
                        string obsValePedagioValor = veiculoCTe.Veiculo.ValorValePedagio > 0 ? " Valor " + veiculoCTe.Veiculo.ValorValePedagio.ToString() : string.Empty;

                        string obsValePedagio = string.Concat("VALE PEDAGIO:", obsValePedagioFornecedor, obsValePedagioResponsavel, obsValePedagioNumeroCompra, obsValePedagioValor, ". ");

                        cte.ObservacoesGerais = string.IsNullOrWhiteSpace(cte.ObservacoesGerais) ? obsValePedagio : string.Concat(obsValePedagio, " / ", cte.ObservacoesGerais);

                        break;
                    }
                }
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Erro ao informar observação vale pedágio CTe: " + ex);
            }

        }

        private bool AdicionarCTeNaCarga(Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, Dominio.ObjetosDeValor.WebService.Carga.CargaIntegracao cargaIntegracao, Dominio.Entidades.Embarcador.Cargas.Carga carga, Dominio.Entidades.Embarcador.Cargas.CargaPedido cargaPedido, Repositorio.UnitOfWork unidadeDeTrabalho)
        {
            try
            {
                Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe repCargaPedidoXMLNotaFiscalCTe = new Repositorio.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe(unidadeDeTrabalho);
                Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal repPedidoXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.PedidoXMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.Embarcador.Pedidos.XMLNotaFiscal repXMLNotaFiscal = new Repositorio.Embarcador.Pedidos.XMLNotaFiscal(unidadeDeTrabalho);
                Repositorio.Embarcador.Cargas.CargaCTe repCargaCTe = new Repositorio.Embarcador.Cargas.CargaCTe(unidadeDeTrabalho);
                Repositorio.DocumentosCTE repDocumentoCTE = new Repositorio.DocumentosCTE(unidadeDeTrabalho);
                Repositorio.Cliente repCliente = new Repositorio.Cliente(unidadeDeTrabalho);
                Repositorio.Veiculo repVeiculo = new Repositorio.Veiculo(unidadeDeTrabalho);

                Dominio.Entidades.Embarcador.Cargas.CargaCTe cargaCTe = repCargaCTe.BuscarPorCTe(cte.Codigo);
                if (cargaCTe == null)
                {
                    cargaCTe = new Dominio.Entidades.Embarcador.Cargas.CargaCTe();
                    cargaCTe.Carga = carga;
                    cargaCTe.CargaOrigem = carga;
                    cargaCTe.CTe = cte;
                    cargaCTe.SistemaEmissor = SistemaEmissor.MultiCTe;
                    repCargaCTe.Inserir(cargaCTe);
                }

                List<Dominio.Entidades.DocumentosCTE> listaDocumentosCTe = repDocumentoCTE.BuscarPorCTe(cte.Codigo);
                foreach (Dominio.Entidades.DocumentosCTE documentoCTe in listaDocumentosCTe)
                {
                    Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal xmlNotaFiscal = new Dominio.Entidades.Embarcador.Pedidos.XMLNotaFiscal();

                    xmlNotaFiscal.Emitente = repCliente.BuscarPorCPFCNPJ(double.Parse(cte.Remetente.CPF_CNPJ));
                    if (!string.IsNullOrWhiteSpace(cte.Destinatario.CPF_CNPJ))
                        xmlNotaFiscal.Destinatario = repCliente.BuscarPorCPFCNPJ(double.Parse(cte.Destinatario.CPF_CNPJ));
                    xmlNotaFiscal.CNPJTranposrtador = cte.Empresa.CNPJ;
                    xmlNotaFiscal.Empresa = cte.Empresa;
                    xmlNotaFiscal.Chave = documentoCTe.ChaveNFE;
                    xmlNotaFiscal.TipoEmissao = Utilidades.Chave.ObterTipoEmissao(xmlNotaFiscal.Chave).ToString().ToEnum<TipoEmissaoNotaFiscal>();
                    int numeroNFe = 0;
                    int.TryParse(documentoCTe.Numero, out numeroNFe);
                    xmlNotaFiscal.Numero = numeroNFe;
                    xmlNotaFiscal.Serie = documentoCTe.Serie;
                    xmlNotaFiscal.DataEmissao = documentoCTe.DataEmissao;
                    xmlNotaFiscal.Valor = documentoCTe.Valor > 0 ? documentoCTe.Valor : cte.ValorTotalMercadoria / listaDocumentosCTe.Count();
                    xmlNotaFiscal.ValorFrete = cte.ValorAReceber / listaDocumentosCTe.Count();
                    xmlNotaFiscal.Peso = documentoCTe.Peso > 0 ? documentoCTe.Peso : cargaIntegracao.PesoBruto / listaDocumentosCTe.Count();
                    xmlNotaFiscal.PesoBaseParaCalculo = xmlNotaFiscal.Peso;
                    xmlNotaFiscal.XML = string.Empty;
                    xmlNotaFiscal.PlacaVeiculoNotaFiscal = cargaIntegracao.Veiculo != null ? cargaIntegracao.Veiculo.Placa : string.Empty;
                    xmlNotaFiscal.nfAtiva = true;
                    xmlNotaFiscal.DataRecebimento = DateTime.Now;

                    repXMLNotaFiscal.Inserir(xmlNotaFiscal);

                    Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal pedidoXMLNotaFiscal = new Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal();
                    pedidoXMLNotaFiscal.XMLNotaFiscal = xmlNotaFiscal;
                    pedidoXMLNotaFiscal.CargaPedido = cargaPedido;
                    pedidoXMLNotaFiscal.CFOP = cte.CFOP;
                    pedidoXMLNotaFiscal.CST = cte.CST;
                    pedidoXMLNotaFiscal.PercentualAliquota = cte.AliquotaICMS;
                    pedidoXMLNotaFiscal.PercentualIncluirBaseCalculo = cte.PercentualICMSIncluirNoFrete;
                    pedidoXMLNotaFiscal.BaseCalculoICMS = cte.BaseCalculoICMS;
                    pedidoXMLNotaFiscal.ValorICMS = cte.ValorICMS;
                    pedidoXMLNotaFiscal.ValorFrete = cte.ValorAReceber / listaDocumentosCTe.Count();
                    pedidoXMLNotaFiscal.Peso = documentoCTe.Peso > 0 ? documentoCTe.Peso : cargaIntegracao.PesoBruto / listaDocumentosCTe.Count();
                    pedidoXMLNotaFiscal.DescontarICMSDoValorAReceber = cte.CST == "60" ? (cte.ValorAReceber + cte.ValorICMS == cte.ValorPrestacaoServico) : false;

                    pedidoXMLNotaFiscal.ValorISS = cte.ValorISS;
                    pedidoXMLNotaFiscal.BaseCalculoISS = cte.BaseCalculoISS;
                    pedidoXMLNotaFiscal.PercentualAliquotaISS = cte.AliquotaISS;
                    pedidoXMLNotaFiscal.PercentualRetencaoISS = cte.PercentualISSRetido;
                    pedidoXMLNotaFiscal.ValorRetencaoISS = cte.ValorISSRetido;
                    pedidoXMLNotaFiscal.IncluirISSBaseCalculo = cte.IncluirISSNoFrete == Dominio.Enumeradores.OpcaoSimNao.Sim;
                    pedidoXMLNotaFiscal.BaseCalculoIBSCBS = cte.BaseCalculoIBSCBS;
                    pedidoXMLNotaFiscal.ValorCBS = cte.ValorCBS;
                    pedidoXMLNotaFiscal.ValorIBSEstadual = cte.ValorIBSEstadual;
                    pedidoXMLNotaFiscal.ValorIBSMunicipal = cte.ValorIBSMunicipal;
                    pedidoXMLNotaFiscal.AliquotaCBS = cte.AliquotaCBS;
                    pedidoXMLNotaFiscal.AliquotaIBSEstadual = cte.AliquotaIBSEstadual;
                    pedidoXMLNotaFiscal.AliquotaIBSMunicipal = cte.AliquotaIBSMunicipal;
                    pedidoXMLNotaFiscal.PercentualReducaoIBSEstadual = cte.PercentualReducaoIBSEstadual;
                    pedidoXMLNotaFiscal.PercentualReducaoIBSMunicipal = cte.PercentualReducaoIBSMunicipal;
                    pedidoXMLNotaFiscal.PercentualReducaoCBS = cte.PercentualReducaoCBS;
                    pedidoXMLNotaFiscal.OutrasAliquotas = cte.OutrasAliquotas;
                    pedidoXMLNotaFiscal.NBS = cte.NBS;
                    pedidoXMLNotaFiscal.CodigoIndicadorOperacao = cte.CodigoIndicadorOperacao;
                    pedidoXMLNotaFiscal.CSTIBSCBS = cte.CSTIBSCBS;
                    pedidoXMLNotaFiscal.ClassificacaoTributariaIBSCBS = cte.ClassificacaoTributariaIBSCBS;

                    pedidoXMLNotaFiscal.BaseCalculoIR = cte.ValorBaseCalculoIR;
                    pedidoXMLNotaFiscal.AliquotaIR = cte.AliquotaIR;
                    pedidoXMLNotaFiscal.ValorIR = cte.ValorIR;

                    Servicos.Log.TratarErro($"Atualizando AdicionarCTeNaCarga pedidoXmlNotaFiscal = {pedidoXMLNotaFiscal.Codigo} com valorISS = {pedidoXMLNotaFiscal.ValorISS} e incluirISSBaseCalculo = {pedidoXMLNotaFiscal.IncluirISSBaseCalculo}, valorRetencaoISS = {pedidoXMLNotaFiscal.ValorRetencaoISS}", "AtualizarPedidoXMLNotaFiscal");

                    repPedidoXMLNotaFiscal.Inserir(pedidoXMLNotaFiscal);

                    Dominio.Entidades.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe cargaPedidoXMLNotaFiscalCTe = new Dominio.Entidades.Embarcador.Cargas.CargaPedidoXMLNotaFiscalCTe();
                    cargaPedidoXMLNotaFiscalCTe.CargaCTe = cargaCTe;
                    cargaPedidoXMLNotaFiscalCTe.PedidoXMLNotaFiscal = pedidoXMLNotaFiscal;

                    repCargaPedidoXMLNotaFiscalCTe.Inserir(cargaPedidoXMLNotaFiscalCTe);
                }

                return true;
            }
            catch (Exception ex)
            {
                Servicos.Log.TratarErro("Erro ao adicionar CTe na carga: " + ex);
                throw;
            }
        }

        private bool VerificarMultiModalPorTipoVeiculo(Dominio.ObjetosDeValor.CTe.CTe cteIntegracao, Dominio.Entidades.Empresa empresa)
        {
            string tipoVeiculo = string.Empty;

            if (empresa.Configuracao != null && empresa.Configuracao.DefinirMultimodalObservacaoIntegracao)
            {
                if (cteIntegracao.ObservacoesGerais != null && cteIntegracao.ObservacoesGerais.Contains("TIPO VEICULO:"))
                {
                    int posicao = cteIntegracao.ObservacoesGerais.IndexOf("TIPO VEICULO:");
                    int posicaoFim = posicao + 13 + 8;
                    if (posicao > -1 && posicaoFim > -1)
                    {
                        int inicio = posicao + 13;
                        int tamanho = posicaoFim - (posicao + 13);
                        tipoVeiculo = cteIntegracao.ObservacoesGerais.Substring(inicio, tamanho).Replace(" ", "");
                    }
                }
                else if (cteIntegracao.ObservacoesGerais != null && cteIntegracao.ObservacoesGerais.Contains("TIPO: VEICULO"))
                {
                    int posicao = cteIntegracao.ObservacoesGerais.IndexOf("TIPO: VEICULO");
                    int posicaoFim = posicao + 13 + 8;
                    if (posicao > -1 && posicaoFim > -1)
                        tipoVeiculo = cteIntegracao.ObservacoesGerais.Substring(posicao + 13, posicaoFim - (posicao + 13)).Replace(" ", "");
                }

                return (tipoVeiculo == "MC40BS2" || tipoVeiculo == "FR22BS2" || tipoVeiculo == "CN40CS1");
            }
            return false;
        }

        private Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoArquivo ObterConfiguracaoArquivo(Repositorio.UnitOfWork unitOfWork)
        {
            if (_configuracaoArquivo == null)
            {
                Repositorio.Embarcador.Configuracoes.ConfiguracaoArquivo repConfiguracaoArquivo = new Repositorio.Embarcador.Configuracoes.ConfiguracaoArquivo(unitOfWork);
                _configuracaoArquivo = repConfiguracaoArquivo.BuscarPrimeiroRegistro();
                return _configuracaoArquivo;
            }

            return _configuracaoArquivo;
        }

        public bool InutilizarCteGerencialmente(string justificativa, Dominio.Entidades.ConhecimentoDeTransporteEletronico cte, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, Repositorio.UnitOfWork unitOfWork)
        {
            Repositorio.Embarcador.Configuracoes.ConfiguracaoDocumentoDestinado repConfiguracaoDocumentoDestinado = new Repositorio.Embarcador.Configuracoes.ConfiguracaoDocumentoDestinado(unitOfWork);
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoDocumentoDestinado configuracaoDocumentoDestinado = repConfiguracaoDocumentoDestinado.BuscarPrimeiroRegistro();

            if (configuracaoDocumentoDestinado.NaoReutilizarNumeracaoAposAnularGerencialmente)
                cte.ReutilizaNumeracao = Dominio.Enumeradores.ReutilizaNumeracao.Nao;

            // Não foi possível tratar pelo código da rejeição pois está retornando o código "462" que é referente há "Serviço Paralisado Momentaneamente.".
            else if (!string.IsNullOrEmpty(cte.MensagemRetornoSefaz) && cte.MensagemRetornoSefaz.Contains("Existe CT-e ja autorizado com a mesma serie e numero") && cte.Empresa?.Localidade?.Estado?.Sigla == "MG")
                cte.ReutilizaNumeracao = Dominio.Enumeradores.ReutilizaNumeracao.Nao;

            else if (cte.MensagemStatus != null && !cte.MensagemStatus.NaoPermiteReutilizarNumeracao)
                cte.ReutilizaNumeracao = Dominio.Enumeradores.ReutilizaNumeracao.Sim;

            else if (cte.MensagemStatus != null && cte.MensagemStatus.NaoPermiteReutilizarNumeracao)
                cte.ReutilizaNumeracao = Dominio.Enumeradores.ReutilizaNumeracao.Nao;

            else
                cte.ReutilizaNumeracao = Dominio.Enumeradores.ReutilizaNumeracao.Sim;

            cte.MensagemRetornoSefaz = "CTE Inutilizado gerencialmente";
            cte.ProtocoloCancelamentoInutilizacao = "CTE Inutilizado gerencialmente";
            cte.ObservacaoCancelamento = justificativa;
            cte.Status = "I";
            cte.DataCancelamento = DateTime.Now;

            return true;
        }

        private string ObterCaminhoPorTipoIntegracaoValePedagio(string integracao, Repositorio.UnitOfWork unidadeTrabalho)
        {
            string caminhoArquivo = Utilidades.IO.FileStorageService.Storage.Combine(Servicos.Embarcador.Configuracoes.ConfigurationInstance.GetInstance(unidadeTrabalho).ObterConfiguracaoArquivo().CaminhoArquivos, "Integracao", integracao);

            return caminhoArquivo;
        }

        private void ImprimirLogObterLotePDFsAgrupado(string mensagem, Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoLogSistema tipo)
        {
            Servicos.Log.TratarErro(mensagem, "ObterLotePDFsAgrupado", tipo);
        }
        #endregion
    }
}
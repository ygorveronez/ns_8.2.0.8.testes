using AdminMultisoftware.Dominio.Enumeradores;
using Dominio.ObjetosDeValor.Embarcador.Carga;
using Dominio.ObjetosDeValor.Embarcador.Enumeradores;
using Dominio.Relatorios.Embarcador.ObjetosDeValor;
using LinqKit;
using MongoDB.Driver;
using NHibernate;
using NHibernate.Linq;
using NHibernate.Type;
using Repositorio.Embarcador.Consulta;
using System;
using System.Collections.Generic;
using System.Data.Common;
using System.Data.Entity.Core.Common.CommandTrees.ExpressionBuilder;
using System.Linq;
using System.Linq.Dynamic.Core;
using System.Linq.Expressions;
using System.Text;
using System.Threading;
using System.Threading.Tasks;

namespace Repositorio.Embarcador.Cargas
{

    public class Carga : RepositorioBase<Dominio.Entidades.Embarcador.Cargas.Carga>
    {
        #region Construtores

        public Carga(UnitOfWork unitOfWork) : base(unitOfWork) { }
        public Carga(UnitOfWork unitOfWork, CancellationToken cancellationToken) : base(unitOfWork, cancellationToken) { }

        #endregion

        #region Métodos Públicos                

        public List<int> BuscarProtocolosCargasAgrupadas(int cargaAgrupamento)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.CargaAgrupamento.Protocolo == cargaAgrupamento);

            return query.Select(o => o.Protocolo).ToList();
        }

        public List<Dominio.ObjetosDeValor.WebService.Carga.Carga> BuscarNumeroCargasAgrupadas(int cargaAgrupamento)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.CargaAgrupamento.Codigo == cargaAgrupamento);

            return query.Select(o => new Dominio.ObjetosDeValor.WebService.Carga.Carga()
            {
                CargaDePreCarga = o.CargaDePreCarga,
                FilialOrigem = o.FilialOrigem.Descricao,
                NumeroCarga = o.CodigoCargaEmbarcador
            }).ToList();
        }

        public List<Dominio.ObjetosDeValor.WebService.Carga.Carga> BuscarNumerosCargasAgrupadas(List<int> cargasAgrupamento)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => cargasAgrupamento.Contains(o.CargaAgrupamento.Codigo));

            return query.Select(o => new Dominio.ObjetosDeValor.WebService.Carga.Carga()
            {
                CargaDePreCarga = o.CargaDePreCarga,
                Protocolo = o.CargaAgrupamento.Codigo,
                NumeroCarga = o.CodigoCargaEmbarcador,
                FilialOrigem = o.FilialOrigem.Descricao
            }).ToList();
        }

        public bool ContemCargaDuplicadaNumeracao(string codigoCargaEmbarcador, bool cargaRecebidaDeIntegracao)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query where obj.CodigoCargaEmbarcador == codigoCargaEmbarcador && obj.SituacaoCarga != SituacaoCarga.Anulada && obj.SituacaoCarga != SituacaoCarga.Cancelada select obj;
            if (cargaRecebidaDeIntegracao)
                result = result.Where(c => c.CargaRecebidaDeIntegracao == true);

            return result.Any();
        }

        public bool IsCargaAgrupada(int codigoCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(obj => obj.Codigo == codigoCarga && obj.CargaAgrupada);
            return query.Any();
        }

        public bool ExisteCargaEspelhoPorCarga(int codigoCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(obj => obj.CargaEspelho.Codigo == codigoCarga);
            return query.Any();
        }

        public int CodigoCargaDuplicadaNumeracao(string codigoCargaEmbarcador)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query where obj.CodigoCargaEmbarcador == codigoCargaEmbarcador && obj.SituacaoCarga != SituacaoCarga.Anulada && obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.CargaRecebidaDeIntegracao == true select obj;

            return result.Select(c => c.Codigo).FirstOrDefault();
        }

        public bool ContemCargaDuplicadaNumeracaoTipoOperacao(string codigoCargaEmbarcador, int codigoTipoOperacao)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query where obj.CodigoCargaEmbarcador == codigoCargaEmbarcador && obj.TipoOperacao.Codigo == codigoTipoOperacao && obj.CargaFechada && obj.SituacaoCarga != SituacaoCarga.Anulada && obj.SituacaoCarga != SituacaoCarga.Cancelada select obj;

            return result.Any();
        }

        public bool TodosProdutosDaCargaSaoPalletsFechado(int codigoCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedidoProduto>();

            var result = from obj in query where obj.CargaPedido.Carga.Codigo == codigoCarga && !obj.CargaPedido.Pedido.Produtos.Any(p => p.PalletFechado) select obj;

            return !result.Any();
        }

        public bool VerificarSeCargaAgrupamentoPossuiPreCarga(int cargaAgrupamento)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.CargaAgrupamento.Codigo == cargaAgrupamento);

            return query.Any(obj => obj.CargaDePreCarga);
        }

        public bool VerificarSePendenteGerarCargaDistribuidorPorCargaAgrupada(int cargaAgrupamento)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.CargaAgrupamento.Codigo == cargaAgrupamento);

            return query.Any(obj => obj.PendenteGerarCargaDistribuidor);
        }

        public List<Dominio.Entidades.Empresa> BuscarEmpresasCargasOriginais(int cargaAgrupamento)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(o => o.CargaAgrupamento.Codigo == cargaAgrupamento && o.Empresa != null);
            return query.Select(obj => obj.Empresa).Distinct().ToList();
        }

        public List<Dominio.Entidades.Embarcador.Filiais.Filial> BuscarFiliaisCargasOriginais(int cargaAgrupamento)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(o => o.CargaAgrupamento.Codigo == cargaAgrupamento && o.Filial != null);
            return query.Select(obj => obj.Filial).Distinct().ToList();
        }

        public bool BuscarCargasOriginaisSaoPrecarga(int cargaAgrupamento)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.CargaAgrupamento.Codigo == cargaAgrupamento && o.CargaDePreCarga);

            return consultaCarga.Any();
        }

        public bool ExiteCargaPorCodigoEmbarcador(string codigoCargaEmbarcador)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.CodigoCargaEmbarcador.Equals(codigoCargaEmbarcador));

            return consultaCarga.Any();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarCargaPorCodigoCargaEmbarcador(string codigoCargaEmbarcador)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.CodigoCargaEmbarcador.Equals(codigoCargaEmbarcador));

            return consultaCarga.FirstOrDefault();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasOriginais(int cargaAgrupamento)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.CargaAgrupamento.Codigo == cargaAgrupamento);

            List<Dominio.Entidades.Embarcador.Cargas.Carga> cargasParticaoUm = consultaCarga
                .Fetch(obj => obj.TipoOperacao)
                .Fetch(obj => obj.Filial)
                .Fetch(obj => obj.ModeloVeicularCarga)
                .Fetch(obj => obj.TipoDeCarga)
                .Fetch(obj => obj.TabelaFrete)
                .Fetch(obj => obj.DadosSumarizados)
                .Fetch(obj => obj.Veiculo)
                .ToList();

            List<Dominio.Entidades.Embarcador.Cargas.Carga> cargasParticaoDois = consultaCarga
                .Fetch(obj => obj.Empresa).ThenFetch(o => o.EmpresaPai).ThenFetch(o => o.Configuracao)
                .Fetch(obj => obj.Empresa).ThenFetch(o => o.Configuracao)
                .Fetch(obj => obj.Empresa).ThenFetch(obj => obj.Localidade).ThenFetch(obj => obj.Pais)
                .Fetch(obj => obj.Empresa).ThenFetch(obj => obj.Localidade).ThenFetch(obj => obj.Regiao).ThenFetch(obj => obj.LocalidadePolo)
                .Fetch(obj => obj.EmpresaFilialEmissora).ThenFetch(obj => obj.Localidade).ThenFetch(obj => obj.Pais)
                .Fetch(obj => obj.EmpresaFilialEmissora).ThenFetch(obj => obj.Localidade).ThenFetch(obj => obj.Regiao).ThenFetch(obj => obj.LocalidadePolo)
                .Fetch(obj => obj.Rota)
                .ToList();

            foreach (Dominio.Entidades.Embarcador.Cargas.Carga cargaParticaoUm in cargasParticaoUm)
            {
                Dominio.Entidades.Embarcador.Cargas.Carga cargaParticaoDois = cargasParticaoDois.First(carga => carga.Codigo == cargaParticaoUm.Codigo);

                cargaParticaoUm.Empresa = cargaParticaoDois.Empresa;
                cargaParticaoUm.EmpresaFilialEmissora = cargaParticaoDois.EmpresaFilialEmissora;
                cargaParticaoUm.Rota = cargaParticaoDois.Rota;
            }

            return cargasParticaoUm;
        }

        public async Task<List<Dominio.Entidades.Embarcador.Cargas.Carga>> BuscarCargasOriginaisAsync(int cargaAgrupamento)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.CargaAgrupamento.Codigo == cargaAgrupamento);

            List<Dominio.Entidades.Embarcador.Cargas.Carga> cargasParticaoUm = await consultaCarga
                .Fetch(obj => obj.TipoOperacao)
                .Fetch(obj => obj.Filial)
                .Fetch(obj => obj.ModeloVeicularCarga)
                .Fetch(obj => obj.TipoDeCarga)
                .Fetch(obj => obj.TabelaFrete)
                .Fetch(obj => obj.DadosSumarizados)
                .Fetch(obj => obj.Veiculo)
                .ToListAsync();

            List<Dominio.Entidades.Embarcador.Cargas.Carga> cargasParticaoDois = await consultaCarga
                .Fetch(obj => obj.Empresa).ThenFetch(o => o.EmpresaPai).ThenFetch(o => o.Configuracao)
                .Fetch(obj => obj.Empresa).ThenFetch(obj => obj.Localidade).ThenFetch(obj => obj.Pais)
                .Fetch(obj => obj.Empresa).ThenFetch(obj => obj.Localidade).ThenFetch(obj => obj.Regiao).ThenFetch(obj => obj.LocalidadePolo)
                .Fetch(obj => obj.EmpresaFilialEmissora).ThenFetch(obj => obj.Localidade).ThenFetch(obj => obj.Pais)
                .Fetch(obj => obj.EmpresaFilialEmissora).ThenFetch(obj => obj.Localidade).ThenFetch(obj => obj.Regiao).ThenFetch(obj => obj.LocalidadePolo)
                .Fetch(obj => obj.Rota)
                .ToListAsync();

            foreach (Dominio.Entidades.Embarcador.Cargas.Carga cargaParticaoUm in cargasParticaoUm)
            {
                Dominio.Entidades.Embarcador.Cargas.Carga cargaParticaoDois = cargasParticaoDois.First(carga => carga.Codigo == cargaParticaoUm.Codigo);

                cargaParticaoUm.Empresa = cargaParticaoDois.Empresa;
                cargaParticaoUm.EmpresaFilialEmissora = cargaParticaoDois.EmpresaFilialEmissora;
                cargaParticaoUm.Rota = cargaParticaoDois.Rota;
            }

            return cargasParticaoUm;
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCargaCancelada(string codigoCargaEmbarcador, int codigoFilial)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o =>
                    o.SituacaoCarga == SituacaoCarga.Cancelada &&
                    o.Filial.Codigo == codigoFilial &&
                    o.CodigoCargaEmbarcador == codigoCargaEmbarcador &&
                    o.CargaAgrupamento == null &&
                    o.CargaFechada
                );

            return consultaCarga
                .OrderByDescending(o => o.Codigo)
                .FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCargaCanceladaComFretePorOperador(string codigoCargaEmbarcador, int codigoFilial, int codigoTipoOperacao)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o =>
                    o.SituacaoCarga == SituacaoCarga.Cancelada &&
                    o.TipoFreteEscolhido == TipoFreteEscolhido.Operador &&
                    o.Filial.Codigo == codigoFilial &&
                    o.TipoOperacao.Codigo == codigoTipoOperacao &&
                    o.CodigoCargaEmbarcador == codigoCargaEmbarcador
                );

            return consultaCarga
                .OrderByDescending(o => o.Codigo)
                .FirstOrDefault();
        }

        public List<int> BuscarCodigosCargasOriginais(int cargaAgrupamento)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.CargaAgrupamento.Codigo == cargaAgrupamento);

            return consultaCarga.Select(o => o.Codigo).ToList();
        }

        public List<int> BuscarCargasVinculadas(int cargaVinculada)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.CargaVinculada.Codigo == cargaVinculada);

            return query.Select(obj => obj.Codigo).ToList();
        }

        public string BuscarIDTrizy(int codigo)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query where obj.Codigo == codigo select obj;
            return result.Select(o => o.IDIdentificacaoTrizzy).FirstOrDefault();
        }

        public List<(int Codigo, DateTime DataFinalizacaoEmissao, int CodigoModeloVeicularCarga, int CodigoTipoCarga, int CodigoTipoOperacao)> BuscarCargasParaSugestaoProgramacaoCarga(Dominio.ObjetosDeValor.Embarcador.Carga.ProgramacaoCarga.FiltroPesquisaCarga filtrosPesquisa)
        {
            List<SituacaoCarga> situacoesCargaNaoEmitida = SituacaoCargaHelper.ObterSituacoesCargaNaoEmitida();
            List<DateTime> datasFinalizacaoEmissao = filtrosPesquisa.DatasFinalizacaoEmissao ?? new List<DateTime>();

            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(carga =>
                    carga.CargaFechada == true &&
                    carga.DataFinalizacaoEmissao != null &&
                    !situacoesCargaNaoEmitida.Contains(carga.SituacaoCarga) &&
                    datasFinalizacaoEmissao.Contains(carga.DataFinalizacaoEmissao.Value.Date)
                );

            IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> consultaCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            if (filtrosPesquisa.CodigoFilial > 0)
                consultaCarga = consultaCarga.Where(carga => carga.Filial.Codigo == filtrosPesquisa.CodigoFilial);

            if (filtrosPesquisa.CodigosModelosVeicularesCarga?.Count > 0)
                consultaCarga = consultaCarga.Where(carga => filtrosPesquisa.CodigosModelosVeicularesCarga.Contains(carga.ModeloVeicularCarga.Codigo));

            if (filtrosPesquisa.CodigosTiposCarga?.Count > 0)
                consultaCarga = consultaCarga.Where(carga => filtrosPesquisa.CodigosTiposCarga.Contains(carga.TipoDeCarga.Codigo));

            if (filtrosPesquisa.CodigosTiposOperacao?.Count > 0)
                consultaCarga = consultaCarga.Where(carga => filtrosPesquisa.CodigosTiposOperacao.Contains(carga.TipoOperacao.Codigo));

            if (filtrosPesquisa.CodigosDestinos?.Count > 0)
                consultaCargaPedido = consultaCargaPedido.Where(carga => filtrosPesquisa.CodigosDestinos.Contains(carga.Destino.Codigo));

            if (filtrosPesquisa.CodigosRegioesDestino?.Count > 0)
                consultaCargaPedido = consultaCargaPedido.Where(carga => filtrosPesquisa.CodigosRegioesDestino.Contains(carga.Destino.Regiao.Codigo));

            if (filtrosPesquisa.SiglasEstadosDestino?.Count > 0)
                consultaCargaPedido = consultaCargaPedido.Where(carga => filtrosPesquisa.SiglasEstadosDestino.Contains(carga.Destino.Estado.Sigla));

            consultaCarga = consultaCarga.Where(carga => consultaCargaPedido.Any(cargaPedido => cargaPedido.Carga.Codigo == carga.Codigo));

            return consultaCarga
                .Select(carga => ValueTuple.Create(carga.Codigo, carga.DataFinalizacaoEmissao.Value, carga.ModeloVeicularCarga.Codigo, carga.TipoDeCarga.Codigo, carga.TipoOperacao.Codigo))
                .ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasComDivergencia(int limite)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.CargaAgrupamento != null && o.CargaAgrupamento.SituacaoCarga != o.SituacaoCarga && o.CargaAgrupamento.CargaFechada && !o.CargaAgrupamento.CalculandoFrete);

            // Se você incluir o filtro direto na consulta com os fetches pode causar lentidão extrema
            List<int> codigosCargas = query.Take(limite).Select(o => o.Codigo).ToList();

            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query1 = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query1 = query1.Where(o => codigosCargas.Contains(o.Codigo));

            return query1
                .Fetch(o => o.DadosSumarizados)
                .Fetch(o => o.CargaAgrupamento).ThenFetch(obj => obj.DadosSumarizados)
                .OrderBy(o => o.Codigo)
                .ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarParaFilaCarregamento(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaFilaCarregamento filtrosPesquisa, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            var consultaCarga = ConsultarParaFilaCarregamento(filtrosPesquisa);

            return ObterLista(consultaCarga, parametrosConsulta);
        }

        public int ContarConsultaParaFilaCarregamento(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaFilaCarregamento filtrosPesquisa)
        {
            var consultaCarga = ConsultarParaFilaCarregamento(filtrosPesquisa);

            return consultaCarga.Count();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarNaoIntegradasTerceiroComTransportador(List<int> codigosTransportadores, bool? naoRetornarCargasComplementares, int totalRetornar = 400)
        {
            List<Dominio.Enumeradores.TipoProprietarioVeiculo> tipoProprietarioVeiculo = new List<Dominio.Enumeradores.TipoProprietarioVeiculo>()
            {
                 Dominio.Enumeradores.TipoProprietarioVeiculo.TACAgregado,
                 Dominio.Enumeradores.TipoProprietarioVeiculo.TACIndependente
            };

            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> queryCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(carga => !this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCIOT>().Any(ciot => ciot.Carga.Codigo == carga.Codigo) &&
                                carga.CargaAgrupamento == null &&
                                codigosTransportadores.Contains(carga.Empresa.Codigo) &&
                                (carga.IntegrouTerceiroTransportador == null || !carga.IntegrouTerceiroTransportador) &&
                                carga.SituacaoCarga == SituacaoCarga.PendeciaDocumentos &&
                                !carga.CargaTransbordo &&
                                carga.Veiculo != null &&
                                carga.Veiculo.Proprietario != null &&
                                tipoProprietarioVeiculo.Contains(carga.Veiculo.TipoProprietario) &&
                                !carga.LiberadoComProblemaCIOT &&
                                carga.ProblemaIntegracaoCIOT);

            if (naoRetornarCargasComplementares.HasValue && naoRetornarCargasComplementares.Value)
                queryCarga = queryCarga.Where(o => o.CargaCTes.Any(c => c.CTe.TipoCTE == Dominio.Enumeradores.TipoCTE.Normal));

            return queryCarga.Take(totalRetornar).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarNaoIntegradasComTransportador(List<int> codigosTransportadores, bool? naoRetornarCargasComplementares, int totalRetornar = 400)
        {
            List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga> situacoesPermitidas = new List<SituacaoCarga>()
            {
                 SituacaoCarga.Encerrada,
                 SituacaoCarga.EmTransporte,
                 SituacaoCarga.AgImpressaoDocumentos,
                 SituacaoCarga.LiberadoPagamento,
                 SituacaoCarga.AgIntegracao
            };

            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.CargaAgrupamento == null &&
                                     codigosTransportadores.Contains(o.Empresa.Codigo) &&
                                     !o.IntegrouTransportador &&
                                     situacoesPermitidas.Contains(o.SituacaoCarga) &&
                                     !o.CargaTransbordo && (o.Rota == null || !o.Rota.FinalizarViagemAutomaticamente));

            if (naoRetornarCargasComplementares.HasValue && naoRetornarCargasComplementares.Value)
                query = query.Where(o => o.CargaCTes.Any(c => c.CTe.TipoCTE == Dominio.Enumeradores.TipoCTE.Normal));

            return query.Take(totalRetornar).ToList();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarCargaPorTransportador(int protocoloCarga, List<int> codigosTransportadores)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.Codigo == protocoloCarga &&
                                     o.CargaAgrupamento == null &&
                                     codigosTransportadores.Contains(o.Empresa.Codigo) &&
                                     !o.CargaTransbordo && (o.Rota == null || !o.Rota.FinalizarViagemAutomaticamente));

            return query.FirstOrDefault();
        }

        public int? ContarPorNumero(string codigoCargaEmbarcador)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.CodigoCargaEmbarcador == codigoCargaEmbarcador);

            return query.Count();
        }

        public int BuscarUltimoControleNumeracao(string codigoCargaEmbarcador)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.CodigoCargaEmbarcador == codigoCargaEmbarcador && o.SituacaoCarga != SituacaoCarga.Cancelada && o.SituacaoCarga != SituacaoCarga.Anulada);

            return consultaCarga.Max(o => o.ControleNumeracao) ?? 0;
        }

        public int ContarCargasPorDiaEMotorista(DateTime data, int codigoMotorista, bool somenteCargasAtivas)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.Motoristas.Any(m => m.Codigo == codigoMotorista));
            query = query.Where(o => o.DataCarregamentoCarga.Value.Date == data.Date);

            if (somenteCargasAtivas)
                query = query.Where(o => o.SituacaoCarga != SituacaoCarga.Cancelada && o.SituacaoCarga != SituacaoCarga.Anulada && o.SituacaoCarga != SituacaoCarga.Encerrada);

            return query.Count();
        }

        public int ContarCargasPorDiaEVeiculos(DateTime data, int codigoVeiculo)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.Veiculo.Codigo == codigoVeiculo);
            query = query.Where(o => o.DataCarregamentoCarga.Value.Date == data.Date);

            return query.Count();
        }

        public List<int> BuscarCargasParaAvancoAutomaticoCTeDocumentosFiscais()
        {
            IQueryable<Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao>();

            query = query.Where(o => !o.CargaPedido.Carga.NaoAvancarAutomaticamenteEtapaDocumentoPorPendencia && o.CargaPedido.Carga.CargaSVM == false && o.CargaPedido.Carga.TipoOperacao != null && o.CargaPedido.Carga.CargaFechada && !o.CargaPedido.Carga.ProcessandoDocumentosFiscais && o.CargaPedido.Carga.SituacaoCarga == SituacaoCarga.AgNFe && o.CargaPedido.Carga.TipoOperacao.AvancarCargaAutomaticaAposMontagem);

            return query.Select(o => o.CargaPedido.Carga.Codigo).ToList();
        }

        public List<int> BuscarCargasParaAvancoAutomaticoDocumentosFiscais()
        {
            IQueryable<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal>();

            query = query.Where(o => !o.CargaPedido.Carga.NaoAvancarAutomaticamenteEtapaDocumentoPorPendencia && o.CargaPedido.Carga.CargaSVM == false && o.CargaPedido.Carga.TipoOperacao != null && o.CargaPedido.Carga.CargaFechada && !o.CargaPedido.Carga.ProcessandoDocumentosFiscais && o.CargaPedido.Carga.SituacaoCarga == SituacaoCarga.AgNFe && o.CargaPedido.Carga.TipoOperacao.AvancarCargaAutomaticaAposMontagem);

            return query.Select(o => o.CargaPedido.Carga.Codigo).ToList();
        }

        public List<int> BuscarCargasParaAvancoAutomaticoEtapaFrete(bool exigirCargaRoteirizada)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => !o.NaoAvancarAutomaticamenteEtapaFretePorPendencia && o.CargaSVM == false && o.TipoOperacao != null
                && o.CargaFechada && o.SituacaoCarga == SituacaoCarga.CalculoFrete
                && !o.CalculandoFrete
                && !o.DataEnvioUltimaNFe.HasValue && (o.TipoOperacao.AvancarCargaAutomaticaAposMontagem || o.TipoOperacao.AvancarEtapaFreteAutomaticamente)
                && !o.PossuiPendencia
                && ((o.SituacaoAlteracaoFreteCarga == SituacaoAlteracaoFreteCarga.Aprovada) || (o.SituacaoAlteracaoFreteCarga == SituacaoAlteracaoFreteCarga.NaoInformada) || (o.SituacaoAlteracaoFreteCarga == SituacaoAlteracaoFreteCarga.Reprovada)));

            if (exigirCargaRoteirizada)
                query = query.Where(o => o.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Concluido);
            else
                query = query.Where(o => o.TipoOperacao.ExigirCargaRoteirizada ? o.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Concluido : true);

            return query.Select(o => o.Codigo).ToList();
        }

        public List<int> BuscarCargasSVMEmProcessamentoDocumentosFiscais()
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.CargaSVM == true && o.CargaFechada && o.SituacaoCarga == SituacaoCarga.CalculoFrete && !o.DataEnvioUltimaNFe.HasValue);

            return query.Select(o => o.Codigo).ToList();
        }

        public List<int> BuscarCargasEmProcessamentoDocumentosFiscais(bool consultarPorLote)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            IQueryable<Dominio.Entidades.Embarcador.Cargas.MensagemAlertaCarga> consultaMensagemAlertaComBloqueio = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.MensagemAlertaCarga>();

            consultaMensagemAlertaComBloqueio = consultaMensagemAlertaComBloqueio.Where(o =>
               o.Confirmada == false &&
               ((bool?)o.Bloquear ?? false) == true
            );

            consultaCarga = consultaCarga.Where(o =>
                o.ProcessandoDocumentosFiscais &&
                o.CargaFechada &&
                (o.SituacaoCarga == SituacaoCarga.AgNFe || o.CargaEmitidaParcialmente) &&
                (((bool?)o.CargaDePreCargaEmFechamento).HasValue == false || o.CargaDePreCargaEmFechamento == false) &&
                !consultaMensagemAlertaComBloqueio.Any(alerta => alerta.Entidade.Codigo == o.Codigo)
            );

            if (consultarPorLote)
                consultaCarga = consultaCarga.Where(o => o.CalcularFreteLote == null || o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Padrao);

            return consultaCarga.OrderBy(o => o.PosicaoFilaProcessamento).ThenBy(o => o.Codigo).Select(o => o.Codigo).ToList();
        }

        public List<int> BuscarCargasEmProcessamentoDocumentosFiscaisEmLote()
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            IQueryable<Dominio.Entidades.Embarcador.Cargas.MensagemAlertaCarga> consultaMensagemAlerta = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.MensagemAlertaCarga>();

            consultaMensagemAlerta = consultaMensagemAlerta.Where(o =>
               o.Confirmada == false &&
               ((bool?)o.Bloquear ?? false) == true
            );

            consultaCarga = consultaCarga.Where(o =>
                o.ProcessandoDocumentosFiscais &&
                o.CargaFechada &&
                (o.SituacaoCarga == SituacaoCarga.AgNFe || o.CargaEmitidaParcialmente) &&
                (((bool?)o.CargaDePreCargaEmFechamento).HasValue == false || o.CargaDePreCargaEmFechamento == false) &&
                !consultaMensagemAlerta.Any(alerta => alerta.Entidade.Codigo == o.Codigo)
            );

            consultaCarga = consultaCarga.Where(o => o.CalcularFreteLote != null && o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Integracao);

            return consultaCarga.Select(o => o.Codigo).ToList();
        }

        public List<int> BuscarProtocolosCargasComTodosCanhotosDigitalizados(int inicioRegistros, int maximoRegistros)
        {
            var consultaCarga = BuscarProtocolosCargasComTodosCanhotosDigitalizados();

            return consultaCarga
                .OrderBy(o => o.Codigo)
                .Select(o => o.Protocolo)
                .Skip(inicioRegistros)
                .Take(maximoRegistros)
                .ToList();
        }

        public int ContarProtocolosCargasComTodosCanhotosDigitalizados()
        {
            var consultaCarga = BuscarProtocolosCargasComTodosCanhotosDigitalizados();

            return consultaCarga.Count();
        }

        public void ZerarValoresCargaAgrupamentoFilialEmissora(int codigoCarga)
        {
            UnitOfWork.Sessao.CreateQuery("UPDATE Carga SET ValorFreteFilialEmissora = :ValorFreteFilialEmissora, ValorICMSFilialEmissora = :ValorICMSFilialEmissora, ValorFreteAPagarFilialEmissora = :ValorFreteAPagarFilialEmissora WHERE CargaAgrupamento.Codigo = :codigoCarga")
                .SetInt32("codigoCarga", codigoCarga)
                .SetDecimal("ValorFreteFilialEmissora", 0)
                .SetDecimal("ValorICMSFilialEmissora", 0)
                .SetDecimal("ValorFreteAPagarFilialEmissora", 0)
                .ExecuteUpdate();
        }

        public void CancelarCargasVinculadas(int codigoCarga, int numeroControle, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacaoCarga)
        {
            UnitOfWork.Sessao.CreateQuery("UPDATE Carga SET SituacaoCarga = :situacaoCarga, CalculandoFrete = :CalculandoFrete, DataAtualizacaoCarga = :dataAtualizacaoCarga, ControleNumeracao = :numeroControle WHERE CargaVinculada.Codigo = :codigoCarga")
                .SetInt32("codigoCarga", codigoCarga)
                .SetInt32("numeroControle", numeroControle)
                .SetBoolean("CalculandoFrete", false)
                .SetEnum("situacaoCarga", situacaoCarga)
                .SetDateTime("dataAtualizacaoCarga", DateTime.Now)
                .ExecuteUpdate();
        }

        public void CancelarCargasAgrupadas(int codigoCarga, int numeroControle, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacaoCarga)
        {
            UnitOfWork.Sessao.CreateQuery("UPDATE Carga SET SituacaoCarga = :situacaoCarga, CalculandoFrete = :CalculandoFrete, DataAtualizacaoCarga = :dataAtualizacaoCarga, ControleNumeracao = :numeroControle  WHERE CargaAgrupamento.Codigo = :codigoCarga")
                .SetInt32("codigoCarga", codigoCarga)
                .SetInt32("numeroControle", numeroControle)
                .SetBoolean("CalculandoFrete", false)
                .SetEnum("situacaoCarga", situacaoCarga)
                .SetDateTime("dataAtualizacaoCarga", DateTime.Now)
                .ExecuteUpdate();
        }

        public void AtualizarSituacaoCargasAgrupadas(int codigoCarga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacaoCarga)
        {
            UnitOfWork.Sessao.CreateQuery("UPDATE Carga SET SituacaoCarga = :situacaoCarga, CalculandoFrete = :CalculandoFrete, DataAtualizacaoCarga = :dataAtualizacaoCarga WHERE CargaAgrupamento.Codigo = :codigoCarga")
                .SetInt32("codigoCarga", codigoCarga)
                .SetBoolean("CalculandoFrete", false)
                .SetEnum("situacaoCarga", situacaoCarga)
                .SetDateTime("dataAtualizacaoCarga", DateTime.Now)
                .ExecuteUpdate();
        }

        public void AtualizarDataAtualizacaoCarga(int codigoCarga, DbConnection connection, DbTransaction transaction)
        {
            DbCommand command = connection.CreateCommand();
            command.CommandTimeout = 300;
            command.Transaction = transaction;
            command.CommandText = "UPDATE t_carga SET car_data_atualizacao = @data_atualizacao WHERE car_codigo = @codigo";

            DbParameter parDataAtualizacao = command.CreateParameter();
            parDataAtualizacao.ParameterName = "@data_atualizacao";
            parDataAtualizacao.Value = DateTime.Now;
            command.Parameters.Add(parDataAtualizacao);

            DbParameter parCodigo = command.CreateParameter();
            parCodigo.ParameterName = "@codigo";
            parCodigo.Value = codigoCarga;
            command.Parameters.Add(parCodigo);

            command.ExecuteNonQuery();
        }

        public void ZerarValoresCargaAgrupamento(int codigoCarga)
        {
            UnitOfWork.Sessao.CreateQuery("UPDATE Carga SET ValorFrete = :ValorFrete, ValorICMS = :ValorICMS, ValorISS = :ValorISS, ValorFreteAPagar = :ValorFreteAPagar WHERE CargaAgrupamento.Codigo = :codigoCarga")
                .SetInt32("codigoCarga", codigoCarga)
                .SetDecimal("ValorFrete", 0)
                .SetDecimal("ValorICMS", 0)
                .SetDecimal("ValorISS", 0)
                .SetDecimal("ValorFreteAPagar", 0)
                .ExecuteUpdate();
        }

        public void AtualizarProcessamentoDocumentosFiscais(int codigoCarga, bool processando)
        {
            if (UnitOfWork.IsActiveTransaction())
            {
                UnitOfWork.Sessao.CreateQuery("UPDATE Carga SET ProcessandoDocumentosFiscais = :processandoDocumentosFiscais WHERE Codigo = :codigoCarga").SetInt32("codigoCarga", codigoCarga).SetBoolean("processandoDocumentosFiscais", processando).ExecuteUpdate();
            }
            else
            {
                try
                {
                    UnitOfWork.Start();

                    UnitOfWork.Sessao.CreateQuery("UPDATE Carga SET ProcessandoDocumentosFiscais = :processandoDocumentosFiscais WHERE Codigo = :codigoCarga").SetInt32("codigoCarga", codigoCarga).SetBoolean("processandoDocumentosFiscais", processando).ExecuteUpdate();

                    UnitOfWork.CommitChanges();
                }
                catch
                {
                    UnitOfWork.Rollback();
                    throw;
                }
            }
        }

        public void AtualizarTentativaRoteirizacao(int codigoCarga, SituacaoRoteirizacao situacao)
        {
            using (var session = UnitOfWork.Sessao.SessionFactory.OpenSession())
            using (var transaction = session.BeginTransaction())
            {
                session.CreateQuery(@"
                    UPDATE Carga 
                        SET NumeroTentativasRoteirizacaoCarga = (NumeroTentativasRoteirizacaoCarga + 1),
                            DataUltimaTentativaRoteirizacaoCarga = :dataUltimaTentativaRoteirizacaoCarga,
                            SituacaoRoteirizacaoCarga = :situacaoRoteirizacaoCarga
                        WHERE Codigo = :codigoCarga
                ")
                .SetInt32("codigoCarga", codigoCarga)
                .SetDateTime("dataUltimaTentativaRoteirizacaoCarga", DateTime.Now)
                .SetInt32("situacaoRoteirizacaoCarga", (int)situacao)
                .ExecuteUpdate();

                transaction.Commit();
            }
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCarregamentosPendentesIntegracao(bool retornarCargasAgrupadasCarregamento, bool naoRetornarSemData, bool retornarCargasEmCalculoFrete, bool somenteEmAguardandoNF, int inicioRegistros, int maximoRegistros, int codigoEmpresa, string codigoFilial, string codigoRegiao)
        {
            var result = ConsultarCarregamentosPendenetesIntegracao(retornarCargasAgrupadasCarregamento, naoRetornarSemData, retornarCargasEmCalculoFrete, somenteEmAguardandoNF, codigoEmpresa, codigoFilial, codigoRegiao);

            return result.Fetch(obj => obj.Carregamento).Skip(inicioRegistros).Take(maximoRegistros).ToList();
        }

        public int ContarCarregamentosPendentesIntegracao(bool retornarCargasAgrupadasCarregamento, bool naoRetornarSemData, bool retornarCargasEmCalculoFrete, bool somenteEmAguardandoNF, int codigoEmpresa, string codigoFilial, string codigoRegiao)
        {
            var result = ConsultarCarregamentosPendenetesIntegracao(retornarCargasAgrupadasCarregamento, naoRetornarSemData, retornarCargasEmCalculoFrete, somenteEmAguardandoNF, codigoEmpresa, codigoFilial, codigoRegiao);

            return result.Count();
        }

        public bool VerificarCargasSemCalculoPorCarregamento(int carregamento, int codigoCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query where obj.Carregamento.Codigo == carregamento && obj.Codigo != codigoCarga select obj;

            return result.Any(obj => obj.SituacaoCarga != SituacaoCarga.CalculoFrete);
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarPorRotaEmCalculoFrete(int rota)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query
                         where
                         obj.Rota.Codigo == rota &&
                         (
                            (obj.ExigeNotaFiscalParaCalcularFrete && (obj.SituacaoCarga == SituacaoCarga.CalculoFrete || obj.SituacaoCarga == SituacaoCarga.AgNFe || obj.SituacaoCarga == SituacaoCarga.Nova)) ||
                            (!obj.ExigeNotaFiscalParaCalcularFrete && (obj.SituacaoCarga == SituacaoCarga.CalculoFrete || obj.SituacaoCarga == SituacaoCarga.AgTransportador || obj.SituacaoCarga == SituacaoCarga.Nova))
                         ) &&
                         obj.CargaFechada
                         select obj;

            return result.ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarPorCodigosEmbarcadorOuNotasFiscais(List<string> codigosEmbarcador, List<string> notasFiscais)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var queryPedidoNotaFiscal = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal>();
            queryPedidoNotaFiscal = queryPedidoNotaFiscal.Where(obj => notasFiscais.Contains(obj.XMLNotaFiscal.Chave));

            query = query.Where(obj => codigosEmbarcador.Contains(obj.CodigoCargaEmbarcador) || queryPedidoNotaFiscal.Any(p => p.CargaPedido.Carga.Codigo == obj.Codigo));

            return query.ToList();
        }

        public Dominio.Entidades.Localidade ObterLocalidadeOrigem(int codigoCarga)
        {
            var consultaPontosPassagem = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaRotaFretePontosPassagem>()
                .Where(o =>
                    o.CargaRotaFrete.Carga.Codigo == codigoCarga &&
                    o.TipoPontoPassagem == TipoPontoPassagem.Coleta &&
                    (((bool?)o.ColetaEquipamento).HasValue == false || o.ColetaEquipamento == false)
                );

            return consultaPontosPassagem
                .OrderBy(o => o.Ordem)
                .Select(o => o.ClienteOutroEndereco.Localidade ?? o.Cliente.Localidade ?? o.Localidade)
                .FirstOrDefault();
        }

        public int ContarQuantidadeCargaPorRota(int codigoRota, int codigoCargaDesconsiderar, DateTime dataInicial, DateTime dataFinal, int codigoModeloVeicularCarga)
        {
            return ContarQuantidadeCargaPorRota(codigoRota, codigoCargaDesconsiderar, dataInicial, dataFinal, codigoModeloVeicularCarga, codigoEmpresa: 0);
        }

        public int ContarQuantidadeCargaPorRota(int codigoRota, int codigoCargaDesconsiderar, DateTime dataInicial, DateTime dataFinal, int codigoModeloVeicularCarga, int codigoEmpresa)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o =>
                    o.Rota.Codigo == codigoRota &&
                    o.Codigo != codigoCargaDesconsiderar &&
                    o.SituacaoCarga != SituacaoCarga.Cancelada &&
                    o.SituacaoCarga != SituacaoCarga.Anulada &&
                    o.DataCriacaoCarga >= dataInicial.Date &&
                    o.DataCriacaoCarga <= dataFinal.Date.Add(DateTime.MaxValue.TimeOfDay)
                );

            if (codigoEmpresa > 0)
                consultaCarga = consultaCarga.Where(o => o.Empresa.Codigo == codigoEmpresa);
            else
                consultaCarga = consultaCarga.Where(o => o.Empresa != null);

            if (codigoModeloVeicularCarga > 0)
                consultaCarga = consultaCarga.Where(o => o.ModeloVeicularCarga.Codigo == codigoModeloVeicularCarga);

            return consultaCarga.Count();
        }

        public int ContarQuantidadeCargaPorConfiguracaoRota(int codigoConfiguracaoRota, int codigoCargaDesconsiderar, DateTime dataInicial, DateTime dataFinal, int codigoModeloVeicularCarga)
        {
            return ContarQuantidadeCargaPorConfiguracaoRota(codigoConfiguracaoRota, codigoCargaDesconsiderar, dataInicial, dataFinal, codigoModeloVeicularCarga, codigoEmpresa: 0);
        }

        public int ContarQuantidadeCargaPorConfiguracaoRota(int codigoConfiguracaoRota, int codigoCargaDesconsiderar, DateTime dataInicial, DateTime dataFinal, int codigoModeloVeicularCarga, int codigoEmpresa)
        {
            System.Text.StringBuilder sqlContarQuantidadeCarga = new System.Text.StringBuilder();

            sqlContarQuantidadeCarga.AppendLine("select count(CargaOrigem.CAR_CODIGO) ");
            sqlContarQuantidadeCarga.AppendLine("  from ( ");
            sqlContarQuantidadeCarga.AppendLine("           select Carga.CAR_CODIGO, PontosPassagem.CLI_CGCCPF, ");
            sqlContarQuantidadeCarga.AppendLine("                  row_number() over (partition by Carga.CAR_CODIGO order by PontosPassagem.CRP_ORDEM) as Ordem ");
            sqlContarQuantidadeCarga.AppendLine("             from T_CARGA Carga ");
            sqlContarQuantidadeCarga.AppendLine("             join T_CARGA_ROTA_FRETE CargaRotaFrete on CargaRotaFrete.CAR_CODIGO = Carga.CAR_CODIGO ");
            sqlContarQuantidadeCarga.AppendLine("             join T_CARGA_ROTA_FRETE_PONTOS_PASSAGEM PontosPassagem on PontosPassagem.CRF_CODIGO = CargaRotaFrete.CRF_CODIGO ");
            sqlContarQuantidadeCarga.AppendLine($"           where PontosPassagem.CRP_TIPO_PONTOS_PASSAGEM = {(int)TipoPontoPassagem.Coleta} ");
            sqlContarQuantidadeCarga.AppendLine("              and isnull(PontosPassagem.CRP_COLETA_EQUIPAMENTO, 0) = 0 ");
            sqlContarQuantidadeCarga.AppendLine($"             and Carga.CAR_CODIGO <> {codigoCargaDesconsiderar} ");
            sqlContarQuantidadeCarga.AppendLine($"             and Carga.CAR_SITUACAO <> {(int)SituacaoCarga.Cancelada} ");
            sqlContarQuantidadeCarga.AppendLine($"             and Carga.CAR_SITUACAO <> {(int)SituacaoCarga.Anulada} ");
            sqlContarQuantidadeCarga.AppendLine("              and Carga.EMP_CODIGO is not null ", codigoEmpresa == 0);
            sqlContarQuantidadeCarga.AppendLine($"             and Carga.EMP_CODIGO = {codigoEmpresa} ", codigoEmpresa > 0);
            sqlContarQuantidadeCarga.AppendLine($"             and Carga.MVC_CODIGO = {codigoModeloVeicularCarga} ", codigoModeloVeicularCarga > 0);
            sqlContarQuantidadeCarga.AppendLine($"             and Carga.CAR_DATA_CRIACAO between '{dataInicial.Date.ToString("yyyyMMdd HH:mm:ss")}' and '{dataFinal.Date.Add(DateTime.MaxValue.TimeOfDay).ToString("yyyyMMdd HH:mm:ss")}' ");
            sqlContarQuantidadeCarga.AppendLine("              and ( ");
            sqlContarQuantidadeCarga.AppendLine("                      (Carga.TCG_CODIGO is null) or ");
            sqlContarQuantidadeCarga.AppendLine($"                     ((select count(TCG_CODIGO) from T_CONFIGURACAO_ROTA_FRETE_TIPO_CARGA where CRF_CODIGO = {codigoConfiguracaoRota}) = 0) or "); // SQL-INJECTION-SAFE
            sqlContarQuantidadeCarga.AppendLine($"                     (Carga.TCG_CODIGO in (select TCG_CODIGO from T_CONFIGURACAO_ROTA_FRETE_TIPO_CARGA where CRF_CODIGO = {codigoConfiguracaoRota})) "); // SQL-INJECTION-SAFE
            sqlContarQuantidadeCarga.AppendLine("                  ) ");
            sqlContarQuantidadeCarga.AppendLine("              and ( ");
            sqlContarQuantidadeCarga.AppendLine("                      (Carga.MVC_CODIGO is null) or ");
            sqlContarQuantidadeCarga.AppendLine($"                     ((select count(MVC_CODIGO) from T_CONFIGURACAO_ROTA_FRETE_MODELO_VEICULAR_CARGA where CRF_CODIGO = {codigoConfiguracaoRota}) = 0) or "); // SQL-INJECTION-SAFE
            sqlContarQuantidadeCarga.AppendLine($"                     (Carga.MVC_CODIGO in (select MVC_CODIGO from T_CONFIGURACAO_ROTA_FRETE_MODELO_VEICULAR_CARGA where CRF_CODIGO = {codigoConfiguracaoRota})) "); // SQL-INJECTION-SAFE
            sqlContarQuantidadeCarga.AppendLine("                  ) ");
            sqlContarQuantidadeCarga.AppendLine("       ) as CargaOrigem ");
            sqlContarQuantidadeCarga.AppendLine("  join T_CLIENTE Cliente on Cliente.CLI_CGCCPF = CargaOrigem.CLI_CGCCPF ");
            sqlContarQuantidadeCarga.AppendLine(" where CargaOrigem.Ordem = 1 ");
            sqlContarQuantidadeCarga.AppendLine("   and Cliente.LOC_CODIGO in ( ");
            sqlContarQuantidadeCarga.AppendLine($"          select LOC_CODIGO from T_CONFIGURACAO_ROTA_FRETE_LOCALIDADE_ORIGEM where CRF_CODIGO = {codigoConfiguracaoRota} "); // SQL-INJECTION-SAFE
            sqlContarQuantidadeCarga.AppendLine("       ) ");
            sqlContarQuantidadeCarga.AppendLine("   and exists ( ");
            sqlContarQuantidadeCarga.AppendLine("           select top(1) 1 ");
            sqlContarQuantidadeCarga.AppendLine("             from T_CARGA_ROTA_FRETE CargaRotaFrete ");
            sqlContarQuantidadeCarga.AppendLine("             join T_CARGA_ROTA_FRETE_PONTOS_PASSAGEM PontosPassagem on PontosPassagem.CRF_CODIGO = CargaRotaFrete.CRF_CODIGO ");
            sqlContarQuantidadeCarga.AppendLine("             join T_CLIENTE Cliente on Cliente.CLI_CGCCPF = PontosPassagem.CLI_CGCCPF ");
            sqlContarQuantidadeCarga.AppendLine("             join T_LOCALIDADES Localidade on Localidade.LOC_CODIGO = Cliente.LOC_CODIGO ");
            sqlContarQuantidadeCarga.AppendLine($"           where PontosPassagem.CRP_TIPO_PONTOS_PASSAGEM = {(int)TipoPontoPassagem.Entrega} ");
            sqlContarQuantidadeCarga.AppendLine("              and CargaRotaFrete.CAR_CODIGO = CargaOrigem.CAR_CODIGO ");
            sqlContarQuantidadeCarga.AppendLine("              and Localidade.UF_SIGLA in ( ");
            sqlContarQuantidadeCarga.AppendLine($"                     select UF_SIGLA from T_CONFIGURACAO_ROTA_FRETE_ESTADO where CRF_CODIGO = {codigoConfiguracaoRota} "); // SQL-INJECTION-SAFE
            sqlContarQuantidadeCarga.AppendLine("                  ) ");
            sqlContarQuantidadeCarga.AppendLine("       ) ");

            var consultaContarQuantidadeCarga = this.SessionNHiBernate.CreateSQLQuery(sqlContarQuantidadeCarga.ToString());

            return consultaContarQuantidadeCarga.UniqueResult<int>();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga VerificarCargaCancelada(int carga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCancelamento>();
            var result = from obj in query
                         where obj.Carga.Codigo == carga && obj.Situacao != SituacaoCancelamentoCarga.Reprovada
                            && ((TipoCancelamentoCargaDocumento?)obj.TipoCancelamentoCargaDocumento ?? TipoCancelamentoCargaDocumento.Carga) == TipoCancelamentoCargaDocumento.Carga
                         select obj.Carga;

            return result.FirstOrDefault();
        }

        public List<int> BuscaCargasSemRoteirizacao(bool controlePorLote, int NumeroTentativasConsultarCargasErroRoteirizacao, int TempoMinutosAguardarReconsultarCargasErroRoteirizacao, int limiteRegistros, bool calcularFreteInicioCarga)
        {
            var codigosCargasCanceladas = ObterCargasEmCancelamento().Select(x => x.Carga.Codigo).ToList();

            var situacaoPreCarga = new List<SituacaoCarga>
           {
               SituacaoCarga.Nova,
               SituacaoCarga.AgNFe
           };

            var situacaoNaoExigeNotaCarga = new List<SituacaoCarga>
           {
               SituacaoCarga.Nova,
               SituacaoCarga.CalculoFrete,
               SituacaoCarga.AgTransportador
           };

            List<int> consultaTipoOperacao = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.TipoOperacao>().Where(x => x.GerarControleColeta || x.ConfiguracaoCarga.RoteirizarCargaEtapaNotaFiscal).Select(x => x.Codigo).ToList();

            List<ValueTuple<int, bool>> consultaTipoIntegracao = this.SessionNHiBernate
                .Query<Dominio.Entidades.Embarcador.Cargas.TipoIntegracao>()
                .Where(x => x.Ativo)
                .Select(x => new ValueTuple<int, bool>(x.Codigo, x.ControlePorLote))
                .ToList();

            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o =>
                    o.CargaFechada &&
                    o.PendenteGerarCargaDistribuidor == false &&
                    codigosCargasCanceladas.Contains(o.Codigo) == false &&
                    (
                        // 1. Carga de pré-carga ou possui pré-cálculo de frete
                        ((o.CargaDePreCarga || o.CargaPossuiPreCalculoFrete) && situacaoPreCarga.Contains(o.SituacaoCarga))

                        ||

                        // 2. Exige NF para cálculo de frete
                        (o.ExigeNotaFiscalParaCalcularFrete &&
                            (
                                o.SituacaoCarga == SituacaoCarga.CalculoFrete ||
                                (o.SituacaoCarga == SituacaoCarga.AgNFe &&
                                    (
                                        o.CargaDePreCargaFechada ||
                                    consultaTipoOperacao.Contains(o.TipoOperacao.Codigo)
                                    )
                                ) ||
                                (o.SituacaoCarga == SituacaoCarga.Nova &&
                                (
                                    o.DadosSumarizados != null &&
                                    o.DadosSumarizados.RoteirizarNaEtapaDeDadosTransporte
                                    )
                                )
                            )
                        )

                        ||

                        // 3. Não exige NF para cálculo de frete
                        (o.ExigeNotaFiscalParaCalcularFrete == false && situacaoNaoExigeNotaCarga.Contains(o.SituacaoCarga))
                    )
                );

            if (calcularFreteInicioCarga)
            {
                consultaCarga = consultaCarga.Where(o =>
                    o.CargaFechada &&
                    o.PendenteGerarCargaDistribuidor == false &&
                    codigosCargasCanceladas.Contains(o.Codigo) == false &&
                    (
                        // 1. Carga de pré-carga em situação Nova ou AgNFe
                        ((o.CargaDePreCarga || o.CalculandoFrete) && (situacaoPreCarga.Contains(o.SituacaoCarga)))

                        ||

                        // 2. Exige NF e está em cálculo de frete
                        (o.ExigeNotaFiscalParaCalcularFrete && o.SituacaoCarga == SituacaoCarga.CalculoFrete)

                        ||

                        // 3. Exige NF e está em AgNFe com condições específicas
                        (o.ExigeNotaFiscalParaCalcularFrete &&
                            o.SituacaoCarga == SituacaoCarga.AgNFe &&
                            (o.TipoOperacao.GerarControleColeta || o.CargaDePreCargaFechada)
                        )

                        ||

                        // 4. Não exige NF e está em uma das situações: Nova, CalculoFrete, AgTransportador
                        (o.ExigeNotaFiscalParaCalcularFrete == false && situacaoNaoExigeNotaCarga.Contains(o.SituacaoCarga))
                    )
                );
            }

            if (NumeroTentativasConsultarCargasErroRoteirizacao > 0)
            {
                // Define um tempo limite para considerar nova tentativa
                var limiteTentativa = DateTime.Now.AddMinutes(-TempoMinutosAguardarReconsultarCargasErroRoteirizacao);

                consultaCarga = consultaCarga.Where(o =>
                    o.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Aguardando ||

                    (
                        o.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Erro &&
                        o.NumeroTentativasRoteirizacaoCarga < NumeroTentativasConsultarCargasErroRoteirizacao &&
                        (
                            o.DataUltimaTentativaRoteirizacaoCarga.HasValue == false ||
                            o.DataUltimaTentativaRoteirizacaoCarga <= limiteTentativa
                        )
                    )
                );

            }
            else
                consultaCarga = consultaCarga.Where(o => o.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Aguardando);

            var codigosSelecionados = consultaTipoIntegracao
        .Where(x => x.Item2)
        .Select(x => x.Item1)
        .ToList();



            if (controlePorLote)
                consultaCarga =
                    consultaCarga.Where(o =>
                        o.Integracoes.Any(i => codigosSelecionados.Contains(i.TipoIntegracao.Codigo)) == true
                    ||
                    o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Integracao
                );

            else
                consultaCarga = consultaCarga.Where(o =>
                      o.Integracoes.Any(i => codigosSelecionados.Contains(i.TipoIntegracao.Codigo)) == false
                    &&
                    (o.CalcularFreteLote == null || o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Padrao)
                );


            return consultaCarga
                .Select(x => x.Codigo)
                .Take(limiteRegistros)
                .ToList();
        }

        public List<int> BuscaCargasLiberarSemNFe(int limiteRegistros)
        {
            List<SituacaoAlteracaoPedido> situacoesPendentes = SituacaoAlteracaoPedidoHelper.ObterSituacoesPendentes();
            var consultaAlteracaoPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.AlteracaoPedido.AlteracaoPedido>()
                .Where(o => situacoesPendentes.Contains(o.Situacao));

            var consultaCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>()
                .Where(o => consultaAlteracaoPedido.Any(a => a.Pedido.Codigo == o.Pedido.Codigo) || o.Pedido.DevolucaoPacote);

            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.CargaFechada &&
                    o.CargaDePreCarga == false &&
                    o.ProcessandoDocumentosFiscais == false &&
                    o.DataInicioEmissaoDocumentos == null &&
                    o.CargaAgrupamento == null &&
                    o.CargaVinculada == null &&
                    o.TipoOperacao != null &&
                    o.TipoOperacao.LiberarCargaSemNFeAutomaticamenteAposLiberarFaturamento == true &&
                    o.SituacaoCarga == SituacaoCarga.AgNFe
                );

            consultaCarga = consultaCarga.Where(o => !consultaCargaPedido.Any(p => p.Carga.Codigo == o.Codigo));

            return consultaCarga
                .Select(o => o.Codigo)
                .Take(limiteRegistros)
                .ToList();
        }

        public List<Dominio.Entidades.Cliente> ConsultarClientesCarga(bool cargaOrigem, bool destinatariosDaCarga, int carga, string nome, double cpfCnpj, string tipo, Dominio.Entidades.Localidade localidade, string telefone, int codigoGrupoPessoas, int inicioRegistros, int maximoRegistros, string propOrdenacao = "", string dirOrdenacao = "asc")
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> result = destinatariosDaCarga ?
                _ConsultarDestinatariosCarga(cargaOrigem, carga, nome, cpfCnpj, tipo, localidade, telefone, codigoGrupoPessoas) :
                _ConsultarRemetentesCarga(cargaOrigem, carga, nome, cpfCnpj, tipo, localidade, telefone, codigoGrupoPessoas);

            IQueryable<double> resultCliente = destinatariosDaCarga ? result.Select(obj => obj.Pedido.Destinatario.CPF_CNPJ) : result.Select(obj => obj.Pedido.Remetente.CPF_CNPJ);

            IQueryable<Dominio.Entidades.Cliente> queryCliente = this.SessionNHiBernate.Query<Dominio.Entidades.Cliente>();

            queryCliente = queryCliente.Where(o => resultCliente.Any(c => c == o.CPF_CNPJ));

            return queryCliente
                   .Fetch(o => o.Localidade)
                   .OrderBy((propOrdenacao ?? "Nome") + (dirOrdenacao == "asc" ? " ascending" : " descending"))
                   .Skip(inicioRegistros)
                   .Take(maximoRegistros)
                   .WithOptions(o => o.SetTimeout(120))
                   .ToList();
        }

        public int ContarClientesCarga(bool cargaOrigem, bool destinatariosDaCarga, int carga, string nome, double cpfCnpj, string tipo, Dominio.Entidades.Localidade localidade, string telefone, int codigoGrupoPessoas)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> result = destinatariosDaCarga ?
                _ConsultarDestinatariosCarga(cargaOrigem, carga, nome, cpfCnpj, tipo, localidade, telefone, codigoGrupoPessoas) :
                _ConsultarRemetentesCarga(cargaOrigem, carga, nome, cpfCnpj, tipo, localidade, telefone, codigoGrupoPessoas);

            IQueryable<double> resultCliente = destinatariosDaCarga ? result.Select(obj => obj.Pedido.Destinatario.CPF_CNPJ) : result.Select(obj => obj.Pedido.Remetente.CPF_CNPJ);

            IQueryable<Dominio.Entidades.Cliente> queryCliente = this.SessionNHiBernate.Query<Dominio.Entidades.Cliente>();

            queryCliente = queryCliente.Where(o => resultCliente.Any(c => c == o.CPF_CNPJ));

            return queryCliente.Count();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCarregamentos(List<int> codigosCarregamento)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(obj => codigosCarregamento.Contains(obj.Carregamento.Codigo));
            return query.FirstOrDefault();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasPorCodigos(List<int> codigosCargas)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(obj => codigosCargas.Contains(obj.Codigo));
            return query.ToList();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCarregamento(int codigoCarregamento)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(obj => obj.Carregamento.Codigo == codigoCarregamento);
            return query.FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarUltimaCargaPorVeiculos(int codigoVeiculo, DateTime dataLimite)
        {
            var listaSituacoes = new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga>
            {
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgImpressaoDocumentos,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgIntegracao,
            };

            var queryGrupo = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => (o.Veiculo.Codigo == codigoVeiculo || o.VeiculosVinculados.Any(c => c.Codigo == codigoVeiculo)) && listaSituacoes.Contains(o.SituacaoCarga) && o.DataCriacaoCarga.Date <= dataLimite.Date);
            //.GroupBy(o => o.Veiculo.Codigo)
            //.Select(o => new Dominio.ObjetosDeValor.Embarcador.Carga.CargaVeiculo { CodigoCarga = o.Max(e => e.Codigo), CodigoVeiculo = o.Key });

            return queryGrupo.OrderByDescending(o => o.Codigo).FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoFetch(int codigo)
        {
            var carga1 = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(a => a.Codigo == codigo)
                .Fetch(obj => obj.TipoOperacao)
                    .ThenFetch(obj => obj.ConfiguracaoEmissaoDocumento)
                .Fetch(obj => obj.TipoOperacao)
                    .ThenFetch(obj => obj.ConfiguracaoDocumentoEmissao)
                .Fetch(obj => obj.TipoOperacao)
                    .ThenFetch(obj => obj.ConfiguracaoEmissao)
                .Fetch(obj => obj.TipoOperacao)
                    .ThenFetch(obj => obj.ConfiguracaoCalculoFrete)
                .Fetch(obj => obj.TipoOperacao)
                    .ThenFetch(obj => obj.ConfiguracaoCarga)
                .Fetch(obj => obj.Carregamento)
                .Fetch(obj => obj.Filial)
                .Fetch(obj => obj.ModeloVeicularCarga)
                .Fetch(obj => obj.TipoDeCarga)
                .Fetch(obj => obj.TabelaFrete)
                .Fetch(obj => obj.EmpresaFilialEmissora)
                    .ThenFetch(obj => obj.Localidade)
                    .ThenFetch(obj => obj.Pais)
                .FirstOrDefault();

            var carga2 = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(a => a.Codigo == codigo)
                .Fetch(obj => obj.EmpresaFilialEmissora)
                    .ThenFetch(obj => obj.Localidade)
                    .ThenFetch(obj => obj.Regiao)
                    .ThenFetch(obj => obj.LocalidadePolo)
                .Fetch(obj => obj.DadosSumarizados)
                .Fetch(obj => obj.Rota)
                .Fetch(obj => obj.Veiculo)
                    .ThenFetch(obj => obj.Proprietario)
                    .ThenFetch(obj => obj.Localidade)
                    .ThenFetch(obj => obj.Estado)
                    .ThenFetch(obj => obj.Pais)
                .Fetch(obj => obj.Operador)
                .Fetch(obj => obj.Empresa)
                    .ThenFetch(o => o.Configuracao)
                .Fetch(obj => obj.Empresa)
                    .ThenFetch(o => o.EmpresaPai)
                    .ThenFetch(o => o.Configuracao)
                .Fetch(obj => obj.Empresa)
                    .ThenFetch(obj => obj.Localidade)
                    .ThenFetch(obj => obj.Pais)
                .Fetch(obj => obj.Empresa)
                    .ThenFetch(obj => obj.Localidade)
                    .ThenFetch(obj => obj.Regiao)
                    .ThenFetch(obj => obj.LocalidadePolo)
                .FirstOrDefault();

            carga1.EmpresaFilialEmissora = carga2.EmpresaFilialEmissora;
            carga1.DadosSumarizados = carga2.DadosSumarizados;
            carga1.Rota = carga2.Rota;
            carga1.Veiculo = carga2.Veiculo;
            carga1.Operador = carga2.Operador;
            carga1.Empresa = carga2.Empresa;

            return carga1;
        }

        public async Task<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarPorCodigoFetchAsync(int codigo, CancellationToken cancellation)
        {
            var carga1 = await this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(a => a.Codigo == codigo)
                .Fetch(obj => obj.TipoOperacao)
                .ThenFetch(obj => obj.ConfiguracaoEmissaoDocumento)
                .Fetch(obj => obj.TipoOperacao)
                .ThenFetch(obj => obj.ConfiguracaoDocumentoEmissao)
                .Fetch(obj => obj.TipoOperacao)
                .ThenFetch(obj => obj.ConfiguracaoEmissao)
                .Fetch(obj => obj.TipoOperacao)
                .ThenFetch(obj => obj.ConfiguracaoCalculoFrete)
                .Fetch(obj => obj.TipoOperacao)
                .ThenFetch(obj => obj.ConfiguracaoCarga)
                .Fetch(obj => obj.Carregamento)
                .Fetch(obj => obj.Filial)
                .Fetch(obj => obj.ModeloVeicularCarga)
                .Fetch(obj => obj.TipoDeCarga)
                .Fetch(obj => obj.TabelaFrete)
                .Fetch(obj => obj.EmpresaFilialEmissora)
                .ThenFetch(obj => obj.Localidade)
                .ThenFetch(obj => obj.Pais)
                .FirstOrDefaultAsync(cancellation);

            var carga2 = await this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(a => a.Codigo == codigo)
                .Fetch(obj => obj.EmpresaFilialEmissora)
                .ThenFetch(obj => obj.Localidade)
                .ThenFetch(obj => obj.Regiao)
                .ThenFetch(obj => obj.LocalidadePolo)
                .Fetch(obj => obj.DadosSumarizados)
                .Fetch(obj => obj.Rota)
                .Fetch(obj => obj.Veiculo)
                .ThenFetch(obj => obj.Proprietario)
                .ThenFetch(obj => obj.Localidade)
                .ThenFetch(obj => obj.Estado)
                .ThenFetch(obj => obj.Pais)
                .Fetch(obj => obj.Operador)
                .Fetch(obj => obj.Empresa)
                .ThenFetch(o => o.EmpresaPai)
                .ThenFetch(o => o.Configuracao)
                .Fetch(obj => obj.Empresa)
                .ThenFetch(obj => obj.Localidade)
                .ThenFetch(obj => obj.Pais)
                .Fetch(obj => obj.Empresa)
                .ThenFetch(obj => obj.Localidade)
                .ThenFetch(obj => obj.Regiao)
                .ThenFetch(obj => obj.LocalidadePolo)
                .FirstOrDefaultAsync(cancellation);

            carga1.EmpresaFilialEmissora = carga2.EmpresaFilialEmissora;
            carga1.DadosSumarizados = carga2.DadosSumarizados;
            carga1.Rota = carga2.Rota;
            carga1.Veiculo = carga2.Veiculo;
            carga1.Operador = carga2.Operador;
            carga1.Empresa = carga2.Empresa;

            return carga1;
        }
        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigo(int codigo)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query where obj.Codigo == codigo select obj;

            return result.FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoComFetch(int codigo, List<string> fetch)
        {
            return BuscarPorCodigoComFetchAsync(codigo, fetch).GetAwaiter().GetResult();
        }

        public async Task<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarPorCodigoComFetchAsync(int codigo, List<string> fetch)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query where obj.Codigo == codigo select obj;

            return (await RealizarFetchAsync(result, fetch, 0, 1)).FirstOrDefault();
        }

        public async Task<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarPorCodigoAsync(int codigo)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query where obj.Codigo == codigo select obj;

            return await result.FirstOrDefaultAsync(CancellationToken);
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarTodasPorCodigo(IList<int> codigos)
        {
            int take = 1000;
            int start = 0;
            List<Dominio.Entidades.Embarcador.Cargas.Carga> resultado = new List<Dominio.Entidades.Embarcador.Cargas.Carga>();

            while (start < codigos.Count)
            {
                List<int> loteCodigos = codigos.Skip(start).Take(take).ToList();

                var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                    .Where(obj => loteCodigos.Contains(obj.Codigo))
                    .ToList();

                resultado.AddRange(query);
                start += take;
            }

            return resultado;
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarTodasPorCodigo(List<int> codigos, bool comFetch = false)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(obj => codigos.Contains(obj.Codigo));
            if (comFetch)
            {
                query = query.Fetch(carga => carga.TipoOperacao);
                query = query.Fetch(carga => carga.Veiculo);
            }
            return query.ToList();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorIDIdentificacaoTrizy(string idTrizy)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query where obj.IDIdentificacaoTrizzy == idTrizy select obj;
            return result.FirstOrDefault();
        }


        public int BuscarQuantidadeEntregaRalizada(int codigoCarga)
        {
            var situacoes = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoEntregaHelper.ObterListaSituacaoEntregaFinalizada();

            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntrega>();
            query = query.Where(obj => obj.Carga.Codigo == codigoCarga && situacoes.Contains(obj.Situacao));
            return query.Select(o => o.Codigo).Count();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorProtocolo(int protocoloCarga)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.Protocolo == protocoloCarga);

            return query.FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorChaveCTE(string chaveCTE)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaCTe> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();

            query = query.Where(o => o.CTe.Chave == chaveCTE);

            return query.Select(x => x.Carga).FirstOrDefault();
        }

        public Task<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarPorProtocoloAsync(int protocoloCarga)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.Protocolo == protocoloCarga);

            return query.FirstOrDefaultAsync(CancellationToken);
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorProtocoloFetchProcessarDocumento(int protocoloCarga)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.Protocolo == protocoloCarga);

            return query
                .Fetch(x => x.ModeloVeicularCarga)
                .Fetch(x => x.TipoOperacao)
                .ThenFetch(x => x.ConfiguracaoMontagemCarga)
                .Fetch(x => x.TipoOperacao)
                .ThenFetch(x => x.ConfiguracaoCarga).FirstOrDefault();
        }


        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarPorListaCarga(List<string> numerosCarga, string codigoIntegracaoFilial, DateTime dataInicial, DateTime dataFinal, string codigoTipoOperacao)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.SituacaoCarga != SituacaoCarga.Cancelada && o.SituacaoCarga != SituacaoCarga.Anulada);

            if (numerosCarga != null && numerosCarga.Count > 0)
            {
                query = query.Where(o => numerosCarga.Contains(o.CodigoCargaEmbarcador));
            }

            if (!string.IsNullOrWhiteSpace(codigoIntegracaoFilial))
                query = query.Where(o => o.Filial.CodigoFilialEmbarcador == codigoIntegracaoFilial);

            if (dataInicial.Date > DateTime.MinValue)
                query = query.Where(o => o.DataCriacaoCarga >= dataInicial);

            if (dataFinal.Date > DateTime.MinValue)
                query = query.Where(o => o.DataCriacaoCarga <= dataFinal);

            if (!string.IsNullOrWhiteSpace(codigoTipoOperacao))
                query = query.Where(o => o.TipoOperacao.CodigoIntegracao == codigoTipoOperacao);

            return query.ToList();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarCargaPorProtocoloBookingOrdemServico(int protocoloIntegracaoCarga, int codigoBooking, string numeroBooking, int codigoOrdemServico, string numeroOrgemServico)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            if (protocoloIntegracaoCarga > 0)
                query = query.Where(o => o.Carga.Protocolo == protocoloIntegracaoCarga);
            if (codigoBooking > 0)
                query = query.Where(o => o.Pedido.CodigoBooking == codigoBooking.ToString("D"));
            if (!string.IsNullOrWhiteSpace(numeroBooking))
                query = query.Where(o => o.Pedido.NumeroBooking == numeroBooking);
            if (codigoOrdemServico > 0)
                query = query.Where(o => o.Pedido.CodigoOS == codigoOrdemServico.ToString("D"));
            if (!string.IsNullOrWhiteSpace(numeroOrgemServico))
                query = query.Where(o => o.Pedido.NumeroOS == numeroOrgemServico);

            return query.Where(o => o.Carga.SituacaoCarga != SituacaoCarga.Anulada && o.Carga.SituacaoCarga != SituacaoCarga.Cancelada).Select(o => o.Carga).FirstOrDefault();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasPorProtocoloBookingOrdemServico(int protocoloIntegracaoCarga, int codigoBooking, string numeroBooking, int codigoOrdemServico, string numeroOrgemServico)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            if (protocoloIntegracaoCarga > 0)
                query = query.Where(o => o.Carga.Protocolo == protocoloIntegracaoCarga);
            if (codigoBooking > 0)
                query = query.Where(o => o.Pedido.CodigoBooking == codigoBooking.ToString("D"));
            if (!string.IsNullOrWhiteSpace(numeroBooking))
                query = query.Where(o => o.Pedido.NumeroBooking == numeroBooking);
            if (codigoOrdemServico > 0)
                query = query.Where(o => o.Pedido.CodigoOS == codigoOrdemServico.ToString("D"));
            if (!string.IsNullOrWhiteSpace(numeroOrgemServico))
                query = query.Where(o => o.Pedido.NumeroOS == numeroOrgemServico);

            return query.Where(o => o.Carga.SituacaoCarga != SituacaoCarga.Anulada && o.Carga.SituacaoCarga != SituacaoCarga.Cancelada).Select(o => o.Carga).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarPorCodigos(IList<int> codigos)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query where codigos.Contains(obj.Codigo) select obj;
            return result
                .Fetch(obj => obj.TipoOperacao)
                .Fetch(obj => obj.Carregamento)
                .Fetch(obj => obj.Filial)
                .Fetch(obj => obj.ModeloVeicularCarga)
                .Fetch(obj => obj.TipoDeCarga)
                .Fetch(obj => obj.TabelaFrete)
                .Fetch(obj => obj.EmpresaFilialEmissora)
                .Fetch(obj => obj.DadosSumarizados)
                .Fetch(obj => obj.Rota)
                .Fetch(obj => obj.Veiculo)
                .Fetch(obj => obj.Operador)
                .Fetch(obj => obj.Empresa)
                .ThenFetch(obj => obj.Localidade)
                .OrderBy(obj => obj.Codigo)
                .ToList();
        }

        public Task<List<Dominio.Entidades.Embarcador.Cargas.Carga>> BuscarPorCodigosAsync(List<int> codigos)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query where codigos.Contains(obj.Codigo) select obj;
            return result
                .Fetch(obj => obj.TipoOperacao)
                .Fetch(obj => obj.Carregamento)
                .Fetch(obj => obj.Filial)
                .Fetch(obj => obj.ModeloVeicularCarga)
                .Fetch(obj => obj.TipoDeCarga)
                .Fetch(obj => obj.TabelaFrete)
                .Fetch(obj => obj.EmpresaFilialEmissora)
                .Fetch(obj => obj.DadosSumarizados)
                .Fetch(obj => obj.Rota)
                .Fetch(obj => obj.Veiculo)
                .Fetch(obj => obj.Operador)
                .Fetch(obj => obj.Empresa)
                .ThenFetch(obj => obj.Localidade)
                .OrderBy(obj => obj.Codigo)
                .ToListAsync();
        }

        public List<string> BuscarNumerosPorCodigos(List<int> codigos)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => codigos.Contains(o.Codigo));

            return query.Select(o => o.CodigoCargaEmbarcador).ToList();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.VeiculoVinculado> BuscarVeiculosVinculadosPorCargas(List<int> codigosCargas)
        {
            string listaCodigos = string.Join(",", codigosCargas.ToList());
            var sql = $"SELECT CAR_CODIGO CodigoCarga, VEI_CODIGO CodigoVeiculo FROM T_CARGA_VEICULOS_VINCULADOS WHERE CAR_CODIGO IN({listaCodigos})"; // SQL-INJECTION-SAFE
            var consultaVeiculosVinculados = this.SessionNHiBernate.CreateSQLQuery(sql);
            consultaVeiculosVinculados.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.VeiculoVinculado)));
            return consultaVeiculosVinculados.SetTimeout(600).List<Dominio.ObjetosDeValor.Embarcador.Carga.VeiculoVinculado>();
        }

        public Task<IList<Dominio.ObjetosDeValor.Embarcador.Carga.VeiculoVinculadoMaisVeiculaDaCarga>> BuscarVeiculosDaCargaAsync(List<int> codigosCargas)
        {
            string sql = @"
                SELECT DISTINCT * FROM (
                    SELECT CAR_CODIGO CodigoCarga, CV.VEI_CODIGO CodigoVeiculo, VEI_PLACA Placa  
                    FROM T_CARGA_VEICULOS_VINCULADOS CV
                    INNER JOIN T_VEICULO V ON V.VEI_CODIGO = CV.VEI_CODIGO
                    WHERE CAR_CODIGO IN (:codigos)
            
                    UNION ALL
            
                    SELECT CAR_CODIGO CodigoCarga, VEI_CODIGO CodigoVeiculo, VEI_PLACA Placa 
                    FROM T_CARGA C
                    INNER JOIN T_VEICULO V ON V.VEI_CODIGO = C.CAR_VEICULO
                    WHERE CAR_CODIGO IN (:codigos)
                ) AS T
            ";

            NHibernate.ISQLQuery consultaVeiculosVinculados = this.SessionNHiBernate.CreateSQLQuery(sql);
            consultaVeiculosVinculados.SetParameterList("codigos", codigosCargas);
            consultaVeiculosVinculados.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(
                typeof(Dominio.ObjetosDeValor.Embarcador.Carga.VeiculoVinculadoMaisVeiculaDaCarga)
            ));

            return consultaVeiculosVinculados
                .SetTimeout(600)
                .ListAsync<Dominio.ObjetosDeValor.Embarcador.Carga.VeiculoVinculadoMaisVeiculaDaCarga>();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.VeiculoVinculadoMaisVeiculaDaCarga> BuscarVeiculosDaCarga(List<int> codigosCargas)
        {
            string listaCodigos = string.Join(",", codigosCargas.ToList());


            var sql = $" SELECT DISTINCT * FROM( SELECT  CAR_CODIGO CodigoCarga, CV.VEI_CODIGO CodigoVeiculo, VEI_PLACA Placa  FROM T_CARGA_VEICULOS_VINCULADOS  CV INNER JOIN T_VEICULO V ON V.VEI_CODIGO = CV.VEI_CODIGO where CAR_CODIGO IN({listaCodigos}) "; // SQL-INJECTION-SAFE
            sql += $" UNION ALL SELECT  CAR_CODIGO CodigoCarga, VEI_CODIGO CodigoVeiculo, VEI_PLACA Placa FROM T_CARGA  C INNER JOIN T_VEICULO V ON V.VEI_CODIGO = C.CAR_VEICULO where CAR_CODIGO IN({listaCodigos})) AS T "; // SQL-INJECTION-SAFE

            var consultaVeiculosVinculados = this.SessionNHiBernate.CreateSQLQuery(sql);
            consultaVeiculosVinculados.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.VeiculoVinculadoMaisVeiculaDaCarga)));
            return consultaVeiculosVinculados.SetTimeout(600).List<Dominio.ObjetosDeValor.Embarcador.Carga.VeiculoVinculadoMaisVeiculaDaCarga>();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.NumerosCargas> BuscarCargasParadasEmitindoDocumentos(int tempoMinutos, DateTime dataHoraAtual)
        {
            var sql = @"select Carga.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga from t_carga Carga where car_situacao = 2 and car_data_envio_ultima_nfe is not null 
                and CAR_AG_VALOR_REDESPACHO = 0 and CAR_AG_EMISSAO_DOCUMENTO_ANTERIOR = 0 and CAR_PENDENTE_GERAR_CARGA_DISTRIBUIDOR = 0 and car_calculando_frete = 0
                AND Carga.CAR_CODIGO_CARGA_EMBARCADOR IS NOT NULL AND Carga.CAR_CODIGO_CARGA_EMBARCADOR <> ''
                AND Carga.CAR_DATA_INICIO_EMISSAO_DOCUMENTOS IS NOT NULL 
                and dateadd(MINUTE, " + tempoMinutos + ", Carga.CAR_DATA_INICIO_EMISSAO_DOCUMENTOS) <= '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "'";

            var consultaCargas = this.SessionNHiBernate.CreateSQLQuery(sql);

            consultaCargas.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.NumerosCargas)));

            return consultaCargas.SetTimeout(7000).List<Dominio.ObjetosDeValor.Embarcador.Carga.NumerosCargas>();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.NumerosCargas> BuscarCargasParadasConfirmacaoDocumentos(int tempoMinutos, DateTime dataHoraAtual)
        {
            var sql = @"select Carga.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga from t_carga Carga where CAR_SITUACAO = 5 and CAR_PROCESSANDO_DOCUMENTOS_FISCAIS = 1
                AND Carga.CAR_CODIGO_CARGA_EMBARCADOR IS NOT NULL AND Carga.CAR_CODIGO_CARGA_EMBARCADOR <> ''
                AND Carga.CAR_DATA_INICIO_CONFIRMACAO_DOCUMENTOS_FISCAIS IS NOT NULL 
                and dateadd(MINUTE, " + tempoMinutos + ", Carga.CAR_DATA_INICIO_CONFIRMACAO_DOCUMENTOS_FISCAIS) <= '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "'";

            var consultaCargas = this.SessionNHiBernate.CreateSQLQuery(sql);

            consultaCargas.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.NumerosCargas)));

            return consultaCargas.SetTimeout(7000).List<Dominio.ObjetosDeValor.Embarcador.Carga.NumerosCargas>();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.NumerosCargas> BuscarCargasParadasCalculandoFrete(int tempoMinutos, DateTime dataHoraAtual)
        {
            var sql = @"select Carga.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga from t_carga Carga where car_situacao = 2 and car_calculando_frete = 1 
                AND Carga.CAR_CODIGO_CARGA_EMBARCADOR IS NOT NULL AND Carga.CAR_CODIGO_CARGA_EMBARCADOR <> ''
                AND Carga.CAR_DATA_INICIO_CALCULO_FRETE IS NOT NULL 
                and dateadd(MINUTE, " + tempoMinutos + ", Carga.CAR_DATA_INICIO_CALCULO_FRETE) <= '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "'";

            var consultaCargas = this.SessionNHiBernate.CreateSQLQuery(sql);

            consultaCargas.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.NumerosCargas)));

            return consultaCargas.SetTimeout(7000).List<Dominio.ObjetosDeValor.Embarcador.Carga.NumerosCargas>();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarPorProtocolos(List<int> protocolos)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => protocolos.Contains(o.Protocolo));

            return query.ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarSemRegraAprovacaoLiberacaoEscrituracaoPagamentoPorCodigos(List<int> codigosCarga)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => codigosCarga.Contains(o.Codigo) && o.SituacaoLiberacaoEscrituracaoPagamentoCarga == SituacaoLiberacaoEscrituracaoPagamentoCarga.SemRegraAprovacao);

            return consultaCarga.ToList();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarUltimaCargaPorMotorista(int motorista)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query
                         where (obj.SituacaoCarga == SituacaoCarga.Encerrada
                         || obj.SituacaoCarga == SituacaoCarga.PendeciaDocumentos
                         || obj.SituacaoCarga == SituacaoCarga.EmTransporte
                         || obj.SituacaoCarga == SituacaoCarga.AgIntegracao
                         || obj.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos
                         || obj.SituacaoCarga == SituacaoCarga.LiberadoPagamento || obj.SituacaoCarga == SituacaoCarga.AgTransportador)
       && obj.Motoristas.Any(mot => mot.Codigo == motorista)
                         select obj;
            return result.OrderByDescending(o => o.Codigo).FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarUltimaCargaEtapaDadosTransportePorMotorista(int motorista)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = query.Where(carga => carga.SituacaoCarga == SituacaoCarga.Nova && carga.Motoristas.Any(mot => mot.Codigo == motorista));

            return result.OrderByDescending(o => o.Codigo).FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarUltimaCargaEtapaDadosTransportePorVeiculo(int codigoVeiculo)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => (o.Veiculo.Codigo == codigoVeiculo || o.VeiculosVinculados.Any(c => c.Codigo == codigoVeiculo)) && o.SituacaoCarga == SituacaoCarga.Nova);

            return query.OrderByDescending(o => o.Codigo).FirstOrDefault();
        }


        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasEmTransportePorMotorista(int motorista)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query
                         where (obj.SituacaoCarga == SituacaoCarga.AgNFe
                         || obj.SituacaoCarga == SituacaoCarga.PendeciaDocumentos
                         || obj.SituacaoCarga == SituacaoCarga.EmTransporte
                         || obj.SituacaoCarga == SituacaoCarga.AgIntegracao
                         || obj.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos
                         || obj.SituacaoCarga == SituacaoCarga.LiberadoPagamento)
       && obj.Motoristas.Any(mot => mot.Codigo == motorista)
                         select obj;
            return result.OrderByDescending(o => o.Codigo).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargaAgNotaPorMotorista(int motorista, DateTime dataUltimaConsulta)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query
                         where obj.SituacaoCarga == SituacaoCarga.AgNFe && obj.Motoristas.Any(mot => mot.Codigo == motorista) && obj.DataCriacaoCarga > dataUltimaConsulta
                         select obj;
            return result.OrderByDescending(o => o.Codigo).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargaPorMotorista(int motorista, DateTime dataUltimaConsulta)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query
                         where (obj.SituacaoCarga == SituacaoCarga.Encerrada
       || obj.SituacaoCarga == SituacaoCarga.EmTransporte
       || obj.SituacaoCarga == SituacaoCarga.AgIntegracao
       || obj.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos
       || obj.SituacaoCarga == SituacaoCarga.LiberadoPagamento) && obj.Motoristas.Any(mot => mot.Codigo == motorista) && obj.CargaFechada && obj.DataFinalizacaoEmissao > dataUltimaConsulta
                         select obj;
            return result.OrderByDescending(o => o.Codigo).ToList();
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="motoristaMobile"></param>
        /// <param name="quantidade"></param>
        /// <param name="orderByDescending"></param>
        /// <param name="exibirEntregaAntesEtapaTransporte"></param>
        /// <param name="horasCargaExibidaNoApp">
        ///     A quantidade de horas que a carga ficará disponível no app. Caso o motorista não 
        ///     inicie a carga até essas X horas terem se passado, ela desaparecerá e dará lugar a outra carga.
        ///     Null ou zero querem dizer que ela aparecerá para sempre.
        /// </param>
        /// <returns></returns>
        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargaPorMotorista(int motoristaMobile, int quantidade, bool orderByDescending, bool naoOrdenarPorData, bool exibirEntregaAntesEtapaTransporte, int? horasCargaExibidaNoApp, DateTime? dataLimite, DateTime? dataLimiteInicio, Dominio.ObjetosDeValor.Embarcador.Enumeradores.DataReferenciaBusca? dataReferenciaBusca)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(o => o.Entregas.Count > 0 && o.SituacaoCarga != SituacaoCarga.Cancelada && o.SituacaoCarga != SituacaoCarga.Anulada);

            if (!exibirEntregaAntesEtapaTransporte)
                query = query.Where(obj => obj.TipoOperacao.ConfiguracaoMobile.ExibirEntregaAntesEtapaTransporte ||
                                            (obj.SituacaoCarga == SituacaoCarga.Encerrada ||
                                             obj.SituacaoCarga == SituacaoCarga.EmTransporte ||
                                             obj.SituacaoCarga == SituacaoCarga.AgIntegracao ||
                                             obj.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos ||
                                             obj.SituacaoCarga == SituacaoCarga.LiberadoPagamento)
                                             ||
                                            (obj.SituacaoCarga == SituacaoCarga.PendeciaDocumentos &&
                                             obj.AgImportacaoCTe)
                                             ||
                                            (obj.SituacaoCarga == SituacaoCarga.AgNFe &&
                                             obj.TipoOperacao.GerarControleColeta));

            if (horasCargaExibidaNoApp.HasValue && horasCargaExibidaNoApp.Value > 0)
            {
                DateTime dataCorte = DateTime.Now.AddHours(-horasCargaExibidaNoApp.Value);
                query = query.Where(obj => obj.DataCriacaoCarga > dataCorte || obj.DataInicioViagem.HasValue);
            }

            if (dataReferenciaBusca.HasValue)
            {
                if (dataReferenciaBusca == DataReferenciaBusca.DataCarregamentoCarga)
                {
                    if (dataLimiteInicio.HasValue)
                        query = query.Where(obj => obj.DataCarregamentoCarga >= dataLimiteInicio.Value.Date);
                    if (dataLimite.HasValue)
                        query = query.Where(obj => obj.DataCarregamentoCarga <= dataLimite.Value.Date);
                }
                else if (dataReferenciaBusca == DataReferenciaBusca.DataCriacaoCarga && dataLimite.HasValue)
                {
                    if (dataLimiteInicio.HasValue)
                        query = query.Where(obj => obj.DataCriacaoCarga >= dataLimite.Value.Date);
                    if (dataLimite.HasValue)
                        query = query.Where(obj => obj.DataCriacaoCarga <= dataLimite.Value.Date);
                }
            }
            else if (dataLimite.HasValue)
                query = query.Where(obj => obj.DataCarregamentoCarga < dataLimite.Value.AddDays(1).Date);

            query = query.Where(obj => obj.CargaFechada && obj.DataFimViagem == null && obj.Motoristas.Any(mot => mot.CodigoMobile == motoristaMobile && mot.Status == "A"));

            query = query
                .Fetch(obj => obj.Filial)
                .Fetch(obj => obj.DadosSumarizados)
                .Fetch(obj => obj.TipoDeCarga);

            if (quantidade > 0)
            {
                if (orderByDescending)
                    return query.OrderByDescending(o => o.Codigo).Take(quantidade).WithOptions(o => o.SetTimeout(240)).ToList();
                else
                {
                    if (naoOrdenarPorData)
                        return query.OrderBy(o => o.Codigo).Take(quantidade).WithOptions(o => o.SetTimeout(240)).ToList();
                    else
                        return query.OrderBy(o => o.DataPrevisaoTerminoCarga).OrderBy(o => o.Codigo).Take(quantidade).WithOptions(o => o.SetTimeout(240)).ToList();
                }
            }
            else
            {
                if (orderByDescending)
                    return query.OrderByDescending(o => o.Codigo).WithOptions(o => o.SetTimeout(240)).ToList();
                else
                {
                    if (naoOrdenarPorData)
                        return query.OrderBy(o => o.Codigo).WithOptions(o => o.SetTimeout(240)).ToList();
                    else
                        return query.OrderBy(o => o.DataPrevisaoTerminoCarga).OrderBy(o => o.Codigo).WithOptions(o => o.SetTimeout(240)).ToList();
                }
            }
        }

        public List<int> BuscarCodigosCargaPorMotorista(int motoristaMobile, int quantidade, bool orderByDescending, bool naoOrdenarPorData, bool exibirEntregaAntesEtapaTransporte, int? horasCargaExibidaNoApp, DateTime? dataLimite, DateTime? dataLimiteInicio, Dominio.ObjetosDeValor.Embarcador.Enumeradores.DataReferenciaBusca? dataReferenciaBusca)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(o => o.Entregas.Count > 0 && o.SituacaoCarga != SituacaoCarga.Cancelada && o.SituacaoCarga != SituacaoCarga.Anulada);

            if (!exibirEntregaAntesEtapaTransporte)
                query = query.Where(obj => (obj.TipoOperacao.ConfiguracaoMobile.ExibirEntregaAntesEtapaTransporte &&
                                            obj.SituacaoCarga == SituacaoCarga.PendeciaDocumentos)
                                              ||
                                            (obj.SituacaoCarga == SituacaoCarga.Encerrada ||
                                             obj.SituacaoCarga == SituacaoCarga.EmTransporte ||
                                             obj.SituacaoCarga == SituacaoCarga.AgIntegracao ||
                                             obj.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos ||
                                             obj.SituacaoCarga == SituacaoCarga.LiberadoPagamento)
                                             ||
                                            (obj.SituacaoCarga == SituacaoCarga.PendeciaDocumentos &&
                                             obj.AgImportacaoCTe)
                                             ||
                                            (obj.SituacaoCarga == SituacaoCarga.AgNFe &&
                                             obj.TipoOperacao.GerarControleColeta));

            if (horasCargaExibidaNoApp.HasValue && horasCargaExibidaNoApp.Value > 0)
            {
                DateTime dataCorte = DateTime.Now.AddHours(-horasCargaExibidaNoApp.Value);
                query = query.Where(obj => obj.DataCriacaoCarga > dataCorte || obj.DataInicioViagem.HasValue);
            }

            if (dataReferenciaBusca.HasValue)
            {
                if (dataReferenciaBusca == DataReferenciaBusca.DataCarregamentoCarga)
                {
                    if (dataLimiteInicio.HasValue)
                        query = query.Where(obj => obj.DataCarregamentoCarga >= dataLimiteInicio.Value.Date);
                    if (dataLimite.HasValue)
                        query = query.Where(obj => obj.DataCarregamentoCarga < dataLimite.Value.AddDays(1).Date);
                }
                else if (dataReferenciaBusca == DataReferenciaBusca.DataCriacaoCarga && dataLimite.HasValue)
                {
                    if (dataLimiteInicio.HasValue)
                        query = query.Where(obj => obj.DataCriacaoCarga >= dataLimite.Value.Date);
                    if (dataLimite.HasValue)
                        query = query.Where(obj => obj.DataCriacaoCarga < dataLimite.Value.AddDays(1).Date);
                }
            }
            else if (dataLimite.HasValue)
                query = query.Where(obj => obj.DataCarregamentoCarga < dataLimite.Value.AddDays(1).Date);

            query = query.Where(obj => obj.CargaFechada && obj.DataFimViagem == null && obj.Motoristas.Any(mot => mot.CodigoMobile == motoristaMobile && mot.Status == "A"));
            query = query.Where(obj => obj.TipoOperacao.HabilitarAppTrizy != true);

            query = query
                .Fetch(obj => obj.Filial)
                .Fetch(obj => obj.DadosSumarizados)
                .Fetch(obj => obj.TipoDeCarga);

            if (quantidade > 0)
            {
                if (orderByDescending)
                    return query.OrderByDescending(o => o.Codigo).Select(o => o.Codigo).Take(quantidade).ToList();
                else
                {
                    if (naoOrdenarPorData)
                        return query.OrderBy(o => o.Codigo).Select(o => o.Codigo).Take(quantidade).ToList();
                    else
                        return query.OrderBy(o => o.DataPrevisaoTerminoCarga).OrderBy(o => o.Codigo).Select(o => o.Codigo).Take(quantidade).ToList();
                }
            }
            else
            {
                if (orderByDescending)
                    return query.OrderByDescending(o => o.Codigo).Select(o => o.Codigo).ToList();
                else
                {
                    if (naoOrdenarPorData)
                        return query.OrderBy(o => o.Codigo).Select(o => o.Codigo).ToList();
                    else
                        return query.OrderBy(o => o.DataPrevisaoTerminoCarga).OrderBy(o => o.Codigo).Select(o => o.Codigo).ToList();
                }
            }
        }
        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasAbertasPorMotorista(int motorista, int horasCargaExibidaNoApp)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query
                         where obj.SituacaoCarga != SituacaoCarga.Encerrada && obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.SituacaoCarga != SituacaoCarga.Anulada
                            && obj.Motoristas.Any(mot => mot.Codigo == motorista)
                         select obj;

            if (horasCargaExibidaNoApp > 0)
            {
                DateTime dataCorte = DateTime.Now.AddHours(-horasCargaExibidaNoApp);
                result = result.Where(obj => DateTime.Compare(obj.DataCriacaoCarga, dataCorte) > 0);
            }

            result = result
                .Fetch(obj => obj.Filial)
                .Fetch(obj => obj.DadosSumarizados);

            return result.OrderByDescending(o => o.Codigo).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargaPorMotoristaCanceladas(int motorista, DateTime dataUltimaConsulta)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCancelamento>();
            var result = from obj in query
                         where (obj.SituacaoCargaNoCancelamento == SituacaoCarga.Encerrada
                            || obj.SituacaoCargaNoCancelamento == SituacaoCarga.EmTransporte
                            || obj.SituacaoCargaNoCancelamento == SituacaoCarga.AgIntegracao
                            || obj.SituacaoCargaNoCancelamento == SituacaoCarga.AgImpressaoDocumentos
                            || obj.SituacaoCargaNoCancelamento == SituacaoCarga.LiberadoPagamento) && obj.Carga.Motoristas.Any(mot => mot.Codigo == motorista) && obj.DataCancelamento > dataUltimaConsulta
                            && ((TipoCancelamentoCargaDocumento?)obj.TipoCancelamentoCargaDocumento ?? TipoCancelamentoCargaDocumento.Carga) == TipoCancelamentoCargaDocumento.Carga
                         select obj;
            return result.Select(obj => obj.Carga).OrderByDescending(o => o.Codigo).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargaPorMotoristaEncerradas(int motorista, DateTime dataUltimaConsulta)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaRegistroEncerramento>();
            var result = from obj in query
                         where obj.Carga.Motoristas.Any(mot => mot.Codigo == motorista) && obj.DataEncerramento.HasValue && obj.DataEncerramento.Value > dataUltimaConsulta
                         select obj;
            return result.Select(obj => obj.Carga).OrderByDescending(o => o.Codigo).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargarAgIntegracaoValePedagio(int quantidadeRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query where obj.IntegrandoValePedagio && obj.CargaFechada select obj;
            return result.OrderBy(o => o.Codigo).Take(quantidadeRegistros).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarPorSituacao(Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacao, bool gerandoIntegracoes, int quantidadeRegistros)
        {
            var queryCancelamento = ObterCargasEmCancelamento();
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query
                         where obj.SituacaoCarga == situacao && obj.CargaFechada && obj.GerandoIntegracoes == gerandoIntegracoes && !queryCancelamento.Select(can => can.Carga.Codigo).Any(cac => cac == obj.Codigo)
                         select obj;

            result = result.Where(obj => obj.SituacaoAutorizacaoIntegracaoCTe == SituacaoAutorizacaoIntegracaoCTe.Aprovada || obj.SituacaoAutorizacaoIntegracaoCTe == SituacaoAutorizacaoIntegracaoCTe.NaoInformada);
            return result.OrderBy(o => o.Codigo).Take(quantidadeRegistros).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasPorSituacoes(List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga> situacoes)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query select obj;

            result = result.Where(obj => situacoes.Contains(obj.SituacaoCarga));

            return result.ToList();
        }

        public List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaVeiculo> BuscarCargasMonitoramento()
        {
            DateTime dataMinima = DateTime.Now.AddDays(-5);

            var listaSituacoes = new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga>
            {
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.PendeciaDocumentos,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgImpressaoDocumentos,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgIntegracao,
            };

            var queryGrupo = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.Veiculo != null && o.DataCriacaoCarga > dataMinima && listaSituacoes.Contains(o.SituacaoCarga))
                .GroupBy(o => o.Veiculo.Codigo)
                .Select(o => new Dominio.ObjetosDeValor.Embarcador.Carga.CargaVeiculo { CodigoCarga = o.Max(e => e.Codigo), CodigoVeiculo = o.Key });

            return queryGrupo.ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasSemMonitoramento()
        {
            var listaSituacoes = new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga>
            {
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgImpressaoDocumentos,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada
            };

            var queryMonitoramento = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Logistica.Monitoramento>();

            var resultMonitoramento = from obj in queryMonitoramento
                                      where listaSituacoes.Contains(obj.Carga.SituacaoCarga) && obj.Carga.DataCriacaoCarga > DateTime.Now.AddHours(-2) && obj.Status != Dominio.ObjetosDeValor.Embarcador.Enumeradores.MonitoramentoStatus.Aguardando
                                      select obj;


            var queryCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var resultCarga = from obj in queryCarga
                              where listaSituacoes.Contains(obj.SituacaoCarga) && obj.DataCriacaoCarga > DateTime.Now.AddHours(-24)
                              select obj;


            return resultCarga.Where(o => !resultMonitoramento.Where(a => a.Carga.Codigo == o.Codigo).Any()).ToList();
        }

        public void AtualizarReprocessamentoCalculoFreteCargas(List<int> CodigosCarga)
        {
            int take = 1000;
            int start = 0;

            while (start < CodigosCarga.Count)
            {
                List<int> Listatemp = CodigosCarga.Skip(start).Take(take).ToList();
                string sqlUpdate = $" update Carga set CalculandoFrete = 1, CalcularFreteLote = 2 where Codigo in ({string.Join(", ", Listatemp)}) "; // SQL-INJECTION-SAFE

                if (UnitOfWork.IsActiveTransaction())
                    UnitOfWork.Sessao.CreateQuery(sqlUpdate).SetTimeout(300).ExecuteUpdate();
                else
                {
                    try
                    {
                        UnitOfWork.Start();

                        UnitOfWork.Sessao.CreateQuery(sqlUpdate).SetTimeout(300).ExecuteUpdate();

                        UnitOfWork.CommitChanges();
                    }
                    catch
                    {
                        UnitOfWork.Rollback();
                        throw;
                    }
                }

                start += take;
            }

        }

        public List<Dominio.Entidades.Veiculo> BuscarVeiculosSemMonitoramento()
        {
            var listaSituacoes = new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga>
            {
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgImpressaoDocumentos,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada
            };

            var queryMonitoramento = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Logistica.Monitoramento>();

            var resultMonitoramento = from obj in queryMonitoramento
                                      where listaSituacoes.Contains(obj.Carga.SituacaoCarga) && obj.Carga.DataCriacaoCarga > DateTime.Now.AddHours(-2) && obj.Status != Dominio.ObjetosDeValor.Embarcador.Enumeradores.MonitoramentoStatus.Aguardando
                                      select obj;


            var queryCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var resultCarga = from obj in queryCarga
                              where listaSituacoes.Contains(obj.SituacaoCarga) && obj.DataCriacaoCarga > DateTime.Now.AddHours(-24)
                              select obj.Veiculo;


            return resultCarga.Where(o => !resultMonitoramento.Where(a => a.Carga.Codigo == o.Codigo).Any()).Distinct().ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasSemCargaEntrega()
        {

            var queryCargaEntrega = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntrega>();

            var resultqueryCargaEntrega = from obj in queryCargaEntrega
                                          select obj;


            var queryCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var resultCarga = from obj in queryCarga
                              select obj;


            return resultCarga.Where(o => !resultqueryCargaEntrega.Where(a => a.Carga.Codigo == o.Codigo).Any()).ToList();
        }

        public Task<List<int>> BuscarCargasNaoConcluiuIntegracaoPorSituacaoAsync(Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacao, int quantidadeRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query where obj.SituacaoCarga == situacao && obj.GerandoIntegracoes == false && obj.PossuiPendencia == false select obj;

            return result.OrderBy(o => o.Codigo).Take(quantidadeRegistros).Select(x => x.Codigo).ToListAsync(CancellationToken);
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga ObterCargaPorContrato(int contratoFreteTransprotador)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query
                         where
                             obj.ContratoFreteTransportador.Codigo == contratoFreteTransprotador
                         select obj;

            return result.OrderByDescending(obj => obj.Codigo).FirstOrDefault();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargaPendentesCalculoFreteAposRecebimentoNFe(int inicioRegistros, int maximoRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query
                         where obj.SituacaoCarga == SituacaoCarga.CalculoFrete && obj.TipoFreteEscolhido != TipoFreteEscolhido.Operador && !obj.PendenciaEmissaoAutomatica && obj.CargaFechada
       && (obj.TipoOperacao != null && !obj.TipoOperacao.ExigeConformacaoFreteAntesEmissao && obj.Filial != null && !obj.Filial.ExigeConfirmacaoFreteAntesEmissao && !obj.problemaAverbacaoCTe) && obj.ExigeNotaFiscalParaCalcularFrete && !obj.DataEnvioUltimaNFe.HasValue && obj.MotivoPendenciaFrete == MotivoPendenciaFrete.NenhumPendencia && obj.PossuiPendencia == false && !obj.CalculandoFrete && !obj.PossuiPendenciaConfiguracaoContabil
                         select obj;

            return result.Skip(inicioRegistros).Take(maximoRegistros).ToList();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga buscarPorCodigoEmbarcadorExpedidor(string codigoEmbarcador, int filial, string cnpjExpedidor, bool cargaDePreCarga)
        {
            IList<int> codigosCarga = this.BuscarCodigosCargaEmCargasEEmCodigosAgrupados(codigoEmbarcador);
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
            //Alterado OR da consulta do nro carga com codigos agrupados para buscar antes os codigos das cargas praa depois fazer um IN
            //var result = from obj in query where (obj.Carga.CodigoCargaEmbarcador == codigoEmbarcador || obj.Carga.CodigosAgrupados.Contains(codigoEmbarcador)) && obj.Carga.CargaDePreCarga == cargaDePreCarga && obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada && obj.Carga.TipoOperacao.UtilizarExpedidorComoTransportador && !obj.Carga.TipoOperacao.OperacaoDeRedespacho && obj.Carga.NumeroSequenciaCarga == 0 select obj;
            var result = from obj in query where codigosCarga.Contains(obj.Carga.Codigo) && obj.Carga.CargaDePreCarga == cargaDePreCarga && obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada && obj.Carga.TipoOperacao.UtilizarExpedidorComoTransportador && !obj.Carga.TipoOperacao.OperacaoDeRedespacho && obj.Carga.NumeroSequenciaCarga == 0 select obj;
            if (filial > 0)
                result = result.Where(obj => obj.Carga.Filial.Codigo == filial);

            if (!string.IsNullOrWhiteSpace(cnpjExpedidor))
            {
                result = result.Where(obj => obj.Expedidor.CPF_CNPJ == double.Parse(cnpjExpedidor));
            }

            return result.Select(obj => obj.Carga).FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCargaPedido(int codigoCargaPedido)
        {
            var queryCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>()
                .Where(cargaPedido => cargaPedido.Codigo == codigoCargaPedido);
            int codigoCarga = queryCargaPedido.Select(obj => obj.Carga.Codigo).FirstOrDefault();
            queryCarga = queryCarga.Where(carga => carga.Codigo == codigoCarga);

            return queryCarga
                .Fetch(obj => obj.TipoOperacao)
                .FirstOrDefault();
        }

        public List<int> BuscarCodigosCargasAguardandoEnvioDocumentacao(string propOrdenar, string dirOrdenar, int inicio, int limite)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.AguardandoEnvioDocumentacaoLote == true);

            return query.Select(o => o.Codigo).Skip(inicio).Take(limite).ToList();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoVinculado(string codigoEmbarcador)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query where obj.NumeroCargaVincularPreCarga == codigoEmbarcador && obj.CargaFechada && obj.CargaDePreCarga && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada select obj;

            return result.FirstOrDefault();

        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPrimeiraCargaPorCodigoCargaEmbarcadorTodasSituacoes(string codigoCargaEmbarcador)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador && obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.SituacaoCarga != SituacaoCarga.Anulada);

            return query.FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPrimeiraCargaPorExternalID2(string externalID2)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = from obj in query where obj.ExternalID1 == externalID2 && obj.SituacaoCarga != SituacaoCarga.Anulada && obj.SituacaoCarga != SituacaoCarga.Cancelada select obj;
            return query.FirstOrDefault();
        }

        public Task<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarPrimeiraCargaPorExternalID2Async(string externalID2)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = from obj in query where obj.ExternalID1 == externalID2 && obj.SituacaoCarga != SituacaoCarga.Anulada && obj.SituacaoCarga != SituacaoCarga.Cancelada select obj;
            return query.FirstOrDefaultAsync();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasPorExternalID1(string externalID1)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = from obj in query where obj.ExternalID2 == externalID1 && obj.SituacaoCarga != SituacaoCarga.Anulada && obj.SituacaoCarga != SituacaoCarga.Cancelada select obj;
            return query.ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasAgrupadasTelhaNorte(string codigoCargaEmbarcador)
        {
            IList<int> codigosCarga = BuscarCodigosCargaEmCargasEEmCodigosAgrupados(codigoCargaEmbarcador);

            return BuscarTodasPorCodigo(codigosCarga);
        }

        public IList<int> BuscarCodigosCargasAgrupadasTelhaNorte(string codigoCargaEmbarcador)
        {
            return BuscarCodigosCargaEmCargasEEmCodigosAgrupados(codigoCargaEmbarcador);
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoCargaEmbarcador(string codigoCargaEmbarcador, int codigoFilial)
        {
            return BuscarPorCodigoCargaEmbarcador(codigoCargaEmbarcador, codigoFilial, cnpjEmpresa: "", codigoIntegracaoTipoOperacao: "", cargaDePreCarga: false, filtrarSequencialCargaZero: true);
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoCargaEmbarcador(string codigoCargaEmbarcador, int codigoFilial, bool? cargaDePreCarga)
        {
            return BuscarPorCodigoCargaEmbarcador(codigoCargaEmbarcador, codigoFilial, cnpjEmpresa: "", codigoIntegracaoTipoOperacao: "", cargaDePreCarga: cargaDePreCarga, filtrarSequencialCargaZero: true);
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoCargaEmbarcador(string codigoCargaEmbarcador, int codigoFilial, bool? cargaDePreCarga, bool filtrarSequencialCargaZero)
        {
            return BuscarPorCodigoCargaEmbarcador(codigoCargaEmbarcador, codigoFilial, cnpjEmpresa: "", codigoIntegracaoTipoOperacao: "", cargaDePreCarga: cargaDePreCarga, filtrarSequencialCargaZero: filtrarSequencialCargaZero);
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoCargaEmbarcador(string codigoCargaEmbarcador, int codigoFilial, string cnpjEmpresa, string codigoIntegracaoTipoOperacao, bool? cargaDePreCarga)
        {
            return BuscarPorCodigoCargaEmbarcador(codigoCargaEmbarcador, codigoFilial, cnpjEmpresa, codigoIntegracaoTipoOperacao, cargaDePreCarga, filtrarSequencialCargaZero: true);
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoCargaEmbarcador(string codigoCargaEmbarcador, int codigoFilial, string cnpjEmpresa, string codigoIntegracaoTipoOperacao, bool? cargaDePreCarga, bool filtrarSequencialCargaZero)
        {
            return BuscarPorCodigoCargaEmbarcador(codigoCargaEmbarcador, codigoFilial, cnpjEmpresa, codigoIntegracaoTipoOperacao, cargaDePreCarga, filtrarSequencialCargaZero, cargaAgrupada: false);
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoCargaEmbarcador(string codigoCargaEmbarcador, bool cargaAgrupada = false)
        {
            return BuscarPorCodigoCargaEmbarcador(codigoCargaEmbarcador, codigoFilial: 0, cnpjEmpresa: "", codigoIntegracaoTipoOperacao: "", cargaDePreCarga: false, filtrarSequencialCargaZero: true, cargaAgrupada);
        }

        public Task<List<Dominio.Entidades.Embarcador.Cargas.Carga>> BuscarPorCodigoCargaEmbarcadorAsync(string codigoCargaEmbarcador)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(obj => codigoCargaEmbarcador == obj.CodigoCargaEmbarcador);

            return query.ToListAsync(CancellationToken);
        }

        public (int codigo, string globalStatu) BuscarCodigoEGlobalStatusCargaPorCodigoCargaEmbarcador(string codigoCargaEmbarcador, bool cargaAgrupada = false)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = from obj in query
                    where obj.CodigoCargaEmbarcador == codigoCargaEmbarcador
                    && obj.SituacaoCarga != SituacaoCarga.Cancelada
                    && obj.SituacaoCarga != SituacaoCarga.Anulada
                    select obj;

            return query.Select(x => ValueTuple.Create(x.Codigo, x.DadosSumarizados.GlobalStatus)).FirstOrDefault();
        }


        /// <summary>
        /// Função para retornar todos os COD_CARGA pelo codigo_carga_embarcador fazendo um union com a CARGA_CODIGOS_AGRUPADOS.
        /// </summary>
        /// <param name="codigoCargaEmbarcador">Código da carga embarcador.</param>
        /// <returns></returns>
        public IList<int> BuscarCodigosCargaEmCargasEEmCodigosAgrupados(string codigoCargaEmbarcador)
        {
            string sqlQuery = $@"
                        select cca.CAR_CODIGO 
                          from T_CARGA_CODIGOS_AGRUPADOS cca 
                         where cca.CAR_CODIGO_CARGA_AGRUPADO = :COD_AGR
                        union 
                        select car.CAR_CODIGO 
                          from T_CARGA car 
                         where car.CAR_CODIGO_CARGA_EMBARCADOR = :COD_EMB";

            var queryCodCarga = this.SessionNHiBernate.CreateSQLQuery(sqlQuery);
            queryCodCarga.SetParameter("COD_AGR", codigoCargaEmbarcador);
            queryCodCarga.SetParameter("COD_EMB", codigoCargaEmbarcador);
            IList<int> codigosCarga = queryCodCarga.List<int>();
            return codigosCarga;
        }

        public async Task<List<int>> BuscarCodigosCargaEmCargasEEmCodigosAgrupadosAsync(string codigoCargaEmbarcador)
        {
            string sqlQuery = $@"
                        select cca.CAR_CODIGO 
                          from T_CARGA_CODIGOS_AGRUPADOS cca 
                         where cca.CAR_CODIGO_CARGA_AGRUPADO = :COD_AGR
                        union 
                        select car.CAR_CODIGO 
                          from T_CARGA car 
                         where car.CAR_CODIGO_CARGA_EMBARCADOR = :COD_EMB";

            var queryCodCarga = this.SessionNHiBernate.CreateSQLQuery(sqlQuery);

            queryCodCarga.SetParameter("COD_AGR", codigoCargaEmbarcador);
            queryCodCarga.SetParameter("COD_EMB", codigoCargaEmbarcador);

            var result = await queryCodCarga.ListAsync<int>();

            return result.ToList();
        }

        private List<int> BuscarCodigosCargaPorExternalIs(string codigoCargaEmbarcardor)
        {
            List<int> codigosPesquisa = new List<int>();

            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var query2 = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = from obj in query where obj.CodigoCargaEmbarcador.Contains(codigoCargaEmbarcardor) select obj;

            var cargaPrincipalBusca = query.FirstOrDefault();

            if (cargaPrincipalBusca == null)
                return codigosPesquisa;

            if (string.IsNullOrEmpty(cargaPrincipalBusca.ExternalID1) && string.IsNullOrEmpty(cargaPrincipalBusca.ExternalID2))
                return codigosPesquisa;

            if (!string.IsNullOrEmpty(cargaPrincipalBusca.ExternalID1) && !string.IsNullOrEmpty(cargaPrincipalBusca.ExternalID2))
            {
                codigosPesquisa = (from obj2 in query2 where obj2.ExternalID1.Contains(cargaPrincipalBusca.ExternalID2) select obj2.Codigo).ToList();
                codigosPesquisa.Add(cargaPrincipalBusca.Codigo);
                return codigosPesquisa;
            }

            if (!string.IsNullOrEmpty(cargaPrincipalBusca.ExternalID1))
            {
                codigosPesquisa = (from obj2 in query2 where obj2.ExternalID2.Contains(cargaPrincipalBusca.ExternalID1) select obj2.Codigo).ToList();
                codigosPesquisa.Add(cargaPrincipalBusca.Codigo);
                return codigosPesquisa;
            }

            codigosPesquisa = (from obj2 in query2 where obj2.ExternalID1.Contains(cargaPrincipalBusca.ExternalID2) select obj2.Codigo).ToList();
            codigosPesquisa.Add(cargaPrincipalBusca.Codigo);
            return codigosPesquisa;

        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoCargaEmbarcador(string codigoCargaEmbarcador, int codigoFilial, string cnpjEmpresa, string codigoIntegracaoTipoOperacao, bool? cargaDePreCarga, bool filtrarSequencialCargaZero, bool cargaAgrupada = false)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o =>
                    o.SituacaoCarga != SituacaoCarga.Cancelada &&
                    o.SituacaoCarga != SituacaoCarga.Anulada &&
                    (o.TipoOperacao == null || o.TipoOperacao.UtilizarExpedidorComoTransportador == false || (o.TipoOperacao.UtilizarExpedidorComoTransportador && o.TipoOperacao.OperacaoDeRedespacho))
                );

            //    consultaCarga = consultaCarga.Where(o => o.CodigoCargaEmbarcador == codigoCargaEmbarcador || o.CodigosAgrupados.Contains(codigoCargaEmbarcador));
            //Alterado OR da consulta do nro carga com codigos agrupados para buscar antes os codigos das cargas praa depois fazer um IN
            IList<int> codigosCarga = this.BuscarCodigosCargaEmCargasEEmCodigosAgrupados(codigoCargaEmbarcador);
            consultaCarga = consultaCarga.Where(o => codigosCarga.Contains(o.Codigo));

            if (cargaDePreCarga.HasValue)
                consultaCarga = consultaCarga.Where(o => o.CargaDePreCarga == cargaDePreCarga.Value);

            if (filtrarSequencialCargaZero)
                consultaCarga = consultaCarga.Where(o => o.NumeroSequenciaCarga == 0);

            if (codigoFilial > 0)
                consultaCarga = consultaCarga.Where(o => o.Filial.Codigo == codigoFilial);

            if (!string.IsNullOrWhiteSpace(cnpjEmpresa))
                consultaCarga = consultaCarga.Where(o => o.Empresa.CNPJ == cnpjEmpresa);

            if (!string.IsNullOrWhiteSpace(codigoIntegracaoTipoOperacao))
                consultaCarga = consultaCarga.Where(o => o.TipoOperacao.CodigoIntegracao == codigoIntegracaoTipoOperacao);

            if (cargaAgrupada)
                consultaCarga = consultaCarga.Where(o => o.TipoOperacao != null && o.TipoOperacao.TipoConsolidacao == EnumTipoConsolidacao.AutorizacaoEmissao);

            return consultaCarga.FirstOrDefault();
        }

        public Task<int> BuscarProtocoloCargaPorNumeroCarregamentoEFilialProtocoloPedidosAsync(string codigoCargaEmbarcador, List<int> protocoloPedidos)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o =>
                    o.SituacaoCarga != SituacaoCarga.Cancelada &&
                    o.SituacaoCarga != SituacaoCarga.Anulada &&
                    (o.TipoOperacao == null || !o.TipoOperacao.UtilizarExpedidorComoTransportador || (o.TipoOperacao.UtilizarExpedidorComoTransportador && o.TipoOperacao.OperacaoDeRedespacho))
                );

            IList<int> codigosCarga = this.BuscarCodigosCargaEmCargasEEmCodigosAgrupados(codigoCargaEmbarcador);
            consultaCarga = consultaCarga.Where(o => codigosCarga.Contains(o.Codigo));

            var subConsultaFilialPedidos = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.Pedido>()
                                        .Where(pedido => protocoloPedidos.Contains(pedido.Codigo))
                                        .Select(pedido => pedido.Filial.Codigo).Distinct();

            consultaCarga = consultaCarga.Where(o => subConsultaFilialPedidos.Contains(o.Filial.Codigo));

            return consultaCarga.Select(carga => carga.Protocolo).FirstOrDefaultAsync();
        }


        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoCargaEmbarcadorETipoOperacaoDiferente(string codigoCargaEmbarcador, int codigoFilial, int codigoTipoOperacao)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o =>
                    o.SituacaoCarga != SituacaoCarga.Cancelada &&
                    o.SituacaoCarga != SituacaoCarga.Anulada &&
                    (o.TipoOperacao == null || o.TipoOperacao.UtilizarExpedidorComoTransportador == false || (o.TipoOperacao.UtilizarExpedidorComoTransportador && o.TipoOperacao.OperacaoDeRedespacho))
                );


            IList<int> codigosCarga = this.BuscarCodigosCargaEmCargasEEmCodigosAgrupados(codigoCargaEmbarcador);
            consultaCarga = consultaCarga.Where(o => codigosCarga.Contains(o.Codigo));

            if (codigoFilial > 0)
                consultaCarga = consultaCarga.Where(o => o.Filial.Codigo == codigoFilial);

            if (codigoTipoOperacao > 0)
                consultaCarga = consultaCarga.Where(o => o.TipoOperacao.Codigo != codigoTipoOperacao);

            return consultaCarga.FirstOrDefault();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarTodasCargasPorCodigoEmbarcador(string codigoEmbarcador, string codigoFilialEmbarcador, bool semPreCargas)
        {
            IList<int> codigosCarga = this.BuscarCodigosCargaEmCargasEEmCodigosAgrupados(codigoEmbarcador);

            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            //Alterado OR da consulta do nro carga com codigos agrupados para buscar antes os codigos das cargas praa depois fazer um IN
            // var result = from obj in query where obj.NumeroSequenciaCarga == 0 && (obj.CodigoCargaEmbarcador == codigoEmbarcador || obj.CodigosAgrupados.Contains(codigoEmbarcador)) && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada select obj;
            var result = from obj in query where obj.NumeroSequenciaCarga == 0 && codigosCarga.Contains(obj.Codigo) && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada select obj;

            if (!string.IsNullOrWhiteSpace(codigoFilialEmbarcador))
                result = result.Where(obj => obj.Filial.CodigoFilialEmbarcador == codigoFilialEmbarcador || obj.Filial.OutrosCodigosIntegracao.Contains(codigoFilialEmbarcador));

            if (semPreCargas)
                result = result.Where(obj => !obj.CargaDePreCarga);

            return result.OrderByDescending(obj => obj.Codigo).ToList();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoCargaEmbarcadorECodigoIntegracaoFilial(string codigoCargaEmbarcador, string codigoIntegracaoFilial)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = query.Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador && obj.Filial.CodigoFilialEmbarcador == codigoIntegracaoFilial);

            result = result.Where(obj => obj.CargaFechada && obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.SituacaoCarga != SituacaoCarga.Anulada);

            return result.FirstOrDefault();
        }

        public List<int> BuscarTodasCargasPendentesAvancoPacotes(int limiteRegistros)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o =>
                    o.CargaFechada &&
                    o.DataSalvouDadosCarga.HasValue &&
                    o.TipoOperacao != null &&
                    o.TipoOperacao.ConfiguracaoCarga != null &&
                    o.TipoOperacao.ConfiguracaoCarga.TempoParaRecebimentoDosPacotes > 0 &&
                    o.SituacaoCarga == SituacaoCarga.AgNFe &&
                    DateTime.Now.AddHours(-o.TipoOperacao.ConfiguracaoCarga.TempoParaRecebimentoDosPacotes) > o.DataSalvouDadosCarga
                );

            return consultaCarga.Select(o => o.Codigo).Take(limiteRegistros).ToList();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarCargaPorCodigoEmbarcador(string codigoEmbarcador)
        {
            IList<int> codigosCarga = this.BuscarCodigosCargaEmCargasEEmCodigosAgrupados(codigoEmbarcador);
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(obj => codigosCarga.Contains(obj.Codigo) && !obj.CargaDePreCarga && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada && (obj.TipoOperacao == null || !obj.TipoOperacao.UtilizarExpedidorComoTransportador || (obj.TipoOperacao.UtilizarExpedidorComoTransportador && obj.TipoOperacao.OperacaoDeRedespacho)));

            return query.FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarCargaPorCodigoEmbarcadorProcessarDocumentos(string codigoEmbarcador)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(obj => obj.CodigoCargaEmbarcador == codigoEmbarcador && !obj.CargaDePreCarga && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada && obj.Redespacho == null && (obj.TipoOperacao == null || !obj.TipoOperacao.UtilizarExpedidorComoTransportador || (obj.TipoOperacao.UtilizarExpedidorComoTransportador && obj.TipoOperacao.OperacaoDeRedespacho)));

            return query.FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarCargaPorCodigoEmbarcadorInclindoCanceladas(string codigoEmbarcador)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(obj => obj.CodigoCargaEmbarcador == codigoEmbarcador && !obj.CargaDePreCarga && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada
                     && (obj.TipoOperacao == null || !obj.TipoOperacao.UtilizarExpedidorComoTransportador || (obj.TipoOperacao.UtilizarExpedidorComoTransportador && obj.TipoOperacao.OperacaoDeRedespacho))
                     && (obj.DadosSumarizados == null || obj.DadosSumarizados.CargaTrecho != CargaTrechoSumarizada.SubCarga));

            return query.FirstOrDefault();
        }


        public DateTime? BuscarDataPreTripCargaCanceladaPorCodigoEmbarcadorEVeiculo(string codigoEmbarcador, int veiculo)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(obj => obj.CodigoCargaEmbarcador == codigoEmbarcador && obj.Veiculo.Codigo == veiculo && !obj.CargaDePreCarga && obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada
                     && (obj.TipoOperacao == null || !obj.TipoOperacao.UtilizarExpedidorComoTransportador || (obj.TipoOperacao.UtilizarExpedidorComoTransportador && obj.TipoOperacao.OperacaoDeRedespacho))
                     && (obj.DadosSumarizados == null || obj.DadosSumarizados.CargaTrecho != CargaTrechoSumarizada.SubCarga)).OrderByDescending(obj => obj.Codigo);

            return query.Select(obj => obj.DataPreViagemInicio).FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoEmbarcador(string codigoEmbarcador)
        {
            IList<int> codigosCarga = this.BuscarCodigosCargaEmCargasEEmCodigosAgrupados(codigoEmbarcador);
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            //Alterado OR da consulta do nro carga com codigos agrupados para buscar antes os codigos das cargas praa depois fazer um IN
            //query = query.Where(obj => (obj.CodigoCargaEmbarcador == codigoEmbarcador || obj.CodigosAgrupados.Contains(codigoEmbarcador)) && !obj.CargaDePreCarga && obj.NumeroSequenciaCarga == 0 && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada && (obj.TipoOperacao == null || !obj.TipoOperacao.UtilizarExpedidorComoTransportador || (obj.TipoOperacao.UtilizarExpedidorComoTransportador && obj.TipoOperacao.OperacaoDeRedespacho)));
            query = query.Where(obj => codigosCarga.Contains(obj.Codigo) && !obj.CargaDePreCarga && obj.NumeroSequenciaCarga == 0 && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada && (obj.TipoOperacao == null || !obj.TipoOperacao.UtilizarExpedidorComoTransportador || (obj.TipoOperacao.UtilizarExpedidorComoTransportador && obj.TipoOperacao.OperacaoDeRedespacho)));

            return query.FirstOrDefault();
        }

        public Task<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarPorCodigoEmbarcadorAsync(string codigoEmbarcador)
        {
            IList<int> codigosCarga = this.BuscarCodigosCargaEmCargasEEmCodigosAgrupados(codigoEmbarcador);
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(obj => codigosCarga.Contains(obj.Codigo) &&
                              !obj.CargaDePreCarga &&
                              obj.NumeroSequenciaCarga == 0 &&
                              obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada &&
                              obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada &&
                              (obj.TipoOperacao == null || !obj.TipoOperacao.UtilizarExpedidorComoTransportador || (obj.TipoOperacao.UtilizarExpedidorComoTransportador && obj.TipoOperacao.OperacaoDeRedespacho))
                );

            return query.FirstOrDefaultAsync(CancellationToken);
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoEmbarcador(string codigoEmbarcador, bool semPreCargas)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query where obj.CodigoCargaEmbarcador == codigoEmbarcador && obj.NumeroSequenciaCarga == 0 && (obj.CargaFechada || (!obj.CargaFechada && obj.CargaAgrupamento != null)) && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada && (obj.TipoOperacao == null || obj.TipoOperacao.UtilizarExpedidorComoTransportador == false || (obj.TipoOperacao.UtilizarExpedidorComoTransportador && obj.TipoOperacao.OperacaoDeRedespacho)) select obj;

            if (semPreCargas)
                result = result.Where(obj => !obj.CargaDePreCarga);

            return result.OrderBy(obj => obj.CargaDePreCarga).OrderBy(obj => obj.Codigo).FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPreCargaPorNumeroCargaVincularPreCarga(string numeroCargaVincularPreCarga, List<Dominio.Entidades.Embarcador.Cargas.Carga> lstCargas = null)
        {

            if (lstCargas != null && lstCargas.Count > 0)
            {
                return lstCargas.Where(obj => obj.CodigoCargaEmbarcador == numeroCargaVincularPreCarga
                                        && obj.CargaDePreCarga && (obj.CargaFechada || (!obj.CargaFechada && obj.CargaAgrupamento != null)) && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada
                                        && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada).FirstOrDefault();
            }


            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query
                         where obj.CodigoCargaEmbarcador == numeroCargaVincularPreCarga
                         && obj.CargaDePreCarga && (obj.CargaFechada || (!obj.CargaFechada && obj.CargaAgrupamento != null)) && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada
                         && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada
                         select obj;

            return result.FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPreCargaVinculadaCargaPedidoImportacao(string numeroCargaVincularPreCarga, List<Dominio.Entidades.Embarcador.Cargas.Carga> lstCargas = null)
        {

            if (lstCargas != null && lstCargas.Count > 0)
            {
                return lstCargas.Where(obj => obj.NumeroCargaVincularPreCarga == numeroCargaVincularPreCarga
                                    && obj.CargaDePreCarga && (obj.CargaFechada || (!obj.CargaFechada && obj.CargaAgrupamento != null)) && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada
                                    && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada).FirstOrDefault();
            }

            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query
                         where obj.NumeroCargaVincularPreCarga == numeroCargaVincularPreCarga
                         && obj.CargaDePreCarga && (obj.CargaFechada || (!obj.CargaFechada && obj.CargaAgrupamento != null)) && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada
                         && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada
                         select obj;

            return result.FirstOrDefault();
        }
        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasPornumeroCargaVincularPreCarga(List<string> numerosCargaVincularPreCarga)
        {
            return this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>().Where(x => numerosCargaVincularPreCarga.Contains(x.NumeroCargaVincularPreCarga)).ToList();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoEmbarcadorCargaFechada(string codigoEmbarcador)
        {
            IList<int> codigosCarga = this.BuscarCodigosCargaEmCargasEEmCodigosAgrupados(codigoEmbarcador);
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            //Alterado OR da consulta do nro carga com codigos agrupados para buscar antes os codigos das cargas praa depois fazer um IN
            //var result = from obj in query where (obj.CodigoCargaEmbarcador == codigoEmbarcador || obj.CodigosAgrupados.Contains(codigoEmbarcador)) && obj.NumeroSequenciaCarga == 0 && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada && (obj.TipoOperacao == null || obj.TipoOperacao.UtilizarExpedidorComoTransportador == false || (obj.TipoOperacao.UtilizarExpedidorComoTransportador && obj.TipoOperacao.OperacaoDeRedespacho && obj.CargaFechada == true)) select obj;
            var result = from obj in query where codigosCarga.Contains(obj.Codigo) && obj.NumeroSequenciaCarga == 0 && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada && (obj.TipoOperacao == null || obj.TipoOperacao.UtilizarExpedidorComoTransportador == false || (obj.TipoOperacao.UtilizarExpedidorComoTransportador && obj.TipoOperacao.OperacaoDeRedespacho && obj.CargaFechada == true)) select obj;
            return result.FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga PesquisaPorCodigoEmbarcador(string codigoEmbarcador)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query
                         where
                            obj.CodigoCargaEmbarcador.Contains(codigoEmbarcador)
                         select obj;

            return result.FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga PesquisaPorCodigoEmbarcadorSituacaoValida(string codigoEmbarcador)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query
                         where
                            obj.CodigoCargaEmbarcador == codigoEmbarcador && obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.SituacaoCarga != SituacaoCarga.AgNFe && obj.SituacaoCarga != SituacaoCarga.AgImpressaoDocumentos
                         select obj;

            return result.FirstOrDefault();
        }

        public List<string> ConsultarSeExisteCargaPendente(int codigoEmpresa, DateTime dataFechamento, SituacaoCarga[] situacaoCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.DataCriacaoCarga < dataFechamento.AddDays(1).Date && situacaoCarga.Contains(o.SituacaoCarga));

            if (codigoEmpresa > 0)
                query = query.Where(c => c.Empresa.Codigo == codigoEmpresa);

            return query.Select(o => o.CodigoCargaEmbarcador).ToList();
        }

        public int BuscarIndiceAtrasoForaPrazo(bool maisQueUmDiaAtraso, DateTime dataInicial, DateTime dataFinal, int codigoOperador, int codigoCentroCarregamento, int codigoTransportador, int codigoFilial, double cpfCnpjDestinatario, int codigoModeloVeiculo, int codigoTipoCarga, int rota)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.SituacaoCarga != SituacaoCarga.Cancelada);

            var consultaCargaJanelaCarregamento = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento>()
                .Where(o => o.Situacao == SituacaoCargaJanelaCarregamento.ProntaParaCarregamento && (((TipoCargaJanelaCarregamento?)o.Tipo).HasValue == false || o.Tipo == TipoCargaJanelaCarregamento.Carregamento));

            if (maisQueUmDiaAtraso)
                consultaCargaJanelaCarregamento = consultaCargaJanelaCarregamento.Where(o => o.DiasAtraso > 1);
            else
                consultaCargaJanelaCarregamento = consultaCargaJanelaCarregamento.Where(o => o.DiasAtraso > 0 && o.DiasAtraso <= 1);

            if (dataInicial != DateTime.MinValue)
                consultaCargaJanelaCarregamento = consultaCargaJanelaCarregamento.Where(o => o.InicioCarregamento >= dataInicial.Date);

            if (dataFinal != DateTime.MinValue)
                consultaCargaJanelaCarregamento = consultaCargaJanelaCarregamento.Where(o => o.InicioCarregamento < dataFinal.AddDays(1).Date);

            if (codigoCentroCarregamento > 0)
                consultaCargaJanelaCarregamento = consultaCargaJanelaCarregamento.Where(o => o.CentroCarregamento.Codigo == codigoCentroCarregamento);

            if (codigoOperador > 0)
                consultaCarga = consultaCarga.Where(o => o.Operador.Codigo == codigoOperador);

            if (codigoTransportador > 0)
                consultaCarga = consultaCarga.Where(o => o.Empresa.Codigo == codigoTransportador);

            if (codigoFilial > 0)
                consultaCarga = consultaCarga.Where(o => o.Filial.Codigo == codigoFilial);

            if (cpfCnpjDestinatario > 0d)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.Destinatario.CPF_CNPJ == cpfCnpjDestinatario));

            if (codigoModeloVeiculo > 0)
                consultaCarga = consultaCarga.Where(o => o.ModeloVeicularCarga.Codigo == codigoModeloVeiculo);

            if (codigoTipoCarga > 0)
                consultaCarga = consultaCarga.Where(o => o.TipoDeCarga.Codigo == codigoTipoCarga);

            if (rota > 0)
                consultaCarga = consultaCarga.Where(o => o.Rota.Codigo == rota);

            consultaCarga = consultaCarga.Where(o => consultaCargaJanelaCarregamento.Any(j => j.Carga.Codigo == o.Codigo));

            return consultaCarga.Select(o => o.Codigo).Count();
        }

        public int BuscarIndiceAtraso(bool dentroPrazo, DateTime dataInicial, DateTime dataFinal, int codigoOperador, int codigoCentroCarregamento, int codigoTransportador, int codigoFilial, double cpfCnpjDestinatario, int codigoModeloVeiculo, int codigoTipoCarga, int rota)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.SituacaoCarga != SituacaoCarga.Cancelada);

            var consultaCargaJanelaCarregamento = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento>()
                .Where(o => o.Situacao == SituacaoCargaJanelaCarregamento.ProntaParaCarregamento && (((TipoCargaJanelaCarregamento?)o.Tipo).HasValue == false || o.Tipo == TipoCargaJanelaCarregamento.Carregamento));

            if (dentroPrazo)
                consultaCargaJanelaCarregamento = consultaCargaJanelaCarregamento.Where(o => o.DiasAtraso <= 0);
            else
                consultaCargaJanelaCarregamento = consultaCargaJanelaCarregamento.Where(o => o.DiasAtraso > 0);

            if (dataInicial != DateTime.MinValue)
                consultaCargaJanelaCarregamento = consultaCargaJanelaCarregamento.Where(o => o.InicioCarregamento >= dataInicial.Date);

            if (dataFinal != DateTime.MinValue)
                consultaCargaJanelaCarregamento = consultaCargaJanelaCarregamento.Where(o => o.InicioCarregamento < dataFinal.AddDays(1).Date);

            if (codigoCentroCarregamento > 0)
                consultaCargaJanelaCarregamento = consultaCargaJanelaCarregamento.Where(o => o.CentroCarregamento.Codigo == codigoCentroCarregamento);

            if (codigoOperador > 0)
                consultaCarga = consultaCarga.Where(o => o.Operador.Codigo == codigoOperador);

            if (codigoTransportador > 0)
                consultaCarga = consultaCarga.Where(o => o.Empresa.Codigo == codigoTransportador);

            if (codigoFilial > 0)
                consultaCarga = consultaCarga.Where(o => o.Filial.Codigo == codigoFilial);

            if (cpfCnpjDestinatario > 0d)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.Destinatario.CPF_CNPJ == cpfCnpjDestinatario));

            if (codigoModeloVeiculo > 0)
                consultaCarga = consultaCarga.Where(o => o.ModeloVeicularCarga.Codigo == codigoModeloVeiculo);

            if (codigoTipoCarga > 0)
                consultaCarga = consultaCarga.Where(o => o.TipoDeCarga.Codigo == codigoTipoCarga);

            if (rota > 0)
                consultaCarga = consultaCarga.Where(o => o.Rota.Codigo == rota);

            consultaCarga = consultaCarga.Where(o => consultaCargaJanelaCarregamento.Any(j => j.Carga.Codigo == o.Codigo));

            return consultaCarga.Select(o => o.Codigo).Count();
        }


        public int ObterProximoCodigo()
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query where obj.CargaFechada select obj;

            int? retorno = result.Max(o => (int?)o.NumeroSequenciaCarga);
            return retorno.HasValue ? (retorno.Value + 1) : 1;
        }

        /// <summary>
        /// Não utilizar diretamente esse método, chamar o serviço CargaSequencial para obter o próximo código
        /// </summary>
        public int ObterProximoCodigo(int? codigoFilial)
        {
            string sql = $@"select MAX(carga.CAR_NUMERO_SEQUENCIAL) from T_CARGA carga WITH(NOLOCK) where carga.CAR_CARGA_FECHADA = 1";

            if (codigoFilial.HasValue)
            {
                if (codigoFilial.Value > 0)
                    sql += $" and carga.FIL_CODIGO = {codigoFilial}";
                else
                    sql += $" and carga.FIL_CODIGO is null";
            }

            var consultaCarga = this.SessionNHiBernate.CreateSQLQuery(sql);

            int? retorno = consultaCarga.UniqueResult<int?>();
            return retorno.HasValue ? (retorno.Value + 1) : 1;
        }

        public string ObtemUltimoSequencialAlfanumericoCarga(int quantidadeCaracteres)
        {
            var sql = $@"SELECT TOP 1 CAR_CODIGO_ALFANUMERICO_CARGA
                         FROM T_CARGA
                         WHERE CAR_CODIGO_ALFANUMERICO_CARGA IS NOT NULL
                            AND ISNULL(LEN(CAR_CODIGO_ALFANUMERICO_CARGA), 0) = {quantidadeCaracteres}
                         ORDER BY CAR_CODIGO DESC";

            var ultimoSequencialAlfanumericoCarga = this.SessionNHiBernate.CreateSQLQuery(sql);

            return ultimoSequencialAlfanumericoCarga.SetTimeout(600).UniqueResult<string>();
        }

        public int ObterProximoCodigoPorFilialOperacao(Dominio.Entidades.Embarcador.Filiais.Filial filial, int codigoTipoOperacao)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query where obj.CargaFechada select obj;

            if (filial != null)
                result = result.Where(obj => obj.Filial.Codigo == filial.Codigo);
            else
                result = result.Where(obj => obj.Filial == null);

            if (codigoTipoOperacao > 0)
                result = result.Where(obj => obj.TipoOperacao.Codigo == codigoTipoOperacao);

            int? retorno = result.Max(o => (int?)o.NumeroSequenciaCarga);
            return retorno.HasValue ? (retorno.Value + 1) : 1;
        }

        public GraficoValorMedioFrete BuscarValorMedioFrete(DateTime dataInicial, DateTime dataFinal, int codigoOperador, int codigoCentroCarregamento, int codigoTransportador, int codigoFilial, double cpfCnpjDestinatario, int codigoModeloVeiculo, int codigoTipoCarga)
        {
            string where = "carga.CAR_SITUACAO in (9, 10, 11)";

            if (dataInicial != DateTime.MinValue)
                where += " and janela.CJC_INICIO_CARREGAMENTO >= '" + dataInicial.ToString("yyyy-MM-dd") + "'";

            if (dataFinal != DateTime.MinValue)
                where += " and janela.CJC_INICIO_CARREGAMENTO < '" + dataFinal.AddDays(1).ToString("yyyy-MM-dd") + "'";

            if (codigoOperador > 0)
                where += " and carga.CAR_OPERADOR = " + codigoOperador.ToString();

            if (codigoCentroCarregamento > 0)
                where += " and janela.CEC_CODIGO = " + codigoCentroCarregamento.ToString();

            if (codigoTransportador > 0)
                where += " and carga.EMP_CODIGO = " + codigoTransportador.ToString();

            if (codigoTransportador > 0)
                where += " and carga.EMP_CODIGO = " + codigoTransportador.ToString();

            if (codigoFilial > 0)
                where += " and carga.FIL_CODIGO = " + codigoFilial.ToString();

            if (cpfCnpjDestinatario > 0d)
                where += " and pedido.CLI_CODIGO = " + cpfCnpjDestinatario.ToString("F0");

            if (codigoModeloVeiculo > 0)
                where += " and carga.MVC_CODIGO = " + codigoModeloVeiculo.ToString();

            if (codigoTipoCarga > 0)
                where += " and carga.TCG_CODIGO = " + codigoTipoCarga.ToString();

            string sql = @"SELECT SUM(ValorFrete) ValorTotalFrete, SUM(Distancia) DistanciaTotal, SUM(Peso) PesoTotal FROM (
                           SELECT carga.CAR_CODIGO, 
                           MAX(carga.CAR_VALOR_FRETE_PAGAR) + MAX(carga.CAR_VALOR_ICMS) ValorFrete, 
                           (SELECT SUM(percurso.CPD_DISTANCIA_KM) FROM T_CARGA_PERCURSO percurso WHERE percurso.CAR_CODIGO = carga.CAR_CODIGO) Distancia,
                           (SELECT SUM(pedido.PED_PESO) FROM T_CARGA_PEDIDO pedido WHERE pedido.CAR_CODIGO = carga.CAR_CODIGO) Peso
                           FROM T_CARGA carga
                           LEFT OUTER JOIN T_CARGA_PEDIDO cargaPedido ON cargaPedido.CAR_CODIGO = carga.CAR_CODIGO
                           LEFT OUTER JOIN T_PEDIDO pedido on pedido.PED_CODIGO = cargaPedido.PED_CODIGO
                           LEFT OUTER JOIN T_CARGA_JANELA_CARREGAMENTO janela on janela.CAR_CODIGO = carga.CAR_CODIGO " +
                           "WHERE " + where + " GROUP BY carga.CAR_CODIGO) as grp";

            var query = this.SessionNHiBernate.CreateSQLQuery(sql);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.GraficoValorMedioFrete)));

            return query.UniqueResult<Dominio.ObjetosDeValor.Embarcador.Carga.GraficoValorMedioFrete>();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoEmbarcador(string codigoEmbarcador, int filial)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query where obj.CodigoCargaEmbarcador == codigoEmbarcador && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada select obj;

            if (filial > 0)
                result = result.Where(obj => obj.Filial.Codigo == filial);
            else
                result = result.Where(obj => obj.Filial == null);

            return result.FirstOrDefault();
        }

        public IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaCancelamento> ObterCargasEmCancelamento()
        {
            var queryCancelamento = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCancelamento>();

            queryCancelamento = queryCancelamento.Where(obj => obj.Situacao == SituacaoCancelamentoCarga.AgCancelamentoAverbacaoCTe ||
                                                               obj.Situacao == SituacaoCancelamentoCarga.AgCancelamentoAverbacaoMDFe ||
                                                               obj.Situacao == SituacaoCancelamentoCarga.AgCancelamentoCTe ||
                                                               obj.Situacao == SituacaoCancelamentoCarga.AgCancelamentoMDFe ||
                                                               obj.Situacao == SituacaoCancelamentoCarga.AgAprovacaoSolicitacao ||
                                                               obj.Situacao == SituacaoCancelamentoCarga.AgIntegracao ||
                                                               obj.Situacao == SituacaoCancelamentoCarga.EmCancelamento ||
                                                               obj.Situacao == SituacaoCancelamentoCarga.FinalizandoCancelamento);

            return queryCancelamento;
        }

        public bool CargaEstaEmCancelamento(int codigoCarga)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaCancelamento> queryCancelamento = this.ObterCargasEmCancelamento()
                .Where(obj => obj.Carga.Codigo == codigoCarga);

            return queryCancelamento.Any();
        }

        //No MultiTMS a emissão é autorizada após o calculo do frete
        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscaCodigosCargasAutorizadasEmissaoNaEtapaDeFretePadraoEIntegracao(List<int> codigosEmpresasNaoBuscar, DateTime tempoParaEmissao, int maximoRegistros, bool informarCienciaNotasAntesEmissao, bool exigirCargaRoteirizada, int inicioContadorNotas, int fimContadorNotas, int inicioContadorPedidos, int fimContadorPedidos)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var queryCancelamento = ObterCargasEmCancelamento();
            List<SituacaoAlteracaoFreteCarga> situacoesAlteracaoFretePermitemAvancarEtapa = SituacaoAlteracaoFreteCargaHelper.ObterSituacoesPermitemAvancarEtapa();

            query = query.Where(obj =>
                obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete &&
                obj.ExigeNotaFiscalParaCalcularFrete &&
                (obj.DataEnvioUltimaNFe.HasValue && obj.DataEnvioUltimaNFe.Value <= tempoParaEmissao) &&
                !obj.AguardandoEmissaoDocumentoAnterior &&
                !obj.CalculandoFrete &&
                obj.CargaFechada &&
                !obj.PendenteGerarCargaDistribuidor &&
                !obj.AgValorRedespacho &&
                situacoesAlteracaoFretePermitemAvancarEtapa.Contains(obj.SituacaoAlteracaoFreteCarga) &&
                !queryCancelamento.Select(can => can.Carga.Codigo).Any(cac => cac == obj.Codigo)
            );

            if (codigosEmpresasNaoBuscar.Count() > 0)
                query = query.Where(o => !codigosEmpresasNaoBuscar.Contains(o.Empresa.Codigo));

            // Processar Carga Padrão e Integração, não processar carga de Reprocessamento
            query = query.Where(o => o.CalcularFreteLote != Dominio.Enumeradores.LoteCalculoFrete.Reprocessamento);

            if (informarCienciaNotasAntesEmissao)
                query = query.Where(obj => obj.Pedidos.All(o => o.CienciaDoEnvioDaNotaInformado));

            if (exigirCargaRoteirizada)
                query = query.Where(o => o.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Concluido);
            else
                query = query.Where(o => o.TipoOperacao.ExigirCargaRoteirizada ? o.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Concluido : true);

            //Tratativa Filas Notas
            if (inicioContadorNotas == 0 && fimContadorNotas > 0)
            {
                IQueryable<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> queryPedidoXMLNotaFiscal = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal>();
                query = query.Where(ped => queryPedidoXMLNotaFiscal.Where(a => a.CargaPedido.Carga.Codigo == ped.Codigo).Count() <= fimContadorNotas);
            }
            else if (inicioContadorNotas > 0 && fimContadorNotas > 0)
            {
                IQueryable<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> queryPedidoXMLNotaFiscal = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal>();
                query = query.Where(ped => queryPedidoXMLNotaFiscal.Where(a => a.CargaPedido.Carga.Codigo == ped.Codigo).Count() > inicioContadorNotas && queryPedidoXMLNotaFiscal.Where(a => a.CargaPedido.Carga.Codigo == ped.Codigo).Count() <= fimContadorNotas);
            }
            else if (inicioContadorNotas > 0 && fimContadorNotas == 0)
            {
                IQueryable<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> queryPedidoXMLNotaFiscal = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal>();
                query = query.Where(ped => queryPedidoXMLNotaFiscal.Where(a => a.CargaPedido.Carga.Codigo == ped.Codigo).Count() > inicioContadorNotas);
            }

            //Tratativa Filas Pedidos
            if (inicioContadorPedidos == 0 && fimContadorPedidos > 0)
            {
                IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
                query = query.Where(carga => queryCargaPedido.Where(a => a.Carga.Codigo == carga.Codigo).Count() <= fimContadorPedidos);
            }
            else if (inicioContadorPedidos > 0 && fimContadorPedidos > 0)
            {
                IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
                query = query.Where(carga => queryCargaPedido.Where(a => a.Carga.Codigo == carga.Codigo).Count() > inicioContadorPedidos && queryCargaPedido.Where(a => a.Carga.Codigo == carga.Codigo).Count() <= fimContadorPedidos);
            }
            else if (inicioContadorPedidos > 0 && fimContadorPedidos == 0)
            {
                IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
                query = query.Where(carga => queryCargaPedido.Where(a => a.Carga.Codigo == carga.Codigo).Count() > inicioContadorPedidos);
            }

            return query.OrderBy(o => o.DataInicioGeracaoCTes).Take(maximoRegistros).ToList();
        }

        //No MultiTMS a emissão é autorizada após o calculo do frete
        public List<int> BuscaCodigosCargasAutorizadasEmissaoNaEtapaDeFrete(DateTime tempoParaEmissao, int maximoRegistros, Dominio.Enumeradores.LoteCalculoFrete ControleCalculoFrete, bool informarCienciaNotasAntesEmissao, bool exigirCargaRoteirizada, int inicioContadorNotas, int fimContadorNotas, int inicioContadorPedidos, int fimContadorPedidos)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var queryCancelamento = ObterCargasEmCancelamento();
            List<SituacaoAlteracaoFreteCarga> situacoesAlteracaoFretePermitemAvancarEtapa = SituacaoAlteracaoFreteCargaHelper.ObterSituacoesPermitemAvancarEtapa();

            query = query.Where(obj =>
                obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete &&
                obj.ExigeNotaFiscalParaCalcularFrete &&
                (obj.DataEnvioUltimaNFe.HasValue && obj.DataEnvioUltimaNFe.Value <= tempoParaEmissao) &&
                !obj.AguardandoEmissaoDocumentoAnterior &&
                !obj.CalculandoFrete &&
                obj.CargaFechada &&
                !obj.PendenteGerarCargaDistribuidor &&
                !obj.AgValorRedespacho &&
                situacoesAlteracaoFretePermitemAvancarEtapa.Contains(obj.SituacaoAlteracaoFreteCarga) &&
                !queryCancelamento.Select(can => can.Carga.Codigo).Any(cac => cac == obj.Codigo)
            );

            if (ControleCalculoFrete == Dominio.Enumeradores.LoteCalculoFrete.Integracao)
                query = query.Where(o => o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote) || (o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Integracao));
            else if (ControleCalculoFrete == Dominio.Enumeradores.LoteCalculoFrete.Padrao)
                query = query.Where(o => !o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote) && (o.CalcularFreteLote == null || o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Padrao));
            else if (ControleCalculoFrete == Dominio.Enumeradores.LoteCalculoFrete.Reprocessamento)
                query = query.Where(o => !o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote) && (o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Reprocessamento));

            if (informarCienciaNotasAntesEmissao)
                query = query.Where(obj => obj.Pedidos.All(o => o.CienciaDoEnvioDaNotaInformado));

            if (exigirCargaRoteirizada)
                query = query.Where(o => o.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Concluido);
            else
                query = query.Where(o => o.TipoOperacao.ExigirCargaRoteirizada ? o.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Concluido : true);

            //Tratativa Filas Notas
            if (inicioContadorNotas == 0 && fimContadorNotas > 0)
            {
                IQueryable<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> queryPedidoXMLNotaFiscal = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal>();
                query = query.Where(ped => queryPedidoXMLNotaFiscal.Where(a => a.CargaPedido.Carga.Codigo == ped.Codigo).Count() <= fimContadorNotas);
            }
            else if (inicioContadorNotas > 0 && fimContadorNotas > 0)
            {
                IQueryable<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> queryPedidoXMLNotaFiscal = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal>();
                query = query.Where(ped => queryPedidoXMLNotaFiscal.Where(a => a.CargaPedido.Carga.Codigo == ped.Codigo).Count() > inicioContadorNotas && queryPedidoXMLNotaFiscal.Where(a => a.CargaPedido.Carga.Codigo == ped.Codigo).Count() <= fimContadorNotas);
            }
            else if (inicioContadorNotas > 0 && fimContadorNotas == 0)
            {
                IQueryable<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal> queryPedidoXMLNotaFiscal = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal>();
                query = query.Where(ped => queryPedidoXMLNotaFiscal.Where(a => a.CargaPedido.Carga.Codigo == ped.Codigo).Count() > inicioContadorNotas);
            }

            //Tratativa Filas Pedidos
            if (inicioContadorPedidos == 0 && fimContadorPedidos > 0)
            {
                IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
                query = query.Where(carga => queryCargaPedido.Where(a => a.Carga.Codigo == carga.Codigo).Count() <= fimContadorPedidos);
            }
            else if (inicioContadorPedidos > 0 && fimContadorPedidos > 0)
            {
                IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
                query = query.Where(carga => queryCargaPedido.Where(a => a.Carga.Codigo == carga.Codigo).Count() > inicioContadorPedidos && queryCargaPedido.Where(a => a.Carga.Codigo == carga.Codigo).Count() <= fimContadorPedidos);
            }
            else if (inicioContadorPedidos > 0 && fimContadorPedidos == 0)
            {
                IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
                query = query.Where(carga => queryCargaPedido.Where(a => a.Carga.Codigo == carga.Codigo).Count() > inicioContadorPedidos);
            }

            return query.OrderBy(o => o.DataInicioGeracaoCTes).Take(maximoRegistros).Select(o => o.Codigo).ToList();
        }

        public List<int> BuscaCargasFilialEmissoraGerarCTeAnterior(int maximoRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query
                         where obj.EmpresaFilialEmissora != null && obj.AgGeracaoCTesAnteriorFilialEmissora
                         select obj;

            return result
                .OrderBy(o => o.DataInicioGeracaoCTes)
                .Select(o => o.Codigo)
                .Take(maximoRegistros)
                .ToList();
        }

        public List<int> BuscaCargasGerarCTeAnteriorEmitirDocumentoSempreOrigemDestinoPedido(int maximoRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from carga in query
                         where
                            carga.TipoOperacao != null && carga.TipoOperacao.ConfiguracaoEmissaoDocumento != null &&
                            carga.TipoOperacao.ConfiguracaoEmissaoDocumento.EmitirDocumentoSempreOrigemDestinoPedido &&
                            carga.AgGeracaoCTesAnteriorFilialEmissora &&
                            carga.EmpresaFilialEmissora == null
                         select carga;

            return result
                .OrderBy(o => o.DataInicioGeracaoCTes)
                .Select(o => o.Codigo)
                .Take(maximoRegistros)
                .ToList();
        }

        public List<int> BuscarCodigosCargasEmEmissao(int maximoRegistros, bool controlePorLote)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(obj => obj.EmitindoCTes && obj.CargaFechada);

            if (controlePorLote)
                query = query.Where(o => o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote));
            else
                query = query.Where(o => !o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote));


            return query.Take(maximoRegistros).Select(s => s.Codigo).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasEmEmissao(int maximoRegistros, bool controlePorLote)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(obj => obj.EmitindoCTes && obj.CargaFechada);

            if (controlePorLote)
                query = query.Where(o => o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote));
            else
                query = query.Where(o => !o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote));

            return query.Take(maximoRegistros).ToList();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.CargaMensagem> BuscarCodigosCargasCTesRejeitados(int quantidadeCargas, int quantidadeTentativas, string dataParametro, string dataReenvio)
        {
            var sql = @"SELECT distinct TOP " + quantidadeCargas.ToString() + " CA.CAR_CODIGO CodigoCarga  " + // SQL-INJECTION-SAFE
                      @" FROM T_CARGA CA
                         JOIN T_CARGA_CTE CT ON CA.CAR_CODIGO = CT.CAR_CODIGO
                         JOIN T_CTE CTE ON CTE.CON_CODIGO = CT.CON_CODIGO
                         LEFT JOIN T_ERRO_SEFAZ ERRO ON CTE.ERR_CODIGO = ERRO.ERR_CODIGO
                        WHERE 
                         CAR_SITUACAO = 6
                         AND CAR_EMITINDO_CTES = 0
                         AND CAR_POSSUI_PENDENCIA = 1
                         AND CAR_PROBLEMA_CTE =  1
                         AND CON_RETORNOCTEDATA >= '" + dataParametro + "'" +
                       " AND '" + dataReenvio + "'" + " >= CON_RETORNOCTEDATA" +
                      @" AND CON_STATUS ='R' 
                         AND CON_TENTATIVA_REENVIO <=  " + quantidadeTentativas.ToString() + // SQL-INJECTION-SAFE
                     @"  AND (ERR_CODIGO_ERRO = '8888' or  
                              ERR_CODIGO_ERRO = '678' or  
	                          ERR_CODIGO_ERRO = '109' or  
	                          ERR_CODIGO_ERRO = '105' or  
	                          ERR_CODIGO_ERRO = '217' or 
	                          CON_RETORNOCTE like '%INDEVIDO%' or 
	                          CON_RETORNOCTE like '%HTTP: 0%' or 
                              CON_RETORNOCTE like '%HTTP: 404%' or 
                              CON_RETORNOCTE like '%HTTP: 503%' or 
                              CON_RETORNOCTE like '%paralisado%' or 
                              CON_RETORNOCTE like '%nao consta%' or 
	                          CON_RETORNOCTE like '%lote em %')";

            var consultaCargas = this.SessionNHiBernate.CreateSQLQuery(sql);

            consultaCargas.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.CargaMensagem)));

            return consultaCargas.SetTimeout(600).List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaMensagem>();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCodigosPentendesInicioViagemPorEmissao(int maximoRegistros, DateTime dataComparacao)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaCancelamento> queryCancelamento = ObterCargasEmCancelamento();

            query = query.Where(o => o.CargaFechada
            && !o.DataInicioViagem.HasValue
            && o.DataFinalizacaoEmissao.HasValue && o.DataFinalizacaoEmissao <= dataComparacao
            && o.SituacaoCarga != SituacaoCarga.Cancelada && o.SituacaoCarga != SituacaoCarga.Anulada
            && !queryCancelamento.Select(can => can.Carga.Codigo).Any(cac => cac == o.Codigo));

            return query.Take(maximoRegistros).ToList();
        }

        public List<int> BuscarCodigosCargasEmFinalizacao(int maximoRegistros, bool controlePorLote)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaCancelamento> queryCancelamento = ObterCargasEmCancelamento();

            query = query.Where(o => o.SituacaoCarga == SituacaoCarga.PendeciaDocumentos && o.FinalizandoProcessoEmissao && o.CargaFechada && !queryCancelamento.Select(can => can.Carga.Codigo).Any(cac => cac == o.Codigo));

            if (controlePorLote)
                query = query.Where(o => o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote));
            else
                query = query.Where(o => !o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote));

            return query.Take(maximoRegistros).Select(o => o.Codigo).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasAutorizadasEmissaoNaEtapaNFePadraoEIntegracao(List<int> codigosEmpresasNaoBuscar, DateTime tempoParaEmissao, int maximoRegistros, bool informarCienciaNotasAntesEmissao, bool naoAvancarRejeicaoIntegracaoTranspoortador, string propOrdenacao = "", string dirOrdenacao = "")// no Embarcador a emissão é autorizada após o envio das notas
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var queryCancelamento = ObterCargasEmCancelamento();

            query = query.Where(obj =>
                obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe &&
                obj.CargaFechada &&
                !obj.ExigeNotaFiscalParaCalcularFrete &&
                (obj.DataEnvioUltimaNFe.HasValue && obj.DataEnvioUltimaNFe.Value <= tempoParaEmissao) &&
                !obj.AguardandoEmissaoDocumentoAnterior &&
                !obj.ProcessandoDocumentosFiscais &&
                !obj.AguardarIntegracaoEtapaTransportador &&
                !obj.AgValorRedespacho &&
                !obj.PendenteGerarCargaDistribuidor &&
                !queryCancelamento.Select(can => can.Carga.Codigo).Any(cac => cac == obj.Codigo)
            );

            if (codigosEmpresasNaoBuscar.Count() > 0)
                query = query.Where(o => !codigosEmpresasNaoBuscar.Contains(o.Empresa.Codigo));

            // Processar Carga Padrão e Integração, não processar carga de Reprocessamento
            query = query.Where(o => o.CalcularFreteLote != Dominio.Enumeradores.LoteCalculoFrete.Reprocessamento);

            if (informarCienciaNotasAntesEmissao)
                query = query.Where(obj => obj.Pedidos.All(o => o.CienciaDoEnvioDaNotaInformado));

            if (!string.IsNullOrWhiteSpace(propOrdenacao) && !string.IsNullOrWhiteSpace(dirOrdenacao))
                query = query.OrderBy(propOrdenacao + " " + dirOrdenacao);

            if (naoAvancarRejeicaoIntegracaoTranspoortador)
                query = query.Where(o => !o.AguardarIntegracaoEtapaTransportador);

            return query.Take(maximoRegistros).ToList();
        }


        public List<int> BuscarCodigosCargasAutorizadasEmissaoNaEtapaNFe(DateTime tempoParaEmissao, int maximoRegistros, Dominio.Enumeradores.LoteCalculoFrete ControleCalculoFrete, bool informarCienciaNotasAntesEmissao, bool naoAvancarRejeicaoIntegracaoTranspoortador, string propOrdenacao = "", string dirOrdenacao = "")// no Embarcador a emissão é autorizada após o envio das notas
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var queryCancelamento = ObterCargasEmCancelamento();

            query = query.Where(obj =>
                obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe &&
                obj.CargaFechada &&
                !obj.ExigeNotaFiscalParaCalcularFrete &&
                (obj.DataEnvioUltimaNFe.HasValue && obj.DataEnvioUltimaNFe.Value <= tempoParaEmissao) &&
                !obj.AguardandoEmissaoDocumentoAnterior &&
                !obj.ProcessandoDocumentosFiscais &&
                !obj.AguardarIntegracaoEtapaTransportador &&
                !obj.AgValorRedespacho &&
                !obj.PendenteGerarCargaDistribuidor &&
                !obj.CalculandoFrete &&
                !queryCancelamento.Select(can => can.Carga.Codigo).Any(cac => cac == obj.Codigo)
            );

            if (ControleCalculoFrete == Dominio.Enumeradores.LoteCalculoFrete.Integracao)
                query = query.Where(o => o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote) || (o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Integracao));
            else if (ControleCalculoFrete == Dominio.Enumeradores.LoteCalculoFrete.Padrao)
                query = query.Where(o => !o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote) && (o.CalcularFreteLote == null || o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Padrao));
            else if (ControleCalculoFrete == Dominio.Enumeradores.LoteCalculoFrete.Reprocessamento)
                query = query.Where(o => !o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote) && (o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Reprocessamento));

            if (informarCienciaNotasAntesEmissao)
                query = query.Where(obj => obj.Pedidos.All(o => o.CienciaDoEnvioDaNotaInformado));

            if (!string.IsNullOrWhiteSpace(propOrdenacao) && !string.IsNullOrWhiteSpace(dirOrdenacao))
                query = query.OrderBy(propOrdenacao + " " + dirOrdenacao);

            if (naoAvancarRejeicaoIntegracaoTranspoortador)
                query = query.Where(o => !o.AguardarIntegracaoEtapaTransportador);

            return query.Take(maximoRegistros).Select(o => o.Codigo).ToList();
        }

        public List<int> BuscarCodigosCargasAutorizadasEmissaoCTesSubContratacaoFilialEmissora(int maximoRegistros, Dominio.Enumeradores.LoteCalculoFrete ControleCalculoFrete, string propOrdenacao = "", string dirOrdenacao = "")// no Embarcador a emissão é autorizada após o envio das notas
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var queryCancelamento = ObterCargasEmCancelamento();

            query = query.Where(obj => obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.PendeciaDocumentos && obj.CargaFechada
            && obj.LiberadaParaEmissaoCTeSubContratacaoFilialEmissora && obj.EmEmissaoCTeSubContratacaoFilialEmissora && !obj.PossuiPendencia && !obj.AgValorRedespacho
                  && !queryCancelamento.Select(can => can.Carga.Codigo).Any(cac => cac == obj.Codigo));

            if (!string.IsNullOrWhiteSpace(propOrdenacao) && !string.IsNullOrWhiteSpace(dirOrdenacao))
                query = query.OrderBy(propOrdenacao + " " + dirOrdenacao);

            if (ControleCalculoFrete == Dominio.Enumeradores.LoteCalculoFrete.Integracao)
                query = query.Where(o => o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote) || (o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Integracao));
            else if (ControleCalculoFrete == Dominio.Enumeradores.LoteCalculoFrete.Padrao)
                query = query.Where(o => !o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote) && (o.CalcularFreteLote == null || o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Padrao));
            else if (ControleCalculoFrete == Dominio.Enumeradores.LoteCalculoFrete.Reprocessamento)
                query = query.Where(o => !o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote) && (o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Reprocessamento));

            return query.Take(maximoRegistros).Select(o => o.Codigo).ToList();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscaCargPorVeiculoNotaFiscal(string placa, int numeroNota, string serieNota)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal>();
            var result = from obj in query where obj.CargaPedido.Carga.Veiculo.Placa == placa && (obj.CargaPedido.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.CargaPedido.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada && obj.CargaPedido.Carga.SituacaoCarga != SituacaoCarga.Encerrada && obj.CargaPedido.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento) select obj;
            result = result.Where(obj => obj.CargaPedido.Pedido.SituacaoPedido != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoPedido.Finalizado);
            result = result.Where(obj => obj.XMLNotaFiscal.Numero == numeroNota && obj.XMLNotaFiscal.Serie == serieNota);

            return result.Select(obj => obj.CargaPedido.Carga).FirstOrDefault();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscaCargaEmAbertoPorVeiculo(string placa)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
            var result = from obj in query where obj.Carga.Veiculo.Placa == placa && (obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada && obj.Carga.SituacaoCarga != SituacaoCarga.Encerrada && obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento) select obj;
            result = result.Where(obj => obj.Pedido.SituacaoPedido != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoPedido.Finalizado);
            return result.Select(obj => obj.Carga).Distinct().ToList();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga ObterPrimeiraCargaEmAbertoPorVeiculo(string placa)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
            var result = from obj in query where obj.Carga.Veiculo.Placa == placa && (obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada && obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada && obj.Carga.SituacaoCarga != SituacaoCarga.Encerrada && obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento) select obj;
            result = result.Where(obj => obj.Pedido.SituacaoPedido != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoPedido.Finalizado);
            return result.Select(obj => obj.Carga).Distinct().FirstOrDefault();
        }

        public List<RelacaoVeiculoCarga> BuscaCargasEmAbertoPorListaDeVeiculos(List<int> codigosVeiculos, DateTime data)
        {
            if (codigosVeiculos.IsNullOrEmpty() || data == DateTime.MinValue)
                return new List<RelacaoVeiculoCarga>();

            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
            var listaStatus = new List<SituacaoCarga>
            {
                SituacaoCarga.Cancelada,
                SituacaoCarga.Anulada,
                SituacaoCarga.Encerrada,
                SituacaoCarga.LiberadoPagamento
            };
            query = query.Where(x => codigosVeiculos.Contains(x.Carga.Veiculo.Codigo));
            query = query.Where(x => x.Carga.DataCriacaoCarga >= data && x.Carga.DataCriacaoCarga < data.AddDays(1));
            query = query.Where(x => !listaStatus.Contains(x.Carga.SituacaoCarga));
            query = query.Where(x => x.Pedido.SituacaoPedido != SituacaoPedido.Finalizado);
            query = query.Where(x => x.Carga.DadosSumarizados != null);

            return query.Select(x => new RelacaoVeiculoCarga
            {
                CodigoVeiculo = x.Carga.Veiculo.Codigo,
                CodigoCarga = x.Carga.CodigoCargaEmbarcador,
                Redespacho = x.Carga.DadosSumarizados.PossuiRedespacho,
                DataCarregamento = x.Carga.DataCarregamentoCarga,
                DataCriacao = x.Carga.DataCriacaoCarga
            }).ToList();
        }

        public string BuscaNumeroDaCargaEmAbertoPorVeiculo(int codigoCarga, string placa)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
            var result = from obj in query
                         where obj.Carga.Veiculo.Placa == placa &&
                               ((obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada &&
                                obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada &&
                                obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada &&
                                obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento) &&
                                obj.Pedido.SituacaoPedido != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoPedido.Finalizado) &&
                                obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte &&
                                obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgTransportador &&
                                obj.Carga.Codigo != codigoCarga && obj.Carga.CargaFechada
                         select obj;

            return result.Select(obj => obj.Carga.CodigoCargaEmbarcador).FirstOrDefault();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasAguardandoTransportador(List<string> codigos)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(carga => codigos.Contains(carga.CodigoCargaEmbarcador)).Fetch(x => x.Pedidos);

            return query.ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargaDePreCargaEmAbertoPorVeiculo(int codigoVeiculo, DateTime dataInicial, DateTime dataFinal)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(carga => carga.CargaDePreCarga && carga.DataCriacaoCarga >= dataInicial && carga.DataCriacaoCarga < dataFinal.AddDays(1) &&
                (carga.SituacaoCarga == SituacaoCarga.Nova || carga.SituacaoCarga == SituacaoCarga.AgTransportador ||
                carga.SituacaoCarga == SituacaoCarga.AgNFe || carga.SituacaoCarga == SituacaoCarga.CalculoFrete));

            query = query.Where(obj => obj.Veiculo.Codigo == codigoVeiculo || obj.VeiculosVinculados.Any(c => c.Codigo == codigoVeiculo));

            return query.ToList();
        }

        public int BuscarCargaEmAbertoPorVeiculoEmpresa(int empresa, string placa)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
            var result = from obj in query
                         where obj.Carga.Veiculo.Placa == placa && obj.Carga.Empresa.Codigo == empresa &&
                               ((obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada &&
                                obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada &&
                                obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada &&
                                obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento) &&
                                obj.Pedido.SituacaoPedido != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoPedido.Finalizado) &&
                                obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte
                         select obj;

            return result.Count();
        }

        public int BuscarCargasEmAbertoPorVeiculo(int codigoVeiculo)
        {
            var listaSituacoes = new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga>
            {
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgImpressaoDocumentos,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgIntegracao,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento,
            };

            var queryGrupo = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                             .Where(o => o.CargaFechada && (o.Veiculo.Codigo == codigoVeiculo || o.VeiculosVinculados.Any(c => c.Codigo == codigoVeiculo)) && !listaSituacoes.Contains(o.SituacaoCarga));

            return queryGrupo.Count();
        }

        public List<string> BuscarNumerosCargasEmAbertoPorVeiculo(int codigoVeiculo)
        {
            var listaSituacoes = new List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga>
            {
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgImpressaoDocumentos,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgIntegracao,
                Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento,
            };

            var queryGrupo = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                             .Where(o => o.CargaFechada && (o.Veiculo.Codigo == codigoVeiculo || o.VeiculosVinculados.Any(c => c.Codigo == codigoVeiculo)) && !listaSituacoes.Contains(o.SituacaoCarga));

            return queryGrupo.Select(o => o.CodigoCargaEmbarcador).ToList();
        }

        public bool ExisteCargaNaoFinalizadaComVeiculo(string placa, int codigoCargaDesconsiderar)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o =>
                    o.Codigo != codigoCargaDesconsiderar &&
                    o.Veiculo.Placa == placa &&
                    o.SituacaoCarga != SituacaoCarga.Encerrada &&
                    o.SituacaoCarga != SituacaoCarga.Cancelada &&
                    o.SituacaoCarga != SituacaoCarga.Anulada
                );

            return consultaCarga.Count() > 0;
        }

        public bool ExisteCargaMesmoCodigoEmbarcador(string codigoCargaEmbarcador)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.CodigoCargaEmbarcador.Equals(codigoCargaEmbarcador));

            return consultaCarga.Any();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarPorChavesNotaFiscal(List<string> chaves)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoXMLNotaFiscal>();

            query = query.Where(obj => chaves.Contains(obj.XMLNotaFiscal.Chave));

            return query.Select(o => o.CargaPedido.Carga).ToList();
        }

        public bool ExistePreCargaComFechamentoNaoIniciadoPorCargaAgrupada(int codigoCargaAgrupada)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.CargaDePreCarga == true && o.CargaAgrupamento.Codigo == codigoCargaAgrupada && o.CargaDePreCargaEmFechamento == false);

            return consultaCarga.Count() > 0;
        }

        public Task<bool> ExistePreCargaComFechamentoNaoIniciadoPorCargaAgrupadaAsync(int codigoCargaAgrupada)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.CargaDePreCarga == true && o.CargaAgrupamento.Codigo == codigoCargaAgrupada && o.CargaDePreCargaEmFechamento == false);

            return consultaCarga.AnyAsync();
        }

        public bool ExisteCarga(string codigoEmbarcador, string codigoFilialEmbarcador, bool semPreCargas)
        {
            IList<int> codigosCarga = this.BuscarCodigosCargaEmCargasEEmCodigosAgrupados(codigoEmbarcador);
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(carga =>
                    carga.NumeroSequenciaCarga == 0 &&
                    codigosCarga.Contains(carga.Codigo) &&
                    carga.SituacaoCarga != SituacaoCarga.Cancelada &&
                    carga.SituacaoCarga != SituacaoCarga.Anulada
                );

            if (!string.IsNullOrWhiteSpace(codigoFilialEmbarcador))
                consultaCarga = consultaCarga.Where(carga => carga.Filial.CodigoFilialEmbarcador == codigoFilialEmbarcador || carga.Filial.OutrosCodigosIntegracao.Contains(codigoFilialEmbarcador));

            if (semPreCargas)
                consultaCarga = consultaCarga.Where(carga => !carga.CargaDePreCarga);

            return consultaCarga.Count() > 0;
        }

        public bool ExisteCargaComSituacaoNFEDocumentoEmitido(int codigoCarga)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
               .Where(obj => obj.Codigo == codigoCarga && (obj.SituacaoCarga == SituacaoCarga.EmTransporte || obj.SituacaoCarga == SituacaoCarga.Encerrada || obj.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos || obj.SituacaoCarga == SituacaoCarga.AgIntegracao || obj.SituacaoCarga == SituacaoCarga.AgNFe));

            return consultaCarga.Count() > 0;
        }

        public Task<bool> ExisteCargaIdentificadorRotaAsync(string identificadorDeRota)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(carga =>
                    carga.IdentificadorDeRota == identificadorDeRota &&
                    carga.SituacaoCarga != SituacaoCarga.Cancelada &&
                    carga.SituacaoCarga != SituacaoCarga.Anulada
                );

            return consultaCarga.AnyAsync(CancellationToken);
        }

        public List<Dominio.Entidades.Embarcador.Cargas.CargaPedido> ConsultarPorSemana(string codigoCargaEmbarcador, int filial, int localidadePolo, int pais, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacaoCarga, double remetente, double destinatario, DateTime dataInicio, DateTime dataFim)
        {

            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
            var result = from obj in query where obj.Carga.CargaFechada select obj;

            if (situacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.NaLogistica)
            {
                result = result.Where(obj => obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada &&
                    obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte &&
                    obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento &&
                    obj.Carga.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada
                );
            }
            else
            {
                if (situacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Todas)
                    result = result.Where(obj => obj.Carga.SituacaoCarga == situacaoCarga);
            }

            if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
            {
                result = result.Where(obj => obj.Carga.CodigoCargaEmbarcador == codigoCargaEmbarcador);
            }
            else
            {
                if (filial > 0)
                    result = result.Where(obj => obj.Carga.Filial.Codigo == filial);

                if (localidadePolo > 0)
                    result = result.Where(obj => obj.Origem.LocalidadePolo.Codigo == localidadePolo);

                if (pais > 0)
                    result = result.Where(obj => obj.Origem.Pais.Codigo == pais);

                if (remetente > 0)
                    result = result.Where(obj => obj.Pedido.Remetente.CPF_CNPJ == remetente);

                if (destinatario > 0)
                    result = result.Where(obj => obj.Pedido.Destinatario.CPF_CNPJ == destinatario);


                if (dataInicio != DateTime.MinValue)
                    result = result.Where(obj => obj.Carga.DataCarregamentoCarga.Value >= dataInicio || !obj.Carga.DataCarregamentoCarga.HasValue);

                if (dataFim != DateTime.MinValue)
                    result = result.Where(obj => obj.Carga.DataCarregamentoCarga.Value <= dataFim || !obj.Carga.DataCarregamentoCarga.HasValue);
            }

            return result.OrderBy(obj => obj.Carga.DataCarregamentoCarga).OrderBy(obj => obj.Codigo).ToList();

        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarPermiteCTeComplementar(int numeroMDFe, string codigoCargaEmbarcador, string proprietarioVeiculo, int numeroCTe, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga> situacoes, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = query.Where(obj => situacoes.Contains(obj.SituacaoCarga));

            if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                result = result.Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador);

            if (numeroCTe > 0)
            {
                var queryCTe = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();

                if (!string.IsNullOrWhiteSpace(proprietarioVeiculo))
                    result = result.Where(o => (from obj in queryCTe where obj.Carga.Codigo == o.Codigo && obj.CTe.Numero == numeroCTe && (obj.CTe.Empresa.CNPJ == proprietarioVeiculo || o.Veiculo.Proprietario.CPF_CNPJ == double.Parse(proprietarioVeiculo)) select obj.Carga.Codigo).Contains(o.Codigo));
                else
                    result = result.Where(o => (from obj in queryCTe where obj.Carga.Codigo == o.Codigo && obj.CTe.Numero == numeroCTe select obj.Carga.Codigo).Contains(o.Codigo));
            }
            else if (!string.IsNullOrWhiteSpace(proprietarioVeiculo))
                result = result.Where(obj => (obj.Veiculo.Proprietario.CPF_CNPJ == double.Parse(proprietarioVeiculo) || obj.Empresa.CNPJ == proprietarioVeiculo || obj.Veiculo.Empresa.CNPJ == proprietarioVeiculo || obj.CargaCTes.Any(c => c.CTe.Empresa.CNPJ == proprietarioVeiculo)));

            if (numeroMDFe > 0)
            {
                var queryMDFe = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaMDFe>();

                result = result.Where(o => (from obj in queryMDFe where obj.Carga.Codigo == o.Codigo && obj.MDFe.Numero == numeroMDFe select obj.Carga.Codigo).Contains(o.Codigo));
            }

            return result.OrderBy(propOrdenacao + (dirOrdenacao == "asc" ? " ascending" : " descending")).Skip(inicioRegistros).Take(maximoRegistros).ToList();
        }

        public async Task<List<Dominio.Entidades.Embarcador.Cargas.Carga>> ConsultarPermiteCTeComplementarAsync(int numeroMDFe, string codigoCargaEmbarcador, string proprietarioVeiculo, int numeroCTe, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga> situacoes,
            string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = query.Where(obj => situacoes.Contains(obj.SituacaoCarga));

            if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                result = result.Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador);

            if (numeroCTe > 0)
            {
                var queryCTe = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();

                if (!string.IsNullOrWhiteSpace(proprietarioVeiculo))
                    result = result.Where(o => (from obj in queryCTe where obj.Carga.Codigo == o.Codigo && obj.CTe.Numero == numeroCTe && (obj.CTe.Empresa.CNPJ == proprietarioVeiculo || o.Veiculo.Proprietario.CPF_CNPJ == double.Parse(proprietarioVeiculo)) select obj.Carga.Codigo).Contains(o.Codigo));
                else
                    result = result.Where(o => (from obj in queryCTe where obj.Carga.Codigo == o.Codigo && obj.CTe.Numero == numeroCTe select obj.Carga.Codigo).Contains(o.Codigo));
            }
            else if (!string.IsNullOrWhiteSpace(proprietarioVeiculo))
                result = result.Where(obj => (obj.Veiculo.Proprietario.CPF_CNPJ == double.Parse(proprietarioVeiculo) || obj.Empresa.CNPJ == proprietarioVeiculo || obj.Veiculo.Empresa.CNPJ == proprietarioVeiculo || obj.CargaCTes.Any(c => c.CTe.Empresa.CNPJ == proprietarioVeiculo)));

            if (numeroMDFe > 0)
            {
                var queryMDFe = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaMDFe>();

                result = result.Where(o => (from obj in queryMDFe where obj.Carga.Codigo == o.Codigo && obj.MDFe.Numero == numeroMDFe select obj.Carga.Codigo).Contains(o.Codigo));
            }

            return await result.OrderBy(propOrdenacao + (dirOrdenacao == "asc" ? " ascending" : " descending")).Skip(inicioRegistros).Take(maximoRegistros).ToListAsync();
        }

        public int ContarConsultaPermiteCTeComplementar(int numeroMDFe, string codigoCargaEmbarcador, string proprietarioVeiculo, int numeroCTe, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga> situacoes)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = query.Where(obj => situacoes.Contains(obj.SituacaoCarga));

            if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                result = result.Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador);

            if (numeroCTe > 0)
            {
                var queryCTe = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();

                if (!string.IsNullOrWhiteSpace(proprietarioVeiculo))
                    result = result.Where(o => (from obj in queryCTe where obj.Carga.Codigo == o.Codigo && obj.CTe.Numero == numeroCTe && (obj.CTe.Empresa.CNPJ == proprietarioVeiculo || o.Veiculo.Proprietario.CPF_CNPJ == double.Parse(proprietarioVeiculo)) select obj.Carga.Codigo).Contains(o.Codigo));
                else
                    result = result.Where(o => (from obj in queryCTe where obj.Carga.Codigo == o.Codigo && obj.CTe.Numero == numeroCTe select obj.Carga.Codigo).Contains(o.Codigo));
            }
            else if (!string.IsNullOrWhiteSpace(proprietarioVeiculo))
                result = result.Where(obj => (obj.Veiculo.Proprietario.CPF_CNPJ == double.Parse(proprietarioVeiculo) || obj.Empresa.CNPJ == proprietarioVeiculo || obj.Veiculo.Empresa.CNPJ == proprietarioVeiculo || obj.CargaCTes.Any(c => c.CTe.Empresa.CNPJ == proprietarioVeiculo)));

            if (numeroMDFe > 0)
            {
                var queryMDFe = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaMDFe>();

                result = result.Where(o => (from obj in queryMDFe where obj.Carga.Codigo == o.Codigo && obj.MDFe.Numero == numeroMDFe select obj.Carga.Codigo).Contains(o.Codigo));
            }

            return result.Count();
        }
        public async Task<int> ContarConsultaPermiteCTeComplementarAsync(int numeroMDFe, string codigoCargaEmbarcador, string proprietarioVeiculo, int numeroCTe, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga> situacoes)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = query.Where(obj => situacoes.Contains(obj.SituacaoCarga));

            if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                result = result.Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador);

            if (numeroCTe > 0)
            {
                var queryCTe = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();

                if (!string.IsNullOrWhiteSpace(proprietarioVeiculo))
                    result = result.Where(o => (from obj in queryCTe where obj.Carga.Codigo == o.Codigo && obj.CTe.Numero == numeroCTe && (obj.CTe.Empresa.CNPJ == proprietarioVeiculo || o.Veiculo.Proprietario.CPF_CNPJ == double.Parse(proprietarioVeiculo)) select obj.Carga.Codigo).Contains(o.Codigo));
                else
                    result = result.Where(o => (from obj in queryCTe where obj.Carga.Codigo == o.Codigo && obj.CTe.Numero == numeroCTe select obj.Carga.Codigo).Contains(o.Codigo));
            }
            else if (!string.IsNullOrWhiteSpace(proprietarioVeiculo))
                result = result.Where(obj => (obj.Veiculo.Proprietario.CPF_CNPJ == double.Parse(proprietarioVeiculo) || obj.Empresa.CNPJ == proprietarioVeiculo || obj.Veiculo.Empresa.CNPJ == proprietarioVeiculo || obj.CargaCTes.Any(c => c.CTe.Empresa.CNPJ == proprietarioVeiculo)));

            if (numeroMDFe > 0)
            {
                var queryMDFe = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaMDFe>();

                result = result.Where(o => (from obj in queryMDFe where obj.Carga.Codigo == o.Codigo && obj.MDFe.Numero == numeroMDFe select obj.Carga.Codigo).Contains(o.Codigo));
            }

            return await result.CountAsync();
        }
        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.ConsultaCarga> Consultar(FiltroPesquisaCargaPesquisa filtroPesquisa, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            return ConsultarCargaSQL(filtroPesquisa, propOrdenacao, dirOrdenacao, inicioRegistros, maximoRegistros);
        }
        public async Task<IList<Dominio.ObjetosDeValor.Embarcador.Carga.ConsultaCarga>> ConsultarAsync(FiltroPesquisaCargaPesquisa filtroPesquisa, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            return ConsultarCargaSQL(filtroPesquisa, propOrdenacao, dirOrdenacao, inicioRegistros, maximoRegistros);
        }

        public int ContarConsultaCarga(FiltroPesquisaCargaPesquisa filtroPesquisa)
        {
            return ContarConsultarCargaSQL(filtroPesquisa);
        }
        public async Task<int> ContarConsultaCargaAsync(FiltroPesquisaCargaPesquisa filtroPesquisa)
        {
            return await ContarConsultarCargaSQLAsync(filtroPesquisa);
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> Consultar(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCarga filtrosPesquisa, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            var consultaCarga = montarQueryConsultaComPedido(filtrosPesquisa);

            //por favor revalide esse order..
            //if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador)
            //consultaCarga = consultaCarga.OrderBy("AgConfirmacaoUtilizacaoCredito" + " descending");

            if (filtrosPesquisa.Situacoes != null && filtrosPesquisa.Situacoes.Exists(x => x == SituacaoCarga.NaLogistica))
                consultaCarga = consultaCarga
                    .OrderBy("problemaCTE" + " descending")
                    .OrderBy("problemaMDFe" + " descending")
                    .OrderBy("problemaNFS" + " descending")
                    .OrderBy("PossuiPendencia" + " descending");

            if (parametrosConsulta.LimiteRegistros > 0)
            {
                return
                    consultaCarga.WithOptions(o => o.SetTimeout(240))
                    .OrderBy(parametrosConsulta.PropriedadeOrdenar + (parametrosConsulta.DirecaoOrdenar == "asc" ? " ascending" : " descending"))
                    .Skip(parametrosConsulta.InicioRegistros)
                    .Take(parametrosConsulta.LimiteRegistros)
                    .Fetch(obj => obj.PedidoViagemNavio)
                    .Fetch(obj => obj.Carregamento).ThenFetch(obj => obj.ModeloVeicularCarga)
                    .Fetch(obj => obj.Filial)
                    .Fetch(obj => obj.Operador)
                    .Fetch(obj => obj.TipoOperacao)
                    .Fetch(obj => obj.ModeloVeicularCarga)
                    .Fetch(obj => obj.Rota)
                    .Fetch(obj => obj.TipoDeCarga)
                    .Fetch(obj => obj.PortoDestino)
                    .Fetch(obj => obj.TerminalOrigem)
                    .Fetch(obj => obj.TerminalDestino)
                    .Fetch(obj => obj.PortoOrigem)
                    .Fetch(obj => obj.Empresa).ThenFetch(obj => obj.Localidade)
                    .Fetch(obj => obj.Veiculo).ThenFetch(obj => obj.ModeloVeicularCarga)
                    .Fetch(obj => obj.Carregamento)
                    .Fetch(obj => obj.DadosSumarizados)
                    .Fetch(obj => obj.Container)
                    .ToList();
            }

            return consultaCarga
                .OrderBy(parametrosConsulta.PropriedadeOrdenar + (parametrosConsulta.DirecaoOrdenar == "asc" ? " ascending" : " descending"))
                .Skip(parametrosConsulta.InicioRegistros).ToList();
        }
        public async Task<List<Dominio.Entidades.Embarcador.Cargas.Carga>> ConsultarAsync(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCarga filtrosPesquisa, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            var consultaCarga = montarQueryConsultaComPedido(filtrosPesquisa);

            if (filtrosPesquisa.Situacoes != null && filtrosPesquisa.Situacoes.Exists(x => x == SituacaoCarga.NaLogistica))
                consultaCarga = consultaCarga
                    .OrderBy("problemaCTE" + " descending")
                    .OrderBy("problemaMDFe" + " descending")
                    .OrderBy("problemaNFS" + " descending")
                    .OrderBy("PossuiPendencia" + " descending");

            if (parametrosConsulta.LimiteRegistros > 0)
            {
                return
                    consultaCarga.WithOptions(o => o.SetTimeout(240))
                    .OrderBy(parametrosConsulta.PropriedadeOrdenar + (parametrosConsulta.DirecaoOrdenar == "asc" ? " ascending" : " descending"))
                    .Skip(parametrosConsulta.InicioRegistros)
                    .Take(parametrosConsulta.LimiteRegistros)
                    .Fetch(obj => obj.PedidoViagemNavio)
                    .Fetch(obj => obj.Carregamento).ThenFetch(obj => obj.ModeloVeicularCarga)
                    .Fetch(obj => obj.Filial)
                    .Fetch(obj => obj.Operador)
                    .Fetch(obj => obj.TipoOperacao)
                    .Fetch(obj => obj.ModeloVeicularCarga)
                    .Fetch(obj => obj.Rota)
                    .Fetch(obj => obj.TipoDeCarga)
                    .Fetch(obj => obj.PortoDestino)
                    .Fetch(obj => obj.TerminalOrigem)
                    .Fetch(obj => obj.TerminalDestino)
                    .Fetch(obj => obj.PortoOrigem)
                    .Fetch(obj => obj.Empresa).ThenFetch(obj => obj.Localidade)
                    .Fetch(obj => obj.Veiculo).ThenFetch(obj => obj.ModeloVeicularCarga)
                    .Fetch(obj => obj.Carregamento)
                    .Fetch(obj => obj.DadosSumarizados)
                    .ToList();
            }

            return await consultaCarga
                .OrderBy(parametrosConsulta.PropriedadeOrdenar + (parametrosConsulta.DirecaoOrdenar == "asc" ? " ascending" : " descending"))
                .Skip(parametrosConsulta.InicioRegistros).ToListAsync();
        }
        public int ContarConsulta(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCarga filtrosPesquisa)
        {
            var consultaCarga = montarQueryConsultaComPedido(filtrosPesquisa);

            return consultaCarga.Count();
        }
        public async Task<int> ContarConsultaAsync(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCarga filtrosPesquisa, CancellationToken cancellationToken)
        {
            var consultaCarga = montarQueryConsultaComPedidoAsync(filtrosPesquisa, cancellationToken);

            return await consultaCarga.Result.CountAsync();
        }

        public dynamic ConsultarParaAcertoViagem(string codigoCargaEmbarcador, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacaoCarga, int codigoAcertoViagem, bool somenteSituacao, DateTime dataCarga, int codigoVeiculo, bool contemConfiguracao, bool visualizarPalletsCanhotosNasCargas, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> iQueriableCarga = null;

            if (codigoAcertoViagem == 0)
            {
                var queryCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

                if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                    queryCarga = queryCarga.Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador);

                if (somenteSituacao)
                    queryCarga = queryCarga.Where(obj => obj.SituacaoCarga == situacaoCarga);

                if (dataCarga != DateTime.MinValue)
                    queryCarga = queryCarga.Where(obj => obj.DataCriacaoCarga <= dataCarga.AddDays(1));

                if (codigoVeiculo > 0)
                    queryCarga = queryCarga.Where(obj => obj.Veiculo.Codigo == codigoVeiculo);

                iQueriableCarga = queryCarga;
            }
            else
            {
                Repositorio.Embarcador.Acerto.AcertoViagem repAcerto = new Acerto.AcertoViagem(UnitOfWork);
                Dominio.Entidades.Embarcador.Acerto.AcertoViagem acertoviagem = repAcerto.BuscarPorCodigo(codigoAcertoViagem);

                var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaMotorista>();

                query = query.Where(obj => obj.Carga.SituacaoCarga == situacaoCarga);
                if (acertoviagem.DataFinal.HasValue)
                    query = query.Where(obj => obj.Carga.DataCriacaoCarga <= acertoviagem.DataFinal.Value.AddDays(1));

                if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                    query = query.Where(obj => obj.Carga.CodigoCargaEmbarcador == codigoCargaEmbarcador);

                if (dataCarga > DateTime.MinValue)
                    query = query.Where(obj => obj.Carga.DataCriacaoCarga <= dataCarga.AddDays(1));

                if (codigoVeiculo > 0)
                    query = query.Where(obj => obj.Carga.Veiculo.Codigo == codigoVeiculo);

                iQueriableCarga = query.Select(obj => obj.Carga);
            }

            return iQueriableCarga.Select(obj => new
            {
                obj.Codigo,
                CodigoAcertoCarga = 0,
                LancadoManualmente = codigoAcertoViagem == 0 ? true : false,
                obj.DataCriacaoCarga,
                Data = obj.DataCriacaoCarga.ToString("dd/MM/yyyy"),
                obj.CodigoCargaEmbarcador,
                Numero = obj.CodigoCargaEmbarcador,
                Placa = obj.Veiculo.Placa ?? string.Empty,
                Veiculo = obj.Veiculo.Placa ?? string.Empty,
                Emitente = obj.DadosSumarizados.Remetentes + " (" + obj.DadosSumarizados.Origens + ")",
                Destino = obj.DadosSumarizados.Destinos,
                CargaFracionada = false,
                ValorBrutoCarga = (obj.ValorAReceberCTes ?? 0m).ToString("n2"),
                ValorICMSCarga = (obj.ValorICMSCTes ?? 0m).ToString("n2"),
                ValorBonificacaoCliente = "0,00",
                PedagioAcertoCredito = contemConfiguracao ? "<span class='spnTipoValorItem' data-codigo-item='" + obj.Codigo + "'></span> 0,00" : "<span class='spnTipoValorItem' data-codigo-item='" + obj.Codigo + "'data-permite-alterar='false'></span> 0,00",
                PedagioAcerto = contemConfiguracao ? "<span class='spnTipoValorItem' data-codigo-item='" + obj.Codigo + "'></span> 0,00" : "<span class='spnTipoValorItem' data-codigo-item='" + obj.Codigo + "'data-permite-alterar='false'></span> 0,00",
                ValorFrete = (obj.ValorFreteCTes ?? 0m).ToString("n2"),
                PercentualAcerto = "<span class='spnTipoValorItem' data-codigo-item='" + obj.Codigo + "'data-permite-alterar='true'></span> " + (obj.Motoristas.Count > 1 || obj.AcertosViagem.Any(o => o.AcertoViagem.Codigo != codigoAcertoViagem && o.AcertoViagem.Situacao != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoAcertoViagem.Cancelado) ? "0,00" : "100,00"),
                Motoristas = obj.NomeMotoristas,
                ContemMaisDeUmMotorista = obj.Motoristas.Count > 1,
                ContemMDFeEncerrado = obj.CargaMDFes.Any(c => c.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Encerrado),
                CargaLancadaEmOutroAcerto = obj.AcertosViagem.Any(o => o.AcertoViagem.Codigo != codigoAcertoViagem && o.AcertoViagem.Situacao != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoAcertoViagem.Cancelado),
                DT_RowColor = "#FFFFFF",
                SituacaoCanhotos = "",
                SituacaoPallets = ""
            })
            .OrderBy(propOrdenacao + (dirOrdenacao == "asc" ? " ascending" : " descending"))
            .Skip(inicioRegistros)
            .Take(maximoRegistros)
            .ToList();
        }

        public int ContarConsultaParaAcertoViagem(string codigoCargaEmbarcador, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacaoCarga, int codigoAcertoViagem, bool somenteSituacao, DateTime dataCarga, int codigoVeiculo)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> iQueriableCarga = null;

            if (codigoAcertoViagem == 0)
            {
                var queryCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

                if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                    queryCarga = queryCarga.Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador);

                if (somenteSituacao)
                    queryCarga = queryCarga.Where(obj => obj.SituacaoCarga == situacaoCarga);

                if (dataCarga != DateTime.MinValue)
                    queryCarga = queryCarga.Where(obj => obj.DataCriacaoCarga <= dataCarga.AddDays(1));

                if (codigoVeiculo > 0)
                    queryCarga = queryCarga.Where(obj => obj.Veiculo.Codigo == codigoVeiculo);

                iQueriableCarga = queryCarga;
            }
            else
            {
                Repositorio.Embarcador.Acerto.AcertoViagem repAcerto = new Acerto.AcertoViagem(UnitOfWork);
                Dominio.Entidades.Embarcador.Acerto.AcertoViagem acertoviagem = repAcerto.BuscarPorCodigo(codigoAcertoViagem);

                var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaMotorista>();

                query = query.Where(obj => obj.Carga.SituacaoCarga == situacaoCarga);
                if (acertoviagem.DataFinal.HasValue)
                    query = query.Where(obj => obj.Carga.DataCriacaoCarga <= acertoviagem.DataFinal.Value.AddDays(1));

                if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                    query = query.Where(obj => obj.Carga.CodigoCargaEmbarcador == codigoCargaEmbarcador);

                if (dataCarga > DateTime.MinValue)
                    query = query.Where(obj => obj.Carga.DataCriacaoCarga <= dataCarga.AddDays(1));

                if (codigoVeiculo > 0)
                    query = query.Where(obj => obj.Carga.Veiculo.Codigo == codigoVeiculo);

                iQueriableCarga = query.Select(obj => obj.Carga);
            }

            return iQueriableCarga.Count();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarSemComissaoMotorista(string codigoCargaEmbarcador, int codigoMotorista, int codigoComissaoFuncionario, DateTime dataCarga, int codigoVeiculo, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(obj => obj.SituacaoCarga == SituacaoCarga.EmTransporte || obj.SituacaoCarga == SituacaoCarga.Encerrada || obj.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos || obj.SituacaoCarga == SituacaoCarga.AgIntegracao || obj.SituacaoCarga == SituacaoCarga.LiberadoPagamento);

            if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                query = query.Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador);

            if (dataCarga != DateTime.MinValue)
                query = query.Where(obj => obj.DataCriacaoCarga <= dataCarga.AddDays(1));

            if (codigoVeiculo > 0)
                query = query.Where(obj => obj.Veiculo.Codigo == codigoVeiculo);

            var queryAcerto = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.RH.ComissaoFuncionarioMotoristaDocumento>();
            var resultAcerto = from obj in queryAcerto where obj.Carga != null && obj.ComissaoFuncionarioMotorista.Codigo == codigoComissaoFuncionario && obj.ComissaoFuncionarioMotorista.Motorista.Codigo == codigoMotorista select obj;

            query = query.Where(obj => !resultAcerto.Select(a => a.Carga).Contains(obj));

            query = query.OrderBy(propOrdenacao + (dirOrdenacao == "asc" ? " ascending" : " descending"));

            if (inicioRegistros > 0)
                query = query.Skip(inicioRegistros);
            if (maximoRegistros > 0)
                query = query.Take(maximoRegistros);

            return query.Distinct().ToList();
        }

        public int ContarConsultaSemComissaoMotorista(string codigoCargaEmbarcador, int codigoMotorista, int codigoComissaoFuncionario, DateTime dataCarga, int codigoVeiculo)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(obj => obj.SituacaoCarga == SituacaoCarga.EmTransporte || obj.SituacaoCarga == SituacaoCarga.Encerrada || obj.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos || obj.SituacaoCarga == SituacaoCarga.AgIntegracao || obj.SituacaoCarga == SituacaoCarga.LiberadoPagamento);

            if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                query = query.Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador);

            if (dataCarga != DateTime.MinValue)
                query = query.Where(obj => obj.DataCriacaoCarga <= dataCarga.AddDays(1));

            if (codigoVeiculo > 0)
                query = query.Where(obj => obj.Veiculo.Codigo == codigoVeiculo);

            var queryAcerto = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.RH.ComissaoFuncionarioMotoristaDocumento>();
            var resultAcerto = from obj in queryAcerto where obj.Carga != null && obj.ComissaoFuncionarioMotorista.Codigo == codigoComissaoFuncionario && obj.ComissaoFuncionarioMotorista.Motorista.Codigo == codigoMotorista select obj;

            query = query.Where(obj => !resultAcerto.Select(a => a.Carga).Contains(obj));
            return query.Distinct().Count();
        }

        public dynamic ConsultarSemAcertoViagem(string codigoCargaEmbarcador, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacaoCarga, int codigoAcertoViagem, bool somenteSituacao, DateTime dataCarga, int codigoVeiculo, bool contemConfiguracao, bool visualizarPalletsCanhotosNasCargas, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros, List<int> listaSituacaoCarga)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> iQueriableCarga = null;

            if (codigoAcertoViagem == 0)
            {
                var queryCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

                if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                    queryCarga = queryCarga.Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador);

                if (somenteSituacao)
                {
                    if (listaSituacaoCarga != null && listaSituacaoCarga.Count > 0)
                        queryCarga = queryCarga.Where(obj => listaSituacaoCarga.Contains((int)obj.SituacaoCarga));
                    else
                        queryCarga = queryCarga.Where(obj => obj.SituacaoCarga == situacaoCarga);
                }

                if (dataCarga != DateTime.MinValue)
                    queryCarga = queryCarga.Where(obj => obj.DataCriacaoCarga <= dataCarga.AddDays(1));

                if (codigoVeiculo > 0)
                    queryCarga = queryCarga.Where(obj => obj.Veiculo.Codigo == codigoVeiculo);

                iQueriableCarga = queryCarga.Where(o => !o.AcertosViagem.Any(ac => ac.AcertoViagem.Situacao != SituacaoAcertoViagem.Cancelado));
            }
            else
            {
                Repositorio.Embarcador.Acerto.AcertoViagem repAcerto = new Acerto.AcertoViagem(UnitOfWork);
                Dominio.Entidades.Embarcador.Acerto.AcertoViagem acertoviagem = repAcerto.BuscarPorCodigo(codigoAcertoViagem);

                var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaMotorista>();

                if (listaSituacaoCarga != null && listaSituacaoCarga.Count > 0)
                    query = query.Where(obj => listaSituacaoCarga.Contains((int)obj.Carga.SituacaoCarga));
                else
                    query = query.Where(obj => obj.Carga.SituacaoCarga == situacaoCarga);

                query = query.Where(obj => obj.Motorista.Codigo == acertoviagem.Motorista.Codigo);
                if (acertoviagem.DataFinal.HasValue)
                    query = query.Where(obj => obj.Carga.DataCriacaoCarga <= acertoviagem.DataFinal.Value.AddDays(1));

                if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                    query = query.Where(obj => obj.Carga.CodigoCargaEmbarcador == codigoCargaEmbarcador);

                if (dataCarga > DateTime.MinValue)
                    query = query.Where(obj => obj.Carga.DataCriacaoCarga <= dataCarga.AddDays(1));

                if (codigoVeiculo > 0)
                    query = query.Where(obj => obj.Carga.Veiculo.Codigo == codigoVeiculo);

                iQueriableCarga = query.Select(obj => obj.Carga);
            }

            return iQueriableCarga.Select(obj => new
            {
                obj.Codigo,
                CodigoAcertoCarga = 0,
                LancadoManualmente = codigoAcertoViagem == 0 ? true : false,
                obj.DataCriacaoCarga,
                Data = obj.DataCriacaoCarga.ToString("dd/MM/yyyy"),
                obj.CodigoCargaEmbarcador,
                Numero = obj.CodigoCargaEmbarcador,
                Placa = obj.Veiculo.Placa ?? string.Empty,
                Veiculo = obj.Veiculo.Placa ?? string.Empty,
                Emitente = obj.DadosSumarizados.Remetentes + " (" + obj.DadosSumarizados.Origens + ")",
                Destino = obj.DadosSumarizados.Destinos,
                CargaFracionada = false,
                ValorBrutoCarga = (obj.ValorAReceberCTes ?? 0m).ToString("n2"),
                ValorICMSCarga = (obj.ValorICMSCTes ?? 0m).ToString("n2"),
                ValorBonificacaoCliente = "0,00",
                PedagioAcertoCredito = contemConfiguracao ? "<span class='spnTipoValorItem' data-codigo-item='" + obj.Codigo + "'></span> 0,00" : "<span class='spnTipoValorItem' data-codigo-item='" + obj.Codigo + "'data-permite-alterar='false'></span> 0,00",
                PedagioAcerto = contemConfiguracao ? "<span class='spnTipoValorItem' data-codigo-item='" + obj.Codigo + "'></span> 0,00" : "<span class='spnTipoValorItem' data-codigo-item='" + obj.Codigo + "'data-permite-alterar='false'></span> 0,00",
                ValorFrete = (obj.ValorFreteCTes ?? 0m).ToString("n2"),
                PercentualAcerto = "<span class='spnTipoValorItem' data-codigo-item='" + obj.Codigo + "'data-permite-alterar='true'></span> 100,00",//"<span class='spnTipoValorItem' data-codigo-item='" + obj.Codigo + "'data-permite-alterar='true'></span> " + (obj.Motoristas != null ? "0,00" : obj.Motoristas.Count > 1 ? "0,00" : "100,00"),
                Motoristas = obj.NomeMotoristas,
                ContemMaisDeUmMotorista = false,//obj.Motoristas != null ? obj.Motoristas.Count > 1 : false,
                ContemMDFeEncerrado = obj.CargaMDFes.Any(c => c.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Encerrado),
                CargaLancadaEmOutroAcerto = false,//obj.AcertosViagem != null ? obj.AcertosViagem.Any(o => o.AcertoViagem.Codigo != codigoAcertoViagem && o.AcertoViagem.Situacao != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoAcertoViagem.Cancelado) : false,
                DT_RowColor = "#FFFFFF",
                SituacaoCanhotos = "",
                SituacaoPallets = ""
            })
            .OrderBy(propOrdenacao + (dirOrdenacao == "asc" ? " ascending" : " descending"))
            .Skip(inicioRegistros)
            .Take(maximoRegistros)
            .ToList();
        }

        public int ContarConsultaSemAcertoViagem(string codigoCargaEmbarcador, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacaoCarga, int codigoAcertoViagem, bool somenteSituacao, DateTime dataCarga, int codigoVeiculo, List<int> listaSituacaoCarga)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> iQueriableCarga = null;

            if (codigoAcertoViagem == 0)
            {
                var queryCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

                if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                    queryCarga = queryCarga.Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador);

                if (somenteSituacao)
                {
                    if (listaSituacaoCarga != null && listaSituacaoCarga.Count > 0)
                        queryCarga = queryCarga.Where(obj => listaSituacaoCarga.Contains((int)obj.SituacaoCarga));
                    else
                        queryCarga = queryCarga.Where(obj => obj.SituacaoCarga == situacaoCarga);
                }

                if (dataCarga != DateTime.MinValue)
                    queryCarga = queryCarga.Where(obj => obj.DataCriacaoCarga <= dataCarga.AddDays(1));

                if (codigoVeiculo > 0)
                    queryCarga = queryCarga.Where(obj => obj.Veiculo.Codigo == codigoVeiculo);

                iQueriableCarga = queryCarga.Where(o => !o.AcertosViagem.Any(ac => ac.AcertoViagem.Situacao != SituacaoAcertoViagem.Cancelado));
            }
            else
            {
                Repositorio.Embarcador.Acerto.AcertoViagem repAcerto = new Acerto.AcertoViagem(UnitOfWork);
                Dominio.Entidades.Embarcador.Acerto.AcertoViagem acertoviagem = repAcerto.BuscarPorCodigo(codigoAcertoViagem);

                var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaMotorista>();

                if (listaSituacaoCarga != null && listaSituacaoCarga.Count > 0)
                    query = query.Where(obj => listaSituacaoCarga.Contains((int)obj.Carga.SituacaoCarga));
                else
                    query = query.Where(obj => obj.Carga.SituacaoCarga == situacaoCarga);

                query = query.Where(obj => obj.Motorista.Codigo == acertoviagem.Motorista.Codigo);
                if (acertoviagem.DataFinal.HasValue)
                    query = query.Where(obj => obj.Carga.DataCriacaoCarga <= acertoviagem.DataFinal.Value.AddDays(1));

                if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                    query = query.Where(obj => obj.Carga.CodigoCargaEmbarcador == codigoCargaEmbarcador);

                if (dataCarga > DateTime.MinValue)
                    query = query.Where(obj => obj.Carga.DataCriacaoCarga <= dataCarga.AddDays(1));

                if (codigoVeiculo > 0)
                    query = query.Where(obj => obj.Carga.Veiculo.Codigo == codigoVeiculo);

                iQueriableCarga = query.Select(obj => obj.Carga);
            }

            return iQueriableCarga.Count();
        }

        public List<int> BuscarCargasPendentesEmissao(int maximoRegistros, bool controlePorLote)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(obj => obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.PendeciaDocumentos &&
                                       !obj.PossuiPendencia &&
                                       (!obj.AgImportacaoCTe || (obj.AgImportacaoCTe && (obj.IntegrandoValePedagio || obj.IntegrandoCIOT || obj.IntegrandoGNRE))) &&
                                       !obj.EmEmissaoCTeSubContratacaoFilialEmissora &&
                                       !obj.AgGeracaoCTesAnteriorFilialEmissora &&
                                       !obj.AgImportacaoMDFe &&
                                       !obj.CTesEmDigitacao &&
                                       (!obj.IntegrandoValePedagio || (obj.AgImportacaoCTe && obj.IntegrandoValePedagio) || (obj.RealizandoOperacaoContainer && obj.IntegrandoValePedagio)) &&
                                       (!obj.EmitindoCTes || !obj.EmitindoNFeRemessa) &&
                                       !obj.FinalizandoProcessoEmissao &&
                                       !obj.AgIntegracaoPagamentoMotorista &&
                                       obj.CargaFechada
                                       );

            if (controlePorLote)
                query = query.Where(o => o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote) || (o.CalcularFreteLote != null && o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Integracao));
            else
                query = query.Where(o => !o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote) && (o.CalcularFreteLote == null || o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Padrao));

            return query.OrderBy(o => o.PosicaoFilaProcessamento).ThenBy(obj => obj.DataInicioGeracaoCTes).Select(o => o.Codigo).Take(maximoRegistros).ToList();
        }

        public List<int> BuscarCargasAguardandoEnviao(int inicio, int quantideRegistros, int codigoTrasportador)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(obj => !obj.AgImportacaoCTe
                            && obj.Empresa.Codigo == codigoTrasportador
                            && obj.CargaFechada
                            && (obj.SituacaoCarga != SituacaoCarga.Anulada || obj.SituacaoCarga != SituacaoCarga.Cancelada));

            return query.Select(o => o.Protocolo).Skip(inicio).Take(quantideRegistros).ToList();
        }

        public List<int> BuscarCargasPendentesComCTeGerado(int maximoRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();

            query = query.Where(obj => obj.Carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe || obj.Carga.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgTransportador);

            return query.Select(o => o.Carga.Codigo).Take(maximoRegistros).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasPendentesGeracaoControleColetaEntrega()
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var consultaCargaCancelamento = ObterCargasEmCancelamento();

            query = query.Where(obj =>
                                obj.GerandoControleColetaEntrega &&
                                obj.CargaFechada &&
                                !consultaCargaCancelamento.Select(can => can.Carga.Codigo).Any(cac => cac == obj.Codigo) &&
                                obj.NumeroTentativaGeracaoEntregasControleQualidade < 3
                                );

            return query.Take(5).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasPorSituacao(Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacao)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query select obj;

            result = result.Where(obj => obj.SituacaoCarga == situacao);

            return result.ToList();
        }

        public bool ContemDeslocamentoVazio(List<int> codigosCargas)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query select obj;

            result = result.Where(obj => obj.TipoOperacao != null && obj.TipoOperacao.DeslocamentoVazio == true && codigosCargas.Contains(obj.Codigo));

            return result.Any();
        }

        public bool ContemDeslocamentoVazio(int codigoCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query select obj;

            result = result.Where(obj => obj.TipoOperacao != null && obj.TipoOperacao.DeslocamentoVazio == true && obj.Codigo == codigoCarga);

            return result.Any();
        }

        public bool PossuiModelosVeiculosDistintoso(List<int> codigosCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query select obj;

            result = result.Where(obj => codigosCarga.Contains(obj.Codigo));

            IQueryable<Dominio.Entidades.ModeloVeiculo> queryModeloVeiculo = result.Select(obj => obj.Veiculo.Modelo);

            return queryModeloVeiculo.Select(obj => obj).Distinct().Count() > 1;
        }

        public Dominio.Entidades.Veiculo BuscarPrimeiroVeiculo(List<int> codigosCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query select obj;

            result = result.Where(obj => codigosCarga.Contains(obj.Codigo));

            IQueryable<Dominio.Entidades.Veiculo> queryVeiculo = result.Select(obj => obj.Veiculo);

            return queryVeiculo.Select(obj => obj)?.FirstOrDefault() ?? null;
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasParaComissaoMotoristaPorCargo(Dominio.Entidades.Usuario motorista, DateTime dataInicial, DateTime dataFinal)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaMotorista>();

            var result = from obj in query where obj.Motorista != null && obj.Motorista.CargoMotorista != null select obj;

            result = result.Where(obj => (obj.Carga.TipoOperacao == null || !obj.Carga.TipoOperacao.NaoPermitirGerarComissaoMotorista) && obj.Carga.SituacaoCarga == SituacaoCarga.EmTransporte || obj.Carga.SituacaoCarga == SituacaoCarga.Encerrada || obj.Carga.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos || obj.Carga.SituacaoCarga == SituacaoCarga.AgIntegracao || obj.Carga.SituacaoCarga == SituacaoCarga.LiberadoPagamento);

            if (motorista != null)
                result = result.Where(obj => obj.Motorista.Codigo == motorista.Codigo);

            var queryPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();
            queryPedido = queryPedido.Where(obj => obj.CTe != null && obj.CTe.Status == "A" && obj.CTe.DataEmissao.Value <= dataFinal.AddDays(1) && obj.CTe.DataEmissao.Value >= dataInicial);

            queryPedido = queryPedido.Where(obj => result.Any(c => c.Carga == obj.Carga));

            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> queryCarga = queryPedido.Select(obj => obj.Carga);

            return queryCarga.Distinct().ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasParaComissaoMotorista(Dominio.Entidades.Usuario motorista, DateTime dataInicial, DateTime dataFinal)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaMotorista>();

            var result = from obj in query select obj;

            result = result.Where(obj => obj.Carga.SituacaoCarga == SituacaoCarga.EmTransporte || obj.Carga.SituacaoCarga == SituacaoCarga.Encerrada || obj.Carga.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos || obj.Carga.SituacaoCarga == SituacaoCarga.AgIntegracao || obj.Carga.SituacaoCarga == SituacaoCarga.LiberadoPagamento);

            if (motorista != null)
                result = result.Where(obj => obj.Motorista.Codigo == motorista.Codigo);

            result = result.Where(obj => obj.Carga.DataFinalizacaoEmissao.Value <= dataFinal.AddDays(1) && obj.Carga.DataFinalizacaoEmissao.Value >= dataInicial);

            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> queryCarga = result.Select(obj => obj.Carga);

            return queryCarga.ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasPorSituacaoMotoristaData(Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacao, Dominio.Entidades.Usuario motorista, DateTime dataInicial, DateTime dataFinal, List<int> listaSituacaoCarga, bool naoAdicionarCargasTransbordoAcertoViagem)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaMotorista>();

            if (naoAdicionarCargasTransbordoAcertoViagem)
                query = query.Where(o => !o.Carga.CargaTransbordo);

            if (listaSituacaoCarga != null && listaSituacaoCarga.Count > 0)
                query = query.Where(obj => listaSituacaoCarga.Contains((int)obj.Carga.SituacaoCarga));
            else
                query = query.Where(obj => obj.Carga.SituacaoCarga == situacao);

            if (motorista != null)
                query = query.Where(obj => obj.Motorista.Codigo == motorista.Codigo);

            query = query.Where(obj => obj.Carga.DataCriacaoCarga <= dataFinal.AddDays(1));

            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> queryCarga = query.Select(obj => obj.Carga);

            return queryCarga.ToList();
        }

        public IList<int> BuscarCargasPorSituacaoMotoristaDataVerificaCargaSemAcerto(Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga situacao, Dominio.Entidades.Usuario motorista, DateTime dataInicial, DateTime dataFinal, List<int> listaSituacaoCarga, bool naoAdicionarCargasTransbordoAcertoViagem)
        {
            System.Text.StringBuilder sqlCarga = new System.Text.StringBuilder();

            sqlCarga.AppendLine("select ");
            sqlCarga.AppendLine("   Carga.CAR_CODIGO ");
            sqlCarga.AppendLine("from ");
            sqlCarga.AppendLine("   T_CARGA_MOTORISTA CargaMotorista ");

            sqlCarga.AppendLine("inner join ");
            sqlCarga.AppendLine("   T_CARGA Carga ");
            sqlCarga.AppendLine("       on CargaMotorista.CAR_CODIGO = Carga.CAR_CODIGO ");

            sqlCarga.AppendLine("inner join ");
            sqlCarga.AppendLine("   T_FUNCIONARIO Usuario ");
            sqlCarga.AppendLine("       on CargaMotorista.CAR_MOTORISTA = Usuario.FUN_CODIGO ");

            sqlCarga.AppendLine("where 1=1 ");

            if (naoAdicionarCargasTransbordoAcertoViagem)
                sqlCarga.AppendLine("   and Carga.CAR_CARGA_TRANSBORDO = 0 ");

            if (listaSituacaoCarga != null && listaSituacaoCarga.Count > 0)
                sqlCarga.AppendLine("   and Carga.CAR_SITUACAO in (" + string.Join(", ", listaSituacaoCarga) + ") ");
            else
                sqlCarga.AppendLine("   and Carga.CAR_SITUACAO = " + (int)situacao);

            if (motorista != null)
                sqlCarga.AppendLine("   and Usuario.FUN_CODIGO = " + motorista.Codigo);

            string pattern = "yyyy-MM-dd";
            sqlCarga.AppendLine("   and Carga.CAR_DATA_CRIACAO <= '" + dataFinal.AddDays(1).ToString(pattern) + "' ");

            sqlCarga.AppendLine("   and not exists( ");
            sqlCarga.AppendLine("                   select  ");
            sqlCarga.AppendLine("                       AcertoCarga.ACC_CODIGO  ");
            sqlCarga.AppendLine("                   from  ");
            sqlCarga.AppendLine("                       T_ACERTO_CARGA AcertoCarga ");
            sqlCarga.AppendLine("                   inner join ");
            sqlCarga.AppendLine("                       T_ACERTO_DE_VIAGEM AcertoViagem ");
            sqlCarga.AppendLine("                           on AcertoCarga.ACV_CODIGO = AcertoViagem.ACV_CODIGO  ");
            sqlCarga.AppendLine("                    where AcertoCarga.CAR_CODIGO = Carga.CAR_CODIGO  ");
            sqlCarga.AppendLine("                          and( AcertoViagem.ACV_SITUACAO<>3 or AcertoViagem.ACV_SITUACAO is null) ) ");

            var query = this.SessionNHiBernate.CreateSQLQuery(sqlCarga.ToString());

            return query.SetTimeout(6000).List<int>();
        }

        public List<Dominio.Entidades.Empresa> BuscarEmbarcadoresSugeridosParaCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            var queryEmpresa = this.SessionNHiBernate.Query<Dominio.Entidades.Empresa>();
            var queryVeiculo = this.SessionNHiBernate.Query<Dominio.Entidades.Veiculo>();
            var resultVeiculo = from obj in queryVeiculo where obj.Ativo && obj.ModeloVeicularCarga.Codigo == carga.ModeloVeicularCarga.Codigo select obj;

            var resultEmpresa = resultVeiculo.Join(queryEmpresa, vei => vei.Empresa.Codigo, emp => emp.Codigo, (vei, emp) => emp);

            resultEmpresa = from obj in resultEmpresa where obj.Status == "A" && obj.DataFinalCertificado.Value >= DateTime.Now && obj.TipoAmbiente == obj.EmpresaPai.TipoAmbiente && obj.NomeCertificado != null && obj.NomeCertificado != string.Empty select obj;

            return resultEmpresa.OrderBy(propOrdenacao + (dirOrdenacao == "asc" ? " ascending" : " descending")).Skip(inicioRegistros).Take(maximoRegistros).Distinct().ToList();

        }

        public int ContarEmbarcadoresSugeridosParaCarga(Dominio.Entidades.Embarcador.Cargas.Carga carga)
        {
            var queryEmpresa = this.SessionNHiBernate.Query<Dominio.Entidades.Empresa>();
            var queryVeiculo = this.SessionNHiBernate.Query<Dominio.Entidades.Veiculo>();
            var resultVeiculo = from obj in queryVeiculo where obj.Ativo && obj.ModeloVeicularCarga.Codigo == carga.ModeloVeicularCarga.Codigo select obj;

            var resultEmpresa = resultVeiculo.Join(queryEmpresa, vei => vei.Empresa.Codigo, emp => emp.Codigo, (vei, emp) => emp);

            resultEmpresa = from obj in resultEmpresa where obj.Status == "A" && obj.DataFinalCertificado.Value >= DateTime.Now && obj.TipoAmbiente == obj.EmpresaPai.TipoAmbiente && obj.NomeCertificado != null && obj.NomeCertificado != string.Empty select obj;

            return resultEmpresa.Distinct().Count();

        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarCargaViagemAberta(int codigoMotorista, int codigoCarga, List<int> veiculosVinculados, int tracao, bool validarApenasCargasComIntegracaoNoTipoDeOperacao)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var queryTransbordo = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Transbordo>().Select(transbordo => transbordo.Carga.Codigo);
            var queryTipoOperacaoIntegracao = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.TipoOperacaoIntegracao>();
            IQueryable<int> queryCancelamentoCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCancelamento>().Select(cancelamento => cancelamento.Carga.Codigo);
            var queryCargaCargaIntegracaoTrizy = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCargaIntegracao>();

            List<SituacaoCarga> listaSituacaoAberta = new List<SituacaoCarga>() { SituacaoCarga.EmTransporte, SituacaoCarga.LiberadoPagamento, SituacaoCarga.AgImpressaoDocumentos };

            if (codigoMotorista > 0)
                query = query.Where(obj => obj.Motoristas.Any(motorista => motorista.Codigo == codigoMotorista));

            query = query.Where(obj => listaSituacaoAberta.Contains(obj.SituacaoCarga));

            query = query.Where(obj => obj.DataFimViagem == null);

            // Se a carga estiver em transbordo, não deve ser considerada
            query = query.Where(carga => !queryTransbordo.Any(codigo => codigo == carga.Codigo));

            if (codigoCarga > 0)
                query = query.Where(obj => obj.Codigo != codigoCarga);

            // Cenário de Rodotrem
            if (veiculosVinculados != null && veiculosVinculados.Count > 0 && tracao > 0)
                query = query.Where(obj => ((obj.Veiculo.Codigo != tracao) || (obj.Veiculo.Codigo == tracao && obj.VeiculosVinculados.Any(o => !veiculosVinculados.Contains(o.Codigo)) && obj.CargaIntegracoes.Any(o => o.DataIntegracao <= DateTime.Now.AddDays(-1)))));

            if (validarApenasCargasComIntegracaoNoTipoDeOperacao)
                query = query.Where(carga => queryTipoOperacaoIntegracao.Any(integracao => integracao.TipoOperacao.Codigo == carga.TipoOperacao.Codigo && integracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Trizy));

            // Se a carga tiver registro de cancelamento mas ainda não mudou a situação, não deve considerar.
            query = query.Where(carga => !queryCancelamentoCarga.Any(codigo => codigo == carga.Codigo));

            // Filtra apenas cargas que tem integração com a Trizy gerada. #56255
            query = query
                .Where(carga => queryCargaCargaIntegracaoTrizy
                    .Any(cargaCargaIntegracao => cargaCargaIntegracao.Carga.Codigo == carga.Codigo &&
                        cargaCargaIntegracao.TipoIntegracao.Tipo == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao.Trizy));

            query = query.OrderBy(obj => obj.DataInicioViagemPrevista);

            return query.FirstOrDefault();
        }

        public string BuscarCodigoEmbarcadorPorCargaEmCancelamento(string codigoEmbarcador, int codigoFilial, List<int> motoristas)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCancelamentoCargaIntegracao>();

            if (motoristas != null && motoristas.Count > 0)
                query = query.Where(obj => obj.CargaCancelamento.Carga.Motoristas.Any(motorista => motoristas.Contains(motorista.Codigo)));

            if (codigoFilial > 0)
                query = query.Where(obj => obj.CargaCancelamento.Carga.Filial.Codigo == codigoFilial);

            if (!string.IsNullOrWhiteSpace(codigoEmbarcador))
                query = query.Where(obj => obj.CargaCancelamento.Carga.CodigoCargaEmbarcador == codigoEmbarcador);

            query.Where(obj => obj.SituacaoIntegracao == SituacaoIntegracao.ProblemaIntegracao);

            query.OrderBy(obj => obj.CargaCancelamento.Carga.DataInicioViagemPrevista);

            var result = from obj in query where obj.SituacaoIntegracao == SituacaoIntegracao.ProblemaIntegracao select obj;

            return result.ToList().Select(obj => obj.CargaCancelamento.Carga.CodigoCargaEmbarcador).FirstOrDefault();
        }

        public bool ContemMaisDeUmMotorista(int codigo)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaMotorista>();

            var result = from obj in query where obj.Carga.Codigo == codigo select obj;

            return result.Count() > 1;
        }

        public bool ContemMDFeEncerrado(int codigo)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaMDFe>();

            var result = from obj in query where obj.Carga.Codigo == codigo && obj.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Encerrado select obj;

            return result.Any();
        }

        public decimal BuscarValorFreteCargasFaturadasPorPeriodo(DateTime dataInicial, DateTime dataFinal, int codigoTransportador)
        {
            List<SituacaoCarga> situacoesCargaNaoFaturada = SituacaoCargaHelper.ObterSituacoesCargaNaoFaturada();

            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o =>
                    !situacoesCargaNaoFaturada.Contains(o.SituacaoCarga) &&
                    o.DataCriacaoCarga >= dataInicial.Date &&
                    o.DataCriacaoCarga <= dataFinal.Date.Add(DateTime.MaxValue.TimeOfDay)
                );

            if (codigoTransportador > 0)
                consultaCarga = consultaCarga.Where(o => o.Empresa.Codigo == codigoTransportador);

            return consultaCarga.Sum(o => (decimal?)o.ValorFreteAPagar) ?? 0m;
        }

        public decimal BuscarValorFreteConhecimentos(int codigoCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();

            var result = from obj in query where obj.Carga.Codigo == codigoCarga select obj.CTe.ValorFrete;

            if (result.Count() > 0)
                return result.Sum();
            else
                return 0;

        }

        public decimal BuscarValorFreteAReceberConhecimentos(int codigoCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();

            query = query.Where(o => o.Carga.Codigo == codigoCarga && o.CargaCTeComplementoInfo == null && o.CTe.Status == "A" && o.CTe.TipoCTE != Dominio.Enumeradores.TipoCTE.Anulacao);

            return query.Sum(o => (decimal?)o.CTe.ValorAReceber) ?? 0m;

        }

        public decimal BuscarValorICMSConhecimentos(int codigoCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaComponentesFrete>();

            query = query.Where(o => o.Carga.Codigo == codigoCarga && o.TipoComponenteFrete == TipoComponenteFrete.ICMS);

            return query.Sum(o => (decimal?)o.ValorComponente) ?? 0m;

        }

        public List<KeyValuePair<int, int>> BuscarCodigosCargasCTeSemFatura(Dominio.Entidades.Embarcador.Fatura.Fatura fatura, int codigoCarga = 0)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();

            query = query.Where(obj => !obj.Carga.CargaTransbordo && obj.CTe.Fatura == null);

            if (fatura.TipoPessoa == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPessoa.Pessoa && fatura.Cliente != null)
            {
                query = query.Where(obj => obj.CTe.DataEmissao >= fatura.DataInicial && obj.CTe.DataEmissao <= fatura.DataFinal.Value.AddDays(1)
                                           && obj.CTe.TomadorPagador.Cliente.CPF_CNPJ == fatura.Cliente.CPF_CNPJ
                                           && obj.CTe.Status == "A");
            }
            else if (fatura.TipoPessoa == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPessoa.GrupoPessoa && fatura.GrupoPessoas != null && fatura.GrupoPessoas.Clientes != null)
            {
                query = query.Where(obj => obj.CTe.DataEmissao >= fatura.DataInicial && obj.CTe.DataEmissao <= fatura.DataFinal.Value.AddDays(1)
                                           && obj.CTe.TomadorPagador.Cliente.GrupoPessoas.Codigo == fatura.GrupoPessoas.Codigo
                                           && obj.CTe.Status == "A");
            }
            else
                query = query.Where(obj => obj.Codigo < 0);//tratativa pois teve uma carga que lançou sem filtro de cliente ou grupo de pessoa

            if (codigoCarga > 0)
                query = query.Where(obj => obj.Carga.Codigo == codigoCarga);

            if (fatura.TipoOperacao != null)
                query = query.Where(obj => obj.Carga.TipoOperacao.Codigo == fatura.TipoOperacao.Codigo);

            if (fatura.Transportadora != null)
                query = query.Where(obj => obj.Carga.Empresa.Codigo == fatura.Transportadora.Codigo);

            return query.Select(obj => new KeyValuePair<int, int>(obj.CTe.Codigo, obj.Carga.Codigo)).Distinct().ToList();
        }

        public List<int> BuscarCargasCTeSemFatura(Dominio.Entidades.Embarcador.Fatura.Fatura fatura, int codigoCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();

            var result = from obj in query where !obj.Carga.CargaTransbordo && obj.CTe.Fatura == null && obj.Carga.Codigo == codigoCarga && !obj.CTe.FaturasTMS.Any(o => o.Fatura.Codigo == fatura.Codigo) select obj;

            if (fatura.TipoPessoa == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPessoa.Pessoa && fatura.Cliente != null)
            {

                result = result.Where(obj => obj.CTe.DataEmissao >= fatura.DataInicial.Value.Date && obj.CTe.DataEmissao < fatura.DataFinal.Value.AddDays(1).Date
                                             && obj.CTe.TomadorPagador.Cliente.CPF_CNPJ == fatura.Cliente.CPF_CNPJ
                                             && obj.CTe.Status == "A");
            }
            else if (fatura.TipoPessoa == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPessoa.GrupoPessoa && fatura.GrupoPessoas != null && fatura.GrupoPessoas.Clientes != null)
            {
                result = result.Where(obj => obj.CTe.DataEmissao >= fatura.DataInicial.Value.Date && obj.CTe.DataEmissao < fatura.DataFinal.Value.AddDays(1).Date
                                             && obj.CTe.TomadorPagador.Cliente.GrupoPessoas.Codigo == fatura.GrupoPessoas.Codigo
                                             && obj.CTe.Status == "A");
            }
            else
                result = result.Where(obj => obj.Codigo < 0);

            return result.Select(o => o.CTe.Codigo).Timeout(120).ToList();
        }

        public dynamic BuscarCargasSemFatura(Dominio.Entidades.Embarcador.Fatura.Fatura fatura, string numeroCarga, int numeroDocumento, DateTime dataCarga, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();

            query = query.Where(obj => !obj.Carga.CargaTransbordo && obj.CTe.Fatura == null);

            if (!string.IsNullOrWhiteSpace(numeroCarga))
                query = query.Where(o => o.Carga.CodigoCargaEmbarcador == numeroCarga);

            if (numeroDocumento > 0)
                query = query.Where(o => o.CTe.Numero == numeroDocumento);

            if (dataCarga != DateTime.MinValue)
                query = query.Where(o => o.Carga.DataCriacaoCarga >= dataCarga.Date && o.Carga.DataCriacaoCarga < dataCarga.AddDays(1).Date);

            if (fatura.TipoPessoa == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPessoa.Pessoa && fatura.Cliente != null)
            {
                query = query.Where(obj => obj.CTe.DataEmissao >= fatura.DataInicial.Value.Date && obj.CTe.DataEmissao < fatura.DataFinal.Value.AddDays(1).Date
                                           && obj.CTe.TomadorPagador.Cliente.CPF_CNPJ == fatura.Cliente.CPF_CNPJ
                                           && obj.CTe.Status == "A");
            }
            else if (fatura.TipoPessoa == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPessoa.GrupoPessoa && fatura.GrupoPessoas != null && fatura.GrupoPessoas.Clientes != null)
            {
                query = query.Where(obj => obj.CTe.DataEmissao >= fatura.DataInicial.Value.Date && obj.CTe.DataEmissao < fatura.DataFinal.Value.AddDays(1).Date
                                           && obj.CTe.TomadorPagador.Cliente.GrupoPessoas.Codigo == fatura.GrupoPessoas.Codigo
                                           && obj.CTe.Status == "A");
            }
            else
                query = query.Where(obj => obj.Codigo < 0);

            if (fatura.TipoOperacao != null)
                query = query.Where(obj => obj.Carga.TipoOperacao.Codigo == fatura.TipoOperacao.Codigo);

            if (fatura.Transportadora != null)
                query = query.Where(obj => obj.Carga.Empresa.Codigo == fatura.Transportadora.Codigo);

            return query.Select(o => new
            {
                o.Carga.Codigo,
                Data = o.Carga.DataCriacaoCarga,//.ToString("dd/MM/yyyy"),
                CodigoCargaEmbarcador = o.Carga.CodigoCargaEmbarcador,
                Emitente = o.Carga.DadosSumarizados.Remetentes + " (" + o.Carga.DadosSumarizados.Origens + ")", // serCargaDadosSumarizados.ObterOrigemTMS(obj, unitOfWork),
                Motoristas = o.Carga.NomeMotoristas,
                Veiculo = o.Carga.PlacasVeiculos
            }).OrderBy(propOrdenacao + (dirOrdenacao == "asc" ? " ascending" : " descending")).Skip(inicioRegistros).Take(maximoRegistros).Distinct().Timeout(120).ToList();
        }

        public int ContarBuscarCargasSemFatura(Dominio.Entidades.Embarcador.Fatura.Fatura fatura, string numeroCarga, int numeroDocumento, DateTime dataCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();

            query = query.Where(obj => !obj.Carga.CargaTransbordo && obj.CTe.Fatura == null);

            if (!string.IsNullOrWhiteSpace(numeroCarga))
                query = query.Where(o => o.Carga.CodigoCargaEmbarcador == numeroCarga);

            if (numeroDocumento > 0)
                query = query.Where(o => o.CTe.Numero == numeroDocumento);

            if (dataCarga != DateTime.MinValue)
                query = query.Where(o => o.Carga.DataCriacaoCarga >= dataCarga.Date && o.Carga.DataCriacaoCarga < dataCarga.AddDays(1).Date);

            if (fatura.TipoPessoa == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPessoa.Pessoa && fatura.Cliente != null)
            {
                query = query.Where(obj => obj.CTe.DataEmissao >= fatura.DataInicial.Value.Date && obj.CTe.DataEmissao < fatura.DataFinal.Value.AddDays(1).Date
                                           && obj.CTe.TomadorPagador.Cliente.CPF_CNPJ == fatura.Cliente.CPF_CNPJ
                                           && obj.CTe.Status == "A");
            }
            else if (fatura.TipoPessoa == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPessoa.GrupoPessoa && fatura.GrupoPessoas != null && fatura.GrupoPessoas.Clientes != null)
            {
                query = query.Where(obj => obj.CTe.DataEmissao >= fatura.DataInicial && obj.CTe.DataEmissao <= fatura.DataFinal.Value.AddDays(1)
                                           && obj.CTe.TomadorPagador.Cliente.GrupoPessoas.Codigo == fatura.GrupoPessoas.Codigo
                                           && obj.CTe.Status == "A");
            }
            else
                query = query.Where(obj => obj.Codigo < 0);

            if (fatura.TipoOperacao != null)
                query = query.Where(obj => obj.Carga.TipoOperacao.Codigo == fatura.TipoOperacao.Codigo);

            if (fatura.Transportadora != null)
                query = query.Where(obj => obj.Carga.Empresa.Codigo == fatura.Transportadora.Codigo);

            return query.Select(o => o.Carga).Distinct().Timeout(120).Count();
        }

        public List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> BuscarConhecimentoCarga(int codigoCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();

            var result = from obj in query where obj.Carga.Codigo == codigoCarga select obj;
            IQueryable<Dominio.Entidades.ConhecimentoDeTransporteEletronico> queryConhecimento = result.Select(obj => obj.CTe);

            return queryConhecimento.ToList();
        }

        public List<Dominio.ObjetosDeValor.Embarcador.Carga.GraficoFaturamentoTransportador> BuscarFaturamentoTransportador(DateTime dataInicial, DateTime dataFinal, int codigoTransportador, int codigoFilial, int codigoCentroCarregamento, int codigoRota, int codigoDestino, int codigoTipoCarga, int codigoModeloVeiculo, double cpfCnpjDestinatario)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento>();

            query = query.Where(o => new SituacaoCarga[] { SituacaoCarga.EmTransporte, SituacaoCarga.Encerrada, SituacaoCarga.LiberadoPagamento }.Contains(o.Carga.SituacaoCarga));
            query = query.Where(o => (((TipoCargaJanelaCarregamento?)o.Tipo).HasValue == false || o.Tipo == TipoCargaJanelaCarregamento.Carregamento));

            if (dataInicial != DateTime.MinValue)
                query = query.Where(o => o.InicioCarregamento >= dataInicial.Date);

            if (dataFinal != DateTime.MinValue)
                query = query.Where(o => o.InicioCarregamento < dataFinal.AddDays(1).Date);

            if (codigoTransportador > 0)
                query = query.Where(o => o.Carga.Empresa.Codigo == codigoTransportador);

            if (codigoFilial > 0)
                query = query.Where(o => o.Carga.Filial.Codigo == codigoFilial);

            if (codigoCentroCarregamento > 0)
                query = query.Where(o => o.CentroCarregamento.Codigo == codigoCentroCarregamento);

            if (codigoRota > 0)
                query = query.Where(o => o.Carga.Rota.Codigo == codigoRota);

            if (codigoDestino > 0)
                query = query.Where(o => o.Carga.Pedidos.Any(cpd => cpd.Destino.Codigo == codigoDestino));

            if (cpfCnpjDestinatario > 0f)
                query = query.Where(o => o.Carga.Pedidos.Any(cpd => cpd.Pedido.Destinatario.CPF_CNPJ == cpfCnpjDestinatario));

            if (codigoTipoCarga > 0)
                query = query.Where(o => o.Carga.TipoDeCarga.Codigo == codigoTipoCarga);

            if (codigoModeloVeiculo > 0)
                query = query.Where(o => o.Carga.ModeloVeicularCarga.Codigo == codigoModeloVeiculo);

            var result = from obj in query
                         group obj by new
                         {
                             CodigoTransportador = obj.Carga.Empresa.Codigo,
                             NomeTransportador = obj.Carga.Empresa.RazaoSocial,
                             CNPJTransportador = obj.Carga.Empresa.CNPJ
                         } into grupo
                         select new Dominio.ObjetosDeValor.Embarcador.Carga.GraficoFaturamentoTransportador()
                         {
                             CNPJTransportador = grupo.Key.CNPJTransportador,
                             Transportador = grupo.Key.NomeTransportador,
                             QuantidadeCargas = grupo.Count(),
                             ValorFrete = grupo.Sum(o => o.Carga.ValorFreteAPagar)
                         };

            return result.ToList();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.GraficoQuantidadeCarga> BuscarQuantidades(int codigoTransportador, int codigoVeiculo, int codigoFilial, int codigoCentroCarregamento, int codigoRota, DateTime dataInicialCarregamento, DateTime dataFinalCarregamento, double cpfCnpjDestinatario, TipoQuantidadeCarga? tipoPai)
        {
            string where = ObterWhereConsultaQuantidades(codigoTransportador, codigoVeiculo, codigoFilial, codigoCentroCarregamento, codigoRota, dataInicialCarregamento, dataFinalCarregamento, cpfCnpjDestinatario, tipoPai);

            var sqlQuery = @"select case cjc_situacao when 4 then 1 when 5 then 2 when 7 then 3 when 3 then 7 when 2 then 8 end Tipo, count(distinct cjc.cjc_codigo) Quantidade 
                             from T_CARGA_JANELA_CARREGAMENTO cjc 
                             inner join t_carga car on cjc.CAR_CODIGO = car.car_codigo 
                             inner join t_carga_pedido cpd on cpd.car_codigo = cjc.CAR_CODIGO
                             inner join t_pedido ped on ped.PED_CODIGO = cpd.PED_CODIGO
                             where cjc.cjc_situacao in (5, 7, 4, 2, 3) and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and
                             cjc.CJC_CODIGO not in (
                             select cjc_codigo from T_CARGA_JANELA_CARREGAMENTO_GUARITA where 
                             (CJC_DATA_ENTRADA_GUARITA is not null and CJC_DATA_FINAL_CARREGAMENTO is not null and CJC_LIBERACAO_VEICULO_CARREGAMENTO is not null) 
                             ) " + where +
                           @"group by cjc_situacao
                             union
                             select 4 Tipo, count(distinct cjc.cjc_codigo) Quantidade 
                             from T_CARGA_JANELA_CARREGAMENTO cjc 
                             inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                             inner join T_CARGA_JANELA_CARREGAMENTO_GUARITA cjg on cjc.CJC_CODIGO = cjg.CJC_CODIGO 
                             inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                             inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                             where cjg.CJC_DATA_ENTRADA_GUARITA is not null and cjg.CJC_DATA_FINAL_CARREGAMENTO is not null and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and car.ROF_CODIGO is not null " + where +
                           @"union
                             select 9 Tipo, count(distinct cjc_codigo) Quantidade
                             from T_CARGA_JANELA_CARREGAMENTO cjc 
                             inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                             inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                             inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                             where cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null " + where +
                           @"union
                             select 10 Tipo, count(distinct cjc.cjc_codigo) Quantidade 
                             from T_CARGA_JANELA_CARREGAMENTO cjc 
                             inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                             inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                             inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                             left join T_CARGA_JANELA_CARREGAMENTO_GUARITA cjg on cjc.CJC_CODIGO = cjg.CJC_CODIGO 
                             where ((cjg.CJC_DATA_ENTRADA_GUARITA is not null and cjg.CJC_DATA_FINAL_CARREGAMENTO is not null) 
                             or
                             (cjc.cjc_situacao = 5 and (cjg.CJC_DATA_ENTRADA_GUARITA is null or cjg.CJC_DATA_FINAL_CARREGAMENTO is null or cjg.CJC_LIBERACAO_VEICULO_CARREGAMENTO is null)))
                             and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null " + where +
                             @"union
                             select 11 Tipo, count(distinct cjc.cjc_codigo) Quantidade
                             from T_CARGA_JANELA_CARREGAMENTO cjc
                             inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO
                             inner join T_CARGA_JANELA_CARREGAMENTO_GUARITA cjg on cjc.CJC_CODIGO = cjg.CJC_CODIGO
                             inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                             inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                             where car.CAR_DATA_FINALIZACAO_EMISSAO is not null  and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null " + where;

            if (!tipoPai.HasValue || tipoPai != TipoQuantidadeCarga.EmAtraso)
            {
                sqlQuery += @"union
                             select 5 Tipo, count(distinct cjc_codigo) Quantidade
                             from T_CARGA_JANELA_CARREGAMENTO cjc 
                             inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                             inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                             inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                             where CONVERT(date, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA) < CONVERT(date, cjc.CJC_INICIO_CARREGAMENTO) and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and car.ROF_CODIGO is not null " + where;
            }

            var query = this.SessionNHiBernate.CreateSQLQuery(sqlQuery);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.GraficoQuantidadeCarga)));

            return query.List<Dominio.ObjetosDeValor.Embarcador.Carga.GraficoQuantidadeCarga>();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.GraficoQuantodadeCargaPorRota> BuscarQuantidadesPorRota(int codigoTransportador, int codigoVeiculo, int codigoFilial, int codigoCentroCarregamento, int codigoRota, DateTime dataInicialCarregamento, DateTime dataFinalCarregamento)
        {
            string where = ObterWhereConsultaQuantidadesRota(codigoTransportador, codigoVeiculo, codigoFilial, codigoCentroCarregamento, codigoRota, dataInicialCarregamento, dataFinalCarregamento);

            var sqlQuery = @"select COUNT(car.CAR_CODIGO) as Quantidade, RotaFrete.ROF_DESCRICAO as Rota from T_CARGA as car left join T_ROTA_FRETE as RotaFrete on car.ROF_CODIGO = RotaFrete.ROF_CODIGO left join T_CARGA_JANELA_CARREGAMENTO as cjc on cjc.CAR_CODIGO = car.CAR_CODIGO " + where + " group by RotaFrete.ROF_DESCRICAO"; // SQL-INJECTION-SAFE
            var query = this.SessionNHiBernate.CreateSQLQuery(sqlQuery);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.GraficoQuantodadeCargaPorRota)));

            return query.List<Dominio.ObjetosDeValor.Embarcador.Carga.GraficoQuantodadeCargaPorRota>();
        }

        public IList<GraficoQuantidadeCarga> BuscarQuantidadesPorTipo(int codigoTransportador, int codigoVeiculo, int codigoFilial, int codigoCentroCarregamento, int codigoRota, DateTime dataInicialCarregamento, DateTime dataFinalCarregamento, double cpfCnpjDestinatario, TipoQuantidadeCarga tipo, TipoQuantidadeCarga? tipoPai)
        {
            string where = ObterWhereConsultaQuantidades(codigoTransportador, codigoVeiculo, codigoFilial, codigoCentroCarregamento, codigoRota, dataInicialCarregamento, dataFinalCarregamento, cpfCnpjDestinatario, tipoPai);

            var sqlQuery = string.Empty;

            switch (tipo)
            {
                case TipoQuantidadeCarga.AgConfirmacaoTransportador:
                    sqlQuery = @"select 1 Tipo, cli.CLI_CGCCPF CPFCNPJ, cli.CLI_NOME Nome, cli.CLI_FISJUR TipoPessoa, count(distinct cjc.cjc_codigo) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join t_carga car on cjc.CAR_CODIGO = car.car_codigo 
                                 inner join t_carga_pedido cpd on cpd.car_codigo = cjc.CAR_CODIGO
                                 inner join t_pedido ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where cjc.cjc_situacao = 4 and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and 
                                 cjc.CJC_CODIGO not in (
                                 select cjc_codigo from T_CARGA_JANELA_CARREGAMENTO_GUARITA where 
                                 (CJC_DATA_ENTRADA_GUARITA is not null and CJC_DATA_FINAL_CARREGAMENTO is not null and CJC_LIBERACAO_VEICULO_CARREGAMENTO is not null)
                                 ) " + where + "group by cli.CLI_NOME, cli.CLI_CGCCPF, cli.CLI_FISJUR";
                    break;
                case TipoQuantidadeCarga.AgLiberacaoParaTransportadores:
                    sqlQuery = @"select 3 Tipo, cli.CLI_CGCCPF CPFCNPJ, cli.CLI_NOME Nome, cli.CLI_FISJUR TipoPessoa, count(distinct cjc.cjc_codigo) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join t_carga car on cjc.CAR_CODIGO = car.car_codigo 
                                 inner join t_carga_pedido cpd on cpd.car_codigo = cjc.CAR_CODIGO
                                 inner join t_pedido ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where cjc.cjc_situacao = 7 and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and 
                                 cjc.CJC_CODIGO not in (
                                 select cjc_codigo from T_CARGA_JANELA_CARREGAMENTO_GUARITA where 
                                 (CJC_DATA_ENTRADA_GUARITA is not null and CJC_DATA_FINAL_CARREGAMENTO is not null and CJC_LIBERACAO_VEICULO_CARREGAMENTO is not null)
                                 ) " + where + "group by cli.CLI_NOME, cli.CLI_CGCCPF, cli.CLI_FISJUR";
                    break;
                case TipoQuantidadeCarga.EmAtraso:
                    sqlQuery = @"select 5 Tipo, cli.CLI_CGCCPF CPFCNPJ, cli.CLI_NOME Nome, cli.CLI_FISJUR TipoPessoa, count(distinct cjc_codigo) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                                 inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                                 inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where CONVERT(date, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA) < CONVERT(date, cjc.CJC_INICIO_CARREGAMENTO) and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and car.ROF_CODIGO is not null " + where + "group by cli.CLI_NOME, cli.CLI_CGCCPF, cli.CLI_FISJUR";
                    break;
                case TipoQuantidadeCarga.JaCarregada:
                    sqlQuery = @"select 4 Tipo, cli.CLI_CGCCPF CPFCNPJ, cli.CLI_NOME Nome, cli.CLI_FISJUR TipoPessoa, count(distinct cjc.cjc_codigo) Quantidade 
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                                 inner join T_CARGA_JANELA_CARREGAMENTO_GUARITA cjg on cjc.CJC_CODIGO = cjg.CJC_CODIGO 
                                 inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                                 inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where cjg.CJC_DATA_ENTRADA_GUARITA is not null and cjg.CJC_DATA_FINAL_CARREGAMENTO is not null and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and car.ROF_CODIGO is not null " + where + @"
                                 group by cli.CLI_NOME, cli.CLI_CGCCPF, cli.CLI_FISJUR";
                    break;
                case TipoQuantidadeCarga.AguardandoCarregamento:
                    sqlQuery = @"select 2 Tipo, cli.CLI_CGCCPF CPFCNPJ, cli.CLI_NOME Nome, cli.CLI_FISJUR TipoPessoa, count(distinct cjc.cjc_codigo) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join t_carga car on cjc.CAR_CODIGO = car.car_codigo 
                                 inner join t_carga_pedido cpd on cpd.car_codigo = cjc.CAR_CODIGO
                                 inner join t_pedido ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where cjc.cjc_situacao = 5 and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and 
                                 cjc.CJC_CODIGO not in (
                                 select cjc_codigo from T_CARGA_JANELA_CARREGAMENTO_GUARITA where 
                                 (CJC_DATA_ENTRADA_GUARITA is not null and CJC_DATA_FINAL_CARREGAMENTO is not null and CJC_LIBERACAO_VEICULO_CARREGAMENTO is not null)
                                 ) " + where + "group by cli.CLI_NOME, cli.CLI_CGCCPF, cli.CLI_FISJUR";
                    break;
                case TipoQuantidadeCarga.SemValorFrete:
                    sqlQuery = @"select 8 Tipo, cli.CLI_CGCCPF CPFCNPJ, cli.CLI_NOME Nome, cli.CLI_FISJUR TipoPessoa, count(distinct cjc.cjc_codigo) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join t_carga car on cjc.CAR_CODIGO = car.car_codigo 
                                 inner join t_carga_pedido cpd on cpd.car_codigo = cjc.CAR_CODIGO
                                 inner join t_pedido ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where cjc.cjc_situacao = 2 and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and 
                                 cjc.CJC_CODIGO not in (
                                 select cjc_codigo from T_CARGA_JANELA_CARREGAMENTO_GUARITA where 
                                 (CJC_DATA_ENTRADA_GUARITA is not null and CJC_DATA_FINAL_CARREGAMENTO is not null and CJC_LIBERACAO_VEICULO_CARREGAMENTO is not null)
                                 ) " + where + "group by cli.CLI_NOME, cli.CLI_CGCCPF, cli.CLI_FISJUR";
                    break;
                case TipoQuantidadeCarga.SemTransportador:
                    sqlQuery = @"select 7 Tipo, cli.CLI_CGCCPF CPFCNPJ, cli.CLI_NOME Nome, cli.CLI_FISJUR TipoPessoa, count(distinct cjc.cjc_codigo) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join t_carga car on cjc.CAR_CODIGO = car.car_codigo 
                                 inner join t_carga_pedido cpd on cpd.car_codigo = cjc.CAR_CODIGO
                                 inner join t_pedido ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where cjc.cjc_situacao = 3 and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and  and 
                                 cjc.CJC_CODIGO not in (
                                 select cjc_codigo from T_CARGA_JANELA_CARREGAMENTO_GUARITA where 
                                 (CJC_DATA_ENTRADA_GUARITA is not null and CJC_DATA_FINAL_CARREGAMENTO is not null and CJC_LIBERACAO_VEICULO_CARREGAMENTO is not null)
                                 ) " + where + "group by cli.CLI_NOME, cli.CLI_CGCCPF, cli.CLI_FISJUR";
                    break;
                case TipoQuantidadeCarga.TotalCargaJanelaCarregamento:
                    sqlQuery = @"select 9 Tipo, cli.CLI_CGCCPF CPFCNPJ, cli.CLI_NOME Nome, cli.CLI_FISJUR TipoPessoa, count(distinct cjc.cjc_codigo) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                                 inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                                 inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null " + where + "group by cli.CLI_NOME, cli.CLI_CGCCPF, cli.CLI_FISJUR";
                    break;
                case TipoQuantidadeCarga.ProntaParaCarregar:
                    sqlQuery = @"select 10 Tipo, cli.CLI_CGCCPF CPFCNPJ, cli.CLI_NOME Nome, cli.CLI_FISJUR TipoPessoa, count(distinct cjc.cjc_codigo) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                                 inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                                 inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 left join T_CARGA_JANELA_CARREGAMENTO_GUARITA cjg on cjc.CJC_CODIGO = cjg.CJC_CODIGO 
                                 where ((cjg.CJC_DATA_ENTRADA_GUARITA is not null and cjg.CJC_DATA_FINAL_CARREGAMENTO is not null) 
                                 or
                                 (cjc.cjc_situacao = 5 and (cjg.CJC_DATA_ENTRADA_GUARITA is null or cjg.CJC_DATA_FINAL_CARREGAMENTO is null or cjg.CJC_LIBERACAO_VEICULO_CARREGAMENTO is null)))
                                 and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null " + where + "group by cli.CLI_NOME, cli.CLI_CGCCPF, cli.CLI_FISJUR";
                    break;
                case TipoQuantidadeCarga.Faturada:
                    sqlQuery = @"select 4 Tipo, cli.CLI_CGCCPF CPFCNPJ, cli.CLI_NOME Nome, cli.CLI_FISJUR TipoPessoa, count(distinct cjc.cjc_codigo) Quantidade 
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                                 inner join T_CARGA_JANELA_CARREGAMENTO_GUARITA cjg on cjc.CJC_CODIGO = cjg.CJC_CODIGO 
                                 inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                                 inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where car.CAR_DATA_FINALIZACAO_EMISSAO is not null  and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null " + where + @"
                                 group by cli.CLI_NOME, cli.CLI_CGCCPF, cli.CLI_FISJUR";
                    break;

                default:
                    sqlQuery = "";
                    break;
            }

            var query = this.SessionNHiBernate.CreateSQLQuery(sqlQuery);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.GraficoQuantidadeCarga)));

            return query.List<Dominio.ObjetosDeValor.Embarcador.Carga.GraficoQuantidadeCarga>();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.GraficoQuantidadeCarga> BuscarQuantidadePallets(int codigoTransportador, int codigoVeiculo, int codigoFilial, int codigoCentroCarregamento, int codigoRota, DateTime dataInicialCarregamento, DateTime dataFinalCarregamento, double cpfCnpjDestinatario, TipoQuantidadeCarga? tipoPai)
        {
            string where = ObterWhereConsultaQuantidades(codigoTransportador, codigoVeiculo, codigoFilial, codigoCentroCarregamento, codigoRota, dataInicialCarregamento, dataFinalCarregamento, cpfCnpjDestinatario, tipoPai);

            var sqlQuery = @"select case cjc.cjc_situacao when 4 then 1 when 5 then 2 when 7 then 3 when 3 then 7 when 2 then 8 end Tipo, SUM(ped.PED_NUMERO_PALETES) Quantidade 
                             from T_CARGA_JANELA_CARREGAMENTO cjc 
                             inner join t_carga car on cjc.CAR_CODIGO = car.car_codigo 
                             inner join t_carga_pedido cpd on cpd.car_codigo = cjc.CAR_CODIGO
                             inner join t_pedido ped on ped.PED_CODIGO = cpd.PED_CODIGO
                             where cjc.cjc_situacao in (5, 7, 4, 2, 3) and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and
                             cjc.CJC_CODIGO not in (
                             select cjc_codigo from T_CARGA_JANELA_CARREGAMENTO_GUARITA where 
                             (CJC_DATA_ENTRADA_GUARITA is not null and CJC_DATA_FINAL_CARREGAMENTO is not null and CJC_LIBERACAO_VEICULO_CARREGAMENTO is not null) 
                             ) " + where +
                           @"group by cjc.cjc_situacao
                             union
                             select 4 Tipo, SUM(ped.PED_NUMERO_PALETES) Quantidade 
                             from T_CARGA_JANELA_CARREGAMENTO cjc 
                             inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                             inner join T_CARGA_JANELA_CARREGAMENTO_GUARITA cjg on cjc.CJC_CODIGO = cjg.CJC_CODIGO 
                             inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                             inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                             where cjg.CJC_DATA_ENTRADA_GUARITA is not null and cjg.CJC_DATA_FINAL_CARREGAMENTO is not null and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and car.ROF_CODIGO is not null " + where +
                           @"union
                             select 9 Tipo, SUM(ped.PED_NUMERO_PALETES) Quantidade
                             from T_CARGA_JANELA_CARREGAMENTO cjc 
                             inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                             inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                             inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                             where cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null " + where +
                           @"union
                             select 10 Tipo, SUM(ped.PED_NUMERO_PALETES) Quantidade 
                             from T_CARGA_JANELA_CARREGAMENTO cjc 
                             inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                             inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                             inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                             left join T_CARGA_JANELA_CARREGAMENTO_GUARITA cjg on cjc.CJC_CODIGO = cjg.CJC_CODIGO 
                             where ((cjg.CJC_DATA_ENTRADA_GUARITA is not null and cjg.CJC_DATA_FINAL_CARREGAMENTO is not null) 
                             or
                             (cjc.cjc_situacao = 5 and (cjg.CJC_DATA_ENTRADA_GUARITA is null or cjg.CJC_DATA_FINAL_CARREGAMENTO is null or cjg.CJC_LIBERACAO_VEICULO_CARREGAMENTO is null)))
                             and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null " + where;

            if (!tipoPai.HasValue || tipoPai != TipoQuantidadeCarga.EmAtraso)
            {
                sqlQuery += @"union
                             select 5 Tipo, SUM(ped.PED_NUMERO_PALETES) Quantidade
                             from T_CARGA_JANELA_CARREGAMENTO cjc 
                             inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                             inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                             inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                             where CONVERT(date, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA) < CONVERT(date, cjc.CJC_INICIO_CARREGAMENTO) and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and car.ROF_CODIGO is not null " + where;
            }

            var query = this.SessionNHiBernate.CreateSQLQuery(sqlQuery);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.GraficoQuantidadeCarga)));

            return query.List<Dominio.ObjetosDeValor.Embarcador.Carga.GraficoQuantidadeCarga>();
        }

        public IList<GraficoQuantidadeCarga> BuscarCargasPorTipo(int codigoTransportador, int codigoVeiculo, int codigoFilial, int codigoCentroCarregamento, int codigoRota, DateTime dataInicialCarregamento, DateTime dataFinalCarregamento, double cpfCnpjDestinatario, TipoQuantidadeCarga tipo, TipoQuantidadeCarga? tipoPai)
        {
            string where = ObterWhereConsultaQuantidades(codigoTransportador, codigoVeiculo, codigoFilial, codigoCentroCarregamento, codigoRota, dataInicialCarregamento, dataFinalCarregamento, cpfCnpjDestinatario, tipoPai);

            var sqlQuery = string.Empty;

            switch (tipo)
            {
                case TipoQuantidadeCarga.AgConfirmacaoTransportador:
                    sqlQuery = @"select 1 Tipo, car.CAR_CODIGO Codigo, car.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA DataCarregamentoProgramada, cjc.CJC_INICIO_CARREGAMENTO InicioCarregamento, SUM(ped.PED_NUMERO_PALETES) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join t_carga car on cjc.CAR_CODIGO = car.car_codigo 
                                 inner join t_carga_pedido cpd on cpd.car_codigo = cjc.CAR_CODIGO
                                 inner join t_pedido ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where cjc.cjc_situacao = 4 and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and 
                                 cjc.CJC_CODIGO not in (
                                 select cjc_codigo from T_CARGA_JANELA_CARREGAMENTO_GUARITA where 
                                 (CJC_DATA_ENTRADA_GUARITA is not null and CJC_DATA_FINAL_CARREGAMENTO is not null and CJC_LIBERACAO_VEICULO_CARREGAMENTO is not null)
                                 ) " + where + "group by car.CAR_CODIGO_CARGA_EMBARCADOR, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA, cjc.CJC_INICIO_CARREGAMENTO, car.CAR_CODIGO";
                    break;
                case TipoQuantidadeCarga.AgLiberacaoParaTransportadores:
                    sqlQuery = @"select 3 Tipo, car.CAR_CODIGO Codigo, car.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA DataCarregamentoProgramada, cjc.CJC_INICIO_CARREGAMENTO InicioCarregamento, SUM(ped.PED_NUMERO_PALETES) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join t_carga car on cjc.CAR_CODIGO = car.car_codigo 
                                 inner join t_carga_pedido cpd on cpd.car_codigo = cjc.CAR_CODIGO
                                 inner join t_pedido ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where cjc.cjc_situacao = 7 and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and 
                                 cjc.CJC_CODIGO not in (
                                 select cjc_codigo from T_CARGA_JANELA_CARREGAMENTO_GUARITA where 
                                 (CJC_DATA_ENTRADA_GUARITA is not null and CJC_DATA_FINAL_CARREGAMENTO is not null and CJC_LIBERACAO_VEICULO_CARREGAMENTO is not null)
                                 ) " + where + "group by car.CAR_CODIGO_CARGA_EMBARCADOR, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA,  cjc.CJC_INICIO_CARREGAMENTO, car.CAR_CODIGO";
                    break;
                case TipoQuantidadeCarga.EmAtraso:
                    sqlQuery = @"select 5 Tipo, car.CAR_CODIGO Codigo, car.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA DataCarregamentoProgramada, cjc.CJC_INICIO_CARREGAMENTO InicioCarregamento, SUM(ped.PED_NUMERO_PALETES) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                                 inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                                 inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where CONVERT(date, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA) < CONVERT(date, cjc.CJC_INICIO_CARREGAMENTO) and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and car.ROF_CODIGO is not null " + where + "group by car.CAR_CODIGO_CARGA_EMBARCADOR, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA, cjc.CJC_INICIO_CARREGAMENTO, car.CAR_CODIGO";
                    break;
                case TipoQuantidadeCarga.JaCarregada:
                    sqlQuery = @"select 4 Tipo, car.CAR_CODIGO Codigo, car.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA DataCarregamentoProgramada, cjc.CJC_INICIO_CARREGAMENTO InicioCarregamento, SUM(ped.PED_NUMERO_PALETES) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                                 inner join T_CARGA_JANELA_CARREGAMENTO_GUARITA cjg on cjc.CJC_CODIGO = cjg.CJC_CODIGO 
                                 inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                                 inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where cjg.CJC_DATA_ENTRADA_GUARITA is not null and cjg.CJC_DATA_FINAL_CARREGAMENTO is not null and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and car.ROF_CODIGO is not null " + where + @"
                                 group by car.CAR_CODIGO_CARGA_EMBARCADOR, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA, cjc.CJC_INICIO_CARREGAMENTO, car.CAR_CODIGO";
                    break;
                case TipoQuantidadeCarga.AguardandoCarregamento:
                    sqlQuery = @"select 2 Tipo, car.CAR_CODIGO Codigo, car.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA DataCarregamentoProgramada, cjc.CJC_INICIO_CARREGAMENTO InicioCarregamento, SUM(ped.PED_NUMERO_PALETES) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join t_carga car on cjc.CAR_CODIGO = car.car_codigo 
                                 inner join t_carga_pedido cpd on cpd.car_codigo = cjc.CAR_CODIGO
                                 inner join t_pedido ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where cjc.cjc_situacao = 5 and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and 
                                 cjc.CJC_CODIGO not in (
                                 select cjc_codigo from T_CARGA_JANELA_CARREGAMENTO_GUARITA where 
                                 (CJC_DATA_ENTRADA_GUARITA is not null and CJC_DATA_FINAL_CARREGAMENTO is not null and CJC_LIBERACAO_VEICULO_CARREGAMENTO is not null)
                                 ) " + where + "group by car.CAR_CODIGO_CARGA_EMBARCADOR, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA, cjc.CJC_INICIO_CARREGAMENTO, car.CAR_CODIGO";
                    break;
                case TipoQuantidadeCarga.SemValorFrete:
                    sqlQuery = @"select 8 Tipo, car.CAR_CODIGO Codigo, car.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA DataCarregamentoProgramada, cjc.CJC_INICIO_CARREGAMENTO InicioCarregamento, SUM(ped.PED_NUMERO_PALETES) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join t_carga car on cjc.CAR_CODIGO = car.car_codigo 
                                 inner join t_carga_pedido cpd on cpd.car_codigo = cjc.CAR_CODIGO
                                 inner join t_pedido ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where cjc.cjc_situacao = 2 and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and 
                                 cjc.CJC_CODIGO not in (
                                 select cjc_codigo from T_CARGA_JANELA_CARREGAMENTO_GUARITA where 
                                 (CJC_DATA_ENTRADA_GUARITA is not null and CJC_DATA_FINAL_CARREGAMENTO is not null and CJC_LIBERACAO_VEICULO_CARREGAMENTO is not null)
                                 ) " + where + "group by car.CAR_CODIGO_CARGA_EMBARCADOR, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA,  cjc.CJC_INICIO_CARREGAMENTO, car.CAR_CODIGO";
                    break;
                case TipoQuantidadeCarga.SemTransportador:
                    sqlQuery = @"select 7 Tipo, car.CAR_CODIGO Codigo, car.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA DataCarregamentoProgramada, cjc.CJC_INICIO_CARREGAMENTO InicioCarregamento, SUM(ped.PED_NUMERO_PALETES) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join t_carga car on cjc.CAR_CODIGO = car.car_codigo 
                                 inner join t_carga_pedido cpd on cpd.car_codigo = cjc.CAR_CODIGO
                                 inner join t_pedido ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where cjc.cjc_situacao = 3 and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null and 
                                 cjc.CJC_CODIGO not in (
                                 select cjc_codigo from T_CARGA_JANELA_CARREGAMENTO_GUARITA where 
                                 (CJC_DATA_ENTRADA_GUARITA is not null and CJC_DATA_FINAL_CARREGAMENTO is not null and CJC_LIBERACAO_VEICULO_CARREGAMENTO is not null)
                                 ) " + where + "group by car.CAR_CODIGO_CARGA_EMBARCADOR, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA,  cjc.CJC_INICIO_CARREGAMENTO, car.CAR_CODIGO";
                    break;
                case TipoQuantidadeCarga.TotalCargaJanelaCarregamento:
                    sqlQuery = @"select 9 Tipo, car.CAR_CODIGO Codigo, car.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA DataCarregamentoProgramada, cjc.CJC_INICIO_CARREGAMENTO InicioCarregamento, SUM(ped.PED_NUMERO_PALETES) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                                 inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                                 inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null " + where + "group by car.CAR_CODIGO_CARGA_EMBARCADOR, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA, cjc.CJC_INICIO_CARREGAMENTO, car.CAR_CODIGO";
                    break;
                case TipoQuantidadeCarga.ProntaParaCarregar:
                    sqlQuery = @"select 10 Tipo, car.CAR_CODIGO Codigo, car.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA DataCarregamentoProgramada, cjc.CJC_INICIO_CARREGAMENTO InicioCarregamento, SUM(ped.PED_NUMERO_PALETES) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                                 inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                                 inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 left join T_CARGA_JANELA_CARREGAMENTO_GUARITA cjg on cjc.CJC_CODIGO = cjg.CJC_CODIGO 
                                 where ((cjg.CJC_DATA_ENTRADA_GUARITA is not null and cjg.CJC_DATA_FINAL_CARREGAMENTO is not null) 
                                 or
                                 (cjc.cjc_situacao = 5 and (cjg.CJC_DATA_ENTRADA_GUARITA is null or cjg.CJC_DATA_FINAL_CARREGAMENTO is null or cjg.CJC_LIBERACAO_VEICULO_CARREGAMENTO is null)))
                                 and cjc.CJC_EXCEDENTE = 0 and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null " + where + "group by car.CAR_CODIGO_CARGA_EMBARCADOR, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA, cjc.CJC_INICIO_CARREGAMENTO, car.CAR_CODIGO";
                    break;
                case TipoQuantidadeCarga.Faturada:
                    sqlQuery = @"select 4 Tipo, car.CAR_CODIGO Codigo, car.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA DataCarregamentoProgramada, cjc.CJC_INICIO_CARREGAMENTO InicioCarregamento, SUM(ped.PED_NUMERO_PALETES) Quantidade
                                 from T_CARGA_JANELA_CARREGAMENTO cjc 
                                 inner join T_CARGA car on car.CAR_CODIGO = cjc.CAR_CODIGO 
                                 inner join T_CARGA_JANELA_CARREGAMENTO_GUARITA cjg on cjc.CJC_CODIGO = cjg.CJC_CODIGO 
                                 inner join T_CARGA_PEDIDO cpd on cpd.CAR_CODIGO = cjc.CAR_CODIGO
                                 inner join T_PEDIDO ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where car.CAR_DATA_FINALIZACAO_EMISSAO is not null  and car.CAR_SITUACAO <> 13 and cjc.CEC_CODIGO is not null " + where + @"
                                 group by car.CAR_CODIGO_CARGA_EMBARCADOR, cjc.CJC_DATA_CARREGAMENTO_PROGRAMADA, cjc.CJC_INICIO_CARREGAMENTO, car.CAR_CODIGO";
                    break;
                default:
                    sqlQuery = "";
                    break;
            }

            var query = this.SessionNHiBernate.CreateSQLQuery(sqlQuery);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.GraficoQuantidadeCarga)));

            return query.List<Dominio.ObjetosDeValor.Embarcador.Carga.GraficoQuantidadeCarga>();
        }

        public IList<GraficoQuantidadeCarga> BuscarDestinatariosPorCarga(int codigoCarga, TipoQuantidadeCarga tipo)
        {
            var sqlQuery = @"select " + tipo.ToString("D") + @" Tipo, cli.CLI_CGCCPF CPFCNPJ, cli.CLI_NOME Nome, cli.CLI_FISJUR TipoPessoa, SUM(cpd.PED_VALOR_FRETE_PAGAR) + SUM(cpd.PED_VALOR_ICMS) ValorFrete, SUM(ped.PED_NUMERO_PALETES) Quantidade
                                 from t_carga car
                                 inner join t_carga_pedido cpd on cpd.car_codigo = car.CAR_CODIGO
                                 inner join t_pedido ped on ped.PED_CODIGO = cpd.PED_CODIGO
                                 inner join t_cliente cli on ped.CLI_CODIGO = cli.CLI_CGCCPF
                                 where car.CAR_CODIGO = " + codigoCarga.ToString() + " group by cli.CLI_CGCCPF, cli.CLI_NOME, cli.CLI_FISJUR"; // SQL-INJECTION-SAFE

            var query = this.SessionNHiBernate.CreateSQLQuery(sqlQuery);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.GraficoQuantidadeCarga)));

            return query.List<Dominio.ObjetosDeValor.Embarcador.Carga.GraficoQuantidadeCarga>();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarCargasFinalizadasAmbiente(bool cargasNaoAgrupadas, int transportador, string numeroCarga, SituacaoCarga[] situacao, string propOrdena, string dirOrdena, int inicioRegistros, int maximoRegistros)
        {
            var result = _ConsultarCargasFinalizadasAmbiente(cargasNaoAgrupadas, transportador, null, numeroCarga, situacao);

            if (!string.IsNullOrWhiteSpace(propOrdena))
                result = result.OrderBy(propOrdena + (dirOrdena == "asc" ? " ascending" : " descending"));

            if (inicioRegistros > 0)
                result = result.Skip(inicioRegistros);

            if (maximoRegistros > 0)
                result = result.Take(maximoRegistros);

            return result.ToList();
        }

        public int ContarConsultaCargasFinalizadasAmbiente(bool cargasNaoAgrupadas, int transportador, long? codigoTransportadorTerceiro, string numeroCarga, SituacaoCarga[] situacao)
        {
            var result = _ConsultarCargasFinalizadasAmbiente(cargasNaoAgrupadas, transportador, codigoTransportadorTerceiro, numeroCarga, situacao);

            return result.Count();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarAvarias(double recebedor, double destinatario, string numeroCarga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga[] situacao, string propOrdena, string dirOrdena, int inicioRegistros, int maximoRegistros)
        {
            var result = _ConsultarAvarias(recebedor, destinatario, numeroCarga, situacao);

            if (!string.IsNullOrWhiteSpace(propOrdena))
                result = result.OrderBy(propOrdena + (dirOrdena == "asc" ? " ascending" : " descending"));

            if (inicioRegistros > 0)
                result = result.Skip(inicioRegistros);

            if (maximoRegistros > 0)
                result = result.Take(maximoRegistros);

            return result
                .Fetch(obj => obj.Empresa)
                .Fetch(obj => obj.TipoOperacao)
                .Fetch(obj => obj.Filial)
                .Fetch(obj => obj.DadosSumarizados)
                .ToList();
        }

        public int ContarConsultaAvarias(double recebedor, double destinatario, string numeroCarga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga[] situacao)
        {
            var result = _ConsultarAvarias(recebedor, destinatario, numeroCarga, situacao);

            return result.Count();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasOcorrenciaPorPeriodo(DateTime periodoInicial, DateTime periodoFim, int transportador, double proprietario)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => o.DataCriacaoCarga.Date >= periodoInicial && o.DataCriacaoCarga.Date <= periodoFim.AddDays(1).Date);
            query = query.Where(o => o.Empresa.Codigo == transportador || o.Veiculo.Proprietario.CPF_CNPJ == proprietario);
            query = query.Where(o => o.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada);

            return query.ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarCargasDaOcorrenciaPorCTe(int ocorrencia, string propOrdena, string dirOrdena, int inicioRegistros, int maximoRegistros)
        {
            var result = _ConsultarCargasDaOcorrenciaPorCTe(ocorrencia);

            if (inicioRegistros > 0)
                result = result.Skip(inicioRegistros);

            if (maximoRegistros > 0)
                result = result.Take(maximoRegistros);

            if (!string.IsNullOrWhiteSpace(propOrdena))
                result = result.OrderBy(propOrdena + (dirOrdena == "asc" ? " ascending" : " descending"));

            return result.ToList();
        }

        public int ContarConsultaCargasDaOcorrenciaPorCTe(int ocorrencia)
        {
            var result = _ConsultarCargasDaOcorrenciaPorCTe(ocorrencia);

            return result.Count();
        }

        public List<int> BuscarCargasAguardandoCalculoFrete(Dominio.Enumeradores.LoteCalculoFrete controleCalculoFretePorLote, bool exigirCargaRoteirizada, int limite, AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware tipoServicoMultisoftware, bool calcularFreteInicioCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var queryCancelamento = ObterCargasEmCancelamento();

            if (!calcularFreteInicioCarga)
                query = query.Where(o => (o.SituacaoCarga == SituacaoCarga.CalculoFrete || (!o.ExigeNotaFiscalParaCalcularFrete && o.SituacaoCarga == SituacaoCarga.AgTransportador)));
            else
                query = query.Where(o => (o.SituacaoCarga == SituacaoCarga.CalculoFrete || o.SituacaoCarga == SituacaoCarga.Nova || o.SituacaoCarga == SituacaoCarga.AgNFe)
                || (!o.ExigeNotaFiscalParaCalcularFrete && o.SituacaoCarga == SituacaoCarga.AgTransportador));

            query = query.Where(o => (o.CargaFechada &&
               o.CalculandoFrete &&
               !o.PendenteGerarCargaDistribuidor &&
               !o.IntegrandoValePedagio &&
               (!o.ProblemaIntegracaoValePedagio || o.LiberadoComProblemaValePedagio) &&
               !queryCancelamento.Any(can => can.Carga == o)));

            if (exigirCargaRoteirizada)
                query = query.Where(o => o.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Concluido);
            else
                query = query.Where(o => o.TipoOperacao.ExigirCargaRoteirizada ? o.SituacaoRoteirizacaoCarga == SituacaoRoteirizacao.Concluido : o.SituacaoRoteirizacaoCarga != SituacaoRoteirizacao.Aguardando);
            //else
            //    query = query.Where(o => o.SituacaoRoteirizacaoCarga != SituacaoRoteirizacao.Aguardando);

            if (controleCalculoFretePorLote == Dominio.Enumeradores.LoteCalculoFrete.Integracao)
                query = query.Where(o => o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote) || (o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Integracao));
            else if (controleCalculoFretePorLote == Dominio.Enumeradores.LoteCalculoFrete.Padrao)
                query = query.Where(o => !o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote) && (o.CalcularFreteLote == null || o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Padrao));
            else if (controleCalculoFretePorLote == Dominio.Enumeradores.LoteCalculoFrete.Reprocessamento)
                query = query.Where(o => !o.Integracoes.Any(i => i.TipoIntegracao.ControlePorLote) && (o.CalcularFreteLote == Dominio.Enumeradores.LoteCalculoFrete.Reprocessamento));

            return query
                .OrderBy(o => o.PosicaoFilaProcessamento)
                .ThenBy(o => o.DataInicioCalculoFrete)
                .Select(obj => obj.Codigo)
                .Take(limite)
                .ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarCargaConhecimento(int codigoConhecimento, string propOrdena, string dirOrdena, int inicioRegistros, int maximoRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();
            var result = from obj in query select obj;

            if (codigoConhecimento > 0)
                result = result.Where(o => o.CTe.Codigo == codigoConhecimento);

            if (!string.IsNullOrWhiteSpace(propOrdena))
                result = result.OrderBy(propOrdena + (dirOrdena == "asc" ? " ascending" : " descending"));

            if (inicioRegistros > 0)
                result = result.Skip(inicioRegistros);

            if (maximoRegistros > 0)
                result = result.Take(maximoRegistros);

            return result.Select(obj => obj.Carga).ToList();
        }

        public int ContarConsultarCargaConhecimento(int codigoConhecimento)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();
            var result = from obj in query select obj;

            if (codigoConhecimento > 0)
                result = result.Where(o => o.CTe.Codigo == codigoConhecimento);

            return result.Select(o => o.Carga).Count();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorPedido(int codigoPedido)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>()
                .Where(o => o.Pedido.Codigo == codigoPedido)
                .Select(o => o.Carga);

            return consultaCarga.FirstOrDefault();
        }

        public List<int> BuscarCodigosPorPedidos(List<int> codigosPedidos)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>()
                .Where(o => codigosPedidos.Contains(o.Pedido.Codigo))
                .Select(o => o.Carga);

            return consultaCarga
                .Select(obj => obj.Codigo)
                .Distinct()
                .ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasPorPedido(int codigoPedido)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>()
                .Where(o =>
                    (o.Pedido.Codigo == codigoPedido) &&
                    (o.Carga.SituacaoCarga != SituacaoCarga.Cancelada) &&
                    (o.Carga.SituacaoCarga != SituacaoCarga.Anulada)
                )
                .Select(o => o.Carga);

            return consultaCarga
                .FetchMany(o => o.Pedidos)
                .Distinct()
                .ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasPorPedidos(List<int> codigosPedidos)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>()
                .Where(o =>
                    (codigosPedidos.Contains(o.Pedido.Codigo)) &&
                    (o.Carga.SituacaoCarga != SituacaoCarga.Cancelada) &&
                    (o.Carga.SituacaoCarga != SituacaoCarga.Anulada)
                )
                .Select(o => o.Carga);

            return consultaCarga
                .Fetch(o => o.Empresa)
                .FetchMany(o => o.Pedidos)
                .Distinct()
                .ToList();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.AcompanhamentoCarga.PedidoCargaVinculada> BuscarPedidoCargaVinculada(int codigoCarga)
        {
            var sql = $@"select Pedido.PED_CODIGO codigo, Pedido.PED_NUMERO_PEDIDO_EMBARCADOR numeroPedido, Destinatario.CLI_NOME cliente, isnull(SUBSTRING((
			SELECT ', ' + carga.CAR_CODIGO_CARGA_EMBARCADOR
			FROM T_CARGA_PEDIDO cargaPedido
			inner join t_carga carga on cargaPedido.CAR_CODIGO = carga.CAR_CODIGO
			inner join t_pedido ped on cargaPedido.PED_CODIGO = ped.PED_CODIGO
			WHERE ped.PED_CODIGO = Pedido.PED_CODIGO FOR XML PATH('')), 3, 1000), '') cargas
            FROM T_CARGA_PEDIDO cargaPedido
			inner join t_carga carga on cargaPedido.CAR_CODIGO = carga.CAR_CODIGO
			inner join t_pedido pedido on cargaPedido.PED_CODIGO = pedido.PED_CODIGO
			LEFT JOIN T_CLIENTE Destinatario ON Destinatario.CLI_CGCCPF = Pedido.CLI_CODIGO 
			WHERE carga.CAR_CODIGO = {codigoCarga}";

            var consulta = this.SessionNHiBernate.CreateSQLQuery(sql);
            consulta.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.AcompanhamentoCarga.PedidoCargaVinculada)));

            return consulta.SetTimeout(7000).List<Dominio.ObjetosDeValor.Embarcador.Carga.AcompanhamentoCarga.PedidoCargaVinculada>();

        }

        //public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasDeColetaPorPedidos(List<int> codigoPedido)
        //{
        //    var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
        //    query.Where(obj => codigoPedido.Contains(obj.Pedido.Codigo) && obj.Carga.CargaColeta == true);
        //    return query.Select(o => o.Carga).ToList();
        //}

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarAtivaPorNumeroPedido(string numeroPedido)
        {
            var consultaCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>()
                .Where(o =>
                    o.Pedido.NumeroPedidoEmbarcador == numeroPedido &&
                    o.Carga.SituacaoCarga != SituacaoCarga.Cancelada &&
                    o.Carga.SituacaoCarga != SituacaoCarga.Anulada
                );

            return consultaCargaPedido
                .Select(o => o.Carga)
                .FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorNumeroPedido(string numeroPedido)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
            var result = from obj in query where obj.Pedido.NumeroPedidoEmbarcador == numeroPedido select obj.Carga;
            return result.FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorNumeroPedidoCancelada(string numeroPedido)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
            var result = from obj in query where obj.Pedido.NumeroPedidoEmbarcador == numeroPedido && (obj.Carga.SituacaoCarga == SituacaoCarga.Cancelada || obj.Carga.SituacaoCarga == SituacaoCarga.Anulada) select obj.Carga;
            return result.FirstOrDefault();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarParaPreCarga(DateTime dataInicial, DateTime dataFinal, string numeroCarga, int filial, int origem, int destino, int transportador, List<double> remetentes, List<double> destinatarios, string propOrdena, string dirOrdena, int inicioRegistros, int maximoRegistros)
        {
            var result = _ConsultarParaPreCarga(dataInicial, dataFinal, numeroCarga, filial, origem, destino, transportador, remetentes, destinatarios);

            if (!string.IsNullOrWhiteSpace(propOrdena))
                result = result.OrderBy(propOrdena + (dirOrdena == "asc" ? " ascending" : " descending"));

            if (inicioRegistros > 0)
                result = result.Skip(inicioRegistros);

            if (maximoRegistros > 0)
                result = result.Take(maximoRegistros);

            return result
                .Fetch(o => o.Empresa)
                .Fetch(o => o.Veiculo)
                .ThenFetch(o => o.Empresa)
                .Fetch(o => o.TipoDeCarga)
                .Fetch(o => o.ModeloVeicularCarga)
                .ToList();
        }

        public int ContarConsultaParaPreCarga(DateTime dataInicial, DateTime dataFinal, string numeroCarga, int filial, int origem, int destino, int transportador, List<double> remetentes, List<double> destinatarios)
        {
            var result = _ConsultarParaPreCarga(dataInicial, dataFinal, numeroCarga, filial, origem, destino, transportador, remetentes, destinatarios);

            return result.Count();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargaPorClienteDestino(double cnpjClienteDestino, DateTime dataUltimaConsulta)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query
                         where (obj.SituacaoCarga == SituacaoCarga.Encerrada
                                || obj.SituacaoCarga == SituacaoCarga.EmTransporte
                                || obj.SituacaoCarga == SituacaoCarga.AgIntegracao
                                || obj.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos
                                || obj.SituacaoCarga == SituacaoCarga.LiberadoPagamento)
                               && obj.DataFinalizacaoEmissao > dataUltimaConsulta && obj.CargaFechada
                         select obj;

            if (cnpjClienteDestino > 0)
                result = result.Where(o => o.Pedidos.Any(p => p.Pedido.Destinatario.CPF_CNPJ == cnpjClienteDestino));

            return result.OrderByDescending(o => o.Codigo).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargaPorClienteDestino(double cnpjClienteDestino, int quantidade)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query
                         where (obj.SituacaoCarga == SituacaoCarga.Encerrada
                                || obj.SituacaoCarga == SituacaoCarga.EmTransporte
                                || obj.SituacaoCarga == SituacaoCarga.AgIntegracao
                                || obj.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos
                                || obj.SituacaoCarga == SituacaoCarga.LiberadoPagamento) && obj.CargaFechada
                         select obj;

            if (cnpjClienteDestino > 0)
                result = result.Where(o => o.DataFimViagem == null && o.Pedidos.Any(p => p.Pedido.Destinatario.CPF_CNPJ == cnpjClienteDestino));

            return result.OrderByDescending(o => o.Codigo).Take(quantidade).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargaPorClienteDestinoCanceladas(double cnpjClienteDestino, DateTime dataUltimaConsulta)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCancelamento>();
            var result = from obj in query
                         where (obj.SituacaoCargaNoCancelamento == SituacaoCarga.Encerrada
                            || obj.SituacaoCargaNoCancelamento == SituacaoCarga.EmTransporte
                            || obj.SituacaoCargaNoCancelamento == SituacaoCarga.AgIntegracao
                            || obj.SituacaoCargaNoCancelamento == SituacaoCarga.AgImpressaoDocumentos
                            || obj.SituacaoCargaNoCancelamento == SituacaoCarga.LiberadoPagamento) && obj.DataCancelamento > dataUltimaConsulta
                            && ((TipoCancelamentoCargaDocumento?)obj.TipoCancelamentoCargaDocumento ?? TipoCancelamentoCargaDocumento.Carga) == TipoCancelamentoCargaDocumento.Carga
                         select obj;

            if (cnpjClienteDestino > 0)
                result = result.Where(o => o.Carga.Pedidos.Any(p => p.Pedido.Destinatario.CPF_CNPJ == cnpjClienteDestino));

            return result.Select(obj => obj.Carga).OrderByDescending(o => o.Codigo).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargaPorClienteDestinoEncerradas(double cnpjClienteDestino, DateTime dataUltimaConsulta)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaRegistroEncerramento>();
            var result = from obj in query
                         where obj.Carga.Pedidos.Any(p => p.Pedido.Destinatario.CPF_CNPJ == cnpjClienteDestino) && obj.DataEncerramento.HasValue && obj.DataEncerramento.Value > dataUltimaConsulta
                         select obj;
            return result.Select(obj => obj.Carga).OrderByDescending(o => o.Codigo).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargaAgNotaPorCliente(double cnpjClienteDestino, DateTime dataUltimaConsulta)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query
                         where obj.SituacaoCarga == SituacaoCarga.AgNFe && obj.Pedidos.Any(p => p.Pedido.Destinatario.CPF_CNPJ == cnpjClienteDestino) && obj.DataCriacaoCarga > dataUltimaConsulta
                         select obj;
            return result.OrderByDescending(o => o.Codigo).ToList();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarCargaPorCargaTrocaNota(int codigoCargaTrocaNota)
        {
            var cargaTrocaNota = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.CargaTrocaNota.Codigo == codigoCargaTrocaNota)
                .FirstOrDefault();

            return cargaTrocaNota;
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarOperacaoTrocaNota(string codigoCargaEmbarcador, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            var consultaCarga = ConsultarOperacaoTrocaNota(codigoCargaEmbarcador);

            return ObterLista(consultaCarga, parametrosConsulta);
        }

        public int ContarConsultaOperacaoTrocaNota(string codigoCargaEmbarcador)
        {
            var consultaCarga = ConsultarOperacaoTrocaNota(codigoCargaEmbarcador);

            return consultaCarga.Count();
        }

        public List<Dominio.Entidades.Embarcador.Chamados.Chamado> BuscarListaPorCargaEntregaPendentes(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaEntrega filtrosPesquisa, Dominio.Entidades.Usuario usuarioLogado)
        {
            var consultaCargaEntrega = ConsultarCargaEntrega(filtrosPesquisa, usuarioLogado).Select(obj => obj.Codigo);

            var query = SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Chamados.Chamado>();
            var result = from obj in query
                         where obj.CargaEntrega.ChamadoEmAberto == true && consultaCargaEntrega.Contains(obj.Carga.Codigo)
                         select obj;

            if (!filtrosPesquisa.VisualizarAtendimentosOperadorResponsavel)
                result = result.Where(o => o.Responsavel == null);

            return result
                .Fetch(o => o.CargaEntrega)
                .ThenFetch(o => o.Carga)
                .OrderBy(o => o.DataCriacao)
                .ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarCargasEntrega(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaEntrega filtrosPesquisa, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta, Dominio.Entidades.Usuario usuarioLogado, string orderBy = "", string versaoAppLoja = null)
        {
            var consultaCargaEntrega = ConsultarCargaEntrega(filtrosPesquisa, usuarioLogado, versaoAppLoja);

            consultaCargaEntrega = consultaCargaEntrega
                .Fetch(obj => obj.Carregamento)
                .Fetch(obj => obj.DadosSumarizados)
                .Fetch(obj => obj.Filial)
                .Fetch(obj => obj.TipoOperacao)
                .Fetch(obj => obj.VeiculosVinculados)
                .Fetch(obj => obj.Empresa)
                .ThenFetch(obj => obj.Localidade)
                .Fetch(obj => obj.Rota)
                .Fetch(obj => obj.Veiculo);

            if (!filtrosPesquisa.OrdernarResultadosPorDataCriacao)
                switch (orderBy)
                {
                    case "AnalistaResponsavelMonitoramento":
                        consultaCargaEntrega = consultaCargaEntrega.OrderBy(obj => obj.AnalistaResponsavelMonitoramento != null ? 1 : -1);
                        break;
                }

            return ObterLista(consultaCargaEntrega, parametrosConsulta);
        }

        public int ContarConsultarCargaEntrega(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaEntrega filtrosPesquisa, Dominio.Entidades.Usuario usuarioLogado, string versaoAppLoja = null)
        {
            var consultaCargaEntrega = ConsultarCargaEntrega(filtrosPesquisa, usuarioLogado, versaoAppLoja);

            return consultaCargaEntrega.Count();
        }

        public int ContarConsultarCargaEntregaNaoFinalizada(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaEntrega filtrosPesquisa, Dominio.Entidades.Usuario usuarioLogado, string versaoAppLoja = null)
        {
            filtrosPesquisa.FiltrarPorProcessamentoEmLote = true;
            var consultaCargaEntrega = ConsultarCargaEntrega(filtrosPesquisa, usuarioLogado, versaoAppLoja);

            consultaCargaEntrega = consultaCargaEntrega.Where(obj => obj.Entregas.Any(e => e.Situacao != SituacaoEntrega.Entregue));

            var listaConsultaCargaEntregaFiltrada = consultaCargaEntrega.ToList();

            return listaConsultaCargaEntregaFiltrada.Count();
        }

        public Task<List<Dominio.Entidades.Embarcador.Cargas.Carga>> ConsultarCargasEntregaNaoFinalizadaAsync(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaEntrega filtrosPesquisa, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta, Dominio.Entidades.Usuario usuarioLogado, string orderBy = "", string versaoAppLoja = null)
        {
            filtrosPesquisa.FiltrarPorProcessamentoEmLote = true;
            var consultaCargaEntrega = ConsultarCargaEntrega(filtrosPesquisa, usuarioLogado, versaoAppLoja);

            consultaCargaEntrega = consultaCargaEntrega
                .Fetch(obj => obj.DadosSumarizados)
                .Fetch(obj => obj.TipoOperacao)
                .Fetch(obj => obj.Empresa)
                .ThenFetch(obj => obj.Localidade)
                .Fetch(obj => obj.Veiculo)
                .Where(obj => obj.Entregas.Any(e => e.Situacao != SituacaoEntrega.Entregue));

            if (!filtrosPesquisa.OrdernarResultadosPorDataCriacao)
                switch (orderBy)
                {
                    case "AnalistaResponsavelMonitoramento":
                        consultaCargaEntrega = consultaCargaEntrega.OrderBy(obj => obj.AnalistaResponsavelMonitoramento != null ? 1 : -1);
                        break;
                }

            return ObterListaAsync(consultaCargaEntrega, parametrosConsulta);
        }

        public List<int> BuscarCodigosCargasEmFechamento(int maximoRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var situacoes = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCargaHelper.ObterSituacoesCargaSemDocumentacao();

            query = query.Where(o => o.CargaFechada == false && o.FechandoCarga == true && situacoes.Contains(o.SituacaoCarga));

            return query.OrderBy(o => o.Codigo).Select(o => o.Codigo).Take(maximoRegistros).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasAguardandoAgrupamentoAutomatico(int maximoRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => !o.CargaFechada && o.AgruparCargaAutomaticamente);

            return query.OrderBy(o => o.Codigo).Take(maximoRegistros).ToList();
        }

        public int ContarCargasAguardandoAgrupamentoAutomatico()
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => !o.CargaFechada && o.AgruparCargaAutomaticamente);

            return query.Count();
        }

        public Task<List<Dominio.Entidades.Embarcador.Cargas.Carga>> BuscarPorPeriodoCriacaoAsync(DateTime dataInicial, DateTime dataFinal, int limite)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o =>
                    o.DataCriacaoCarga >= dataInicial &&
                    o.DataCriacaoCarga <= dataFinal
                )
                .Take(limite);

            return query.ToListAsync(CancellationToken);
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasFaturadasPorPeriodoETransportador(DateTime dataInicial, DateTime dataFinal, int codigoTransportador)
        {
            List<SituacaoCarga> situacoesCargaNaoFaturada = SituacaoCargaHelper.ObterSituacoesCargaNaoFaturada();

            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o =>
                    !situacoesCargaNaoFaturada.Contains(o.SituacaoCarga) &&
                    o.DataCriacaoCarga >= dataInicial.Date &&
                    o.DataCriacaoCarga <= dataFinal.Date.Add(DateTime.MaxValue.TimeOfDay) &&
                    o.Empresa.Codigo == codigoTransportador
                );

            return consultaCarga.ToList();
        }

        public void DeletarEntrega(int codigoCargaEntrega)
        {
            try
            {

                if (UnitOfWork.IsActiveTransaction())
                {
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaFoto WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaFoto c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaNFeDevolucao WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaNFeDevolucao c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaNotaFiscal WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaNotaFiscal c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM OcorrenciaColetaEntrega WHERE Codigo IN (SELECT c.Codigo FROM OcorrenciaColetaEntrega c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM PermanenciaCliente WHERE Codigo IN (SELECT c.Codigo FROM PermanenciaCliente c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM PermanenciaSubarea WHERE Codigo IN (SELECT c.Codigo FROM PermanenciaSubarea c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaPedido WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaPedido c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaProduto WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaProduto c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntrega c WHERE c.Codigo = :codigoCargaEntrega").SetInt32("codigoCargaEntrega", codigoCargaEntrega).SetTimeout(300).ExecuteUpdate();
                }
                else
                {
                    try
                    {
                        UnitOfWork.Start();

                        UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaFoto WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaFoto c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                        UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaNFeDevolucao WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaNFeDevolucao c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                        UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaNotaFiscal WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaNotaFiscal c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                        UnitOfWork.Sessao.CreateQuery("DELETE FROM OcorrenciaColetaEntrega WHERE Codigo IN (SELECT c.Codigo FROM OcorrenciaColetaEntrega c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                        UnitOfWork.Sessao.CreateQuery("DELETE FROM PermanenciaCliente WHERE Codigo IN (SELECT c.Codigo FROM PermanenciaCliente c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                        UnitOfWork.Sessao.CreateQuery("DELETE FROM PermanenciaSubarea WHERE Codigo IN (SELECT c.Codigo FROM PermanenciaSubarea c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                        UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaPedido WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaPedido c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                        UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaProduto WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaProduto c WHERE c.CargaEntrega.Codigo = :codigoCargaEntrega)").SetInt32("codigoCargaEntrega", codigoCargaEntrega).ExecuteUpdate();
                        UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntrega c WHERE c.Codigo = :codigoCargaEntrega").SetInt32("codigoCargaEntrega", codigoCargaEntrega).SetTimeout(300).ExecuteUpdate();

                        UnitOfWork.CommitChanges();
                    }
                    catch
                    {
                        UnitOfWork.Rollback();
                        throw;
                    }
                }
            }
            catch (NHibernate.Exceptions.GenericADOException excecao)
            {
                if ((excecao.InnerException != null) && object.ReferenceEquals(excecao.InnerException.GetType(), typeof(System.Data.SqlClient.SqlException)))
                {
                    System.Data.SqlClient.SqlException excecaoSql = (System.Data.SqlClient.SqlException)excecao.InnerException;

                    if (excecaoSql.Number == 547)
                        throw new Exception("O registro possui dependências e não pode ser excluido.", excecaoSql);
                }

                throw;
            }
        }

        public void DeletarEntregas(int codigoCarga)
        {
            try
            {

                if (UnitOfWork.IsActiveTransaction())
                {
                    DeletarCargaEntregas(codigoCarga);
                }
                else
                {
                    try
                    {
                        UnitOfWork.Start();

                        DeletarCargaEntregas(codigoCarga);

                        UnitOfWork.CommitChanges();
                    }
                    catch
                    {
                        UnitOfWork.Rollback();
                        throw;
                    }
                }
            }
            catch (NHibernate.Exceptions.GenericADOException excecao)
            {
                if ((excecao.InnerException != null) && object.ReferenceEquals(excecao.InnerException.GetType(), typeof(System.Data.SqlClient.SqlException)))
                {
                    System.Data.SqlClient.SqlException excecaoSql = (System.Data.SqlClient.SqlException)excecao.InnerException;

                    if (excecaoSql.Number == 547)
                        throw new Exception("O registro possui dependências e não pode ser excluido.", excecaoSql);
                }

                throw;
            }
        }

        public void DeletarColeta(int codigoCargaColeta)
        {
            try
            {
                if (UnitOfWork.IsActiveTransaction())
                {
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColetaFoto WHERE Codigo IN (SELECT c.Codigo FROM CargaColetaFoto c WHERE c.CargaColeta.Codigo = :codigoCargaColeta)").SetInt32("codigoCargaColeta", codigoCargaColeta).ExecuteUpdate();
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColetaNotaFiscal WHERE Codigo IN (SELECT c.Codigo FROM CargaColetaNotaFiscal c WHERE c.CargaColeta.Codigo = :codigoCargaColeta)").SetInt32("codigoCargaColeta", codigoCargaColeta).ExecuteUpdate();
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColetaPedido WHERE Codigo IN (SELECT c.Codigo FROM CargaColetaPedido c WHERE c.CargaColeta.Codigo = :codigoCargaColeta)").SetInt32("codigoCargaColeta", codigoCargaColeta).ExecuteUpdate();
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColeta c WHERE c.Codigo = :codigoCargaColeta").SetInt32("codigoCargaColeta", codigoCargaColeta).ExecuteUpdate();
                }
                else
                {
                    try
                    {
                        UnitOfWork.Start();

                        UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColetaFoto WHERE Codigo IN (SELECT c.Codigo FROM CargaColetaFoto c WHERE c.CargaColeta.Codigo = :codigoCargaColeta)").SetInt32("codigoCargaColeta", codigoCargaColeta).ExecuteUpdate();
                        UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColetaNotaFiscal WHERE Codigo IN (SELECT c.Codigo FROM CargaColetaNotaFiscal c WHERE c.CargaColeta.Codigo = :codigoCargaColeta)").SetInt32("codigoCargaColeta", codigoCargaColeta).ExecuteUpdate();
                        UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColetaPedido WHERE Codigo IN (SELECT c.Codigo FROM CargaColetaPedido c WHERE c.CargaColeta.Codigo = :codigoCargaColeta)").SetInt32("codigoCargaColeta", codigoCargaColeta).ExecuteUpdate();
                        UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColeta c WHERE c.Codigo = :codigoCargaColeta").SetInt32("codigoCargaColeta", codigoCargaColeta).ExecuteUpdate();

                        UnitOfWork.CommitChanges();
                    }
                    catch
                    {
                        UnitOfWork.Rollback();
                        throw;
                    }
                }
            }
            catch (NHibernate.Exceptions.GenericADOException excecao)
            {
                if ((excecao.InnerException != null) && object.ReferenceEquals(excecao.InnerException.GetType(), typeof(System.Data.SqlClient.SqlException)))
                {
                    System.Data.SqlClient.SqlException excecaoSql = (System.Data.SqlClient.SqlException)excecao.InnerException;

                    if (excecaoSql.Number == 547)
                        throw new Exception("O registro possui dependências e não pode ser excluido.", excecaoSql);
                }

                throw;
            }
        }

        public void DeletarColetas(int codigoCarga)
        {
            try
            {
                if (UnitOfWork.IsActiveTransaction())
                {
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColetaFoto WHERE Codigo IN (SELECT c.Codigo FROM CargaColetaFoto c WHERE c.CargaColeta.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColetaNotaFiscal WHERE Codigo IN (SELECT c.Codigo FROM CargaColetaNotaFiscal c WHERE c.CargaColeta.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColetaPedido WHERE Codigo IN (SELECT c.Codigo FROM CargaColetaPedido c WHERE c.CargaColeta.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
                    UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColeta c WHERE c.Carga.Codigo = :codigoCarga").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
                }
                else
                {
                    try
                    {
                        UnitOfWork.Start();

                        UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColetaFoto WHERE Codigo IN (SELECT c.Codigo FROM CargaColetaFoto c WHERE c.CargaColeta.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
                        UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColetaNotaFiscal WHERE Codigo IN (SELECT c.Codigo FROM CargaColetaNotaFiscal c WHERE c.CargaColeta.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
                        UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColetaPedido WHERE Codigo IN (SELECT c.Codigo FROM CargaColetaPedido c WHERE c.CargaColeta.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
                        UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaColeta c WHERE c.Carga.Codigo = :codigoCarga").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();

                        UnitOfWork.CommitChanges();
                    }
                    catch
                    {
                        UnitOfWork.Rollback();
                        throw;
                    }
                }
            }
            catch (NHibernate.Exceptions.GenericADOException excecao)
            {
                if ((excecao.InnerException != null) && object.ReferenceEquals(excecao.InnerException.GetType(), typeof(System.Data.SqlClient.SqlException)))
                {
                    System.Data.SqlClient.SqlException excecaoSql = (System.Data.SqlClient.SqlException)excecao.InnerException;

                    if (excecaoSql.Number == 547)
                        throw new Exception("O registro possui dependências e não pode ser excluido.", excecaoSql);
                }

                throw;
            }
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarCargasPendenteCancelamento(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCancelamentoCargaLote filtrosPesquisa, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametroConsulta)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = _ConsultarCargasPendenteCancelamento(filtrosPesquisa);

            query = query
                    .Fetch(obj => obj.DadosSumarizados)
                    .Fetch(obj => obj.PedidoViagemNavio)
                    .Fetch(obj => obj.TerminalOrigem)
                    .Fetch(obj => obj.TerminalDestino)
                    .Fetch(obj => obj.TipoOperacao);

            return ObterLista(query, parametroConsulta);
        }

        public int ContarConsultaCargasPendenteCancelamento(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCancelamentoCargaLote filtrosPesquisa)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = _ConsultarCargasPendenteCancelamento(filtrosPesquisa);

            return query.Count();
        }

        public List<int> ConsultarCodigosCargasPendenteCancelamento(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCancelamentoCargaLote filtrosPesquisa)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = _ConsultarCargasPendenteCancelamento(filtrosPesquisa);

            return query.Select(o => o.Codigo).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarWebServiceMonitoramento(DateTime dataInicial, int inicioRegistros, int limiteRegistros)
        {
            var consultaCarga = ConsultarWebServiceMonitoramento(dataInicial);

            consultaCarga = consultaCarga
                .Fetch(o => o.Filial)
                .Fetch(o => o.TipoDeCarga)
                .Fetch(o => o.Veiculo)
                .Fetch(o => o.VeiculosVinculados)
                .Fetch(o => o.Empresa);

            return consultaCarga
                .Skip(inicioRegistros)
                .Take(limiteRegistros)
                .WithOptions(o => o.SetTimeout(600))
                .ToList();
        }

        public int ContarConsultaWebServiceMonitoramento(DateTime dataInicial)
        {
            var consultaCarga = ConsultarWebServiceMonitoramento(dataInicial);

            return consultaCarga.Count();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasexpLiberadasSemRetiradaContainer(int CodigoTipoContainer, string codigoCargaEmbarcador, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            IQueryable<Dominio.Entidades.Embarcador.Pedidos.ColetaContainer> queryColetaContainer = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.ColetaContainer>();

            query = query.Where(obj => obj.LiberadaSemRetiradaContainer == true && obj.SituacaoCarga != SituacaoCarga.Cancelada);

            if (CodigoTipoContainer > 0)
                query = query.Where(obj => obj.Carregamento.ModeloVeicularCarga.ContainerTipo.Codigo == CodigoTipoContainer || obj.ModeloVeicularCarga.ContainerTipo.Codigo == CodigoTipoContainer);

            if (!string.IsNullOrEmpty(codigoCargaEmbarcador))
                query = query.Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador);

            query = query.Where(obj => !queryColetaContainer.Any(coletaContainer => ((coletaContainer.CargaAtual.Codigo == obj.Codigo || coletaContainer.CargaDeColeta.Codigo == obj.Codigo) && coletaContainer.Container != null)));

            return query.OrderBy(propOrdenacao + (dirOrdenacao == "asc" ? " ascending" : " descending"))
            .Skip(inicioRegistros)
            .Take(maximoRegistros).ToList();

        }
        public async Task<List<Dominio.Entidades.Embarcador.Cargas.Carga>> BuscarCargasexpLiberadasSemRetiradaContainerAsync(int CodigoTipoContainer, string codigoCargaEmbarcador, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            IQueryable<Dominio.Entidades.Embarcador.Pedidos.ColetaContainer> queryColetaContainer = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.ColetaContainer>();

            query = query.Where(obj => obj.LiberadaSemRetiradaContainer == true && obj.SituacaoCarga != SituacaoCarga.Cancelada);

            if (CodigoTipoContainer > 0)
                query = query.Where(obj => obj.Carregamento.ModeloVeicularCarga.ContainerTipo.Codigo == CodigoTipoContainer || obj.ModeloVeicularCarga.ContainerTipo.Codigo == CodigoTipoContainer);

            if (!string.IsNullOrEmpty(codigoCargaEmbarcador))
                query = query.Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador);

            query = query.Where(obj => !queryColetaContainer.Any(coletaContainer => ((coletaContainer.CargaAtual.Codigo == obj.Codigo || coletaContainer.CargaDeColeta.Codigo == obj.Codigo) && coletaContainer.Container != null)));

            return await query.OrderBy(propOrdenacao + (dirOrdenacao == "asc" ? " ascending" : " descending"))
            .Skip(inicioRegistros)
            .Take(maximoRegistros).ToListAsync();

        }

        public int ContarCargasexpLiberadasSemRetiradaContainer(int CodigoTipoContainer, string codigoCargaEmbarcador)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            IQueryable<Dominio.Entidades.Embarcador.Pedidos.ColetaContainer> queryColetaContainer = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.ColetaContainer>();

            query = query.Where(obj => obj.LiberadaSemRetiradaContainer == true);

            if (CodigoTipoContainer > 0)
                query = query.Where(obj => obj.Carregamento.ModeloVeicularCarga.ContainerTipo.Codigo == CodigoTipoContainer || obj.ModeloVeicularCarga.ContainerTipo.Codigo == CodigoTipoContainer);

            if (!string.IsNullOrEmpty(codigoCargaEmbarcador))
                query = query.Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador);

            query = query.Where(obj => !queryColetaContainer.Any(coletaContainer => ((coletaContainer.CargaAtual.Codigo == obj.Codigo || coletaContainer.CargaDeColeta.Codigo == obj.Codigo) && coletaContainer.Container != null)));

            return query.Count();
        }
        public async Task<int> ContarCargasexpLiberadasSemRetiradaContainerAsync(int CodigoTipoContainer, string codigoCargaEmbarcador)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            IQueryable<Dominio.Entidades.Embarcador.Pedidos.ColetaContainer> queryColetaContainer = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.ColetaContainer>();

            query = query.Where(obj => obj.LiberadaSemRetiradaContainer == true);

            if (CodigoTipoContainer > 0)
                query = query.Where(obj => obj.Carregamento.ModeloVeicularCarga.ContainerTipo.Codigo == CodigoTipoContainer || obj.ModeloVeicularCarga.ContainerTipo.Codigo == CodigoTipoContainer);

            if (!string.IsNullOrEmpty(codigoCargaEmbarcador))
                query = query.Where(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador);

            query = query.Where(obj => !queryColetaContainer.Any(coletaContainer => ((coletaContainer.CargaAtual.Codigo == obj.Codigo || coletaContainer.CargaDeColeta.Codigo == obj.Codigo) && coletaContainer.Container != null)));

            return await query.CountAsync();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasPorCarregamento(int carregamentoCodigo)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(obj => obj.Carregamento.Codigo == carregamentoCodigo);
            return query.ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasPorCarregamentos(List<int> codigos)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(obj => codigos.Contains(obj.Carregamento.Codigo));
            return query.ToList();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.AcompanhamentoCarga.AcompanhamentoCargaSumarizadoRetorno> BuscarCargasAcompanhamentoEntregaSumarizado(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaEntrega filtrosPesquisa, DateTime dataHoraAtual, int tipoConsulta, Dominio.Entidades.Embarcador.Cargas.AcompanhamentoEntregaTempoConfiguracao.AcompanhamentoEntregaTempoConfiguracao AcompanhamentoConfig, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS ConfiguracaoEmbarcador)
        {
            StringBuilder where = new StringBuilder();
            var parametros = new List<ParametroSQL>();
            where.Append(" this_.CAR_CARGA_FECHADA = 1 and (this_.CAR_SITUACAO <> 13 or this_.CAR_SITUACAO is null) and (this_.CAR_SITUACAO <> 18 or this_.CAR_SITUACAO is null) and (this_.CAR_VEICULO is not null) ");

            if (!ConfiguracaoEmbarcador.ExibirEntregaAntesEtapaTransporte)
            {
                where.Append(@" AND (((TipoOperacaoMobile.COM_EXIBIR_ENTREGA_ANTES_TRANSPORTE = 0 OR TipoOperacaoMobile.COM_EXIBIR_ENTREGA_ANTES_TRANSPORTE IS NULL)
		                                 AND this_.CAR_SITUACAO in (9, 10, 11, 15, 7) or (this_.CAR_SITUACAO = 6 and this_.CAR_AG_IMPORTACAO_CTE = 1)
	                                    ) OR TipoOperacaoMobile.COM_EXIBIR_ENTREGA_ANTES_TRANSPORTE = 1) ");
            }

            if (filtrosPesquisa.StatusViagem.HasValue)
            {
                if (filtrosPesquisa.StatusViagem.Value == StatusViagemControleEntrega.EmAndamento)
                    where.Append(" and this_.CAR_DATA_INICIO_VIAGEM is not null and this_.CAR_DATA_FIM_VIAGEM is null ");
                else if (filtrosPesquisa.StatusViagem.Value == StatusViagemControleEntrega.Finalizada)
                    where.Append(" and this_.CAR_DATA_FIM_VIAGEM is not null ");
                else if (filtrosPesquisa.StatusViagem.Value == StatusViagemControleEntrega.Iniciada)
                    where.Append(" and this_.CAR_DATA_INICIO_VIAGEM is not null ");
                else if (filtrosPesquisa.StatusViagem.Value == StatusViagemControleEntrega.NaoFinalizada)
                    where.Append(" and this_.CAR_DATA_FIM_VIAGEM is null ");
                else if (filtrosPesquisa.StatusViagem.Value == StatusViagemControleEntrega.NaoIniciada)
                    where.Append(" and this_.CAR_DATA_INICIO_VIAGEM is null ");
            }

            if (!string.IsNullOrEmpty(filtrosPesquisa.CodigoCargaEmbarcador))
            {
                where.Append(" and this_.CAR_CODIGO_CARGA_EMBARCADOR = :CAR_CODIGO_CARGA_EMBARCADOR ");
                parametros.Add(new ParametroSQL("CAR_CODIGO_CARGA_EMBARCADOR", filtrosPesquisa.CodigoCargaEmbarcador));
            }

            if (filtrosPesquisa.CodigosFilial?.Count > 0)
                where.Append($" and this_.FIL_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosFilial)})");

            if (filtrosPesquisa.CpfCnpjDestinatarios?.Count > 0)
            {
                where.Append(" AND EXISTS ( ");
                where.Append("         select cargapedid18_.CPE_CODIGO from T_CARGA_PEDIDO pedidos17_, T_CARGA_PEDIDO cargapedid18_ left outer join T_PEDIDO pedido19_  ");
                where.Append("         on cargapedid18_.PED_CODIGO=pedido19_.PED_CODIGO ");
                where.Append("         left outer join T_CLIENTE cliente20_ on pedido19_.CLI_CODIGO=cliente20_.CLI_CGCCPF  ");
                where.Append("         where this_.CAR_CODIGO=pedidos17_.CAR_CODIGO  and pedidos17_.CPE_CODIGO=cargapedid18_.CPE_CODIGO ");
                where.Append($"        and (cliente20_.CLI_CGCCPF in ({string.Join(", ", filtrosPesquisa.CpfCnpjDestinatarios)})) )");
            }

            if (filtrosPesquisa.CodigosVeiculo?.Count > 0)
                where.Append($" and (veiculo.VEI_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosVeiculo)}))");

            if (filtrosPesquisa.CodigosTipoOperacao?.Count > 0)
                where.Append($" and tipooperacao.TOP_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosTipoOperacao)})");

            if (tipoConsulta == 1)
            {
                //CASO FOR POR DESTINO, deve mudar o SQL comparar pela saida Raio, pois o caminhao esta no destino e devemos verificar o atraso pela data saida do mesmo;
                if (!string.IsNullOrEmpty(filtrosPesquisa.DescSituacaoEntrega) && filtrosPesquisa.DescSituacaoEntrega.Contains("Destino"))
                {
                    where.Append(" and " + MontarconsultaCargaAcompanhamentoEntregaFiltroWhere(filtrosPesquisa.DescSituacaoEntrega, AcompanhamentoConfig));
                }
                else
                {
                    if (string.IsNullOrEmpty(filtrosPesquisa.DescSituacaoEntrega))
                    {
                        where.Append(" and entrega.CEN_COLETA = 0 and entrega.CEN_SITUACAO = 1 ");
                        where.Append("  and (DATEDIFF(minute, entrega.CEN_DATA_SAIDA_RAIO, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + AcompanhamentoConfig.DestinoEmTempo.TotalMinutes + " or (DATEDIFF(minute, entrega.CEN_DATA_SAIDA_RAIO, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + AcompanhamentoConfig.DestinoAtraso1.TotalMinutes + " and DATEDIFF(minute, entrega.CEN_DATA_SAIDA_RAIO, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + (AcompanhamentoConfig.DestinoEmTempo.TotalMinutes + 1) + ") " +
                                        "or (DATEDIFF(minute, entrega.CEN_DATA_SAIDA_RAIO, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + AcompanhamentoConfig.DestinoAtraso2.TotalMinutes + " and DATEDIFF(minute, entrega.CEN_DATA_SAIDA_RAIO, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + AcompanhamentoConfig.DestinoAtraso1.TotalMinutes + ") " +
                                        "or (DATEDIFF(minute, entrega.CEN_DATA_SAIDA_RAIO, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + AcompanhamentoConfig.DestinoAtraso3.TotalMinutes + ")) ");
                    }
                    //retorna vazio pois esta pesquisando por outras situacoes;
                    else
                        return new List<Dominio.ObjetosDeValor.Embarcador.Carga.AcompanhamentoCarga.AcompanhamentoCargaSumarizadoRetorno>();
                }

                var sql2 = @"select this_.CAR_CODIGO as codigocarga, count(this_.CAR_CODIGO) as num, DATEDIFF(minute, entrega.CEN_DATA_SAIDA_RAIO, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') tempo " + // SQL-INJECTION-SAFE
                            "from t_carga this_ " +
                            "left outer join " +
                            "  T_FILIAL filial  " +
                            "  on this_.FIL_CODIGO = filial.FIL_CODIGO " +
                            "  left outer join " +
                            "  T_VEICULO veiculo " +
                            " on this_.CAR_VEICULO = veiculo.VEI_CODIGO " +
                            "  left outer join " +
                            " T_TIPO_OPERACAO tipooperacao " +
                            "  on this_.TOP_CODIGO = tipooperacao.TOP_CODIGO " +
                            "left join T_CONFIGURACAO_TIPO_OPERACAO_MOBILE TipoOperacaoMobile " +
                            "on tipooperacao.COM_CODIGO = TipoOperacaoMobile.COM_CODIGO " +
                            " inner join " +
                            " T_CARGA_ENTREGA entrega on entrega.CAR_CODIGO = this_.CAR_CODIGO " +
                            " where " + where.ToString() +
                            " group by this_.CAR_CODIGO,  DATEDIFF(minute, entrega.CEN_DATA_SAIDA_RAIO, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') ";

                var sqlDinamico = new SQLDinamico(sql2, parametros);

                var consultaDestinos = sqlDinamico.CriarSQLQuery(this.SessionNHiBernate);
                consultaDestinos.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.AcompanhamentoCarga.AcompanhamentoCargaSumarizadoRetorno)));

                return consultaDestinos.SetTimeout(7000).List<Dominio.ObjetosDeValor.Embarcador.Carga.AcompanhamentoCarga.AcompanhamentoCargaSumarizadoRetorno>();
            }
            else if (tipoConsulta == 2)
            {
                //caso devemos filtrar apenas cargas com coletas na qual ja foram coletadas.. (pode ter cargas q nao tem coleta...e ai?)
                //and EXISTS (select entrega.CEN_CODIGO from T_CARGA_ENTREGA ent where ent.CEN_SITUACAO = 2 and ent.CEN_COLETA = 1 and ent.CEN_CODIGO = entrega.CEN_CODIGO)

                //CASO FOR EM TRANSITO, deve mudar o SQL comparar a data programada de entrega e a data reprogramada do inicio da entrega;
                if (!string.IsNullOrEmpty(filtrosPesquisa.DescSituacaoEntrega) && filtrosPesquisa.DescSituacaoEntrega.Contains("Emtransito"))
                {
                    where.Append(" and " + MontarconsultaCargaAcompanhamentoEntregaFiltroWhere(filtrosPesquisa.DescSituacaoEntrega, AcompanhamentoConfig));
                }
                else
                {
                    if (string.IsNullOrEmpty(filtrosPesquisa.DescSituacaoEntrega))
                    {
                        where.Append(" and entrega.CEN_SITUACAO = 0 and entrega.CEN_COLETA = 0");
                        where.Append(" and (DATEDIFF(minute, entrega.CEN_DATA_ENTREGA_PREVISTA, entrega.CEN_DATA_ENTREGA_REPROGRAMADA) <= " + AcompanhamentoConfig.EmtransitoEmTempo.TotalMinutes + " or(DATEDIFF(minute, entrega.CEN_DATA_ENTREGA_PREVISTA, entrega.CEN_DATA_ENTREGA_REPROGRAMADA) <= " + AcompanhamentoConfig.EmTrasitoAtraso1.TotalMinutes + " and DATEDIFF(minute, entrega.CEN_DATA_ENTREGA_PREVISTA, entrega.CEN_DATA_ENTREGA_REPROGRAMADA) > " + (AcompanhamentoConfig.EmtransitoEmTempo.TotalMinutes + 1) + ") " +
                                       " or (DATEDIFF(minute, entrega.CEN_DATA_ENTREGA_PREVISTA, entrega.CEN_DATA_ENTREGA_REPROGRAMADA) <= " + AcompanhamentoConfig.EmTrasitoAtraso2.TotalMinutes + " and DATEDIFF(minute, entrega.CEN_DATA_ENTREGA_PREVISTA, entrega.CEN_DATA_ENTREGA_REPROGRAMADA) > " + AcompanhamentoConfig.EmTrasitoAtraso1.TotalMinutes + ") " +
                                       " or (DATEDIFF(minute, entrega.CEN_DATA_ENTREGA_PREVISTA, entrega.CEN_DATA_ENTREGA_REPROGRAMADA) > " + AcompanhamentoConfig.EmTrasitoAtraso3.TotalMinutes + "))  ");
                    }
                    //retorna vazio pois esta pesquisando por outras situacoes;
                    else
                        return new List<Dominio.ObjetosDeValor.Embarcador.Carga.AcompanhamentoCarga.AcompanhamentoCargaSumarizadoRetorno>();
                }

                var sql2 = @"select this_.CAR_CODIGO as codigocarga, count(this_.CAR_CODIGO) as num, DATEDIFF(minute, entrega.CEN_DATA_ENTREGA_PREVISTA, entrega.CEN_DATA_ENTREGA_REPROGRAMADA) tempo " +
                        "from t_carga this_ " +
                        "left outer join " +
                        "  T_FILIAL filial  " +
                            "  on this_.FIL_CODIGO = filial.FIL_CODIGO " +
                        "  left outer join T_VEICULO veiculo " +
                            "  on this_.CAR_VEICULO = veiculo.VEI_CODIGO " +
                        "  left outer join  T_TIPO_OPERACAO tipooperacao " +
                            "  on this_.TOP_CODIGO = tipooperacao.TOP_CODIGO " +
                            "left join T_CONFIGURACAO_TIPO_OPERACAO_MOBILE TipoOperacaoMobile " +
                            "on tipooperacao.COM_CODIGO = TipoOperacaoMobile.COM_CODIGO " +
                        " inner join T_CARGA_ENTREGA entrega " +
                            "  on entrega.CAR_CODIGO = this_.CAR_CODIGO " +
                        " where " + where.ToString() +
                        " group by this_.CAR_CODIGO, DATEDIFF(minute, entrega.CEN_DATA_ENTREGA_PREVISTA, entrega.CEN_DATA_ENTREGA_REPROGRAMADA) ";

                var consultaEmtransito = this.SessionNHiBernate.CreateSQLQuery(sql2);
                consultaEmtransito.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.AcompanhamentoCarga.AcompanhamentoCargaSumarizadoRetorno)));

                return consultaEmtransito.SetTimeout(7000).List<Dominio.ObjetosDeValor.Embarcador.Carga.AcompanhamentoCarga.AcompanhamentoCargaSumarizadoRetorno>();
            }
            else
            {
                if (!string.IsNullOrEmpty(filtrosPesquisa.DescSituacaoEntrega) && filtrosPesquisa.DescSituacaoEntrega.Contains("Coletas"))
                {
                    where.Append(" and " + MontarconsultaCargaAcompanhamentoEntregaFiltroWhere(filtrosPesquisa.DescSituacaoEntrega, AcompanhamentoConfig));
                }
                else
                {
                    if (string.IsNullOrEmpty(filtrosPesquisa.DescSituacaoEntrega))
                    {
                        where.Append(" and entrega.CEN_SITUACAO = 0 and entrega.CEN_COLETA = 1 ");
                        where.Append(" and (DATEDIFF(minute, entrega.CEN_DATA_FIM_PREVISTA, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') < " + AcompanhamentoConfig.SaidaEmTempo.TotalMinutes + " or(DATEDIFF(minute, entrega.CEN_DATA_FIM_PREVISTA, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + AcompanhamentoConfig.SaidaAtraso1.TotalMinutes + " and DATEDIFF(minute, entrega.CEN_DATA_FIM_PREVISTA, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + (AcompanhamentoConfig.SaidaEmTempo.TotalMinutes + 1) + ") " +
                                      " or (DATEDIFF(minute, entrega.CEN_DATA_FIM_PREVISTA, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + AcompanhamentoConfig.SaidaAtraso2.TotalMinutes + " and DATEDIFF(minute, entrega.CEN_DATA_FIM_PREVISTA, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + AcompanhamentoConfig.SaidaAtraso1.TotalMinutes + ") " +
                                      " or (DATEDIFF(minute, entrega.CEN_DATA_FIM_PREVISTA, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + AcompanhamentoConfig.SaidaAtraso3.TotalMinutes + ")) ");
                    }
                    //retorna vazio pois esta pesquisando por outras situacoes;
                    else
                        return new List<Dominio.ObjetosDeValor.Embarcador.Carga.AcompanhamentoCarga.AcompanhamentoCargaSumarizadoRetorno>();
                }

                //filtrando coletas
                var sql1 = @"select this_.CAR_CODIGO as codigocarga, count(this_.CAR_CODIGO) as num, DATEDIFF(minute, entrega.CEN_DATA_FIM_PREVISTA, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') tempo " + // SQL-INJECTION-SAFE
                     "from t_carga this_ " +
            " left outer join " +
                "  T_FILIAL filial  " +
                    "  on this_.FIL_CODIGO = filial.FIL_CODIGO " +
            " left outer join " +
                "  T_VEICULO veiculo " +
                     " on this_.CAR_VEICULO = veiculo.VEI_CODIGO " +
            " left outer join " +
                " T_TIPO_OPERACAO tipooperacao " +
                    "  on this_.TOP_CODIGO = tipooperacao.TOP_CODIGO " +
            " inner join " +
               " T_CARGA_ENTREGA entrega on entrega.CAR_CODIGO = this_.CAR_CODIGO " +
            " where " + where.ToString() +
            " group by this_.CAR_CODIGO, DATEDIFF(minute, entrega.CEN_DATA_FIM_PREVISTA, '" + dataHoraAtual.ToString("yyyy-MM-dd HH:mm:sss") + "') ";

                var consultaCargas = this.SessionNHiBernate.CreateSQLQuery(sql1);
                consultaCargas.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.AcompanhamentoCarga.AcompanhamentoCargaSumarizadoRetorno)));

                return consultaCargas.SetTimeout(7000).List<Dominio.ObjetosDeValor.Embarcador.Carga.AcompanhamentoCarga.AcompanhamentoCargaSumarizadoRetorno>();
            }
        }

        public int ContarConsultarCargaAcompanhamentoEntrega(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaEntrega filtrosPesquisa, Dominio.Entidades.Embarcador.Cargas.AcompanhamentoEntregaTempoConfiguracao.AcompanhamentoEntregaTempoConfiguracao acompanhamentoConfig, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS ConfiguracaoEmbarcador)
        {
            StringBuilder where = new StringBuilder();

            where.Append(" this_.CAR_CARGA_FECHADA = 1 and (this_.CAR_SITUACAO <> 13 or this_.CAR_SITUACAO is null) and (this_.CAR_SITUACAO <> 18 or this_.CAR_SITUACAO is null) and (this_.CAR_VEICULO is not null) ");

            if (!ConfiguracaoEmbarcador.ExibirEntregaAntesEtapaTransporte)
            {
                where.Append(@" AND (((TipoOperacaoMobile.COM_EXIBIR_ENTREGA_ANTES_TRANSPORTE = 0 OR TipoOperacaoMobile.COM_EXIBIR_ENTREGA_ANTES_TRANSPORTE IS NULL)
		                                 AND this_.CAR_SITUACAO in (9, 10, 11, 15, 7) or (this_.CAR_SITUACAO = 6 and this_.CAR_AG_IMPORTACAO_CTE = 1)
	                                    ) OR TipoOperacaoMobile.COM_EXIBIR_ENTREGA_ANTES_TRANSPORTE = 1) ");
            }

            if (filtrosPesquisa.StatusViagem.HasValue)
            {
                if (filtrosPesquisa.StatusViagem.Value == StatusViagemControleEntrega.EmAndamento)
                    where.Append(" and this_.CAR_DATA_INICIO_VIAGEM is not null and this_.CAR_DATA_FIM_VIAGEM is null ");
                else if (filtrosPesquisa.StatusViagem.Value == StatusViagemControleEntrega.Finalizada)
                    where.Append(" and this_.CAR_DATA_FIM_VIAGEM is not null ");
                else if (filtrosPesquisa.StatusViagem.Value == StatusViagemControleEntrega.Iniciada)
                    where.Append(" and this_.CAR_DATA_INICIO_VIAGEM is not null ");
                else if (filtrosPesquisa.StatusViagem.Value == StatusViagemControleEntrega.NaoFinalizada)
                    where.Append(" and this_.CAR_DATA_FIM_VIAGEM is null ");
                else if (filtrosPesquisa.StatusViagem.Value == StatusViagemControleEntrega.NaoIniciada)
                    where.Append(" and this_.CAR_DATA_INICIO_VIAGEM is null ");
            }

            if (!string.IsNullOrEmpty(filtrosPesquisa.DescSituacaoEntrega))
            {
                where.Append(" and " + MontarconsultaCargaAcompanhamentoEntregaFiltro(filtrosPesquisa.DescSituacaoEntrega, acompanhamentoConfig));
            }
            else
            {
                where.Append(" and exists( " +
                                " select " +
                                " cargaentre2_.CEN_CODIGO " +
                                " from " +
                                " T_CARGA_ENTREGA entregas1_, " +
                                " T_CARGA_ENTREGA cargaentre2_ " +
                                " where " +
                                " this_.CAR_CODIGO = entregas1_.CAR_CODIGO " +
                                " and entregas1_.CEN_CODIGO = cargaentre2_.CEN_CODIGO) ");
            }

            if (!string.IsNullOrEmpty(filtrosPesquisa.CodigoCargaEmbarcador))
                where.Append(" and this_.CAR_CODIGO_CARGA_EMBARCADOR = '" + filtrosPesquisa.CodigoCargaEmbarcador + "' ");

            if (filtrosPesquisa.CodigosFilial?.Count > 0)
                where.Append($" and this_.FIL_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosFilial)})");

            if (filtrosPesquisa.CpfCnpjDestinatarios?.Count > 0)
            {
                where.Append(" AND EXISTS ( ");
                where.Append("         select cargapedid18_.CPE_CODIGO from T_CARGA_PEDIDO pedidos17_, T_CARGA_PEDIDO cargapedid18_ left outer join T_PEDIDO pedido19_  ");
                where.Append("         on cargapedid18_.PED_CODIGO=pedido19_.PED_CODIGO ");
                where.Append("         left outer join T_CLIENTE cliente20_ on pedido19_.CLI_CODIGO = cliente20_.CLI_CGCCPF  ");
                where.Append("         where this_.CAR_CODIGO = pedidos17_.CAR_CODIGO and pedidos17_.CPE_CODIGO=cargapedid18_.CPE_CODIGO ");
                where.Append($"        and (cliente20_.CLI_CGCCPF in ({string.Join(", ", filtrosPesquisa.CpfCnpjDestinatarios)})) )");
            }

            if (filtrosPesquisa.CodigosVeiculo?.Count > 0)
                where.Append($" and (veiculo.VEI_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosVeiculo)}))");

            if (filtrosPesquisa.CodigosTipoOperacao?.Count > 0)
                where.Append($" and tipooperacao.TOP_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosTipoOperacao)})");


            var sql1 = @"select cast(count(*) as INT) " +
                "from t_carga this_ " +
        "left outer join " +
           "  T_FILIAL filial  " +
               "  on this_.FIL_CODIGO = filial.FIL_CODIGO " +
        "  left outer join " +
           "  T_VEICULO veiculo " +
                " on this_.CAR_VEICULO = veiculo.VEI_CODIGO " +
        "  left outer join " +
           " T_TIPO_OPERACAO tipooperacao " +
               "  on this_.TOP_CODIGO = tipooperacao.TOP_CODIGO " +
        "  left outer join " +
           " T_CONFIGURACAO_TIPO_OPERACAO_MOBILE TipoOperacaoMobile " +
               "  on this_.TOP_CODIGO = TipoOperacaoMobile.TOP_CODIGO " +
        " where " + where.ToString() + " ";


            var consultaAcompanhamentoCargas = this.SessionNHiBernate.CreateSQLQuery(sql1);

            return consultaAcompanhamentoCargas.SetTimeout(600).UniqueResult<int>();
        }

        public IList<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarCargasAcompanhamentoEntrega(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaEntrega filtroPesquisa, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta, Dominio.Entidades.Embarcador.Cargas.AcompanhamentoEntregaTempoConfiguracao.AcompanhamentoEntregaTempoConfiguracao acompanhamentoEntregaConfig, Dominio.Entidades.Embarcador.Configuracao.ConfiguracaoTMS ConfiguracaoEmbarcador)
        {
            var criteria = this.SessionNHiBernate.CreateCriteria<Dominio.Entidades.Embarcador.Cargas.Carga>();
            criteria.CreateAlias("Filial", "filial", NHibernate.SqlCommand.JoinType.LeftOuterJoin);
            criteria.CreateAlias("Veiculo", "veiculo", NHibernate.SqlCommand.JoinType.LeftOuterJoin);
            criteria.CreateAlias("TipoOperacao", "tipooperacao", NHibernate.SqlCommand.JoinType.LeftOuterJoin);
            criteria.CreateAlias("tipooperacao.ConfiguracaoMobile", "tipooperacaomobile", NHibernate.SqlCommand.JoinType.LeftOuterJoin);
            criteria.Add(NHibernate.Criterion.Restrictions.Eq("CargaFechada", true));

            var orExpression = NHibernate.Criterion.Restrictions.Or(NHibernate.Criterion.Restrictions.Not(NHibernate.Criterion.Restrictions.Eq("SituacaoCarga", Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada)), NHibernate.Criterion.Restrictions.IsNull("SituacaoCarga"));
            criteria.Add(orExpression);

            var orExpression1 = NHibernate.Criterion.Restrictions.Or(NHibernate.Criterion.Restrictions.Not(NHibernate.Criterion.Restrictions.Eq("SituacaoCarga", Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada)), NHibernate.Criterion.Restrictions.IsNull("SituacaoCarga"));
            criteria.Add(orExpression1);

            if (!ConfiguracaoEmbarcador.ExibirEntregaAntesEtapaTransporte)
            {
                criteria.Add(NHibernate.Criterion.Expression.Sql(@" (((tipooperac4_.COM_EXIBIR_ENTREGA_ANTES_TRANSPORTE = 0 OR tipooperac4_.COM_EXIBIR_ENTREGA_ANTES_TRANSPORTE IS NULL)
                                                                         AND this_.CAR_SITUACAO in (9, 10, 11, 15, 7) or(this_.CAR_SITUACAO = 6 and this_.CAR_AG_IMPORTACAO_CTE = 1)
                                                                        ) OR tipooperac4_.COM_EXIBIR_ENTREGA_ANTES_TRANSPORTE = 1) "));
            }

            if (filtroPesquisa.StatusViagem.HasValue)
            {
                if (filtroPesquisa.StatusViagem.Value == StatusViagemControleEntrega.EmAndamento)
                    criteria.Add(NHibernate.Criterion.Expression.Sql("  this_.CAR_DATA_INICIO_VIAGEM is not null and this_.CAR_DATA_FIM_VIAGEM is null "));
                else if (filtroPesquisa.StatusViagem.Value == StatusViagemControleEntrega.Finalizada)
                    criteria.Add(NHibernate.Criterion.Expression.Sql("  this_.CAR_DATA_FIM_VIAGEM is not null "));
                else if (filtroPesquisa.StatusViagem.Value == StatusViagemControleEntrega.Iniciada)
                    criteria.Add(NHibernate.Criterion.Expression.Sql("  this_.CAR_DATA_INICIO_VIAGEM is not null "));
                else if (filtroPesquisa.StatusViagem.Value == StatusViagemControleEntrega.NaoFinalizada)
                    criteria.Add(NHibernate.Criterion.Expression.Sql("  this_.CAR_DATA_FIM_VIAGEM is null "));
                else if (filtroPesquisa.StatusViagem.Value == StatusViagemControleEntrega.NaoIniciada)
                    criteria.Add(NHibernate.Criterion.Expression.Sql("  this_.CAR_DATA_INICIO_VIAGEM is null "));
            }

            criteria.Add(NHibernate.Criterion.Restrictions.IsNotNull("Veiculo"));

            if (!string.IsNullOrEmpty(filtroPesquisa.DescSituacaoEntrega))
            {
                criteria.Add(NHibernate.Criterion.Expression.Sql(MontarconsultaCargaAcompanhamentoEntregaFiltro(filtroPesquisa.DescSituacaoEntrega, acompanhamentoEntregaConfig)));
            }
            else
            {
                criteria.Add(NHibernate.Criterion.Expression.Sql($" exists( " +
                  " select " +
                  " cargaentre2_.CEN_CODIGO " +
                  " from " +
                  " T_CARGA_ENTREGA entregas1_, " +
                  " T_CARGA_ENTREGA cargaentre2_ " +
                  " where " +
                  " this_.CAR_CODIGO = entregas1_.CAR_CODIGO " +
                  " and entregas1_.CEN_CODIGO = cargaentre2_.CEN_CODIGO) "));
            }


            if (!string.IsNullOrEmpty(filtroPesquisa.CodigoCargaEmbarcador))
                criteria.Add(NHibernate.Criterion.Restrictions.Eq("CodigoCargaEmbarcador", filtroPesquisa.CodigoCargaEmbarcador));

            if (filtroPesquisa.CodigosFilial?.Count > 0)
                criteria.Add(NHibernate.Criterion.Restrictions.In("filial.Codigo", filtroPesquisa.CodigosFilial));

            if (filtroPesquisa.CpfCnpjDestinatarios?.Count > 0)
            {

                criteria.Add(
                    NHibernate.Criterion.Expression.Sql(
                        "EXISTS ( " +
                        " select cargapedid18_.CPE_CODIGO from T_CARGA_PEDIDO pedidos17_, T_CARGA_PEDIDO cargapedid18_ " +
                        " left outer join T_PEDIDO pedido19_ on cargapedid18_.PED_CODIGO = pedido19_.PED_CODIGO " +
                        " left outer join T_CLIENTE cliente20_ on pedido19_.CLI_CODIGO = cliente20_.CLI_CGCCPF " +
                        " where {alias}.CAR_CODIGO = pedidos17_.CAR_CODIGO " +
                        "   and pedidos17_.CPE_CODIGO = cargapedid18_.CPE_CODIGO " +
                        "   and cliente20_.CLI_CGCCPF in ( ? )" +
                        ")",
                        new object[] { string.Join(", ", filtroPesquisa.CpfCnpjDestinatarios) },
                        new IType[] { NHibernateUtil.String }
                    )
                );
            }

            if (filtroPesquisa.CodigosVeiculo?.Count > 0)
                criteria.Add(NHibernate.Criterion.Restrictions.In("veiculo.Codigo", filtroPesquisa.CodigosVeiculo));

            if (filtroPesquisa.CodigosTipoOperacao?.Count > 0)
                criteria.Add(NHibernate.Criterion.Restrictions.In("tipooperacao.Codigo", filtroPesquisa.CodigosTipoOperacao));

            if (parametrosConsulta != null)
            {
                if (!string.IsNullOrWhiteSpace(parametrosConsulta.PropriedadeOrdenar))
                {
                    if (parametrosConsulta.DirecaoOrdenar == "asc")
                        criteria.AddOrder(NHibernate.Criterion.Order.Asc(parametrosConsulta.PropriedadeOrdenar));
                    else
                        criteria.AddOrder(NHibernate.Criterion.Order.Desc(parametrosConsulta.PropriedadeOrdenar));
                }

                if (parametrosConsulta.InicioRegistros > 0)
                    criteria.SetFirstResult(parametrosConsulta.InicioRegistros);

                if (parametrosConsulta.LimiteRegistros > 0)
                    criteria.SetMaxResults(parametrosConsulta.LimiteRegistros);
            }

            return criteria.List<Dominio.Entidades.Embarcador.Cargas.Carga>();

        }

        private string MontarconsultaCargaAcompanhamentoEntregaFiltro(string FiltroDescricaoSituacaoEntrega, Dominio.Entidades.Embarcador.Cargas.AcompanhamentoEntregaTempoConfiguracao.AcompanhamentoEntregaTempoConfiguracao acompanhamentoEntregaConfig)
        {
            switch (FiltroDescricaoSituacaoEntrega)
            {
                case "ColetasEmTempo":
                    return ($" exists( " +
                                " select " +
                                " cargaentre2_.CEN_CODIGO " +
                                " from " +
                                " T_CARGA_ENTREGA entregas1_, " +
                                " T_CARGA_ENTREGA cargaentre2_ " +
                                " where " +
                                " this_.CAR_CODIGO = entregas1_.CAR_CODIGO " +
                                " and entregas1_.CEN_CODIGO = cargaentre2_.CEN_CODIGO and cargaentre2_.CEN_SITUACAO = 0 and cargaentre2_.CEN_COLETA = 1 and " +
                                " (DATEDIFF(minute, cargaentre2_.CEN_DATA_FIM_PREVISTA, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + acompanhamentoEntregaConfig.SaidaEmTempo.TotalMinutes + " )) ");
                case "ColetasAtraso1":
                    return ($" exists( " +
                                " select " +
                                " cargaentre2_.CEN_CODIGO " +
                                " from " +
                                " T_CARGA_ENTREGA entregas1_, " +
                                " T_CARGA_ENTREGA cargaentre2_ " +
                                " where " +
                                " this_.CAR_CODIGO = entregas1_.CAR_CODIGO " +
                                " and entregas1_.CEN_CODIGO = cargaentre2_.CEN_CODIGO and cargaentre2_.CEN_SITUACAO = 0 and cargaentre2_.CEN_COLETA = 1 and " +
                                " (DATEDIFF(minute, cargaentre2_.CEN_DATA_FIM_PREVISTA, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + acompanhamentoEntregaConfig.SaidaAtraso1.TotalMinutes + " and DATEDIFF(minute, cargaentre2_.CEN_DATA_FIM_PREVISTA, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + (acompanhamentoEntregaConfig.SaidaEmTempo.TotalMinutes + 1) + " )) ");

                case "ColetasAtraso2":
                    return ($" exists( " +
                               " select " +
                               " cargaentre2_.CEN_CODIGO " +
                               " from " +
                               " T_CARGA_ENTREGA entregas1_, " +
                               " T_CARGA_ENTREGA cargaentre2_ " +
                               " where " +
                               " this_.CAR_CODIGO = entregas1_.CAR_CODIGO " +
                               " and entregas1_.CEN_CODIGO = cargaentre2_.CEN_CODIGO and cargaentre2_.CEN_SITUACAO = 0 and cargaentre2_.CEN_COLETA = 1 and " +
                               " (DATEDIFF(minute, cargaentre2_.CEN_DATA_FIM_PREVISTA, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + acompanhamentoEntregaConfig.SaidaAtraso2.TotalMinutes + " and DATEDIFF(minute, cargaentre2_.CEN_DATA_FIM_PREVISTA, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + acompanhamentoEntregaConfig.SaidaAtraso1.TotalMinutes + " )) ");
                case "ColetasAtraso3":
                    return ($" exists( " +
                               " select " +
                               " cargaentre2_.CEN_CODIGO " +
                               " from " +
                               " T_CARGA_ENTREGA entregas1_, " +
                               " T_CARGA_ENTREGA cargaentre2_ " +
                               " where " +
                               " this_.CAR_CODIGO = entregas1_.CAR_CODIGO " +
                               " and entregas1_.CEN_CODIGO = cargaentre2_.CEN_CODIGO and cargaentre2_.CEN_SITUACAO = 0 and cargaentre2_.CEN_COLETA = 1 and " +
                               " (DATEDIFF(minute, cargaentre2_.CEN_DATA_FIM_PREVISTA, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + acompanhamentoEntregaConfig.SaidaAtraso3.TotalMinutes + " ))");
                case "EmtransitoOK":
                    return ($" exists( " +
                                 " select " +
                                 " cargaentre2_.CEN_CODIGO " +
                                 " from " +
                                 " T_CARGA_ENTREGA entregas1_, " +
                                 " T_CARGA_ENTREGA cargaentre2_ " +
                                 " where " +
                                 " this_.CAR_CODIGO = entregas1_.CAR_CODIGO " +
                                 " and entregas1_.CEN_CODIGO = cargaentre2_.CEN_CODIGO and cargaentre2_.CEN_SITUACAO = 0 and cargaentre2_.CEN_COLETA = 0 and " +
                                 " (DATEDIFF(minute, cargaentre2_.CEN_DATA_ENTREGA_PREVISTA, cargaentre2_.CEN_DATA_ENTREGA_REPROGRAMADA) <= " + acompanhamentoEntregaConfig.EmtransitoEmTempo.TotalMinutes + " )) ");
                case "EmtransitoAtraso1":
                    return ($" exists( " +
                                  " select " +
                                  " cargaentre2_.CEN_CODIGO " +
                                  " from " +
                                  " T_CARGA_ENTREGA entregas1_, " +
                                  " T_CARGA_ENTREGA cargaentre2_ " +
                                  " where " +
                                  " this_.CAR_CODIGO = entregas1_.CAR_CODIGO " +
                                  " and entregas1_.CEN_CODIGO = cargaentre2_.CEN_CODIGO and cargaentre2_.CEN_SITUACAO = 0 and cargaentre2_.CEN_COLETA = 0 and " +
                                  " (DATEDIFF(minute, cargaentre2_.CEN_DATA_ENTREGA_PREVISTA, cargaentre2_.CEN_DATA_ENTREGA_REPROGRAMADA) <= " + acompanhamentoEntregaConfig.EmTrasitoAtraso1.TotalMinutes + " and DATEDIFF(minute, cargaentre2_.CEN_DATA_ENTREGA_PREVISTA, cargaentre2_.CEN_DATA_ENTREGA_REPROGRAMADA) > " + (acompanhamentoEntregaConfig.EmtransitoEmTempo.TotalMinutes + 1) + ")) ");
                case "EmtransitoAtraso2":
                    return ($" exists( " +
                                  " select " +
                                  " cargaentre2_.CEN_CODIGO " +
                                  " from " +
                                  " T_CARGA_ENTREGA entregas1_, " +
                                  " T_CARGA_ENTREGA cargaentre2_ " +
                                  " where " +
                                  " this_.CAR_CODIGO = entregas1_.CAR_CODIGO " +
                                  " and entregas1_.CEN_CODIGO = cargaentre2_.CEN_CODIGO and cargaentre2_.CEN_SITUACAO = 0 and cargaentre2_.CEN_COLETA = 0 and " +
                                  " (DATEDIFF(minute, cargaentre2_.CEN_DATA_ENTREGA_PREVISTA, cargaentre2_.CEN_DATA_ENTREGA_REPROGRAMADA) <= " + acompanhamentoEntregaConfig.EmTrasitoAtraso2.TotalMinutes + " and DATEDIFF(minute, cargaentre2_.CEN_DATA_ENTREGA_PREVISTA, cargaentre2_.CEN_DATA_ENTREGA_REPROGRAMADA) > " + acompanhamentoEntregaConfig.EmTrasitoAtraso1.TotalMinutes + " )) ");
                case "EmtransitoAtraso3":
                    return ($" exists( " +
                                " select " +
                                " cargaentre2_.CEN_CODIGO " +
                                " from " +
                                " T_CARGA_ENTREGA entregas1_, " +
                                " T_CARGA_ENTREGA cargaentre2_ " +
                                " where " +
                                " this_.CAR_CODIGO = entregas1_.CAR_CODIGO " +
                                " and entregas1_.CEN_CODIGO = cargaentre2_.CEN_CODIGO and cargaentre2_.CEN_SITUACAO = 0 and cargaentre2_.CEN_COLETA = 0 and " +
                                " (DATEDIFF(minute, cargaentre2_.CEN_DATA_ENTREGA_PREVISTA, cargaentre2_.CEN_DATA_ENTREGA_REPROGRAMADA) > " + acompanhamentoEntregaConfig.EmTrasitoAtraso3.TotalMinutes + " )) ");
                case "DestinoEmTempo":
                    return ($" exists( " +
                                 " select " +
                                 " cargaentre2_.CEN_CODIGO " +
                                 " from " +
                                 " T_CARGA_ENTREGA entregas1_, " +
                                 " T_CARGA_ENTREGA cargaentre2_ " +
                                 " where " +
                                 " this_.CAR_CODIGO = entregas1_.CAR_CODIGO " +
                                 " and entregas1_.CEN_CODIGO = cargaentre2_.CEN_CODIGO and cargaentre2_.CEN_SITUACAO = 1 and " +
                                 " (DATEDIFF(minute, cargaentre2_.CEN_DATA_SAIDA_RAIO, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + acompanhamentoEntregaConfig.DestinoEmTempo.TotalMinutes + " )) ");
                case "DestinoAtraso1":
                    return ($" exists( " +
                                  " select " +
                                  " cargaentre2_.CEN_CODIGO " +
                                  " from " +
                                  " T_CARGA_ENTREGA entregas1_, " +
                                  " T_CARGA_ENTREGA cargaentre2_ " +
                                  " where " +
                                  " this_.CAR_CODIGO = entregas1_.CAR_CODIGO " +
                                  " and entregas1_.CEN_CODIGO = cargaentre2_.CEN_CODIGO and cargaentre2_.CEN_SITUACAO = 1 and " +
                                  " (DATEDIFF(minute, cargaentre2_.CEN_DATA_SAIDA_RAIO, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + acompanhamentoEntregaConfig.DestinoAtraso1.TotalMinutes + " and DATEDIFF(minute, cargaentre2_.CEN_DATA_SAIDA_RAIO, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + (acompanhamentoEntregaConfig.DestinoEmTempo.TotalMinutes + 1) + " )) ");
                case "DestinoAtraso2":
                    return ($" exists( " +
                                  " select " +
                                  " cargaentre2_.CEN_CODIGO " +
                                  " from " +
                                  " T_CARGA_ENTREGA entregas1_, " +
                                  " T_CARGA_ENTREGA cargaentre2_ " +
                                  " where " +
                                  " this_.CAR_CODIGO = entregas1_.CAR_CODIGO " +
                                  " and entregas1_.CEN_CODIGO = cargaentre2_.CEN_CODIGO and cargaentre2_.CEN_SITUACAO = 1 and " +
                                  " (DATEDIFF(minute, cargaentre2_.CEN_DATA_SAIDA_RAIO, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + acompanhamentoEntregaConfig.DestinoAtraso2.TotalMinutes + " and DATEDIFF(minute, cargaentre2_.CEN_DATA_SAIDA_RAIO, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + acompanhamentoEntregaConfig.DestinoAtraso1.TotalMinutes + " )) ");
                case "DestinoAtraso3":
                    return ($" exists( " +
                                   " select " +
                                   " cargaentre2_.CEN_CODIGO " +
                                   " from " +
                                   " T_CARGA_ENTREGA entregas1_, " +
                                   " T_CARGA_ENTREGA cargaentre2_ " +
                                   " where " +
                                   " this_.CAR_CODIGO = entregas1_.CAR_CODIGO " +
                                   " and entregas1_.CEN_CODIGO = cargaentre2_.CEN_CODIGO and cargaentre2_.CEN_SITUACAO = 1 and " +
                                   " (DATEDIFF(minute, cargaentre2_.CEN_DATA_SAIDA_RAIO, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + acompanhamentoEntregaConfig.DestinoAtraso3.TotalMinutes + " )) ");
                default:
                    return "";

            }
        }

        private string MontarconsultaCargaAcompanhamentoEntregaFiltroWhere(string FiltroDescricaoSituacaoEntrega, Dominio.Entidades.Embarcador.Cargas.AcompanhamentoEntregaTempoConfiguracao.AcompanhamentoEntregaTempoConfiguracao acompanhamentoEntregaConfig)
        {
            switch (FiltroDescricaoSituacaoEntrega)
            {
                case "ColetasEmTempo":
                    return ($" entrega.CEN_SITUACAO = 0 and entrega.CEN_COLETA = 1 and " +
                                " (DATEDIFF(minute, entrega.CEN_DATA_FIM_PREVISTA, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + acompanhamentoEntregaConfig.SaidaEmTempo.TotalMinutes + " ) ");
                case "ColetasAtraso1":
                    return ($" entrega.CEN_SITUACAO = 0 and entrega.CEN_COLETA = 1 and " +
                                " (DATEDIFF(minute, entrega.CEN_DATA_FIM_PREVISTA, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + acompanhamentoEntregaConfig.SaidaAtraso1.TotalMinutes + " and (DATEDIFF(minute, entrega.CEN_DATA_FIM_PREVISTA, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + (acompanhamentoEntregaConfig.SaidaEmTempo.TotalMinutes + 1) + " )) ");
                case "ColetasAtraso2":
                    return ($" entrega.CEN_SITUACAO = 0 and entrega.CEN_COLETA = 1 and " +
                               " (DATEDIFF(minute, entrega.CEN_DATA_FIM_PREVISTA, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + acompanhamentoEntregaConfig.SaidaAtraso2.TotalMinutes + " and (DATEDIFF(minute, entrega.CEN_DATA_FIM_PREVISTA, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + acompanhamentoEntregaConfig.SaidaAtraso1.TotalMinutes + " )) ");
                case "ColetasAtraso3":
                    return ($" entrega.CEN_SITUACAO = 0 and entrega.CEN_COLETA = 1 and " +
                               " (DATEDIFF(minute, entrega.CEN_DATA_FIM_PREVISTA, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + acompanhamentoEntregaConfig.SaidaAtraso3.TotalMinutes + " )");
                case "EmtransitoOK":
                    return ($" entrega.CEN_SITUACAO = 0 and entrega.CEN_COLETA = 0 and " +
                                 " (DATEDIFF(minute, entrega.CEN_DATA_ENTREGA_PREVISTA, entrega.CEN_DATA_ENTREGA_REPROGRAMADA) <= " + acompanhamentoEntregaConfig.EmtransitoEmTempo.TotalMinutes + " ) ");
                case "EmtransitoAtraso1":
                    return ($" entrega.CEN_SITUACAO = 0 and entrega.CEN_COLETA = 0 and " +
                                  " (DATEDIFF(minute, entrega.CEN_DATA_ENTREGA_PREVISTA, entrega.CEN_DATA_ENTREGA_REPROGRAMADA) <= " + acompanhamentoEntregaConfig.EmTrasitoAtraso1.TotalMinutes + " and (DATEDIFF(minute, entrega.CEN_DATA_ENTREGA_PREVISTA, entrega.CEN_DATA_ENTREGA_REPROGRAMADA) > " + (acompanhamentoEntregaConfig.EmtransitoEmTempo.TotalMinutes + 1) + " )) ");
                case "EmtransitoAtraso2":
                    return ($" entrega.CEN_SITUACAO = 0 and entrega.CEN_COLETA = 0 and " +
                                  " (DATEDIFF(minute, entrega.CEN_DATA_ENTREGA_PREVISTA, entrega.CEN_DATA_ENTREGA_REPROGRAMADA) <= " + acompanhamentoEntregaConfig.EmTrasitoAtraso2.TotalMinutes + " and (DATEDIFF(minute, entrega.CEN_DATA_ENTREGA_PREVISTA, entrega.CEN_DATA_ENTREGA_REPROGRAMADA) > " + acompanhamentoEntregaConfig.EmTrasitoAtraso1.TotalMinutes + " )) ");
                case "EmtransitoAtraso3":
                    return ($" entrega.CEN_SITUACAO = 0 and entrega.CEN_COLETA = 0 and " +
                                " (DATEDIFF(minute, entrega.CEN_DATA_ENTREGA_PREVISTA, entrega.CEN_DATA_ENTREGA_REPROGRAMADA) > " + acompanhamentoEntregaConfig.EmTrasitoAtraso3.TotalMinutes + " ) ");
                case "DestinoEmTempo":
                    return ($" entrega.CEN_SITUACAO = 1 and entrega.CEN_COLETA = 0 and " +
                                 " (DATEDIFF(minute, entrega.CEN_DATA_SAIDA_RAIO, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + acompanhamentoEntregaConfig.DestinoEmTempo.TotalMinutes + " ) ");
                case "DestinoAtraso1":
                    return ($" entrega.CEN_SITUACAO = 1 and entrega.CEN_COLETA = 0 and " +
                                  " (DATEDIFF(minute, entrega.CEN_DATA_SAIDA_RAIO, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + acompanhamentoEntregaConfig.DestinoAtraso1.TotalMinutes + " and (DATEDIFF(minute, entrega.CEN_DATA_SAIDA_RAIO, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + (acompanhamentoEntregaConfig.DestinoEmTempo.TotalMinutes + 1) + " )) ");
                case "DestinoAtraso2":
                    return ($" entrega.CEN_SITUACAO = 1 and entrega.CEN_COLETA = 0 and " +
                                  " (DATEDIFF(minute, entrega.CEN_DATA_SAIDA_RAIO, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') <= " + acompanhamentoEntregaConfig.DestinoAtraso2.TotalMinutes + " and (DATEDIFF(minute, entrega.CEN_DATA_SAIDA_RAIO, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + acompanhamentoEntregaConfig.DestinoAtraso1.TotalMinutes + " )) ");
                case "DestinoAtraso3":
                    return ($" entrega.CEN_SITUACAO = 1 and entrega.CEN_COLETA = 0 and " +
                                   " (DATEDIFF(minute, entrega.CEN_DATA_SAIDA_RAIO, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "') > " + acompanhamentoEntregaConfig.DestinoAtraso3.TotalMinutes + " ) ");
                default:
                    return "";

            }
        }

        public List<Dominio.ObjetosDeValor.WebService.Carga.CargaAgrupadaAguardandoIntegracao> BuscarCargasAgrupadasAguardandoIntegracao(int PageNumber = 0, int PageSize = 0)
        {
            int Offset = (PageNumber - 1) * PageSize;

            var sql = $@" WITH CargaAgrupamentoPai as
            (
                SELECT  C.CAR_CODIGO, C.CAR_PROTOCOLO AS ProtocoloCargaPai
                FROM    T_CARGA C
                WHERE   C.CAR_AG_INTEGRACAO_AGRUPAMENTO_CARGA = 1
                AND     C.CAR_SITUACAO = {(int)SituacaoCarga.AgNFe}";
            if (PageSize != 0)
                sql += $" ORDER BY c.CAR_PROTOCOLO OFFSET {Offset} ROWS FETCH NEXT {PageSize} ROWS ONLY ";

            sql += $@")  SELECT CP.ProtocoloCargaPai , CG.CAR_PROTOCOLO ProtocoloCargaFilha
                        FROM CargaAgrupamentoPai CP
                        INNER  JOIN	T_CARGA CG ON CG.CAR_CODIGO_AGRUPAMENTO = CP.CAR_CODIGO";

            var query = this.SessionNHiBernate.CreateSQLQuery(sql);
            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.WebService.Carga.ProtocolosAguardandoIntegracao)));
            IList<Dominio.ObjetosDeValor.WebService.Carga.ProtocolosAguardandoIntegracao> protocolosAguardandoIntegracao = query.SetTimeout(600).List<Dominio.ObjetosDeValor.WebService.Carga.ProtocolosAguardandoIntegracao>();


            List<Dominio.ObjetosDeValor.WebService.Carga.CargaAgrupadaAguardandoIntegracao> objetoRetorno = new List<Dominio.ObjetosDeValor.WebService.Carga.CargaAgrupadaAguardandoIntegracao>();
            foreach (var cargaAgrupada in protocolosAguardandoIntegracao.GroupBy(o => o.ProtocoloCargaPai))
            {
                objetoRetorno.Add(new Dominio.ObjetosDeValor.WebService.Carga.CargaAgrupadaAguardandoIntegracao
                {
                    ProtocoloCarga = cargaAgrupada.Key,
                    CargasFilhas = cargaAgrupada.Select(o => new Dominio.ObjetosDeValor.WebService.Carga.CargaFilhaAguardandoIntegracao
                    {
                        ProtocoloCarga = o.ProtocoloCargaFilha
                    }).ToList()
                });
            }
            return objetoRetorno;
        }

        public bool ExisteCargaFechadaPorPreCarga(int codigoPreCarga)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.CargaPreCarga.Codigo == codigoPreCarga && o.CargaFechada == true);

            return consultaCarga.Any();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarCargasPorPeriodo(DateTime dataInicial, DateTime dataFinal, int inicio, int limite)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            if (dataInicial > DateTime.MinValue)
                query = query.Where(obj => obj.DataCriacaoCarga >= dataInicial.Date);

            if (dataFinal > DateTime.MinValue)
                query = query.Where(obj => obj.DataCriacaoCarga < dataFinal.Date.AddDays(1));

            query = query.WithOptions(o => o.SetTimeout(240));

            return ObterLista(query, "Codigo", "desc", inicio, limite);
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarCargasComProvisaoPorPeriodo(DateTime dataInicial, DateTime dataFinal, List<string> fetch, int inicio, int limite)
        {
            return ConsultarCargasComProvisaoPorPeriodo(dataInicial, dataFinal, fetch, inicio, limite, false);
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarCargasComProvisaoPorPeriodo(DateTime dataInicial, DateTime dataFinal, List<string> fetch, int inicio, int limite, bool datasCriacaoDaCarga)
        {
            string hql = @"select provisao.Carga from Dominio.Entidades.Embarcador.Escrituracao.Provisao provisao ";

            for (int i = 0; i < fetch.Count; i++)
            {
                hql += $" left join fetch provisao.Carga.{fetch[i]} as {fetch[i]} ";
            }

            hql += "where 1=1 ";

            if (datasCriacaoDaCarga)
            {
                if (dataInicial > DateTime.MinValue && dataFinal > DateTime.MinValue)
                    hql += " and provisao.Carga.DataCriacaoCarga between :dataInicial and :dataFinal ";
            }
            else
            {
                if (dataInicial > DateTime.MinValue)
                    hql += " and provisao.DataInicial >= :dataInicial ";

                if (dataFinal > DateTime.MinValue)
                    hql += " and provisao.DataFinal < :dataFinal ";
            }

            hql += " and provisao.Carga != null order by provisao.Carga.Codigo desc ";

            var query = this.SessionNHiBernate.CreateQuery(hql);

            if (dataInicial > DateTime.MinValue)
                query.SetDateTime("dataInicial", dataInicial.Date);

            if (dataFinal > DateTime.MinValue)
                query.SetDateTime("dataFinal", dataFinal.Date.AddDays(1));

            if (inicio > 0)
                query.SetFirstResult(inicio);

            if (limite > 0)
                query.SetMaxResults(limite);

            return query.List<Dominio.Entidades.Embarcador.Cargas.Carga>().ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ObterCargasParaDiariaAutomatica()
        {
            return BuscarCargasPorSituacoes(new List<SituacaoCarga>() { SituacaoCarga.EmTransporte });
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.AlertaCarga.CargaProcessarEvento> BuscarCargasParaAlertaEventoCarga(int TempoLimite, TipoAlertaCarga tipoAlerta)
        {
            Dominio.ObjetosDeValor.Embarcador.Carga.AlertaCarga.FiltroPesquisaCargasAlertaEvento FiltroPesquisaCargasAlerta = new Dominio.ObjetosDeValor.Embarcador.Carga.AlertaCarga.FiltroPesquisaCargasAlertaEvento
            {
                TempoEvento = TempoLimite,
                TipoAlertaCarga = tipoAlerta
            };

            var consulta = this.SessionNHiBernate.CreateSQLQuery(new ConsultaCargaAlertaEvento().ObterSql(FiltroPesquisaCargasAlerta));

            consulta.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.AlertaCarga.CargaProcessarEvento)));

            return consulta.SetTimeout(7000).List<Dominio.ObjetosDeValor.Embarcador.Carga.AlertaCarga.CargaProcessarEvento>();

        }

        public IList<int> ConsultarCodigosCargasContingenciaEmissao(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaContingenciaCargaEmissao filtrosPesquisa, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            var sqlDinamico = new ConsultaContingenciaCargaEmissao().ObterSql(filtrosPesquisa, false, parametrosConsulta, true);

            var consulta = sqlDinamico.CriarSQLQuery(this.SessionNHiBernate);

            return consulta.SetTimeout(7000).List<int>();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.CargaContingenciaEmissao> ConsultarCargasContingenciaEmissao(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaContingenciaCargaEmissao filtrosPesquisa, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            var sqlDinamico = new ConsultaContingenciaCargaEmissao().ObterSql(filtrosPesquisa, false, parametrosConsulta);

            var consulta = sqlDinamico.CriarSQLQuery(this.SessionNHiBernate);

            consulta.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.CargaContingenciaEmissao)));

            return consulta.SetTimeout(7000).List<Dominio.ObjetosDeValor.Embarcador.Carga.CargaContingenciaEmissao>();
        }

        public int ContarConsultaCargasContingenciaEmissao(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaContingenciaCargaEmissao filtrosPesquisa)
        {
            var sqlDinamico = new ConsultaContingenciaCargaEmissao().ObterSql(filtrosPesquisa, true, null);

            var consulta = sqlDinamico.CriarSQLQuery(this.SessionNHiBernate);

            return consulta.SetTimeout(7000).UniqueResult<int>();
        }

        public void AtualizarContingenciaEmissao(List<int> codigosCarga, bool contingencia, int codigoUsuario)
        {
            string mensagem = contingencia ? "Liberou a emissão por contingência" : "Removeu a emissão por contingência";
            if (UnitOfWork.IsActiveTransaction())
            {
                UnitOfWork.Sessao.CreateSQLQuery(@"
                            DECLARE @UpdateCarga TABLE (
                                CAR_CODIGO int,
                                CAR_CODIGO_CARGA_EMBARCADOR varchar(60)
                            );

                            UPDATE T_CARGA
                                SET CAR_CONTINGENCIA_EMISSAO = :contingencia
                                OUTPUT inserted.CAR_CODIGO, inserted.CAR_CODIGO_CARGA_EMBARCADOR INTO @UpdateCarga (CAR_CODIGO, CAR_CODIGO_CARGA_EMBARCADOR)
                            WHERE CAR_CODIGO in (:codigosCarga);


                            INSERT INTO T_HISTORICO_OBJETO
                            (HIO_OBJETO, HIO_CODIGO_OBJETO, HIO_ACAO, HIO_DATA, FUN_CODIGO, HIO_DESCRICAO_ACAO, HIO_DESCRICAO, HIO_TIPO_AUDITADO, INT_CODIGO, HIO_IP, HIO_ORIGEM_AUDITADO, HIO_USER_MULTISOFTWARE)
                            select 'Carga', CAR_CODIGO, 1, getdate(), :codigoUsuario, :mensagem, CAR_CODIGO_CARGA_EMBARCADOR, 1, null, null, 0, null FROM @UpdateCarga;
                        ")
                        .SetParameterList("codigosCarga", codigosCarga)
                        .SetBoolean("contingencia", contingencia)
                        .SetString("mensagem", mensagem)
                        .SetInt32("codigoUsuario", codigoUsuario)
                        .ExecuteUpdate();
            }
            else
            {
                try
                {
                    UnitOfWork.Start();
                    UnitOfWork.Sessao.CreateSQLQuery(@"
                            DECLARE @UpdateCarga TABLE (
                                CAR_CODIGO int,
                                CAR_CODIGO_CARGA_EMBARCADOR varchar(60)
                            );

                            UPDATE T_CARGA
                                SET CAR_CONTINGENCIA_EMISSAO = :contingencia
                                OUTPUT inserted.CAR_CODIGO, inserted.CAR_CODIGO_CARGA_EMBARCADOR INTO @UpdateCarga (CAR_CODIGO, CAR_CODIGO_CARGA_EMBARCADOR)
                            WHERE CAR_CODIGO in (:codigosCarga);


                            INSERT INTO T_HISTORICO_OBJETO
                            (HIO_OBJETO, HIO_CODIGO_OBJETO, HIO_ACAO, HIO_DATA, FUN_CODIGO, HIO_DESCRICAO_ACAO, HIO_DESCRICAO, HIO_TIPO_AUDITADO, INT_CODIGO, HIO_IP, HIO_ORIGEM_AUDITADO, HIO_USER_MULTISOFTWARE)
                            select 'Carga', CAR_CODIGO, 1, getdate(), :codigoUsuario, :mensagem, CAR_CODIGO_CARGA_EMBARCADOR, 1, null, null, 0, null FROM @UpdateCarga;
                        ")
                            .SetParameterList("codigosCarga", codigosCarga)
                            .SetBoolean("contingencia", contingencia)
                            .SetString("mensagem", mensagem)
                            .SetInt32("codigoUsuario", codigoUsuario)
                            .ExecuteUpdate();

                    UnitOfWork.CommitChanges();
                }
                catch
                {
                    UnitOfWork.Rollback();
                    throw;
                }
            }
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarCargasLiberadasGuarita(string codigoCargaEmbarcador, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoGuarita> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoGuarita>();
            query = query.Where(c => c.Situacao == SituacaoCargaGuarita.Liberada);

            if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                query = query.Where(obj => obj.Carga.CodigoCargaEmbarcador == codigoCargaEmbarcador);

            return query.Select(obj => obj.Carga)
            .OrderBy(propOrdenacao + (dirOrdenacao == "asc" ? " ascending" : " descending"))
            .Skip(inicioRegistros)
            .Take(maximoRegistros)
            .ToList();
        }

        public int ContarConsultaCargasLiberadasGuarita(string codigoCargaEmbarcador)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoGuarita> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoGuarita>();
            query = query.Where(c => c.Situacao == SituacaoCargaGuarita.Liberada);

            if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                query = query.Where(obj => obj.Carga.CodigoCargaEmbarcador == codigoCargaEmbarcador);

            return query.Count();
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarPendetes(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCarga filtrosPesquisa)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(c => c.SituacaoCarga == SituacaoCarga.CalculoFrete
                                    && c.CalculandoFrete == false
                                    && c.CalcularFreteLote != Dominio.Enumeradores.LoteCalculoFrete.Reprocessamento
                                    && !c.IntegrandoValePedagio
                                    && c.CargaFechada);

            if (filtrosPesquisa.DataInicial.HasValue)
                query = query.Where(o => o.DataCriacaoCarga.Date >= filtrosPesquisa.DataInicial.Value);

            if (filtrosPesquisa.DataFinal.HasValue)
                query = query.Where(o => o.DataCriacaoCarga.Date <= filtrosPesquisa.DataFinal.Value);

            if (filtrosPesquisa.CodigosFilial?.Count > 0)
                query = query.Where(o => filtrosPesquisa.CodigosFilial.Contains(o.Filial.Codigo));

            if (filtrosPesquisa.CodigosTipoOperacao?.Count > 0)
                query = query.Where(o => filtrosPesquisa.CodigosTipoOperacao.Contains(o.TipoOperacao.Codigo));

            if (!string.IsNullOrEmpty(filtrosPesquisa.CodigoCargaEmbarcador))
                query = query.Where(obj => obj.CodigoCargaEmbarcador == filtrosPesquisa.CodigoCargaEmbarcador);

            if (filtrosPesquisa.CodigosTransportador?.Count > 0)
                query = query.Where(o => filtrosPesquisa.CodigosTransportador.Contains(o.Empresa.Codigo));

            return query;
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasFretePendente(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCarga filtrosPesquisa, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            var consulta = ConsultarPendetes(filtrosPesquisa);
            return ObterLista(consulta, parametrosConsulta);

            //query = query.OrderByDescending(o => o.Codigo).Skip(parametrosConsulta.InicioRegistros);

            //if (parametrosConsulta.LimiteRegistros > 0)
            //    query = query.Take(parametrosConsulta.LimiteRegistros);

        }

        public int ContarCargasFretePendente(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCarga filtrosPesquisa)
        {
            var consulta = ConsultarPendetes(filtrosPesquisa);
            return consulta.Count();

            //IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            //query = query.Where(c => c.SituacaoCarga == SituacaoCarga.CalculoFrete && c.CalculandoFrete == false && c.CalcularFreteLote != Dominio.Enumeradores.LoteCalculoFrete.Reprocessamento &&
            //!c.IntegrandoValePedagio && c.CargaFechada);

            //if (filtrosPesquisa.DataInicial.HasValue)
            //    query = query.Where(o => o.DataCriacaoCarga.Date >= filtrosPesquisa.DataInicial.Value);

            //if (filtrosPesquisa.DataFinal.HasValue)
            //    query = query.Where(o => o.DataCriacaoCarga.Date <= filtrosPesquisa.DataFinal.Value);

            //if (filtrosPesquisa.CodigosFilial?.Count > 0)
            //    query = query.Where(o => filtrosPesquisa.CodigosFilial.Contains(o.Filial.Codigo));

            //if (filtrosPesquisa.CodigosTipoOperacao?.Count > 0)
            //    query = query.Where(o => filtrosPesquisa.CodigosTipoOperacao.Contains(o.TipoOperacao.Codigo));

            //if (!string.IsNullOrEmpty(filtrosPesquisa.CodigoCargaEmbarcador))
            //    query = query.Where(obj => obj.CodigoCargaEmbarcador == filtrosPesquisa.CodigoCargaEmbarcador);

            //if (filtrosPesquisa.CodigosTransportador?.Count > 0)
            //    query = query.Where(o => filtrosPesquisa.CodigosTransportador.Contains(o.Empresa.Codigo));
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.TorreControle.CardAcompanhamentoCarga.Carga> ConsultarCargasAcompanhamentoCargaPorListaCarga(List<int> codigoscarga)
        {
            var sql = @"select [CodigoCarga]
                              ,[CargaEmbarcador]
                              ,[DataCriacaoCarga]
                              ,[DataPrevisaoTerminoCarga]
                              ,[DataInicioViagem]
                              ,[DataInicioViagemPrevista]
                              ,[DataCarregamentoCarga]
                              ,[DataFimViagem]
                              ,[SituacaoCarga]
                              ,[CargaFechada]
                              ,[CodigoAnalistaResponsavel]
                              ,[NomeAnalistaResponsavel]
                              ,[CodigoTipoOperacao]
                              ,[TipoOperacao]
                              ,[PesoTotalCarga]
                              ,[Origens]
                              ,[Destinos]
                              ,[DistanciaPlanejada]
                              ,[DataFimViagemPrevista]
                              ,[DataPrevisaoChegadaPlanta]
                              ,[Veiculo]
                              ,[CodigoTransportador]
                              ,[NomeTransportador]
                              ,[CodigoFilial]
                              ,[Filial]
                              ,[VeiculoTracao]
                              ,[Rastreador]
                              ,[VersaoAPP]
                              ,[Reboques]
                              ,[Motoristas]
                              ,[NumeroMotorista]
                              ,[DadosMonitoramento]
                              ,[DadosAlerta]
                              ,[DadosEntregas]
                              ,[DataAlerta]
                              ,[PossuiAlertaAberto] 
                              ,[PossuiAlertaEmTratativa] 
                              ,[CargaFixadaControleCargas]
                              ,[GrupoTipoOperacaoCodigo]
                              ,[GrupoTipoOperacaoDescricao]
                              ,[GrupoTipoOperacaoCor]
                              ,[StatusLoger]
                              ,[CodigoCargaEspelhadaComMonitoramentoAtivo]
                              ,[DataAgendamentoPedido]
                              ,[DataCarregamentoPedido]
                              ,[NumeroPedidoCliente]
                              ,[EscritorioVendasComplementar]
                              ,[MatrizComplementar]
                              ,[CargaTransbordo] from VIEW_ACOMPANHAMENTO_CARGA_NEW";
            sql += $" WHERE CodigoCarga in ({string.Join(", ", codigoscarga)} )";

            var consulta = this.SessionNHiBernate.CreateSQLQuery(sql);

            consulta.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.TorreControle.CardAcompanhamentoCarga.Carga)));

            return consulta.SetTimeout(600).List<Dominio.ObjetosDeValor.Embarcador.TorreControle.CardAcompanhamentoCarga.Carga>();
        }

        public Dominio.ObjetosDeValor.Embarcador.TorreControle.CardAcompanhamentoCarga.Carga ConsultarCargasAcompanhamentoCargaPorCarga(int codigocarga)
        {
            var sql = @"select [CodigoCarga]
                              ,[CargaEmbarcador]
                              ,[DataCriacaoCarga]
                              ,[DataPrevisaoTerminoCarga]
                              ,[DataInicioViagem]
                              ,[DataInicioViagemPrevista]
                              ,[DataCarregamentoCarga]
                              ,[DataFimViagem]
                              ,[SituacaoCarga]
                              ,[CargaFechada]
                              ,[CodigoAnalistaResponsavel]
                              ,[NomeAnalistaResponsavel]
                              ,[CodigoTipoOperacao]
                              ,[TipoOperacao]
                              ,[PesoTotalCarga]
                              ,[Origens]
                              ,[Destinos]
                              ,[DistanciaPlanejada]
                              ,[DataFimViagemPrevista]
                              ,[DataPrevisaoChegadaPlanta]
                              ,[Veiculo]
                              ,[CodigoTransportador]
                              ,[NomeTransportador]
                              ,[CodigoFilial]
                              ,[Filial]
                              ,[VeiculoTracao]
                              ,[Rastreador]
                              ,[VersaoAPP]
                              ,[Reboques]
                              ,[Motoristas]
                              ,[NumeroMotorista]
                              ,[DadosMonitoramento]
                              ,[DadosAlerta]
                              ,[DadosEntregas]
                              ,[DataAlerta]
                              ,[PossuiAlertaAberto] 
                              ,[PossuiAlertaEmTratativa] 
                              ,[CargaFixadaControleCargas]
                              ,[GrupoTipoOperacaoCodigo]
                              ,[GrupoTipoOperacaoDescricao]
                              ,[GrupoTipoOperacaoCor]
                              ,[StatusLoger]
                              ,[CodigoCargaEspelhadaComMonitoramentoAtivo]
                              ,[DataPreViagemInicio]
                              ,[DataPreViagemFim]
                              ,[HabilitarPreViagemTrizy]
                              ,[DataAgendamentoPedido]
                              ,[DataCarregamentoPedido]
                              ,[NumeroPedidoCliente]
                              ,[EscritorioVendasComplementar]
                              ,[MatrizComplementar]
                              ,[CargaTransbordo] from VIEW_ACOMPANHAMENTO_CARGA_NEW";
            sql += " WHERE CodigoCarga = " + codigocarga;

            var consulta = this.SessionNHiBernate.CreateSQLQuery(sql);

            consulta.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.TorreControle.CardAcompanhamentoCarga.Carga)));

            return consulta.SetTimeout(600).List<Dominio.ObjetosDeValor.Embarcador.TorreControle.CardAcompanhamentoCarga.Carga>().FirstOrDefault();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.TorreControle.CardAcompanhamentoCarga.Carga> ConsultarCargasAcompanhamentoCarga(Dominio.ObjetosDeValor.Embarcador.TorreControle.FiltroPesquisaAcompanhamentoCarga filtrosPesquisa, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            string filtro = GetFiltroAcompanhamentoCarga(filtrosPesquisa);

            var sql = @"select [CodigoCarga]
                              ,[CargaEmbarcador]
                              ,[DataCriacaoCarga]
                              ,[DataPrevisaoTerminoCarga]
                              ,[DataInicioViagem]
                              ,[DataInicioViagemPrevista]
                              ,[DataCarregamentoCarga]
                              ,[DataFimViagem]
                              ,[SituacaoCarga]
                              ,[CargaFechada]
                              ,[CodigoAnalistaResponsavel]
                              ,[TempoCarregamento]
                              ,[NomeAnalistaResponsavel]
                              ,[CodigoTipoOperacao]
                              ,[TipoOperacao]
                              ,[TipoModal]
                              ,[PesoTotalCarga]
                              ,[Origens]
                              ,[Destinos]
                              ,[DistanciaPlanejada]
                              ,[DataFimViagemPrevista]
                              ,[DataPrevisaoChegadaPlanta]
                              ,[Veiculo]
                              ,[CodigoTransportador]
                              ,[NomeTransportador]
                              ,[CodigoFilial]
                              ,[Filial]
                              ,[VeiculoTracao]
                              ,[Rastreador]
                              ,[VersaoAPP]
                              ,[Reboques]
                              ,[Motoristas]
                              ,[NumeroMotorista]
                              ,[DadosMonitoramento]
                              ,[DadosAlerta]
                              ,[DadosEntregas]
                              ,[DataAlerta] 
                              ,[PossuiAlertaAberto] 
                              ,[PossuiAlertaEmTratativa] 
                              ,[CargaFixadaControleCargas]
                              ,[GrupoTipoOperacaoCodigo]
                              ,[GrupoTipoOperacaoDescricao]
                              ,[GrupoTipoOperacaoCor]
                              ,[StatusLoger]                              
                              ,[CargaTransbordo]
                              ,[NumeroFrotaReboques]
                              ,[DataPreViagemInicio]
                              ,[DataPreViagemFim]
                              ,[HabilitarPreViagemTrizy]
                              ,[AnotacoesCard]
                              ,[MaiorPrioridadeAlerta]
                              ,[CodigoCargaEspelhadaComMonitoramentoAtivo]
                              ,[DataAgendamentoPedido]
                              ,[DataCarregamentoPedido]
                              ,[NumeroPedidoCliente]
                              ,[EscritorioVendasComplementar]
                              ,[MatrizComplementar]
                              ,[TipoModalTransporte]
                              ,[CanalVenda]  
                              ,[InicioDeViagemNoRaio]
                              ,[CodigoRastreador]
                              ,[Mesoregiao]
                              ,[Regiao]
                              ,[UtilizaAppTrizy]
                              from [VIEW_ACOMPANHAMENTO_CARGA_NEW]";
            sql += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE

            if (filtrosPesquisa.CodigosMotorista?.Count > 0)
            {
                sql += $" and CodigoCarga in ( " +
                    $"  select  motoristas.CAR_CODIGO from  T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO " +
                    $"  and ( usuario.FUN_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosMotorista)} )))";
            }

            if (filtrosPesquisa.ExibirSomenteCargasMotoristaMobile)
                sql += @" and CodigoCarga in (select  motoristas.CAR_CODIGO from T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario 
                            where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO
						    and ( usuario.FUN_CODIGO_MOBILE > 0))";

            if (parametrosConsulta != null)
            {
                if (filtrosPesquisa.PropriedadeOrdenacaoCargasAcompanhamentoCarga == OpcoesOrdenacaoCardsAcompanhamentoCarga.DataCarregamentoCarga)
                    sql = sql + $"  order by CargaFixadaControleCargas desc, PossuiAlertaAberto desc,  IIF(DataCarregamentoCarga is null, 999999999, DATEDIFF(minute, GETDATE(),DataCarregamentoCarga )) asc, MensagemLida asc, CodigoCarga asc";
                else
                    sql = sql + $"  order by CargaFixadaControleCargas desc, PossuiAlertaAberto desc, MensagemLida asc, DataCriacaoCarga asc, CodigoCarga asc";

                if ((parametrosConsulta.InicioRegistros > 0) || (parametrosConsulta.LimiteRegistros > 0))
                    sql = sql + $" offset {parametrosConsulta.InicioRegistros} rows fetch next {parametrosConsulta.LimiteRegistros} rows only;";
            }

            var consulta = this.SessionNHiBernate.CreateSQLQuery(sql);

            consulta.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.TorreControle.CardAcompanhamentoCarga.Carga)));

            return consulta.SetTimeout(600).List<Dominio.ObjetosDeValor.Embarcador.TorreControle.CardAcompanhamentoCarga.Carga>();
        }

        public int ContarCargasAcompanhamentoCarga(Dominio.ObjetosDeValor.Embarcador.TorreControle.FiltroPesquisaAcompanhamentoCarga filtrosPesquisa)
        {
            string filtro = GetFiltroAcompanhamentoCarga(filtrosPesquisa);

            var sql = "select count(1) from VIEW_ACOMPANHAMENTO_CARGA_NEW";
            sql += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE

            if (filtrosPesquisa.CodigosMotorista?.Count > 0)
            {
                sql += $" and CodigoCarga in ( " +
                    $"  select  motoristas.CAR_CODIGO from  T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO " +
                    $"  and ( usuario.FUN_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosMotorista)} )))"; // SQL-INJECTION-SAFE
            }

            var consulta = this.SessionNHiBernate.CreateSQLQuery(sql);
            return consulta.SetTimeout(600).UniqueResult<int>();
        }

        public dynamic ContarResumoCargasAcompanhamentoCarga(Dominio.ObjetosDeValor.Embarcador.TorreControle.FiltroPesquisaAcompanhamentoCarga filtrosPesquisa)
        {
            string filtro = GetFiltroAcompanhamentoCarga(filtrosPesquisa, false);

            var sql = "select count(1) from VIEW_ACOMPANHAMENTO_CARGA_NEW";
            sql += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE

            if (filtrosPesquisa.CodigosMotorista?.Count > 0)
            {
                sql += $" and CodigoCarga in ( " +
                    $"  select  motoristas.CAR_CODIGO from  T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO " +
                    $"  and ( usuario.FUN_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosMotorista)} )))"; // SQL-INJECTION-SAFE
            }

            var consulta = this.SessionNHiBernate.CreateSQLQuery(sql);
            int totaisCargas = consulta.SetTimeout(600).UniqueResult<int>();

            int totaisCargasEmViagem = 0;
            if (filtrosPesquisa.StatusViagem?.Count() > 0 && !filtrosPesquisa.StatusViagem.Contains(StatusViagemControleEntrega.Finalizada) && !filtrosPesquisa.StatusViagem.Contains(StatusViagemControleEntrega.NaoIniciada))
            {
                var sql2 = "select count(1) from VIEW_ACOMPANHAMENTO_CARGA_NEW";
                sql2 += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro + " AND DataInicioViagem is not null and DataFimViagem is null" : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE

                if (filtrosPesquisa.CodigosMotorista?.Count > 0)
                {
                    sql2 += $" and CodigoCarga in ( " +
                        $"  select  motoristas.CAR_CODIGO from  T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO " +
                        $"  and ( usuario.FUN_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosMotorista)} )))"; // SQL-INJECTION-SAFE
                }

                var consulta2 = this.SessionNHiBernate.CreateSQLQuery(sql2);
                totaisCargasEmViagem = consulta2.SetTimeout(600).UniqueResult<int>();
            }

            int totaisCargasNaoIniciadas = 0;
            if (filtrosPesquisa.StatusViagem?.Count() > 0 && !filtrosPesquisa.StatusViagem.Contains(StatusViagemControleEntrega.EmAndamento) && !filtrosPesquisa.StatusViagem.Contains(StatusViagemControleEntrega.Iniciada))
            {
                var sqlnaoIniciada = "select count(1) from VIEW_ACOMPANHAMENTO_CARGA_NEW";
                sqlnaoIniciada += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro + " AND DataInicioViagem is null " : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE

                if (filtrosPesquisa.CodigosMotorista?.Count > 0)
                {
                    sqlnaoIniciada += $" and CodigoCarga in ( " +
                        $"  select  motoristas.CAR_CODIGO from  T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO " +
                        $"  and ( usuario.FUN_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosMotorista)} )))"; // SQL-INJECTION-SAFE
                }

                var consultanaoIniciada = this.SessionNHiBernate.CreateSQLQuery(sqlnaoIniciada);
                totaisCargasNaoIniciadas = consultanaoIniciada.SetTimeout(600).UniqueResult<int>();
            }

            int totaisCargasFinalizadas = 0;
            if (filtrosPesquisa.StatusViagem?.Count() > 0 && !filtrosPesquisa.StatusViagem.Contains(StatusViagemControleEntrega.EmAndamento) && !filtrosPesquisa.StatusViagem.Contains(StatusViagemControleEntrega.Iniciada) && !filtrosPesquisa.StatusViagem.Contains(StatusViagemControleEntrega.NaoFinalizada) && !filtrosPesquisa.StatusViagem.Contains(StatusViagemControleEntrega.NaoIniciada))
            {
                var sql3 = "select count(1) from VIEW_ACOMPANHAMENTO_CARGA_NEW";
                sql3 += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro + " AND DataInicioViagem is not null and DataFimViagem is not null" : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE

                if (filtrosPesquisa.CodigosMotorista?.Count > 0)
                {
                    sql3 += $" and CodigoCarga in ( " +
                        $"  select  motoristas.CAR_CODIGO from  T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO " +
                        $"  and ( usuario.FUN_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosMotorista)} )))"; // SQL-INJECTION-SAFE
                }
                var consulta3 = this.SessionNHiBernate.CreateSQLQuery(sql3);
                totaisCargasFinalizadas = consulta3.SetTimeout(600).UniqueResult<int>();

            }

            if (filtrosPesquisa.StatusViagem?.Count() <= 0)
            {
                var sql2 = "select count(1) from VIEW_ACOMPANHAMENTO_CARGA_NEW";
                sql2 += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro + " AND DataInicioViagem is not null and DataFimViagem is null" : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE

                if (filtrosPesquisa.CodigosMotorista?.Count > 0)
                {
                    sql2 += $" and CodigoCarga in ( " +
                        $"  select  motoristas.CAR_CODIGO from  T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO " +
                        $"  and ( usuario.FUN_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosMotorista)} )))"; // SQL-INJECTION-SAFE
                }

                var consulta2 = this.SessionNHiBernate.CreateSQLQuery(sql2);
                totaisCargasEmViagem = consulta2.SetTimeout(600).UniqueResult<int>();

                var sql3 = "select count(1) from VIEW_ACOMPANHAMENTO_CARGA_NEW";
                sql3 += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro + " AND DataInicioViagem is not null and DataFimViagem is not null" : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE

                if (filtrosPesquisa.CodigosMotorista?.Count > 0)
                {
                    sql3 += $" and CodigoCarga in ( " +
                        $"  select  motoristas.CAR_CODIGO from  T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO " +
                        $"  and ( usuario.FUN_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosMotorista)} )))"; // SQL-INJECTION-SAFE
                }
                var consulta3 = this.SessionNHiBernate.CreateSQLQuery(sql3);
                totaisCargasFinalizadas = consulta3.SetTimeout(600).UniqueResult<int>();

                var sqlnaoIniciada = "select count(1) from VIEW_ACOMPANHAMENTO_CARGA_NEW";
                sqlnaoIniciada += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro + " AND DataInicioViagem is null " : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE

                if (filtrosPesquisa.CodigosMotorista?.Count > 0)
                {
                    sqlnaoIniciada += $" and CodigoCarga in ( " +
                        $"  select  motoristas.CAR_CODIGO from  T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO " +
                        $"  and ( usuario.FUN_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosMotorista)} )))"; // SQL-INJECTION-SAFE
                }

                var consultanaoIniciada = this.SessionNHiBernate.CreateSQLQuery(sqlnaoIniciada);
                totaisCargasNaoIniciadas = consultanaoIniciada.SetTimeout(600).UniqueResult<int>();
            }

            int quantidadeChamadosPendentes = QuantidadeChamados(filtro, Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Pendente, filtrosPesquisa);
            int quantidadeChamadosTratativa = QuantidadeChamados(filtro, Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Tratativa, filtrosPesquisa);
            int quantidadeChamadosAtrasados = QuantidadeChamados(filtro, Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Atrasada, filtrosPesquisa);
            int quantidadeChamadosConcluidos = QuantidadeChamados(filtro, Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Concluida, filtrosPesquisa);
            int quantidadeAlertasEmAberto = ConsultarQuantidadeCargasComAlertasEmAberto(filtro);
            int quantidadeAlertasEmTratativa = ConsultarQuantidadeCargasComAlertasEmTratativa(filtro);
            int quantidadeCargasSemAlerta = ConsultarQuantidadeCargasSemAlertas(filtro);
            int quantidadeTendenciaEntregaNenhum = ConsultarTendenciaEntrega(filtro, Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroTendenciaEntrega.Nenhum, filtrosPesquisa);
            int quantidadeTendenciaEntregaAdiantado = ConsultarTendenciaEntrega(filtro, Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroTendenciaEntrega.Adiantado, filtrosPesquisa);
            int quantidadeTendenciaEntregaNoPrazo = ConsultarTendenciaEntrega(filtro, Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroTendenciaEntrega.NoPrazo, filtrosPesquisa);
            int quantidadeTendenciaEntregaAtrasado = ConsultarTendenciaEntrega(filtro, Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroTendenciaEntrega.Atrasado, filtrosPesquisa);
            int quantidadeFarolEspelhamentoOnline = ConsultarFarolEspelhamento(filtro, Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroFarolEspelhamento.Online, filtrosPesquisa);
            int quantidadeFarolEspelhamentoOffline = ConsultarFarolEspelhamento(filtro, Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroFarolEspelhamento.Offline, filtrosPesquisa);

            return new
            {
                TotalCargas = totaisCargas,
                TotalCargasNaoIniciadas = totaisCargasNaoIniciadas,
                TotalCargasEmViagem = totaisCargasEmViagem,
                TotalCargasFinalizadas = totaisCargasFinalizadas,
                TotaisChamadosPendentes = quantidadeChamadosPendentes,
                TotaisChamadosTratativa = quantidadeChamadosTratativa,
                TotaisChamadoAtrasados = quantidadeChamadosAtrasados,
                TotaisChamadosConcluidos = quantidadeChamadosConcluidos,
                TotalCargasComAlertas = quantidadeAlertasEmAberto,
                TotalCargasComAlertasEmTratativa = quantidadeAlertasEmTratativa,
                TotalCargasSemAlertas = quantidadeCargasSemAlerta,
                TotalTendenciaEntregaNenhum = quantidadeTendenciaEntregaNenhum,
                TotalTendenciaEntregaAdiantado = quantidadeTendenciaEntregaAdiantado,
                TotalTendenciaEntregaNoPrazo = quantidadeTendenciaEntregaNoPrazo,
                TotalTendenciaEntregaAtrasado = quantidadeTendenciaEntregaAtrasado,
                TotalFarolEspelhamentoOnline = quantidadeFarolEspelhamentoOnline,
                TotalFarolEspelhamentoOffline = quantidadeFarolEspelhamentoOffline,
            };

        }

        private int ConsultarFarolEspelhamento(string filtro, Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroFarolEspelhamento tipoFiltro, Dominio.ObjetosDeValor.Embarcador.TorreControle.FiltroPesquisaAcompanhamentoCarga filtrosPesquisa)
        {
            var sqlFarolEspelhameto = "select count(1) from VIEW_ACOMPANHAMENTO_CARGA_NEW";

            sqlFarolEspelhameto += !string.IsNullOrWhiteSpace(filtro)
                ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro  // SQL-INJECTION-VULNERABLE
                : " where 1 + 1 ";


            if (filtrosPesquisa.CodigosMotorista?.Count > 0)
            {
                sqlFarolEspelhameto += $@" and CodigoCarga in ( 
                      select  motoristas.CAR_CODIGO from  T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO 
                      and ( usuario.FUN_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosMotorista)} )))";
            }

            var dataDia = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss.fff");
            sqlFarolEspelhameto += $@"
                                    AND (SELECT TOP 1 
                                        CASE 
                                            WHEN POSICAO.POS_DATA_VEICULO IS NOT NULL 
                                                 AND DATEDIFF(MINUTE, POSICAO.POS_DATA_VEICULO, '{dataDia}') <= EMBARCADOR.CEM_TEMPO_SEM_POSICAO_PARA_VEICULO_PERDER_SINAL
                                            THEN 1
                                            ELSE 0
                                        END AS ONLINE
                                    FROM T_MONITORAMENTO MONITORAMENTO
                                    LEFT JOIN T_POSICAO AS POSICAO 
                                        ON POSICAO.POS_CODIGO = MONITORAMENTO.POS_ULTIMA_POSICAO 
                                    LEFT JOIN (
                                        SELECT TOP 1 CEM_TEMPO_SEM_POSICAO_PARA_VEICULO_PERDER_SINAL 
                                        FROM T_CONFIGURACAO_EMBARCADOR
                                    ) AS EMBARCADOR 
                                        ON 1 = 1
                                    WHERE MONITORAMENTO.CAR_CODIGO = CodigoCarga) = {(int)tipoFiltro}";

            var consulta = this.SessionNHiBernate.CreateSQLQuery(sqlFarolEspelhameto);
            return consulta.SetTimeout(600).UniqueResult<int>();
        }

        private int ConsultarTendenciaEntrega(string filtro, Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroTendenciaEntrega tipoFiltro, Dominio.ObjetosDeValor.Embarcador.TorreControle.FiltroPesquisaAcompanhamentoCarga filtrosPesquisa)
        {
            var sqlTendencia = "select count(1) from VIEW_ACOMPANHAMENTO_CARGA_NEW";

            sqlTendencia += !string.IsNullOrWhiteSpace(filtro)
                ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro // SQL-INJECTION-VULNERABLE
                : " where 1 + 1 ";

            if (filtrosPesquisa.CodigosMotorista?.Count > 0)
            {
                sqlTendencia += $@" and CodigoCarga in ( 
                      select  motoristas.CAR_CODIGO from  T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO 
                      and ( usuario.FUN_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosMotorista)} )))";
            }

            sqlTendencia += $@" AND COALESCE((
                        SELECT TOP 1 cargaEntrega.CEN_TENDENCIA FROM t_carga_entrega cargaEntrega 
                        WHERE cargaEntrega.CAR_CODIGO = CodigoCarga 
                          AND cargaEntrega.CEN_SITUACAO != 2 
                        ORDER BY cargaEntrega.CEN_ORDEM
                   ), (
                        SELECT TOP 1 cargaEntrega.CEN_TENDENCIA FROM t_carga_entrega cargaEntrega 
                        WHERE cargaEntrega.CAR_CODIGO = CodigoCarga 
                          AND cargaEntrega.CEN_SITUACAO = 2 
                        ORDER BY cargaEntrega.CEN_ORDEM DESC
                   )) = {(int)tipoFiltro}";

            var consulta = this.SessionNHiBernate.CreateSQLQuery(sqlTendencia);
            return consulta.SetTimeout(600).UniqueResult<int>();
        }


        private int QuantidadeChamados(string filtro, Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento tipoFiltro, Dominio.ObjetosDeValor.Embarcador.TorreControle.FiltroPesquisaAcompanhamentoCarga filtrosPesquisa)
        {
            if (tipoFiltro == Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Pendente)
            {
                var sqlchamadosPendentes = "select sum(chamadosPendentes) from VIEW_ACOMPANHAMENTO_CARGA_NEW";
                sqlchamadosPendentes += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE

                if (filtrosPesquisa.CodigosMotorista?.Count > 0)
                {
                    sqlchamadosPendentes += $" and CodigoCarga in ( " +
                        $"  select  motoristas.CAR_CODIGO from  T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO " +
                        $"  and ( usuario.FUN_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosMotorista)} )))"; // SQL-INJECTION-SAFE
                }

                sqlchamadosPendentes += $" and CodigoCarga in ( " +
                        $"  select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega inner join t_chamados chamado on chamado.CAR_CODIGO = cargaEntrega.CAR_CODIGO  where chamado.FUN_RESPONSAVEL is null)";

                var consulta = this.SessionNHiBernate.CreateSQLQuery(sqlchamadosPendentes);
                return consulta.SetTimeout(600).UniqueResult<int>();
            }
            else if (tipoFiltro == Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Tratativa)
            {
                var sqlchamadosTratativa = "select sum(chamadosEmtratativa) from VIEW_ACOMPANHAMENTO_CARGA_NEW";
                sqlchamadosTratativa += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE

                if (filtrosPesquisa.CodigosMotorista?.Count > 0)
                {
                    sqlchamadosTratativa += $" and CodigoCarga in ( " +
                        $"  select  motoristas.CAR_CODIGO from  T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO " +
                        $"  and ( usuario.FUN_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosMotorista)} )))"; // SQL-INJECTION-SAFE
                }

                sqlchamadosTratativa += $" and CodigoCarga in ( " +
                        $"  select chamado.CAR_CODIGO from T_CHAMADOS chamado where (chamado.FUN_RESPONSAVEL is not null or chamado.SET_RESPONSAVEL is not null) AND chamado.CHA_SITUACAO = {(int)Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoChamado.Aberto} and CodigoCarga = chamado.CAR_CODIGO)"; // SQL-INJECTION-SAFE

                var consulta = this.SessionNHiBernate.CreateSQLQuery(sqlchamadosTratativa);
                return consulta.SetTimeout(600).UniqueResult<int>();
            }
            else if (tipoFiltro == Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Atrasada)
            {
                var sqlchamadosAtrasados = "select sum(chamadosAtrasados) from VIEW_ACOMPANHAMENTO_CARGA_NEW";
                sqlchamadosAtrasados += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE

                if (filtrosPesquisa.CodigosMotorista?.Count > 0)
                {
                    sqlchamadosAtrasados += $" and CodigoCarga in ( " +
                        $"  select  motoristas.CAR_CODIGO from  T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO " +
                        $"  and ( usuario.FUN_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosMotorista)} )))"; // SQL-INJECTION-SAFE
                }

                sqlchamadosAtrasados += $" and CodigoCarga in ( " +
                        $"  select chamado.CAR_CODIGO from T_CHAMADOS chamado inner join T_NIVEL_ATENDIMENTO nivel on nivel.CHA_CODIGO = chamado.CHA_CODIGO where (chamado.FUN_RESPONSAVEL is not null or chamado.SET_RESPONSAVEL is not null) AND chamado.CHA_SITUACAO != {(int)Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoChamado.Finalizado} AND chamado.CHA_SITUACAO != {(int)Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoChamado.Cancelada} AND convert(datetime, '{DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")}', 102) > nivel.NAT_DATA_LIMITE and CodigoCarga = chamado.CAR_CODIGO)"; // SQL-INJECTION-SAFE

                var consulta = this.SessionNHiBernate.CreateSQLQuery(sqlchamadosAtrasados);
                return consulta.SetTimeout(600).UniqueResult<int>();

            }
            else if (tipoFiltro == Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Concluida)
            {
                var sqlchamadosConcluidos = "select sum(chamadosConcluidos) from VIEW_ACOMPANHAMENTO_CARGA_NEW";
                sqlchamadosConcluidos += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE

                if (filtrosPesquisa.CodigosMotorista?.Count > 0)
                {
                    sqlchamadosConcluidos += $" and CodigoCarga in ( " +
                        $"  select  motoristas.CAR_CODIGO from  T_CARGA_MOTORISTA motoristas, T_FUNCIONARIO usuario where CodigoCarga = motoristas.CAR_CODIGO and motoristas.CAR_MOTORISTA = usuario.FUN_CODIGO " +
                        $"  and ( usuario.FUN_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosMotorista)} )))"; // SQL-INJECTION-SAFE
                }

                sqlchamadosConcluidos += $" and CodigoCarga in ( " +
                        $"  select chamado.CAR_CODIGO from T_CHAMADOS chamado where chamado.CHA_SITUACAO = {(int)SituacaoChamado.Finalizado} and CodigoCarga = chamado.CAR_CODIGO)"; // SQL-INJECTION-SAFE

                var consulta = this.SessionNHiBernate.CreateSQLQuery(sqlchamadosConcluidos);
                return consulta.SetTimeout(600).UniqueResult<int>();
            }
            else
                return 0;
        }

        private int ConsultarQuantidadeCargasComAlertasEmAberto(string filtro)
        {
            var sql = "select sum(PossuiAlertaAberto) from VIEW_ACOMPANHAMENTO_CARGA_NEW";
            sql += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE


            var consulta = this.SessionNHiBernate.CreateSQLQuery(sql);
            return consulta.SetTimeout(600).UniqueResult<int>();
        }

        private int ConsultarQuantidadeCargasComAlertasEmTratativa(string filtro)
        {
            var sql = "select sum(PossuiAlertaEmTratativa) from VIEW_ACOMPANHAMENTO_CARGA_NEW";
            sql += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE


            var consulta = this.SessionNHiBernate.CreateSQLQuery(sql);
            return consulta.SetTimeout(600).UniqueResult<int>();
        }

        private int ConsultarQuantidadeCargasSemAlertas(string filtro)
        {
            var sql = "select sum(IIF (PossuiAlertaAberto = 1 OR PossuiAlertaEmTratativa = 1, 0, 1)) from VIEW_ACOMPANHAMENTO_CARGA_NEW";
            sql += !string.IsNullOrWhiteSpace(filtro) ? " WHERE CodigoCarga in ( select distinct cargaEntrega.car_codigo from T_CARGA_ENTREGA cargaEntrega " + filtro : " where 1 + 1 "; // SQL-INJECTION-VULNERABLE


            var consulta = this.SessionNHiBernate.CreateSQLQuery(sql);
            return consulta.SetTimeout(600).UniqueResult<int>();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.TorreControle.CardAcompanhamentoCarga.Mensagens> ConsultarMensagensNaoLidasCards(int CodigoUsuario)
        {

            var sql = $@"SELECT distinct Mensagem.CAR_CODIGO AS [CodigoCarga]
						  			    ,Mensagem.FUN_REMETENTE AS [CodigoRemetente]
                                        FROM T_CHAT_MOBILE_MENSAGEM Mensagem
									    INNER JOIN T_CARGA Carga on Carga.CAR_CODIGO = Mensagem.CAR_CODIGO
    									LEFT JOIN T_FUNCIONARIO Remetente on Remetente.FUN_CODIGO = Mensagem.FUN_REMETENTE WHERE Mensagem.CMM_LIDA = 0 and Mensagem.FUN_REMETENTE <> {CodigoUsuario} ;"; // SQL-INJECTION-SAFE

            var consulta = this.SessionNHiBernate.CreateSQLQuery(sql);

            consulta.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.TorreControle.CardAcompanhamentoCarga.Mensagens)));

            return consulta.SetTimeout(600).List<Dominio.ObjetosDeValor.Embarcador.TorreControle.CardAcompanhamentoCarga.Mensagens>();
        }

        public IList<Dominio.Relatorios.Embarcador.DataSource.Planejamentos.PlanejamentoFrotaCarga> ConsultarCargasPlanejamentoFrota(Dominio.ObjetosDeValor.Embarcador.Frota.FiltroPesquisaPlanejamentoFrotaCarga filtroPesquisa, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            var consulta = this.SessionNHiBernate.CreateSQLQuery(QueryCargasPlanejamentoFrota(filtroPesquisa, false, propOrdenacao, dirOrdenacao, inicioRegistros, maximoRegistros));

            consulta.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.Relatorios.Embarcador.DataSource.Planejamentos.PlanejamentoFrotaCarga)));

            return consulta.SetTimeout(600).List<Dominio.Relatorios.Embarcador.DataSource.Planejamentos.PlanejamentoFrotaCarga>();
        }

        public int ContarConsultaCargasPlanejamentoFrota(Dominio.ObjetosDeValor.Embarcador.Frota.FiltroPesquisaPlanejamentoFrotaCarga filtroPesquisa)
        {
            var consulta = this.SessionNHiBernate.CreateSQLQuery(QueryCargasPlanejamentoFrota(filtroPesquisa, true));

            return consulta.SetTimeout(600).UniqueResult<int>();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultaCargasCanceladasCompativeis(Dominio.Entidades.Embarcador.Cargas.Carga cargaExemplo, List<double> remetentes, List<double> destinatarios, int transportador, int veiculo, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(obj => obj.SituacaoCarga == SituacaoCarga.Cancelada);

            //result = result.Where(o => o.Pedidos.Any(p => localidadeOrigens.Contains(p.Pedido.Origem.Codigo)));
            //result = result.Where(o => o.Pedidos.Any(p => localidadeDestino.Contains(p.Pedido.Destino.Codigo)));

            if (veiculo > 0)
                query = query.Where(o => o.Veiculo.Codigo == veiculo);

            if (transportador > 0)
                query = query.Where(o => o.Empresa.Codigo == transportador);

            if (remetentes.Count > 0)
            {
                var queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>()
                    .Where(obj => remetentes.Contains(obj.Pedido.Remetente.CPF_CNPJ));

                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga.Codigo == obj.Codigo));
            }

            if (destinatarios.Count > 0)
            {
                var queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>()
                    .Where(obj => destinatarios.Contains(obj.Pedido.Destinatario.CPF_CNPJ));

                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga.Codigo == obj.Codigo));
            }

            query = query.OrderByDescending(o => o.DataCriacaoCarga).Skip(parametrosConsulta.InicioRegistros);

            if (parametrosConsulta.LimiteRegistros > 0)
                query = query.Take(parametrosConsulta.LimiteRegistros);

            return query
                .Fetch(o => o.Veiculo)
                .Fetch(o => o.TipoOperacao)
                .Fetch(o => o.DadosSumarizados)
                .ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarCargasDataCarregamentoInicioMonitoramentoAutomatico(DateTime DataAtual)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(obj =>
                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada &&
                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada &&
                obj.SituacaoCarga != SituacaoCarga.Encerrada);
            query = query.Where(obj =>
                obj.Veiculo != null &&
                obj.DataCarregamentoCarga.HasValue &&
                obj.DataCarregamentoCarga.Value <= DataAtual &&
                obj.TipoOperacao != null &&
                obj.TipoOperacao.IniciarMonitoramentoAutomaticamenteDataCarregamento);

            var queryMonitoramento = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Logistica.Monitoramento>();
            query = query.Where(obj => !queryMonitoramento.Any(monitoramento => monitoramento.Carga.Codigo == obj.Codigo) ||
                queryMonitoramento.Any(monitoramento => monitoramento.Carga.Codigo == obj.Codigo && monitoramento.Status == MonitoramentoStatus.Aguardando));

            return query.Fetch(obj => obj.TipoOperacao).OrderBy(obj => obj.DataCarregamentoCarga).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasComTempoTipoDeOperacaoAlertaEmailExcedente()
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            consultaCarga = consultaCarga.Where(o => o.SituacaoCarga == SituacaoCarga.Nova
            && o.TipoOperacao.ConfiguracaoCarga.TempoParaAlertarPorEmailResponsavelDaFilialDaCargaQueAindaNaoTeveOsDadosDeTransporteInformados > 0

            && ((!o.DataEnvioEmailTipoOperacaoAvisoResponsavelFilial.HasValue && o.DataCriacaoCarga < DateTime.Now.AddHours(-o.TipoOperacao.ConfiguracaoCarga.TempoParaAlertarPorEmailResponsavelDaFilialDaCargaQueAindaNaoTeveOsDadosDeTransporteInformados))
            || (o.DataEnvioEmailTipoOperacaoAvisoResponsavelFilial.HasValue && o.DataEnvioEmailTipoOperacaoAvisoResponsavelFilial.Value < DateTime.Now.AddHours(-o.TipoOperacao.ConfiguracaoCarga.TempoParaAlertarPorEmailResponsavelDaFilialDaCargaQueAindaNaoTeveOsDadosDeTransporteInformados))
            ));

            return consultaCarga
                .Fetch(o => o.TipoOperacao)
                .Fetch(o => o.Filial)
                .ToList();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.MensagemAlertaAdicional> BuscarMensagensPedidosComPrevisaoEntregaEDestinatarioIguais(List<int> codigosCarga)
        {
            string sqlConsulta = $@"
                with CargasPrevistas (CodigoCarga, CodigoTipoOperacao, PrevisaoEntrega, Destinatario)
                as
                (
                    select Carga.CAR_CODIGO,
                           Carga.TOP_CODIGO,
                           cast(Pedido.PED_PREVISAO_ENTREGA as Date),
                           isnull(CargaPedido.CLI_CODIGO_RECEBEDOR, Pedido.CLI_CODIGO)
                      from T_CARGA Carga
                      join T_CARGA_PEDIDO CargaPedido on CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO
                      join T_PEDIDO Pedido on Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
                     where Carga.CAR_CODIGO in ({string.Join(", ", codigosCarga)})
                       and Carga.TOP_CODIGO is not null
                       and Pedido.PED_PREVISAO_ENTREGA is not null
                )
                select CargaPrevista.CodigoCarga,
                       'Existe(m) ' + cast(count(CargaPrevista.PrevisaoEntrega) as varchar(10)) + ' pedido(s) programado(s) para a mesma data de entrega na loja ' + Destinatario.CLI_NOME as Mensagem
                  from CargasPrevistas CargaPrevista
                  join T_CLIENTE Destinatario on Destinatario.CLI_CGCCPF = CargaPrevista.Destinatario
                  join T_CARGA Carga on Carga.TOP_CODIGO = CargaPrevista.CodigoTipoOperacao
                  join T_CARGA_PEDIDO CargaPedido on CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO
                  join T_PEDIDO Pedido on Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
                 where Carga.CAR_CODIGO <> CargaPrevista.CodigoCarga
                   and Carga.CAR_SITUACAO <> {(int)SituacaoCarga.Cancelada}
                   and Carga.CAR_SITUACAO <> {(int)SituacaoCarga.Anulada}
                   and isnull(CargaPedido.CLI_CODIGO_RECEBEDOR, Pedido.CLI_CODIGO) = CargaPrevista.Destinatario
                   and cast(Pedido.PED_PREVISAO_ENTREGA as Date) = CargaPrevista.PrevisaoEntrega
                 group by CargaPrevista.CodigoCarga, CargaPrevista.PrevisaoEntrega, CargaPrevista.Destinatario, Destinatario.CLI_NOME";

            var consulta = this.SessionNHiBernate.CreateSQLQuery(sqlConsulta);

            consulta.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.MensagemAlertaAdicional)));

            return consulta.SetTimeout(600).List<Dominio.ObjetosDeValor.Embarcador.Carga.MensagemAlertaAdicional>();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasPendentesEnvioEmailDocumentacao()
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query where obj.SituacaoEnvioEmailDocumentacaoCarga == SituacaoEnvioEmailDocumentacaoCarga.PendenteDeEnvio select obj;

            return result.Take(15).ToList();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarPorCodigoCargaEmbarcadorSemAgrupamento(string codigoCargaEmbarcador)
        {
            List<SituacaoCarga> situacaoesPermitidas = SituacaoCargaHelper.ObterSituacoesCargaPermiteAtualizar();
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            var result = from obj in query where obj.CodigoCargaEmbarcador.Contains(codigoCargaEmbarcador) && situacaoesPermitidas.Contains(obj.SituacaoCarga) select obj;
            return result.FirstOrDefault();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargaAgNotaPorDataCriacao(DateTime dataConsulta)
        {

            var dataLimite = dataConsulta.AddDays(-5);
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query
                         where obj.SituacaoCarga == SituacaoCarga.AgNFe && obj.DataCriacaoCarga <= dataConsulta && obj.DataCriacaoCarga > dataLimite
                         select obj;
            return result.OrderByDescending(o => o.Codigo).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasPorTipoOperacaoComCTeEmitidoEmbarcador(int tipoOperacao)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var subQueryDocumentoCte = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe>().Where(o => o.CargaPedido.Carga.TipoOperacao.Codigo == tipoOperacao).Select(o => o.CargaPedido.Carga.Codigo);
            var subQueryDocumentoMDFe = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoMDFe>().Where(o => o.CargaPedido.Carga.TipoOperacao.Codigo == tipoOperacao).Select(o => o.CargaPedido.Carga.Codigo);

            var result = from obj in query
                         where obj.TipoOperacao.Codigo == tipoOperacao && obj.Pedidos.Any(o => o.CTeEmitidoNoEmbarcador)
                            && obj.SituacaoCarga == SituacaoCarga.AgNFe && (subQueryDocumentoCte.Contains(obj.Codigo) && subQueryDocumentoMDFe.Contains(obj.Codigo))
                         select obj;

            return result.ToList();
        }

        public int BuscarCodigoGrupoProdutoDominantePorCarga(int codigoCarga)
        {
            var sql = $@"
                select CodigoGrupoProduto
                    from (
                        select
                            CargaPedido.CAR_CODIGO as CodigoCarga,
                            isnull(ProdutoEmbarcador.GRP_CODIGO, 0) as CodigoGrupoProduto,
                            row_number() OVER (PARTITION by CargaPedido.CAR_CODIGO ORDER by sum(PedidoProduto.PRP_QUANTIDADE) desc) AS Ordem
                        from
                            T_CARGA_PEDIDO CargaPedido
                        join
                            T_PEDIDO_PRODUTO PedidoProduto on PedidoProduto.PED_CODIGO = CargaPedido.PED_CODIGO
                        join
                            T_PRODUTO_EMBARCADOR ProdutoEmbarcador on ProdutoEmbarcador.PRO_CODIGO = PedidoProduto.PRO_CODIGO
                        where
                            CargaPedido.CAR_CODIGO = {codigoCarga}
                        group by
                            CargaPedido.CAR_CODIGO,
                            ProdutoEmbarcador.GRP_CODIGO
                    ) AS Subquery
                    where
                        Subquery.Ordem = 1;";

            var consultaGrupoProdutoDominante = this.SessionNHiBernate.CreateSQLQuery(sql);

            return consultaGrupoProdutoDominante.SetTimeout(600).UniqueResult<int>();
        }

        public IList<(int CodigoCarga, int CodigoGrupoProduto)> BuscarDadosGruposProdutosDominantesPorCargas(List<int> codigosCargas)
        {
            var sql = $@"
                select CodigoCarga, CodigoGrupoProduto
                    from (
                        select
                            CargaPedido.CAR_CODIGO as CodigoCarga,
                            isnull(ProdutoEmbarcador.GRP_CODIGO, 0) as CodigoGrupoProduto,
                            row_number() OVER (PARTITION by CargaPedido.CAR_CODIGO ORDER by sum(PedidoProduto.PRP_QUANTIDADE) desc) AS Ordem
                        from
                            T_CARGA_PEDIDO CargaPedido
                        join
                            T_PEDIDO_PRODUTO PedidoProduto on PedidoProduto.PED_CODIGO = CargaPedido.PED_CODIGO
                        join
                            T_PRODUTO_EMBARCADOR ProdutoEmbarcador on ProdutoEmbarcador.PRO_CODIGO = PedidoProduto.PRO_CODIGO
                        where
                            CargaPedido.CAR_CODIGO in ({string.Join(", ", codigosCargas)})
                        group by
                            CargaPedido.CAR_CODIGO,
                            ProdutoEmbarcador.GRP_CODIGO
                    ) AS Subquery
                    where
                        Subquery.Ordem = 1;";

            var consultaGrupoProdutoDominante = this.SessionNHiBernate.CreateSQLQuery(sql);

            consultaGrupoProdutoDominante.SetResultTransformer(new NHibernate.Transform.AliasToBeanConstructorResultTransformer(typeof((int CodigoCarga, int CodigoGrupoProduto)).GetConstructors().FirstOrDefault()));

            return consultaGrupoProdutoDominante.SetTimeout(600).List<(int CodigoCarga, int CodigoGrupoProduto)>();
        }

        public List<int> BuscarCodigosPorCargaAguardandoSalvarDadosTransporte()
        {
            List<SituacaoCarga> situacoesValidas = new List<SituacaoCarga>
            {
                SituacaoCarga.Nova,
                SituacaoCarga.AgNFe,
                SituacaoCarga.AgTransportador
            };

            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> carga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(cg => cg.AguardandoSalvarDadosTransporteCarga && situacoesValidas.Contains(cg.SituacaoCarga));

            return carga
                .OrderBy(o => o.Codigo)
                .Select(o => o.Codigo)
                .Take(15)
                .ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarPorCargasComAlertaViagemPendente(int minutos)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> carga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
            .Where(cg =>
                cg.JaEnviouAlertaMotoristaViagem == false &&
                 cg.DataFechamentoCarga != null &&
                  cg.DataFechamentoCarga <= DateTime.Now.AddMinutes(minutos)
            );

            return carga.ToList();
        }

        public Dominio.Entidades.Embarcador.Cargas.Carga BuscarCargaColetaPreCheckinPorCte(int codigoConhecimento)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();
            var result = from obj in query where obj.Carga.DadosSumarizados.CargaTrecho == CargaTrechoSumarizada.SubCarga && obj.Carga.TipoOperacao.ExigeNotaFiscalParaCalcularFrete == true select obj;

            if (codigoConhecimento > 0)
                result = result.Where(o => o.CTe.Codigo == codigoConhecimento);

            return result.Select(obj => obj.Carga).FirstOrDefault();
        }

        public int ContarCargasOrganizacao(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCarga filtrosPesquisa)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(cg => cg.TipoOperacao != null && cg.TipoOperacao.ConfiguracaoCarga.TipoOperacaoPreCarga);

            IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> consultaCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            if (!string.IsNullOrEmpty(filtrosPesquisa.CodigoCargaEmbarcador))
                consultaCarga = consultaCarga.Where(cg => cg.CodigoCargaEmbarcador == filtrosPesquisa.CodigoCargaEmbarcador);

            if (filtrosPesquisa.CpfCnpjDestinatario > 0)
                consultaCargaPedido = consultaCargaPedido.Where(ccp => filtrosPesquisa.CpfCnpjDestinatario == ccp.Pedido.Destinatario.CPF_CNPJ);

            if (filtrosPesquisa.CpfCnpjRemetente > 0)
                consultaCargaPedido = consultaCargaPedido.Where(ccp => filtrosPesquisa.CpfCnpjRemetente == ccp.Pedido.Remetente.CPF_CNPJ);

            if (filtrosPesquisa.CodigoOrigem > 0)
                consultaCargaPedido = consultaCargaPedido.Where(ccp => filtrosPesquisa.CodigoOrigem == ccp.Origem.Codigo);

            if (filtrosPesquisa.CodigoDestino > 0)
                consultaCargaPedido = consultaCargaPedido.Where(ccp => filtrosPesquisa.CodigoDestino == ccp.Origem.Codigo);

            consultaCarga = consultaCarga.Where(carga => consultaCargaPedido.Any(cargaPedido => cargaPedido.Carga.Codigo == carga.Codigo));

            return consultaCarga.Count();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasOrganizacao(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCarga filtrosPesquisa, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>().Where(cg => cg.TipoOperacao != null && cg.TipoOperacao.ConfiguracaoCarga.TipoOperacaoPreCarga);
            IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> consultaCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            if (!string.IsNullOrEmpty(filtrosPesquisa.CodigoCargaEmbarcador))
                consultaCarga = consultaCarga.Where(cg => cg.CodigoCargaEmbarcador == filtrosPesquisa.CodigoCargaEmbarcador);

            if (filtrosPesquisa.CpfCnpjDestinatario > 0)
                consultaCargaPedido = consultaCargaPedido.Where(ccp => filtrosPesquisa.CpfCnpjDestinatario == ccp.Pedido.Destinatario.CPF_CNPJ);

            if (filtrosPesquisa.CpfCnpjRemetente > 0)
                consultaCargaPedido = consultaCargaPedido.Where(ccp => filtrosPesquisa.CpfCnpjRemetente == ccp.Pedido.Remetente.CPF_CNPJ);

            if (filtrosPesquisa.CodigoOrigem > 0)
                consultaCargaPedido = consultaCargaPedido.Where(ccp => filtrosPesquisa.CodigoOrigem == ccp.Origem.Codigo);

            if (filtrosPesquisa.CodigoDestino > 0)
                consultaCargaPedido = consultaCargaPedido.Where(ccp => filtrosPesquisa.CodigoDestino == ccp.Origem.Codigo);

            consultaCarga = consultaCarga.Where(carga => consultaCargaPedido.Any(cargaPedido => cargaPedido.Carga.Codigo == carga.Codigo));

            return consultaCarga.OrderBy(propOrdenacao + (dirOrdenacao == "asc" ? " ascending" : " descending"))
            .Skip(inicioRegistros)
            .Take(maximoRegistros).ToList();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.CargaCargaOrganizacao> BuscarCargaCargasOrganizacao(int codigoCarga)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaCargaOrganizacao> consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCargaOrganizacao>()
                .Where(cco => cco.Carga.Codigo == codigoCarga);

            return consultaCarga.ToList();
        }

        public List<int> BuscarCargasAguardandoSalvarDadosTransporteComRegraAvancoDataCarregamento()
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            var result = query.Where(c => c.SituacaoCarga == SituacaoCarga.Nova
            && c.TipoOperacao != null
            && c.TipoOperacao.ConfiguracaoCarga != null
            && c.TipoOperacao.ConfiguracaoCarga.ManterCargaNaEtapaUmAteXHorasAntesDaDataDeCarregamento
            && c.TipoOperacao.ConfiguracaoCarga.HorasManterCargaNaEtapaUmAteXHorasAntesDaDataDeCarregamento > 0
            && queryCargaPedido.Where(p => p.Carga.Codigo == c.Codigo && p.Pedido.DataInicialColeta != null).Select(p => p.Pedido.DataInicialColeta).FirstOrDefault()
                .Value.AddHours(-c.TipoOperacao.ConfiguracaoCarga.HorasManterCargaNaEtapaUmAteXHorasAntesDaDataDeCarregamento) <= DateTime.Now
            && c.TipoDeCarga != null
            && c.ModeloVeicularCarga != null
            && c.Empresa != null
            && c.Veiculo != null);

            return result.Select(carga => carga.Codigo).ToList();
        }

        public List<Dominio.ObjetosDeValor.Embarcador.Carga.CodigoEmbarcador> BuscarCodigoEmbarcadorPorCodigosCarga(List<int> cargas)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(o => cargas.Contains(o.Codigo));

            return query.Select(o => new Dominio.ObjetosDeValor.Embarcador.Carga.CodigoEmbarcador()
            {
                CodigoCarga = o.Codigo,
                CodigoCargaEmbarcador = o.CodigoCargaEmbarcador
            }).ToList();
        }

        public bool CargaUtilizaDirecionamentoCustoExtra(int codigoCarga)
        {
            string sqlQuery = @"
                select ConfiguracaoTipoOperacaoCarga.CCG_UTILIZAR_DIRECIONAMENTO_CUSTO_EXTRA from T_CARGA Carga
                    join T_TIPO_OPERACAO TipoOperacao on Carga.TOP_CODIGO = TipoOperacao.TOP_CODIGO
                    join T_CONFIGURACAO_TIPO_OPERACAO_CARGA ConfiguracaoTipoOperacaoCarga on TipoOperacao.CCG_CODIGO = ConfiguracaoTipoOperacaoCarga.CCG_CODIGO
                where Carga.CAR_CODIGO = :codigoCarga;
            ";

            var queryResult = this.SessionNHiBernate.CreateSQLQuery(sqlQuery)
                .SetParameter("codigoCarga", codigoCarga);

            bool? utiliza = queryResult.UniqueResult<bool?>();

            return utiliza.GetValueOrDefault(false);
        }
        public void SetarDataPreViagemFimCargaTransbordo(int codigoCarga, DateTime dataPreViagemFim)
        {
            if (codigoCarga <= 0)
                return;

            string sql = @"
             UPDATE T_CARGA SET CAR_DATA_PRE_VIAGEM_FIM = :dataPreViagemFim
             WHERE CAR_CODIGO IN (select T.CAR_CODIGO from T_CARGA (nolock) C  
             INNER JOIN T_CARGA (nolock) T ON T.CAR_CODIGO_CARGA_EMBARCADOR = C.CAR_CODIGO_CARGA_EMBARCADOR
             where C.CAR_CODIGO = :codigoCarga AND T.CAR_CARGA_TRANSBORDO = 1)";

            var query = this.SessionNHiBernate.CreateSQLQuery(sql)
                .SetParameter("codigoCarga", codigoCarga)
                .SetParameter("dataPreViagemFim", dataPreViagemFim);

            query.ExecuteUpdate();
        }

        public string OutrosNumerosObsCte(Dominio.Entidades.Embarcador.Cargas.Carga carga)
        {
            if (carga == null)
                return string.Empty;

            string resultado = string.Empty;
            if (carga.CargaDeVinculo || carga.CargaPossuiOutrosNumerosEmbarcador)
                resultado = string.Join(", ", carga.CodigosAgrupados.ToList());

            if (carga.CargaAgrupada)
            {
                IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

                query = query.Where(o => o.CargaAgrupamento.Codigo == carga.Codigo);

                resultado = string.Join(", ", resultado, string.Join(", ", query.Select(o => o.CodigoCargaEmbarcador).ToList()));
            }
            return resultado;
        }

        public List<int> BuscarCargasPendentesGerarCargaEspelho(int limit)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> queryCarga = SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(carga =>
                    carga.TipoOperacao != null &&
                    carga.TipoOperacao.ConfiguracaoCarga != null &&
                    carga.TipoOperacao.ConfiguracaoCarga.GerarCargaEspelhoAutomaticamenteAoFinalizarCarga &&
                    (carga.SituacaoCarga == SituacaoCarga.EmTransporte || carga.SituacaoCarga == SituacaoCarga.Encerrada) &&
                    carga.PendenteGerarCargaEspelho);

            return queryCarga.Select(carga => carga.Codigo).Take(limit).ToList();
        }

        public IList<int> BuscarCodigosCargasSemControleEntrega(int limit)
        {
            var sql = $@"SELECT TOP ({limit}) Carga.CAR_CODIGO
                        FROM T_CARGA Carga
                        WHERE
                            Carga.CAR_CODIGO_AGRUPAMENTO IS NULL
                            AND (Carga.CAR_NUMERO_TENTATIVAS_GERAR_ENTREGAS_CONTROLE_QUALIDADE IS NULL
                                 OR Carga.CAR_NUMERO_TENTATIVAS_GERAR_ENTREGAS_CONTROLE_QUALIDADE < 3)
                            AND EXISTS (
                                SELECT 1
                                FROM T_TIPO_OPERACAO TipoOperacao
                                WHERE TipoOperacao.TOP_CODIGO = Carga.TOP_CODIGO
                                  AND TipoOperacao.TOP_NAO_GERAR_CONTROLE_COLETA_ENTREGA = 0
                            )
                            AND NOT EXISTS (
                                SELECT 1
                                FROM T_CARGA_ENTREGA CargaEntrega
                                WHERE CargaEntrega.CAR_CODIGO = Carga.CAR_CODIGO
                            )
                            AND (
                                Carga.CAR_SITUACAO IN (11, 9, 7, 15)
                                OR (
                                    Carga.CAR_SITUACAO_CARGA_ROTEIRIZADA = 2
                                    AND Carga.CAR_SITUACAO NOT IN (1, 13, 5, 4, 18, 2)
                                    AND Carga.CAR_DATA_CRIACAO >= DATEADD(MONTH, -1, GETDATE())
                                )
                            );";

            var consultaCargasSemEntrega = this.SessionNHiBernate.CreateSQLQuery(sql);

            return consultaCargasSemEntrega.List<int>();
        }

        public IList<int> BuscarCodigosCargasPedidoSemControleEntrega(int limit)
        {
            var sql = $@"SELECT TOP ({limit}) Carga.CAR_CODIGO
                        FROM T_CARGA Carga
                        WHERE
                            Carga.CAR_SITUACAO IN (11, 9, 7, 15)
                            AND Carga.CAR_CODIGO_AGRUPAMENTO IS NULL
                            AND (
                                Carga.CAR_NUMERO_TENTATIVAS_GERAR_ENTREGAS_CONTROLE_QUALIDADE IS NULL
                                OR Carga.CAR_NUMERO_TENTATIVAS_GERAR_ENTREGAS_CONTROLE_QUALIDADE < 3
                            )
                            AND EXISTS (
                                SELECT 1
                                FROM T_TIPO_OPERACAO TipoOperacao
                                WHERE TipoOperacao.TOP_CODIGO = Carga.TOP_CODIGO
                                  AND TipoOperacao.TOP_NAO_GERAR_CONTROLE_COLETA_ENTREGA = 0
                            )
                            AND EXISTS (
                                SELECT 1
                                FROM T_CARGA_PEDIDO CargaPedido
                                WHERE CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO
                                  AND NOT EXISTS (
                                      SELECT 1
                                      FROM T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido
                                      WHERE CargaEntregaPedido.CPE_CODIGO = CargaPedido.CPE_CODIGO
                                        AND CargaEntregaPedido.CEN_CODIGO IS NOT NULL
                                  )
                            );";

            var consultaCargasSemEntrega = this.SessionNHiBernate.CreateSQLQuery(sql);
            return consultaCargasSemEntrega.List<int>();
        }

        public IList<int> BuscarCodigosCargasSemIntegracao(int limit, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoIntegracao> tiposIntegracao)
        {
            string tipoIntegracao = string.Join(", ", from integracao in tiposIntegracao select integracao.ToString("d"));

            var sql = $@"
                select distinct  Carga.CAR_CODIGO
                from t_carga Carga inner join T_CARGA_INTEGRACAO integracao on integracao.CAR_CODIGO = Carga.CAR_CODIGO 
                inner join T_TIPO_INTEGRACAO tipoIntegracao on tipoIntegracao.TPI_CODIGO = integracao.TPI_CODIGO 
                LEFT JOIN T_CARGA_CARGA_INTEGRACAO cargaIntegracao ON cargaIntegracao.CAR_CODIGO = Carga.CAR_CODIGO 
                WHERE  tipoIntegracao.TPI_TIPO in ({tipoIntegracao}) and Carga.CAR_SITUACAO in (11,9,7) and cargaIntegracao.CAR_CODIGO IS NULL and Carga.car_data_criacao >= '{DateTime.Now.AddDays(-15).ToString("yyyy-MM-dd")}';";

            var consultaCargasSemEntrega = this.SessionNHiBernate.CreateSQLQuery(sql);

            return consultaCargasSemEntrega.List<int>();
        }

        public IList<int> BuscarCodigosCargasEntregasSemProdutos(int limit)
        {
            var sql = $@"
                select distinct top {limit} Carga.CAR_CODIGO
                from t_carga Carga inner join T_CARGA_PEDIDO cargapedido on cargapedido.CAR_CODIGO = Carga.CAR_CODIGO
                inner join T_TIPO_OPERACAO operacao on carga.TOP_CODIGO = operacao.TOP_CODIGO and operacao.top_nao_gerar_controle_coleta_entrega = 0
                inner join T_PEDIDO_XML_NOTA_FISCAL pedidoXmlNota on pedidoXmlNota.CPE_CODIGO = cargapedido.CPE_CODIGO
                inner join T_XML_NOTA_FISCAL_PRODUTO xmlNotaFiscalProduto on xmlNotaFiscalProduto.NFX_CODIGO = pedidoXmlNota.NFX_CODIGO
                inner join T_CARGA_ENTREGA  cargaEntrega ON cargaEntrega.CAR_CODIGO = Carga.CAR_CODIGO 
                left join T_CARGA_ENTREGA_PRODUTO cargaentregaProduto on cargaentregaProduto.CEN_CODIGO = cargaEntrega.CEN_CODIGO AND cargaentregaProduto.NFX_CODIGO IS NOT NULL and xmlNotaFiscalProduto.PRO_CODIGO = cargaentregaProduto.PRO_CODIGO
                WHERE Carga.CAR_SITUACAO in (11,9,7,15) 
                and carga.CAR_CODIGO_AGRUPAMENTO is null 
                and cargaentregaProduto.CEN_CODIGO IS NULL 
                and Carga.car_data_criacao >= '{DateTime.Today.AddMonths(-3):yyyy-MM-dd}';";

            var consultaCargasSemEntrega = this.SessionNHiBernate.CreateSQLQuery(sql);

            return consultaCargasSemEntrega.List<int>();
        }

        public int ValidarCargaEntregasSemProdutos(int carga)
        {
            var sql = $@"
                select distinct  Carga.CAR_CODIGO
                from t_carga Carga inner join T_CARGA_PEDIDO cargapedido on cargapedido.CAR_CODIGO = Carga.CAR_CODIGO
                inner join T_TIPO_OPERACAO operacao on carga.TOP_CODIGO = operacao.TOP_CODIGO and operacao.top_nao_gerar_controle_coleta_entrega = 0
                inner join T_PEDIDO_XML_NOTA_FISCAL pedidoXmlNota on pedidoXmlNota.CPE_CODIGO = cargapedido.CPE_CODIGO
                inner join T_XML_NOTA_FISCAL_PRODUTO xmlNotaFiscalProduto on xmlNotaFiscalProduto.NFX_CODIGO = pedidoXmlNota.NFX_CODIGO
                inner join T_CARGA_ENTREGA  cargaEntrega ON cargaEntrega.CAR_CODIGO = Carga.CAR_CODIGO 
                left join T_CARGA_ENTREGA_PRODUTO cargaentregaProduto on cargaentregaProduto.CEN_CODIGO = cargaEntrega.CEN_CODIGO AND cargaentregaProduto.NFX_CODIGO IS NOT NULL and xmlNotaFiscalProduto.PRO_CODIGO = cargaentregaProduto.PRO_CODIGO
                WHERE operacao.TOP_EXIGE_NOTA_FISCAL_PARA_CALCULAR_FRETE = 1 and Carga.CAR_SITUACAO in (11,9,7,15) and carga.CAR_CODIGO_AGRUPAMENTO is null and cargaentregaProduto.CEN_CODIGO IS NULL and cargaEntrega.CEN_ENTREGA_COM_NOTAS_REPROCESSADAS = 1 and Carga.CAR_CODIGO = {carga};";

            var consultaCargasSemItem = this.SessionNHiBernate.CreateSQLQuery(sql);

            return consultaCargasSemItem.UniqueResult<int>();
        }

        public IList<int> BuscarCodigosCargasEntregasSemNotas(int limit, Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoControleEntrega configuracaoControleEntrega)
        {
            string whereSituacao = string.Empty;

            if ((configuracaoControleEntrega?.PermitirAjustarEntregasEtapasAnterioresIntegracao ?? false))
                whereSituacao = "Carga.CAR_SITUACAO in (11,9,7,15,6)";
            else
                whereSituacao = "Carga.CAR_SITUACAO in (11,9,15,7)";

            int dias = (configuracaoControleEntrega?.TempoReprocessarCargaEntregasSemNotas ?? 30);
            if (dias == 0)
                dias = 30;

            var sql = $@"
                select distinct  Carga.CAR_CODIGO
                from t_carga Carga inner join T_CARGA_PEDIDO cargapedido on cargapedido.CAR_CODIGO = Carga.CAR_CODIGO
                inner join T_TIPO_OPERACAO operacao on carga.TOP_CODIGO = operacao.TOP_CODIGO and operacao.top_nao_gerar_controle_coleta_entrega = 0
                inner join T_PEDIDO_XML_NOTA_FISCAL pedidoXmlNota on pedidoXmlNota.CPE_CODIGO = cargapedido.CPE_CODIGO
                inner join T_CARGA_ENTREGA  cargaEntrega ON cargaEntrega.CAR_CODIGO = Carga.CAR_CODIGO 
                left join T_CARGA_ENTREGA_NOTA_FISCAL cargaentregaNotaFiscal on cargaentregaNotaFiscal.CEN_CODIGO = cargaEntrega.CEN_CODIGO
                WHERE {whereSituacao} and carga.CAR_CODIGO_AGRUPAMENTO is null and cargaentregaNotaFiscal.CEN_CODIGO IS NULL and (cargaEntrega.CEN_ENTREGA_COM_NOTAS_REPROCESSADAS != 1 or cargaEntrega.CEN_ENTREGA_COM_NOTAS_REPROCESSADAS is null) and Carga.car_data_criacao >= '{DateTime.Now.AddDays(-dias).ToString("yyyy-MM-dd")}';";

            var consultaCargasSemEntrega = this.SessionNHiBernate.CreateSQLQuery(sql);

            return consultaCargasSemEntrega.List<int>();
        }

        public int ValidarCargaEntregasSemNotas(int carga)
        {
            var sql = $@"
                select distinct  Carga.CAR_CODIGO
                from t_carga Carga inner join T_CARGA_PEDIDO cargapedido on cargapedido.CAR_CODIGO = Carga.CAR_CODIGO
                inner join T_TIPO_OPERACAO operacao on carga.TOP_CODIGO = operacao.TOP_CODIGO and operacao.top_nao_gerar_controle_coleta_entrega = 0
                inner join T_PEDIDO_XML_NOTA_FISCAL pedidoXmlNota on pedidoXmlNota.CPE_CODIGO = cargapedido.CPE_CODIGO
                inner join T_CARGA_ENTREGA  cargaEntrega ON cargaEntrega.CAR_CODIGO = Carga.CAR_CODIGO 
                left join T_CARGA_ENTREGA_NOTA_FISCAL cargaentregaNotaFiscal on cargaentregaNotaFiscal.CEN_CODIGO = cargaEntrega.CEN_CODIGO
                WHERE Carga.CAR_SITUACAO in (11,9,7,15,6) and carga.CAR_CODIGO_AGRUPAMENTO is null and cargaentregaNotaFiscal.CEN_CODIGO IS NULL 
                and (cargaEntrega.CEN_ENTREGA_COM_NOTAS_REPROCESSADAS != 1 or cargaEntrega.CEN_ENTREGA_COM_NOTAS_REPROCESSADAS is null) and Carga.CAR_CODIGO = {carga};";

            var consultaCargasSemEntrega = this.SessionNHiBernate.CreateSQLQuery(sql);

            return consultaCargasSemEntrega.UniqueResult<int>();
        }


        public Task<List<Dominio.Entidades.Embarcador.Cargas.Carga>> RealizarFetchAsync(IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query, List<string> fetch, int inicio = 0, int limite = 50)
        {
            if (fetch.Contains("CargaCancelamento"))
                query = query.Fetch(carga => carga.CargaCancelamento);

            if (fetch.Contains("Filial"))
                query = query.Fetch(carga => carga.Filial);

            if (fetch.Contains("Empresa"))
                query = query.Fetch(carga => carga.Empresa);

            if (fetch.Contains("TabelaFrete"))
                query = query.Fetch(carga => carga.TabelaFrete);

            if (fetch.Contains("TipoDeCarga"))
                query = query.Fetch(carga => carga.TipoDeCarga);

            if (fetch.Contains("TipoOperacao"))
                query = query.Fetch(carga => carga.TipoOperacao);

            if (fetch.Contains("Carregamento"))
                query = query.Fetch(carga => carga.Carregamento);

            if (fetch.Contains("CargaAgrupamento"))
                query = query.Fetch(carga => carga.CargaAgrupamento);

            if (fetch.Contains("ModeloVeicularCarga"))
                query = query.Fetch(carga => carga.ModeloVeicularCarga);

            if (fetch.Contains("Rota"))
                query = query.Fetch(carga => carga.Rota);

            return ObterListaAsync<Dominio.Entidades.Embarcador.Cargas.Carga>(query, "Codigo", "desc", inicio, limite);
        }

        public IList<Dominio.ObjetosDeValor.WebService.Rest.Escrituracao.BuscarDadosPagamento.CargaPagamento> BuscarParaAPIDePagamentos(Dominio.ObjetosDeValor.WebService.Rest.Escrituracao.BuscarDadosPagamento.RequisicaoBuscarDadosPagamento request)
        {
            string pattern = "yyyy-MM-dd";
            StringBuilder sql = new StringBuilder();

            sql.Append(@"SELECT DISTINCT CAR.CAR_CODIGO AS CodigoCarga,
                        CAR_CODIGO_CARGA_EMBARCADOR AS NumeroCarga,
                        CAR_SITUACAO AS SituacaoCargaInt, 
                        EMP_RAZAO AS Transportador, 
                        EMP_CNPJ AS CnpjTransportador, 
                        FIL_DESCRICAO AS Filial, 
                        TOP_DESCRICAO AS TipoOperacao,
                        CON.CON_DATAHORAEMISSAO AS DataHoraEmissao
                        FROM T_CARGA CAR
                        LEFT JOIN T_EMPRESA EMP ON CAR.EMP_CODIGO = EMP.EMP_CODIGO
                        LEFT JOIN T_FILIAL FIL ON CAR.FIL_CODIGO = FIL.FIL_CODIGO
                        LEFT JOIN T_TIPO_OPERACAO TIOP ON CAR.TOP_CODIGO = TIOP.TOP_CODIGO
                        LEFT JOIN T_CARGA_CTE CCT ON CAR.CAR_CODIGO = CCT.CAR_CODIGO
                        LEFT JOIN T_CTe CON ON CCT.CON_CODIGO = CON.CON_CODIGO
                        WHERE (EXISTS (SELECT CON_CODIGO FROM T_DOCUMENTO_FATURAMENTO DFA WHERE DFA.CON_CODIGO = CON.CON_CODIGO AND PAG_CODIGO IS NOT NULL))"
            );

            if (request.ProtocoloDocumento > 0)
                sql.Append($@" AND CCT.CON_CODIGO = {request.ProtocoloDocumento}");

            else if (request.ChaveDocumento != null)
                sql.Append($@" AND CON.CON_CHAVECTE = '{request.ChaveDocumento}'");

            else if (request.dataEmissaoDocumentoInicial != null && request.dataEmissaoDocumentoFinal != null)
                sql.Append($@" AND CON.CON_DATAHORAEMISSAO BETWEEN '{request.dataEmissaoDocumentoInicial.Value.ToString(pattern)}' AND '{request.dataEmissaoDocumentoFinal.Value.ToString(pattern)}'");

            sql.Append($" ORDER BY CON.CON_DATAHORAEMISSAO ASC OFFSET {request.Inicio} ROWS");

            if (request.Limite > 0)
                sql.Append($"  FETCH NEXT {request.Limite} ROWS ONLY;");

            var consulta = this.SessionNHiBernate.CreateSQLQuery(sql.ToString());

            consulta.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.WebService.Rest.Escrituracao.BuscarDadosPagamento.CargaPagamento)));

            return consulta.SetTimeout(600).List<Dominio.ObjetosDeValor.WebService.Rest.Escrituracao.BuscarDadosPagamento.CargaPagamento>();
        }

        public List<int> BuscarCodigosCargasSolicitarConfirmacaoDocumentosFiscais(int limiteRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                        .Where(obj =>
                            (obj.DataSolicitacaoConfirmacaoDocumentosFiscais <= DateTime.Now.AddSeconds(-10)) &&
                            (obj.ProcessandoDocumentosFiscais == false) &&
                            (obj.CargaFechada == true))
                        .OrderBy(obj => obj.DataSolicitacaoConfirmacaoDocumentosFiscais)
                        .Select(obj => obj.Codigo)
                        .Take(limiteRegistros);

            return query.ToList();
        }

        public async Task<List<int>> BuscarCodigosCargasSolicitarConfirmacaoDocumentosFiscaisAsync(int limiteRegistros, CancellationToken cancellationToken)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                        .Where(obj =>
                            (obj.DataSolicitacaoConfirmacaoDocumentosFiscais <= DateTime.Now.AddSeconds(-10)) &&
                            (obj.ProcessandoDocumentosFiscais == false) &&
                            (obj.CargaFechada == true))
                        .OrderBy(obj => obj.DataSolicitacaoConfirmacaoDocumentosFiscais)
                        .Select(obj => obj.Codigo)
                        .Take(limiteRegistros);

            return await query.ToListAsync(cancellationToken);
        }

        public async Task AtualizarDataSolicitacaoConfirmacaoDocumentosFiscaisPorCodigoCargaAsync(int codigoCarga, DateTime? DataSolicitacaoConfirmacaoDocumentosFiscais, CancellationToken cancellationToken)
        {
            await UnitOfWork.Sessao.CreateSQLQuery("UPDATE T_CARGA SET CAR_DATA_SOLICITACAO_CONFIRMACAO_DOCUMENTOS_FISCAIS = :dataSolicitacaoConfirmacaoDocumentosFiscais WHERE CAR_CODIGO = :codigoCarga")
                .SetParameter("codigoCarga", codigoCarga)
                .SetParameter("dataSolicitacaoConfirmacaoDocumentosFiscais", DataSolicitacaoConfirmacaoDocumentosFiscais)
                .ExecuteUpdateAsync(cancellationToken);
        }

        public Task ExcluirDadosTransporteAsync(int codigoCarga, CancellationToken cancellationToken)
        {
            string sql = $@"UPDATE T_CARGA SET CAR_VEICULO = NULL WHERE CAR_CODIGO = {codigoCarga};
 
                            DELETE FROM T_CARGA_VEICULOS_VINCULADOS WHERE CAR_CODIGO = {codigoCarga};

                            DELETE FROM T_CARGA_MOTORISTA WHERE CAR_CODIGO = {codigoCarga};";

            return SessionNHiBernate.CreateSQLQuery(sql).ExecuteUpdateAsync(cancellationToken);
        }

        public Task<List<Dominio.ObjetosDeValor.Embarcador.Pedido.TipoOperacaoRetornoControleEntrega>> BuscarTipoOperacaoControleEntregaAsync(List<int> codigos)
        {
            string sql = $@"SELECT carga.CAR_CODIGO CodigoCarga,
                           configuracaoTipoOperacaoTrizy.CTT_HABILITAR_CHAT PermiteChat,
                           tipoOperacao.TOP_DESCRICAO Descricao,
                           tipoOperacao.TOP_PERMITE_ADICIONAR_COLETA PermiteAdicionarColeta,
                           configuracaoTipoOperacaoControleEntrega.COE_ENVIAR_BOLETIM_DE_VIAGEM_AO_FINALIZAR_VIAGEM EnviarBoletimDeViagemAoFinalizarViagem,
                           tipoOperacao.TOP_PERMITIR_ADICIONAR_PEDIDO_REENTREGA_APOS_INICIO_VIAGEM PermiteAdicionarPedidoReentregaAposInicioViagem
                   FROM t_carga carga
                   LEFT JOIN t_tipo_operacao tipoOperacao ON tipoOperacao.TOP_CODIGO = carga.TOP_CODIGO
                   LEFT JOIN T_CONFIGURACAO_TIPO_OPERACAO_TRIZY configuracaoTipoOperacaoTrizy ON configuracaoTipoOperacaoTrizy.CTT_CODIGO = tipoOperacao.CTT_CODIGO_TRIZY
                   LEFT JOIN T_CONFIGURACAO_TIPO_OPERACAO_CONTROLE_ENTREGA configuracaoTipoOperacaoControleEntrega ON configuracaoTipoOperacaoControleEntrega.COE_CODIGO = tipoOperacao.COE_CODIGO
                   WHERE Carga.CAR_CODIGO in (:codigos)";

            var consulta = this.SessionNHiBernate.CreateSQLQuery(sql.ToString())
                .SetParameterList("codigos", codigos)
                .SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Pedido.TipoOperacaoRetornoControleEntrega)));

            return consulta.List<Dominio.ObjetosDeValor.Embarcador.Pedido.TipoOperacaoRetornoControleEntrega>()
                           .ToDynamicListAsync<Dominio.ObjetosDeValor.Embarcador.Pedido.TipoOperacaoRetornoControleEntrega>();
        }

        public bool GerarFluxoPatioAposConfirmacaoAgendamento(int codigoCarga)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaJanelaDescarregamento> queryCargaJanelaDescarregamento = SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaJanelaDescarregamento>();
            bool permite = queryCargaJanelaDescarregamento.Where(cjd => cjd.Carga.Codigo == codigoCarga).Any(cjd => cjd.CentroDescarregamento != null && cjd.CentroDescarregamento.Ativo && cjd.CentroDescarregamento.GerarFluxoPatioAposConfirmacaoAgendamento);

            return permite;
        }

        public bool ExisteCargaJanelaDescarregamentoPorFilialDestino(int codigoCarga, SituacaoCargaJanelaDescarregamento[] situacoes)
        {
            string sql = $@"SELECT
                            CASE
                                WHEN EXISTS (
                                    SELECT 1
                                    FROM T_CARGA_JANELA_DESCARREGAMENTO cargaJanelaDescarregamento
                                    INNER JOIN T_CARGA carga
			                        ON cargaJanelaDescarregamento.CAR_CODIGO = carga.CAR_CODIGO
			                        WHERE carga.CAR_CODIGO = {codigoCarga} 
                                    AND (cargaJanelaDescarregamento.CJD_SITUACAO IN ({string.Join(",", situacoes.Select(situacao => (int)situacao))}))
                                )
                                THEN CAST(1 AS BIT)
                                ELSE CAST(0 AS BIT)
                            END AS existe;";

            var query = this.SessionNHiBernate.CreateSQLQuery(sql);
            return query.UniqueResult<bool>();
        }

        #endregion Métodos Públicos

        #region Métodos Públicos - Relatórios

        public IList<Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.RelatorioGestaoCarga> ConsultarRelatorioGestaoCargaDetalhado(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaGestaoCarga filtrosPesquisa)
        {
            string sqlQuery = @"SELECT distinct 
                                        TipoOperacao.TOP_DESCRICAO Tipo,
                                        CASE
                                        WHEN CargaCTe.CAR_CODIGO IS NULL THEN 'PENDENTE'
										WHEN DestinoEntrega.Fim IS NOT NULL THEN 'FINALIZADO'
										WHEN DestinoEntrega.Inicio IS NOT NULL AND  DestinoEntrega.Fim IS NULL THEN 'EM DESCARGA'
										WHEN OrigemEntrega.Fim IS NOT NULL THEN 'EM VIAGEM'
										ELSE 'EM CARREGAMENTO'
										END Status,
                                        GrupoPessoa.GRP_DESCRICAO Grupo,
                                        Empresa.EMP_CODIGO_INTEGRACAO Filial,
                                        CAST(Pedido.PED_NUMERO AS VARCHAR(20)) ProgVei,
                                        Remetente.PCT_NOME Remetente,
                                        Origem.LOC_DESCRICAO Origem,
                                        PaisOrigem.PAI_NOME PaisOrigem,
                                        FronteiraOrigemEntrega.Etapa FronteiraOrigem,
                                        FronteiraDestinoEntrega.Etapa FronteiraDestino,
                                        Cavalo.VEI_PLACA Cavalo,
                                        ISNULL(SUBSTRING((SELECT ', ' + veiculo1.VEI_PLACA FROM T_CARGA_VEICULOS_VINCULADOS veiculoVinculadoCarga1 INNER JOIN T_VEICULO veiculo1 ON veiculoVinculadoCarga1.VEI_CODIGO = veiculo1.VEI_CODIGO WHERE veiculoVinculadoCarga1.CAR_CODIGO = Carga.CAR_CODIGO FOR XML PATH('')), 3, 1000), '') Carretas,
                                        OrigemEntrega.Inicio ChegadaOrigem,
                                        OrigemEntrega.Fim SaidaOrigem,
                                        OrigemEntrega.Total TempoOrigem,
                                        FronteiraOrigemEntrega.Inicio ChegadaFronteiraOrigem,
                                        FronteiraOrigemEntrega.Fim SaidaFronteiraOrigem,
                                        FronteiraOrigemEntrega.Total TempoFronteiraOrigem,
                                        FronteiraDestinoEntrega.Inicio ChegadaFronteiraDestino,
                                        FronteiraDestinoEntrega.Fim SaidaFronteiraDestino,
                                        FronteiraDestinoEntrega.Total TempoFronteiraDestino,
                                        DestinoEntrega.Inicio ChegadaDestino,
                                        DestinoEntrega.Fim SaidaDestino,
                                        DestinoEntrega.Total TempoDestino,
                                        DATEDIFF(hour, OrigemEntrega.Inicio, DestinoEntrega.Fim) TempoViagem,
                                        0.0 VlrDiaria,--verificar
                                        Pedido.PED_NUMERO_PEDIDO_EMBARCADOR NumeroPedidoEmbarcador,
                                        Pedido.PED_NUMERO NumeroPedido,
                                        Destinatario.PCT_NOME Destinatario,
                                        Destino.LOC_DESCRICAO Destino,
                                        PaisDestino.PAI_NOME PaisDestino,
                                        Pedido.CAR_DATA_CARREGAMENTO_PEDIDO PrevisaoEmbarque, 
                                        CTe.CON_VALOR_FRETE ValorFrete,
                                        (TipoCarga.TCG_DESCRICAO + ' Temp. ' + CAST(isnull(FaixaTemperatura.FTE_FAIXA_INICIAL, 0) as nvarchar(max)) + ' a ' + CAST(isnull(FaixaTemperatura.FTE_FAIXA_FINAL, 0) as nvarchar(max))) Produto,
                                        FaixaTemperatura.FTE_DESCRICAO Temperatura,
                                        SUBSTRING((SELECT ', ' + motorista1.FUN_NOME + (CASE WHEN motorista1.FUN_FONE is null or motorista1.FUN_FONE = '' THEN '' ELSE ' (' + motorista1.FUN_FONE  + ')' END) FROM T_CARGA_MOTORISTA motoristaCarga1 INNER JOIN T_FUNCIONARIO motorista1 ON motoristaCarga1.CAR_MOTORISTA = motorista1.FUN_CODIGO WHERE motoristaCarga1.CAR_CODIGO = Carga.CAR_CODIGO FOR XML PATH('')), 3, 1000) Motoristas,
                                        (SELECT MAX(POA_DATA) DataUltimaPosicao from T_POSICAO_ATUAL 
                                                        inner join T_VEICULO on T_VEICULO.VEI_CODIGO = T_POSICAO_ATUAL.VEI_CODIGO
                                                        inner join T_RASTREADOR_TECNOLOGIA on T_VEICULO.TRA_CODIGO = T_RASTREADOR_TECNOLOGIA.TRA_CODIGO
				                                        WHERE T_VEICULO.VEI_CODIGO = Carga.CAR_VEICULO) DataUltimaPosicao,
                                        (SELECT TOP(1) 'http://maps.google.com/?q=' + LTRIM(STR(POA_LATITUDE, 25, 6)) + ',' + LTRIM(STR(POA_LONGITUDE, 25, 6))  from T_POSICAO_ATUAL 
                                                        inner join T_VEICULO on T_VEICULO.VEI_CODIGO = T_POSICAO_ATUAL.VEI_CODIGO
                                                        inner join T_RASTREADOR_TECNOLOGIA on T_VEICULO.TRA_CODIGO = T_RASTREADOR_TECNOLOGIA.TRA_CODIGO
				                                        WHERE T_VEICULO.VEI_CODIGO = Carga.CAR_VEICULO order by POA_DATA DESC)
				                                        LocalUltimaPosicao,
                                        (SELECT TOP(1) POA_DESCRICAO DataUltimaPosicao from T_POSICAO_ATUAL 
                                                        inner join T_VEICULO on T_VEICULO.VEI_CODIGO = T_POSICAO_ATUAL.VEI_CODIGO
                                                        inner join T_RASTREADOR_TECNOLOGIA on T_VEICULO.TRA_CODIGO = T_RASTREADOR_TECNOLOGIA.TRA_CODIGO
				                                        WHERE T_VEICULO.VEI_CODIGO = Carga.CAR_VEICULO order by POA_DATA DESC) DescricaoLocalUltimaPosicao,
                                        GETDATE() DataUltimaOcorrencia,--verificar
                                        '' DescricaoUltimaOcorrencia--verificar
                                        FROM T_CARGA Carga
                                        LEFT OUTER JOIN T_TIPO_OPERACAO TipoOperacao on TipoOperacao.TOP_CODIGO = Carga.TOP_CODIGO
                                        JOIN T_CARGA_PEDIDO CargaPedido on CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO
                                        JOIN T_PEDIDO Pedido on Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
                                        LEFT OUTER JOIN T_TIPO_DE_CARGA TipoCarga on TipoCarga.TCG_CODIGO = Pedido.TCG_CODIGO
										LEFT OUTER JOIN T_FAIXA_TEMPERATURA FaixaTemperatura on FaixaTemperatura.FTE_CODIGO = TipoCarga.FTE_CODIGO
                                        JOIN T_EMPRESA Empresa on Empresa.EMP_CODIGO = Carga.EMP_CODIGO
                                        LEFT OUTER JOIN T_CARGA_CTE CargaCTe on CargaCTe.CAR_CODIGO = Carga.CAR_CODIGO--
                                        LEFT OUTER JOIN T_CTE CTe on CTe.CON_CODIGO = CargaCTe.CON_CODIGO--
                                        LEFT OUTER JOIN T_CTE_PARTICIPANTE Remetente on Remetente.PCT_CODIGO = CTe.CON_REMETENTE_CTE--
                                        LEFT OUTER JOIN T_CTE_PARTICIPANTE Destinatario on Destinatario.PCT_CODIGO = CTe.CON_DESTINATARIO_CTE--
                                        LEFT OUTER JOIN T_CTE_PARTICIPANTE Tomador on Tomador.PCT_CODIGO = CTe.CON_TOMADOR_PAGADOR_CTE--
                                        LEFT OUTER JOIN T_GRUPO_PESSOAS GrupoPessoa on GrupoPessoa.GRP_CODIGO = Tomador.GRP_CODIGO
                                        LEFT OUTER JOIN T_LOCALIDADES Origem on Origem.LOC_CODIGO = CTe.CON_LOCINICIOPRESTACAO--
                                        LEFT OUTER JOIN T_PAIS PaisOrigem on PaisOrigem.PAI_CODIGO = Origem.PAI_CODIGO
                                        LEFT OUTER JOIN T_LOCALIDADES Destino on Destino.LOC_CODIGO = CTe.CON_LOCTERMINOPRESTACAO--
                                        LEFT OUTER JOIN T_PAIS PaisDestino on PaisDestino.PAI_CODIGO = Destino.PAI_CODIGO
                                        LEFT OUTER JOIN T_VEICULO Cavalo on Cavalo.VEI_CODIGO = Carga.CAR_VEICULO
                                        LEFT OUTER JOIN (SELECT T.Etapa, T.Inicio, T.Fim, T.Total, (T.Freetime * 60) Freetime, 
		                                        CASE 
		                                        WHEN Total > (T.Freetime * 60) then Total - (T.Freetime * 60)
		                                        ELSE 0
		                                        END Exedente, T.CodigoCarga
		                                        FROM  (
		                                        SELECT CargaEntrega.CEN_ORDEM_REALIZADA Ordem,
		                                        CASE 
		                                        WHEN CEN_COLETA = 1 THEN 'Coleta'
		                                        WHEN CEN_FRONTEIRA = 1 THEN Cliente.CLI_NOME
                                                WHEN CEN_PARQUEAMENTO = 1 THEN 'Parqueamento'
		                                        ELSE 'Entrega'
		                                        END Etapa,
		                                        CargaEntrega.CEN_DATA_INICIO_ENTREGA Inicio,
		                                        CargaEntrega.CEN_DATA_FIM_ENTREGA Fim,
		                                        datediff(minute, CargaEntrega.CEN_DATA_INICIO_ENTREGA , CargaEntrega.CEN_DATA_FIM_ENTREGA) Total,
		                                        CASE
		                                        WHEN CEN_COLETA = 1 THEN ISNULL(Rota.ROF_TEMPO_CARREGAMENTO_TICKS, 0) / 36000000000
		                                        WHEN CEN_FRONTEIRA = 1 THEN ISNULL((SELECT TOP(1) Fronteira.RFF_TEMPO_MEDIO_PERMANENCIA_FRONTEIRA FROM T_ROTA_FRETE_FRONTEIRA Fronteira where Fronteira.ROF_CODIGO = Rota.ROF_CODIGO and Fronteira.CLI_CGCCPF = Cliente.CLI_CGCCPF), 0) / 60
		                                        ELSE ISNULL(Rota.ROF_TEMPO_DESCARGA_TICKS, 0) / 36000000000
		                                        END Freetime, CargaTempo.CAR_CODIGO CodigoCarga
			                                        FROM T_CARGA_ENTREGA CargaEntrega
			                                        JOIN T_CLIENTE Cliente on Cliente.CLI_CGCCPF = CargaEntrega.CLI_CODIGO_ENTREGA
			                                        JOIN T_CARGA CargaTempo on CargaTempo.CAR_CODIGO = CargaEntrega.CAR_CODIGO
			                                        LEFT OUTER JOIN T_ROTA_FRETE Rota ON Rota.ROF_CODIGO = CargaTempo.ROF_CODIGO
		                                        WHERE CargaEntrega.CEN_ORDEM_REALIZADA = 0 AND CargaEntrega.CEN_COLETA = 1) AS T) OrigemEntrega on OrigemEntrega.CodigoCarga = Carga.CAR_CODIGO
                                        LEFT OUTER JOIN (SELECT T.Etapa, T.Inicio, T.Fim, T.Total, (T.Freetime * 60) Freetime, 
		                                        CASE 
		                                        WHEN Total > (T.Freetime * 60) then Total - (T.Freetime * 60)
		                                        ELSE 0
		                                        END Exedente, T.CodigoCarga
		                                        FROM  (
		                                        SELECT CargaEntrega.CEN_ORDEM_REALIZADA Ordem,
		                                        CASE 
		                                        WHEN CEN_COLETA = 1 THEN 'Coleta'
		                                        WHEN CEN_FRONTEIRA = 1 THEN Cliente.CLI_NOME
                                                WHEN CEN_PARQUEAMENTO = 1 THEN 'Parqueamento'
		                                        ELSE 'Entrega'
		                                        END Etapa,
		                                        CargaEntrega.CEN_DATA_INICIO_ENTREGA Inicio,
		                                        CargaEntrega.CEN_DATA_FIM_ENTREGA Fim,
		                                        datediff(minute, CargaEntrega.CEN_DATA_INICIO_ENTREGA , CargaEntrega.CEN_DATA_FIM_ENTREGA) Total,
		                                        CASE
		                                        WHEN CEN_COLETA = 1 THEN ISNULL(Rota.ROF_TEMPO_CARREGAMENTO_TICKS, 0) / 36000000000
		                                        WHEN CEN_FRONTEIRA = 1 THEN ISNULL((SELECT TOP(1) Fronteira.RFF_TEMPO_MEDIO_PERMANENCIA_FRONTEIRA FROM T_ROTA_FRETE_FRONTEIRA Fronteira where Fronteira.ROF_CODIGO = Rota.ROF_CODIGO and Fronteira.CLI_CGCCPF = Cliente.CLI_CGCCPF), 0) / 60
		                                        ELSE ISNULL(Rota.ROF_TEMPO_DESCARGA_TICKS, 0) / 36000000000
		                                        END Freetime, Carga.CAR_CODIGO CodigoCarga
			                                        FROM T_CARGA_ENTREGA CargaEntrega
			                                        JOIN T_CLIENTE Cliente on Cliente.CLI_CGCCPF = CargaEntrega.CLI_CODIGO_ENTREGA
			                                        JOIN T_CARGA Carga on Carga.CAR_CODIGO = CargaEntrega.CAR_CODIGO
			                                        LEFT OUTER JOIN T_ROTA_FRETE Rota ON Rota.ROF_CODIGO = Carga.ROF_CODIGO
		                                        WHERE CargaEntrega.CEN_ORDEM_REALIZADA = 1 AND CargaEntrega.CEN_FRONTEIRA = 1) AS T) FronteiraOrigemEntrega on FronteiraOrigemEntrega.CodigoCarga = Carga.CAR_CODIGO
                                        LEFT OUTER JOIN (SELECT T.Etapa, T.Inicio, T.Fim, T.Total, (T.Freetime * 60) Freetime, 
		                                        CASE 
		                                        WHEN Total > (T.Freetime * 60) then Total - (T.Freetime * 60)
		                                        ELSE 0
		                                        END Exedente, T.CodigoCarga
		                                        FROM  (
		                                        SELECT CargaEntrega.CEN_ORDEM_REALIZADA Ordem,
		                                        CASE 
		                                        WHEN CEN_COLETA = 1 THEN 'Coleta'
		                                        WHEN CEN_FRONTEIRA = 1 THEN Cliente.CLI_NOME
                                                WHEN CEN_PARQUEAMENTO = 1 THEN 'Parqueamento'
		                                        ELSE 'Entrega'
		                                        END Etapa,
		                                        CargaEntrega.CEN_DATA_INICIO_ENTREGA Inicio,
		                                        CargaEntrega.CEN_DATA_FIM_ENTREGA Fim,
		                                        datediff(minute, CargaEntrega.CEN_DATA_INICIO_ENTREGA , CargaEntrega.CEN_DATA_FIM_ENTREGA) Total,
		                                        CASE
		                                        WHEN CEN_COLETA = 1 THEN ISNULL(Rota.ROF_TEMPO_CARREGAMENTO_TICKS, 0) / 36000000000
		                                        WHEN CEN_FRONTEIRA = 1 THEN ISNULL((SELECT TOP(1) Fronteira.RFF_TEMPO_MEDIO_PERMANENCIA_FRONTEIRA FROM T_ROTA_FRETE_FRONTEIRA Fronteira where Fronteira.ROF_CODIGO = Rota.ROF_CODIGO and Fronteira.CLI_CGCCPF = Cliente.CLI_CGCCPF), 0) / 60
		                                        ELSE ISNULL(Rota.ROF_TEMPO_DESCARGA_TICKS, 0) / 36000000000
		                                        END Freetime, Carga.CAR_CODIGO CodigoCarga
			                                        FROM T_CARGA_ENTREGA CargaEntrega
			                                        JOIN T_CLIENTE Cliente on Cliente.CLI_CGCCPF = CargaEntrega.CLI_CODIGO_ENTREGA
			                                        JOIN T_CARGA Carga on Carga.CAR_CODIGO = CargaEntrega.CAR_CODIGO
			                                        LEFT OUTER JOIN T_ROTA_FRETE Rota ON Rota.ROF_CODIGO = Carga.ROF_CODIGO
		                                        WHERE CargaEntrega.CEN_ORDEM_REALIZADA = 2 AND CargaEntrega.CEN_FRONTEIRA = 1) AS T) FronteiraDestinoEntrega on FronteiraDestinoEntrega.CodigoCarga = Carga.CAR_CODIGO
                                        LEFT OUTER JOIN (SELECT T.Etapa, T.Inicio, T.Fim, T.Total, (T.Freetime * 60) Freetime, 
		                                        CASE 
		                                        WHEN Total > (T.Freetime * 60) then Total - (T.Freetime * 60)
		                                        ELSE 0
		                                        END Exedente, T.CodigoCarga
		                                        FROM  (
		                                        SELECT CargaEntrega.CEN_ORDEM_REALIZADA Ordem,
		                                        CASE 
		                                        WHEN CEN_COLETA = 1 THEN 'Coleta'
		                                        WHEN CEN_FRONTEIRA = 1 THEN Cliente.CLI_NOME
                                                WHEN CEN_PARQUEAMENTO = 1 THEN 'Parqueamento'
		                                        ELSE 'Entrega'
		                                        END Etapa,
		                                        CargaEntrega.CEN_DATA_INICIO_ENTREGA Inicio,
		                                        CargaEntrega.CEN_DATA_FIM_ENTREGA Fim,
		                                        datediff(minute, CargaEntrega.CEN_DATA_INICIO_ENTREGA , CargaEntrega.CEN_DATA_FIM_ENTREGA) Total,
		                                        CASE
		                                        WHEN CEN_COLETA = 1 THEN ISNULL(Rota.ROF_TEMPO_CARREGAMENTO_TICKS, 0) / 36000000000
		                                        WHEN CEN_FRONTEIRA = 1 THEN ISNULL((SELECT TOP(1) Fronteira.RFF_TEMPO_MEDIO_PERMANENCIA_FRONTEIRA FROM T_ROTA_FRETE_FRONTEIRA Fronteira where Fronteira.ROF_CODIGO = Rota.ROF_CODIGO and Fronteira.CLI_CGCCPF = Cliente.CLI_CGCCPF), 0) / 60
		                                        ELSE ISNULL(Rota.ROF_TEMPO_DESCARGA_TICKS, 0) / 36000000000
		                                        END Freetime, Carga.CAR_CODIGO CodigoCarga
			                                        FROM T_CARGA_ENTREGA CargaEntrega
			                                        JOIN T_CLIENTE Cliente on Cliente.CLI_CGCCPF = CargaEntrega.CLI_CODIGO_ENTREGA
			                                        JOIN T_CARGA Carga on Carga.CAR_CODIGO = CargaEntrega.CAR_CODIGO
			                                        LEFT OUTER JOIN T_ROTA_FRETE Rota ON Rota.ROF_CODIGO = Carga.ROF_CODIGO
		                                        WHERE CargaEntrega.CEN_FRONTEIRA = 0 and CargaEntrega.CEN_COLETA = 0) AS T) DestinoEntrega on DestinoEntrega.CodigoCarga = Carga.CAR_CODIGO
		                                        WHERE 1 = 1 ";

            string pattern = "yyyy-MM-dd";

            sqlQuery += ($" and Carga.CAR_SITUACAO IN (0,1,2,5,6,9,11)");

            if (filtrosPesquisa.DataInicial > DateTime.MinValue)
                sqlQuery += ($" and Carga.CAR_DATA_CRIACAO >= '{filtrosPesquisa.DataInicial.ToString(pattern)}'");

            if (filtrosPesquisa.DataFinal > DateTime.MinValue)
                sqlQuery += ($" and Carga.CAR_DATA_CRIACAO < '{filtrosPesquisa.DataFinal.AddDays(1).ToString(pattern)}'");

            if (filtrosPesquisa.CodigosTipoOperacao?.Count > 0)
                sqlQuery += ($" and (Carga.TOP_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosTipoOperacao)}){(filtrosPesquisa.CodigosTipoOperacao.Contains(-1) ? " or Carga.TOP_CODIGO is null" : "")})");

            if (filtrosPesquisa.CodigosCentroResultado?.Count > 0)
                sqlQuery += ($" and Pedido.CRE_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosCentroResultado)}) ");

            if (filtrosPesquisa.CodigosGrupoPessoa?.Count > 0)
                sqlQuery += ($" and (Tomador.GRP_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosGrupoPessoa)})  or Carga.GRP_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosGrupoPessoa)}))");

            if (filtrosPesquisa.CNPJsTomador?.Count > 0)
                sqlQuery += ($" and Tomador.CLI_CODIGO IN ({string.Join(", ", filtrosPesquisa.CNPJsTomador)}) ");

            if (!filtrosPesquisa.IncluirOperacoesDeslocamentoVazio)
                sqlQuery += ($" and (TipoOperacao.TOP_DESLOCAMENTO_VAZIO = 0 or TipoOperacao.TOP_DESLOCAMENTO_VAZIO IS NULL) ");

            if (filtrosPesquisa.StatusGestaoCarga == StatusGestaoCarga.Pendente)
                sqlQuery += ($" and CargaCTe.CAR_CODIGO IS NULL ");
            else if (filtrosPesquisa.StatusGestaoCarga == StatusGestaoCarga.Finalizado)
                sqlQuery += ($" and DestinoEntrega.Fim IS NOT NULL and CargaCTe.CAR_CODIGO IS NOT NULL ");
            else if (filtrosPesquisa.StatusGestaoCarga == StatusGestaoCarga.EmViagem)
                sqlQuery += ($" and OrigemEntrega.Fim IS NOT NULL and DestinoEntrega.Fim IS NULL and CargaCTe.CAR_CODIGO IS NOT NULL ");
            else if (filtrosPesquisa.StatusGestaoCarga == StatusGestaoCarga.EmDescarga)
                sqlQuery += ($" and DestinoEntrega.Inicio IS NOT NULL AND  DestinoEntrega.Fim IS NULL and CargaCTe.CAR_CODIGO IS NOT NULL ");
            else if (filtrosPesquisa.StatusGestaoCarga == StatusGestaoCarga.EmCarregamento)
                sqlQuery += ($" and OrigemEntrega.Fim IS NULL and CargaCTe.CAR_CODIGO IS NOT NULL ");

            var nhQuery = this.SessionNHiBernate.CreateSQLQuery(sqlQuery);

            nhQuery.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.RelatorioGestaoCarga)));

            return nhQuery.SetTimeout(6000).List<Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.RelatorioGestaoCarga>();
        }

        public Dominio.Relatorios.Embarcador.DataSource.Cargas.RelacaoPedidoPacote.RelacaoPedidoPacote ConsultarRelatorioRelacaoPedidoPacote(int codigoCarga)
        {
            string sql = @"select
	                        carga.CAR_CODIGO_CARGA_EMBARCADOR as CodigoCargaEmbarcador,
	                        carga.CAR_DATA_CARREGAMENTO as DataCarregamentoCarga,
	                        filial.FIL_DESCRICAO as Filial,
	                        empresa.EMP_CODIGO as CodigoEmpresa,
	                        empresa.EMP_RAZAO as RazaoSocialEmpresa,
	                        localidade.LOC_DESCRICAO as DescricaoLocalidade,
	                        localidade.LOC_IBGE as CodigoIBGE,
	                        pais.PAI_ABREVIACAO as AbreviacaoPais,
	                        pais.PAI_NOME as NomePais,
	                        uf.UF_SIGLA as SiglaEstado,
	                        filial.FIL_CODIGO_FILIAL_EMBARCADOR as Origem,
	                        dadosSumarizados.CDS_DESTINOS as Destino
                        from T_CARGA carga ";

            sql += @" JOIN T_FILIAL filial ON filial.FIL_CODIGO = carga.FIL_CODIGO
	                        JOIN T_EMPRESA empresa ON empresa.EMP_CODIGO = carga.EMP_CODIGO
	                        LEFT JOIN T_LOCALIDADES origemTrocaNota ON origemTrocaNota.LOC_CODIGO = carga.LOC_CODIGO_ORIGEM_TROCA_NOTA
	                        LEFT JOIN T_CARGA_DADOS_SUMARIZADOS dadosSumarizados ON dadosSumarizados.CDS_CODIGO = carga.CDS_CODIGO
		                        LEFT JOIN T_LOCALIDADES localidade ON localidade.LOC_CODIGO = empresa.LOC_CODIGO
			                        LEFT JOIN T_PAIS pais ON pais.PAI_CODIGO = localidade.PAI_CODIGO
			                        LEFT JOIN T_UF uf ON uf.UF_SIGLA = localidade.UF_SIGLA";

            sql += " where 1 = 1 ";

            sql += " and carga.CAR_CODIGO = :CodigoCarga";

            var query = this.SessionNHiBernate.CreateSQLQuery(sql);

            query.SetParameter("CodigoCarga", codigoCarga);
            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.Relatorios.Embarcador.DataSource.Cargas.RelacaoPedidoPacote.RelacaoPedidoPacote)));

            return query.SetTimeout(600).UniqueResult<Dominio.Relatorios.Embarcador.DataSource.Cargas.RelacaoPedidoPacote.RelacaoPedidoPacote>();
        }

        public IList<Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.RelatorioGestaoCarga> ConsultarRelatorioGestaoCarga(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaGestaoCarga filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedades, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            var consultaCarga = new ConsultaGestaoCarga().ObterSqlPesquisa(filtrosPesquisa, parametrosConsulta, propriedades).CriarSQLQuery(this.SessionNHiBernate);

            consultaCarga.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.RelatorioGestaoCarga)));

            return consultaCarga.SetTimeout(1200).List<Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.RelatorioGestaoCarga>();
        }

        public int ContarConsultaRelatorioGestaoCarga(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaGestaoCarga filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedades)
        {
            var consultaCarga = new ConsultaGestaoCarga().ObterSqlContarPesquisa(filtrosPesquisa, propriedades).CriarSQLQuery(this.SessionNHiBernate);

            return consultaCarga.SetTimeout(1200).UniqueResult<int>();
        }

        public IList<Dominio.Relatorios.Embarcador.DataSource.TorreControle.Permanencias> ConsultaRelatorioPermanencias(Dominio.ObjetosDeValor.Embarcador.TorreControle.FiltroPesquisaRelatorioPermanencias filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedades, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            var consultaPermanencias = new Repositorio.Embarcador.TorreControle.Consulta.ConsultaPermanencias().ObterSqlPesquisa(filtrosPesquisa, parametrosConsulta, propriedades).CriarSQLQuery(this.SessionNHiBernate);

            consultaPermanencias.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.Relatorios.Embarcador.DataSource.TorreControle.Permanencias)));

            return consultaPermanencias.SetTimeout(1200).List<Dominio.Relatorios.Embarcador.DataSource.TorreControle.Permanencias>();
        }

        public int ContarConsultaRelatorioPermanencias(Dominio.ObjetosDeValor.Embarcador.TorreControle.FiltroPesquisaRelatorioPermanencias filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedades)
        {
            var consultaPermanencias = new Repositorio.Embarcador.TorreControle.Consulta.ConsultaPermanencias().ObterSqlContarPesquisa(filtrosPesquisa, propriedades).CriarSQLQuery(this.SessionNHiBernate);

            return consultaPermanencias.SetTimeout(1200).UniqueResult<int>();
        }

        public IList<Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.RelatorioCarga> ConsultarRelatorioCarga(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCarga filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedades, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            var consultaCarga = new ConsultaCarga().ObterSqlPesquisa(filtrosPesquisa, parametrosConsulta, propriedades).CriarSQLQuery(this.SessionNHiBernate);

            consultaCarga.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.RelatorioCarga)));

            return consultaCarga.SetTimeout(1200).List<Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.RelatorioCarga>();
        }

        public int ContarConsultaRelatorioCarga(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCarga filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedades)
        {
            var consultaCarga = new ConsultaCarga().ObterSqlContarPesquisa(filtrosPesquisa, propriedades).CriarSQLQuery(this.SessionNHiBernate);

            return consultaCarga.SetTimeout(1200).UniqueResult<int>();
        }

        public IList<Dominio.Relatorios.Embarcador.DataSource.Cargas.Quantidade.Quantidade> ConsultarRelatorioQuantidade(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaRelatorioQuantidade filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedades, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            var consultaQuantidade = new ConsultaQuantidade().ObterSqlPesquisa(filtrosPesquisa, parametrosConsulta, propriedades).CriarSQLQuery(this.SessionNHiBernate);

            consultaQuantidade.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.Relatorios.Embarcador.DataSource.Cargas.Quantidade.Quantidade)));

            return consultaQuantidade.SetTimeout(600).List<Dominio.Relatorios.Embarcador.DataSource.Cargas.Quantidade.Quantidade>();
        }

        public int ContarConsultaRelatorioQuantidade(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaRelatorioQuantidade filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedades)
        {
            var consultaQuantidade = new ConsultaQuantidade().ObterSqlContarPesquisa(filtrosPesquisa, propriedades).CriarSQLQuery(this.SessionNHiBernate);

            return consultaQuantidade.SetTimeout(600).UniqueResult<int>();
        }

        public IList<Dominio.Relatorios.Embarcador.DataSource.Cargas.QuantidadeDescarga.QuantidadeDescarga> ConsultarRelatorioQuantidadeDescarregamento(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaRelatorioQuantidadeDescarga filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedades, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            var consultaQuantidade = new ConsultaQuantidadeJanelaDescarregamento().ObterSqlPesquisa(filtrosPesquisa, parametrosConsulta, propriedades).CriarSQLQuery(this.SessionNHiBernate);

            consultaQuantidade.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.Relatorios.Embarcador.DataSource.Cargas.QuantidadeDescarga.QuantidadeDescarga)));

            return consultaQuantidade
                .SetTimeout(600)
                .List<Dominio.Relatorios.Embarcador.DataSource.Cargas.QuantidadeDescarga.QuantidadeDescarga>();
        }

        public int ContarConsultaRelatorioQuantidadeDescarregamento(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaRelatorioQuantidadeDescarga filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedades)
        {
            var consultaQuantidade = new ConsultaQuantidadeJanelaDescarregamento().ObterSqlContarPesquisa(filtrosPesquisa, propriedades).CriarSQLQuery(this.SessionNHiBernate);

            return consultaQuantidade.SetTimeout(600).UniqueResult<int>();
        }

        public int ContarConsultaRelatorioTaxaOcupacaoVeiculo(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaRelatorioTaxaOcupacaoVeiculo filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedadesAgrupamento)
        {
            var query = this.SessionNHiBernate.CreateSQLQuery(ObterSelectConsultaRelatorioTaxaOcupacaoVeiculo(true, filtrosPesquisa, propriedadesAgrupamento, null));

            return query.UniqueResult<int>();
        }

        public IList<Dominio.Relatorios.Embarcador.DataSource.Cargas.TaxaOcupacaoVeiculo.TaxaOcupacaoVeiculo> ConsultarRelatorioTaxaOcupacaoVeiculo(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaRelatorioTaxaOcupacaoVeiculo filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedadesAgrupamento, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            var sql = ObterSelectConsultaRelatorioTaxaOcupacaoVeiculo(false, filtrosPesquisa, propriedadesAgrupamento, parametrosConsulta);
            var query = this.SessionNHiBernate.CreateSQLQuery(sql);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.Relatorios.Embarcador.DataSource.Cargas.TaxaOcupacaoVeiculo.TaxaOcupacaoVeiculo)));

            return query.SetTimeout(1200).List<Dominio.Relatorios.Embarcador.DataSource.Cargas.TaxaOcupacaoVeiculo.TaxaOcupacaoVeiculo>();
        }

        public int ContarConsultaRelatorioTaxaIncidenciaFrete(List<PropriedadeAgrupamento> agrupamentos, DateTime dataInicial, DateTime dataFinal, int codigoTransportador, List<int> codigosFilial, List<double> codigosRecebedores, int codigoCentroCarregamento, int codigoRota, int codigoDestino, List<int> codigosTipoCarga, int codigoModeloVeiculo, double cpfCnpjDestinatario, List<int> codigosTipoOparacao, string propAgrupa, string dirAgrupa, string propOrdena, string dirOrdena, int inicio, int limite)
        {
            var query = this.SessionNHiBernate.CreateSQLQuery(ObterSelectConsultaRelatorioTaxaIncidenciaFrete(true, agrupamentos, dataInicial, dataFinal, codigoTransportador, codigosFilial, codigosRecebedores, codigoCentroCarregamento, codigoRota, codigoDestino, codigosTipoCarga, codigoModeloVeiculo, cpfCnpjDestinatario, codigosTipoOparacao, propAgrupa, dirAgrupa, propOrdena, dirOrdena, inicio, limite));

            return query.UniqueResult<int>();
        }

        public async Task<IList<Dominio.Relatorios.Embarcador.DataSource.Cargas.TaxaIncidenciaFrete.TaxaIncidenciaFrete>> ConsultarRelatorioTaxaIncidenciaFrete(List<PropriedadeAgrupamento> agrupamentos, DateTime dataInicial, DateTime dataFinal, int codigoTransportador, List<int> codigosFilial, List<double> codigosRecebedores, int codigoCentroCarregamento, int codigoRota, int codigoDestino, List<int> codigosTipoCarga, int codigoModeloVeiculo, double cpfCnpjDestinatario, List<int> codigosTipoOparacao, string propAgrupa, string dirAgrupa, string propOrdena, string dirOrdena, int inicio, int limite, CancellationToken cancellationToken)
        {
            var query = this.SessionNHiBernate.CreateSQLQuery(ObterSelectConsultaRelatorioTaxaIncidenciaFrete(false, agrupamentos, dataInicial, dataFinal, codigoTransportador, codigosFilial, codigosRecebedores, codigoCentroCarregamento, codigoRota, codigoDestino, codigosTipoCarga, codigoModeloVeiculo, cpfCnpjDestinatario, codigosTipoOparacao, propAgrupa, dirAgrupa, propOrdena, dirOrdena, inicio, limite));

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.Relatorios.Embarcador.DataSource.Cargas.TaxaIncidenciaFrete.TaxaIncidenciaFrete)));

            return await query.ListAsync<Dominio.Relatorios.Embarcador.DataSource.Cargas.TaxaIncidenciaFrete.TaxaIncidenciaFrete>(cancellationToken);
        }

        public async Task<IList<Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.AlteracaoFrete>> ConsultarRelatorioAlteracaoFreteAsync(
                FiltroPesquisaRelatorioAlteracaoFrete filtrosPesquisa,
                List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedades,
                Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta,
                CancellationToken cancellationToken)
        {
            var query = new ConsultaAlteracaoFrete().ObterSqlPesquisa(filtrosPesquisa, parametrosConsulta, propriedades).CriarSQLQuery(this.SessionNHiBernate)
                .SetResultTransformer(
                    NHibernate.Transform.Transformers.AliasToBean<
                        Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.AlteracaoFrete>());

            return await query
                .SetTimeout(600)
                .ListAsync<Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.AlteracaoFrete>(cancellationToken);
        }

        public int ContarConsultaRelatorioAlteracaoFrete(FiltroPesquisaRelatorioAlteracaoFrete filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedades)
        {
            var query = new ConsultaAlteracaoFrete().ObterSqlContarPesquisa(filtrosPesquisa, propriedades).CriarSQLQuery(this.SessionNHiBernate);

            return query.SetTimeout(600).UniqueResult<int>();
        }

        private string SqlRelatorioCargaPedidoEmbarcador(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaRelatorioCargaPedidoEmbarcador filtrosPesquisa)
        {
            string sqlFiltrosSelect = "";
            string sqlFiltrosPedido = string.Empty;

            string datePattern = "yyyy-MM-dd";
            if (filtrosPesquisa.DataInicial != DateTime.MinValue)
            {
                sqlFiltrosSelect += $" TABELA.DataPedido >= '" + filtrosPesquisa.DataInicial.ToString(datePattern) + " 00:00:00'";
                sqlFiltrosPedido += $" AND PED.PED_DATA_CRIACAO >= '" + filtrosPesquisa.DataInicial.ToString(datePattern) + " 00:00:00'";
            }

            if (filtrosPesquisa.DataFinal != DateTime.MinValue)
            {
                sqlFiltrosSelect += $" AND TABELA.DataPedido <= '" + filtrosPesquisa.DataFinal.ToString(datePattern) + " 23:59:59'";
                sqlFiltrosPedido += $" AND PED.PED_DATA_CRIACAO <= '" + filtrosPesquisa.DataFinal.ToString(datePattern) + " 23:59:59'";
            }

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.PedidoEmbarcador))
            {
                sqlFiltrosSelect += $" AND TABELA.NumeroEmbarcador = '" + filtrosPesquisa.PedidoEmbarcador + "' ";
                sqlFiltrosPedido += $" AND PED.PED_NUMERO_PEDIDO_EMBARCADOR = '" + filtrosPesquisa.PedidoEmbarcador + "' ";
            }

            // Antes de criticar.. teste a performance...
            // O IN em alguns momentos.. no ASSAI, está matando a consulta.. dando Timótio.
            if (filtrosPesquisa.CodigosFiliais?.Count > 1)
            {
                sqlFiltrosSelect += $" AND TABELA.FilialCodigo in ({string.Join(", ", filtrosPesquisa.CodigosFiliais)})";
                sqlFiltrosPedido += $" AND PED.FIL_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosFiliais)})";
            }
            else if (filtrosPesquisa.CodigosFiliais?.Count > 0)
            {
                sqlFiltrosSelect += $" AND TABELA.FilialCodigo = {filtrosPesquisa.CodigosFiliais.FirstOrDefault()}";
                sqlFiltrosPedido += $" AND PED.FIL_CODIGO = {filtrosPesquisa.CodigosFiliais.FirstOrDefault()}";
            }

            if (filtrosPesquisa.CodigosCanaisEntrega?.Count > 1)
            {
                sqlFiltrosSelect += $" AND TABELA.CanalEntregaCodigo in ({string.Join(", ", filtrosPesquisa.CodigosCanaisEntrega)})";
                sqlFiltrosPedido += $" AND PED.CNE_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosCanaisEntrega)})";
            }
            else if (filtrosPesquisa.CodigosCanaisEntrega?.Count > 0)
            {
                sqlFiltrosSelect += $" AND TABELA.CanalEntregaCodigo = {filtrosPesquisa.CodigosCanaisEntrega.FirstOrDefault()}";
                sqlFiltrosPedido += $" AND PED.CNE_CODIGO = {filtrosPesquisa.CodigosCanaisEntrega.FirstOrDefault()}";
            }

            if (filtrosPesquisa.CodigosTiposCarga?.Count > 1)
            {
                sqlFiltrosSelect += $" AND TABELA.TipoCargaCodigo in ({string.Join(", ", filtrosPesquisa.CodigosTiposCarga)})";
                sqlFiltrosPedido += $" AND PED.TCG_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosTiposCarga)})";
            }
            else if (filtrosPesquisa.CodigosTiposCarga?.Count > 0)
            {
                sqlFiltrosSelect += $" AND TABELA.TipoCargaCodigo = {filtrosPesquisa.CodigosTiposCarga.FirstOrDefault()}";
                sqlFiltrosPedido += $" AND PED.TCG_CODIGO = {filtrosPesquisa.CodigosTiposCarga.FirstOrDefault()}";
            }

            if (filtrosPesquisa.CodigosGrupoProduto?.Count > 1)
                sqlFiltrosSelect += $" AND TABELA.GrupoProdutoCodigo in ({string.Join(", ", filtrosPesquisa.CodigosGrupoProduto)})";
            else if (filtrosPesquisa.CodigosGrupoProduto?.Count > 0)
                sqlFiltrosSelect += $" AND TABELA.GrupoProdutoCodigo = {filtrosPesquisa.CodigosGrupoProduto.FirstOrDefault()}";

            if (filtrosPesquisa.CodigosDestinatario?.Count > 1)
            {
                sqlFiltrosSelect += $" AND TABELA.DestinatarioCodigo in ({string.Join(", ", filtrosPesquisa.CodigosDestinatario)})";
                sqlFiltrosPedido += $" AND PED.CLI_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosDestinatario)})";
            }
            else if (filtrosPesquisa.CodigosDestinatario?.Count > 0)
            {
                sqlFiltrosSelect += $" AND TABELA.DestinatarioCodigo = {filtrosPesquisa.CodigosDestinatario.FirstOrDefault()}";
                sqlFiltrosPedido += $" AND PED.CLI_CODIGO = {filtrosPesquisa.CodigosDestinatario.FirstOrDefault()}";
            }

            if (filtrosPesquisa.TipoOperacao?.Count > 1)
            {
                sqlFiltrosSelect += $" AND TABELA.TipoOperacaoCodigo in ({string.Join(", ", filtrosPesquisa.TipoOperacao)})";
                sqlFiltrosPedido += $" AND PED.TOP_CODIGO in ({string.Join(", ", filtrosPesquisa.TipoOperacao)})";
            }
            else if (filtrosPesquisa.TipoOperacao?.Count > 0)
            {
                sqlFiltrosSelect += $" AND TABELA.TipoOperacaoCodigo = {filtrosPesquisa.TipoOperacao.FirstOrDefault()}";
                sqlFiltrosPedido += $" AND PED.TOP_CODIGO = {filtrosPesquisa.TipoOperacao.FirstOrDefault()}";
            }

            if (filtrosPesquisa.CodigosProduto?.Count > 1)
                sqlFiltrosSelect += $" AND TABELA.CodigoIntegracao in ('{string.Join("', '", filtrosPesquisa.CodigosProduto)}')";
            else if (filtrosPesquisa.CodigosProduto?.Count > 0)
                sqlFiltrosSelect += $" AND TABELA.CodigoIntegracao = '{filtrosPesquisa.CodigosProduto.FirstOrDefault()}'";

            if (filtrosPesquisa.CodigosGrupoPessoa?.Count > 1)
                sqlFiltrosSelect += $" AND TABELA.CodigoGrupoPessoa in ({string.Join(", ", filtrosPesquisa.CodigosGrupoPessoa)})";
            else if (filtrosPesquisa.CodigosGrupoPessoa?.Count > 0)
                sqlFiltrosSelect += $" AND TABELA.CodigoGrupoPessoa = {filtrosPesquisa.CodigosGrupoPessoa.FirstOrDefault()}";

            if (filtrosPesquisa.StatusPedido != null)
            {
                foreach (var status in filtrosPesquisa.StatusPedido)
                {
                    switch (status)
                    {
                        case Dominio.ObjetosDeValor.Embarcador.Enumeradores.StatusPedidoEmbarcadorAssai.Liberado:
                            sqlFiltrosSelect += $" and TABELA.PedidoCodigo not in (SELECT CargaPedido.PED_CODIGO FROM T_CARGA Carga JOIN T_CARGA_PEDIDO CargaPedido on CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO)";
                            sqlFiltrosSelect += $" and TABELA.PedidoCodigo not in (SELECT CarregamentoPedido.PED_CODIGO FROM T_CARREGAMENTO_PEDIDO CarregamentoPedido JOIN T_CARREGAMENTO Carregamento on Carregamento.CRG_CODIGO = CarregamentoPedido.CRG_CODIGO)";
                            break;
                        case Dominio.ObjetosDeValor.Embarcador.Enumeradores.StatusPedidoEmbarcadorAssai.Faturado:
                            sqlFiltrosSelect += $" and TABELA.PedidoCodigo in (SELECT CargaPedido.PED_CODIGO FROM T_CARGA Carga JOIN T_CARGA_PEDIDO CargaPedido on CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO)";
                            sqlFiltrosSelect += $" and TABELA.PedidoCodigo not in (SELECT CarregamentoPedido.PED_CODIGO FROM T_CARREGAMENTO_PEDIDO CarregamentoPedido JOIN T_CARREGAMENTO Carregamento on Carregamento.CRG_CODIGO = CarregamentoPedido.CRG_CODIGO)";
                            break;
                        case Dominio.ObjetosDeValor.Embarcador.Enumeradores.StatusPedidoEmbarcadorAssai.EmCarregamento:
                            sqlFiltrosSelect += $" and TABELA.PedidoCodigo in (SELECT CarregamentoPedido.PED_CODIGO FROM T_CARREGAMENTO_PEDIDO CarregamentoPedido JOIN T_CARREGAMENTO Carregamento on Carregamento.CRG_CODIGO = CarregamentoPedido.CRG_CODIGO)";
                            sqlFiltrosSelect += $" and TABELA.PedidoCodigo not in (SELECT CargaPedido.PED_CODIGO FROM T_CARGA Carga JOIN T_CARGA_PEDIDO CargaPedido on CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO)";
                            break;
                    }
                }
            }

            //Alterado a consulta das notas fiscais do pedido para buscar pelo PED_CODIGO e não buscar dos PED_PRE_CARGA.
            //in (select pei.ped_codigo from t_pedido pei where pei.PED_PRE_CARGA = PED.PED_CODIGO)

            string sqlQuery =
                @"
                SELECT 
	            TABELA.FilialDescricao,
	            TABELA.NumeroEmbarcador,
	            TABELA.DataPedido,
	            TABELA.CodigoIntegracao,
	            TABELA.CodigoProdutoEmbarcador,
	            TABELA.NomeProdutoEmbarcador,
	            TABELA.QuantidadeEmbalagem,
	            TABELA.PesoUnitario,
	            TABELA.Quantidade,
	            TABELA.PesoTotalKG,
	            TABELA.MetroCubico,
	            TABELA.QuantidadePallet,
	            TABELA.QuantidadeCaixaPorPallet,
	            TABELA.PalletFechado,
	            TABELA.NumeroCarga,
	            TABELA.NotasFiscais,
	            TABELA.SessaoRoteirizador,
	            TABELA.GrupoPessoas,
	            TABELA.SituacaoPedidoProduto,
	            TABELA.TipoCargaDescricao,
	            TABELA.CanalEntregaDescricao,
	            TABELA.TipoOperacaoDescricao,
	            TABELA.GrupoProdutoDescricao,
	            TABELA.LinhaSeparacaoDescricao 
          FROM (
                SELECT
                TIP.TCG_CODIGO										             TipoCargaCodigo,
	            TIP.TCG_DESCRICAO									             TipoCargaDescricao,
	            CNE.CNE_CODIGO										             CanalEntregaCodigo,
	            CNE.CNE_DESCRICAO									             CanalEntregaDescricao,
	            OPE.TOP_CODIGO										             TipoOperacaoCodigo,
	            OPE.TOP_DESCRICAO									             TipoOperacaoDescricao,
	            GPR.GPR_CODIGO										             GrupoProdutoCodigo,
	            GPR.GRP_DESCRICAO									             GrupoProdutoDescricao,
	            LIN.CLS_CODIGO										             LinhaSeparacaoCodigo,
	            LIN.CLS_DESCRICAO									             LinhaSeparacaoDescricao,	   
	            PED.CLI_CODIGO										             DestinatarioCodigo,
	            FIL.FIL_CODIGO										             FilialCodigo,
                FIL.FIL_DESCRICAO                                                FilialDescricao, 
                PED.PED_CODIGO                                                   PedidoCodigo,
                PED.PED_NUMERO_PEDIDO_EMBARCADOR                                 NumeroEmbarcador, 
                PED.PED_DATA_CRIACAO                                             DataPedido, 
                CLI.CLI_CODIGO_INTEGRACAO                                        CodigoIntegracao, 
                PEM.PRO_CODIGO_PRODUTO_EMBARCADOR                                CodigoProdutoEmbarcador, 
                PEM.GRP_DESCRICAO                                                NomeProdutoEmbarcador, 
                PEM.PRO_QUANTIDADE_CAIXA                                         QuantidadeEmbalagem, 
                (PEM.PRO_PESO_UNITARIO * PEM.PRO_QUANTIDADE_CAIXA)	             PesoUnitario, 
                CPP.CPP_QUANTIDADE                                               Quantidade, 
                CRO.CPP_PESO                                                     PesoTotalKG, 
                CRO.CPP_METRO_CUBICO                                             MetroCubico, 
                CRO.CPP_QUANTIDADE_PALLET                                        QuantidadePallet, 
                PEM.PRO_QUANTIDADE_CAIXA_POR_PALLET                              QuantidadeCaixaPorPallet, 
                CASE PRP.PRP_PALLET_FECHADO 
                     WHEN 0 
                     THEN 'Não' ELSE 'Sim' 
                END                                                              PalletFechado, 
                CAR.CAR_CODIGO_CARGA_EMBARCADOR 			                     NumeroCarga, 
                substring((SELECT DISTINCT ', ' + CAST(NotaFiscal.NF_NUMERO as varchar) FROM T_PEDIDO_XML_NOTA_FISCAL PedidoNotaFiscal JOIN T_XML_NOTA_FISCAL NotaFiscal on PedidoNotaFiscal.NFX_CODIGO = NotaFiscal.NFX_CODIGO JOIN T_CARGA_PEDIDO CargaPedido ON PedidoNotaFiscal.CPE_CODIGO = CargaPedido.CPE_CODIGO where CargaPedido.PED_CODIGO = PED.PED_CODIGO for xml path('')), 3, 200) NotasFiscais, 
                CAST(SRP.SRO_CODIGO as VARCHAR)                                  SessaoRoteirizador, 
                PEM.GRP_CODIGO_PESSOA								             CodigoGrupoPessoa,
                GRP.GRP_DESCRICAO                                                GrupoPessoas, 
                'Em Carga'                                                       SituacaoPedidoProduto
            FROM T_CARGA CAR INNER JOIN T_CARGA_PEDIDO			CPE ON CPE.CAR_CODIGO = CAR.CAR_CODIGO AND CAR.CAR_SITUACAO <> 13 
							 INNER JOIN T_PEDIDO				PED ON CPE.PED_CODIGO = PED.PED_CODIGO #BINDPEDIDO#
							 INNER JOIN T_PEDIDO_PRODUTO		PRP ON PED.PED_CODIGO = PRP.PED_CODIGO
							 LEFT JOIN T_LINHA_SEPARACAO		LIN	ON PRP.CLS_CODIGO = LIN.CLS_CODIGO
							 INNER JOIN T_FILIAL				FIL ON PED.FIL_CODIGO = FIL.FIL_CODIGO
							 INNER JOIN T_CLIENTE				CLI ON PED.CLI_CODIGO = CLI.CLI_CGCCPF 
							 LEFT JOIN T_GRUPO_PESSOAS			GRP ON CLI.GRP_CODIGO = GRP.GRP_CODIGO
							 INNER JOIN T_CARGA_PEDIDO_PRODUTO	CPP ON CPP.CPE_CODIGO = CPE.CPE_CODIGO 
							 INNER JOIN T_PRODUTO_EMBARCADOR	PEM ON PEM.PRO_CODIGO = CPP.PRO_CODIGO AND PEM.PRO_CODIGO = PRP.PRO_CODIGO
							 LEFT JOIN T_GRUPO_PRODUTO			GPR ON PEM.GRP_CODIGO = GPR.GPR_CODIGO
							 INNER JOIN T_CARREGAMENTO			CRG ON CAR.CRG_CODIGO = CRG.CRG_CODIGO AND CRG.CRG_SITUACAO = 2 
							 INNER JOIN T_CARREGAMENTO_PEDIDO	CRP ON CRG.CRG_CODIGO = CRP.CRG_CODIGO AND CRP.PED_CODIGO = PED.PED_CODIGO
							 INNER JOIN T_CARREGAMENTO_PEDIDO_PRODUTO CRO ON CRP.CRP_CODIGO = CRO.CRP_CODIGO AND CRO.PRP_CODIGO = PRP.PRP_CODIGO
							 LEFT JOIN T_SESSAO_ROTEIRIZADOR_PEDIDO  SRP ON PED.PED_CODIGO = SRP.PED_CODIGO 
							 LEFT JOIN T_TIPO_DE_CARGA			TIP ON TIP.TCG_CODIGO = PED.TCG_CODIGO
							 LEFT JOIN T_CANAL_ENTREGA			CNE ON PED.CNE_CODIGO = CNE.CNE_CODIGO
							 LEFT JOIN T_TIPO_OPERACAO			OPE ON PED.TOP_CODIGO = OPE.TOP_CODIGO  
          WHERE 1 = 1 ";
            // AND SRP.SRP_SITUACAO <> 4

            sqlQuery = sqlQuery.Replace("#BINDPEDIDO#", sqlFiltrosPedido);

            if (filtrosPesquisa.DataInicial != DateTime.MinValue)
                sqlQuery += $" AND PED.PED_DATA_CRIACAO >= '" + filtrosPesquisa.DataInicial.ToString(datePattern) + " 00:00:00'";

            if (filtrosPesquisa.DataFinal != DateTime.MinValue)
                sqlQuery += $" AND PED.PED_DATA_CRIACAO <= '" + filtrosPesquisa.DataFinal.ToString(datePattern) + " 23:59:59'";

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.PedidoEmbarcador))
                sqlQuery += $" AND PED.PED_NUMERO_PEDIDO_EMBARCADOR = '" + filtrosPesquisa.PedidoEmbarcador + "' ";

            if (filtrosPesquisa.CodigosFiliais?.Count > 1)
                sqlQuery += $" AND FIL.FIL_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosFiliais)})";
            else if (filtrosPesquisa.CodigosFiliais?.Count > 0)
                sqlQuery += $" AND FIL.FIL_CODIGO = {filtrosPesquisa.CodigosFiliais.FirstOrDefault()}";

            if (filtrosPesquisa.TipoOperacao?.Count > 1)
                sqlQuery += $" AND OPE.TOP_CODIGO in ({string.Join(", ", filtrosPesquisa.TipoOperacao)})";
            else if (filtrosPesquisa.TipoOperacao?.Count > 0)
                sqlQuery += $" AND OPE.TOP_CODIGO = {filtrosPesquisa.TipoOperacao.FirstOrDefault()}";

            //
            // in (select pei.ped_codigo from t_pedido pei where pei.PED_PRE_CARGA = PED.PED_CODIGO)
            sqlQuery +=
                @"
                UNION 

                SELECT 
                TIP.TCG_CODIGO							                          TipoCargaCodigo,
	            TIP.TCG_DESCRICAO   				                              TipoCargaDescricao,
	            CNE.CNE_CODIGO													  CanalEntregaCodigo,
	            CNE.CNE_DESCRICAO									              CanalEntregaDescricao,
	            OPE.TOP_CODIGO										              TipoOperacaoCodigo,
	            OPE.TOP_DESCRICAO									              TipoOperacaoDescricao,
	            GPR.GPR_CODIGO										              GrupoProdutoCodigo,
	            GPR.GRP_DESCRICAO									              GrupoProdutoDescricao,
	            LIN.CLS_CODIGO										              LinhaSeparacaoCodigo,
	            LIN.CLS_DESCRICAO									              LinhaSeparacaoDescricao,	   
	            PED.CLI_CODIGO										              DestinatarioCodigo,
	            FIL.FIL_CODIGO										              FilialCodigo,
	            FIL.FIL_DESCRICAO									              FilialDescricao, 
                PED.PED_CODIGO                                                    PedidoCodigo,
                PED.PED_NUMERO_PEDIDO_EMBARCADOR                                  NumeroEmbarcador , 
                PED.PED_DATA_CRIACAO                                              DataPedido, 
                CLI.CLI_CODIGO_INTEGRACAO                                         CodigoIntegracao, 
                PEM.PRO_CODIGO_PRODUTO_EMBARCADOR                                 CodigoProdutoEmbarcador, 
                PEM.GRP_DESCRICAO                                                 NomeProdutoEmbarcador, 
                PEM.PRO_QUANTIDADE_CAIXA                                          QuantidadeEmbalagem, 
                (PEM.PRO_PESO_UNITARIO * PEM.PRO_QUANTIDADE_CAIXA)	              PesoUnitario , 
                PRP.PRP_QUANTIDADE - PNA.QTDE_CARREGADO                           Quantidade , 
                PNA.SALDO_PRODUTO PesoTotalKG, 
                PRP.PRP_METRO_CUBICO - PNA.METRO_CARREGADO                        MetroCubico , 
                PRP.PRP_QUANTIDADE_PALET - PNA.QTDE_PALLET_CARREGADO              QuantidadePallet , 
                PEM.PRO_QUANTIDADE_CAIXA_POR_PALLET                               QuantidadeCaixaPorPallet, 
                CASE PRP.PRP_PALLET_FECHADO 
                   WHEN 0 
                   THEN 'Não' 
                   ELSE 'Sim' 
                END                                                               PalletFechado, 
                 ''                                                               NumeroCarga , 
                substring((SELECT DISTINCT ', ' + CAST(NotaFiscal.NF_NUMERO as varchar) FROM T_PEDIDO_XML_NOTA_FISCAL PedidoNotaFiscal JOIN T_XML_NOTA_FISCAL NotaFiscal on PedidoNotaFiscal.NFX_CODIGO = NotaFiscal.NFX_CODIGO JOIN T_CARGA_PEDIDO CargaPedido ON PedidoNotaFiscal.CPE_CODIGO = CargaPedido.CPE_CODIGO where CargaPedido.PED_CODIGO = PED.PED_CODIGO for xml path('')), 3, 200) NotasFiscais,  
                ''                                                                 SessaoRoteirizador, 
                0								                                   CodigoGrupoPessoa,
                GRP.GRP_DESCRICAO                                                  GrupoPessoas, 
                case when PED.PED_SITUACAO = 1 then 'Em Aberto'
				     when PED.PED_SITUACAO = 2 then 'Cancelado'                                                     
					 when PED.PED_SITUACAO = 3 then 'Finalizado'
					 when PED.PED_SITUACAO = 4 then 'Ag. Aprovação'
				     when PED.PED_SITUACAO = 7 then 'Autorização Pendente'                                                     
					 when PED.PED_SITUACAO = 5 then 'Rejeitado'
					 else 'Outro' end                                               SituacaoPedidoProduto

            FROM T_PRODUTO_EMBARCADOR PEM INNER JOIN T_PEDIDO_PRODUTO	PRP ON PEM.PRO_CODIGO = PRP.PRO_CODIGO
										   LEFT JOIN T_LINHA_SEPARACAO	LIN	ON PRP.CLS_CODIGO = LIN.CLS_CODIGO 
										  INNER JOIN T_PEDIDO			PED ON PED.PED_CODIGO = PRP.PED_CODIGO #BINDPEDIDO1#
                                           LEFT JOIN T_TIPO_DE_CARGA    TIP	ON TIP.TCG_CODIGO = PED.TCG_CODIGO	
										  INNER JOIN T_FILIAL			FIL ON PED.FIL_CODIGO = FIL.FIL_CODIGO
										  INNER JOIN T_CLIENTE			CLI ON PED.CLI_CODIGO = CLI.CLI_CGCCPF 
										   LEFT JOIN T_GRUPO_PESSOAS	GRP ON CLI.GRP_CODIGO = GRP.GRP_CODIGO
										   LEFT JOIN T_CANAL_ENTREGA	CNE ON PED.CNE_CODIGO = CNE.CNE_CODIGO
										   LEFT JOIN T_TIPO_OPERACAO	OPE ON PED.TOP_CODIGO = OPE.TOP_CODIGO
										   LEFT JOIN T_GRUPO_PRODUTO	GPR ON PEM.GRP_CODIGO = GPR.GPR_CODIGO AND GPR.GPR_CODIGO = PEM.GRP_CODIGO 

 INNER JOIN (SELECT
                    PNA.PED_CODIGO,
                    PNA.PRP_CODIGO,
					PNA.QTDE_PRODUTO,
                    PNA.PESO_TOTAL_PEDIDO_PRODUTO,
                    PNA.PESO_CARREGADO,
                    PNA.QTDE_CARREGADO,
                    PNA.QTDE_PALLET_CARREGADO,
                    PNA.METRO_CARREGADO,
                    (PNA.PESO_TOTAL_PEDIDO_PRODUTO - PNA.PESO_CARREGADO) SALDO_PRODUTO,     
					(PNA.QTDE_PRODUTO - PNA.QTDE_CARREGADO) SALDO_PRODUTO_QTDE                 
                FROM
                    (SELECT
                        PPO.PED_CODIGO,
                        PPO.PRP_CODIGO,
						PPO.PRP_QUANTIDADE	QTDE_PRODUTO,
                        MIN(PPO.PRP_QUANTIDADE * PRP_PESO_UNITARIO) PESO_TOTAL_PEDIDO_PRODUTO,
                        SUM(CPP.CPP_PESO)                           PESO_CARREGADO,
                        SUM(CPP.CPP_QUANTIDADE)                     QTDE_CARREGADO,
                        SUM(CPP.CPP_QUANTIDADE_PALLET)              QTDE_PALLET_CARREGADO,
                        SUM(CPP.CPP_METRO_CUBICO)                   METRO_CARREGADO                           
                    FROM
                        T_PEDIDO                         PED,
                        T_PEDIDO_PRODUTO                 PPO,
                        T_CARREGAMENTO_PEDIDO_PRODUTO    CPP,
                        T_CARREGAMENTO_PEDIDO            CPE,
                        T_CARREGAMENTO                   CRG                           
                    WHERE
                        CRG.CRG_SITUACAO = 2                                
                        AND CRG.CRG_CODIGO = CPE.CRG_CODIGO                                
                        AND CPE.CRP_CODIGO = CPP.CRP_CODIGO                                
                        AND CPP.PRP_CODIGO = PPO.PRP_CODIGO                                
                        AND PPO.PED_CODIGO = PED.PED_CODIGO                                
                        AND PED.PED_CODIGO = CPE.PED_CODIGO                                
                        AND PED.PED_TOTALMENTE_CARREGADO = 0                                
                        AND PED.PED_SITUACAO <> 2        
                        #BINDSUB# 
                    GROUP BY
                        PPO.PED_CODIGO,
                        PPO.PRP_CODIGO,
						PPO.PRP_QUANTIDADE) PNA                           
                WHERE 
                    PNA.QTDE_PRODUTO > PNA.QTDE_CARREGADO 
                ) PNA ON PRP.PRP_CODIGO = PNA.PRP_CODIGO    AND PED.PED_CODIGO = PNA.PED_CODIGO 
      WHERE 1 = 1 ";

            sqlQuery = sqlQuery.Replace("#BINDPEDIDO1#", sqlFiltrosPedido);

            string sqlQuerySub = string.Empty;

            if (filtrosPesquisa.DataInicial != DateTime.MinValue)
            {
                sqlQuery += $" AND PED.PED_DATA_CRIACAO >= '" + filtrosPesquisa.DataInicial.ToString(datePattern) + " 00:00:00'";
                sqlQuerySub += $" AND PED.PED_DATA_CRIACAO >= '" + filtrosPesquisa.DataInicial.ToString(datePattern) + " 00:00:00'";
            }

            if (filtrosPesquisa.DataFinal != DateTime.MinValue)
            {
                sqlQuery += $" AND PED.PED_DATA_CRIACAO <= '" + filtrosPesquisa.DataFinal.ToString(datePattern) + " 23:59:59'";
                sqlQuerySub += $" AND PED.PED_DATA_CRIACAO <= '" + filtrosPesquisa.DataFinal.ToString(datePattern) + " 23:59:59'";
            }

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.PedidoEmbarcador))
            {
                sqlQuery += $" AND PED.PED_NUMERO_PEDIDO_EMBARCADOR = '" + filtrosPesquisa.PedidoEmbarcador + "' ";
                sqlQuerySub += $" AND PED.PED_NUMERO_PEDIDO_EMBARCADOR = '" + filtrosPesquisa.PedidoEmbarcador + "' ";
            }

            if (filtrosPesquisa.CodigosFiliais?.Count > 1)
            {
                sqlQuery += $" AND FIL.FIL_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosFiliais)})";
                sqlQuerySub += $" AND PED.FIL_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosFiliais)})";
            }
            else if (filtrosPesquisa.CodigosFiliais?.Count > 0)
            {
                sqlQuery += $" AND FIL.FIL_CODIGO = {filtrosPesquisa.CodigosFiliais.FirstOrDefault()}";
                sqlQuerySub += $" AND PED.FIL_CODIGO = {filtrosPesquisa.CodigosFiliais.FirstOrDefault()}";
            }

            if (filtrosPesquisa.TipoOperacao?.Count > 1)
            {
                sqlQuery += $" AND OPE.TOP_CODIGO in ({string.Join(", ", filtrosPesquisa.TipoOperacao)})";
                sqlQuerySub += $" AND PED.TOP_CODIGO in ({string.Join(", ", filtrosPesquisa.TipoOperacao)})";
            }
            else if (filtrosPesquisa.TipoOperacao?.Count > 0)
            {
                sqlQuery += $" AND OPE.TOP_CODIGO = {filtrosPesquisa.TipoOperacao.FirstOrDefault()}";
                sqlQuerySub += $" AND PED.TOP_CODIGO = {filtrosPesquisa.TipoOperacao.FirstOrDefault()}";
            }

            sqlQuery = sqlQuery.Replace("#BINDSUB#", sqlQuerySub);
            sqlQuerySub = string.Empty;

            // Agora vamos fazer union com os cancelamentos de reserva...
            //in (select pei.ped_codigo from t_pedido pei where pei.PED_PRE_CARGA = PED.PED_CODIGO)

            sqlQuery += @"
                UNION 
                SELECT 
                TIP.TCG_CODIGO							                          TipoCargaCodigo,
	            TIP.TCG_DESCRICAO   				                              TipoCargaDescricao,
	            CNE.CNE_CODIGO													  CanalEntregaCodigo,
	            CNE.CNE_DESCRICAO									              CanalEntregaDescricao,
	            OPE.TOP_CODIGO										              TipoOperacaoCodigo,
	            OPE.TOP_DESCRICAO									              TipoOperacaoDescricao,
	            GPR.GPR_CODIGO										              GrupoProdutoCodigo,
	            GPR.GRP_DESCRICAO									              GrupoProdutoDescricao,
	            LIN.CLS_CODIGO										              LinhaSeparacaoCodigo,
	            LIN.CLS_DESCRICAO									              LinhaSeparacaoDescricao,		   
	            PED.CLI_CODIGO										              DestinatarioCodigo,
	            FIL.FIL_CODIGO										              FilialCodigo,
	            FIL.FIL_DESCRICAO									              FilialDescricao, 
                PED.PED_CODIGO                                                    PedidoCodigo,
                PED.PED_NUMERO_PEDIDO_EMBARCADOR                                  NumeroEmbarcador , 
                PED.PED_DATA_CRIACAO                                              DataPedido, 
                CLI.CLI_CODIGO_INTEGRACAO                                         CodigoIntegracao, 
                PEM.PRO_CODIGO_PRODUTO_EMBARCADOR                                 CodigoProdutoEmbarcador, 
                PEM.GRP_DESCRICAO                                                 NomeProdutoEmbarcador, 
                PEM.PRO_QUANTIDADE_CAIXA                                          QuantidadeEmbalagem, 
                (PEM.PRO_PESO_UNITARIO * PEM.PRO_QUANTIDADE_CAIXA)	              PesoUnitario , 
                PPC.CPP_QUANTIDADE											      Quantidade , 
                PPC.CPP_PESO													  PesoTotalKG, 
                PPC.CPP_METRO_CUBICO                                              MetroCubico , 
                PPC.CPP_QUANTIDADE_PALLET										  QuantidadePallet , 
                PEM.PRO_QUANTIDADE_CAIXA_POR_PALLET                               QuantidadeCaixaPorPallet, 
                CASE PRP.PRP_PALLET_FECHADO 
                   WHEN 0 
                   THEN 'Não' 
                   ELSE 'Sim' 
                END                                                               PalletFechado, 
                 ''                                                               NumeroCarga , 
                substring((SELECT DISTINCT ', ' + CAST(NotaFiscal.NF_NUMERO as varchar) FROM T_PEDIDO_XML_NOTA_FISCAL PedidoNotaFiscal JOIN T_XML_NOTA_FISCAL NotaFiscal on PedidoNotaFiscal.NFX_CODIGO = NotaFiscal.NFX_CODIGO JOIN T_CARGA_PEDIDO CargaPedido ON PedidoNotaFiscal.CPE_CODIGO = CargaPedido.CPE_CODIGO where CargaPedido.PED_CODIGO = PED.PED_CODIGO for xml path('')), 3, 200) NotasFiscais,  
                ''                                                                 SessaoRoteirizador, 
                0								                                   CodigoGrupoPessoa,
                GRP.GRP_DESCRICAO                                                  GrupoPessoas, 
                'Cancelado Reserva' SituacaoPedidoProduto
					 
                FROM T_PRODUTO_EMBARCADOR PEM INNER JOIN T_PEDIDO_PRODUTO PRP ON PEM.PRO_CODIGO = PRP.PRO_CODIGO 
					 INNER JOIN T_PEDIDO PED			ON PED.PED_CODIGO = PRP.PED_CODIGO #BINDPEDIDO2# 
                      LEFT JOIN T_TIPO_DE_CARGA  TIP	ON TIP.TCG_CODIGO = PED.TCG_CODIGO	
					 INNER JOIN T_PEDIDO_CANCELAMENTO_RESERVA_INTEGRACAO CRI ON PED.PED_CODIGO = CRI.PED_CODIGO
					 INNER JOIN T_PEDIDO_PRODUTO_CANCELAMENTO_RESERVA_INTEGRACAO PPC ON CRI.CPI_CODIGO = PPC.CPI_CODIGO AND PPC.PRP_CODIGO = PRP.PRP_CODIGO
					 INNER JOIN T_FILIAL FIL			ON PED.FIL_CODIGO = FIL.FIL_CODIGO 
					 INNER JOIN T_CLIENTE CLI			ON PED.CLI_CODIGO = CLI.CLI_CGCCPF
					 LEFT JOIN T_GRUPO_PESSOAS GRP		ON CLI.GRP_CODIGO = GRP.GRP_CODIGO 
					 LEFT JOIN T_CANAL_ENTREGA CNE		ON PED.CNE_CODIGO = CNE.CNE_CODIGO
					 LEFT JOIN T_TIPO_OPERACAO OPE		ON PED.TOP_CODIGO = OPE.TOP_CODIGO
					 INNER JOIN T_GRUPO_PRODUTO GPR		ON GPR.GPR_CODIGO = PEM.GRP_CODIGO
					 INNER JOIN T_LINHA_SEPARACAO LIN	ON LIN.CLS_CODIGO = PRP.CLS_CODIGO 

               WHERE 1 = 1 ";

            sqlQuery = sqlQuery.Replace("#BINDPEDIDO2#", sqlFiltrosPedido);

            if (filtrosPesquisa.DataInicial != DateTime.MinValue)
                sqlQuery += $" AND PED.PED_DATA_CRIACAO >= '" + filtrosPesquisa.DataInicial.ToString(datePattern) + " 00:00:00'";

            if (filtrosPesquisa.DataFinal != DateTime.MinValue)
                sqlQuery += $" AND PED.PED_DATA_CRIACAO <= '" + filtrosPesquisa.DataFinal.ToString(datePattern) + " 23:59:59'";

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.PedidoEmbarcador))
                sqlQuery += $" AND PED.PED_NUMERO_PEDIDO_EMBARCADOR = '" + filtrosPesquisa.PedidoEmbarcador + "' ";

            if (filtrosPesquisa.CodigosFiliais?.Count > 1)
                sqlQuery += $" AND FIL.FIL_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosFiliais)})";
            else if (filtrosPesquisa.CodigosFiliais?.Count > 0)
                sqlQuery += $" AND FIL.FIL_CODIGO = {filtrosPesquisa.CodigosFiliais.FirstOrDefault()}";

            if (filtrosPesquisa.TipoOperacao?.Count > 1)
                sqlQuery += $" AND OPE.TOP_CODIGO in ({string.Join(", ", filtrosPesquisa.TipoOperacao)})";
            else if (filtrosPesquisa.TipoOperacao?.Count > 0)
                sqlQuery += $" AND OPE.TOP_CODIGO = {filtrosPesquisa.TipoOperacao.FirstOrDefault()}";

            // in (select pei.ped_codigo from t_pedido pei where pei.PED_PRE_CARGA = PED.PED_CODIGO)
            sqlQuery +=
                @"
                UNION 
                SELECT 
                TIP.TCG_CODIGO							                          TipoCargaCodigo,
	            TIP.TCG_DESCRICAO   				                              TipoCargaDescricao,
	            CNE.CNE_CODIGO													  CanalEntregaCodigo,
	            CNE.CNE_DESCRICAO									              CanalEntregaDescricao,
	            OPE.TOP_CODIGO										              TipoOperacaoCodigo,
	            OPE.TOP_DESCRICAO									              TipoOperacaoDescricao,
	            GPR.GPR_CODIGO										              GrupoProdutoCodigo,
	            GPR.GRP_DESCRICAO									              GrupoProdutoDescricao,
	            LIN.CLS_CODIGO										              LinhaSeparacaoCodigo,
	            LIN.CLS_DESCRICAO									              LinhaSeparacaoDescricao,		   
	            PED.CLI_CODIGO										              DestinatarioCodigo,
	            FIL.FIL_CODIGO										              FilialCodigo,
	            FIL.FIL_DESCRICAO									              FilialDescricao, 
                PED.PED_CODIGO                                                    PedidoCodigo,
                PED.PED_NUMERO_PEDIDO_EMBARCADOR                                  NumeroEmbarcador , 
                PED.PED_DATA_CRIACAO                                              DataPedido, 
                CLI.CLI_CODIGO_INTEGRACAO                                         CodigoIntegracao, 
                PEM.PRO_CODIGO_PRODUTO_EMBARCADOR                                 CodigoProdutoEmbarcador, 
                PEM.GRP_DESCRICAO                                                 NomeProdutoEmbarcador, 
                PEM.PRO_QUANTIDADE_CAIXA                                          QuantidadeEmbalagem, 
                (PEM.PRO_PESO_UNITARIO * PEM.PRO_QUANTIDADE_CAIXA)	              PesoUnitario , 
                PRP.PRP_QUANTIDADE											      Quantidade , 
                (PRP.PRP_QUANTIDADE * PRP_PESO_UNITARIO)						  PesoTotalKG, 
                PRP.PRP_METRO_CUBICO                                              MetroCubico , 
                PRP.PRP_QUANTIDADE_PALET										  QuantidadePallet , 
                PEM.PRO_QUANTIDADE_CAIXA_POR_PALLET                               QuantidadeCaixaPorPallet, 
                CASE PRP.PRP_PALLET_FECHADO 
                   WHEN 0 
                   THEN 'Não' 
                   ELSE 'Sim' 
                END                                                               PalletFechado, 
                 ''                                                               NumeroCarga , 
                substring((SELECT DISTINCT ', ' + CAST(NotaFiscal.NF_NUMERO as varchar) FROM T_PEDIDO_XML_NOTA_FISCAL PedidoNotaFiscal JOIN T_XML_NOTA_FISCAL NotaFiscal on PedidoNotaFiscal.NFX_CODIGO = NotaFiscal.NFX_CODIGO JOIN T_CARGA_PEDIDO CargaPedido ON PedidoNotaFiscal.CPE_CODIGO = CargaPedido.CPE_CODIGO where CargaPedido.PED_CODIGO = PED.PED_CODIGO for xml path('')), 3, 200) NotasFiscais,  
                ''                                                                 SessaoRoteirizador, 
                0								                                   CodigoGrupoPessoa,
                GRP.GRP_DESCRICAO                                                  GrupoPessoas, 
                case when PED.PED_SITUACAO = 1 then 'Em Aberto'
				     when PED.PED_SITUACAO = 2 then 'Cancelado'                                                     
					 when PED.PED_SITUACAO = 3 then 'Finalizado'
					 when PED.PED_SITUACAO = 4 then 'Ag. Aprovação'
				     when PED.PED_SITUACAO = 7 then 'Autorização Pendente'                                                     
					 when PED.PED_SITUACAO = 5 then 'Rejeitado'
					 else 'Outro' end SituacaoPedidoProduto

                FROM T_PRODUTO_EMBARCADOR PEM INNER JOIN T_PEDIDO_PRODUTO PRP ON PEM.PRO_CODIGO = PRP.PRO_CODIGO 
					 INNER JOIN T_PEDIDO PED			ON PED.PED_CODIGO = PRP.PED_CODIGO #BINDPEDIDO3#
                      LEFT JOIN T_TIPO_DE_CARGA  TIP	ON TIP.TCG_CODIGO = PED.TCG_CODIGO	
					 INNER JOIN T_FILIAL FIL			ON PED.FIL_CODIGO = FIL.FIL_CODIGO 
					 INNER JOIN T_CLIENTE CLI			ON PED.CLI_CODIGO = CLI.CLI_CGCCPF
					 LEFT JOIN T_GRUPO_PESSOAS GRP		ON CLI.GRP_CODIGO = GRP.GRP_CODIGO 
					 LEFT JOIN T_CANAL_ENTREGA CNE		ON PED.CNE_CODIGO = CNE.CNE_CODIGO
					 LEFT JOIN T_TIPO_OPERACAO OPE		ON PED.TOP_CODIGO = OPE.TOP_CODIGO
					 INNER JOIN T_GRUPO_PRODUTO GPR		ON GPR.GPR_CODIGO = PEM.GRP_CODIGO
					 INNER JOIN T_LINHA_SEPARACAO LIN	ON LIN.CLS_CODIGO = PRP.CLS_CODIGO 

               WHERE 
                       NOT EXISTS (SELECT 1 FROM T_CARREGAMENTO_PEDIDO CPE, T_CARREGAMENTO CRG WHERE CRG.CRG_CODIGO = CPE.CRG_CODIGO AND PED.PED_CODIGO = CPE.PED_CODIGO AND CRG.CRG_SITUACAO <> 3)
                       AND NOT EXISTS (SELECT 1 FROM T_CARGA_PEDIDO CPE, T_CARGA CAR WHERE CAR.CAR_CODIGO = CPE.CAR_CODIGO AND PED.PED_CODIGO = CPE.PED_CODIGO AND CAR.CAR_SITUACAO <> 13) ";

            sqlQuery = sqlQuery.Replace("#BINDPEDIDO3#", sqlFiltrosPedido);

            if (filtrosPesquisa.DataInicial != DateTime.MinValue)
                sqlQuery += $" AND PED.PED_DATA_CRIACAO >= '" + filtrosPesquisa.DataInicial.ToString(datePattern) + " 00:00:00'";

            if (filtrosPesquisa.DataFinal != DateTime.MinValue)
                sqlQuery += $" AND PED.PED_DATA_CRIACAO <= '" + filtrosPesquisa.DataFinal.ToString(datePattern) + " 23:59:59'";

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.PedidoEmbarcador))
                sqlQuery += $" AND PED.PED_NUMERO_PEDIDO_EMBARCADOR = '" + filtrosPesquisa.PedidoEmbarcador + "' ";

            if (filtrosPesquisa.CodigosFiliais?.Count > 1)
                sqlQuery += $" AND FIL.FIL_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosFiliais)})";
            else if (filtrosPesquisa.CodigosFiliais?.Count > 0)
                sqlQuery += $" AND FIL.FIL_CODIGO = {filtrosPesquisa.CodigosFiliais.FirstOrDefault()}";

            if (filtrosPesquisa.TipoOperacao?.Count > 1)
                sqlQuery += $" AND OPE.TOP_CODIGO in ({string.Join(", ", filtrosPesquisa.TipoOperacao)})";
            else if (filtrosPesquisa.TipoOperacao?.Count > 0)
                sqlQuery += $" AND OPE.TOP_CODIGO = {filtrosPesquisa.TipoOperacao.FirstOrDefault()}";

            sqlQuery += ") TABELA WHERE ";

            sqlQuery += sqlFiltrosSelect;

            return sqlQuery;
        }

        public int ContarRelatorioCargaPedidoEmbarcador(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaRelatorioCargaPedidoEmbarcador filtrosPesquisa)
        {

            string sqlQuery = SqlRelatorioCargaPedidoEmbarcador(filtrosPesquisa);

            string query = @"SELECT COUNT(0) as CONTADOR
                FROM ( " + sqlQuery + " ) AS A ";

            var nhQuery = this.SessionNHiBernate.CreateSQLQuery(query);

            return nhQuery.SetTimeout(6000).UniqueResult<int>();
        }

        public IList<Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.CargaPedidoEmbarcador> ConsultarRelatorioCargaPedidoEmbarcador(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaRelatorioCargaPedidoEmbarcador filtrosPesquisa, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            string sqlQuery = SqlRelatorioCargaPedidoEmbarcador(filtrosPesquisa);

            sqlQuery +=
                @"ORDER BY 1, 2, 5, 19 DESC ";

            if ((parametrosConsulta != null) && ((parametrosConsulta.InicioRegistros > 0) || (parametrosConsulta.LimiteRegistros > 0)))
                sqlQuery += $" offset {parametrosConsulta.InicioRegistros} rows fetch next {parametrosConsulta.LimiteRegistros} rows only;";

            var nhQuery = this.SessionNHiBernate.CreateSQLQuery(sqlQuery);

            nhQuery.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.CargaPedidoEmbarcador)));

            return nhQuery.SetTimeout(6000).List<Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.CargaPedidoEmbarcador>();

        }

        public async Task<IList<Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.CargaPedidoEmbarcador>> ConsultarRelatorioCargaPedidoEmbarcadorAsync(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaRelatorioCargaPedidoEmbarcador filtrosPesquisa, string propGrupo, string dirOrdenacaoGrupo, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros, bool paginar = true)
        {
            string sqlQuery = SqlRelatorioCargaPedidoEmbarcador(filtrosPesquisa);

            sqlQuery +=
                @"ORDER BY 1, 2, 5, 19 DESC ";

            if (paginar)
                sqlQuery += " OFFSET " + inicioRegistros + " ROWS FETCH FIRST " + maximoRegistros + " ROWS ONLY";

            return await this.SessionNHiBernate.CreateSQLQuery(sqlQuery)
                .SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.CargaPedidoEmbarcador)))
                .SetTimeout(6000)
                .ListAsync<Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.CargaPedidoEmbarcador>();
        }

        public IList<Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.CargaEntregaPedido> ConsultarRelatorioCargaEntregaPedido(FiltroPesquisaRelatorioCargaEntregaPedido filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedades, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            var query = new ConsultaCargaEntregaPedido().ObterSqlPesquisa(filtrosPesquisa, parametrosConsulta, propriedades).CriarSQLQuery(this.SessionNHiBernate);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.CargaEntregaPedido)));

            return query.SetTimeout(600).List<Dominio.Relatorios.Embarcador.DataSource.Cargas.Carga.CargaEntregaPedido>();
        }

        public int ContarConsultaRelatorioCargaEntregaPedido(FiltroPesquisaRelatorioCargaEntregaPedido filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedades)
        {
            var query = new ConsultaCargaEntregaPedido().ObterSqlContarPesquisa(filtrosPesquisa, propriedades).CriarSQLQuery(this.SessionNHiBernate);

            return query.SetTimeout(600).UniqueResult<int>();
        }

        public int ContarConsultaRelatorioCargaViagemEventos(FiltroPesquisaRelatorioCargaViagemEventos filtrosPesquisa, List<Dominio.Relatorios.Embarcador.ObjetosDeValor.PropriedadeAgrupamento> propriedades)
        {
            var query = new ConsultaCargaViagemEventos().ObterSqlContarPesquisa(filtrosPesquisa, propriedades).CriarSQLQuery(this.SessionNHiBernate);

            return query.SetTimeout(600).UniqueResult<int>();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.CargaCTeIntegracaoArquivo> BuscarArquivosPorIntergacao(int codigo, int inicio, int limite)
        {
            var queryCargaCTeIntegracao = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTeManualIntegracao>();
            var resultCargaCTeIntegracao = from obj in queryCargaCTeIntegracao where obj.Codigo == codigo select obj;

            var queryCargaCTeIntegracaoArquivo = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTeIntegracaoArquivo>();
            var resultCargaCTeIntegracaoArquivo = from obj in queryCargaCTeIntegracaoArquivo where resultCargaCTeIntegracao.Any(p => p.ArquivosTransacao.Contains(obj)) orderby obj.Data descending select obj;

            return resultCargaCTeIntegracaoArquivo.Skip(inicio).Take(limite).ToList();
        }

        public int ContarBuscarArquivosPorIntergacao(int codigo)
        {
            var queryCargaCTeIntegracao = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTeManualIntegracao>();
            var resultCargaCTeIntegracao = from obj in queryCargaCTeIntegracao where obj.Codigo == codigo select obj;

            var queryCargaCTeIntegracaoArquivo = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTeIntegracaoArquivo>();
            var resultCargaCTeIntegracaoArquivo = from obj in queryCargaCTeIntegracaoArquivo where resultCargaCTeIntegracao.Any(p => p.ArquivosTransacao.Contains(obj)) orderby obj.Data descending select obj;

            return resultCargaCTeIntegracaoArquivo.Count();
        }

        public Dominio.Entidades.Embarcador.Cargas.CargaCTeIntegracaoArquivo BuscarIntergacaoPorCodigo(int codigo)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTeIntegracaoArquivo>();
            var result = from obj in query where obj.Codigo == codigo select obj;

            return result.FirstOrDefault();
        }

        public Dominio.Entidades.Embarcador.Cargas.CartaCorrecaoCCEIntegracaoArquivo BuscarIntergacaoCartaCorrecaoPorCodigo(int codigo)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CartaCorrecaoCCEIntegracaoArquivo>();
            var result = from obj in query where obj.Codigo == codigo select obj;

            return result.FirstOrDefault();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasOriginaisVinculadas(int codigoCarga)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> listaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.CargaVinculada.Codigo == codigoCarga);

            return listaCarga.ToList();
        }

        public string BuscaTipoDeCargaPorCarga(int codigoCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query where obj.Codigo == codigoCarga select obj;

            return result.Select(obj => obj.TipoDeCarga.Descricao).FirstOrDefault();
        }

        public int BuscarProtocoloCargaPorNumeroBooking(string numeroBooking)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            var result = query.Where(o => o.Carga.SituacaoCarga != SituacaoCarga.Cancelada && o.Carga.SituacaoCarga != SituacaoCarga.Anulada && o.Pedido.NumeroBooking.Equals(numeroBooking));

            return result.Select(o => o.Carga.Protocolo).FirstOrDefault();
        }

        public List<int> BuscarProtocolosCargaPorNumeroBooking(string numeroBooking)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            var result = query.Where(o => o.Carga.SituacaoCarga != SituacaoCarga.Cancelada && o.Carga.SituacaoCarga != SituacaoCarga.Anulada && o.Pedido.NumeroBooking.Equals(numeroBooking));

            return result.Select(o => o.Carga.Protocolo).ToList();
        }

        public bool PossuiPendenciaTransportadorContribuinte(int codigoCarga)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => o.Codigo == codigoCarga && o.PendenciaDocumentoTransportador).Select(o => o.Codigo);

            var consultaDocumentoPendencia = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.ContribuinteCargaCTeAnexo>()
                .Where(o => o.CargaCTe.Carga.Codigo == codigoCarga).Select(o => o.Codigo);

            return consultaCarga.Any() || consultaDocumentoPendencia.Any();
        }

        public Dominio.Entidades.Embarcador.Veiculos.Equipamento BuscarPrimeiroEquipamentoVinculado(int codigoCarga)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(obj => obj.Codigo == codigoCarga);

            return query.SelectMany(obj => obj.VeiculosVinculados).SelectMany(obj => obj.Equipamentos).FirstOrDefault();
        }


        public decimal BuscarTaxaOcupacaoVeiculo(int codigoCarga)
        {
            string query = @$"SELECT
                                ISNULL((
                                    SELECT SUM(_notaFiscal.NF_PESO) * 100
                                    FROM (
                                        SELECT DISTINCT _xmlnotafiscal.NF_NUMERO, _xmlnotafiscal.NF_PESO
                                        FROM T_CARGA_PEDIDO _cargapedido
                                        JOIN T_PEDIDO_XML_NOTA_FISCAL _pedidoxmlnotafiscal ON _pedidoxmlnotafiscal.CPE_CODIGO = _cargapedido.CPE_CODIGO
                                        JOIN T_XML_NOTA_FISCAL _xmlnotafiscal ON _xmlnotafiscal.NFX_CODIGO = _pedidoxmlnotafiscal.NFX_CODIGO
                                        WHERE _cargapedido.CAR_CODIGO = {codigoCarga}
                                    ) _notaFiscal
                                ), 0)
                                / NULLIF(
                                    ISNULL((
                                        SELECT SUM(_capacidadeModeloVeicularCarga.Capacidade)
                                        FROM (
                                            SELECT _modeloveicularcarga.MVC_CODIGO, ISNULL(_modeloveicularcarga.MVC_CAPACIDADE_PESO_TRANSPORTE, 0.0) AS Capacidade
                                            FROM T_VEICULO _veiculo
                                            JOIN T_MODELO_VEICULAR_CARGA _modeloveicularcarga ON _modeloveicularcarga.MVC_CODIGO = _veiculo.MVC_CODIGO
                                            WHERE _veiculo.VEI_CODIGO = (
                                                SELECT CAR_VEICULO FROM T_CARGA WHERE CAR_CODIGO = {codigoCarga}
                                            )
                                            AND _modeloveicularcarga.MVC_TIPO IN ({(int)TipoModeloVeicularCarga.Geral}, {(int)TipoModeloVeicularCarga.Reboque}) -- Geral, Reboque
                                            UNION
                                            SELECT DISTINCT _modeloveicularcarga.MVC_CODIGO, ISNULL(_modeloveicularcarga.MVC_CAPACIDADE_PESO_TRANSPORTE, 0.0) AS Capacidade
                                            FROM T_CARGA_VEICULOS_VINCULADOS _veiculoVinculado
                                            JOIN T_VEICULO _veiculo ON _veiculo.VEI_CODIGO = _veiculoVinculado.VEI_CODIGO
                                            JOIN T_MODELO_VEICULAR_CARGA _modeloveicularcarga ON _modeloveicularcarga.MVC_CODIGO = _veiculo.MVC_CODIGO
                                            WHERE _veiculoVinculado.CAR_CODIGO = {codigoCarga}
                                            AND _modeloveicularcarga.MVC_TIPO IN ({(int)TipoModeloVeicularCarga.Geral}, {(int)TipoModeloVeicularCarga.Reboque}) -- Geral, Reboque
                                        ) AS _capacidadeModeloVeicularCarga
                                    ), 0)
                                , 0) AS TaxaOcupacaoVeiculo"; // SQL-INJECTION-SAFE


            ISQLQuery nhQuery = this.SessionNHiBernate.CreateSQLQuery(query);
            return nhQuery.SetTimeout(6000).UniqueResult<decimal>();
        }

        #endregion Métodos Públicos - Relatórios

        #region Métodos Privados

        private string GetFiltroAcompanhamentoCarga(Dominio.ObjetosDeValor.Embarcador.TorreControle.FiltroPesquisaAcompanhamentoCarga filtrosPesquisa, bool aplicarFiltroAlerta = true)
        {
            string WhereGeral = " AND SituacaoCarga <> 13 AND SituacaoCarga <> 18 AND CargaFechada = 1 "; //where direto na view;

            if (filtrosPesquisa.SituacoesCarga.Count > 0)
                WhereGeral += $" AND SituacaoCarga in ({string.Join(", ", filtrosPesquisa.SituacoesCarga.Select(x => (int)x).ToList())}) ";

            string JoinInterno = ""; // joins do select in a view;
            string whereInterno = " where 1=1 "; // where do select in a view;

            string dateFormat = "yyyy-MM-dd HH:mm:ss";

            if (!filtrosPesquisa.ExibirEntregaAntesEtapaTransporte)
                WhereGeral += $" AND (ExibirCargaAntesTransporte = 1 or SituacaoCarga in ({(int)SituacaoCarga.EmTransporte},{(int)SituacaoCarga.LiberadoPagamento}, {(int)SituacaoCarga.Encerrada}, {(int)SituacaoCarga.AgIntegracao}, {(int)SituacaoCarga.AgImpressaoDocumentos}, {(int)SituacaoCarga.PendeciaDocumentos})) ";

            if (filtrosPesquisa.DataCriacaoCargaInicial.HasValue)
                WhereGeral += $" AND DataCriacaoCarga >= convert(datetime, '{filtrosPesquisa.DataCriacaoCargaInicial.Value.ToString(dateFormat)}', 102) ";

            if (filtrosPesquisa.DataCriacaoCargaFinal.HasValue)
                WhereGeral += $" AND DataCriacaoCarga < convert(datetime, '{filtrosPesquisa.DataCriacaoCargaFinal.Value.AddDays(1).ToString(dateFormat)}', 102) ";

            if (filtrosPesquisa.DataInicioViagemInicial.HasValue)
                WhereGeral += $" AND DataInicioViagem >= convert(datetime, '{filtrosPesquisa.DataInicioViagemInicial.Value.ToString(dateFormat)}', 102) ";

            if (filtrosPesquisa.DataInicioViagemFinal.HasValue)
                WhereGeral += $" AND DataInicioViagem < convert(datetime, '{filtrosPesquisa.DataInicioViagemFinal.Value.AddDays(1).ToString(dateFormat)}', 102) ";

            if (filtrosPesquisa.DataPrevisaoInicioViagemInicial.HasValue)
                WhereGeral += $" AND DataInicioViagemPrevista >= convert(datetime, '{filtrosPesquisa.DataPrevisaoInicioViagemInicial.Value.ToString(dateFormat)}', 102)";

            if (filtrosPesquisa.DataPrevisaoInicioViagemFinal.HasValue)
                WhereGeral += $" AND DataInicioViagemPrevista < convert(datetime, '{filtrosPesquisa.DataPrevisaoInicioViagemFinal.Value.AddDays(1).ToString(dateFormat)}', 102)";

            if (filtrosPesquisa.DataCarregamentoInicial.HasValue)
                WhereGeral += $" AND DataCarregamentoCarga >= convert(datetime, '{filtrosPesquisa.DataCarregamentoInicial.Value.ToString(dateFormat)}', 102)";

            if (filtrosPesquisa.DataCarregamentoFinal.HasValue)
                WhereGeral += $" AND DataCarregamentoCarga < convert(datetime, '{filtrosPesquisa.DataCarregamentoFinal.Value.AddDays(1).ToString(dateFormat)}', 102)";

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroCarga))
                if (filtrosPesquisa.FiltrarCargasPorParteDoNumero)
                    WhereGeral += $@" AND (CargaEmbarcador LIKE '%{filtrosPesquisa.NumeroCarga}%' OR ( EXISTS(SELECT CargaCodigosAgrupados.CAR_CODIGO_CARGA_AGRUPADO
                                                                                                        FROM T_CARGA_CODIGOS_AGRUPADOS CargaCodigosAgrupados
                                                                                                        WHERE CargaCodigosAgrupados.CAR_CODIGO = CodigoCarga AND CargaCodigosAgrupados.CAR_CODIGO_CARGA_AGRUPADO LIKE '%{filtrosPesquisa.NumeroCarga}%')))";
                else
                    WhereGeral += $@" AND (CargaEmbarcador = '{filtrosPesquisa.NumeroCarga}' OR ( EXISTS(SELECT CargaCodigosAgrupados.CAR_CODIGO_CARGA_AGRUPADO
                                                                                                        FROM T_CARGA_CODIGOS_AGRUPADOS CargaCodigosAgrupados
                                                                                                        WHERE CargaCodigosAgrupados.CAR_CODIGO = CodigoCarga AND CargaCodigosAgrupados.CAR_CODIGO_CARGA_AGRUPADO = '{filtrosPesquisa.NumeroCarga}')))";

            if (filtrosPesquisa.CodigoNovaCarga > 0)
                WhereGeral += $" AND CodigoCarga = {filtrosPesquisa.CodigoNovaCarga}";

            if (filtrosPesquisa.CodigosTipoOperacao?.Count > 0)
                WhereGeral += $" AND CodigoTipoOperacao  in ({string.Join(", ", filtrosPesquisa.CodigosTipoOperacao)})";

            if (filtrosPesquisa.CodigosVeiculo?.Count > 0)
                WhereGeral += $" AND Veiculo  in ({string.Join(", ", filtrosPesquisa.CodigosVeiculo)})";

            if (filtrosPesquisa.CodigosTransportador?.Count > 0)
                WhereGeral += $" AND CodigoTransportador  in ({string.Join(", ", filtrosPesquisa.CodigosTransportador)})";

            if (filtrosPesquisa.ExibirSomenteCargasComVeiculo)
                WhereGeral += $" AND Veiculo is not null";

            if (filtrosPesquisa.StatusViagem?.Count() > 0)
            {
                if (filtrosPesquisa.StatusViagem.Contains(StatusViagemControleEntrega.EmAndamento))
                    WhereGeral += $" AND DataInicioViagem is not null and DataFimViagem is null ";
                if (filtrosPesquisa.StatusViagem.Contains(StatusViagemControleEntrega.Finalizada))
                    WhereGeral += $" AND DataFimViagem is not null  "; //consultaCarga = consultaCarga.Where(o => o.DataFimViagem != null);
                if (filtrosPesquisa.StatusViagem.Contains(StatusViagemControleEntrega.Iniciada))
                    WhereGeral += $" AND DataInicioViagem is not null "; // consultaCarga = consultaCarga.Where(o => o.DataInicioViagem != null);
                if (filtrosPesquisa.StatusViagem.Contains(StatusViagemControleEntrega.NaoFinalizada))
                    WhereGeral += $" AND DataFimViagem is null ";  //consultaCarga = consultaCarga.Where(o => o.DataFimViagem == null);
                if (filtrosPesquisa.StatusViagem.Contains(StatusViagemControleEntrega.NaoIniciada))
                    WhereGeral += $" AND DataInicioViagem is null and SituacaoCarga != 11 "; //consultaCarga = consultaCarga.Where(o => o.DataInicioViagem == null);
            }

            if (filtrosPesquisa.resumoFinalizadas)
                WhereGeral += $" AND DataInicioViagem is not null and DataFimViagem is not null";

            if (filtrosPesquisa.resumoEmViagem)
                WhereGeral += $" AND DataInicioViagem is not null and DataFimViagem is null";

            if (filtrosPesquisa.resumoNaoIniciada)
                WhereGeral += $" AND DataInicioViagem is null and SituacaoCarga != 11";

            if (filtrosPesquisa.DataEntregaInicial.HasValue)
                whereInterno += $" AND (cargaEntrega.CEN_DATA_ENTREGA >= convert(datetime, '{filtrosPesquisa.DataEntregaInicial.Value.ToString(dateFormat)}', 102) )";

            if (filtrosPesquisa.DataEntregaFinal.HasValue)
                whereInterno += $" AND (cargaEntrega.CEN_DATA_ENTREGA <= convert(datetime, '{filtrosPesquisa.DataEntregaFinal.Value.ToString(dateFormat)}', 102) )";

            if (filtrosPesquisa.ExibirSomenteCargasComReentrega)
                whereInterno += $" AND cargaEntrega.CEN_REENTREGA = 1 ";

            if (filtrosPesquisa.ExibirSomenteCargasComChamadoAberto)
                whereInterno += $" AND cargaEntrega.CEN_CHAMADO_EM_ABERTO = 1 ";

            if (filtrosPesquisa.DataPrevisaoEntregaInicial.HasValue)
                whereInterno += $" AND (cargaEntrega.CEN_DATA_ENTREGA_PREVISTA >= convert(datetime, '{filtrosPesquisa.DataPrevisaoEntregaInicial.Value.ToString(dateFormat)}', 102) )";

            if (filtrosPesquisa.DataPrevisaoEntregaFinal.HasValue)
                whereInterno += $" AND (cargaEntrega.CEN_DATA_ENTREGA_PREVISTA < convert(datetime, '{filtrosPesquisa.DataPrevisaoEntregaFinal.Value.AddDays(1).ToString(dateFormat)}', 102) )";

            if (filtrosPesquisa.LocaisEntrega?.Count > 0)
                whereInterno += $" AND (cargaEntrega.CLI_CODIGO_ENTREGA in ({string.Join(", ", filtrosPesquisa.LocaisEntrega)}) and cargaEntrega.CEN_COLETA = 0)";

            if (filtrosPesquisa.LocaisColeta?.Count > 0)
                whereInterno += $" AND (cargaEntrega.CLI_CODIGO_ENTREGA in ({string.Join(", ", filtrosPesquisa.LocaisColeta)}) and cargaEntrega.CEN_COLETA = 1)";

            if (filtrosPesquisa.localidadeColeta?.Count > 0)
            {
                if (!JoinInterno.Contains("T_CLIENTE"))
                    JoinInterno += "left join T_CLIENTE Cliente on Cliente.CLI_CGCCPF = cargaEntrega.CLI_CODIGO_ENTREGA ";

                whereInterno += $" AND (Cliente.LOC_CODIGO in ({string.Join(", ", filtrosPesquisa.localidadeColeta)}) and cargaEntrega.CEN_COLETA = 1)";
            }

            if (filtrosPesquisa.localidadeEntrega?.Count > 0)
            {
                if (!JoinInterno.Contains("T_CLIENTE"))
                    JoinInterno += "left join T_CLIENTE Cliente on Cliente.CLI_CGCCPF = cargaEntrega.CLI_CODIGO_ENTREGA ";

                whereInterno += $" AND (Cliente.LOC_CODIGO in ({string.Join(", ", filtrosPesquisa.localidadeEntrega)}) and cargaEntrega.CEN_COLETA = 0)";
            }

            if (filtrosPesquisa.NumeroNotasFiscais?.Count > 0)
            {
                if (!JoinInterno.Contains("T_CARGA_ENTREGA_NOTA_FISCAL"))
                {
                    JoinInterno += $"JOIN T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido ON CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO" +
                                   $" join t_carga_pedido CargaPedido ON CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO" +
                                   $" join T_PEDIDO_XML_NOTA_FISCAL PedidoNotaFiscal on CargaPedido.CPE_CODIGO = PedidoNotaFiscal.CPE_CODIGO" +
                                   $" join  T_XML_NOTA_FISCAL XMLNotaFiscal on XMLNotaFiscal.NFX_CODIGO = PedidoNotaFiscal.NFX_CODIGO ";

                    whereInterno += $" AND ( XMLNotaFiscal.NFX_CODIGO in ({string.Join(", ", filtrosPesquisa.NumeroNotasFiscais)}))";
                }
            }

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroPedidoEmbarcador))
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaEntregaPedido.CPE_CODIGO = CargaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" Pedido "))
                    JoinInterno += "left join T_PEDIDO Pedido on Pedido.PED_CODIGO = CargaPedido.PED_CODIGO ";

                whereInterno += $" AND ( Pedido.PED_NUMERO_PEDIDO_EMBARCADOR = '{filtrosPesquisa.NumeroPedidoEmbarcador}')";
            }

            if (filtrosPesquisa.CodigosStatusDaViagem != null && filtrosPesquisa.CodigosStatusDaViagem.Count > 0)
            {
                if (!JoinInterno.Contains(" Monitoramento "))
                    JoinInterno += "left join T_MONITORAMENTO Monitoramento on cargaEntrega.CAR_CODIGO = Monitoramento.CAR_CODIGO ";

                whereInterno += " and (";
                if (filtrosPesquisa.CodigosStatusDaViagem.Contains(-1))
                    whereInterno += $" Monitoramento.MSV_CODIGO is null or ";
                whereInterno += $" Monitoramento.MSV_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosStatusDaViagem)}) )";
            }

            if (filtrosPesquisa.MonitoramentoStatus.Count > 0)
            {
                if (!JoinInterno.Contains(" Monitoramento "))
                    JoinInterno += "left join T_MONITORAMENTO Monitoramento on cargaEntrega.CAR_CODIGO = Monitoramento.CAR_CODIGO ";

                var statusCodes = filtrosPesquisa.MonitoramentoStatus.Cast<int>();

                whereInterno += $" AND Monitoramento.MON_STATUS in ({string.Join(", ", statusCodes)})";
            }

            if (filtrosPesquisa.CpfCnpjDestinatariosPedido.Count > 0)
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" Pedido "))
                    JoinInterno += "left join T_PEDIDO Pedido on CargaPedido.PED_CODIGO = Pedido.PED_CODIGO ";

                whereInterno += $" AND Pedido.CLI_CODIGO in ({string.Join(", ", filtrosPesquisa.CpfCnpjDestinatariosPedido)})";
            }

            if (filtrosPesquisa.CpfCnpjRemetentesPedido.Count > 0)
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" Pedido "))
                    JoinInterno += "left join T_PEDIDO Pedido on CargaPedido.PED_CODIGO = Pedido.PED_CODIGO ";

                whereInterno += $" AND Pedido.CLI_CODIGO_REMETENTE in ({string.Join(", ", filtrosPesquisa.CpfCnpjRemetentesPedido)})";
            }

            if (filtrosPesquisa.CodigosExpedidor.Count > 0)
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" ExpedidorCargaPedido "))
                    JoinInterno += "left join T_CLIENTE ExpedidorCargaPedido on ExpedidorCargaPedido.CLI_CGCCPF = CargaPedido.CLI_CODIGO_EXPEDIDOR ";

                whereInterno += $" AND ExpedidorCargaPedido.CLI_CGCCPF in ({string.Join(", ", filtrosPesquisa.CodigosExpedidor)})";
            }

            if (filtrosPesquisa.CodigosRecebedor.Count > 0)
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" RecebedorCargaPedido "))
                    JoinInterno += "left join T_CLIENTE RecebedorCargaPedido on RecebedorCargaPedido.CLI_CGCCPF = CargaPedido.CLI_CODIGO_RECEBEDOR ";

                whereInterno += $" AND RecebedorCargaPedido.CLI_CGCCPF in ({string.Join(", ", filtrosPesquisa.CodigosRecebedor)})";
            }

            if (filtrosPesquisa.CpfCnpjRecebedoresOuSemRecebedores?.Count > 0)
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" RecebedorCargaPedido "))
                    JoinInterno += "left join T_CLIENTE RecebedorCargaPedido on RecebedorCargaPedido.CLI_CGCCPF = CargaPedido.CLI_CODIGO_RECEBEDOR ";

                whereInterno += $" AND (RecebedorCargaPedido.CLI_CGCCPF in ({string.Join(", ", filtrosPesquisa.CpfCnpjRecebedoresOuSemRecebedores)}) OR RecebedorCargaPedido.CLI_CGCCPF is null)";
            }

            if ((filtrosPesquisa.CodigosFilial?.Any(codigo => codigo == "-1") ?? false) && filtrosPesquisa.CpfCnpjRecebedoresOuSemRecebedores?.Count > 0)
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" RecebedorCargaPedido "))
                    JoinInterno += "left join T_CLIENTE RecebedorCargaPedido on RecebedorCargaPedido.CLI_CGCCPF = CargaPedido.CLI_CODIGO_RECEBEDOR ";

                whereInterno += $" AND (CodigoFilial in ('{string.Join("', '", filtrosPesquisa.CodigosFilial)}') OR RecebedorCargaPedido.CLI_CGCCPF in ({string.Join(", ", filtrosPesquisa.CpfCnpjRecebedoresOuSemRecebedores)}))";
            }
            else if (filtrosPesquisa.CodigosFilial?.Count > 0)
                whereInterno += $" AND CodigoFilial in ('{string.Join("', '", filtrosPesquisa.CodigosFilial)}')";

            if (filtrosPesquisa?.CodigosFilialVenda?.Count > 0)
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" Pedido "))
                    JoinInterno += "left join T_PEDIDO Pedido on Pedido.PED_CODIGO = CargaPedido.PED_CODIGO ";

                whereInterno += $" AND Pedido.FIL_CODIGO_VENDA in ({string.Join(", ", filtrosPesquisa.CodigosFilialVenda)})";
            }

            if (filtrosPesquisa?.CodigosTipoCarga?.Count > 0)
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" Carga "))
                    JoinInterno += "left join T_CARGA Carga on Carga.CAR_CODIGO = CargaPedido.CAR_CODIGO ";

                whereInterno += $" AND Carga.TCG_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosTipoCarga)})";
            }

            if (filtrosPesquisa.FiltroAtendimento != Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Nenhum)
            {
                if (filtrosPesquisa.FiltroAtendimento == Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Pendente)
                    WhereGeral += $" AND chamadosPendentes > 0";
                else if (filtrosPesquisa.FiltroAtendimento == Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Tratativa)
                    WhereGeral += $" AND chamadosEmtratativa > 0";
                else if (filtrosPesquisa.FiltroAtendimento == Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Atrasada)
                    WhereGeral += $" AND chamadosAtrasados > 0";
                else if (filtrosPesquisa.FiltroAtendimento == Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Concluida)
                    WhereGeral += $" AND chamadosConcluidos > 0";


                //if (!JoinInterno.Contains(" chamado "))
                //    JoinInterno += "inner join t_chamados chamado on chamado.CAR_CODIGO = cargaEntrega.CAR_CODIGO ";

                //if ((filtrosPesquisa.FiltroAtendimento == Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Tratativa || filtrosPesquisa.FiltroAtendimento == Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Atrasada) && !JoinInterno.Contains(" NivelAtendimento "))
                //    JoinInterno += "inner join T_NIVEL_ATENDIMENTO NivelAtendimento on NivelAtendimento.CHA_CODIGO = chamado.CHA_CODIGO ";

                //if (filtrosPesquisa.FiltroAtendimento == Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Pendente)
                //    whereInterno += $" AND chamado.FUN_RESPONSAVEL is null";
                //else if (filtrosPesquisa.FiltroAtendimento == Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Tratativa)
                //    whereInterno += $" AND chamado.FUN_RESPONSAVEL is not null AND chamado.CHA_SITUACAO = {(int)Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoChamado.Aberto} ";
                //else if (filtrosPesquisa.FiltroAtendimento == Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Atrasada)
                //    whereInterno += $" AND chamado.FUN_RESPONSAVEL is not null AND chamado.CHA_SITUACAO != {(int)Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoChamado.Finalizado} AND chamado.CHA_SITUACAO != {(int)Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoChamado.Cancelada} AND '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "' > NivelAtendimento.NAT_DATA_LIMITE ";
                //else if (filtrosPesquisa.FiltroAtendimento == Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroAtendimento.Concluida)
                //    whereInterno += $" AND chamado.CHA_SITUACAO = {(int)SituacaoChamado.Finalizado}";


            }

            if (filtrosPesquisa.FiltroTendenciaEntrega != Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroTendenciaEntrega.Todos && filtrosPesquisa.FiltroTendenciaColeta != Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroTendenciaEntrega.Todos)
            {
                whereInterno += $@"
                    AND (
                        ISNULL((
                            SELECT TOP 1 cargaEntrega.CEN_TENDENCIA
                            FROM t_carga_entrega cargaEntrega 
                            WHERE cargaEntrega.CAR_CODIGO = CodigoCarga
                                AND cargaEntrega.CEN_SITUACAO != 2
                                AND cargaEntrega.CEN_COLETA = 1
                            ORDER BY cargaEntrega.CEN_ORDEM
                        ), (
                            SELECT TOP 1 cargaEntrega.CEN_TENDENCIA
                            FROM t_carga_entrega cargaEntrega 
                            WHERE cargaEntrega.CAR_CODIGO = CodigoCarga
                                AND cargaEntrega.CEN_SITUACAO = 2
                                AND cargaEntrega.CEN_COLETA = 1
                            ORDER BY cargaEntrega.CEN_ORDEM DESC
                        )) = {(int)filtrosPesquisa.FiltroTendenciaColeta}

                        AND 

                        ISNULL((
                            SELECT TOP 1 cargaEntrega.CEN_TENDENCIA
                            FROM t_carga_entrega cargaEntrega 
                            WHERE cargaEntrega.CAR_CODIGO = CodigoCarga
                                AND cargaEntrega.CEN_SITUACAO != 2
                                AND cargaEntrega.CEN_COLETA = 0
                            ORDER BY cargaEntrega.CEN_ORDEM
                        ), (
                            SELECT TOP 1 cargaEntrega.CEN_TENDENCIA
                            FROM t_carga_entrega cargaEntrega 
                            WHERE cargaEntrega.CAR_CODIGO = CodigoCarga
                                AND cargaEntrega.CEN_SITUACAO = 2
                                AND cargaEntrega.CEN_COLETA = 0
                            ORDER BY cargaEntrega.CEN_ORDEM DESC
                        )) = {(int)filtrosPesquisa.FiltroTendenciaEntrega}
                    )";
            }
            else
            {
                if (filtrosPesquisa.FiltroTendenciaEntrega != Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroTendenciaEntrega.Todos)
                {
                    whereInterno += @$" AND (

                        ISNULL((
                            SELECT TOP 1 cargaEntrega.CEN_TENDENCIA
                            FROM t_carga_entrega cargaEntrega 
                            WHERE cargaEntrega.CAR_CODIGO = CodigoCarga
                                AND cargaEntrega.CEN_SITUACAO != 2
                                AND cargaEntrega.CEN_COLETA = 0
                            ORDER BY cargaEntrega.CEN_ORDEM
                        ), (
                            SELECT TOP 1 cargaEntrega.CEN_TENDENCIA
                            FROM t_carga_entrega cargaEntrega 
                            WHERE cargaEntrega.CAR_CODIGO = CodigoCarga
                                AND cargaEntrega.CEN_SITUACAO = 2
                                AND cargaEntrega.CEN_COLETA = 0
                            ORDER BY cargaEntrega.CEN_ORDEM DESC
                        )) = {(int)filtrosPesquisa.FiltroTendenciaEntrega} "; // SQL-INJECTION-SAFE

                    whereInterno += " ) ";
                }

                if (filtrosPesquisa.FiltroTendenciaColeta != Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroTendenciaEntrega.Todos)
                {
                    whereInterno += @$"  AND (
                        ISNULL((
                            SELECT TOP 1 cargaEntrega.CEN_TENDENCIA
                            FROM t_carga_entrega cargaEntrega 
                            WHERE cargaEntrega.CAR_CODIGO = CodigoCarga
                                AND cargaEntrega.CEN_SITUACAO != 2
                                AND cargaEntrega.CEN_COLETA = 1
                            ORDER BY cargaEntrega.CEN_ORDEM
                        ), (
                            SELECT TOP 1 cargaEntrega.CEN_TENDENCIA
                            FROM t_carga_entrega cargaEntrega 
                            WHERE cargaEntrega.CAR_CODIGO = CodigoCarga
                                AND cargaEntrega.CEN_SITUACAO = 2
                                AND cargaEntrega.CEN_COLETA = 1
                            ORDER BY cargaEntrega.CEN_ORDEM DESC
                        )) = {(int)filtrosPesquisa.FiltroTendenciaColeta} "; // SQL-INJECTION-SAFE

                    whereInterno += " ) ";
                }
            }

            if (filtrosPesquisa.FiltroTendencia != Dominio.ObjetosDeValor.Embarcador.TorreControle.tipoFiltroTendenciaEntrega.Todos)
            {
                whereInterno += @$"  AND (
                        ISNULL((
                            SELECT TOP 1 cargaEntrega.CEN_TENDENCIA
                            FROM t_carga_entrega cargaEntrega 
                            WHERE cargaEntrega.CAR_CODIGO = CodigoCarga
                                AND cargaEntrega.CEN_SITUACAO != 2
                            ORDER BY cargaEntrega.CEN_ORDEM
                        ), (
                            SELECT TOP 1 cargaEntrega.CEN_TENDENCIA
                            FROM t_carga_entrega cargaEntrega 
                            WHERE cargaEntrega.CAR_CODIGO = CodigoCarga
                                AND cargaEntrega.CEN_SITUACAO = 2
                            ORDER BY cargaEntrega.CEN_ORDEM DESC
                        )) = {(int)filtrosPesquisa.FiltroTendencia} "; // SQL-INJECTION-SAFE

                whereInterno += " ) ";
            }
            if (filtrosPesquisa.ExibirSomenteCargasUsuarioMonitora)
            {
                if (!JoinInterno.Contains(" Carga "))
                    JoinInterno += "left join T_CARGA Carga on Carga.CAR_CODIGO = cargaEntrega.CAR_CODIGO ";

                whereInterno += $" AND Carga.CAR_ANALISTA_RESPONSAVEL_MONITORAMENTO = {filtrosPesquisa.CodigoUsuario} ";
            }

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroOrdem))
            {
                if (!JoinInterno.Contains(" Carga "))
                    JoinInterno += "left join T_CARGA Carga on Carga.CAR_CODIGO = cargaEntrega.CAR_CODIGO ";

                if (!JoinInterno.Contains(" CargaDadosSumarizados "))
                    JoinInterno += "left join T_CARGA_DADOS_SUMARIZADOS CargaDadosSumarizados on Carga.CDS_CODIGO = CargaDadosSumarizados.CDS_CODIGO ";

                whereInterno += $" AND CargaDadosSumarizados.CDS_NUMERO_ORDEM like '%{filtrosPesquisa.NumeroOrdem}%' ";
            }

            if (filtrosPesquisa.ExibirSomenteCargasCriticas)
            {
                if (!JoinInterno.Contains(" Carga "))
                    JoinInterno += "left join T_CARGA Carga on Carga.CAR_CODIGO = cargaEntrega.CAR_CODIGO ";

                if (!JoinInterno.Contains(" Monitoramento "))
                    JoinInterno += "left join T_MONITORAMENTO Monitoramento on Carga.CAR_CODIGO = Monitoramento.CAR_CODIGO ";

                whereInterno += $" AND Monitoramento.MON_CRITICO = 1 ";
            }

            if (filtrosPesquisa.ExibirSomenteCargasEmAtraso)
            {
                whereInterno += $" AND (cargaEntrega.CEN_DATA_ENTREGA_PREVISTA < convert(datetime, '{DateTime.Now.ToString(dateFormat)}', 102)) AND (cargaEntrega.CEN_SITUACAO = {(int)SituacaoEntrega.NaoEntregue} or cargaEntrega.CEN_SITUACAO = {(int)SituacaoEntrega.EmCliente} or cargaEntrega.CEN_SITUACAO = {(int)SituacaoEntrega.Revertida})";
            }

            if (filtrosPesquisa?.CodigosTipoDocumentoTransporte?.Count > 0)
            {
                if (!JoinInterno.Contains(" Carga "))
                    JoinInterno += "left join T_CARGA Carga on Carga.CAR_CODIGO = cargaEntrega.CAR_CODIGO ";

                whereInterno += $" AND Carga.TDT_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosTipoDocumentoTransporte)})";
            }

            if (aplicarFiltroAlerta)
            {
                if (filtrosPesquisa.ExibirSomenteCargasAlertaMonitoramentoAberto)
                {
                    WhereGeral += $" AND PossuiAlertaAberto = 1 ";
                }

                if (filtrosPesquisa.ExibirSomenteCargasAlertaMonitoramentoEmTratativa)
                {
                    WhereGeral += $"AND PossuiAlertaEmTratativa = 1";
                }

                if (filtrosPesquisa.ExibirSomenteCargasSemAlertas)
                {
                    WhereGeral += $" AND (PossuiAlertaAberto = 0 OR PossuiAlertaAberto IS NULL)";
                }
            }

            if (filtrosPesquisa.PossuiRecebedor.HasValue)
            {
                string nullNotNull = string.Empty;

                if (filtrosPesquisa.PossuiRecebedor.Value)
                    nullNotNull = "not null";
                else
                    nullNotNull = "null";

                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" RecebedorCargaPedido "))
                    JoinInterno += "left join T_CLIENTE RecebedorCargaPedido on RecebedorCargaPedido.CLI_CGCCPF = CargaPedido.CLI_CODIGO_RECEBEDOR ";

                whereInterno += $" AND RecebedorCargaPedido.CLI_CGCCPF is {nullNotNull}";
            }

            if (filtrosPesquisa.PossuiExpedidor.HasValue)
            {
                string nullNotNull = string.Empty;

                if (filtrosPesquisa.PossuiExpedidor.Value)
                    nullNotNull = "not null";
                else
                    nullNotNull = "null";

                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" ExpedidorCargaPedido "))
                    JoinInterno += "left join T_CLIENTE ExpedidorCargaPedido on ExpedidorCargaPedido.CLI_CGCCPF = CargaPedido.CLI_CODIGO_EXPEDIDOR ";

                whereInterno += $" AND ExpedidorCargaPedido.CLI_CGCCPF is {nullNotNull}";
            }

            if (filtrosPesquisa.ExibirSomenteCargasComPesquisaDeDesembarquePendente)
            {
                if (!JoinInterno.Contains(" cargaEntregaChecklist "))
                    JoinInterno += "left join T_CARGA_ENTREGA_CHECKLIST cargaEntregaChecklist on cargaEntregaChecklist.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                whereInterno += $" AND cargaEntregaChecklist.CEC_RESPONDIDO = 1";
            }

            if (filtrosPesquisa.PreTrip.HasValue)
            {
                if (!JoinInterno.Contains(" Carga "))
                    JoinInterno += "left join T_CARGA Carga on Carga.CAR_CODIGO = cargaEntrega.CAR_CODIGO ";
                if (!JoinInterno.Contains(" Filial "))
                    JoinInterno += "left join T_FILIAL Filial on Filial.FIL_CODIGO = carga.FIL_CODIGO ";
                if (!JoinInterno.Contains(" TipoOperacaoTrizy "))
                    JoinInterno += "left join T_FILIAL_TIPO_OPERACAO_TRIZY TipoOperacaoTrizy on TipoOperacaoTrizy.FIL_CODIGO = Carga.FIL_CODIGO ";

                if (filtrosPesquisa.PreTrip.Value)
                {
                    whereInterno += $" AND Filial.FIL_HABILITAR_PRE_VIAGEM_TRIZY = 1 AND CARGA.TOP_CODIGO = TipoOperacaoTrizy.TOP_CODIGO ";
                }
                else
                {
                    whereInterno += @" AND (Filial.FIL_HABILITAR_PRE_VIAGEM_TRIZY = 0) 
                                                 AND (Carga.TOP_CODIGO IS NULL 
                                                      OR NOT EXISTS (SELECT 1 
                                                                       FROM T_FILIAL_TIPO_OPERACAO_TRIZY t 
                                                                       WHERE t.FIL_CODIGO = Carga.FIL_CODIGO
                                                                       AND t.TOP_CODIGO = Carga.TOP_CODIGO))";
                }
            }

            if (filtrosPesquisa.DataAgendamentoPedidoInicial != DateTime.MinValue || filtrosPesquisa.DataAgendamentoPedidoFinal != DateTime.MinValue)
            {
                if (filtrosPesquisa.DataAgendamentoPedidoInicial != DateTime.MinValue)
                {
                    whereInterno += $" AND cargaEntrega.CEN_DATA_AGENDAMENTO >= '{filtrosPesquisa.DataAgendamentoPedidoInicial.ToString(dateFormat)}' ";
                }

                if (filtrosPesquisa.DataAgendamentoPedidoFinal != DateTime.MinValue)
                {
                    whereInterno += $" AND cargaEntrega.CEN_DATA_AGENDAMENTO <= '{filtrosPesquisa.DataAgendamentoPedidoFinal.ToString(dateFormat)}' ";
                }

                whereInterno += "AND cargaEntrega.CEN_COLETA = 0";
            }

            if (filtrosPesquisa.DataColetaPedidoInicial != DateTime.MinValue || filtrosPesquisa.DataColetaPedidoFinal != DateTime.MinValue)
            {
                if (filtrosPesquisa.DataColetaPedidoInicial != DateTime.MinValue)
                {
                    whereInterno += $" AND cargaEntrega.CEN_DATA_AGENDAMENTO >= '{filtrosPesquisa.DataColetaPedidoInicial.ToString(dateFormat)}' ";
                }

                if (filtrosPesquisa.DataColetaPedidoFinal != DateTime.MinValue)
                {
                    whereInterno += $" AND cargaEntrega.CEN_DATA_AGENDAMENTO <= '{filtrosPesquisa.DataColetaPedidoFinal.ToString(dateFormat)}' ";
                }

                whereInterno += "AND cargaEntrega.CEN_COLETA = 1";
            }

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroPedidoCliente))
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" Pedido "))
                    JoinInterno += "left join T_PEDIDO Pedido on Pedido.PED_CODIGO = CargaPedido.PED_CODIGO ";

                whereInterno += $" AND Pedido.PED_CODIGO_PEDIDO_CLIENTE = '{filtrosPesquisa.NumeroPedidoCliente}' ";
            }

            if (filtrosPesquisa.CanalVenda > 0)
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" Pedido "))
                    JoinInterno += "left join T_PEDIDO Pedido on Pedido.PED_CODIGO = CargaPedido.PED_CODIGO ";

                whereInterno += $" AND Pedido.CNV_CODIGO = '{filtrosPesquisa.CanalVenda}' ";
            }

            if (filtrosPesquisa.CanalEntrega > 0)
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" Pedido "))
                    JoinInterno += "left join T_PEDIDO Pedido on Pedido.PED_CODIGO = CargaPedido.PED_CODIGO ";

                whereInterno += $" AND   Pedido.CNE_CODIGO = '{filtrosPesquisa.CanalEntrega}' ";
            }

            if (filtrosPesquisa.ModalTransporte > 0)
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                whereInterno += $" AND CargaPedido.TBF_TIPO_COBRANCA_MULTIMODAL = {Convert.ToInt32(filtrosPesquisa.ModalTransporte)} ";
            }


            if (filtrosPesquisa.CodigosClienteComplementar?.Count > 0)
                whereInterno += @$" AND CodigoCarga in (
                                    select distinct cargaEntrega.car_codigo
                                    from T_CARGA_ENTREGA cargaEntrega 
                                    left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO 
                                    left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO 
                                    left join T_PEDIDO Pedido on Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
                                    JOIN T_CLIENTE DestinatarioPedido ON DestinatarioPedido.CLI_CGCCPF = Pedido.CLI_CODIGO
                                    where DestinatarioPedido.CLI_CGCCPF IN  ({string.Join(", ", filtrosPesquisa.CodigosClienteComplementar)})
                            ) "; // SQL-INJECTION-SAFE

            if (filtrosPesquisa.VeiculoNoRaio)
            {
                whereInterno += $@" AND CargaEntrega.CEN_SITUACAO = 1";
            }

            if (filtrosPesquisa?.TipoAlerta?.Count > 0)
            {
                if (!JoinInterno.Contains(" AlertaMonitor"))
                    JoinInterno += "left join T_ALERTA_MONITOR AlertaMonitor on AlertaMonitor.CAR_CODIGO = cargaEntrega.CAR_CODIGO ";

                if (!JoinInterno.Contains(" MonitoramentoEvento"))
                    JoinInterno += "left join T_MONITORAMENTO_EVENTO MonitoramentoEvento on MonitoramentoEvento.MEV_CODIGO = AlertaMonitor.MEV_CODIGO ";

                whereInterno += $" AND MonitoramentoEvento.MEV_CODIGO in ({string.Join(", ", filtrosPesquisa.TipoAlerta)})";
            }

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.EscritorioVenda))
            {
                List<string> splitEscritorioVenda = filtrosPesquisa.EscritorioVenda.Split(',').Select(m => m.Trim()).ToList();

                whereInterno += @$" AND EXISTS (
                                   SELECT 1 FROM T_CARGA_PEDIDO CargaPedido
                                   INNER JOIN T_PEDIDO Pedido ON Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
                                   INNER JOIN T_CLIENTE DestinatarioPedido ON DestinatarioPedido.CLI_CGCCPF = Pedido.CLI_CODIGO
                                   INNER JOIN T_CLIENTE_COMPLEMENTAR ClienteComplementar ON ClienteComplementar.CLI_CODIGO = DestinatarioPedido.CLI_CGCCPF
                                   WHERE CargaPedido.CAR_CODIGO = cargaEntrega.CAR_CODIGO 
                                   AND (ClienteComplementar.CLC_ESCRITORIO_VENDAS LIKE '%{filtrosPesquisa.EscritorioVenda}%'
                                        OR ClienteComplementar.CLC_ESCRITORIO_VENDAS IN ('{string.Join("','", splitEscritorioVenda)}')))"; // SQL-INJECTION-SAFE
            }

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.Matriz))
            {
                List<string> splitMatriz = filtrosPesquisa.Matriz.Split(',').Select(m => m.Trim()).ToList();

                whereInterno += @$" AND EXISTS (
                                     SELECT 1 FROM T_CARGA_PEDIDO CargaPedido
                                     INNER JOIN T_PEDIDO Pedido ON Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
                                     INNER JOIN T_CLIENTE DestinatarioPedido ON DestinatarioPedido.CLI_CGCCPF = Pedido.CLI_CODIGO
                                     INNER JOIN T_CLIENTE_COMPLEMENTAR ClienteComplementar ON ClienteComplementar.CLI_CODIGO = DestinatarioPedido.CLI_CGCCPF
                                     WHERE CargaPedido.CAR_CODIGO = cargaEntrega.CAR_CODIGO 
                                     AND (ClienteComplementar.CLC_MATRIZ LIKE '%{filtrosPesquisa.Matriz}%' 
                                          OR ClienteComplementar.CLC_MATRIZ IN ('{string.Join("','", splitMatriz)}')))"; // SQL-INJECTION-SAFE
            }

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.EquipeVendas))
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" Pedido "))
                    JoinInterno += "left join T_PEDIDO Pedido on CargaPedido.PED_CODIGO = Pedido.PED_CODIGO ";

                whereInterno += $" AND Pedido.PED_EQUIPE_VENDAS like '%{filtrosPesquisa.EquipeVendas}%'";
            }

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.TipoMercadoria))
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" Pedido "))
                    JoinInterno += "left join T_PEDIDO Pedido on CargaPedido.PED_CODIGO = Pedido.PED_CODIGO ";

                whereInterno += $" AND Pedido.PED_TIPO_MERCADORIA like '%{filtrosPesquisa.TipoMercadoria}%'";
            }

            if (!string.IsNullOrEmpty(filtrosPesquisa.RotaFrete))
            {
                if (!JoinInterno.Contains(" Carga "))
                    JoinInterno += "left join T_CARGA Carga on Carga.CAR_CODIGO = cargaEntrega.CAR_CODIGO ";

                if (!JoinInterno.Contains(" RotaFrete "))
                    JoinInterno += "LEFT JOIN T_ROTA_FRETE RotaFrete on RotaFrete.ROF_CODIGO = Carga.ROF_CODIGO ";

                whereInterno += $" AND RotaFrete.ROF_DESCRICAO = '{filtrosPesquisa.RotaFrete}'";

            }

            if (filtrosPesquisa.Mesoregiao?.Count > 0)
                whereInterno += @$" AND EXISTS (    SELECT 1 FROM T_CARGA_PEDIDO CargaPedido
		                                                JOIN T_PEDIDO Pedido ON Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
		                                                JOIN T_CLIENTE DestinatarioPedido ON DestinatarioPedido.CLI_CGCCPF = Pedido.CLI_CODIGO
                                                        JOIN T_MESO_REGIAO MesoRegiao ON MesoRegiao.MRE_CODIGO = DestinatarioPedido.MRE_CODIGO
	                                                WHERE CargaPedido.CAR_CODIGO = cargaEntrega.CAR_CODIGO AND MesoRegiao.MRE_CODIGO IN ({string.Join(", ", filtrosPesquisa.Mesoregiao)})
                                                ) "; // SQL-INJECTION-SAFE

            if (filtrosPesquisa.Regiao?.Count > 0)
                whereInterno += @$" AND EXISTS (    SELECT 1 FROM T_CARGA_PEDIDO CargaPedido
		                                                JOIN T_PEDIDO Pedido ON Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
		                                                JOIN T_CLIENTE DestinatarioPedido ON DestinatarioPedido.CLI_CGCCPF = Pedido.CLI_CODIGO
                                                        JOIN T_REGIAO Regiao ON Regiao.REG_CODIGO = DestinatarioPedido.REG_CODIGO
	                                                WHERE CargaPedido.CAR_CODIGO = cargaEntrega.CAR_CODIGO AND Regiao.REG_CODIGO IN ({string.Join(", ", filtrosPesquisa.Regiao)})
                                                ) "; // SQL-INJECTION-SAFE

            if (filtrosPesquisa.GrupoDePessoas?.Count > 0)
            {
                whereInterno += @$"
                                AND EXISTS (
                                    SELECT 1
                                    FROM T_CARGA_PEDIDO CargaPedido
                                    JOIN T_PEDIDO Pedido ON Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
                                    JOIN T_CLIENTE DestinatarioPedido ON DestinatarioPedido.CLI_CGCCPF = Pedido.CLI_CODIGO
                                    JOIN T_GRUPO_PESSOAS GrupoPessoas ON GrupoPessoas.GRP_CODIGO = DestinatarioPedido.GRP_CODIGO
                                    WHERE CargaPedido.CAR_CODIGO = cargaEntrega.CAR_CODIGO 
                                    AND GrupoPessoas.GRP_CODIGO IN ({string.Join(", ", filtrosPesquisa.GrupoDePessoas)}) 
                                )
                            "; // SQL-INJECTION-SAFE
            }

            if (filtrosPesquisa.Parqueada.HasValue)
            {
                if (filtrosPesquisa.Parqueada.Value)
                {
                    WhereGeral += $" AND Parqueada = 1 ";
                }
                else
                {
                    WhereGeral += " AND Parqueada = 0 ";
                }
            }

            if (filtrosPesquisa.ExibirSomenteCargasFarolEspelhamentoOnline.HasValue || filtrosPesquisa.ExibirSomenteCargasFarolEspelhamentoOffline.HasValue)
            {
                var dataDia = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss.fff");
                WhereGeral += $@"
                                AND (SELECT TOP 1 
                                    CASE 
                                        WHEN POSICAO.POS_DATA_VEICULO IS NOT NULL 
                                                AND DATEDIFF(MINUTE, POSICAO.POS_DATA_VEICULO, '{dataDia}') <= EMBARCADOR.CEM_TEMPO_SEM_POSICAO_PARA_VEICULO_PERDER_SINAL
                                        THEN 1
                                        ELSE 0
                                    END AS ONLINE
                                FROM T_MONITORAMENTO MONITORAMENTO
                                LEFT JOIN T_POSICAO AS POSICAO 
                                    ON POSICAO.POS_CODIGO = MONITORAMENTO.POS_ULTIMA_POSICAO 
                                LEFT JOIN (
                                    SELECT TOP 1 CEM_TEMPO_SEM_POSICAO_PARA_VEICULO_PERDER_SINAL 
                                    FROM T_CONFIGURACAO_EMBARCADOR
                                ) AS EMBARCADOR 
                                    ON 1 = 1
                                WHERE MONITORAMENTO.CAR_CODIGO = CodigoCarga) = {(filtrosPesquisa.ExibirSomenteCargasFarolEspelhamentoOnline.HasValue ? 1 : 0)}";
            }


            if (filtrosPesquisa.DataInicioAbate != DateTime.MinValue)
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" Pedido "))
                    JoinInterno += "left join T_PEDIDO Pedido on Pedido.PED_CODIGO = CargaPedido.PED_CODIGO ";

                whereInterno += $" AND Pedido.PED_DATA_ETA >= convert(datetime, '{filtrosPesquisa.DataInicioAbate.ToString(dateFormat)}')";
            }

            if (filtrosPesquisa.DataFimAbate != DateTime.MinValue)
            {
                if (!JoinInterno.Contains(" CargaEntregaPedido "))
                    JoinInterno += "left join T_CARGA_ENTREGA_PEDIDO CargaEntregaPedido on CargaEntregaPedido.CEN_CODIGO = cargaEntrega.CEN_CODIGO ";

                if (!JoinInterno.Contains(" CargaPedido "))
                    JoinInterno += "left join T_CARGA_PEDIDO CargaPedido on CargaPedido.CPE_CODIGO = CargaEntregaPedido.CPE_CODIGO ";

                if (!JoinInterno.Contains(" Pedido "))
                    JoinInterno += "left join T_PEDIDO Pedido on Pedido.PED_CODIGO = CargaPedido.PED_CODIGO ";

                whereInterno += $" AND Pedido.PED_DATA_ETA <= convert(datetime,'{filtrosPesquisa.DataFimAbate.ToString(dateFormat)}')";
            }



            string filtro = JoinInterno + whereInterno + ")" + WhereGeral;

            return filtro;
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarProtocolosCargasComTodosCanhotosDigitalizados()
        {
            var consultaCargaConfirmacao = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaConfirmacao>()
                .Where(o => o.DataCorfirmacaoCanhotosDigitalizados.HasValue == true);

            var consultaCanhotoDigitalizado = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Canhotos.Canhoto>()
                .Where(o => o.SituacaoDigitalizacaoCanhoto == SituacaoDigitalizacaoCanhoto.Digitalizado);

            var consultaCanhotoNaoDigitalizado = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Canhotos.Canhoto>()
                .Where(o => o.SituacaoDigitalizacaoCanhoto != SituacaoDigitalizacaoCanhoto.Digitalizado);

            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o =>
                    o.CargaFechada &&
                    o.SituacaoCarga != SituacaoCarga.Cancelada &&
                    o.SituacaoCarga != SituacaoCarga.Anulada
                );

            consultaCarga = consultaCarga.Where(carga => !consultaCargaConfirmacao.Any(canhoto => canhoto.Carga.Codigo == carga.Codigo));
            consultaCarga = consultaCarga.Where(carga => !consultaCanhotoNaoDigitalizado.Any(canhoto => canhoto.Carga.Codigo == carga.Codigo));
            consultaCarga = consultaCarga.Where(carga => consultaCanhotoDigitalizado.Any(canhoto => canhoto.Carga.Codigo == carga.Codigo));

            return consultaCarga;
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarCargaEntrega(FiltroPesquisaCargaEntrega filtrosPesquisa, Dominio.Entidades.Usuario usuarioLogado, string versaoAppLoja = null)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            if (!filtrosPesquisa.PermiteExibirCargaCancelada)
                consultaCarga = consultaCarga.Where(o => o.Entregas.Any() && o.CargaFechada == true && o.SituacaoCarga != SituacaoCarga.Cancelada && o.SituacaoCarga != SituacaoCarga.Anulada);

            if (filtrosPesquisa.ExibirSomenteCargasSubTrecho)
                consultaCarga = consultaCarga.Where(x => x.DadosSumarizados == null || x.DadosSumarizados.CargaTrecho == null || x.DadosSumarizados.CargaTrecho == CargaTrechoSumarizada.SubCarga);


            if (filtrosPesquisa.PermitirBuscarCargasAgrupadasAoPesquisarNumero)
            {
                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.CodigoCargaEmbarcador))
                {
                    if (filtrosPesquisa.FiltrarCargasPorParteDoNumero)
                        consultaCarga = consultaCarga.Where(o => o.CodigoCargaEmbarcador.Contains(filtrosPesquisa.CodigoCargaEmbarcador) || o.CodigosAgrupados.Contains(filtrosPesquisa.CodigoCargaEmbarcador));
                    else
                        consultaCarga = consultaCarga.Where(o => o.CodigoCargaEmbarcador == filtrosPesquisa.CodigoCargaEmbarcador || o.CodigosAgrupados.Contains(filtrosPesquisa.CodigoCargaEmbarcador));
                }
            }
            else
            {
                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.CodigoCargaEmbarcador))
                {
                    if (filtrosPesquisa.FiltrarCargasPorParteDoNumero)
                        consultaCarga = consultaCarga.Where(o => o.CodigoCargaEmbarcador.Contains(filtrosPesquisa.CodigoCargaEmbarcador));
                    else
                        consultaCarga = consultaCarga.Where(o => o.CodigoCargaEmbarcador == filtrosPesquisa.CodigoCargaEmbarcador);
                }
            }

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.Placa))
                consultaCarga = consultaCarga.Where(o => o.Veiculo.Placa == filtrosPesquisa.Placa);

            if (filtrosPesquisa.NumeroPedidosEmbarcador?.Count > 0)
            {
                if (filtrosPesquisa.FiltrarCargasPorParteDoNumero)
                {
                    var predicateOr = PredicateBuilder.False<Dominio.Entidades.Embarcador.Cargas.Carga>();

                    foreach (var numeroPedidoEmbarcadorDigitado in filtrosPesquisa.NumeroPedidosEmbarcador)
                    {
                        predicateOr = predicateOr.Or(o => o.Pedidos.Any(p => p.Pedido.NumeroPedidoEmbarcador.Contains(numeroPedidoEmbarcadorDigitado)));
                    }

                    consultaCarga = consultaCarga.Where(predicateOr);
                }
                else
                    consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => filtrosPesquisa.NumeroPedidosEmbarcador.Contains(p.Pedido.NumeroPedidoEmbarcador)));
            }

            if (filtrosPesquisa.NumeroPedido > 0)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.Numero == filtrosPesquisa.NumeroPedido));

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroPedidoCliente))
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.CodigoPedidoCliente == filtrosPesquisa.NumeroPedidoCliente));


            if (filtrosPesquisa.CodigosFilialVenda?.Count > 0)
            {
                var queryPedidosFilial = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

                if (filtrosPesquisa.CodigosFilialVenda.Any(x => x == -1))
                    consultaCarga = consultaCarga.Where(o => (from obj in queryPedidosFilial
                                                              where filtrosPesquisa.CodigosFilialVenda.Contains(obj.Pedido.FilialVenda.Codigo) || filtrosPesquisa.Recebedor.Contains(obj.Recebedor.CPF_CNPJ)
                                                              select obj.Carga.Codigo).Contains(o.Codigo));
                else
                    consultaCarga = consultaCarga.Where(o => (from obj in queryPedidosFilial
                                                              where filtrosPesquisa.CodigosFilialVenda.Contains(obj.Pedido.FilialVenda.Codigo)
                                                              select obj.Carga.Codigo).Contains(o.Codigo));
            }


            if (filtrosPesquisa.ModalTransporte > 0)
            {
                var queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

                consultaCarga = consultaCarga.Where(o => (from obj in queryCargaPedido
                                                          where obj.TipoCobrancaMultimodal == filtrosPesquisa.ModalTransporte
                                                          select obj.Carga.Codigo).Contains(o.Codigo));
            }


            if (filtrosPesquisa.SituacaoResponsavel == SituacaoResponsavelEntrega.ComResponsavel)
                consultaCarga = consultaCarga.Where(o => o.ResponsavelEntrega != null);
            else if (filtrosPesquisa.SituacaoResponsavel == SituacaoResponsavelEntrega.SemResponsavel)
                consultaCarga = consultaCarga.Where(o => o.ResponsavelEntrega == null);

            if (filtrosPesquisa.CodigoResponsavelEntrega > 0)
                consultaCarga = consultaCarga.Where(o => o.ResponsavelEntrega.Codigo == filtrosPesquisa.CodigoResponsavelEntrega);

            if (filtrosPesquisa.DataInicial != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.DataCriacaoCarga >= filtrosPesquisa.DataInicial);

            if (filtrosPesquisa.DataLimite != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.DataCriacaoCarga < filtrosPesquisa.DataLimite.AddDays(1));

            if (filtrosPesquisa.DataCarregamentoCargaInicial != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.DataCarregamentoCarga >= filtrosPesquisa.DataCarregamentoCargaInicial);

            if (filtrosPesquisa.DataCarregamentoCargaFinal != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.DataCarregamentoCarga < filtrosPesquisa.DataCarregamentoCargaFinal);

            if (filtrosPesquisa.CodigosFilial.Any(codigo => codigo == -1))
                consultaCarga = consultaCarga.Where(o => filtrosPesquisa.CodigosFilial.Contains(o.Filial.Codigo) || o.Pedidos.Any(ped => ped.Recebedor != null && filtrosPesquisa.Recebedor.Contains(ped.Recebedor.CPF_CNPJ)));
            else if (filtrosPesquisa.CodigosFilial?.Count > 0)
                consultaCarga = consultaCarga.Where(o => filtrosPesquisa.CodigosFilial.Contains(o.Filial.Codigo));

            if (filtrosPesquisa.CpfCnpjDestinatarios?.Count > 0)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => filtrosPesquisa.CpfCnpjDestinatarios.Contains(p.Pedido.Destinatario.CPF_CNPJ)));

            if (filtrosPesquisa.CodigosVendedor?.Count > 0)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => filtrosPesquisa.CodigosVendedor.Contains(p.Pedido.FuncionarioVendedor.Codigo)));

            if (filtrosPesquisa.CodigosSupervisor?.Count > 0)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => filtrosPesquisa.CodigosSupervisor.Contains(p.Pedido.FuncionarioSupervisor.Codigo)));

            if (filtrosPesquisa.CodigosGerente?.Count > 0)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => filtrosPesquisa.CodigosGerente.Contains(p.Pedido.FuncionarioGerente.Codigo)));

            if (filtrosPesquisa.CodigosTransportador?.Count > 0)
                consultaCarga = consultaCarga.Where(o => filtrosPesquisa.CodigosTransportador.Contains(o.Empresa.Codigo));

            if (filtrosPesquisa.CodigosVeiculo?.Count > 0)
                consultaCarga = consultaCarga.Where(o => filtrosPesquisa.CodigosVeiculo.Contains(o.Veiculo.Codigo));

            if (filtrosPesquisa.CodigosMotorista?.Count > 0)
                consultaCarga = consultaCarga.Where(o => o.Motoristas.Any(m => filtrosPesquisa.CodigosMotorista.Contains(m.Codigo)));

            if (filtrosPesquisa.ExibirSomenteCargasComVeiculo)
                consultaCarga = consultaCarga.Where(o => o.Veiculo != null);

            if (filtrosPesquisa.CpfCnpjExpedidores?.Count > 0)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => filtrosPesquisa.CpfCnpjExpedidores.Contains(p.Expedidor.CPF_CNPJ)));

            if (filtrosPesquisa.CodigoEmpresa > 0)
                consultaCarga = consultaCarga.Where(o => o.Empresa.Codigo == filtrosPesquisa.CodigoEmpresa);

            if (filtrosPesquisa.CodigoOrigem > 0)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Origem.Codigo == filtrosPesquisa.CodigoOrigem));

            if (filtrosPesquisa.CodigoDestino > 0)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Destino.Codigo == filtrosPesquisa.CodigoDestino));

            if (filtrosPesquisa.CodigoVeiculo > 0)
                consultaCarga = consultaCarga.Where(o => o.Veiculo.Codigo == filtrosPesquisa.CodigoVeiculo);

            if (filtrosPesquisa.CodigoMotorista > 0)
                consultaCarga = consultaCarga.Where(o => o.Motoristas.Any(m => m.Codigo == filtrosPesquisa.CodigoMotorista));

            if (filtrosPesquisa.TipoOperacao > 0)
                consultaCarga = consultaCarga.Where(o => o.TipoOperacao.Codigo == filtrosPesquisa.TipoOperacao);

            if (filtrosPesquisa.CnpjRemetente > 0)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.Remetente.CPF_CNPJ == filtrosPesquisa.CnpjRemetente));

            if (filtrosPesquisa.CnpjDestinatario > 0)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.Destinatario.CPF_CNPJ == filtrosPesquisa.CnpjDestinatario));

            if (filtrosPesquisa.CnpjTomador > 0)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.Tomador.CPF_CNPJ == filtrosPesquisa.CnpjTomador));

            if (filtrosPesquisa.DataInicioEmissao != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.DataInicioEmissaoDocumentos >= filtrosPesquisa.DataInicioEmissao);

            if (filtrosPesquisa.DataFinalEmissao != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.DataFinalizacaoEmissao <= filtrosPesquisa.DataFinalEmissao);

            if (filtrosPesquisa.CodigosCarga?.Count > 0)
                consultaCarga = consultaCarga.Where(o => filtrosPesquisa.CodigosCarga.Contains(o.Codigo));

            if (filtrosPesquisa.CpfCnpjRemetentes == null)
                filtrosPesquisa.CpfCnpjRemetentes = new List<double>();

            List<double> listaEmitentesRemetentes = filtrosPesquisa.CpfCnpjRemetentes.Union(filtrosPesquisa.CpfCnpjEmitentes ?? new List<double>()).ToList();

            if (listaEmitentesRemetentes.Count > 0)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => listaEmitentesRemetentes.Contains(p.Pedido.Remetente.CPF_CNPJ)));

            if (filtrosPesquisa.CodigosStatusViagem != null && filtrosPesquisa.CodigosStatusViagem.Count > 0)
                consultaCarga = consultaCarga.Where(o => o.Monitoramento.Any(monitoramento => filtrosPesquisa.CodigosStatusViagem.Contains(monitoramento.StatusViagem.Codigo)));

            if (filtrosPesquisa.StatusViagem.HasValue)
            {
                if (filtrosPesquisa.StatusViagem.Value == StatusViagemControleEntrega.EmAndamento)
                    consultaCarga = consultaCarga.Where(o => o.DataInicioViagem != null && o.DataFimViagem == null);
                else if (filtrosPesquisa.StatusViagem.Value == StatusViagemControleEntrega.Finalizada)
                    consultaCarga = consultaCarga.Where(o => o.DataFimViagem != null);
                else if (filtrosPesquisa.StatusViagem.Value == StatusViagemControleEntrega.Iniciada)
                    consultaCarga = consultaCarga.Where(o => o.DataInicioViagem != null);
                else if (filtrosPesquisa.StatusViagem.Value == StatusViagemControleEntrega.NaoFinalizada)
                    consultaCarga = consultaCarga.Where(o => o.DataFimViagem == null);
                else if (filtrosPesquisa.StatusViagem.Value == StatusViagemControleEntrega.NaoIniciada)
                    consultaCarga = consultaCarga.Where(o => o.DataInicioViagem == null);
            }

            if (filtrosPesquisa.StatusViagens.Count > 0)
            {
                var predicateOr = PredicateBuilder.False<Dominio.Entidades.Embarcador.Cargas.Carga>();

                foreach (StatusViagemControleEntrega statusViagem in filtrosPesquisa.StatusViagens)
                {
                    switch (statusViagem)
                    {
                        case StatusViagemControleEntrega.EmAndamento:
                            predicateOr = predicateOr.Or(o => o.DataInicioViagem != null && o.DataFimViagem == null);
                            break;

                        case StatusViagemControleEntrega.Finalizada:
                            predicateOr = predicateOr.Or(o => o.DataFimViagem != null);
                            break;

                        case StatusViagemControleEntrega.Iniciada:
                            predicateOr = predicateOr.Or(o => o.DataInicioViagem != null && o.DataFimViagem == null);
                            break;

                        case StatusViagemControleEntrega.NaoFinalizada:
                            predicateOr = predicateOr.Or(o => o.DataFimViagem == null);
                            break;

                        case StatusViagemControleEntrega.NaoIniciada:
                            predicateOr = predicateOr.Or(o => o.DataInicioViagem == null && o.DataFimViagem == null);
                            break;
                    }
                }

                consultaCarga = consultaCarga.Where(predicateOr);
            }


            List<SituacaoCarga> situacoesComEmissao = new List<SituacaoCarga>()
                {
                    SituacaoCarga.EmTransporte,
                    SituacaoCarga.LiberadoPagamento,
                    SituacaoCarga.Encerrada,
                    SituacaoCarga.AgIntegracao,
                    SituacaoCarga.AgImpressaoDocumentos,
                    SituacaoCarga.PendeciaDocumentos
                };


            List<SituacaoCarga> situacoesAposTransporte = new List<SituacaoCarga>()
                {
                    SituacaoCarga.EmTransporte,
                    SituacaoCarga.LiberadoPagamento,
                    SituacaoCarga.Encerrada,
                    SituacaoCarga.AgIntegracao,
                    SituacaoCarga.AgImpressaoDocumentos
                };


            if (!filtrosPesquisa.ExibirEntregaAntesEtapaTransporte)
            {

                consultaCarga = consultaCarga.Where(o =>
                                                    (o.TipoOperacao.ConfiguracaoMobile.ExibirEntregaAntesEtapaTransporte && !o.TipoOperacao.ConfiguracaoMobile.ExibirEntregaEtapaEmissaoDocumentos) ||
                                                    (o.TipoOperacao.ConfiguracaoMobile.ExibirEntregaEtapaEmissaoDocumentos && situacoesComEmissao.Contains(o.SituacaoCarga)) ||
                                                    situacoesAposTransporte.Contains(o.SituacaoCarga) || (o.SituacaoCarga == SituacaoCarga.PendeciaDocumentos && o.AgImportacaoCTe)
                                                    );
            }
            else
            {
                consultaCarga = consultaCarga.Where(o =>
                                                     (o.TipoOperacao.ConfiguracaoMobile.ExibirEntregaAntesEtapaTransporte && !o.TipoOperacao.ConfiguracaoMobile.ExibirEntregaEtapaEmissaoDocumentos) ||
                                                     (o.TipoOperacao.ConfiguracaoMobile.ExibirEntregaEtapaEmissaoDocumentos && situacoesComEmissao.Contains(o.SituacaoCarga)) ||
                                                     !o.TipoOperacao.ConfiguracaoMobile.ExibirEntregaEtapaEmissaoDocumentos
                                                     );


            }

            if (filtrosPesquisa.NumeroNotasFiscais.Count > 0)
                consultaCarga = consultaCarga.Where(o => o.Entregas.Any(e => e.NotasFiscais.Any(n => filtrosPesquisa.NumeroNotasFiscais.Contains(n.PedidoXMLNotaFiscal.XMLNotaFiscal.Codigo))));

            if (filtrosPesquisa.NumeroNotaFiscal != 0)
                consultaCarga = consultaCarga.Where(o => o.Entregas.Any(e => e.NotasFiscais.Any(n => filtrosPesquisa.NumeroNotaFiscal.Equals(n.PedidoXMLNotaFiscal.XMLNotaFiscal.Numero))));

            if (filtrosPesquisa.ExibirSomenteCargasComChamadoAberto)
            {
                var queryChamado = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Chamados.Chamado>();
                var resultQueryChamado = from obj in queryChamado select obj;

                consultaCarga = consultaCarga.Where(o => resultQueryChamado.Where(a => a.Carga.Codigo == o.Codigo && (a.Situacao == SituacaoChamado.Aberto || a.Situacao == SituacaoChamado.EmTratativa)).Any());
            }

            if (filtrosPesquisa.ExibirSomenteCargasComChatNaoLido)
            {
                var queryChatMobile = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.ChatMobileMensagem>();
                var resultQueryChatMobile = from obj in queryChatMobile select obj;

                consultaCarga = consultaCarga.Where(o => resultQueryChatMobile.Where(a => a.Carga.Codigo == o.Codigo && !a.MensagemLida).Any());
            }

            if (filtrosPesquisa.SomenteCargaComEstadiaConfiguraca)
                consultaCarga = consultaCarga.Where(o => o.TipoOperacao != null && o.TipoOperacao.HabilitarCobrancaEstadiaAutomaticaPeloTracking == true);

            if (filtrosPesquisa.CargasComEstadiasGeradas.HasValue)
            {
                var queryCargaOcorrencia = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Ocorrencias.CargaOcorrencia>();
                queryCargaOcorrencia = queryCargaOcorrencia.Where(o => o.OcorrenciaDeEstadia == true);

                if (filtrosPesquisa.CargasComEstadiasGeradas.Value)
                    consultaCarga = consultaCarga.Where(o => queryCargaOcorrencia.Any(c => c.Carga == o));
                else
                    consultaCarga = consultaCarga.Where(o => !queryCargaOcorrencia.Any(c => c.Carga == o));
            }

            if (filtrosPesquisa.ExibirSomenteCargasComReentrega)
                consultaCarga = consultaCarga.Where(o => o.Entregas.Any(e => e.Reentrega));

            if (filtrosPesquisa.ExibirSomenteCargasComMotoristaAppDesatualizado && versaoAppLoja != null)
                consultaCarga = consultaCarga.Where(o => o.Motoristas.Any(e => String.Compare(versaoAppLoja, e.VersaoAPP) > 0));

            if (filtrosPesquisa.DataEntregaPedidoInicial != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.DataEntrega >= filtrosPesquisa.DataEntregaPedidoInicial));

            if (filtrosPesquisa.DataEntregaPedidoFinal != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.DataEntrega <= filtrosPesquisa.DataEntregaPedidoFinal));

            if (filtrosPesquisa.DataPrevisaoEntregaPedidoInicial != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.Entregas.Any(p => p.DataPrevista >= filtrosPesquisa.DataPrevisaoEntregaPedidoInicial));

            if (filtrosPesquisa.DataPrevisaoEntregaPedidoFinal != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.Entregas.Any(p => p.DataPrevista <= filtrosPesquisa.DataPrevisaoEntregaPedidoFinal));

            if (filtrosPesquisa.DataPrevisaoInicioViagemInicial != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(obj => obj.DataInicioViagemPrevista >= filtrosPesquisa.DataPrevisaoInicioViagemInicial);

            if (filtrosPesquisa.DataPrevisaoInicioViagemFinal != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(obj => obj.DataInicioViagemPrevista <= filtrosPesquisa.DataPrevisaoInicioViagemFinal);

            if (filtrosPesquisa.DataEntregaPedidoFinal != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.DataEntrega <= filtrosPesquisa.DataEntregaPedidoFinal));

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.SerieNota))
                consultaCarga = consultaCarga.Where(o => o.Entregas.Any(e => e.NotasFiscais.Any(n => filtrosPesquisa.SerieNota == n.PedidoXMLNotaFiscal.XMLNotaFiscal.Serie)));
            if (filtrosPesquisa.DataEmissaoNotaDe != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.Entregas.Any(e => e.NotasFiscais.Any(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.DataEmissao >= filtrosPesquisa.DataEmissaoNotaDe)));
            if (filtrosPesquisa.DataEmissaoNotaAte != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.Entregas.Any(e => e.NotasFiscais.Any(n => n.PedidoXMLNotaFiscal.XMLNotaFiscal.DataEmissao < filtrosPesquisa.DataEmissaoNotaAte.AddDays(1))));
            if (filtrosPesquisa.NumeroCTeDe > 0)
                consultaCarga = consultaCarga.Where(o => o.CargaCTes.Any(p => p.CTe.Numero >= filtrosPesquisa.NumeroCTeDe));
            if (filtrosPesquisa.NumeroCTeAte > 0)
                consultaCarga = consultaCarga.Where(o => o.CargaCTes.Any(p => p.CTe.Numero <= filtrosPesquisa.NumeroCTeAte));
            if (filtrosPesquisa.SerieCTe > 0)
                consultaCarga = consultaCarga.Where(o => o.CargaCTes.Any(p => p.CTe.Serie.Numero == filtrosPesquisa.SerieCTe));
            if (filtrosPesquisa.DataEmissaoCTeDe != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.CargaCTes.Any(p => p.CTe.DataEmissao.Value >= filtrosPesquisa.DataEmissaoCTeDe));
            if (filtrosPesquisa.DataEmissaoCTeAte != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.CargaCTes.Any(p => p.CTe.DataEmissao.Value < filtrosPesquisa.DataEmissaoCTeAte.AddDays(1)));
            if (filtrosPesquisa.EmpresaDestino > 0)
                consultaCarga = consultaCarga.Where(o => o.Empresa.Codigo == filtrosPesquisa.EmpresaDestino);
            if (filtrosPesquisa.CidadeOrigem > 0)
                consultaCarga = consultaCarga.Where(o => o.CargaCTes.Any(p => p.CTe.LocalidadeInicioPrestacao.Codigo == filtrosPesquisa.CidadeOrigem));
            if (filtrosPesquisa.CidadeDestino > 0)
                consultaCarga = consultaCarga.Where(o => o.CargaCTes.Any(p => p.CTe.LocalidadeTerminoPrestacao.Codigo == filtrosPesquisa.CidadeDestino));
            if (filtrosPesquisa.EstadosOrigem?.Count > 0)
                consultaCarga = consultaCarga.Where(o => o.CargaCTes.Any(p => filtrosPesquisa.EstadosOrigem.Contains(p.CTe.LocalidadeInicioPrestacao.Estado.Sigla)));
            if (filtrosPesquisa.EstadosDestino?.Count > 0)
                consultaCarga = consultaCarga.Where(o => o.CargaCTes.Any(p => filtrosPesquisa.EstadosDestino.Contains(p.CTe.LocalidadeTerminoPrestacao.Estado.Sigla)));
            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroSolicitacao))
                consultaCarga = consultaCarga.Where(o => o.Entregas.Any(e => e.NotasFiscais.Any(n => filtrosPesquisa.NumeroSolicitacao == n.PedidoXMLNotaFiscal.XMLNotaFiscal.NumeroSolicitacao)));
            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroPedidoCF))
                consultaCarga = consultaCarga.Where(o => o.CargaCTes.Any(p => p.CTe.Documentos.Any(r => r.NumeroPedido == filtrosPesquisa.NumeroPedidoCF)));
            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroPedidoEmbarcador))
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.NumeroPedidoEmbarcador == filtrosPesquisa.NumeroPedidoEmbarcador));
            if (filtrosPesquisa.GrupoPessoa > 0)
                consultaCarga = consultaCarga.Where(o => o.GrupoPessoaPrincipal.Codigo == filtrosPesquisa.GrupoPessoa);
            if (filtrosPesquisa.CodigosTipoOperacao?.Count > 0)
                consultaCarga = consultaCarga.Where(o => filtrosPesquisa.CodigosTipoOperacao.Contains(o.TipoOperacao.Codigo));
            if (filtrosPesquisa.CodigosTipoCarga?.Count > 0)
                consultaCarga = consultaCarga.Where(o => filtrosPesquisa.CodigosTipoCarga.Contains(o.TipoDeCarga.Codigo));

            if (filtrosPesquisa.CodigoCargaEmbarcadorMulti?.Count > 0)
                consultaCarga = consultaCarga.Where(o => filtrosPesquisa.CodigoCargaEmbarcadorMulti.Contains(o.Codigo.ToString()));

            if (filtrosPesquisa.Recebedor?.Count > 0 && (!filtrosPesquisa.CodigosFilial.Any(codigo => codigo == -1)))
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => filtrosPesquisa.Recebedor.Contains(p.Recebedor.CPF_CNPJ)));

            if (filtrosPesquisa.ExibirSomenteCargasComRecebedor.HasValue)
            {
                if (filtrosPesquisa.ExibirSomenteCargasComRecebedor.Value)
                    consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Recebedor != null));
                else
                    consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Recebedor == null));
            }

            if (filtrosPesquisa.ExibirSomenteCargasComExpedidor.HasValue)
            {
                if (filtrosPesquisa.ExibirSomenteCargasComExpedidor.Value)
                    consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Expedidor != null));
                else
                    consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Expedidor == null));
            }

            if (filtrosPesquisa.DataProgramadaDescargaInicial != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.PrevisaoEntrega >= filtrosPesquisa.DataProgramadaDescargaInicial));

            if (filtrosPesquisa.DataProgramadaDescargaFinal != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.PrevisaoEntrega <= filtrosPesquisa.DataProgramadaDescargaFinal));


            if (filtrosPesquisa.DataProgramadaColetaInicial != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.Entregas.Any(p => p.DataAgendamento >= filtrosPesquisa.DataProgramadaColetaInicial && p.Coleta));

            if (filtrosPesquisa.DataProgramadaColetaFinal != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.Entregas.Any(p => p.DataAgendamento <= filtrosPesquisa.DataProgramadaColetaFinal && p.Coleta));

            if (filtrosPesquisa.DataAgendamentoInicial != DateTime.MinValue || filtrosPesquisa.DataAgendamentoFinal != DateTime.MinValue)
            {
                if (filtrosPesquisa.DataAgendamentoInicial != DateTime.MinValue && filtrosPesquisa.DataAgendamentoFinal != DateTime.MinValue)
                    consultaCarga = consultaCarga.Where(o => o.Entregas.Any(p => p.DataAgendamento >= filtrosPesquisa.DataAgendamentoInicial && p.DataAgendamento <= filtrosPesquisa.DataAgendamentoFinal && !p.Coleta));

                else if (filtrosPesquisa.DataAgendamentoInicial != DateTime.MinValue && filtrosPesquisa.DataAgendamentoFinal == DateTime.MinValue)
                    consultaCarga = consultaCarga.Where(o => o.Entregas.Any(p => p.DataAgendamento >= filtrosPesquisa.DataAgendamentoInicial && !p.Coleta));

                else if (filtrosPesquisa.DataAgendamentoInicial == DateTime.MinValue && filtrosPesquisa.DataAgendamentoFinal != DateTime.MinValue)
                    consultaCarga = consultaCarga.Where(o => o.Entregas.Any(p => p.DataAgendamento <= filtrosPesquisa.DataAgendamentoFinal && !p.Coleta));
            }

            if (filtrosPesquisa.RetornarCargasQueMonitoro)
                consultaCarga = consultaCarga.Where(o => o.AnalistaResponsavelMonitoramento.Codigo == usuarioLogado.Codigo);

            if (filtrosPesquisa.CanaisEntrega?.Count > 0)
                consultaCarga = consultaCarga.Where(obj => obj.Pedidos.Any(t => filtrosPesquisa.CanaisEntrega.Contains(t.Pedido.CanalEntrega.Codigo)));

            if (filtrosPesquisa.CanaisVenda?.Count > 0)
                consultaCarga = consultaCarga.Where(obj => obj.Pedidos.Any(t => filtrosPesquisa.CanaisVenda.Contains(t.Pedido.CanalVenda.Codigo)));

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.CodigoSap))
                consultaCarga = consultaCarga.Where(obj => obj.Pedidos.Any(p => p.Pedido.Destinatario.CodigoSap == filtrosPesquisa.CodigoSap));

            if (filtrosPesquisa.CentrosCarregamentos?.Count > 0)
            {
                var queryJanelaCarregamento = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamento>()
                    .Where(obj => filtrosPesquisa.CentrosCarregamentos.Contains(obj.CentroCarregamento.Codigo));

                consultaCarga = consultaCarga.Where(obj => queryJanelaCarregamento.Any(j => j.Carga == obj));
            }

            if (filtrosPesquisa.CodigoResponsavelVeiculo > 0)
                consultaCarga = consultaCarga.Where(o => o.Veiculo.FuncionarioResponsavel.Codigo == filtrosPesquisa.CodigoResponsavelVeiculo);

            if (filtrosPesquisa.CentrosResultados?.Count > 0)
                consultaCarga = consultaCarga.Where(obj => obj.Pedidos.Any(t => filtrosPesquisa.CentrosResultados.Contains(t.Pedido.CentroResultado.Codigo)));

            if (filtrosPesquisa.DataInicioViagemInicial != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.DataInicioViagem >= filtrosPesquisa.DataInicioViagemInicial);

            if (filtrosPesquisa.DataInicioViagemFinal != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.DataInicioViagem <= filtrosPesquisa.DataInicioViagemFinal);

            if (filtrosPesquisa.TiposTrecho.Count > 0)
                consultaCarga = consultaCarga.Where(o => filtrosPesquisa.TiposTrecho.Contains(o.TipoTrecho.Codigo));

            if (filtrosPesquisa.DataInicioCriacaoCarga != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.DataCriacaoCarga >= filtrosPesquisa.DataInicioCriacaoCarga);

            if (filtrosPesquisa.DataFinalCriacaoCarga != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.DataCriacaoCarga <= filtrosPesquisa.DataFinalCriacaoCarga);

            if (filtrosPesquisa.CodigosOrigem.Count > 0)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => filtrosPesquisa.CodigosOrigem.Contains(p.Origem.Codigo)));

            if (filtrosPesquisa.CodigosTiposOperacao?.Count > 0)
                consultaCarga = consultaCarga.Where(o => filtrosPesquisa.CodigosTiposOperacao.Contains(o.TipoOperacao.Codigo));

            if (filtrosPesquisa.Filial > 0)
                consultaCarga = consultaCarga.Where(o => o.Filial.Codigo == filtrosPesquisa.Filial);

            if (filtrosPesquisa.SituacoesCarga?.Count > 0)
                consultaCarga = consultaCarga.Where(carga => filtrosPesquisa.SituacoesCarga.Contains(carga.SituacaoCarga));

            if (filtrosPesquisa.SomenteCargasCriticas)
                consultaCarga = consultaCarga.Where(carga => carga.Monitoramento.Any(monitoramento => monitoramento.Critico));

            if (filtrosPesquisa.SomenteCargasComPesquisaRecebedorPendenteResposta)
            {
                var consultaCargaEntregaCheckList = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.ControleEntrega.CargaEntregaCheckList>();
                consultaCarga = consultaCarga.Where(carga =>
                    consultaCargaEntregaCheckList.Any(a => a.CargaEntrega.Carga.Codigo == carga.Codigo && a.TipoCheckList == TipoCheckList.Desembarque && (!a.Respondido)));
            }

            if (filtrosPesquisa.TendenciaEntrega != TendenciaEntrega.Nenhum && filtrosPesquisa.TendenciaColeta != TendenciaEntrega.Nenhum)
            {
                consultaCarga = consultaCarga
         .Where(carga =>
             (
                 carga.Entregas
                     .Where(entrega => entrega.Coleta && entrega.Situacao != SituacaoEntrega.Entregue)
                     .OrderBy(entrega => entrega.Ordem)
                     .Select(entrega => (TendenciaEntrega?)entrega.Tendencia)
                     .FirstOrDefault() ??
                 carga.Entregas
                     .Where(entrega => entrega.Coleta && entrega.Situacao == SituacaoEntrega.Entregue)
                     .OrderByDescending(entrega => entrega.Ordem)
                     .Select(entrega => (TendenciaEntrega?)entrega.Tendencia)
                     .FirstOrDefault()
             ) == filtrosPesquisa.TendenciaColeta
             &&
             (
                 carga.Entregas
                     .Where(entrega => !entrega.Coleta && entrega.Situacao != SituacaoEntrega.Entregue)
                     .OrderBy(entrega => entrega.Ordem)
                     .Select(entrega => (TendenciaEntrega?)entrega.Tendencia)
                     .FirstOrDefault() ??
                 carga.Entregas
                     .Where(entrega => !entrega.Coleta && entrega.Situacao == SituacaoEntrega.Entregue)
                     .OrderByDescending(entrega => entrega.Ordem)
                     .Select(entrega => (TendenciaEntrega?)entrega.Tendencia)
                     .FirstOrDefault()
             ) == filtrosPesquisa.TendenciaEntrega
         );
            }
            else
            {
                if (filtrosPesquisa.TendenciaEntrega != TendenciaEntrega.Nenhum)
                {
                    consultaCarga = consultaCarga
             .Where(carga =>
                 (
                     carga.Entregas
                         .Where(entrega => !entrega.Coleta && entrega.Situacao != SituacaoEntrega.Entregue)
                         .OrderBy(entrega => entrega.Ordem)
                         .Select(entrega => (TendenciaEntrega?)entrega.Tendencia)
                         .FirstOrDefault() ??
                     carga.Entregas
                         .Where(entrega => !entrega.Coleta && entrega.Situacao == SituacaoEntrega.Entregue)
                         .OrderByDescending(entrega => entrega.Ordem)
                         .Select(entrega => (TendenciaEntrega?)entrega.Tendencia)
                         .FirstOrDefault()
                 ) == filtrosPesquisa.TendenciaEntrega
             );
                }

                if (filtrosPesquisa.TendenciaColeta != TendenciaEntrega.Nenhum)
                {
                    consultaCarga = consultaCarga
                    .Where(carga =>
                    (
                     carga.Entregas
                         .Where(entrega => entrega.Coleta && entrega.Situacao != SituacaoEntrega.Entregue)
                         .OrderBy(entrega => entrega.Ordem)
                         .Select(entrega => (TendenciaEntrega?)entrega.Tendencia)
                         .FirstOrDefault() ??
                     carga.Entregas
                         .Where(entrega => entrega.Coleta && entrega.Situacao == SituacaoEntrega.Entregue)
                         .OrderByDescending(entrega => entrega.Ordem)
                         .Select(entrega => (TendenciaEntrega?)entrega.Tendencia)
                         .FirstOrDefault()
                    ) == filtrosPesquisa.TendenciaColeta);
                }
            }


            if (filtrosPesquisa.ClienteComplementar?.Count > 0)
                consultaCarga = consultaCarga.Where(carga => carga.Pedidos.Any(pedido => filtrosPesquisa.ClienteComplementar.Contains(pedido.Pedido.Destinatario.CPF_CNPJ)));

            if (!string.IsNullOrEmpty(filtrosPesquisa.NumeroOrdemPedido))
            {
                if (filtrosPesquisa.NumeroOrdemPedido.Contains(","))
                {
                    List<string> NumeroOrdemFiltro = filtrosPesquisa.NumeroOrdemPedido.Split(',').Select(s => s.Trim()).Distinct().ToList();
                    consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => NumeroOrdemFiltro.Contains(p.Pedido.NumeroOrdem)));
                }
                else
                    consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.NumeroOrdem == filtrosPesquisa.NumeroOrdemPedido));
            }

            if (filtrosPesquisa.VeiculosNoRaio)
                consultaCarga = consultaCarga.Where(o => o.Entregas.Any(entrega => entrega.Situacao == SituacaoEntrega.EmCliente));

            if (filtrosPesquisa.MonitoramentoStatus.Count > 0)
                consultaCarga = consultaCarga.Where(c => c.Monitoramento.Any(m => filtrosPesquisa.MonitoramentoStatus.Contains(m.Status)));

            if (filtrosPesquisa?.TipoAlerta?.Count > 0)
            {
                var consultaMonitoramentoEvento = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Logistica.AlertaMonitor>();

                var resultQueryAlerta = from obj in consultaMonitoramentoEvento select obj;

                consultaCarga = consultaCarga.Where(o => resultQueryAlerta.Where(a => a.Carga.Codigo == o.Codigo && filtrosPesquisa.TipoAlerta.Contains(a.MonitoramentoEvento.Codigo)).Any());
            }

            if (filtrosPesquisa.CodigosTipoOcorrencia != null && filtrosPesquisa.CodigosTipoOcorrencia.Count > 0)
            {
                var consultaOcorrencias = this.SessionNHiBernate
                    .Query<Dominio.Entidades.Embarcador.Cargas.ControleEntrega.OcorrenciaColetaEntrega>()
                    .Where(ocorrencia => filtrosPesquisa.CodigosTipoOcorrencia.Contains(ocorrencia.TipoDeOcorrencia.Codigo))
                    .ToList();

                var codigosEntregasComOcorrencias = consultaOcorrencias
                    .Select(ocorrencia => ocorrencia.CargaEntrega.Codigo)
                    .ToList();

                consultaCarga = consultaCarga.Where(carga =>
                    carga.Entregas.Any(entrega => codigosEntregasComOcorrencias.Contains(entrega.Codigo))
                );
            }

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.EscritorioVenda))
            {
                List<string> listaEscritorios = filtrosPesquisa.EscritorioVenda.Split(',').ToList();

                IQueryable<Dominio.Entidades.Embarcador.Pessoas.ClienteComplementar> queryClienteComplementar = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pessoas.ClienteComplementar>();
                queryClienteComplementar = queryClienteComplementar.Where(cliente => listaEscritorios.Contains(cliente.EscritorioVendas) || filtrosPesquisa.EscritorioVenda.Contains(cliente.EscritorioVendas));

                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => queryClienteComplementar.Select(cliente => cliente.Cliente.CPF_CNPJ).Any(codigo => codigo == p.Pedido.Destinatario.CPF_CNPJ)));
            }

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.Matriz))
            {
                List<string> listaEscritorios = filtrosPesquisa.Matriz.Split(',').ToList();

                IQueryable<Dominio.Entidades.Embarcador.Pessoas.ClienteComplementar> queryClienteComplementar = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pessoas.ClienteComplementar>();
                queryClienteComplementar = queryClienteComplementar.Where(cliente => listaEscritorios.Contains(cliente.Matriz) || filtrosPesquisa.Matriz.Contains(cliente.Matriz));

                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => queryClienteComplementar.Select(cliente => cliente.Cliente.CPF_CNPJ).Any(codigo => codigo == p.Pedido.Destinatario.CPF_CNPJ)));
            }

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.EquipeVendas))
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.EquipeVendas.Contains(filtrosPesquisa.EquipeVendas)));

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.TipoMercadoria))
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.TipoMercadoria.Contains(filtrosPesquisa.TipoMercadoria)));

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.RotaFrete))
                consultaCarga = consultaCarga.Where(o => o.Rota.Descricao == filtrosPesquisa.RotaFrete);

            if (filtrosPesquisa.MesoRegiao?.Count > 0)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.Destinatario.MesoRegiao != null && filtrosPesquisa.MesoRegiao.Contains(p.Pedido.Destinatario.MesoRegiao.Codigo)));

            if (filtrosPesquisa.Regiao.Count > 0)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.Destinatario.Regiao != null && filtrosPesquisa.Regiao.Contains(p.Pedido.Destinatario.Regiao.Codigo)));

            if (filtrosPesquisa.Parqueada.HasValue)
                consultaCarga = consultaCarga.Where(o => o.Parqueada.Value == filtrosPesquisa.Parqueada);

            if (filtrosPesquisa.DataInicioAbate != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.DataETA >= filtrosPesquisa.DataInicioAbate));

            if (filtrosPesquisa.DataFimAbate != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(o => o.Pedidos.Any(p => p.Pedido.DataETA <= filtrosPesquisa.DataFimAbate));

            if (filtrosPesquisa.FiltrarPorProcessamentoEmLote.HasValue && filtrosPesquisa.FiltrarPorProcessamentoEmLote.Value)
            {
                var query = SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.ControleEntrega.ProcessamentoFinalizacaoColetaEntregaEmLote>().Select(p => p.CodigoCarga);
                consultaCarga = consultaCarga.Where(o => !query.Any(p => p == o.Codigo));
            }
            return consultaCarga;
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> _ConsultarDestinatariosCarga(bool cargaOrigem, int carga, string nome, double cpfCnpj, string tipo, Dominio.Entidades.Localidade localidade, string telefone, int codigoGrupoPessoas)
        {
            var result = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            if (!cargaOrigem)
                result = from obj in result where obj.Carga.Codigo == carga select obj;
            else
                result = from obj in result where obj.CargaOrigem.Codigo == carga select obj;

            if (!string.IsNullOrWhiteSpace(nome))
                result = result.Where(o => o.Pedido.Destinatario.Nome.Contains(nome) || o.Pedido.Destinatario.CodigoIntegracao == nome);

            if (!string.IsNullOrWhiteSpace(tipo))
                result = result.Where(o => o.Pedido.Destinatario.Tipo.Equals(tipo));

            if (localidade != null)
                result = result.Where(o => o.Pedido.Destinatario.Localidade == localidade);

            if (!string.IsNullOrWhiteSpace(telefone))
                result = result.Where(o => o.Pedido.Destinatario.Telefone1.Equals(telefone));

            if (cpfCnpj > 0)
                result = result.Where(o => o.Pedido.Destinatario.CPF_CNPJ == cpfCnpj);

            if (codigoGrupoPessoas > 0)
                result = result.Where(o => o.Pedido.Destinatario.GrupoPessoas.Codigo == codigoGrupoPessoas);

            return result;
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> _ConsultarRemetentesCarga(bool cargaOrigem, int carga, string nome, double cpfCnpj, string tipo, Dominio.Entidades.Localidade localidade, string telefone, int codigoGrupoPessoas)
        {
            var result = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            if (!cargaOrigem)
                result = from obj in result where obj.Carga.Codigo == carga select obj;
            else
                result = from obj in result where obj.CargaOrigem.Codigo == carga select obj;

            if (!string.IsNullOrWhiteSpace(nome))
                result = result.Where(o => o.Pedido.Remetente.Nome.Contains(nome) || o.Pedido.Remetente.CodigoIntegracao == nome);

            if (!string.IsNullOrWhiteSpace(tipo))
                result = result.Where(o => o.Pedido.Remetente.Tipo.Equals(tipo));

            if (localidade != null)
                result = result.Where(o => o.Pedido.Remetente.Localidade == localidade);

            if (!string.IsNullOrWhiteSpace(telefone))
                result = result.Where(o => o.Pedido.Remetente.Telefone1.Equals(telefone));

            if (cpfCnpj > 0)
                result = result.Where(o => o.Pedido.Remetente.CPF_CNPJ == cpfCnpj);

            if (codigoGrupoPessoas > 0)
                result = result.Where(o => o.Pedido.Remetente.GrupoPessoas.Codigo == codigoGrupoPessoas);

            return result;
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> montarQueryConsultaComPedido(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCarga filtrosPesquisa)
        {
            Repositorio.Embarcador.Configuracoes.ConfiguracaoComissaoMotorista repConfiguracaoComissaoMotorista = new Repositorio.Embarcador.Configuracoes.ConfiguracaoComissaoMotorista(UnitOfWork);
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoComissaoMotorista configuracaoComissaoMotorista = repConfiguracaoComissaoMotorista.BuscarConfiguracaoPadrao();

            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query select obj;

            if (filtrosPesquisa.ExibirCargasNaoFechadas)
                result = result.Where(obj => obj.CargaFechada || (!obj.CargaFechada && obj.SituacaoCarga == SituacaoCarga.Anulada));
            else
                result = result.Where(obj => obj.CargaFechada);

            var consultouPorNumero = false;

            if (filtrosPesquisa.CodigoCarga > 0)
            {
                result = result.Where(obj => obj.Codigo == filtrosPesquisa.CodigoCarga);

                return result;
            }

            if (filtrosPesquisa.Codigo > 0)
                result = result.Where(obj => obj.Codigo == filtrosPesquisa.Codigo);
            else
            {
                if (filtrosPesquisa.PossuiPendencia.HasValue)
                    result = result.Where(o => o.PossuiPendencia == filtrosPesquisa.PossuiPendencia.Value);

                if (filtrosPesquisa.CodigosModeloDocumentoFiscal?.Count > 0)
                    result = result.Where(o => o.CargaCTes.Any(cte => filtrosPesquisa.CodigosModeloDocumentoFiscal.Contains(cte.CTe.ModeloDocumentoFiscal.Codigo)));

                if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe)
                    result = result.Where(obj => obj.TipoOperacao.OcultarCargasComEsseTipoOperacaoNoPortalTransportador == false || obj.TipoOperacao.OcultarCargasComEsseTipoOperacaoNoPortalTransportador == null);

                if (filtrosPesquisa.SomenteAgrupadas)
                    result = result.Where(obj => obj.CargaAgrupada);

                if (filtrosPesquisa.SomenteCargasReentrega)
                    result = result.Where(obj => obj.Pedidos.Any(cp => cp.ReentregaSolicitada));

                if (filtrosPesquisa.CodigoCarregamento > 0)
                    result = result.Where(obj => obj.Carregamento.Codigo == filtrosPesquisa.CodigoCarregamento);

                if (filtrosPesquisa.NumeroPedido > 0)
                {
                    result = result.Where(o => o.Pedidos.Any(p => p.Pedido.Numero == filtrosPesquisa.NumeroPedido));
                    consultouPorNumero = true;
                }

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroPedidoCliente))
                {
                    result = result.Where(o => o.Pedidos.Any(p => p.Pedido.CodigoPedidoCliente == filtrosPesquisa.NumeroPedidoCliente));
                    consultouPorNumero = true;
                }

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.codigoPedidoEmbarcador))
                {
                    if (filtrosPesquisa.FiltrarCargasPorParteDoNumero)
                        result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.NumeroPedidoEmbarcador.Contains(filtrosPesquisa.codigoPedidoEmbarcador)));
                    else
                        result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.NumeroPedidoEmbarcador == filtrosPesquisa.codigoPedidoEmbarcador));

                    //result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.NumeroPedidoEmbarcador == filtrosPesquisa.codigoPedidoEmbarcador));

                    consultouPorNumero = true;
                }

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroTransporte))
                    result = result.Where(o => o.Pedidos.Any(p => p.Pedido.NotasFiscais.Any(n => n.NumeroTransporte == filtrosPesquisa.NumeroTransporte)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroPedidoTrocado))
                {
                    var consultaTrocaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoTroca>();

                    if (filtrosPesquisa.FiltrarCargasPorParteDoNumero)
                        consultaTrocaPedido = consultaTrocaPedido.Where(o => o.PedidoProvisorio.NumeroPedidoEmbarcador.Contains(filtrosPesquisa.NumeroPedidoTrocado));
                    else
                        consultaTrocaPedido = consultaTrocaPedido.Where(o => o.PedidoProvisorio.NumeroPedidoEmbarcador == filtrosPesquisa.NumeroPedidoTrocado);

                    result = result.Where(obj => consultaTrocaPedido.Any(t => obj.Pedidos.Any(p => p.Pedido.Codigo == t.PedidoDefinitivo.Codigo)));
                }

                if (filtrosPesquisa.TipoContratacaoCarga.HasValue)
                {
                    if (filtrosPesquisa.TipoContratacaoCarga.Value == TipoContratacaoCarga.SVMProprio)
                        result = result.Where(o => o.CargaSVM == true);
                    else if (filtrosPesquisa.TipoContratacaoCarga.Value == TipoContratacaoCarga.SVMTerceiro)
                        result = result.Where(o => o.CargaSVMTerceiro == true);
                    else
                        result = result.Where(o => o.TipoContratacaoCarga == filtrosPesquisa.TipoContratacaoCarga);
                }

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.CodigoCargaEmbarcador))
                {
                    if (filtrosPesquisa.BuscarCargasRedespacho)
                    {
                        //    var predicateRedespacho = PredicateBuilder.True<Dominio.Entidades.Embarcador.Cargas.Carga>();

                        //    predicateRedespacho = predicateRedespacho.And(obj => obj.CodigoCargaEmbarcador == codigoCargaEmbarcador || obj.CodigosAgrupados.Contains(codigoCargaEmbarcador));
                        //    predicateRedespacho = predicateRedespacho.And(obj => obj.Pedidos.Any(p => (p.CargaPedidoProximoTrecho.Carga.CodigoCargaEmbarcador == codigoCargaEmbarcador || p.CargaPedidoTrechoAnterior.Carga.CodigoCargaEmbarcador == codigoCargaEmbarcador)));
                        //    result = result.Where(predicateRedespacho);


                        if (!filtrosPesquisa.FiltrarCargasPorParteDoNumero)
                        {
                            //Alterado OR da consulta do nro carga com codigos agrupados para buscar antes os codigos das cargas praa depois fazer um IN
                            //result = result.Where(obj =>
                            //(
                            //    obj.CodigoCargaEmbarcador == filtrosPesquisa.CodigoCargaEmbarcador
                            //    || obj.CodigosAgrupados.Contains(filtrosPesquisa.CodigoCargaEmbarcador)
                            //)
                            //|| obj.Pedidos.Any(p =>
                            //    (
                            //        p.CargaPedidoProximoTrecho.Carga.CodigoCargaEmbarcador == filtrosPesquisa.CodigoCargaEmbarcador
                            //        || p.CargaPedidoTrechoAnterior.Carga.CodigoCargaEmbarcador == filtrosPesquisa.CodigoCargaEmbarcador
                            //    )
                            //)
                            //);
                            IList<int> codigosCarga = this.BuscarCodigosCargaEmCargasEEmCodigosAgrupados(filtrosPesquisa.CodigoCargaEmbarcador);
                            result = result.Where(obj => codigosCarga.Contains(obj.Codigo)
                                || obj.Pedidos.Any(p =>
                                    (
                                        p.CargaPedidoProximoTrecho.Carga.CodigoCargaEmbarcador == filtrosPesquisa.CodigoCargaEmbarcador
                                        || p.CargaPedidoTrechoAnterior.Carga.CodigoCargaEmbarcador == filtrosPesquisa.CodigoCargaEmbarcador
                                    )
                                )
                            );
                        }
                        else
                        {
                            result = result.Where(obj =>
                            (
                                obj.CodigoCargaEmbarcador.Contains(filtrosPesquisa.CodigoCargaEmbarcador)
                                || obj.CodigosAgrupados.Contains(filtrosPesquisa.CodigoCargaEmbarcador)
                            )
                            || obj.Pedidos.Any(p =>
                                (
                                    p.CargaPedidoProximoTrecho.Carga.CodigoCargaEmbarcador.Contains(filtrosPesquisa.CodigoCargaEmbarcador)
                                    || p.CargaPedidoTrechoAnterior.Carga.CodigoCargaEmbarcador.Contains(filtrosPesquisa.CodigoCargaEmbarcador)
                                )
                            )
                            );
                        }
                    }
                    else
                    {
                        if (!filtrosPesquisa.FiltrarCargasPorParteDoNumero)
                        {
                            //Alterado OR da consulta do nro carga com codigos agrupados para buscar antes os codigos das cargas praa depois fazer um IN
                            //result = result.Where(obj => obj.CodigoCargaEmbarcador == filtrosPesquisa.CodigoCargaEmbarcador || obj.CodigosAgrupados.Contains(filtrosPesquisa.CodigoCargaEmbarcador));
                            IList<int> codigosCarga = this.BuscarCodigosCargaEmCargasEEmCodigosAgrupados(filtrosPesquisa.CodigoCargaEmbarcador);
                            result = result.Where(obj => codigosCarga.Contains(obj.Codigo));
                        }
                        else if (filtrosPesquisa.CargaRelacionadas)
                        {
                            List<int> codigosCarga = this.BuscarCodigosCargaPorExternalIs(filtrosPesquisa.CodigoCargaEmbarcador);
                            result = result.Where(obj => codigosCarga.Contains(obj.Codigo));
                        }
                        else
                            result = result.Where(obj => obj.CodigoCargaEmbarcador.Contains(filtrosPesquisa.CodigoCargaEmbarcador) || obj.CodigosAgrupados.Contains(filtrosPesquisa.CodigoCargaEmbarcador));
                    }
                    consultouPorNumero = true;
                }

                if (filtrosPesquisa.BuscarCargasRedespacho)
                {
                    result = result.Where(obj =>
                                          obj.DadosSumarizados.PossuiRedespacho ||
                                          obj.TipoContratacaoCarga == TipoContratacaoCarga.Redespacho ||
                                          obj.Redespacho != null);
                }

                if (filtrosPesquisa.NumeroCTe > 0)
                {
                    if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.CTe.Numero == filtrosPesquisa.NumeroCTe && cte.CargaCTeComplementoInfo == null) || obj.Pedidos.Any(ped => ped.CTeEmitidoNoEmbarcador && ped.CargaPedidoDocumentosCTe.Any(cte => cte.CTe.Numero == filtrosPesquisa.NumeroCTe)));
                    else
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.CTe.Numero == filtrosPesquisa.NumeroCTe && cte.CargaCTeComplementoInfo == null));

                    consultouPorNumero = true;
                }

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroControle))
                {
                    if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.CTe.NumeroControle.Contains(filtrosPesquisa.NumeroControle)) || obj.Pedidos.Any(ped => ped.CTeEmitidoNoEmbarcador && ped.CargaPedidoDocumentosCTe.Any(cte => cte.CTe.NumeroControle.Contains(filtrosPesquisa.NumeroControle))));
                    else
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.CTe.NumeroControle.Contains(filtrosPesquisa.NumeroControle)));

                    consultouPorNumero = true;
                }

                if (filtrosPesquisa.NumeroMDFe > 0)
                {
                    if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                        result = result.Where(o => o.CargaMDFes.Any(mdf => mdf.MDFe.Numero == filtrosPesquisa.NumeroMDFe) || o.Pedidos.Any(ped => ped.CTeEmitidoNoEmbarcador && ped.CargaPedidoDocumentosMDFe.Any(cpm22 => cpm22.MDFe.Numero == filtrosPesquisa.NumeroMDFe)));
                    else
                        result = result.Where(o => o.CargaMDFes.Any(mdf => mdf.MDFe.Numero == filtrosPesquisa.NumeroMDFe));

                    consultouPorNumero = true;
                }

                if (filtrosPesquisa.NumeroNF > 0)
                {
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.NotasFiscais.Any(nf => nf.XMLNotaFiscal.Numero == filtrosPesquisa.NumeroNF) || ped.CargaPedidoXMLNotasFiscaisParcial.Any(pa => pa.Numero == filtrosPesquisa.NumeroNF)));
                    consultouPorNumero = true;
                }

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroPedidoNFe))
                {
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.NotasFiscais.Any(nf => nf.XMLNotaFiscal.NumeroPedidoEmbarcador == filtrosPesquisa.NumeroPedidoNFe || ped.CargaPedidoXMLNotasFiscaisParcial.Any(pa => pa.Pedido == filtrosPesquisa.NumeroPedidoNFe))));
                    consultouPorNumero = true;
                }

                if (filtrosPesquisa.NumeroCTeSubcontratacao > 0)
                {
                    result = result.Where(o => o.Pedidos.Any(ped => ped.PedidoCTesParaSubContratacao.Any(cte => cte.CTeTerceiro.Numero == filtrosPesquisa.NumeroCTeSubcontratacao)));
                    consultouPorNumero = true;
                }

                if (filtrosPesquisa.Situacoes != null && filtrosPesquisa.Situacoes.Count > 0 && filtrosPesquisa.Situacoes.Any(o => o != SituacaoCarga.NaLogistica))
                {
                    if (filtrosPesquisa.Situacoes != null && (filtrosPesquisa.Situacoes.Count() > 0))
                        result = result.Where(o => filtrosPesquisa.Situacoes.Contains(o.SituacaoCarga));
                }
                else
                {
                    if (!filtrosPesquisa.SomentePermiteAgrupamento)
                    {
                        if (filtrosPesquisa.Situacoes != null && filtrosPesquisa.Situacoes.Any(x => x == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.NaLogistica) && !consultouPorNumero && filtrosPesquisa.CodigoCarregamento == 0)
                        {
                            if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                                result = result.Where(obj => (obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada &&
                                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento &&
                                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada &&
                                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada) || obj.AgConfirmacaoUtilizacaoCredito
                            );
                            else
                                result = result.Where(obj => (obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada &&
                                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte &&
                                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento &&
                                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada &&
                                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada) || obj.AgConfirmacaoUtilizacaoCredito
                            );
                        }
                        else
                        {
                            if (filtrosPesquisa.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.PermiteCTeManual && filtrosPesquisa.CodigoCarregamento == 0)
                            {
                                if (filtrosPesquisa.TipoOperacaoCargaCTeManual == TipoOperacaoCargaCTeManual.NovaCarga)
                                {
                                    result = result.Where(obj => obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova
                                    || obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe);
                                }
                                else
                                {
                                    if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador)
                                        result = result.Where(obj => obj.SituacaoCarga == SituacaoCarga.EmTransporte ||
                                                                 obj.SituacaoCarga == SituacaoCarga.Anulada ||
                                                                 obj.SituacaoCarga == SituacaoCarga.Encerrada);
                                    else

                                        result = result.Where(obj => obj.SituacaoCarga == SituacaoCarga.EmTransporte ||
                                                                 obj.SituacaoCarga == SituacaoCarga.Encerrada);
                                }
                            }
                            else
                            {
                                if (filtrosPesquisa.Situacoes != null && filtrosPesquisa.Situacoes.Any(x => x != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Todas && x != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.NaLogistica && x == 0))
                                    result = result.Where(obj => filtrosPesquisa.Situacoes.Contains(obj.SituacaoCarga));
                            }
                        }
                    }
                    else
                    {
                        if (filtrosPesquisa.RetornarCargaDocumentoEmitido)
                        {
                            result = result.Where(obj => obj.SituacaoCarga == SituacaoCarga.EmTransporte);
                        }
                        else
                        {
                            result = result.Where(obj => (obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova ||
                                 obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete ||
                                 obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgTransportador
                                 || (obj.SituacaoCarga == SituacaoCarga.AgNFe && obj.ExigeNotaFiscalParaCalcularFrete)
                                 )
                                 && !obj.EmitindoCTes && !obj.TipoOperacao.NaoPermiteAgruparCargas && !obj.CargaAgrupada
                             );
                        }
                    }
                }

                if (filtrosPesquisa.SituacoesCargaMercante?.Count > 0)
                {
                    Expression<Func<Dominio.Entidades.Embarcador.Cargas.Carga, bool>> predicateOr = PredicateBuilder.False<Dominio.Entidades.Embarcador.Cargas.Carga>();

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.Cancelada))
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga == SituacaoCarga.Cancelada);

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.Anulada))
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga == SituacaoCarga.Anulada);

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.AguardandoEmissao))
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga == SituacaoCarga.AgNFe && obj.DataRecebimentoUltimaNFe.HasValue);

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.PendenteEmissaoCTe))
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga == SituacaoCarga.AgNFe && !obj.DataRecebimentoUltimaNFe.HasValue);

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.PendenteMDFe))
                        predicateOr = predicateOr.Or(obj => ((bool?)obj.MDFeAquaviarioVinculado ?? false) == false && obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.SituacaoCarga != SituacaoCarga.Anulada &&
                            obj.Pedidos.Any(ped => ped.TipoCobrancaMultimodal == TipoCobrancaMultimodal.CTEAquaviario));

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.PendenteMercante))
                        predicateOr = predicateOr.Or(obj => ((bool?)obj.TodosCTesComMercante ?? false) == false && obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.SituacaoCarga != SituacaoCarga.Anulada &&
                            obj.Pedidos.Any(ped => ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto || ped.TipoServicoMultimodal == TipoServicoMultimodal.VinculadoMultimodalTerceiro || ped.TipoServicoMultimodal == TipoServicoMultimodal.VinculadoMultimodalProprio));

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.PendenteFaturamento))
                        predicateOr = predicateOr.Or(obj => ((bool?)obj.TodosCTesFaturados ?? false) == false && obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.SituacaoCarga != SituacaoCarga.Anulada &&
                            obj.Pedidos.Any(ped => ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorta || ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorta ||
                                ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto || ped.TipoPropostaMultimodal == TipoPropostaMultimodal.Feeder));

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.PendenteIntegracaoCTe))
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga == SituacaoCarga.AgIntegracao);

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.PendenteIntegracaoFatura))
                        predicateOr = predicateOr.Or(obj => ((bool?)obj.TodosCTesFaturadosIntegrados ?? false) == false && obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.SituacaoCarga != SituacaoCarga.Anulada &&
                            obj.Pedidos.Any(ped => ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorta || ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorta ||
                                ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto || ped.TipoPropostaMultimodal == TipoPropostaMultimodal.Feeder));

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.PendenteSVM))
                    {
                        var querySVM = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.CTe.CTeSVMMultimodal>();
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.SituacaoCarga != SituacaoCarga.Anulada &&
                            obj.Pedidos.Any(ped => ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorta) &&
                            obj.CargaCTes.Any(c => !querySVM.Any(s => s.CTeSVM.Status == "A" && s.CTeMultimodal.TipoCTE == Dominio.Enumeradores.TipoCTE.Normal && s.CTeMultimodal.Codigo == c.CTe.Codigo)));
                    }

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.ComErro))
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga == SituacaoCarga.AgIntegracao || obj.SituacaoCarga == SituacaoCarga.PendeciaDocumentos || obj.problemaCTE);// || obj.PossuiPendencia

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.Finalizada))
                    {
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga == SituacaoCarga.Encerrada &&
                            (obj.TodosCTesComMercante || !obj.Pedidos.Any(ped => ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto || ped.TipoServicoMultimodal == TipoServicoMultimodal.VinculadoMultimodalTerceiro)) &&
                            (obj.TodosCTesComManifesto || !obj.Pedidos.Any(ped => ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto || ped.TipoServicoMultimodal == TipoServicoMultimodal.VinculadoMultimodalTerceiro)) &&
                            (obj.TodosCTesFaturados || !obj.Pedidos.Any(ped => ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorta || ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorta || ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto || ped.TipoPropostaMultimodal == TipoPropostaMultimodal.Feeder)) &&
                            (obj.MDFeAquaviarioVinculado || !obj.Pedidos.Any(ped => ped.TipoCobrancaMultimodal == TipoCobrancaMultimodal.CTEAquaviario)));
                    }

                    result = result.Where(predicateOr);
                }

                if (filtrosPesquisa.ConsultaParaGeracaoDocumentos)
                {
                    result = result.Where(obj => (obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada &&
                             obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete &&
                             obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova &&
                             obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe &&
                             obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada));
                    result = result.Where(o => o.CargaSVM != true);
                }

                if (filtrosPesquisa.SomentePermiteMDFeManual)
                    result = result.Where(obj => (obj.CargaMDFes.All(mdf => (mdf.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Encerrado || mdf.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Cancelado || mdf.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Rejeicao)) || obj.CargaMDFes.Count == 0));

                if (filtrosPesquisa.SomenteTerceiros.HasValue && filtrosPesquisa.SomenteTerceiros.Value)
                    result = result.Where(obj => obj.FreteDeTerceiro == true);

                if (filtrosPesquisa.CodigoEmpresa > 0)
                {
                    if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe)
                    {
                        if (filtrosPesquisa.SetarCargaComoBloqueadaEnquantoNaoReceberDesbloqueioViaIntegracaoOuManual)
                        {
                            IQueryable<Dominio.Entidades.Embarcador.Cargas.MensagemAlertaCarga> consultaMensagemAlerta = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.MensagemAlertaCarga>();
                            consultaMensagemAlerta = consultaMensagemAlerta.Where(o =>
                               o.Confirmada == false
                               && ((bool?)o.Bloquear ?? false) == true
                               && o.Tipo == TipoMensagemAlerta.CargaAguardandoDesbloqueio
                            );

                            result = result.Where(o =>
                                 o.Empresa != null
                                 && !consultaMensagemAlerta.Any(alerta => alerta.Entidade.Codigo == o.Codigo)
                             );
                        }

                        Repositorio.Empresa repEmpresa = new Repositorio.Empresa(this.UnitOfWork);
                        Dominio.Entidades.Empresa empresaCTe = repEmpresa.BuscarPorCodigo(filtrosPesquisa.CodigoEmpresa);

                        //if (empresaCTe != null)
                        //{

                        //    if (!filtrosPesquisa.SomentePermiteMDFeManual)
                        //        result = result.Where(obj => obj.Empresa.Codigo == filtrosPesquisa.CodigoEmpresa || (empresaCTe.Filiais != null && empresaCTe.Filiais.Contains(obj.Empresa)) ||
                        //            obj.Pedidos.Any(ped => ped.Pedido.Remetente.CPF_CNPJ == double.Parse(empresaCTe.CNPJ)));
                        //    else
                        //    {
                        //        string raiz = (empresaCTe.CNPJ_SemFormato).Remove(8, 6);
                        //        result = result.Where(obj => obj.Empresa.Codigo == filtrosPesquisa.CodigoEmpresa || (empresaCTe.Filiais != null && empresaCTe.Filiais.Contains(obj.Empresa)) || obj.Empresa.CNPJ.Contains(raiz) ||
                        //            obj.Pedidos.Any(ped => ped.Pedido.Remetente.CPF_CNPJ == double.Parse(empresaCTe.CNPJ)));
                        //    }
                        //}

                        if (empresaCTe != null)
                        {
                            if (filtrosPesquisa.CpfCnpjEmpresasConsulta?.Count == 0)
                            {
                                filtrosPesquisa.CpfCnpjEmpresasConsulta = new List<double>();
                                filtrosPesquisa.CpfCnpjEmpresasConsulta.Add(double.Parse(empresaCTe.CNPJ));

                                if (empresaCTe.Filiais != null)
                                    filtrosPesquisa.CpfCnpjEmpresasConsulta.AddRange(empresaCTe.Filiais.Select(x => double.Parse(x.CNPJ)).ToList());
                            }

                            if (!filtrosPesquisa.SomentePermiteMDFeManual)
                                result = result.Where(obj => filtrosPesquisa.CpfCnpjEmpresasConsulta.Contains(double.Parse(obj.Empresa.CNPJ)) || obj.Pedidos.Any(ped => filtrosPesquisa.CpfCnpjEmpresasConsulta.Contains(ped.Pedido.Remetente.CPF_CNPJ)));
                            else
                            {
                                string raiz = (empresaCTe.CNPJ_SemFormato).Remove(8, 6);
                                result = result.Where(obj => filtrosPesquisa.CpfCnpjEmpresasConsulta.Contains(double.Parse(obj.Empresa.CNPJ)) || obj.Empresa.CNPJ.Contains(raiz) || obj.Pedidos.Any(ped => filtrosPesquisa.CpfCnpjEmpresasConsulta.Contains(ped.Pedido.Remetente.CPF_CNPJ)));
                            }
                        }

                    }
                    else
                    {
                        if (!filtrosPesquisa.SomentePermiteMDFeManual)
                            result = result.Where(obj => obj.Empresa.Codigo == filtrosPesquisa.CodigoEmpresa);
                        else
                        {

                            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(this.UnitOfWork);
                            Dominio.Entidades.Empresa empresaCTe = repEmpresa.BuscarPorCodigo(filtrosPesquisa.CodigoEmpresa);
                            string raiz = (empresaCTe.CNPJ_SemFormato).Remove(8, 6);
                            result = result.Where(obj => obj.Empresa.Codigo == filtrosPesquisa.CodigoEmpresa || obj.Empresa.CNPJ.Contains(raiz));
                        }
                    }
                }

                if (filtrosPesquisa.ApenasEmpresaPermiteEncaixe)
                    result = result.Where(obj => obj.Empresa.PermiteEmitirSubcontratacao);

                if (filtrosPesquisa.CodigosVeiculos?.Count > 0)
                    result = result.Where(obj => filtrosPesquisa.CodigosVeiculos.Contains(obj.Veiculo.Codigo) || obj.VeiculosVinculados.Any(o => filtrosPesquisa.CodigosVeiculos.Contains(o.Codigo)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.PlacaAgrupamento))
                    result = result.Where(obj => obj.PlacaDeAgrupamento == filtrosPesquisa.PlacaAgrupamento);

                if (filtrosPesquisa.CodigoMotorista > 0)
                    result = result.Where(obj => obj.Motoristas.Any(mot => mot.Codigo == filtrosPesquisa.CodigoMotorista));

                if (filtrosPesquisa.CodigosTipoCarga?.Count > 0)
                    result = result.Where(obj => filtrosPesquisa.CodigosTipoCarga.Contains(obj.TipoDeCarga.Codigo) || (filtrosPesquisa.CodigosTipoCarga.Contains(-1) && obj.TipoDeCarga == null));

                if (filtrosPesquisa.CodigoModeloVeicularCarga > 0)
                    result = result.Where(obj => obj.ModeloVeicularCarga.Codigo == filtrosPesquisa.CodigoModeloVeicularCarga);

                if (filtrosPesquisa.CodigosTipoOperacao?.Count > 0)
                    result = result.Where(obj => filtrosPesquisa.CodigosTipoOperacao.Contains(obj.TipoOperacao.Codigo) || (filtrosPesquisa.CodigosTipoOperacao.Contains(-1) && obj.TipoOperacao == null) || (obj.CargaAgrupada && obj.CargasAgrupamento.Any(carAgp => filtrosPesquisa.CodigosTipoOperacao.Contains(carAgp.TipoOperacao.Codigo))));

                if (filtrosPesquisa.CodigosRota?.Count > 0)
                    result = result.Where(obj => filtrosPesquisa.CodigosRota.Contains(obj.Rota.Codigo));

                if (filtrosPesquisa.CodigoPedidoViagemNavio > 0)
                    result = result.Where(obj => obj.PedidoViagemNavio.Codigo == filtrosPesquisa.CodigoPedidoViagemNavio);

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.Ordem))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Ordem.Equals(filtrosPesquisa.Ordem)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.PortoSaida))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.PortoSaida.Equals(filtrosPesquisa.PortoSaida)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.Reserva))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Reserva.Equals(filtrosPesquisa.Reserva)));

                if (filtrosPesquisa.SomenteComReserva)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Reserva != null && ped.Pedido.Reserva != ""));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.TipoEmbarque))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.TipoEmbarque.Equals(filtrosPesquisa.TipoEmbarque)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroBooking))
                {
                    var queryCTe = this.SessionNHiBernate.Query<Dominio.Entidades.ConhecimentoDeTransporteEletronico>();
                    queryCTe = queryCTe.Where(obj => obj.NumeroBooking == filtrosPesquisa.NumeroBooking);
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.NumeroBooking.Equals(filtrosPesquisa.NumeroBooking)));
                }

                if (filtrosPesquisa.PedidoEmpresaResponsavel > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.PedidoEmpresaResponsavel.Codigo == filtrosPesquisa.PedidoEmpresaResponsavel));

                if (filtrosPesquisa.PedidoCentroCusto > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.PedidoCentroCusto.Codigo == filtrosPesquisa.PedidoCentroCusto));

                if (filtrosPesquisa.CargaPerigosa.HasValue && filtrosPesquisa.CargaPerigosa.Value == true)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.PossuiCargaPerigosa == true));

                if (filtrosPesquisa.CargaTrocaDeNota.HasValue && filtrosPesquisa.CargaTrocaDeNota.Value == true)
                    result = result.Where(obj => (obj.Pedidos.Any(ped => ped.Pedido.PedidoTrocaNota == true) || obj.CargaTrocaNota != null));

                if (configuracaoComissaoMotorista.DataBase == DataBaseComissaoMotorista.DataCarregamento)
                {
                    if (filtrosPesquisa.DataInicialEmissao.HasValue)
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.Carga.DataCarregamentoCarga.Value.Date >= filtrosPesquisa.DataInicialEmissao.Value.Date));

                    if (filtrosPesquisa.DataFinalEmissao.HasValue)
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.Carga.DataCarregamentoCarga.Value.Date <= filtrosPesquisa.DataFinalEmissao.Value.Date));
                }
                else
                {
                    if (filtrosPesquisa.DataInicialEmissao.HasValue)
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.CTe.DataEmissao.Value.Date >= filtrosPesquisa.DataInicialEmissao.Value.Date));

                    if (filtrosPesquisa.DataFinalEmissao.HasValue)
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.CTe.DataEmissao.Value.Date <= filtrosPesquisa.DataFinalEmissao.Value.Date));
                }

                if (!string.IsNullOrEmpty(filtrosPesquisa.RaizCNPJ))
                    result = result.Where(obj => obj.CargaCTes.Any(cte => cte.CTe.TomadorPagador.CPF_CNPJ.StartsWith(filtrosPesquisa.RaizCNPJ)));

                if (filtrosPesquisa.DataInicioAverbacao.HasValue)
                {
                    var queryAverbacao = this.SessionNHiBernate.Query<Dominio.Entidades.AverbacaoCTe>();
                    queryAverbacao = queryAverbacao.Where(obj => obj.DataRetorno.Value.Date >= filtrosPesquisa.DataInicioAverbacao.Value.Date);
                    result = result.Where(o => queryAverbacao.Any(p => p.Carga == o));
                }

                if (filtrosPesquisa.DataFimAverbacao.HasValue)
                {
                    var queryAverbacao = this.SessionNHiBernate.Query<Dominio.Entidades.AverbacaoCTe>();
                    queryAverbacao = queryAverbacao.Where(obj => obj.DataRetorno.Value.Date <= filtrosPesquisa.DataFimAverbacao.Value.Date);
                    result = result.Where(o => queryAverbacao.Any(p => p.Carga == o));
                }

                if (filtrosPesquisa.TiposPropostasMultimodal != null && filtrosPesquisa.TiposPropostasMultimodal.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.TiposPropostasMultimodal.Contains(ped.TipoPropostaMultimodal)));

                if (filtrosPesquisa.PortoOrigem > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Porto.Codigo == filtrosPesquisa.PortoOrigem));

                if (filtrosPesquisa.PortoDestino > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.PortoDestino.Codigo == filtrosPesquisa.PortoDestino));

                if (filtrosPesquisa.Container > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Container.Codigo == filtrosPesquisa.Container));

                if (filtrosPesquisa.ListaNumeroOSMae != null || filtrosPesquisa.ListaNumeroOS != null)
                {
                    List<int> codigosPedidosPeloNumeroOSMae = new List<int>();
                    List<int> codigosPedidosPeloNumeroOS = new List<int>();

                    //Verifica se existe cargas que tenhma um numero os igual ao numero os mãe ( da carga escolhida )
                    if (filtrosPesquisa.ListaNumeroOSMae.Count > 0 && !filtrosPesquisa.ListaNumeroOSMae.All(item => item == ""))
                        codigosPedidosPeloNumeroOSMae = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.Pedido>()
                            .Where(ped => filtrosPesquisa.ListaNumeroOSMae.Contains(ped.NumeroOS)).Select(ped => ped.Codigo).ToList();

                    //Verifica se existe cargas que tenhma um numero os igual ao numero os ( da carga escolhida )
                    if (filtrosPesquisa.ListaNumeroOS.Count > 0 && !filtrosPesquisa.ListaNumeroOS.All(item => item == ""))
                        codigosPedidosPeloNumeroOS = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.Pedido>()
                            .Where(ped => filtrosPesquisa.ListaNumeroOS.Contains(ped.NumeroOS)).Select(ped => ped.Codigo).ToList();

                    //Caso exista cargas com o numero os mãe igual, procura por elas primeiro se não achar cargas via numero os mae, procura então pelo numero os
                    if (codigosPedidosPeloNumeroOSMae.Count > 0)
                        result = result.Where(obj => obj.Pedidos.Any(ped => codigosPedidosPeloNumeroOSMae.Contains(ped.Pedido.Codigo)) ||
                                                   (!obj.Pedidos.Any(ped => codigosPedidosPeloNumeroOSMae.Contains(ped.Pedido.Codigo)) &&
                                                     obj.Pedidos.Any(ped => codigosPedidosPeloNumeroOS.Contains(ped.Pedido.Codigo))));

                    //Caso a carga escolhida não tenha numero os mãe procura direto pelo numero os
                    else if (codigosPedidosPeloNumeroOS.Count > 0)
                        result = result.Where(obj => obj.Pedidos.Any(ped => codigosPedidosPeloNumeroOS.Contains(ped.Pedido.Codigo)));
                }

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroOS))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.NumeroOS == filtrosPesquisa.NumeroOS));

                if (filtrosPesquisa.CnpjClienteUsuario > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Remetente.CPF_CNPJ == filtrosPesquisa.CnpjClienteUsuario || ped.Pedido.Destinatario.CPF_CNPJ == filtrosPesquisa.CnpjClienteUsuario));

                if (filtrosPesquisa.CpfCnpjRemetentes?.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.CpfCnpjRemetentes.Contains(ped.Pedido.Remetente.CPF_CNPJ)));

                if (filtrosPesquisa.CpfCnpjDestinatario > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Destinatario.CPF_CNPJ == filtrosPesquisa.CpfCnpjDestinatario));

                if (filtrosPesquisa.CpfCnpjRemetentesOuDestinatarios?.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.CpfCnpjRemetentesOuDestinatarios.Contains(ped.Pedido.Remetente.CPF_CNPJ) || filtrosPesquisa.CpfCnpjRemetentesOuDestinatarios.Contains(ped.Pedido.Destinatario.CPF_CNPJ)));

                if (filtrosPesquisa.CpfCnpjExpedidores?.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.CpfCnpjExpedidores.Contains(ped.Expedidor.CPF_CNPJ)));

                if (filtrosPesquisa.CpfCnpjRecebedores?.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.CpfCnpjRecebedores.Contains(ped.Recebedor.CPF_CNPJ)));

                if (filtrosPesquisa.CpfCnpjRecebedoresOuSemRecebedores?.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.CpfCnpjRecebedoresOuSemRecebedores.Contains(ped.Recebedor.CPF_CNPJ) || ped.Recebedor == null));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.SiglaEstadoOrigem) && filtrosPesquisa.SiglaEstadoOrigem != "0")
                    result = result.Where(o => o.LocaisPrestacao.Any(p => p.LocalidadeInicioPrestacao.Estado.Sigla == filtrosPesquisa.SiglaEstadoOrigem));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.SiglaEstadoDestino) && filtrosPesquisa.SiglaEstadoDestino != "0")
                    result = result.Where(o => o.LocaisPrestacao.Any(p => p.LocalidadeTerminoPrestacao.Estado.Sigla == filtrosPesquisa.SiglaEstadoDestino));

                if (filtrosPesquisa.CodigoGrupoPessoas?.Count > 0)
                {
                    if (filtrosPesquisa.OperadorLogistica == null || !filtrosPesquisa.OperadorLogistica.PossuiFiltroGrupoPessoas || filtrosPesquisa.OperadorLogistica.GrupoPessoas.Any(obj => filtrosPesquisa.CodigoGrupoPessoas.Contains(obj.Codigo)))
                        result = result.Where(obj => filtrosPesquisa.CodigoGrupoPessoas.Contains(obj.GrupoPessoaPrincipal.Codigo));
                }

                if (filtrosPesquisa.CodigosFilial != null && filtrosPesquisa.CodigosFilial.Any(codigo => codigo == -1))
                {
                    if (filtrosPesquisa.CodigosFilial?.Count > 0)
                        result = result.Where(obj => (filtrosPesquisa.CodigosFilial.Contains(obj.Filial.Codigo) ||
                                             obj.Pedidos.Any(ped => ped.Recebedor != null && filtrosPesquisa.CpfCnpjRecebedoresOuSemRecebedores.Contains(ped.Recebedor.CPF_CNPJ))) ||
                                            (obj.CargaAgrupada && obj.CargasAgrupamento.Any(carAgp => filtrosPesquisa.CodigosFilial.Contains(carAgp.Filial.Codigo))) ||
                                            (filtrosPesquisa.CodigosFilial.Contains(obj.FilialOrigem.Codigo))
                                            );
                }
                else
                {
                    if (filtrosPesquisa.CodigosFilial?.Count > 0)
                        result = result.Where(obj => filtrosPesquisa.CodigosFilial.Contains(obj.Filial.Codigo) ||
                        (obj.CargaAgrupada && obj.CargasAgrupamento.Any(carAgp => filtrosPesquisa.CodigosFilial.Contains(carAgp.Filial.Codigo))) ||
                        (filtrosPesquisa.CodigosFilial.Contains(obj.FilialOrigem.Codigo))
                        );
                }

                if (filtrosPesquisa.CodigosFilialVenda != null && filtrosPesquisa.CodigosFilialVenda.Any(codigo => codigo == -1))
                {
                    if (filtrosPesquisa.CodigosFilialVenda?.Count > 0)
                        result = result.Where(obj => (filtrosPesquisa.CodigosFilialVenda.Contains(obj.Pedidos.FirstOrDefault().Pedido.FilialVenda.Codigo)));
                }
                else
                {
                    if (filtrosPesquisa.CodigosFilialVenda?.Count > 0)
                        result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.CodigosFilialVenda.Contains(ped.Pedido.FilialVenda.Codigo)) ||
                        (obj.CargaAgrupada && obj.CargasAgrupamento.Any(carAgp => carAgp.Pedidos.Any(ped => filtrosPesquisa.CodigosFilialVenda.Contains(ped.Pedido.FilialVenda.Codigo)))));
                }

                if (filtrosPesquisa.CodigoOrigem > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Origem.Codigo == filtrosPesquisa.CodigoOrigem));

                if (filtrosPesquisa.CodigoDestino > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Destino.Codigo == filtrosPesquisa.CodigoDestino));

                if (filtrosPesquisa.HabilitarHoraFiltroDataInicialFinalRelatorioCargas)
                {
                    if (filtrosPesquisa.DataInicial.HasValue)
                        result = result.Where(obj => obj.DataCriacaoCarga >= filtrosPesquisa.DataInicial.Value);

                    if (filtrosPesquisa.DataFinal.HasValue)
                        result = result.Where(obj => obj.DataCriacaoCarga <= filtrosPesquisa.DataFinal.Value);
                }
                else
                {
                    if (configuracaoComissaoMotorista.DataBase == DataBaseComissaoMotorista.DataCarregamento)
                    {
                        if (filtrosPesquisa.DataInicial.HasValue)
                            result = result.Where(obj => obj.DataCarregamentoCarga.Value.Date >= filtrosPesquisa.DataInicial.Value.Date);

                        if (filtrosPesquisa.DataFinal.HasValue)
                            result = result.Where(obj => obj.DataCarregamentoCarga.Value.Date <= filtrosPesquisa.DataFinal.Value.Date);
                    }
                    else
                    {
                        if (filtrosPesquisa.DataInicial.HasValue)
                            result = result.Where(obj => obj.DataCriacaoCarga.Date >= filtrosPesquisa.DataInicial.Value.Date);

                        if (filtrosPesquisa.DataFinal.HasValue)
                            result = result.Where(obj => obj.DataCriacaoCarga.Date <= filtrosPesquisa.DataFinal.Value.Date);
                    }
                }

                if (filtrosPesquisa.DataCarregamentoInicial.HasValue)
                    result = result.Where(obj => obj.DataCarregamentoCarga >= filtrosPesquisa.DataCarregamentoInicial.Value.Date);

                if (filtrosPesquisa.DataCarregamentoFinal.HasValue)
                    result = result.Where(obj => obj.DataCarregamentoCarga <= filtrosPesquisa.DataCarregamentoFinal.Value.Date.Add(DateTime.MaxValue.TimeOfDay));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.DeliveryTerm))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.DeliveryTerm == filtrosPesquisa.DeliveryTerm));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.IdAutorizacao))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.IdAutorizacao == filtrosPesquisa.IdAutorizacao));

                if (filtrosPesquisa.DataInclusaoBookingInicial.HasValue)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.DataInclusaoBooking >= filtrosPesquisa.DataInclusaoBookingInicial.Value.Date));

                if (filtrosPesquisa.DataInclusaoBookingLimite.HasValue)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.DataInclusaoBooking <= filtrosPesquisa.DataInclusaoBookingLimite.Value.Date.Add(DateTime.MaxValue.TimeOfDay)));

                if (filtrosPesquisa.DataInclusaoPCPInicial.HasValue)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.DataInclusaoPCP >= filtrosPesquisa.DataInclusaoPCPInicial.Value.Date));

                if (filtrosPesquisa.DataInclusaoPCPLimite.HasValue)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.DataInclusaoPCP <= filtrosPesquisa.DataInclusaoPCPLimite.Value.Date.Add(DateTime.MaxValue.TimeOfDay)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.CodigoPedidoCliente))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.CodigoPedidoCliente == filtrosPesquisa.CodigoPedidoCliente));

                if (filtrosPesquisa.CodigoOperador > 0)
                {
                    if (filtrosPesquisa.OperadorLogistica != null && filtrosPesquisa.OperadorLogistica.SupervisorLogistica)
                        result = result.Where(obj => obj.Operador.Codigo == filtrosPesquisa.CodigoOperador);
                    else
                        result = result.Where(obj => obj.Operador.Codigo == filtrosPesquisa.CodigoOperador || obj.Operador == null);
                }

                if (filtrosPesquisa?.CodigosCentroResultado?.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.CodigosCentroResultado.Contains(ped.Pedido.CentroResultado.Codigo)));

                var predicateAnd = PredicateBuilder.True<Dominio.Entidades.Embarcador.Cargas.Carga>();

                //if (operadorFiliais.Count > 0)
                //{
                //    List<Dominio.Entidades.Embarcador.Filiais.Filial> filiais = (from obj in operadorFiliais select obj.Filial).Distinct().ToList();
                //    predicateAnd = predicateAnd.And(obj => filiais.Contains(obj.Filial));
                //}

                if (filtrosPesquisa.OperadorLogistica != null && filtrosPesquisa.OperadorLogistica.PossuiFiltroGrupoPessoas)
                {
                    predicateAnd = predicateAnd.And(obj => (filtrosPesquisa.OperadorLogistica.GrupoPessoas.Count > 0 && (filtrosPesquisa.OperadorLogistica.GrupoPessoas.Contains(obj.GrupoPessoaPrincipal) || (filtrosPesquisa.OperadorLogistica.VisualizaCargasSemGrupoPessoas && obj.GrupoPessoaPrincipal == null))));
                }

                //if (operadorTiposCargasModelosVeiculares.Count > 0)
                //{
                //    // use False quando o predicado for criar para criar OR e use True quando predicado for criar and (veja o sql gerado para entender a regra)
                //    var predicateOr = PredicateBuilder.False<Dominio.Entidades.Embarcador.Cargas.Carga>();

                //    foreach (Dominio.ObjetosDeValor.Embarcador.Operacional.OperadorTipoCargaModelosVeiculares operadorTipoCargaModelo in operadorTiposCargasModelosVeiculares)
                //    {
                //        if (operadorTipoCargaModelo.ModelosVeicularCarga.Count > 0)
                //        {
                //            predicateOr = predicateOr.Or(obj => (obj.TipoDeCarga.Codigo == operadorTipoCargaModelo.TipoCarga.Codigo
                //                && (operadorTipoCargaModelo.ModelosVeicularCarga.Contains(obj.ModeloVeicularCarga)
                //                || obj.ModeloVeicularCarga == null)));
                //        }
                //        else
                //        {
                //            predicateOr = predicateOr.Or(obj => (obj.TipoDeCarga.Codigo == operadorTipoCargaModelo.TipoCarga.Codigo));
                //        }

                //    }
                //    predicateOr = predicateOr.Or(obj => obj.TipoDeCarga == null);
                //    predicateAnd = predicateAnd.And(predicateOr);
                //}

                if (filtrosPesquisa.OperadorLogistica != null && ((filtrosPesquisa.CodigoOperador == 0 && filtrosPesquisa.OperadorLogistica.SupervisorLogistica) || filtrosPesquisa.CodigoOperador == filtrosPesquisa.OperadorLogistica.Usuario.Codigo))
                {
                    var predicateOr = PredicateBuilder.False<Dominio.Entidades.Embarcador.Cargas.Carga>();
                    predicateOr = predicateOr.Or(predicateAnd);
                    predicateOr = predicateOr.Or(obj => obj.Operador.Codigo == filtrosPesquisa.OperadorLogistica.Usuario.Codigo);
                    result = result.Where(predicateOr);
                }
                else
                    result = result.Where(predicateAnd);

                if (filtrosPesquisa.CodigoCanalEntrega > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.CanalEntrega.Codigo == filtrosPesquisa.CodigoCanalEntrega));

                if (filtrosPesquisa.CodigoCanalVenda > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.CanalVenda.Codigo == filtrosPesquisa.CodigoCanalVenda));

                if (filtrosPesquisa.TipoCobrancaMultimodal?.Count > 0)
                    result = result.Where(o => o.Pedidos.Any(ped => filtrosPesquisa.TipoCobrancaMultimodal.Contains(ped.TipoCobrancaMultimodal)));

                if (filtrosPesquisa.CodigoFuncionarioVendedor > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.FuncionarioVendedor.Codigo == filtrosPesquisa.CodigoFuncionarioVendedor));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroEXP))
                    result = result.Where(o => o.Pedidos.Any(p => p.Pedido.NumeroEXP.Contains(filtrosPesquisa.NumeroEXP)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.ObservacaoCTe))
                    result = result.Where(o => o.Pedidos.Any(p => p.Pedido.ObservacaoCTe.Contains(filtrosPesquisa.ObservacaoCTe)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.RotaEmbarcador))
                    result = result.Where(o => o.Pedidos.Any(p => p.Pedido.RotaEmbarcador.Contains(filtrosPesquisa.RotaEmbarcador)));

                if (filtrosPesquisa.CpfCnpjTransportadorTerceiro > 0)
                    result = result.Where(obj => obj.Terceiro.CPF_CNPJ == filtrosPesquisa.CpfCnpjTransportadorTerceiro);

                if (!string.IsNullOrEmpty(filtrosPesquisa.NumeroOe))
                {
                    var consultaOrdemEmbarque = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarque>();
                    consultaOrdemEmbarque = consultaOrdemEmbarque.Where(o => o.Numero == filtrosPesquisa.NumeroOe);
                    result = result.Where(o => consultaOrdemEmbarque.Select(x => x.Carga.Codigo).Any(x => x == o.Codigo));
                }

                if (filtrosPesquisa.Serie > 0)
                    result = result.Where(obj => obj.CargaCTes.Any(o => o.CTe.Serie.Numero == filtrosPesquisa.Serie));

                if (filtrosPesquisa.CargasAguardandoImportacaoCTe != Dominio.Enumeradores.OpcaoSimNao.Todos)
                {
                    if (filtrosPesquisa.CargasAguardandoImportacaoCTe == Dominio.Enumeradores.OpcaoSimNao.Sim)
                        result = result.Where(obj => obj.LiberadaSemTodosPreCTes == true || obj.AgImportacaoCTe == true);
                    else if (filtrosPesquisa.PermitirFiltrarCargasNaEmissaoManualCteSemTerCtesImportados)
                        result = result.Where(obj => obj.AgImportacaoCTe == false);
                    else
                        result = result.Where(obj => obj.LiberadaSemTodosPreCTes == false && obj.AgImportacaoCTe == false);
                }

                if (filtrosPesquisa.CodigoOperadorInsercao > 0)
                {
                    if (filtrosPesquisa.OperadorLogistica != null && filtrosPesquisa.OperadorLogistica.SupervisorLogistica)
                        result = result.Where(obj => obj.OperadorInsercao.Codigo == filtrosPesquisa.CodigoOperadorInsercao);
                    else
                        result = result.Where(obj => obj.OperadorInsercao.Codigo == filtrosPesquisa.CodigoOperadorInsercao || obj.OperadorInsercao == null);
                }

                if (filtrosPesquisa.SomenteCargasComValePedagio)
                    result = result.Where(obj => obj.DadosSumarizados.PossuiIntegracaoValePedagio);

                if (filtrosPesquisa.SomenteCargasCriticas)
                    result = result.Where(obj => obj.Monitoramento.Any(monitoramento => monitoramento.Critico));

                if (filtrosPesquisa.SomenteCargasSemCIOT)
                    result = result.Where(obj => !obj.CargaCIOTs.Any() || obj.CargaCIOTs.All(ciot => ciot.CIOT == null));

                if (filtrosPesquisa.SomenteCargasComFaturaFake)
                    result = result.Where(obj => obj.PossuiFacturaFake);

                if (filtrosPesquisa.SomenteCargasComDocumentoOriginarioVinculado)
                {
                    IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe> queryDocumentoAnterior = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe>();
                    IQueryable<Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao> queryPedidoCTeSubcontratacao = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao>();

                    result = result.Where(obj => obj.Pedidos.Any(ped => queryDocumentoAnterior.Any(d => d.CargaPedido == ped)) || obj.Pedidos.Any(o => queryPedidoCTeSubcontratacao.Any(p => p.CargaPedido == o)));
                }

                if (filtrosPesquisa.CodigoCIOT > 0)
                    result = result.Where(obj => obj.CargaCIOTs.Any(ciot => ciot.CIOT.Codigo == filtrosPesquisa.CodigoCIOT));

                if (filtrosPesquisa.CodigosEmpresas != null && filtrosPesquisa.CodigosEmpresas.Count > 0)
                    result = result.Where(obj => filtrosPesquisa.CodigosEmpresas.Contains(obj.Empresa.Codigo));

                if (filtrosPesquisa.CodigoZonaTransporte > 0)
                {
                    var consultaZonaTransporte = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaZonaTransporte>();
                    consultaZonaTransporte = consultaZonaTransporte.Where(o => o.ZonaTransporte.Codigo == filtrosPesquisa.CodigoZonaTransporte);
                    result = result.Where(o => consultaZonaTransporte.Select(x => x.Carga.Codigo).Any(x => x == o.Codigo));
                }

                if (filtrosPesquisa.CodigosEmpresa != null && filtrosPesquisa.CodigosEmpresa.Count > 0)
                {
                    if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe)
                    {
                        Repositorio.Empresa repEmpresa = new Repositorio.Empresa(this.UnitOfWork);
                        List<Dominio.Entidades.Empresa> empresasCTe = repEmpresa.BuscarPorCodigos(filtrosPesquisa.CodigosEmpresa);
                        List<Dominio.Entidades.Empresa> filiais = empresasCTe.SelectMany(empresa => empresa.Filiais).ToList();

                        if (!filtrosPesquisa.SomentePermiteMDFeManual)
                            result = result.Where(obj => filtrosPesquisa.CodigosEmpresa.Contains(obj.Empresa.Codigo) || filiais.Contains(obj.Empresa));
                        else
                            result = result.Where(obj => filtrosPesquisa.CodigosEmpresa.Contains(obj.Empresa.Codigo) || filiais.Contains(obj.Empresa) || empresasCTe.Any(o => obj.Empresa.CNPJ.Contains(o.RaizCnpj)));
                    }
                    else
                    {
                        if (!filtrosPesquisa.SomentePermiteMDFeManual)
                            result = result.Where(obj => filtrosPesquisa.CodigosEmpresa.Contains(obj.Empresa.Codigo));
                        else
                        {
                            //Repositorio.Empresa repEmpresa = new Repositorio.Empresa(StringConexao);
                            //List<Dominio.Entidades.Empresa> empresasCTe = repEmpresa.BuscarPorCodigos(filtrosPesquisa.CodigosEmpresa);
                            result = result.Where(obj => filtrosPesquisa.CodigosEmpresa.Contains(obj.Empresa.Codigo)); /*|| empresasCTe.Any(o => obj.Empresa.CNPJ.Contains(o.RaizCnpj))) Causando exeção System.NotSupportedException*/
                        }

                    }
                }
                if (filtrosPesquisa.ApenasMDFeEncerrados)
                    result = result.Where(obj => obj.CargaMDFes.Any(o => o.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Encerrado));

                if (filtrosPesquisa.CargaTrechoSumarizada != null)
                    result = result.Where(obj => obj.DadosSumarizados.CargaTrecho == filtrosPesquisa.CargaTrechoSumarizada || obj.DadosSumarizados.CargaTrecho == null);
            }

            if (filtrosPesquisa.CargasParaEncerramento)
                result = result.Where(obj => obj.SituacaoCarga != SituacaoCarga.Encerrada &&
                                            obj.SituacaoCarga != SituacaoCarga.Anulada &&
                                            obj.SituacaoCarga != SituacaoCarga.Cancelada);

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroOT))
                result = result.Where(o => o.NumeroOT == filtrosPesquisa.NumeroOT);

            if (filtrosPesquisa.FormaIntegracaoNotas != FormaIntegracao.Todos)
                result = result.Where(o => o.FormaIntegracao == filtrosPesquisa.FormaIntegracaoNotas);

            if (filtrosPesquisa.CategoriaOS != null && filtrosPesquisa.CategoriaOS.Count > 0)
                result = result.Where(o => filtrosPesquisa.CategoriaOS.Contains(o.CategoriaOS.Value));

            if (filtrosPesquisa.TipoOSConvertido != null && filtrosPesquisa.TipoOSConvertido.Count > 0)
                result = result.Where(o => filtrosPesquisa.TipoOSConvertido.Contains(o.TipoOSConvertido.Value));

            if (filtrosPesquisa.TipoOS != null && filtrosPesquisa.TipoOS.Count > 0)
                result = result.Where(o => filtrosPesquisa.TipoOS.Contains(o.TipoOS.Value));

            if (filtrosPesquisa.DirecionamentoCustoExtra != null && filtrosPesquisa.DirecionamentoCustoExtra.Count > 0)
                result = result.Where(o => filtrosPesquisa.DirecionamentoCustoExtra.Contains(o.TipoOperacao.ConfiguracaoCarga.DirecionamentoCustoExtra));

            if (filtrosPesquisa.StatusCustoExtra != null && filtrosPesquisa.StatusCustoExtra.Count > 0)
                result = result.Where(o => o.TipoOperacao.ConfiguracaoCarga.UtilizarDirecionamentoCustoExtra && filtrosPesquisa.StatusCustoExtra.Contains(o.StatusCustoExtra.Value));

            if (filtrosPesquisa.SomenteCargasNaoValidadasNaGR)
                result = result.Where(o => o.ProblemaIntegracaoGrMotoristaVeiculo);

            if (filtrosPesquisa.PossuiValePedagio != Dominio.Enumeradores.OpcaoSimNao.Todos)
            {
                if (filtrosPesquisa.PossuiValePedagio == Dominio.Enumeradores.OpcaoSimNao.Nao)
                    result = result.Where(obj => obj.NaoComprarValePedagio);
                else
                    result = result.Where(obj => !obj.NaoComprarValePedagio);
            }

            if (filtrosPesquisa.Regiao != null && filtrosPesquisa.Regiao.Count > 0 && filtrosPesquisa.Mesorregiao != null && filtrosPesquisa.Mesorregiao.Count > 0)
            {
                result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.Regiao.Contains(ped.Pedido.Remetente.Regiao.Codigo)
                    || filtrosPesquisa.Mesorregiao.Contains(ped.Pedido.Remetente.MesoRegiao.Codigo)));
            }
            else
            {
                if (filtrosPesquisa.Regiao != null && filtrosPesquisa.Regiao.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.Regiao.Contains(ped.Pedido.Remetente.Regiao.Codigo)));

                if (filtrosPesquisa.Mesorregiao != null && filtrosPesquisa.Mesorregiao.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.Mesorregiao.Contains(ped.Pedido.Remetente.MesoRegiao.Codigo)));
            }

            if (!string.IsNullOrEmpty(filtrosPesquisa.NumeroPreCarga))
                result = result.Where(o => o.PreCarga.NumeroPreCarga == filtrosPesquisa.NumeroPreCarga);

            if (!string.IsNullOrEmpty(filtrosPesquisa.NumeroContainerVeiculo))
            {
                IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer> queryCargaVeiculoContainer = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaVeiculoContainer>();

                queryCargaVeiculoContainer = queryCargaVeiculoContainer.Where(o => o.NumeroContainer == filtrosPesquisa.NumeroContainerVeiculo);

                return queryCargaVeiculoContainer.Select(o => o.Carga);
            }


            return result;
        }
        private async Task<IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga>> montarQueryConsultaComPedidoAsync(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCarga filtrosPesquisa, CancellationToken cancellation)
        {
            Repositorio.Embarcador.Configuracoes.ConfiguracaoComissaoMotorista repConfiguracaoComissaoMotorista = new Repositorio.Embarcador.Configuracoes.ConfiguracaoComissaoMotorista(UnitOfWork, cancellation);
            Dominio.Entidades.Embarcador.Configuracoes.ConfiguracaoComissaoMotorista configuracaoComissaoMotorista = await repConfiguracaoComissaoMotorista.BuscarConfiguracaoPadraoAsync();

            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query select obj;

            if (filtrosPesquisa.ExibirCargasNaoFechadas)
                result = result.Where(obj => obj.CargaFechada || (!obj.CargaFechada && obj.SituacaoCarga == SituacaoCarga.Anulada));
            else
                result = result.Where(obj => obj.CargaFechada);

            var consultouPorNumero = false;

            if (filtrosPesquisa.CodigoCarga > 0)
            {
                result = result.Where(obj => obj.Codigo == filtrosPesquisa.CodigoCarga);

                return result;
            }

            if (filtrosPesquisa.Codigo > 0)
                result = result.Where(obj => obj.Codigo == filtrosPesquisa.Codigo);
            else
            {
                if (filtrosPesquisa.PossuiPendencia.HasValue)
                    result = result.Where(o => o.PossuiPendencia == filtrosPesquisa.PossuiPendencia.Value);

                if (filtrosPesquisa.CodigosModeloDocumentoFiscal?.Count > 0)
                    result = result.Where(o => o.CargaCTes.Any(cte => filtrosPesquisa.CodigosModeloDocumentoFiscal.Contains(cte.CTe.ModeloDocumentoFiscal.Codigo)));

                if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe)
                    result = result.Where(obj => obj.TipoOperacao.OcultarCargasComEsseTipoOperacaoNoPortalTransportador == false || obj.TipoOperacao.OcultarCargasComEsseTipoOperacaoNoPortalTransportador == null);

                if (filtrosPesquisa.SomenteAgrupadas)
                    result = result.Where(obj => obj.CargaAgrupada);

                if (filtrosPesquisa.SomenteCargasReentrega)
                    result = result.Where(obj => obj.Pedidos.Any(cp => cp.ReentregaSolicitada));

                if (filtrosPesquisa.CodigoCarregamento > 0)
                    result = result.Where(obj => obj.Carregamento.Codigo == filtrosPesquisa.CodigoCarregamento);

                if (filtrosPesquisa.NumeroPedido > 0)
                {
                    result = result.Where(o => o.Pedidos.Any(p => p.Pedido.Numero == filtrosPesquisa.NumeroPedido));
                    consultouPorNumero = true;
                }

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroPedidoCliente))
                {
                    result = result.Where(o => o.Pedidos.Any(p => p.Pedido.CodigoPedidoCliente == filtrosPesquisa.NumeroPedidoCliente));
                    consultouPorNumero = true;
                }

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.codigoPedidoEmbarcador))
                {
                    if (filtrosPesquisa.FiltrarCargasPorParteDoNumero)
                        result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.NumeroPedidoEmbarcador.Contains(filtrosPesquisa.codigoPedidoEmbarcador)));
                    else
                        result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.NumeroPedidoEmbarcador == filtrosPesquisa.codigoPedidoEmbarcador));

                    consultouPorNumero = true;
                }

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroTransporte))
                    result = result.Where(o => o.Pedidos.Any(p => p.Pedido.NotasFiscais.Any(n => n.NumeroTransporte == filtrosPesquisa.NumeroTransporte)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroPedidoTrocado))
                {
                    var consultaTrocaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoTroca>();

                    if (filtrosPesquisa.FiltrarCargasPorParteDoNumero)
                        consultaTrocaPedido = consultaTrocaPedido.Where(o => o.PedidoProvisorio.NumeroPedidoEmbarcador.Contains(filtrosPesquisa.NumeroPedidoTrocado));
                    else
                        consultaTrocaPedido = consultaTrocaPedido.Where(o => o.PedidoProvisorio.NumeroPedidoEmbarcador == filtrosPesquisa.NumeroPedidoTrocado);

                    result = result.Where(obj => consultaTrocaPedido.Any(t => obj.Pedidos.Any(p => p.Pedido.Codigo == t.PedidoDefinitivo.Codigo)));
                }

                if (filtrosPesquisa.TipoContratacaoCarga.HasValue)
                {
                    if (filtrosPesquisa.TipoContratacaoCarga.Value == TipoContratacaoCarga.SVMProprio)
                        result = result.Where(o => o.CargaSVM == true);
                    else if (filtrosPesquisa.TipoContratacaoCarga.Value == TipoContratacaoCarga.SVMTerceiro)
                        result = result.Where(o => o.CargaSVMTerceiro == true);
                    else
                        result = result.Where(o => o.TipoContratacaoCarga == filtrosPesquisa.TipoContratacaoCarga);
                }

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.CodigoCargaEmbarcador))
                {
                    if (filtrosPesquisa.BuscarCargasRedespacho)
                    {

                        if (!filtrosPesquisa.FiltrarCargasPorParteDoNumero)
                        {
                            IList<int> codigosCarga = this.BuscarCodigosCargaEmCargasEEmCodigosAgrupados(filtrosPesquisa.CodigoCargaEmbarcador);
                            result = result.Where(obj => codigosCarga.Contains(obj.Codigo)
                                || obj.Pedidos.Any(p =>
                                    (
                                        p.CargaPedidoProximoTrecho.Carga.CodigoCargaEmbarcador == filtrosPesquisa.CodigoCargaEmbarcador
                                        || p.CargaPedidoTrechoAnterior.Carga.CodigoCargaEmbarcador == filtrosPesquisa.CodigoCargaEmbarcador
                                    )
                                )
                            );
                        }
                        else
                        {
                            result = result.Where(obj =>
                            (
                                obj.CodigoCargaEmbarcador.Contains(filtrosPesquisa.CodigoCargaEmbarcador)
                                || obj.CodigosAgrupados.Contains(filtrosPesquisa.CodigoCargaEmbarcador)
                            )
                            || obj.Pedidos.Any(p =>
                                (
                                    p.CargaPedidoProximoTrecho.Carga.CodigoCargaEmbarcador.Contains(filtrosPesquisa.CodigoCargaEmbarcador)
                                    || p.CargaPedidoTrechoAnterior.Carga.CodigoCargaEmbarcador.Contains(filtrosPesquisa.CodigoCargaEmbarcador)
                                )
                            )
                            );
                        }
                    }
                    else
                    {
                        if (!filtrosPesquisa.FiltrarCargasPorParteDoNumero)
                        {
                            IList<int> codigosCarga = this.BuscarCodigosCargaEmCargasEEmCodigosAgrupados(filtrosPesquisa.CodigoCargaEmbarcador);
                            result = result.Where(obj => codigosCarga.Contains(obj.Codigo));
                        }
                        else if (filtrosPesquisa.CargaRelacionadas)
                        {
                            List<int> codigosCarga = this.BuscarCodigosCargaPorExternalIs(filtrosPesquisa.CodigoCargaEmbarcador);
                            result = result.Where(obj => codigosCarga.Contains(obj.Codigo));
                        }
                        else
                            result = result.Where(obj => obj.CodigoCargaEmbarcador.Contains(filtrosPesquisa.CodigoCargaEmbarcador) || obj.CodigosAgrupados.Contains(filtrosPesquisa.CodigoCargaEmbarcador));
                    }
                    consultouPorNumero = true;
                }

                if (filtrosPesquisa.BuscarCargasRedespacho)
                {
                    result = result.Where(obj =>
                                          obj.DadosSumarizados.PossuiRedespacho ||
                                          obj.TipoContratacaoCarga == TipoContratacaoCarga.Redespacho ||
                                          obj.Redespacho != null);
                }

                if (filtrosPesquisa.NumeroCTe > 0)
                {
                    if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.CTe.Numero == filtrosPesquisa.NumeroCTe && cte.CargaCTeComplementoInfo == null) || obj.Pedidos.Any(ped => ped.CTeEmitidoNoEmbarcador && ped.CargaPedidoDocumentosCTe.Any(cte => cte.CTe.Numero == filtrosPesquisa.NumeroCTe)));
                    else
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.CTe.Numero == filtrosPesquisa.NumeroCTe && cte.CargaCTeComplementoInfo == null));

                    consultouPorNumero = true;
                }

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroControle))
                {
                    if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.CTe.NumeroControle.Contains(filtrosPesquisa.NumeroControle)) || obj.Pedidos.Any(ped => ped.CTeEmitidoNoEmbarcador && ped.CargaPedidoDocumentosCTe.Any(cte => cte.CTe.NumeroControle.Contains(filtrosPesquisa.NumeroControle))));
                    else
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.CTe.NumeroControle.Contains(filtrosPesquisa.NumeroControle)));

                    consultouPorNumero = true;
                }

                if (filtrosPesquisa.NumeroMDFe > 0)
                {
                    if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                        result = result.Where(o => o.CargaMDFes.Any(mdf => mdf.MDFe.Numero == filtrosPesquisa.NumeroMDFe) || o.Pedidos.Any(ped => ped.CTeEmitidoNoEmbarcador && ped.CargaPedidoDocumentosMDFe.Any(cpm22 => cpm22.MDFe.Numero == filtrosPesquisa.NumeroMDFe)));
                    else
                        result = result.Where(o => o.CargaMDFes.Any(mdf => mdf.MDFe.Numero == filtrosPesquisa.NumeroMDFe));

                    consultouPorNumero = true;
                }

                if (filtrosPesquisa.NumeroNF > 0)
                {
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.NotasFiscais.Any(nf => nf.XMLNotaFiscal.Numero == filtrosPesquisa.NumeroNF) || ped.CargaPedidoXMLNotasFiscaisParcial.Any(pa => pa.Numero == filtrosPesquisa.NumeroNF)));
                    consultouPorNumero = true;
                }

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroPedidoNFe))
                {
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.NotasFiscais.Any(nf => nf.XMLNotaFiscal.NumeroPedidoEmbarcador == filtrosPesquisa.NumeroPedidoNFe || ped.CargaPedidoXMLNotasFiscaisParcial.Any(pa => pa.Pedido == filtrosPesquisa.NumeroPedidoNFe))));
                    consultouPorNumero = true;
                }

                if (filtrosPesquisa.NumeroCTeSubcontratacao > 0)
                {
                    result = result.Where(o => o.Pedidos.Any(ped => ped.PedidoCTesParaSubContratacao.Any(cte => cte.CTeTerceiro.Numero == filtrosPesquisa.NumeroCTeSubcontratacao)));
                    consultouPorNumero = true;
                }

                if (filtrosPesquisa.Situacoes != null && filtrosPesquisa.Situacoes.Count > 0 && filtrosPesquisa.Situacoes.Any(o => o != SituacaoCarga.NaLogistica))
                {
                    if (filtrosPesquisa.Situacoes != null && (filtrosPesquisa.Situacoes.Count() > 0))
                        result = result.Where(o => filtrosPesquisa.Situacoes.Contains(o.SituacaoCarga));
                }
                else
                {
                    if (!filtrosPesquisa.SomentePermiteAgrupamento)
                    {
                        if (filtrosPesquisa.Situacoes != null && filtrosPesquisa.Situacoes.Any(x => x == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.NaLogistica) && !consultouPorNumero && filtrosPesquisa.CodigoCarregamento == 0)
                        {
                            if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS)
                                result = result.Where(obj => (obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada &&
                                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento &&
                                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada &&
                                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada) || obj.AgConfirmacaoUtilizacaoCredito
                            );
                            else
                                result = result.Where(obj => (obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Encerrada &&
                                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.EmTransporte &&
                                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.LiberadoPagamento &&
                                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada &&
                                obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada) || obj.AgConfirmacaoUtilizacaoCredito
                            );
                        }
                        else
                        {
                            if (filtrosPesquisa.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.PermiteCTeManual && filtrosPesquisa.CodigoCarregamento == 0)
                            {
                                if (filtrosPesquisa.TipoOperacaoCargaCTeManual == TipoOperacaoCargaCTeManual.NovaCarga)
                                {
                                    result = result.Where(obj => obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova
                                    || obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe);
                                }
                                else
                                {
                                    if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador)
                                        result = result.Where(obj => obj.SituacaoCarga == SituacaoCarga.EmTransporte ||
                                                                 obj.SituacaoCarga == SituacaoCarga.Anulada ||
                                                                 obj.SituacaoCarga == SituacaoCarga.Encerrada);
                                    else

                                        result = result.Where(obj => obj.SituacaoCarga == SituacaoCarga.EmTransporte ||
                                                                 obj.SituacaoCarga == SituacaoCarga.Encerrada);
                                }
                            }
                            else
                            {
                                if (filtrosPesquisa.Situacoes != null && filtrosPesquisa.Situacoes.Any(x => x != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Todas && x != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.NaLogistica && x == 0))
                                    result = result.Where(obj => filtrosPesquisa.Situacoes.Contains(obj.SituacaoCarga));
                            }
                        }
                    }
                    else
                    {
                        if (filtrosPesquisa.RetornarCargaDocumentoEmitido)
                        {
                            result = result.Where(obj => obj.SituacaoCarga == SituacaoCarga.EmTransporte);
                        }
                        else
                        {
                            result = result.Where(obj => (obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova ||
                                 obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete ||
                                 obj.SituacaoCarga == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgTransportador
                                 || (obj.SituacaoCarga == SituacaoCarga.AgNFe && obj.ExigeNotaFiscalParaCalcularFrete)
                                 )
                                 && !obj.EmitindoCTes && !obj.TipoOperacao.NaoPermiteAgruparCargas && !obj.CargaAgrupada
                             );
                        }
                    }
                }

                if (filtrosPesquisa.SituacoesCargaMercante?.Count > 0)
                {
                    Expression<Func<Dominio.Entidades.Embarcador.Cargas.Carga, bool>> predicateOr = PredicateBuilder.False<Dominio.Entidades.Embarcador.Cargas.Carga>();

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.Cancelada))
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga == SituacaoCarga.Cancelada);

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.Anulada))
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga == SituacaoCarga.Anulada);

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.AguardandoEmissao))
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga == SituacaoCarga.AgNFe && obj.DataRecebimentoUltimaNFe.HasValue);

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.PendenteEmissaoCTe))
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga == SituacaoCarga.AgNFe && !obj.DataRecebimentoUltimaNFe.HasValue);

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.PendenteMDFe))
                        predicateOr = predicateOr.Or(obj => ((bool?)obj.MDFeAquaviarioVinculado ?? false) == false && obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.SituacaoCarga != SituacaoCarga.Anulada &&
                            obj.Pedidos.Any(ped => ped.TipoCobrancaMultimodal == TipoCobrancaMultimodal.CTEAquaviario));

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.PendenteMercante))
                        predicateOr = predicateOr.Or(obj => ((bool?)obj.TodosCTesComMercante ?? false) == false && obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.SituacaoCarga != SituacaoCarga.Anulada &&
                            obj.Pedidos.Any(ped => ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto || ped.TipoServicoMultimodal == TipoServicoMultimodal.VinculadoMultimodalTerceiro || ped.TipoServicoMultimodal == TipoServicoMultimodal.VinculadoMultimodalProprio));

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.PendenteFaturamento))
                        predicateOr = predicateOr.Or(obj => ((bool?)obj.TodosCTesFaturados ?? false) == false && obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.SituacaoCarga != SituacaoCarga.Anulada &&
                            obj.Pedidos.Any(ped => ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorta || ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorta ||
                                ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto || ped.TipoPropostaMultimodal == TipoPropostaMultimodal.Feeder));

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.PendenteIntegracaoCTe))
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga == SituacaoCarga.AgIntegracao);

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.PendenteIntegracaoFatura))
                        predicateOr = predicateOr.Or(obj => ((bool?)obj.TodosCTesFaturadosIntegrados ?? false) == false && obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.SituacaoCarga != SituacaoCarga.Anulada &&
                            obj.Pedidos.Any(ped => ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorta || ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorta ||
                                ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto || ped.TipoPropostaMultimodal == TipoPropostaMultimodal.Feeder));

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.PendenteSVM))
                    {
                        var querySVM = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.CTe.CTeSVMMultimodal>();
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.SituacaoCarga != SituacaoCarga.Anulada &&
                            obj.Pedidos.Any(ped => ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorta) &&
                            obj.CargaCTes.Any(c => !querySVM.Any(s => s.CTeSVM.Status == "A" && s.CTeMultimodal.TipoCTE == Dominio.Enumeradores.TipoCTE.Normal && s.CTeMultimodal.Codigo == c.CTe.Codigo)));
                    }

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.ComErro))
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga == SituacaoCarga.AgIntegracao || obj.SituacaoCarga == SituacaoCarga.PendeciaDocumentos || obj.problemaCTE);// || obj.PossuiPendencia

                    if (filtrosPesquisa.SituacoesCargaMercante.Any(o => o == SituacaoCargaMercante.Finalizada))
                    {
                        predicateOr = predicateOr.Or(obj => obj.SituacaoCarga == SituacaoCarga.Encerrada &&
                            (obj.TodosCTesComMercante || !obj.Pedidos.Any(ped => ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto || ped.TipoServicoMultimodal == TipoServicoMultimodal.VinculadoMultimodalTerceiro)) &&
                            (obj.TodosCTesComManifesto || !obj.Pedidos.Any(ped => ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto || ped.TipoServicoMultimodal == TipoServicoMultimodal.VinculadoMultimodalTerceiro)) &&
                            (obj.TodosCTesFaturados || !obj.Pedidos.Any(ped => ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorta || ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorta || ped.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto || ped.TipoPropostaMultimodal == TipoPropostaMultimodal.Feeder)) &&
                            (obj.MDFeAquaviarioVinculado || !obj.Pedidos.Any(ped => ped.TipoCobrancaMultimodal == TipoCobrancaMultimodal.CTEAquaviario)));
                    }

                    result = result.Where(predicateOr);
                }

                if (filtrosPesquisa.ConsultaParaGeracaoDocumentos)
                {
                    result = result.Where(obj => (obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Cancelada &&
                             obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.CalculoFrete &&
                             obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Nova &&
                             obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.AgNFe &&
                             obj.SituacaoCarga != Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga.Anulada));
                    result = result.Where(o => o.CargaSVM != true);
                }

                if (filtrosPesquisa.SomentePermiteMDFeManual)
                    result = result.Where(obj => (obj.CargaMDFes.All(mdf => (mdf.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Encerrado || mdf.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Cancelado || mdf.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Rejeicao)) || obj.CargaMDFes.Count == 0));

                if (filtrosPesquisa.SomenteTerceiros.HasValue && filtrosPesquisa.SomenteTerceiros.Value)
                    result = result.Where(obj => obj.FreteDeTerceiro == true);

                if (filtrosPesquisa.CodigoEmpresa > 0)
                {
                    if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe)
                    {
                        if (filtrosPesquisa.SetarCargaComoBloqueadaEnquantoNaoReceberDesbloqueioViaIntegracaoOuManual)
                        {
                            IQueryable<Dominio.Entidades.Embarcador.Cargas.MensagemAlertaCarga> consultaMensagemAlerta = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.MensagemAlertaCarga>();
                            consultaMensagemAlerta = consultaMensagemAlerta.Where(o =>
                               o.Confirmada == false
                               && ((bool?)o.Bloquear ?? false) == true
                               && o.Tipo == TipoMensagemAlerta.CargaAguardandoDesbloqueio
                            );

                            result = result.Where(o =>
                                 o.Empresa != null
                                 && !consultaMensagemAlerta.Any(alerta => alerta.Entidade.Codigo == o.Codigo)
                             );
                        }

                        Repositorio.Empresa repEmpresa = new Repositorio.Empresa(this.UnitOfWork);
                        Dominio.Entidades.Empresa empresaCTe = repEmpresa.BuscarPorCodigo(filtrosPesquisa.CodigoEmpresa);

                        if (empresaCTe != null)
                        {
                            if (filtrosPesquisa.CpfCnpjEmpresasConsulta?.Count == 0)
                            {
                                filtrosPesquisa.CpfCnpjEmpresasConsulta = new List<double>();
                                filtrosPesquisa.CpfCnpjEmpresasConsulta.Add(double.Parse(empresaCTe.CNPJ));

                                if (empresaCTe.Filiais != null)
                                    filtrosPesquisa.CpfCnpjEmpresasConsulta.AddRange(empresaCTe.Filiais.Select(x => double.Parse(x.CNPJ)).ToList());
                            }

                            if (!filtrosPesquisa.SomentePermiteMDFeManual)
                                result = result.Where(obj => filtrosPesquisa.CpfCnpjEmpresasConsulta.Contains(double.Parse(obj.Empresa.CNPJ)) || obj.Pedidos.Any(ped => filtrosPesquisa.CpfCnpjEmpresasConsulta.Contains(ped.Pedido.Remetente.CPF_CNPJ)));
                            else
                            {
                                string raiz = (empresaCTe.CNPJ_SemFormato).Remove(8, 6);
                                result = result.Where(obj => filtrosPesquisa.CpfCnpjEmpresasConsulta.Contains(double.Parse(obj.Empresa.CNPJ)) || obj.Empresa.CNPJ.Contains(raiz) || obj.Pedidos.Any(ped => filtrosPesquisa.CpfCnpjEmpresasConsulta.Contains(ped.Pedido.Remetente.CPF_CNPJ)));
                            }
                        }
                    }
                    else
                    {
                        if (!filtrosPesquisa.SomentePermiteMDFeManual)
                            result = result.Where(obj => obj.Empresa.Codigo == filtrosPesquisa.CodigoEmpresa);
                        else
                        {

                            Repositorio.Empresa repEmpresa = new Repositorio.Empresa(this.UnitOfWork);
                            Dominio.Entidades.Empresa empresaCTe = repEmpresa.BuscarPorCodigo(filtrosPesquisa.CodigoEmpresa);
                            string raiz = (empresaCTe.CNPJ_SemFormato).Remove(8, 6);
                            result = result.Where(obj => obj.Empresa.Codigo == filtrosPesquisa.CodigoEmpresa || obj.Empresa.CNPJ.Contains(raiz));
                        }
                    }
                }

                if (filtrosPesquisa.ApenasEmpresaPermiteEncaixe)
                    result = result.Where(obj => obj.Empresa.PermiteEmitirSubcontratacao);

                if (filtrosPesquisa.CodigosVeiculos?.Count > 0)
                    result = result.Where(obj => filtrosPesquisa.CodigosVeiculos.Contains(obj.Veiculo.Codigo) || obj.VeiculosVinculados.Any(o => filtrosPesquisa.CodigosVeiculos.Contains(o.Codigo)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.PlacaAgrupamento))
                    result = result.Where(obj => obj.PlacaDeAgrupamento == filtrosPesquisa.PlacaAgrupamento);

                if (filtrosPesquisa.CodigoMotorista > 0)
                    result = result.Where(obj => obj.Motoristas.Any(mot => mot.Codigo == filtrosPesquisa.CodigoMotorista));

                if (filtrosPesquisa.CodigosTipoCarga?.Count > 0)
                    result = result.Where(obj => filtrosPesquisa.CodigosTipoCarga.Contains(obj.TipoDeCarga.Codigo) || (filtrosPesquisa.CodigosTipoCarga.Contains(-1) && obj.TipoDeCarga == null));

                if (filtrosPesquisa.CodigoModeloVeicularCarga > 0)
                    result = result.Where(obj => obj.ModeloVeicularCarga.Codigo == filtrosPesquisa.CodigoModeloVeicularCarga);

                if (filtrosPesquisa.CodigosTipoOperacao?.Count > 0)
                    result = result.Where(obj => filtrosPesquisa.CodigosTipoOperacao.Contains(obj.TipoOperacao.Codigo) || (filtrosPesquisa.CodigosTipoOperacao.Contains(-1) && obj.TipoOperacao == null) || (obj.CargaAgrupada && obj.CargasAgrupamento.Any(carAgp => filtrosPesquisa.CodigosTipoOperacao.Contains(carAgp.TipoOperacao.Codigo))));

                if (filtrosPesquisa.CodigosRota?.Count > 0)
                    result = result.Where(obj => filtrosPesquisa.CodigosRota.Contains(obj.Rota.Codigo));

                if (filtrosPesquisa.CodigoPedidoViagemNavio > 0)
                    result = result.Where(obj => obj.PedidoViagemNavio.Codigo == filtrosPesquisa.CodigoPedidoViagemNavio);

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.Ordem))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Ordem.Equals(filtrosPesquisa.Ordem)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.PortoSaida))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.PortoSaida.Equals(filtrosPesquisa.PortoSaida)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.Reserva))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Reserva.Equals(filtrosPesquisa.Reserva)));

                if (filtrosPesquisa.SomenteComReserva)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Reserva != null && ped.Pedido.Reserva != ""));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.TipoEmbarque))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.TipoEmbarque.Equals(filtrosPesquisa.TipoEmbarque)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroBooking))
                {
                    var queryCTe = this.SessionNHiBernate.Query<Dominio.Entidades.ConhecimentoDeTransporteEletronico>();
                    queryCTe = queryCTe.Where(obj => obj.NumeroBooking == filtrosPesquisa.NumeroBooking);
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.NumeroBooking.Equals(filtrosPesquisa.NumeroBooking)));
                }

                if (filtrosPesquisa.PedidoEmpresaResponsavel > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.PedidoEmpresaResponsavel.Codigo == filtrosPesquisa.PedidoEmpresaResponsavel));

                if (filtrosPesquisa.PedidoCentroCusto > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.PedidoCentroCusto.Codigo == filtrosPesquisa.PedidoCentroCusto));

                if (filtrosPesquisa.CargaPerigosa.HasValue && filtrosPesquisa.CargaPerigosa.Value == true)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.PossuiCargaPerigosa == true));

                if (filtrosPesquisa.CargaTrocaDeNota.HasValue && filtrosPesquisa.CargaTrocaDeNota.Value == true)
                    result = result.Where(obj => (obj.Pedidos.Any(ped => ped.Pedido.PedidoTrocaNota == true) || obj.CargaTrocaNota != null));

                if (configuracaoComissaoMotorista.DataBase == DataBaseComissaoMotorista.DataCarregamento)
                {
                    if (filtrosPesquisa.DataInicialEmissao.HasValue)
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.Carga.DataCarregamentoCarga.Value.Date >= filtrosPesquisa.DataInicialEmissao.Value.Date));

                    if (filtrosPesquisa.DataFinalEmissao.HasValue)
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.Carga.DataCarregamentoCarga.Value.Date <= filtrosPesquisa.DataFinalEmissao.Value.Date));
                }
                else
                {
                    if (filtrosPesquisa.DataInicialEmissao.HasValue)
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.CTe.DataEmissao.Value.Date >= filtrosPesquisa.DataInicialEmissao.Value.Date));

                    if (filtrosPesquisa.DataFinalEmissao.HasValue)
                        result = result.Where(obj => obj.CargaCTes.Any(cte => cte.CTe.DataEmissao.Value.Date <= filtrosPesquisa.DataFinalEmissao.Value.Date));
                }

                if (!string.IsNullOrEmpty(filtrosPesquisa.RaizCNPJ))
                    result = result.Where(obj => obj.CargaCTes.Any(cte => cte.CTe.TomadorPagador.CPF_CNPJ.StartsWith(filtrosPesquisa.RaizCNPJ)));

                if (filtrosPesquisa.DataInicioAverbacao.HasValue)
                {
                    var queryAverbacao = this.SessionNHiBernate.Query<Dominio.Entidades.AverbacaoCTe>();
                    queryAverbacao = queryAverbacao.Where(obj => obj.DataRetorno.Value.Date >= filtrosPesquisa.DataInicioAverbacao.Value.Date);
                    result = result.Where(o => queryAverbacao.Any(p => p.Carga == o));
                }

                if (filtrosPesquisa.DataFimAverbacao.HasValue)
                {
                    var queryAverbacao = this.SessionNHiBernate.Query<Dominio.Entidades.AverbacaoCTe>();
                    queryAverbacao = queryAverbacao.Where(obj => obj.DataRetorno.Value.Date <= filtrosPesquisa.DataFimAverbacao.Value.Date);
                    result = result.Where(o => queryAverbacao.Any(p => p.Carga == o));
                }

                if (filtrosPesquisa.TiposPropostasMultimodal != null && filtrosPesquisa.TiposPropostasMultimodal.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.TiposPropostasMultimodal.Contains(ped.TipoPropostaMultimodal)));

                if (filtrosPesquisa.PortoOrigem > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Porto.Codigo == filtrosPesquisa.PortoOrigem));

                if (filtrosPesquisa.PortoDestino > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.PortoDestino.Codigo == filtrosPesquisa.PortoDestino));

                if (filtrosPesquisa.Container > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Container.Codigo == filtrosPesquisa.Container));

                if (filtrosPesquisa.ListaNumeroOSMae != null || filtrosPesquisa.ListaNumeroOS != null)
                {
                    List<int> codigosPedidosPeloNumeroOSMae = new List<int>();
                    List<int> codigosPedidosPeloNumeroOS = new List<int>();

                    //Verifica se existe cargas que tenhma um numero os igual ao numero os mãe ( da carga escolhida )
                    if (filtrosPesquisa.ListaNumeroOSMae.Count > 0 && !filtrosPesquisa.ListaNumeroOSMae.All(item => item == ""))
                        codigosPedidosPeloNumeroOSMae = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.Pedido>()
                            .Where(ped => filtrosPesquisa.ListaNumeroOSMae.Contains(ped.NumeroOS)).Select(ped => ped.Codigo).ToList();

                    //Verifica se existe cargas que tenhma um numero os igual ao numero os ( da carga escolhida )
                    if (filtrosPesquisa.ListaNumeroOS.Count > 0 && !filtrosPesquisa.ListaNumeroOS.All(item => item == ""))
                        codigosPedidosPeloNumeroOS = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.Pedido>()
                            .Where(ped => filtrosPesquisa.ListaNumeroOS.Contains(ped.NumeroOS)).Select(ped => ped.Codigo).ToList();

                    //Caso exista cargas com o numero os mãe igual, procura por elas primeiro se não achar cargas via numero os mae, procura então pelo numero os
                    if (codigosPedidosPeloNumeroOSMae.Count > 0)
                        result = result.Where(obj => obj.Pedidos.Any(ped => codigosPedidosPeloNumeroOSMae.Contains(ped.Pedido.Codigo)) ||
                                                   (!obj.Pedidos.Any(ped => codigosPedidosPeloNumeroOSMae.Contains(ped.Pedido.Codigo)) &&
                                                     obj.Pedidos.Any(ped => codigosPedidosPeloNumeroOS.Contains(ped.Pedido.Codigo))));

                    //Caso a carga escolhida não tenha numero os mãe procura direto pelo numero os
                    else if (codigosPedidosPeloNumeroOS.Count > 0)
                        result = result.Where(obj => obj.Pedidos.Any(ped => codigosPedidosPeloNumeroOS.Contains(ped.Pedido.Codigo)));
                }

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroOS))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.NumeroOS == filtrosPesquisa.NumeroOS));

                if (filtrosPesquisa.CnpjClienteUsuario > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Remetente.CPF_CNPJ == filtrosPesquisa.CnpjClienteUsuario || ped.Pedido.Destinatario.CPF_CNPJ == filtrosPesquisa.CnpjClienteUsuario));

                if (filtrosPesquisa.CpfCnpjRemetentes?.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.CpfCnpjRemetentes.Contains(ped.Pedido.Remetente.CPF_CNPJ)));

                if (filtrosPesquisa.CpfCnpjDestinatario > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Destinatario.CPF_CNPJ == filtrosPesquisa.CpfCnpjDestinatario));

                if (filtrosPesquisa.CpfCnpjRemetentesOuDestinatarios?.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.CpfCnpjRemetentesOuDestinatarios.Contains(ped.Pedido.Remetente.CPF_CNPJ) || filtrosPesquisa.CpfCnpjRemetentesOuDestinatarios.Contains(ped.Pedido.Destinatario.CPF_CNPJ)));

                if (filtrosPesquisa.CpfCnpjExpedidores?.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.CpfCnpjExpedidores.Contains(ped.Expedidor.CPF_CNPJ)));

                if (filtrosPesquisa.CpfCnpjRecebedores?.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.CpfCnpjRecebedores.Contains(ped.Recebedor.CPF_CNPJ)));

                if (filtrosPesquisa.CpfCnpjRecebedoresOuSemRecebedores?.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.CpfCnpjRecebedoresOuSemRecebedores.Contains(ped.Recebedor.CPF_CNPJ) || ped.Recebedor == null));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.SiglaEstadoOrigem) && filtrosPesquisa.SiglaEstadoOrigem != "0")
                    result = result.Where(o => o.LocaisPrestacao.Any(p => p.LocalidadeInicioPrestacao.Estado.Sigla == filtrosPesquisa.SiglaEstadoOrigem));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.SiglaEstadoDestino) && filtrosPesquisa.SiglaEstadoDestino != "0")
                    result = result.Where(o => o.LocaisPrestacao.Any(p => p.LocalidadeTerminoPrestacao.Estado.Sigla == filtrosPesquisa.SiglaEstadoDestino));

                if (filtrosPesquisa.CodigoGrupoPessoas?.Count > 0)
                {
                    if (filtrosPesquisa.OperadorLogistica == null || !filtrosPesquisa.OperadorLogistica.PossuiFiltroGrupoPessoas || filtrosPesquisa.OperadorLogistica.GrupoPessoas.Any(obj => filtrosPesquisa.CodigoGrupoPessoas.Contains(obj.Codigo)))
                        result = result.Where(obj => filtrosPesquisa.CodigoGrupoPessoas.Contains(obj.GrupoPessoaPrincipal.Codigo));
                }

                if (filtrosPesquisa.CodigosFilial != null && filtrosPesquisa.CodigosFilial.Any(codigo => codigo == -1))
                {
                    if (filtrosPesquisa.CodigosFilial?.Count > 0)
                        result = result.Where(obj => (filtrosPesquisa.CodigosFilial.Contains(obj.Filial.Codigo) ||
                                             obj.Pedidos.Any(ped => ped.Recebedor != null && filtrosPesquisa.CpfCnpjRecebedoresOuSemRecebedores.Contains(ped.Recebedor.CPF_CNPJ))) ||
                                            (obj.CargaAgrupada && obj.CargasAgrupamento.Any(carAgp => filtrosPesquisa.CodigosFilial.Contains(carAgp.Filial.Codigo))) ||
                                            (filtrosPesquisa.CodigosFilial.Contains(obj.FilialOrigem.Codigo))
                                            );
                }
                else
                {
                    if (filtrosPesquisa.CodigosFilial?.Count > 0)
                        result = result.Where(obj => filtrosPesquisa.CodigosFilial.Contains(obj.Filial.Codigo) ||
                        (obj.CargaAgrupada && obj.CargasAgrupamento.Any(carAgp => filtrosPesquisa.CodigosFilial.Contains(carAgp.Filial.Codigo))) ||
                        (filtrosPesquisa.CodigosFilial.Contains(obj.FilialOrigem.Codigo))
                        );
                }

                if (filtrosPesquisa.CodigosFilialVenda != null && filtrosPesquisa.CodigosFilialVenda.Any(codigo => codigo == -1))
                {
                    if (filtrosPesquisa.CodigosFilialVenda?.Count > 0)
                        result = result.Where(obj => (filtrosPesquisa.CodigosFilialVenda.Contains(obj.Pedidos.FirstOrDefault().Pedido.FilialVenda.Codigo)));
                }
                else
                {
                    if (filtrosPesquisa.CodigosFilialVenda?.Count > 0)
                        result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.CodigosFilialVenda.Contains(ped.Pedido.FilialVenda.Codigo)) ||
                        (obj.CargaAgrupada && obj.CargasAgrupamento.Any(carAgp => carAgp.Pedidos.Any(ped => filtrosPesquisa.CodigosFilialVenda.Contains(ped.Pedido.FilialVenda.Codigo)))));
                }

                if (filtrosPesquisa.CodigoOrigem > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Origem.Codigo == filtrosPesquisa.CodigoOrigem));

                if (filtrosPesquisa.CodigoDestino > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Destino.Codigo == filtrosPesquisa.CodigoDestino));

                if (filtrosPesquisa.HabilitarHoraFiltroDataInicialFinalRelatorioCargas)
                {
                    if (filtrosPesquisa.DataInicial.HasValue)
                        result = result.Where(obj => obj.DataCriacaoCarga >= filtrosPesquisa.DataInicial.Value);

                    if (filtrosPesquisa.DataFinal.HasValue)
                        result = result.Where(obj => obj.DataCriacaoCarga <= filtrosPesquisa.DataFinal.Value);
                }
                else
                {
                    if (configuracaoComissaoMotorista.DataBase == DataBaseComissaoMotorista.DataCarregamento)
                    {
                        if (filtrosPesquisa.DataInicial.HasValue)
                            result = result.Where(obj => obj.DataCarregamentoCarga.Value.Date >= filtrosPesquisa.DataInicial.Value.Date);

                        if (filtrosPesquisa.DataFinal.HasValue)
                            result = result.Where(obj => obj.DataCarregamentoCarga.Value.Date <= filtrosPesquisa.DataFinal.Value.Date);
                    }
                    else
                    {
                        if (filtrosPesquisa.DataInicial.HasValue)
                            result = result.Where(obj => obj.DataCriacaoCarga.Date >= filtrosPesquisa.DataInicial.Value.Date);

                        if (filtrosPesquisa.DataFinal.HasValue)
                            result = result.Where(obj => obj.DataCriacaoCarga.Date <= filtrosPesquisa.DataFinal.Value.Date);
                    }
                }

                if (filtrosPesquisa.DataCarregamentoInicial.HasValue)
                    result = result.Where(obj => obj.DataCarregamentoCarga >= filtrosPesquisa.DataCarregamentoInicial.Value.Date);

                if (filtrosPesquisa.DataCarregamentoFinal.HasValue)
                    result = result.Where(obj => obj.DataCarregamentoCarga <= filtrosPesquisa.DataCarregamentoFinal.Value.Date.Add(DateTime.MaxValue.TimeOfDay));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.DeliveryTerm))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.DeliveryTerm == filtrosPesquisa.DeliveryTerm));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.IdAutorizacao))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.IdAutorizacao == filtrosPesquisa.IdAutorizacao));

                if (filtrosPesquisa.DataInclusaoBookingInicial.HasValue)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.DataInclusaoBooking >= filtrosPesquisa.DataInclusaoBookingInicial.Value.Date));

                if (filtrosPesquisa.DataInclusaoBookingLimite.HasValue)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.DataInclusaoBooking <= filtrosPesquisa.DataInclusaoBookingLimite.Value.Date.Add(DateTime.MaxValue.TimeOfDay)));

                if (filtrosPesquisa.DataInclusaoPCPInicial.HasValue)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.DataInclusaoPCP >= filtrosPesquisa.DataInclusaoPCPInicial.Value.Date));

                if (filtrosPesquisa.DataInclusaoPCPLimite.HasValue)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.DataInclusaoPCP <= filtrosPesquisa.DataInclusaoPCPLimite.Value.Date.Add(DateTime.MaxValue.TimeOfDay)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.CodigoPedidoCliente))
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.CodigoPedidoCliente == filtrosPesquisa.CodigoPedidoCliente));

                if (filtrosPesquisa.CodigoOperador > 0)
                {
                    if (filtrosPesquisa.OperadorLogistica != null && filtrosPesquisa.OperadorLogistica.SupervisorLogistica)
                        result = result.Where(obj => obj.Operador.Codigo == filtrosPesquisa.CodigoOperador);
                    else
                        result = result.Where(obj => obj.Operador.Codigo == filtrosPesquisa.CodigoOperador || obj.Operador == null);
                }

                if (filtrosPesquisa?.CodigosCentroResultado?.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.CodigosCentroResultado.Contains(ped.Pedido.CentroResultado.Codigo)));

                var predicateAnd = PredicateBuilder.True<Dominio.Entidades.Embarcador.Cargas.Carga>();


                if (filtrosPesquisa.OperadorLogistica != null && filtrosPesquisa.OperadorLogistica.PossuiFiltroGrupoPessoas)
                {
                    predicateAnd = predicateAnd.And(obj => (filtrosPesquisa.OperadorLogistica.GrupoPessoas.Count > 0 && (filtrosPesquisa.OperadorLogistica.GrupoPessoas.Contains(obj.GrupoPessoaPrincipal) || (filtrosPesquisa.OperadorLogistica.VisualizaCargasSemGrupoPessoas && obj.GrupoPessoaPrincipal == null))));
                }

                if (filtrosPesquisa.OperadorLogistica != null && ((filtrosPesquisa.CodigoOperador == 0 && filtrosPesquisa.OperadorLogistica.SupervisorLogistica) || filtrosPesquisa.CodigoOperador == filtrosPesquisa.OperadorLogistica.Usuario.Codigo))
                {
                    var predicateOr = PredicateBuilder.False<Dominio.Entidades.Embarcador.Cargas.Carga>();
                    predicateOr = predicateOr.Or(predicateAnd);
                    predicateOr = predicateOr.Or(obj => obj.Operador.Codigo == filtrosPesquisa.OperadorLogistica.Usuario.Codigo);
                    result = result.Where(predicateOr);
                }
                else
                    result = result.Where(predicateAnd);

                if (filtrosPesquisa.CodigoCanalEntrega > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.CanalEntrega.Codigo == filtrosPesquisa.CodigoCanalEntrega));

                if (filtrosPesquisa.CodigoCanalVenda > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.CanalVenda.Codigo == filtrosPesquisa.CodigoCanalVenda));

                if (filtrosPesquisa.TipoCobrancaMultimodal?.Count > 0)
                    result = result.Where(o => o.Pedidos.Any(ped => filtrosPesquisa.TipoCobrancaMultimodal.Contains(ped.TipoCobrancaMultimodal)));

                if (filtrosPesquisa.CodigoFuncionarioVendedor > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.FuncionarioVendedor.Codigo == filtrosPesquisa.CodigoFuncionarioVendedor));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroEXP))
                    result = result.Where(o => o.Pedidos.Any(p => p.Pedido.NumeroEXP.Contains(filtrosPesquisa.NumeroEXP)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.ObservacaoCTe))
                    result = result.Where(o => o.Pedidos.Any(p => p.Pedido.ObservacaoCTe.Contains(filtrosPesquisa.ObservacaoCTe)));

                if (!string.IsNullOrWhiteSpace(filtrosPesquisa.RotaEmbarcador))
                    result = result.Where(o => o.Pedidos.Any(p => p.Pedido.RotaEmbarcador.Contains(filtrosPesquisa.RotaEmbarcador)));

                if (filtrosPesquisa.CpfCnpjTransportadorTerceiro > 0)
                    result = result.Where(obj => obj.Terceiro.CPF_CNPJ == filtrosPesquisa.CpfCnpjTransportadorTerceiro);

                if (!string.IsNullOrEmpty(filtrosPesquisa.NumeroOe))
                {
                    var consultaOrdemEmbarque = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.OrdemEmbarque.OrdemEmbarque>();
                    consultaOrdemEmbarque = consultaOrdemEmbarque.Where(o => o.Numero == filtrosPesquisa.NumeroOe);
                    result = result.Where(o => consultaOrdemEmbarque.Select(x => x.Carga.Codigo).Any(x => x == o.Codigo));
                }

                if (filtrosPesquisa.Serie > 0)
                    result = result.Where(obj => obj.CargaCTes.Any(o => o.CTe.Serie.Numero == filtrosPesquisa.Serie));

                if (filtrosPesquisa.CargasAguardandoImportacaoCTe != Dominio.Enumeradores.OpcaoSimNao.Todos)
                {
                    if (filtrosPesquisa.CargasAguardandoImportacaoCTe == Dominio.Enumeradores.OpcaoSimNao.Sim)
                        result = result.Where(obj => obj.LiberadaSemTodosPreCTes == true || obj.AgImportacaoCTe == true);
                    else if (filtrosPesquisa.PermitirFiltrarCargasNaEmissaoManualCteSemTerCtesImportados)
                        result = result.Where(obj => obj.AgImportacaoCTe == false);
                    else
                        result = result.Where(obj => obj.LiberadaSemTodosPreCTes == false && obj.AgImportacaoCTe == false);
                }

                if (filtrosPesquisa.CodigoOperadorInsercao > 0)
                {
                    if (filtrosPesquisa.OperadorLogistica != null && filtrosPesquisa.OperadorLogistica.SupervisorLogistica)
                        result = result.Where(obj => obj.OperadorInsercao.Codigo == filtrosPesquisa.CodigoOperadorInsercao);
                    else
                        result = result.Where(obj => obj.OperadorInsercao.Codigo == filtrosPesquisa.CodigoOperadorInsercao || obj.OperadorInsercao == null);
                }

                if (filtrosPesquisa.SomenteCargasComValePedagio)
                    result = result.Where(obj => obj.DadosSumarizados.PossuiIntegracaoValePedagio);

                if (filtrosPesquisa.SomenteCargasCriticas)
                    result = result.Where(obj => obj.Monitoramento.Any(monitoramento => monitoramento.Critico));

                if (filtrosPesquisa.SomenteCargasComFaturaFake)
                    result = result.Where(obj => obj.PossuiFacturaFake);

                if (filtrosPesquisa.SomenteCargasComDocumentoOriginarioVinculado)
                {
                    IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe> queryDocumentoAnterior = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedidoDocumentoCTe>();
                    IQueryable<Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao> queryPedidoCTeSubcontratacao = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoCTeParaSubContratacao>();

                    result = result.Where(obj => obj.Pedidos.Any(ped => queryDocumentoAnterior.Any(d => d.CargaPedido == ped)) || obj.Pedidos.Any(o => queryPedidoCTeSubcontratacao.Any(p => p.CargaPedido == o)));
                }

                if (filtrosPesquisa.CodigoCIOT > 0)
                    result = result.Where(obj => obj.CargaCIOTs.Any(ciot => ciot.CIOT.Codigo == filtrosPesquisa.CodigoCIOT));

                if (filtrosPesquisa.CodigosEmpresas != null && filtrosPesquisa.CodigosEmpresas.Count > 0)
                    result = result.Where(obj => filtrosPesquisa.CodigosEmpresas.Contains(obj.Empresa.Codigo));

                if (filtrosPesquisa.CodigoZonaTransporte > 0)
                {
                    var consultaZonaTransporte = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaZonaTransporte>();
                    consultaZonaTransporte = consultaZonaTransporte.Where(o => o.ZonaTransporte.Codigo == filtrosPesquisa.CodigoZonaTransporte);
                    result = result.Where(o => consultaZonaTransporte.Select(x => x.Carga.Codigo).Any(x => x == o.Codigo));
                }

                if (filtrosPesquisa.CodigosEmpresa != null && filtrosPesquisa.CodigosEmpresa.Count > 0)
                {
                    if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiCTe)
                    {
                        Repositorio.Empresa repEmpresa = new Repositorio.Empresa(this.UnitOfWork);
                        List<Dominio.Entidades.Empresa> empresasCTe = repEmpresa.BuscarPorCodigos(filtrosPesquisa.CodigosEmpresa);
                        List<Dominio.Entidades.Empresa> filiais = empresasCTe.SelectMany(empresa => empresa.Filiais).ToList();

                        if (!filtrosPesquisa.SomentePermiteMDFeManual)
                            result = result.Where(obj => filtrosPesquisa.CodigosEmpresa.Contains(obj.Empresa.Codigo) || filiais.Contains(obj.Empresa));
                        else
                            result = result.Where(obj => filtrosPesquisa.CodigosEmpresa.Contains(obj.Empresa.Codigo) || filiais.Contains(obj.Empresa) || empresasCTe.Any(o => obj.Empresa.CNPJ.Contains(o.RaizCnpj)));
                    }
                    else
                    {
                        if (!filtrosPesquisa.SomentePermiteMDFeManual)
                            result = result.Where(obj => filtrosPesquisa.CodigosEmpresa.Contains(obj.Empresa.Codigo));
                        else
                        {
                            result = result.Where(obj => filtrosPesquisa.CodigosEmpresa.Contains(obj.Empresa.Codigo)); /*|| empresasCTe.Any(o => obj.Empresa.CNPJ.Contains(o.RaizCnpj))) Causando exeção System.NotSupportedException*/
                        }

                    }
                }
                if (filtrosPesquisa.ApenasMDFeEncerrados)
                    result = result.Where(obj => obj.CargaMDFes.Any(o => o.MDFe.Status == Dominio.Enumeradores.StatusMDFe.Encerrado));

                if (filtrosPesquisa.CargaTrechoSumarizada != null)
                    result = result.Where(obj => obj.DadosSumarizados.CargaTrecho == filtrosPesquisa.CargaTrechoSumarizada || obj.DadosSumarizados.CargaTrecho == null);
            }

            if (filtrosPesquisa.CargasParaEncerramento)
                result = result.Where(obj => obj.SituacaoCarga != SituacaoCarga.Encerrada &&
                                            obj.SituacaoCarga != SituacaoCarga.Anulada &&
                                            obj.SituacaoCarga != SituacaoCarga.Cancelada);

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroOT))
                result = result.Where(o => o.NumeroOT == filtrosPesquisa.NumeroOT);

            if (filtrosPesquisa.FormaIntegracaoNotas != FormaIntegracao.Todos)
                result = result.Where(o => o.FormaIntegracao == filtrosPesquisa.FormaIntegracaoNotas);

            if (filtrosPesquisa.CategoriaOS != null && filtrosPesquisa.CategoriaOS.Count > 0)
                result = result.Where(o => filtrosPesquisa.CategoriaOS.Contains(o.CategoriaOS.Value));

            if (filtrosPesquisa.TipoOSConvertido != null && filtrosPesquisa.TipoOSConvertido.Count > 0)
                result = result.Where(o => filtrosPesquisa.TipoOSConvertido.Contains(o.TipoOSConvertido.Value));

            if (filtrosPesquisa.TipoOS != null && filtrosPesquisa.TipoOS.Count > 0)
                result = result.Where(o => filtrosPesquisa.TipoOS.Contains(o.TipoOS.Value));

            if (filtrosPesquisa.DirecionamentoCustoExtra != null && filtrosPesquisa.DirecionamentoCustoExtra.Count > 0)
                result = result.Where(o => filtrosPesquisa.DirecionamentoCustoExtra.Contains(o.TipoOperacao.ConfiguracaoCarga.DirecionamentoCustoExtra));

            if (filtrosPesquisa.StatusCustoExtra != null && filtrosPesquisa.StatusCustoExtra.Count > 0)
                result = result.Where(o => o.TipoOperacao.ConfiguracaoCarga.UtilizarDirecionamentoCustoExtra && filtrosPesquisa.StatusCustoExtra.Contains(o.StatusCustoExtra.Value));

            if (filtrosPesquisa.SomenteCargasNaoValidadasNaGR)
                result = result.Where(o => o.ProblemaIntegracaoGrMotoristaVeiculo);

            if (filtrosPesquisa.PossuiValePedagio != Dominio.Enumeradores.OpcaoSimNao.Todos)
            {
                if (filtrosPesquisa.PossuiValePedagio == Dominio.Enumeradores.OpcaoSimNao.Nao)
                    result = result.Where(obj => obj.NaoComprarValePedagio);
                else
                    result = result.Where(obj => !obj.NaoComprarValePedagio);
            }

            if (filtrosPesquisa.Regiao != null && filtrosPesquisa.Regiao.Count > 0 && filtrosPesquisa.Mesorregiao != null && filtrosPesquisa.Mesorregiao.Count > 0)
            {
                result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.Regiao.Contains(ped.Pedido.Remetente.Regiao.Codigo)
                    || filtrosPesquisa.Mesorregiao.Contains(ped.Pedido.Remetente.MesoRegiao.Codigo)));
            }
            else
            {
                if (filtrosPesquisa.Regiao != null && filtrosPesquisa.Regiao.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.Regiao.Contains(ped.Pedido.Remetente.Regiao.Codigo)));

                if (filtrosPesquisa.Mesorregiao != null && filtrosPesquisa.Mesorregiao.Count > 0)
                    result = result.Where(obj => obj.Pedidos.Any(ped => filtrosPesquisa.Mesorregiao.Contains(ped.Pedido.Remetente.MesoRegiao.Codigo)));
            }

            if (!string.IsNullOrEmpty(filtrosPesquisa.NumeroPreCarga))
                result = result.Where(o => o.PreCarga.NumeroPreCarga == filtrosPesquisa.NumeroPreCarga);

            return result;
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarOperacaoTrocaNota(string codigoCargaEmbarcador)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o => (o.CargaTrocaNota == null) || ((o.CargaTrocaNota.SituacaoCarga == SituacaoCarga.Anulada) || (o.CargaTrocaNota.SituacaoCarga == SituacaoCarga.Cancelada)));

            if (!string.IsNullOrWhiteSpace(codigoCargaEmbarcador))
                consultaCarga = consultaCarga.Where(o => o.CodigoCargaEmbarcador == codigoCargaEmbarcador);

            return consultaCarga;
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> MontarQueryConsulta(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaPesquisa filtroPesquisa)
        {
            string cnpjEmpresa = string.Format("{0:00000000000000}", filtroPesquisa.ProprietarioVeiculo);

            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            if (filtroPesquisa.CargasNaoAgrupadas)
            {
                if (!filtroPesquisa.CargasNaoFechadas)
                    query = query.Where(obj => (obj.CargaFechada == true && !obj.CargaAgrupada) || (obj.CargaFechada == false && obj.CargaAgrupamento != null));
                else
                    query = query.Where(obj => !obj.CargaAgrupada || (obj.CargaFechada == false && obj.CargaAgrupamento != null));
            }
            else
            {
                if (!filtroPesquisa.CargasNaoFechadas)
                    query = query.Where(obj => obj.CargaFechada == true);
                else
                    query = query.Where(obj => obj.CargaAgrupamento == null);
            }

            if (filtroPesquisa.DataInicialEmissao.HasValue)
                query = query.Where(obj => obj.DataInicioEmissaoDocumentos.Value.Date >= filtroPesquisa.DataInicialEmissao.Value);

            if (filtroPesquisa.DataFinalEmissao.HasValue)
                query = query.Where(obj => obj.DataInicioEmissaoDocumentos.Value.Date <= filtroPesquisa.DataFinalEmissao.Value);

            if (filtroPesquisa.DataInicialCarga.HasValue)
                query = query.Where(obj => obj.DataCriacaoCarga.Date >= filtroPesquisa.DataInicialCarga.Value);

            if (filtroPesquisa.DataFinalCarga.HasValue)
                query = query.Where(obj => obj.DataCriacaoCarga.Date <= filtroPesquisa.DataFinalCarga.Value);

            if (filtroPesquisa.Situacao?.Count() > 0)
                query = query.Where(obj => filtroPesquisa.Situacao.Contains(obj.SituacaoCarga));

            if (filtroPesquisa.TipoIntegracao != null && filtroPesquisa.TipoIntegracao.Count() > 0)
                query = query.Where(obj => obj.Integracoes.Where(o => filtroPesquisa.TipoIntegracao.Contains(o.TipoIntegracao.Tipo)).Any());

            if (!string.IsNullOrWhiteSpace(filtroPesquisa.CodigoCargaEmbarcador))
            {
                if (filtroPesquisa.FiltrarCargasPorParteDoNumero)
                    query = query.Where(obj => obj.CodigoCargaEmbarcador.Contains(filtroPesquisa.CodigoCargaEmbarcador.Trim()) || obj.CodigosAgrupados.Contains(filtroPesquisa.CodigoCargaEmbarcador));
                else
                    query = query.Where(obj => obj.CodigoCargaEmbarcador == filtroPesquisa.CodigoCargaEmbarcador.Trim() || obj.CodigosAgrupados.Contains(filtroPesquisa.CodigoCargaEmbarcador));
            }

            if (!string.IsNullOrWhiteSpace(filtroPesquisa.NumeroPedidoEmbarcador))
                query = query.Where(o => o.Pedidos.Any(p => p.Pedido.NumeroPedidoEmbarcador == filtroPesquisa.NumeroPedidoEmbarcador));

            if (filtroPesquisa.CodigosEmpresa?.Count > 0)
                query = query.Where(obj => filtroPesquisa.CodigosEmpresa.Contains(obj.Empresa.Codigo) || obj.Empresa.Filiais.Any(o => filtroPesquisa.CodigosEmpresa.Contains(o.Codigo))); // || obj.CargaCTes.Any(c => c.CTe.Empresa.Codigo == codigoEmpresa));

            if (filtroPesquisa.CodigosFilial.Any(o => o == -1))
            {
                query = query.Where(obj => filtroPesquisa.CodigosFilial.Contains(obj.Filial.Codigo) || obj.Pedidos.Any(p => filtroPesquisa.CodigosRecebedores.Contains(p.Pedido.Recebedor.CPF_CNPJ)));
            }
            else if (filtroPesquisa.CodigosFilial?.Count > 0)
            {
                query = query.Where(o => filtroPesquisa.CodigosFilial.Contains(o.Filial.Codigo) || o.CargaAgrupada && o.CargasAgrupamento.Any(carAgp => filtroPesquisa.CodigosFilial.Contains(carAgp.Filial.Codigo)));
            }

            if (filtroPesquisa.CodigosTipoCarga?.Count > 0)
                query = query.Where(o => filtroPesquisa.CodigosTipoCarga.Contains(o.TipoDeCarga.Codigo) || (filtroPesquisa.CodigosTipoCarga.Contains(-1) && o.TipoDeCarga == null));

            if (filtroPesquisa.CodigosTipoOperacao?.Count > 0)
                query = query.Where(o => filtroPesquisa.CodigosTipoOperacao.Contains(o.TipoOperacao.Codigo) || (filtroPesquisa.CodigosTipoOperacao.Contains(-1) && o.TipoOperacao == null) || (o.CargaAgrupada && o.CargasAgrupamento.Any(carAgp => filtroPesquisa.CodigosTipoOperacao.Contains(carAgp.TipoOperacao.Codigo))));

            if (filtroPesquisa.CodigoGrupoPessoas > 0)
                query = query.Where(o => o.GrupoPessoaPrincipal.Codigo == filtroPesquisa.CodigoGrupoPessoas);

            if (filtroPesquisa.CodigoVeiculo > 0)
                query = query.Where(o => o.Veiculo.Codigo == filtroPesquisa.CodigoVeiculo || o.VeiculosVinculados.Any(v => v.Codigo == filtroPesquisa.CodigoVeiculo));

            if (!string.IsNullOrWhiteSpace(filtroPesquisa.NumeroFrota))
                query = query.Where(o => o.Veiculo.NumeroFrota == filtroPesquisa.NumeroFrota);

            if (filtroPesquisa.CodigoMotorista > 0)
                query = query.Where(o => o.Motoristas.Any(m => m.Codigo == filtroPesquisa.CodigoMotorista));

            if (filtroPesquisa.CodigoTipoOcorrencia > 0)
                query = query.Where(o => o.TipoOperacao == null || !o.TipoOperacao.TiposOcorrencia.Any() || o.TipoOperacao.TiposOcorrencia.Any(to => to.Codigo == filtroPesquisa.CodigoTipoOcorrencia));

            if (filtroPesquisa.NumeroNF > 0)
                query = query.Where(o => o.Pedidos.Any(p => p.NotasFiscais.Any(n => n.XMLNotaFiscal.Numero == filtroPesquisa.NumeroNF)));

            if (filtroPesquisa.TiposPropostasMultimodal != null && filtroPesquisa.TiposPropostasMultimodal.Count > 0)
                query = query.Where(obj => obj.Pedidos.Any(ped => filtroPesquisa.TiposPropostasMultimodal.Contains(ped.TipoPropostaMultimodal)));

            if (filtroPesquisa.NumeroCTe > 0)
            {
                if (filtroPesquisa.ProprietarioVeiculo > 0D)
                    query = query.Where(o => o.CargaCTes.Any(c => c.CargaCTeComplementoInfo == null && c.CTe.Numero == filtroPesquisa.NumeroCTe && (c.CTe.Empresa.CNPJ == cnpjEmpresa || o.Veiculo.Proprietario.CPF_CNPJ == filtroPesquisa.ProprietarioVeiculo || o.Veiculo.Empresa.CNPJ == cnpjEmpresa))); //Adicionado para buscar o Proprietário também pela empresa do veículo - result = result.Where(o => o.CargaCTes.Any(c => c.CargaCTeComplementoInfo == null && c.CTe.Numero == numeroCTe && (c.CTe.Empresa.CNPJ == cnpjEmpresa || o.Veiculo.Proprietario.CPF_CNPJ == proprietarioVeiculo)));
                else
                    query = query.Where(o => o.CargaCTes.Any(c => c.CargaCTeComplementoInfo == null && c.CTe.Numero == filtroPesquisa.NumeroCTe));
            }
            else if (filtroPesquisa.ProprietarioVeiculo > 0D)
                query = query.Where(o => o.Veiculo.Proprietario.CPF_CNPJ == filtroPesquisa.ProprietarioVeiculo || o.Empresa.CNPJ == cnpjEmpresa || o.Veiculo.Empresa.CNPJ == cnpjEmpresa || o.CargaCTes.Any(c => c.CTe.Empresa.CNPJ == cnpjEmpresa || o.Veiculo.Empresa.CNPJ == cnpjEmpresa));

            if (filtroPesquisa.NumeroMDFe > 0)
                query = query.Where(o => o.CargaMDFes.Any(c => c.MDFe.Numero == filtroPesquisa.NumeroMDFe));

            if (filtroPesquisa.PossuiDTNatura.HasValue)
            {
                if (filtroPesquisa.PossuiDTNatura.Value)
                    query = query.Where(o => o.IntegracoesNatura.Any());
                else
                    query = query.Where(o => !o.IntegracoesNatura.Any());
            }

            if (filtroPesquisa.CpfCnpjRemetente > 0D)
                query = query.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Remetente.CPF_CNPJ == filtroPesquisa.CpfCnpjRemetente));

            if (filtroPesquisa.CpfCnpjDestinatario > 0D)
                query = query.Where(obj => obj.Pedidos.Any(ped => ((double?)ped.Recebedor.CPF_CNPJ ?? ped.Pedido.Destinatario.CPF_CNPJ) == filtroPesquisa.CpfCnpjDestinatario));

            if (filtroPesquisa.CpfCnpjExpedidor > 0D)
                query = query.Where(obj => obj.Pedidos.Any(ped => ped.Expedidor.CPF_CNPJ == filtroPesquisa.CpfCnpjExpedidor));

            if (filtroPesquisa.CpfCnpjRecebedor > 0D)
                query = query.Where(obj => obj.Pedidos.Any(ped => ped.Recebedor.CPF_CNPJ == filtroPesquisa.CpfCnpjRecebedor));

            if (filtroPesquisa.CodigoOrigem > 0)
                query = query.Where(obj => obj.Pedidos.Any(ped => ped.Origem.Codigo == filtroPesquisa.CodigoOrigem));

            if (filtroPesquisa.CodigoDestino > 0)
                query = query.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Destino.Codigo == filtroPesquisa.CodigoDestino));

            if (filtroPesquisa.NumeroCTeSubcontratacao > 0)
                query = query.Where(o => o.Pedidos.Any(cp => cp.PedidoCTesParaSubContratacao.Any(p => p.CTeTerceiro.Numero == filtroPesquisa.NumeroCTeSubcontratacao)));

            if (filtroPesquisa.CargaTransbordo.HasValue)
            {
                if (filtroPesquisa.CargaTransbordo.Value)
                    query = query.Where(o => o.CargaTransbordo);
                else
                    query = query.Where(o => !o.CargaTransbordo);
            }

            if (filtroPesquisa.CargasDisponiveisParaJanela)
            {
                var consultaCargaJanelaDescarregamento1 = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaJanelaDescarregamento>().ToList();
                IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaJanelaDescarregamento> consultaCargaJanelaDescarregamento = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaJanelaDescarregamento>();

                consultaCargaJanelaDescarregamento = consultaCargaJanelaDescarregamento.Where(obj =>
                        ((bool?)obj.Cancelada ?? false) == false &&
                        obj.Carga.Pedidos.Any(ped => ped.Pedido.Destinatario.CPF_CNPJ == filtroPesquisa.CpfCnpjDestinatario) &&
                        obj.Carga.SituacaoCarga != SituacaoCarga.Cancelada &&
                        obj.Carga.SituacaoCarga != SituacaoCarga.Anulada
                    );

                query = query.Where(carga =>
                    carga.SituacaoCarga != SituacaoCarga.Cancelada &&
                    carga.SituacaoCarga != SituacaoCarga.Anulada &&
                    !consultaCargaJanelaDescarregamento.Any(janelaDescarregamento => janelaDescarregamento.Carga.Codigo == carga.Codigo)
                );

            }

            if (filtroPesquisa.CodigosEmpresas != null && filtroPesquisa.CodigosEmpresas.Count > 0)
                query = query.Where(obj => filtroPesquisa.CodigosEmpresas.Contains(obj.Empresa.Codigo));

            if (filtroPesquisa.SomenteCargasDeRedespacho.HasValue)
                query = query.Where(obj => obj.TipoOperacao.OperacaoDeRedespacho == filtroPesquisa.SomenteCargasDeRedespacho.Value);

            if (filtroPesquisa.NaoRetornarSubCarga)
                query = query.Where(obj => (obj.DadosSumarizados.CargaTrecho == null || obj.DadosSumarizados.CargaTrecho == CargaTrechoSumarizada.Agrupadora));

            if (!string.IsNullOrWhiteSpace(filtroPesquisa.NumeroContainer))
            {
                var consultaColetaContainer = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.ColetaContainer>();

                query = query.Where(c => consultaColetaContainer.Any(cc => cc.CargaAtual.Codigo == c.Codigo && cc.Container.Numero == filtroPesquisa.NumeroContainer));
            }

            if (filtroPesquisa.CodigoClienteTerceiro > 0)
                query = query.Where(obj => obj.Terceiro.Codigo == filtroPesquisa.CodigoClienteTerceiro);

            if (filtroPesquisa.NaoExibirCargasCanceladas)
                query = query.Where(obj => obj.SituacaoCarga != SituacaoCarga.Cancelada);

            if (filtroPesquisa.SituacaoDiferente?.Count() > 0)
                query = query.Where(obj => !filtroPesquisa.SituacaoDiferente.Contains(obj.SituacaoCarga));

            return query;
        }

        public int ContarConsultarCargaSQL(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaPesquisa filtrosPesquisa)
        {
            var consulta = this.SessionNHiBernate.CreateSQLQuery(QueryConsultaCarga(filtrosPesquisa, true));

            return consulta.SetTimeout(600).UniqueResult<int>();
        }
        public async Task<int> ContarConsultarCargaSQLAsync(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaPesquisa filtrosPesquisa)
        {
            var consulta = this.SessionNHiBernate.CreateSQLQuery(QueryConsultaCarga(filtrosPesquisa, true));

            return await consulta.SetTimeout(600).UniqueResultAsync<int>();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Carga.ConsultaCarga> ConsultarCargaSQL(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaPesquisa filtrosPesquisa, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            var consulta = this.SessionNHiBernate.CreateSQLQuery(QueryConsultaCarga(filtrosPesquisa, false, propOrdenacao, dirOrdenacao, inicioRegistros, maximoRegistros));

            consulta.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.ConsultaCarga)));

            return consulta.SetTimeout(600).List<Dominio.ObjetosDeValor.Embarcador.Carga.ConsultaCarga>();
        }
        public async Task<List<Dominio.ObjetosDeValor.Embarcador.Carga.ConsultaCarga>> ConsultarCargaSQLAsync(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaPesquisa filtrosPesquisa, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            var consulta = this.SessionNHiBernate.CreateSQLQuery(QueryConsultaCarga(filtrosPesquisa, false, propOrdenacao, dirOrdenacao, inicioRegistros, maximoRegistros));

            consulta.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Carga.ConsultaCarga)));

            return (List<Dominio.ObjetosDeValor.Embarcador.Carga.ConsultaCarga>)
                await consulta.SetTimeout(600).ListAsync<Dominio.ObjetosDeValor.Embarcador.Carga.ConsultaCarga>();
        }


        private string QueryConsultaCarga(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaPesquisa filtroPesquisa, bool somenteContarNumeroRegistros, string propOrdenacao = null, string dirOrdenacao = null, int? inicioRegistros = null, int? maximoRegistros = null)
        {
            string cnpjEmpresa = string.Format("{0:00000000000000}", filtroPesquisa.ProprietarioVeiculo);
            System.Globalization.CultureInfo cultura = new System.Globalization.CultureInfo("en-US");
            string pattern = "yyyy-MM-dd";

            StringBuilder select = new StringBuilder();
            StringBuilder joins = new StringBuilder();
            StringBuilder where = new StringBuilder();

            where.Append(" where 1=1 ");

            if (somenteContarNumeroRegistros)
                select.Append("select distinct(count(0) over ()) ");
            else
                select.Append($@"select
                             carga.CAR_CODIGO Codigo,
                             carga.CAR_CODIGO_CARGA_EMBARCADOR Descricao,
                             carga.CAR_VEICULO CodigoVeiculo,
                             (ISNULL((SELECT TOP 1 motorista1.FUN_CODIGO FROM T_CARGA_MOTORISTA motoristaCarga1 INNER JOIN T_FUNCIONARIO motorista1 ON motoristaCarga1.CAR_MOTORISTA = motorista1.FUN_CODIGO WHERE motoristaCarga1.CAR_CODIGO = carga.CAR_CODIGO), 0)) CodigoMotorista,
                             carga.CAR_CODIGO_CARGA_EMBARCADOR CodigoCargaEmbarcador,
                             tipoCarga.TCG_DESCRICAO TipoCarga,
                             modeloVeicularCarga.MVC_DESCRICAO ModeloVeicular,
                             modeloVeicularCarga.MVC_NUMERO_REBOQUES NumeroReboques,
                             empresa.EMP_RAZAO Transportador,
                             cargaDadosSumarizados.CDS_FILIAIS Filial,
                             cargaDadosSumarizados.CDA_TIPOS_DE_OPERACAO TipoOperacao,
                             ((select vei.VEI_PLACA from T_VEICULO vei where vei.VEI_CODIGO = carga.CAR_VEICULO) + ISNULL((SELECT ', ' + veiculo1.VEI_PLACA FROM T_CARGA_VEICULOS_VINCULADOS veiculoVinculadoCarga1 INNER JOIN T_VEICULO veiculo1 ON veiculoVinculadoCarga1.VEI_CODIGO = veiculo1.VEI_CODIGO WHERE veiculoVinculadoCarga1.CAR_CODIGO = carga.CAR_CODIGO FOR XML PATH('')), '')) Veiculo,
                             SUBSTRING((SELECT ', ' + motorista1.FUN_NOME + (CASE WHEN motorista1.FUN_FONE is null or motorista1.FUN_FONE = '' THEN '' ELSE ' (' + motorista1.FUN_FONE  + ')' END) FROM T_CARGA_MOTORISTA motoristaCarga1 INNER JOIN T_FUNCIONARIO motorista1 ON motoristaCarga1.CAR_MOTORISTA = motorista1.FUN_CODIGO WHERE motoristaCarga1.CAR_CODIGO = carga.CAR_CODIGO FOR XML PATH('')), 3, 1000) Motorista,
                             carga.CAR_SITUACAO Situacao,
                             carga.CAR_DATA_CRIACAO DataCriacaoCarga,
                             carga.CAR_DATA_CARREGAMENTO DataCarregamento,
                             SUBSTRING((SELECT DISTINCT ', ' + CAST(cte.CON_NUM AS NVARCHAR(20)) FROM T_CARGA_CTE cargaCTe inner join T_CTE cte ON cte.CON_CODIGO = cargaCTe.CON_CODIGO WHERE cargaCTe.CAR_CODIGO = carga.CAR_CODIGO and cargaCTe.CON_CODIGO IS NOT NULL FOR XML PATH('')), 3, 1000) NumeroCTes,
                             cargaDadosSumarizados.CDS_REMETENTES Remetentes,
                             cargaDadosSumarizados.CDS_ORIGENS Origem,
                             cargaDadosSumarizados.CDS_DESTINATARIOS Destinatarios,
                             cargaDadosSumarizados.CDS_DESTINOS Destino,
                             carga.CAR_CARGA_FECHADA CargaFechada,
                             carga.CAR_DATA_INICIO_EMISSAO_DOCUMENTOS DataEmissaoDocumentos,
                             carga.CAR_VALOR_FRETE ValorFrete,
                             (select count(1) from T_CARGA_CTE cargaCte where cargaCte.CAR_CODIGO = carga.CAR_CODIGO) QuantidadeDocumentosFrete,
                             configuracaoTipoOperacaoChamado.CCH_NAO_PERMITIR_GERAR_ATENDIMENTO NaoPermitirGerarAtendimento,
                             cargaDadosSumarizados.CDS_OBSERVACAO_RELATORIO_DE_EMBARQUE ObservacaoRelatorioDeEmbarque,
                             cargaDadosSumarizados.CDS_FILIAIS_VENDA FilialVenda");

            joins.Append($@"  from T_CARGA carga
                         left join T_VEICULO veiculo on veiculo.VEI_CODIGO = carga.CAR_VEICULO 
                         left join T_CLIENTE clienteVeiculo on clienteVeiculo.CLI_CGCCPF = veiculo.VEI_PROPRIETARIO 
                         left join T_EMPRESA empresaVeiculo on empresaVeiculo.EMP_CODIGO = veiculo.EMP_CODIGO 
                         left join T_EMPRESA empresa on empresa.EMP_CODIGO = carga.EMP_CODIGO 
                         left join T_TIPO_OPERACAO tipoOperacao on tipoOperacao.TOP_CODIGO = carga.TOP_CODIGO 
                         left join T_CARGA_DADOS_SUMARIZADOS cargaDadosSumarizados on cargaDadosSumarizados.CDS_CODIGO = carga.CDS_CODIGO
                         left join T_TIPO_DE_CARGA tipoCarga on carga.TCG_CODIGO = tipoCarga.TCG_CODIGO
                         left join T_MODELO_VEICULAR_CARGA modeloVeicularCarga on carga.MVC_CODIGO = modeloVeicularCarga.MVC_CODIGO
                         left join T_CONFIGURACAO_TIPO_OPERACAO_CHAMADO configuracaoTipoOperacaoChamado on tipoOperacao.CCH_CODIGO = configuracaoTipoOperacaoChamado.CCH_CODIGO");

            if (filtroPesquisa.CargasNaoAgrupadas)
            {
                if (!filtroPesquisa.CargasNaoFechadas)
                    where.Append(" and ((carga.CAR_CARGA_FECHADA = 1 and carga.CAR_CARGA_AGRUPADA = 0) or (carga.CAR_CARGA_FECHADA = 0 and carga.CAR_CODIGO_AGRUPAMENTO is not null))");
                else
                    where.Append(" and (carga.CAR_CODIGO_AGRUPAMENTO = 0 or (carga.CAR_CODIGO_AGRUPAMENTO = 1 and carga.CAR_CODIGO_AGRUPAMENTO is not null))");
            }
            else
            {
                if (filtroPesquisa.SomenteNaoFechadas)
                    where.Append(" and carga.CAR_CARGA_FECHADA = 0");
                else if (!filtroPesquisa.CargasNaoFechadas)
                    where.Append(" and carga.CAR_CARGA_FECHADA = 1");
                else
                    where.Append(" and carga.CAR_CODIGO_AGRUPAMENTO is null");
            }

            if (filtroPesquisa.DataInicialEmissao.HasValue)
            {
                where.Append($" and carga.CAR_DATA_INICIO_EMISSAO_DOCUMENTOS >= '{filtroPesquisa.DataInicialEmissao.Value.ToString(pattern)}'");
                if (filtroPesquisa.DataFinalEmissao.HasValue)
                {
                    DateTime dataFinalInclusiva = filtroPesquisa.DataFinalEmissao.Value.AddDays(1);
                    where.Append($" and carga.CAR_DATA_INICIO_EMISSAO_DOCUMENTOS < '{dataFinalInclusiva.ToString(pattern)}'");
                }
            }

            if (filtroPesquisa.DataFinalEmissao.HasValue && !filtroPesquisa.DataInicialEmissao.HasValue)
            {
                DateTime dataFinalInclusiva = filtroPesquisa.DataFinalEmissao.Value.AddDays(1);
                where.Append($" and carga.CAR_DATA_INICIO_EMISSAO_DOCUMENTOS < '{dataFinalInclusiva.ToString(pattern)}'");
            }

            if (filtroPesquisa.DataInicialCarga.HasValue)
                where.Append($" and carga.CAR_DATA_CRIACAO >= '{filtroPesquisa.DataInicialCarga.Value.ToString(pattern)}'");

            if (filtroPesquisa.DataFinalCarga.HasValue)
                where.Append($" and carga.CAR_DATA_CRIACAO <= '{filtroPesquisa.DataFinalCarga.Value.ToString(pattern)}'");

            if (filtroPesquisa.Situacao?.Count() > 0)
            {
                string situacoes = string.Join(", ", from situacao in filtroPesquisa.Situacao select situacao.ToString("d"));

                where.Append($" and carga.CAR_SITUACAO IN ({situacoes})");
            }

            if (filtroPesquisa.TipoIntegracao != null && filtroPesquisa.TipoIntegracao.Count() > 0)
            {
                where.Append($@" AND EXISTS (SELECT 1 FROM T_CARGA_INTEGRACAO cargaIntegracao
	                                         JOIN T_TIPO_INTEGRACAO tipoIntegraca ON cargaIntegracao.TPI_CODIGO = tipoIntegraca.TPI_CODIGO
	                                         WHERE carga.CAR_CODIGO = cargaIntegracao.CAR_CODIGO
	                                         AND tipoIntegraca.TPI_TIPO IN ({string.Join(", ", filtroPesquisa.TipoIntegracao.Cast<int>().ToList())})
                                            )");
            }

            if (!string.IsNullOrWhiteSpace(filtroPesquisa.CodigoCargaEmbarcador))
            {
                if (filtroPesquisa.FiltrarCargasPorParteDoNumero)
                    where.Append($" and (carga.CAR_CODIGO in (" +
                        $"              select cca.CAR_CODIGO from T_CARGA_CODIGOS_AGRUPADOS cca " +
                        $"              where cca.CAR_CODIGO_CARGA_AGRUPADO like '%{filtroPesquisa.CodigoCargaEmbarcador}%' " +
                        $"              union " +
                        $"              select car.CAR_CODIGO from T_CARGA car " +
                        $"              where car.CAR_CODIGO_CARGA_EMBARCADOR like '%{filtroPesquisa.CodigoCargaEmbarcador}%' ))");

                else
                    where.Append($" and (carga.CAR_CODIGO in (" +
                        $"              select cca.CAR_CODIGO from T_CARGA_CODIGOS_AGRUPADOS cca " +
                        $"              where cca.CAR_CODIGO_CARGA_AGRUPADO = '{filtroPesquisa.CodigoCargaEmbarcador}' " +
                        $"              union " +
                        $"              select car.CAR_CODIGO from T_CARGA car " +
                        $"              where car.CAR_CODIGO_CARGA_EMBARCADOR = '{filtroPesquisa.CodigoCargaEmbarcador}' ))");
            }

            if (!string.IsNullOrWhiteSpace(filtroPesquisa.NumeroPedidoEmbarcador))
            {
                where.Append($@" and exists(
                                   select pedido.PED_CODIGO
                                   from T_CARGA_PEDIDO cargaPedido
                                   join T_PEDIDO pedido on pedido.PED_CODIGO = cargaPedido.PED_CODIGO
                                   where carga.CAR_CODIGO = cargaPedido.CAR_CODIGO
                                   and pedido.PED_NUMERO_PEDIDO_EMBARCADOR = '{filtroPesquisa.NumeroPedidoEmbarcador}'
                             )");
            }

            if (!string.IsNullOrWhiteSpace(filtroPesquisa.NumeroPedidoCliente))
            {
                where.Append($@" and exists(
                                   select pedido.PED_CODIGO
                                   from T_CARGA_PEDIDO cargaPedido
                                   join T_PEDIDO pedido on pedido.PED_CODIGO = cargaPedido.PED_CODIGO
                                   where carga.CAR_CODIGO = cargaPedido.CAR_CODIGO
                                   and pedido.PED_CODIGO_PEDIDO_CLIENTE = '{filtroPesquisa.NumeroPedidoCliente}'
                             )");
            }

            if (filtroPesquisa.TelaRedespacho && filtroPesquisa.CodigosEmpresa?.Count > 0 && filtroPesquisa.CpfCnpjRecebedor > 0)
            {
                where.Append($@" and (
                       empresa.EMP_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosEmpresa)})
                       or exists (
                           select empresaFilial.EMP_CODIGO
                           from T_EMPRESA_FILIAL empresaFilial
                           where empresa.EMP_CODIGO = empresaFilial.EMP_CODIGO
                             and empresaFilial.EMP_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosEmpresa)})
                       )
                       or exists(
                           select cargaPedido.CPE_CODIGO
                           from T_CARGA_PEDIDO cargaPedido
                           where cargaPedido.CAR_CODIGO = carga.CAR_CODIGO
                             and cargaPedido.CLI_CODIGO_RECEBEDOR = {filtroPesquisa.CpfCnpjRecebedor}
                       )
                   )");
            }
            else
            {
                if (filtroPesquisa.CodigosEmpresa?.Count > 0)
                {
                    where.Append($@" and (
                           empresa.EMP_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosEmpresa)})
                           or exists (
                               select empresaFilial.EMP_CODIGO
                               from T_EMPRESA_FILIAL empresaFilial
                               where empresa.EMP_CODIGO = empresaFilial.EMP_CODIGO
                                 and empresaFilial.EMP_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosEmpresa)})
                           )
                        )");
                }

                if (filtroPesquisa.CpfCnpjRecebedor > 0)
                {
                    where.Append($@" and exists(
                           select cargaPedido.CPE_CODIGO
                           from T_CARGA_PEDIDO cargaPedido
                           join T_PEDIDO pedido on cargaPedido.PED_CODIGO = pedido.PED_CODIGO
                           where cargaPedido.CAR_CODIGO = carga.CAR_CODIGO
                             and pedido.CLI_CODIGO_RECEBEDOR = {filtroPesquisa.CpfCnpjRecebedor}
                        )");
                }
            }


            if (filtroPesquisa.CodigosFilial.Exists(o => o == -1))
            {
                where.Append($@" and (carga.FIL_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosFilial)}) OR EXISTS (   SELECT _cargaPedidoRecebedor.CAR_CODIGO 
                                                                                                                  FROM T_CARGA_PEDIDO _cargaPedidoRecebedor 
                                                                                                                  WHERE Carga.CAR_CODIGO = _cargaPedidoRecebedor.CAR_CODIGO
                                                                                                                  AND _cargaPedidoRecebedor.CLI_CODIGO_RECEBEDOR IN ({string.Join(",", filtroPesquisa.CodigosRecebedores)})))");
            }
            else if (filtroPesquisa.CodigosFilial?.Count > 0)
            {
                where.Append($" and carga.FIL_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosFilial)})");
            }

            if (filtroPesquisa.CodigosTipoCarga?.Count > 0)
                where.Append($" and (carga.TCG_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosTipoCarga)}){(filtroPesquisa.CodigosTipoCarga.Contains(-1) ? " or carga.TCG_CODIGO is null" : "")})");

            if (filtroPesquisa.CodigosTipoOperacao?.Count > 0)
                where.Append($@" and (
                               carga.TOP_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosTipoOperacao)}) 
                               {(filtroPesquisa.CodigosTipoOperacao.Contains(-1) ? " or carga.TOP_CODIGO is null" : "")} 
                            or (
                               carga.CAR_CARGA_AGRUPADA = 1 
                            and 
                               exists(
                                   select cargaAgrupada.CAR_CODIGO
                                   from T_CARGA cargaAgrupada
                                   where carga.CAR_CODIGO = cargaAgrupada.CAR_CODIGO_AGRUPAMENTO and cargaAgrupada.TOP_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosTipoOperacao)})
                                   )
                                )
                           )");

            if (filtroPesquisa.CodigoGrupoPessoas > 0)
                where.Append($" and carga.GRP_CODIGO = {filtroPesquisa.CodigoGrupoPessoas}");

            if (filtroPesquisa.CodigoVeiculo > 0)
                where.Append($@" and (carga.CAR_VEICULO = {filtroPesquisa.CodigoVeiculo} or 
                                carga.CAR_CODIGO in (
                                   select cargaVeiculos.CAR_CODIGO
                                   from T_CARGA_VEICULOS_VINCULADOS cargaVeiculos
                                   where cargaVeiculos.VEI_CODIGO = {filtroPesquisa.CodigoVeiculo}
                                ))");

            if (!string.IsNullOrWhiteSpace(filtroPesquisa.NumeroFrota))
            {
                where.Append($" and veiculo.VEI_NUMERO_FROTA = {filtroPesquisa.NumeroFrota}");
            }

            if (filtroPesquisa.CodigoMotorista > 0)
                where.Append($@" and Carga.CAR_CODIGO in (
                               select cargaMotorista.CAR_CODIGO
                               from T_CARGA_MOTORISTA cargaMotorista
                               where cargaMotorista.CAR_MOTORISTA = {filtroPesquisa.CodigoMotorista}
                           )");

            if (filtroPesquisa.CodigoTipoOcorrencia > 0)
                where.Append($@" and (carga.TOP_CODIGO is null 
                           or not (exists(
                               select tipoOperacao.OCO_CODIGO
                               from T_TIPO_OPERACAO tipoOperacao
							inner join T_TIPO_OPERACAO_TIPO_OCORRENCIA tipoOperacaoTipoOcorrencia ON tipoOperacaoTipoOcorrencia.TOP_CODIGO = tipoOperacao.OCO_CODIGO
                               where tipoOperacao.TOP_CODIGO = carga.TOP_CODIGO)
                           or exists(
                               select tipoOperacao.OCO_CODIGO
                               from T_TIPO_OPERACAO tipoOperacao
							inner join T_TIPO_OPERACAO_TIPO_OCORRENCIA tipoOperacaoTipoOcorrencia ON tipoOperacaoTipoOcorrencia.TOP_CODIGO = tipoOperacao.OCO_CODIGO
                               where tipoOperacao.TOP_CODIGO = carga.TOP_CODIGO and tipoOperacaoTipoOcorrencia.OCO_CODIGO = {filtroPesquisa.CodigoTipoOcorrencia})
                           ))");

            if (filtroPesquisa.NumeroNF > 0)
            {
                joins.Append(" INNER JOIN (  ");
                joins.Append("         select _cargapedido.CAR_CODIGO CAR_CODIGO ");
                joins.Append("           from T_CARGA_PEDIDO _cargapedido");
                joins.Append("           inner join T_PEDIDO_XML_NOTA_FISCAL _pex on _pex.CPE_CODIGO = _cargapedido.CPE_CODIGO ");
                joins.Append("           inner join T_XML_NOTA_FISCAL _nfx on _nfx.NFX_CODIGO = _pex.NFX_CODIGO ");
                joins.Append($"         where _nfx.NF_NUMERO = {filtroPesquisa.NumeroNF} ");
                joins.Append("     ) TESTE ON TESTE.CAR_CODIGO = Carga.CAR_CODIGO  ");
            }

            if (filtroPesquisa.TiposPropostasMultimodal != null && filtroPesquisa.TiposPropostasMultimodal.Count > 0)
            {
                where.Append(" and Carga.CAR_CODIGO in (");
                where.Append("         select DISTINCT _cargaPedido.CAR_CODIGO ");
                where.Append("           from T_CARGA_PEDIDO _cargaPedido");
                where.Append("           inner join T_CARGA_CTE _cargaCte on _cargaCte.CAR_CODIGO = _cargaPedido.CAR_CODIGO ");
                where.Append($"         where _cargaPedido.TBF_TIPO_PROPOSTA_MULTIMODAL in ({string.Join(", ", filtroPesquisa.TiposPropostasMultimodal.Select(o => o.ToString("D")))}) ");
                where.Append("     ) ");
            }

            if (filtroPesquisa.NumeroMDFe > 0)
            {
                where.Append(" AND EXISTS ( ");
                where.Append("         SELECT 1 ");
                where.Append("           FROM T_CARGA_MDFE CargaMdfe ");
                where.Append("           JOIN T_MDFE Mdfe ");
                where.Append("             ON CargaMdfe.MDF_CODIGO = Mdfe.MDF_CODIGO ");
                where.Append("          WHERE CargaMdfe.CAR_CODIGO = Carga.CAR_CODIGO ");
                where.Append($"           AND Mdfe.MDF_NUMERO = {filtroPesquisa.NumeroMDFe} ");
                where.Append("     ) ");
            }

            if (filtroPesquisa.NumeroCTe > 0)
            {
                if (filtroPesquisa.ProprietarioVeiculo > 0D)
                {
                    where.Append($@" and exists(
                                   select cargaCte.CCT_CODIGO
                                   from T_CARGA_CTE cargaCte
                                   join T_CTE cte on cargaCte.CON_CODIGO = cte.CON_CODIGO
                                   left join T_EMPRESA empresaCte on cte.EMP_CODIGO = empresaVeiculo.EMP_CODIGO
                                   where carga.CAR_CODIGO = cargaCte.CAR_CODIGO
                                         and cargaCte.CCC_CODIGO is null
                                         and cte.CON_NUM = {filtroPesquisa.NumeroCTe}
                                         and (
                                               empresaCte.EMP_CODIGO = {cnpjEmpresa}
                                               or cliente.CLI_CGCCPF = {filtroPesquisa.ProprietarioVeiculo}
                                               or empresaVeiculo.EMP_CODIGO = {cnpjEmpresa}
                                         ))");
                }
                else
                {
                    where.Append($@" and exists(
                                       select cargaCte.CCT_CODIGO
                                       from T_CARGA_CTE cargaCte
                                       join T_CTE cte on cargaCte.CON_CODIGO = cte.CON_CODIGO
                                       where carga.CAR_CODIGO = cargaCte.CAR_CODIGO
                                             and cargaCte.CCC_CODIGO is null
                                             and cte.CON_NUM = {filtroPesquisa.NumeroCTe}
                                   )");
                }
            }
            else if (filtroPesquisa.ProprietarioVeiculo > 0D)
            {
                where.Append($@" and (clienteVeiculo.CLI_CGCCPF = {filtroPesquisa.ProprietarioVeiculo}
                            or empresa.EMP_CNPJ = '{cnpjEmpresa}'
                            or empresaVeiculo.EMP_CNPJ = '{cnpjEmpresa}'
                            or exists (
                               select cargaCte.CCT_CODIGO
                               from T_CARGA_CTE cargaCte
                               left join T_CTE cte on cargaCte.CON_CODIGO = cte.CON_CODIGO 
                               left join T_EMPRESA empresa on cte.EMP_CODIGO = empresa.EMP_CODIGO
                               where carga.CAR_CODIGO = cargaCte.CAR_CODIGO
                               and (empresa.EMP_CODIGO = {cnpjEmpresa} or empresaVeiculo.EMP_CNPJ = '{cnpjEmpresa}')))");
            }

            if (filtroPesquisa.PossuiDTNatura.HasValue)
            {
                if (filtroPesquisa.PossuiDTNatura.Value)
                    where.Append($@" and exists(
                                   select cargaIntegracaoNatura.CNA_CODIGO
                                   from T_CARGA_INTEGRACAO_NATURA cargaIntegracaoNatura
                                   where cargaIntegracaoNatura.CAR_CODIGO = carga.CAR_CODIGO)");
                else
                    where.Append($@" and not(exists(
                                   select cargaIntegracaoNatura.CNA_CODIGO
                                   from T_CARGA_INTEGRACAO_NATURA cargaIntegracaoNatura
                                   where cargaIntegracaoNatura.CAR_CODIGO = carga.CAR_CODIGO))");
            }

            if (filtroPesquisa.CpfCnpjRemetente > 0d)
            {
                where.Append($@" and exists(
                                   select cargaPedido.CPE_CODIGO
                                   from T_CARGA_PEDIDO cargaPedido
                                   join T_PEDIDO pedido on cargaPedido.PED_CODIGO = pedido.PED_CODIGO
                                   where cargaPedido.CAR_CODIGO = carga.CAR_CODIGO and pedido.CLI_CODIGO_REMETENTE = {filtroPesquisa.CpfCnpjRemetente})");
            }

            if (filtroPesquisa.CpfCnpjDestinatario > 0D)
            {
                where.Append($@" and exists(                                   
                                       select cargaPedido.CPE_CODIGO 
                                       from T_CARGA_PEDIDO cargaPedido
                                       left join T_CLIENTE cliente on cargaPedido.CLI_CODIGO_RECEBEDOR = cliente.CLI_CGCCPF 
                                       left join T_PEDIDO pedido on cargaPedido.PED_CODIGO = pedido.PED_CODIGO 
                                       left join T_CLIENTE clientePedido on pedido.CLI_CODIGO=clientePedido.CLI_CGCCPF 
                                       where
                                           carga.CAR_CODIGO=cargaPedido.CAR_CODIGO 
                                           and (
                                               case 
                                                   when cliente.CLI_CGCCPF is not null then cliente.CLI_CGCCPF 
                                                   else clientePedido.CLI_CGCCPF 
                                               end
                                           )='{filtroPesquisa.CpfCnpjDestinatario}'
                                   )");
            }

            if (filtroPesquisa.CpfCnpjExpedidor > 0D)
            {
                where.Append($@" and exists(
                                   select cargaPedido.CPE_CODIGO
                                   from T_CARGA_PEDIDO cargaPedido
                                   join T_PEDIDO pedido on cargaPedido.PED_CODIGO = pedido.PED_CODIGO
                                   where cargaPedido.CAR_CODIGO = carga.CAR_CODIGO and pedido.CLI_CODIGO_EXPEDIDOR = {filtroPesquisa.CpfCnpjExpedidor})");
            }

            if (filtroPesquisa.CodigoOrigem > 0)
            {
                where.Append($@" and exists(
                                   select cargaPedido.CPE_CODIGO
                                   from T_CARGA_PEDIDO cargaPedido
                                   where cargaPedido.CAR_CODIGO = carga.CAR_CODIGO and cargaPedido.LOC_CODIGO_ORIGEM = {filtroPesquisa.CodigoOrigem})");
            }

            if (filtroPesquisa.CodigoDestino > 0)
            {
                where.Append($@" and exists(
                                   select cargaPedido.CPE_CODIGO
                                   from T_CARGA_PEDIDO cargaPedido
                                   join T_PEDIDO pedido on cargaPedido.PED_CODIGO = pedido.PED_CODIGO
                                   where cargaPedido.CAR_CODIGO = carga.CAR_CODIGO and pedido.LOC_CODIGO_DESTINO = {filtroPesquisa.CodigoOrigem})");
            }

            if (filtroPesquisa.NumeroCTeSubcontratacao > 0)
            {
                where.Append($@" and exists (
                                   select cargaPedido.CPE_CODIGO
                                   from T_CARGA_PEDIDO cargaPedido
                                   where carga.CAR_CODIGO = cargaPedido.CAR_CODIGO
                                   and exists(
                                       select pedidoCteSubContratacao.PSC_CODIGO
                                       from T_PEDIDO_CTE_PARA_SUB_CONTRATACAO pedidoCteSubContratacao
                                       left join T_CTE_TERCEIRO cteTerceitro on cteTerceitro.CPS_CODIGO = pedidoCteSubContratacao.CPS_CODIGO
                                       where T_CTE_TERCEIRO.CPS_NUMERO = {filtroPesquisa.NumeroCTeSubcontratacao}))");
            }

            if (filtroPesquisa.CargaTransbordo.HasValue)
            {
                if (filtroPesquisa.CargaTransbordo.Value)
                    where.Append($@" and carga.CAR_CARGA_TRANSBORDO = 1");
                else
                    where.Append($@" and carga.CAR_CARGA_TRANSBORDO = 0");
            }

            if (filtroPesquisa.CargasDisponiveisParaJanela)
            {
                where.Append($@" and (carga.CAR_SITUACAO not in (13, 18) 
                             and carga.CAR_CODIGO not in (
                               select 
                                 cargaJanelaDescarregamento.CAR_CODIGO 
                               from 
                                 T_CARGA_JANELA_DESCARREGAMENTO cargaJanelaDescarregamento 
                                 join T_CARGA cargaJanela on cargaJanelaDescarregamento.CAR_CODIGO = cargaJanela.CAR_CODIGO 
                               where 
                                 ISNULL(
                                   cargaJanelaDescarregamento.CJD_CANCELADA, 
                                   0
                                 ) = 0 
                                 and exists (
                                   SELECT 
                                     1 
                                   FROM 
                                     T_CARGA_PEDIDO cargaPedido 
                                     join T_PEDIDO pedido ON cargaPedido.PED_CODIGO = pedido.PED_CODIGO 
                                   WHERE 
                                     cargaJanela.CAR_CODIGO = cargaPedido.CAR_CODIGO 
                                     and pedido.CLI_CODIGO = {filtroPesquisa.CpfCnpjDestinatario}
                                 ) 
                                 and cargaJanela.CAR_SITUACAO not in (13, 18)
                             )
                           )");
            }

            if (filtroPesquisa.CodigosEmpresas != null && filtroPesquisa.CodigosEmpresas.Count > 0)
                where.Append($" and carga.EMP_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosEmpresas)})");

            if (filtroPesquisa.SomenteCargasDeRedespacho.HasValue)
            {
                where.Append($@" and tipoOperacao.TOP_OPERACAO_REDESPACHO = {filtroPesquisa.SomenteCargasDeRedespacho.Value}");
            }

            if (filtroPesquisa.NaoRetornarSubCarga)
            {
                where.Append($@" and (cargaDadosSumarizados.CDS_CARGA_TRECHO is null or cargaDadosSumarizados.CDS_CARGA_TRECHO = {CargaTrechoSumarizada.Agrupadora.GetHashCode()})");
            }

            if (!string.IsNullOrWhiteSpace(filtroPesquisa.NumeroContainer))
            {
                where.Append($@" and exists(
                                   select coletaContainer.CCR_CODIDO
                                   from T_COLETA_CONTAINER coletaContainer
                                   join T_CONTAINER container on coletaContainer.CTR_CODIGO = container.CTR_CODIGO 
                                   where (coletaContainer.CAR_CODIGO_ATUAL = carga.CAR_CODIGO and container.CTR_NUMERO = {filtroPesquisa.NumeroContainer}))");
            }

            if (filtroPesquisa.CodigoClienteTerceiro > 0)
                where.Append($@" and carga.CLI_CGCCPF_TERCEIRO = {filtroPesquisa.CodigoClienteTerceiro}");

            if (filtroPesquisa.NaoExibirCargasCanceladas)
                where.Append($@" and carga.CAR_SITUACAO != {SituacaoCarga.Cancelada.GetHashCode()}");

            if (filtroPesquisa.SituacaoDiferente?.Count() > 0)
                where.Append($@" and carga.CAR_SITUACAO not in ({string.Join(", ", filtroPesquisa.SituacaoDiferente.Select(x => (int)x))})");

            if (filtroPesquisa.CpfCnpjFornecedor > 0)
                where.Append($@"and exists(
                                   select cargaPedido.CPE_CODIGO
                                   from T_CARGA_PEDIDO cargaPedido
                                   join T_PEDIDO pedido on cargaPedido.PED_CODIGO = pedido.PED_CODIGO
                                   where cargaPedido.CAR_CODIGO = carga.CAR_CODIGO and pedido.CLI_CODIGO_PROVEDOR_OS = {filtroPesquisa.CpfCnpjFornecedor})");

            string sql = select.Append(joins).Append(where).ToString();

            if (!somenteContarNumeroRegistros && !string.IsNullOrWhiteSpace(propOrdenacao))
            {
                sql += $" order by {propOrdenacao} {dirOrdenacao}";

                if ((inicioRegistros > 0) || (maximoRegistros > 0))
                    sql += $" offset {inicioRegistros} rows fetch next {maximoRegistros} rows only;";
            }

            return sql;
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> _ConsultarCargasDaOcorrenciaPorCTe(int ocorrencia)
        {
            // To Do: Refator codigo
            // Talvez seja necessário criar um vinculo Ocorr -> Carga por entidade e não por set
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var queryCargaOcorrencia = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Ocorrencias.CargaOcorrencia>();

            var resultCargaOcorrencia = (from o in queryCargaOcorrencia where o.Codigo == ocorrencia select o).FirstOrDefault();
            int[] codigoCargas = (from o in resultCargaOcorrencia.Cargas select o.Codigo).ToArray();

            var result = from o in query where codigoCargas.Contains(o.Codigo) select o;

            return result;
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> _ConsultarCargasFinalizadasAmbiente(bool cargasNaoAgrupadas, int transportador, long? codigoTransportadorTerceiro, string numeroCarga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga[] situacao)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            if (cargasNaoAgrupadas)
                query = query.Where(obj => (obj.CargaFechada == true && !obj.CargaAgrupada) || (obj.CargaFechada == false && obj.CargaAgrupamento != null));
            else
                query = query.Where(obj => obj.CargaFechada == true);

            if (!string.IsNullOrWhiteSpace(numeroCarga))
                query = query.Where(o => o.CodigoCargaEmbarcador.Contains(numeroCarga) || o.CodigosAgrupados.Contains(numeroCarga));

            if (transportador > 0)
                query = query.Where(o => o.Empresa.Codigo == transportador);

            if ((codigoTransportadorTerceiro ?? 0) > 0)
                query = query.Where(obj => obj.Terceiro.Codigo == codigoTransportadorTerceiro);

            if (situacao.Count() > 0)
                query = query.Where(o => situacao.Contains(o.SituacaoCarga));

            return query;
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> _ConsultarAvarias(double recebedor, double destinatario, string numeroCarga, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga[] situacao)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            query = query.Where(obj => (obj.CargaFechada && !obj.CargaAgrupada) || (!obj.CargaFechada && obj.CargaAgrupamento != null));

            if (!string.IsNullOrWhiteSpace(numeroCarga))
                query = query.Where(o => o.CodigoCargaEmbarcador == numeroCarga);

            if (destinatario > 0)
                query = query.Where(o => o.CargaOrigemPedidos.Any(ped => ped.Pedido.Destinatario.CPF_CNPJ == destinatario));

            if (recebedor > 0)
                query = query.Where(o => o.CargaOrigemPedidos.Any(ped => ped.Recebedor.CPF_CNPJ == recebedor));

            if (situacao.Count() > 0)
                query = query.Where(o => situacao.Contains(o.SituacaoCarga));

            return query;
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> _ConsultarParaPreCarga(DateTime dataInicial, DateTime dataFinal, string numeroCarga, int filial, int origem, int destino, int transportador, List<double> remetentes, List<double> destinatarios)
        {
            List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarga> situacoesCargaNaoEmitida = Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCargaHelper.ObterSituacoesCargaNaoEmitida();
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            //var queryPreCargas = (from o in this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.PreCargas.PreCarga>() select o.Carga);

            var result = from obj in query
                         where situacoesCargaNaoEmitida.Contains(obj.SituacaoCarga) && obj.PreCarga == null //!queryPreCargas.Any(p => p.Codigo == obj.Codigo)
                         select obj;

            // Filtros
            if (dataInicial != DateTime.MinValue)
                result = result.Where(o => o.DataCarregamentoCarga.Value.Date >= dataInicial);

            if (dataFinal != DateTime.MinValue)
                result = result.Where(o => o.DataCarregamentoCarga.Value.Date <= dataFinal);

            if (!string.IsNullOrWhiteSpace(numeroCarga))
                result = result.Where(o => o.CodigoCargaEmbarcador == numeroCarga);

            if (origem > 0)
                result = result.Where(o => o.Pedidos.Any(p => p.Pedido.Origem.Codigo == origem));

            if (destino > 0)
                result = result.Where(o => o.Pedidos.Any(p => p.Pedido.Destino.Codigo == destino));

            if (filial > 0)
                result = result.Where(o => o.Filial.Codigo == filial);

            if (transportador > 0)
                result = result.Where(o => o.Empresa.Codigo == transportador);

            if (remetentes.Count > 0)
            {
                //result = result.Where(o => o.Pedidos.Any(p => p.Pedido.Remetente.CPF_CNPJ == remetentes.FirstOrDefault()));
                //result = result.Where(o => o.Pedidos.Select(c => c.Pedido.Remetente.CPF_CNPJ).Distinct().Count() == remetentes.Count);
                //result = result.Where(o => o.Pedidos.Any(p => remetentes.Contains(p.Pedido.Remetente.CPF_CNPJ)));
                result = result.Where(RemetentesExatos(remetentes));
            }

            if (destinatarios.Count > 0)
            {
                //result = result.Where(o => o.Pedidos.Any(p => p.Pedido.Destinatario.CPF_CNPJ == destinatarios.FirstOrDefault()));
                //result = result.Where(o => o.Pedidos.Select(c => c.Pedido.Destinatario.CPF_CNPJ).Distinct().Count() == destinatarios.Count);
                //result = result.Where(o => o.Pedidos.Any(p => destinatarios.Contains(p.Pedido.Destinatario.CPF_CNPJ)));
                result = result.Where(DestinatariosExatos(destinatarios));
            }

            return result;
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarParaFilaCarregamento(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCargaFilaCarregamento filtrosPesquisa)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiTMS ||
                filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.TransportadorTerceiro)
                consultaCarga = consultaCarga.Where(carga => carga.SituacaoCarga == SituacaoCarga.Nova || carga.SituacaoCarga == SituacaoCarga.AgNFe);
            else
                consultaCarga = consultaCarga.Where(carga => carga.SituacaoCarga == SituacaoCarga.AgTransportador || (carga.SituacaoCarga == SituacaoCarga.Nova && (carga.Empresa == null || carga.Veiculo == null || carga.Motoristas.Count == 0)));

            if (!string.IsNullOrWhiteSpace(filtrosPesquisa.CodigoCargaEmbarcador))
            {
                //Alterado OR da consulta do nro carga com codigos agrupados para buscar antes os codigos das cargas praa depois fazer um IN
                //consultaCarga = consultaCarga.Where(o => o.CodigoCargaEmbarcador == filtrosPesquisa.CodigoCargaEmbarcador || o.CodigosAgrupados.Any(a => a == filtrosPesquisa.CodigoCargaEmbarcador));
                IList<int> codigosCarga = this.BuscarCodigosCargaEmCargasEEmCodigosAgrupados(filtrosPesquisa.CodigoCargaEmbarcador);
                consultaCarga = consultaCarga.Where(o => codigosCarga.Contains(o.Codigo));
            }

            if (filtrosPesquisa.CodigoFilial > 0)
                consultaCarga = consultaCarga.Where(o => o.Filial.Codigo == filtrosPesquisa.CodigoFilial);

            if (filtrosPesquisa.CodigoModeloVeicularCarga > 0)
                consultaCarga = consultaCarga.Where(o => o.ModeloVeicularCarga.Codigo == filtrosPesquisa.CodigoModeloVeicularCarga);

            if (filtrosPesquisa.DataInicial.HasValue)
                consultaCarga = consultaCarga.Where(o => o.DataCarregamentoCarga.Value >= filtrosPesquisa.DataInicial.Value.Date);

            if (filtrosPesquisa.DataLimite.HasValue)
                consultaCarga = consultaCarga.Where(o => o.DataCarregamentoCarga.Value <= filtrosPesquisa.DataLimite.Value.Date.Add(DateTime.MaxValue.TimeOfDay));

            return consultaCarga;
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> _ConsultarCargasPendenteCancelamento(Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaCancelamentoCargaLote filtrosPesquisa)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            query = query.Where(obj => obj.SituacaoCarga != SituacaoCarga.Cancelada && obj.SituacaoCarga != SituacaoCarga.Anulada);

            if (filtrosPesquisa.Situacoes.Count == 1 && filtrosPesquisa.Situacoes.Contains(SituacaoCarga.NaLogistica))
            {
                query = query.Where(obj => (obj.SituacaoCarga != SituacaoCarga.Encerrada &&
                                            obj.SituacaoCarga != SituacaoCarga.EmTransporte &&
                                            obj.SituacaoCarga != SituacaoCarga.LiberadoPagamento) || obj.AgConfirmacaoUtilizacaoCredito);
            }
            else
                query = query.Where(obj => filtrosPesquisa.Situacoes.Contains(obj.SituacaoCarga));

            if (filtrosPesquisa.CodigoEmpresa > 0)
                query = query.Where(obj => obj.Empresa.Codigo == filtrosPesquisa.CodigoEmpresa);

            if (filtrosPesquisa.CodigoTipoOperacao?.Count > 0)
                query = query.Where(obj => filtrosPesquisa.CodigoTipoOperacao.Contains(obj.TipoOperacao.Codigo));

            if (filtrosPesquisa.TipoServicoMultisoftware == AdminMultisoftware.Dominio.Enumeradores.TipoServicoMultisoftware.MultiEmbarcador)
            {
                if (filtrosPesquisa.CodigoOrigem > 0)
                    query = query.Where(obj => obj.Pedidos.Any(ped => ped.Origem.Codigo == filtrosPesquisa.CodigoOrigem));

                if (filtrosPesquisa.CodigoDestino > 0)
                    query = query.Where(obj => obj.Pedidos.Any(ped => ped.Pedido.Destino.Codigo == filtrosPesquisa.CodigoDestino));

                if (filtrosPesquisa.DataInicioEmissao != DateTime.MinValue)
                    query = query.Where(obj => obj.DataCriacaoCarga.Date >= filtrosPesquisa.DataInicioEmissao);

                if (filtrosPesquisa.DataFinalEmissao != DateTime.MinValue)
                    query = query.Where(obj => obj.DataCriacaoCarga.Date <= filtrosPesquisa.DataFinalEmissao);
            }
            else
            {
                if (filtrosPesquisa.CodigoPedidoViagemDirecao > 0 || filtrosPesquisa.DataInicioEmissao > DateTime.MinValue || filtrosPesquisa.DataFinalEmissao > DateTime.MinValue || !string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroBooking) ||
                    filtrosPesquisa.CodigoTerminalOrigem > 0 || filtrosPesquisa.CodigoTerminalDestino > 0 || filtrosPesquisa.CodigoOrigem > 0 || filtrosPesquisa.CodigoDestino > 0 || filtrosPesquisa.CnpjTomador > 0 || filtrosPesquisa.DataCriacaoCarga > DateTime.MinValue)
                {
                    var queryCargaCTe = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();
                    if (filtrosPesquisa.CodigoPedidoViagemDirecao > 0)
                        queryCargaCTe = queryCargaCTe.Where(obj => obj.CTe.Viagem.Codigo == filtrosPesquisa.CodigoPedidoViagemDirecao);
                    if (filtrosPesquisa.DataInicioEmissao > DateTime.MinValue)
                        queryCargaCTe = queryCargaCTe.Where(obj => obj.CTe.DataEmissao.Value.Date >= filtrosPesquisa.DataInicioEmissao.Date);
                    if (filtrosPesquisa.DataFinalEmissao > DateTime.MinValue)
                        queryCargaCTe = queryCargaCTe.Where(obj => obj.CTe.DataEmissao.Value.Date <= filtrosPesquisa.DataFinalEmissao.Date);

                    if (filtrosPesquisa.DataCriacaoCarga > DateTime.MinValue)
                        queryCargaCTe = queryCargaCTe.Where(obj => obj.Carga.DataCriacaoCarga.Date == filtrosPesquisa.DataCriacaoCarga.Date);

                    if (!string.IsNullOrWhiteSpace(filtrosPesquisa.NumeroBooking))
                        queryCargaCTe = queryCargaCTe.Where(obj => obj.CTe.NumeroBooking == filtrosPesquisa.NumeroBooking);
                    if (filtrosPesquisa.CodigoTerminalOrigem > 0)
                        queryCargaCTe = queryCargaCTe.Where(obj => obj.CTe.TerminalOrigem.Codigo == filtrosPesquisa.CodigoTerminalOrigem);
                    if (filtrosPesquisa.CodigoTerminalDestino > 0)
                        queryCargaCTe = queryCargaCTe.Where(obj => obj.CTe.TerminalDestino.Codigo == filtrosPesquisa.CodigoTerminalDestino);
                    if (filtrosPesquisa.CodigoOrigem > 0)
                        queryCargaCTe = queryCargaCTe.Where(obj => obj.CTe.LocalidadeInicioPrestacao.Codigo == filtrosPesquisa.CodigoOrigem);
                    if (filtrosPesquisa.CodigoDestino > 0)
                        queryCargaCTe = queryCargaCTe.Where(obj => obj.CTe.LocalidadeTerminoPrestacao.Codigo == filtrosPesquisa.CodigoDestino);
                    if (filtrosPesquisa.CnpjTomador > 0)
                        queryCargaCTe = queryCargaCTe.Where(obj => obj.CTe.TomadorPagador.Cliente.CPF_CNPJ == filtrosPesquisa.CnpjTomador);

                    query = query.Where(obj => queryCargaCTe.Any(o => o.Carga.Codigo == obj.Codigo));
                }
            }

            if (filtrosPesquisa.TipoPropostaMultimodal?.Count > 0 || filtrosPesquisa.TiposPropostasMultimodal?.Count > 0)
            {
                var queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
                if (filtrosPesquisa.TipoPropostaMultimodal?.Count > 0)
                    queryCargaPedido = queryCargaPedido.Where(obj => filtrosPesquisa.TipoPropostaMultimodal.Contains(obj.TipoPropostaMultimodal));
                if (filtrosPesquisa.TiposPropostasMultimodal?.Count > 0)
                    queryCargaPedido = queryCargaPedido.Where(obj => filtrosPesquisa.TiposPropostasMultimodal.Contains(obj.TipoPropostaMultimodal));

                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga.Codigo == obj.Codigo));
            }

            if (filtrosPesquisa.CodigoVeiculo > 0)
                query = query.Where(obj => obj.Veiculo.Codigo == filtrosPesquisa.CodigoVeiculo || obj.VeiculosVinculados.Any(v => v.Codigo == filtrosPesquisa.CodigoVeiculo));

            if (filtrosPesquisa.CodigoMotorista > 0)
                query = query.Where(obj => obj.Motoristas.Any(m => m.Codigo == filtrosPesquisa.CodigoMotorista));

            if (filtrosPesquisa.CnpjRemetente > 0)
            {
                var queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>()
                    .Where(obj => obj.Pedido.Remetente.CPF_CNPJ == filtrosPesquisa.CnpjRemetente);

                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga.Codigo == obj.Codigo));
            }

            if (filtrosPesquisa.CnpjDestinatario > 0)
            {
                var queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>()
                    .Where(obj => obj.Pedido.Destinatario.CPF_CNPJ == filtrosPesquisa.CnpjDestinatario);

                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga.Codigo == obj.Codigo));
            }

            if (filtrosPesquisa.CodigosCarga?.Count > 0)
                query = query.Where(o => filtrosPesquisa.CodigosCarga.Contains(o.Codigo));

            var queryCargaCancelamento = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCancelamento>()
                .Where(o => ((TipoCancelamentoCargaDocumento?)o.TipoCancelamentoCargaDocumento ?? TipoCancelamentoCargaDocumento.Carga) == TipoCancelamentoCargaDocumento.Carga);
            query = query.Where(obj => !queryCargaCancelamento.Any(o => o.Carga.Codigo == obj.Codigo));

            return query;
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarWebServiceMonitoramento(DateTime dataInicial)
        {
            var consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(o =>
                    o.DataAtualizacaoCarga >= dataInicial &&
                    o.CargaFechada == true
                );

            return consultaCarga;
        }

        private Expression<Func<Dominio.Entidades.Embarcador.Cargas.Carga, bool>> RemetentesExatos(List<double> clientesRemetente)
        {
            var clientesExatos = PredicateBuilder.True<Dominio.Entidades.Embarcador.Cargas.Carga>();

            clientesExatos = clientesExatos.And(o => o.DadosSumarizados.ClientesRemetentes.Count() == clientesRemetente.Count);

            var clientesExatosClientes = PredicateBuilder.True<Dominio.Entidades.Embarcador.Cargas.Carga>();

            foreach (double clienteOrigem in clientesRemetente)
                clientesExatosClientes = clientesExatosClientes.And(o => o.DadosSumarizados.ClientesRemetentes.Any(c => c.CPF_CNPJ == clienteOrigem));

            clientesExatos = clientesExatos.And(clientesExatosClientes);

            return clientesExatos;
        }

        private Expression<Func<Dominio.Entidades.Embarcador.Cargas.Carga, bool>> DestinatariosExatos(List<double> clientesDestino)
        {
            var clientesExatos = PredicateBuilder.True<Dominio.Entidades.Embarcador.Cargas.Carga>();

            clientesExatos = clientesExatos.And(o => o.DadosSumarizados.ClientesDestinatarios.Count() == clientesDestino.Count);

            var clientesExatosClientes = PredicateBuilder.True<Dominio.Entidades.Embarcador.Cargas.Carga>();

            foreach (double clienteDestino in clientesDestino)
                clientesExatosClientes = clientesExatosClientes.And(o => o.DadosSumarizados.ClientesDestinatarios.Any(c => c.CPF_CNPJ == clienteDestino));

            clientesExatos = clientesExatos.And(clientesExatosClientes);

            return clientesExatos;
        }

        private void DeletarCargaEntregas(int codigoCarga)
        {
            //AO INSERIR UM SCRIPT PARA DELETAR ABAIXO, DEVE IMPLEMENTAR A TRANSFERÊNCIA DELE PARA A NOVA ENTREGA, QUE ACONTECE NO MÉTODO: TransferirDadosDasEntregasAntigas

            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaFoto WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaFoto c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM ControleNotaDevolucao WHERE CargaEntregaNFeDevolucao.Codigo IN (SELECT c.Codigo FROM CargaEntregaNFeDevolucao c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaNFeDevolucao WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaNFeDevolucao c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaNotaFiscalChamado WHERE CargaEntregaNotaFiscal.Codigo IN (SELECT c.Codigo FROM CargaEntregaNotaFiscal c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaNotaFiscal WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaNotaFiscal c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).SetTimeout(120).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM OcorrenciaColetaEntregaAnexo WHERE Codigo IN (SELECT c.Codigo FROM OcorrenciaColetaEntregaAnexo c WHERE c.EntidadeAnexo.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM OcorrenciaColetaEntrega WHERE Codigo IN (SELECT c.Codigo FROM OcorrenciaColetaEntrega c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM MonitoramentoHistoricoStatusViagemPermanenciaCliente WHERE Codigo IN (SELECT c.Codigo FROM MonitoramentoHistoricoStatusViagemPermanenciaCliente c WHERE c.PermanenciaCliente.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM MonitoramentoHistoricoStatusViagemPermanenciaSubArea WHERE Codigo IN (SELECT c.Codigo FROM MonitoramentoHistoricoStatusViagemPermanenciaSubArea c WHERE c.PermanenciaSubarea.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM PermanenciaCliente WHERE Codigo IN (SELECT c.Codigo FROM PermanenciaCliente c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM PermanenciaSubarea WHERE Codigo IN (SELECT c.Codigo FROM PermanenciaSubarea c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaPedido WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaPedido c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM ColetaContainerCargaEntrega WHERE Codigo IN (SELECT c.Codigo FROM ColetaContainerCargaEntrega c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaProdutoChamado WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaProdutoChamado c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaProduto WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaProduto c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("UPDATE AlertasAcompanhamentoCarga c SET c.CargaEvento = NULL, c.AlertaMonitor = NULL WHERE c.Carga.Codigo = :codigoCarga").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM AlertasAcompanhamentoCarga c WHERE c.Carga.Codigo = :codigoCarga").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM AlertasAcompanhamentoCarga WHERE Codigo in (SELECT c.Codigo from AlertasAcompanhamentoCarga c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM PerdaSinalMonitoramento WHERE Codigo IN (SELECT a.Codigo FROM PerdaSinalMonitoramento a WHERE a.AlertaMonitor.Codigo in (SELECT b.Codigo FROM AlertaMonitor b WHERE b.CargaEntrega.Carga.Codigo = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM PerdaSinalMonitoramento WHERE Codigo IN (SELECT a.Codigo FROM PerdaSinalMonitoramento a WHERE a.AlertaMonitor.Codigo in (SELECT b.Codigo FROM AlertaMonitor b WHERE b.Carga.Codigo = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM AlertaMonitorNotificacao WHERE Codigo IN (SELECT a.Codigo FROM AlertaMonitorNotificacao a WHERE a.AlertaMonitor.Codigo in (SELECT b.Codigo FROM AlertaMonitor b WHERE b.CargaEntrega.Carga.Codigo = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM AlertaMonitorNotificacao WHERE Codigo IN (SELECT a.Codigo FROM AlertaMonitorNotificacao a WHERE a.AlertaMonitor.Codigo in (SELECT b.Codigo FROM AlertaMonitor b WHERE b.Carga.Codigo = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM AlertaMonitor WHERE Codigo in (SELECT c.Codigo FROM AlertaMonitor c WHERE c.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM AlertaMonitor WHERE Codigo IN (SELECT c.Codigo FROM AlertaMonitor c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).SetTimeout(60).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaChaveNfe WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaChaveNfe c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_INTEGRACAO_SUPER_APP WHERE CEN_CODIGO IN (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaAssinaturaResponsavel WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaAssinaturaResponsavel c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();

            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaCheckListAlternativa WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaCheckListAlternativa c WHERE c.CargaEntregaCheckListPergunta.Codigo IN (SELECT a.Codigo FROM CargaEntregaCheckListPergunta a WHERE a.CargaEntregaCheckList.Codigo in (SELECT b.Codigo FROM CargaEntregaCheckList b WHERE b.CargaEntrega.Carga.Codigo = :codigoCarga)))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaCheckListPergunta WHERE Codigo IN (SELECT a.Codigo FROM CargaEntregaCheckListPergunta a WHERE a.CargaEntregaCheckList.Codigo in (SELECT b.Codigo FROM CargaEntregaCheckList b WHERE b.CargaEntrega.Carga.Codigo = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaCheckList WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaCheckList c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaFotoNotaFiscal WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaFotoNotaFiscal c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntregaGuiaTransporteAnimal WHERE Codigo IN (SELECT c.Codigo FROM CargaEntregaGuiaTransporteAnimal c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaOcorrencia WHERE Codigo IN (SELECT c.Codigo FROM CargaOcorrencia c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();

            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CARGA_ENTREGA_EVENTO_INTEGRACAO_ARQUIVO where INT_CODIGO in (select INT_CODIGO from T_CARGA_ENTREGA_EVENTO_INTEGRACAO where CEE_CODIGO in (select CEE_CODIGO from T_CARGA_ENTREGA_EVENTO where CAR_CODIGO = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CARGA_ENTREGA_EVENTO_INTEGRACAO where  CEE_CODIGO in(select CEE_CODIGO  from T_CARGA_ENTREGA_EVENTO where CAR_CODIGO = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CARGA_ENTREGA_EVENTO where CAR_CODIGO = :codigoCarga").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CARGA_ENTREGA_EVENTO where CEN_CODIGO IN (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEvento WHERE Codigo IN (SELECT c.Codigo FROM CargaEvento c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();

            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_TRANSBORDO_CARGA_ENTREGA where CEN_CODIGO in (select CEN_CODIGO  from T_CARGA_ENTREGA where CAR_CODIGO = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM ChamadoAnalise WHERE Codigo IN (SELECT a.Codigo FROM ChamadoAnalise a WHERE a.Chamado.Codigo in (SELECT b.Codigo FROM Chamado b WHERE b.CargaEntrega.Carga.Codigo = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM ChamadoOcorrencia WHERE Codigo IN (SELECT a.Codigo FROM ChamadoOcorrencia a WHERE a.Chamado.Codigo in (SELECT b.Codigo FROM Chamado b WHERE b.CargaEntrega.Carga.Codigo = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CHAMADO_ANALISTAS WHERE CHA_CODIGO IN (SELECT CHA_CODIGO FROM T_CHAMADOS WHERE CAR_CODIGO = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CHAMADO_ANALISTAS WHERE CHA_CODIGO IN (SELECT CHA_CODIGO FROM T_CHAMADOS WHERE CEN_CODIGO in (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CHAMADO_ANEXOS WHERE CHA_CODIGO IN (SELECT CHA_CODIGO FROM T_CHAMADOS WHERE CAR_CODIGO = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CHAMADO_ANEXOS WHERE CHA_CODIGO IN (SELECT CHA_CODIGO FROM T_CHAMADOS WHERE CEN_CODIGO in (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CHAMADO_DATA WHERE CHA_CODIGO IN (SELECT CHA_CODIGO FROM T_CHAMADOS WHERE CAR_CODIGO = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CHAMADO_DATA WHERE CHA_CODIGO IN (SELECT CHA_CODIGO FROM T_CHAMADOS WHERE CEN_CODIGO in (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CHAMADO_PERFIL_ACESSO WHERE CHA_CODIGO IN (SELECT CHA_CODIGO FROM T_CHAMADOS WHERE CAR_CODIGO = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CHAMADO_PERFIL_ACESSO WHERE CHA_CODIGO IN (SELECT CHA_CODIGO FROM T_CHAMADOS WHERE CEN_CODIGO IN (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CHAMADO_REGRAS_ANALISE WHERE CHA_CODIGO IN (SELECT CHA_CODIGO FROM T_CHAMADOS WHERE CAR_CODIGO = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CHAMADO_REGRAS_ANALISE WHERE CHA_CODIGO IN (SELECT CHA_CODIGO FROM T_CHAMADOS WHERE CEN_CODIGO IN (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CHAMADO_XML_NOTA_FISCAL WHERE CHA_CODIGO IN (SELECT CHA_CODIGO FROM T_CHAMADOS WHERE CAR_CODIGO = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CHAMADO_XML_NOTA_FISCAL WHERE CHA_CODIGO IN (SELECT CHA_CODIGO FROM T_CHAMADOS WHERE CEN_CODIGO IN (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CHAMADO_INFORMACAO_FECHAMENTO WHERE CHA_CODIGO IN (SELECT CHA_CODIGO FROM T_CHAMADOS WHERE CAR_CODIGO = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_CHAMADO_INFORMACAO_FECHAMENTO WHERE CHA_CODIGO IN (SELECT CHA_CODIGO FROM T_CHAMADOS WHERE CEN_CODIGO IN (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_NIVEL_ATENDIMENTO WHERE CHA_CODIGO IN (SELECT CHA_CODIGO FROM T_CHAMADOS WHERE CEN_CODIGO IN (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM HistoricoNotaFiscalChamado WHERE Chamado.Codigo IN (SELECT c.Codigo FROM Chamado c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).SetTimeout(300).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_MONITORAMENTO_NOTIFICACOES_APP WHERE CHA_CODIGO IN (SELECT c.CHA_CODIGO FROM T_CHAMADOS C WHERE c.CEN_CODIGO IN (SELECT e.CEN_CODIGO from T_CARGA_ENTREGA e WHERE e.CAR_CODIGO = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).SetTimeout(300).ExecuteUpdate();
            UnitOfWork.Sessao.CreateQuery("DELETE FROM Chamado WHERE Codigo IN (SELECT c.Codigo FROM Chamado c WHERE c.CargaEntrega.Carga.Codigo = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).SetTimeout(300).ExecuteUpdate();

            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_GESTAO_DADOS_COLETA_INTEGRACAO_ARQUIVO_ARQUIVO WHERE INT_CODIGO IN (select INT_CODIGO from T_GESTAO_DADOS_COLETA_INTEGRACAO where GDC_CODIGO IN (SELECT GDC_CODIGO FROM T_GESTAO_DADOS_COLETA WHERE CEN_CODIGO IN (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga)))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_GESTAO_DADOS_COLETA_INTEGRACAO WHERE GDC_CODIGO IN (SELECT GDC_CODIGO FROM T_GESTAO_DADOS_COLETA WHERE CEN_CODIGO IN (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_GESTAO_DADOS_COLETA_DADOS_NFE WHERE GDC_CODIGO IN (SELECT GDC_CODIGO FROM T_GESTAO_DADOS_COLETA WHERE CEN_CODIGO IN (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_GESTAO_DADOS_COLETA_DADOS_TRANSPORTE WHERE GDC_CODIGO IN (SELECT GDC_CODIGO FROM T_GESTAO_DADOS_COLETA WHERE CEN_CODIGO IN (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga))").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_GESTAO_DADOS_COLETA WHERE CEN_CODIGO IN (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();
            UnitOfWork.Sessao.CreateSQLQuery("DELETE FROM T_GESTAO_DEVOLUCAO_NFE_TRANSFERENCIA_PALLET WHERE CEN_CODIGO IN (SELECT CEN_CODIGO FROM T_CARGA_ENTREGA WHERE CAR_CODIGO = :codigoCarga)").SetInt32("codigoCarga", codigoCarga).ExecuteUpdate();

            UnitOfWork.Sessao.CreateQuery("DELETE FROM CargaEntrega c WHERE c.Carga.Codigo = :codigoCarga").SetInt32("codigoCarga", codigoCarga).SetTimeout(300).ExecuteUpdate();

            //AO INSERIR UM SCRIPT PARA DELETAR ACIMA, DEVE IMPLEMENTAR A TRANSFERÊNCIA DELE PARA A NOVA ENTREGA, QUE ACONTECE NO MÉTODO: TransferirDadosDasEntregasAntigas
        }

        private string QueryCargasPlanejamentoFrota(Dominio.ObjetosDeValor.Embarcador.Frota.FiltroPesquisaPlanejamentoFrotaCarga filtroPesquisa, bool somenteContarNumeroRegistros, string propOrdenacao = "", string dirOrdenacao = "", int inicioRegistros = 0, int maximoRegistros = 0)
        {
            string sql;
            string pattern = "yyyy-MM-dd";

            if (somenteContarNumeroRegistros)
                sql = "select distinct(count(0) over ()) ";
            else
                sql = @"select
                        Carga.CAR_CODIGO Codigo,
                        Carga.CAR_DATA_CARREGAMENTO DataCarregamento,
                        Carga.CAR_CODIGO_CARGA_EMBARCADOR CodigoCargaEmbarcador,
                        Carga.CAR_VALOR_FRETE_PAGAR ValorFrete,
                        Carga.GRP_CODIGO CodigoGrupoPessoas,
                        Carga.CAR_DATA_INICIAL_PREVISAO_CARREGAMENTO DataInicioCarregamento,
                        Carga.CAR_DATA_FINAL_PREVISAO_CARREGAMENTO DataFimCarregamento,
                        ModeloVeiculo.MVC_DESCRICAO ModeloVeicular,
                        DadosSumarizados.CDS_PESO_TOTAL Peso,
                        DadosSumarizados.CDS_ORIGENS Origem,
                        DadosSumarizados.CDS_DESTINOS Destino,
                        ( SELECT
                                FrotaCarga.FRC_CODIGO Codigo,
                                FrotaCarga.FRT_CODIGO CodigoFrota,
                                FrotaCarga.CAR_CODIGO CodigoCarga,
			                    VeiculoTracao.VEI_PLACA PlacaTracao,
			                    VeiculoReboque1.VEI_PLACA PlacaReboque1,
			                    VeiculoReboque2.VEI_PLACA PlacaReboque2,
			                    Motorista.FUN_NOME Motorista,
                                FrotaCarga.RFC_SITUACAO_COMPROMETIMENTO SituacaoComprometimentoFrota
                            FROM
                                T_FROTA_CARGA FrotaCarga                                  
                            LEFT JOIN
                                T_FROTA AS Frota 
                                    on FrotaCarga.FRT_CODIGO = Frota.FRT_CODIGO 
	                        LEFT JOIN
                                T_VEICULO AS VeiculoTracao 
                                    on VeiculoTracao.VEI_CODIGO = Frota.VEI_CODIGO_TRACAO 
	                        LEFT JOIN
                                T_VEICULO AS VeiculoReboque1 
                                    on VeiculoReboque1.VEI_CODIGO = Frota.VEI_CODIGO_REBOQUE
	                        LEFT JOIN
                                T_VEICULO AS VeiculoReboque2 
                                    on VeiculoReboque2.VEI_CODIGO = Frota.VEI_CODIGO_REBOQUE2
		                    left join
                            T_FUNCIONARIO as Motorista 
                                on Motorista.FUN_CODIGO = Frota.FUN_CODIGO_MOTORISTA
                            WHERE
                                FrotaCarga.CAR_CODIGO = Carga.CAR_CODIGO 
                            order by
                                FrotaCarga.FRC_DATA_CARREGAMENTO desc FOR JSON PATH ) DadosPlanejamentoCarga ";

            sql += @"   from T_CARGA Carga
                        left join T_CARGA_DADOS_SUMARIZADOS DadosSumarizados ON DadosSumarizados.CDS_CODIGO = Carga.CDS_CODIGO
                        left join T_MODELO_VEICULAR_CARGA ModeloVeiculo on ModeloVeiculo.MVC_CODIGO = Carga.MVC_CODIGO
                        left join T_FILIAL as Filial on Filial.FIL_CODIGO = Carga.FIL_CODIGO
                        left join T_VEICULO as Veiculo on Veiculo.VEI_CODIGO = Carga.CAR_VEICULO
                        left join T_EMPRESA as Empresa on Empresa.EMP_CODIGO = Carga.EMP_CODIGO ";

            sql += " where Carga.CAR_CARGA_FECHADA = 1 and Carga.CAR_SITUACAO in (1, 2, 5)";
            sql += $" and CAST(Carga.CAR_DATA_CARREGAMENTO AS DATE) = '{filtroPesquisa.Data.ToString(pattern)}'";

            if (filtroPesquisa.CodigosTransportador?.Count > 0)
                sql += $" and Empresa.EMP_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosTransportador)}) ";

            if (filtroPesquisa.CodigosVeiculos?.Count > 0)
            {
                string codigosVeiculos = string.Join(", ", filtroPesquisa.CodigosVeiculos);
                sql += $@" 
                    AND (
                        Veiculo.VEI_CODIGO in ({codigosVeiculos}) 
                        OR exists (
                            SELECT 1
                            FROM T_CARGA_VEICULOS_VINCULADOS VeiculosVinculados9
                            JOIN T_VEICULO Veiculo9 on Veiculo9.VEI_CODIGO = VeiculosVinculados9.VEI_CODIGO
                            WHERE VeiculosVinculados9.CAR_CODIGO = Carga.CAR_CODIGO AND Veiculo9.VEI_CODIGO in ({codigosVeiculos})
			            )) ";
            }

            if (!string.IsNullOrWhiteSpace(filtroPesquisa.CodigoCargaEmbarcador))
            {
                sql += $"AND Carga.CAR_CODIGO_CARGA_EMBARCADOR LIKE '%{filtroPesquisa.CodigoCargaEmbarcador}%'";
            }

            if (filtroPesquisa.CodigoGrupoPessoa > 0)
                sql += $" AND Carga.GRP_CODIGO = '{filtroPesquisa.CodigoGrupoPessoa}'";

            if (filtroPesquisa.CodigosFilial != null && filtroPesquisa.CodigosFilial.Count > 0)
            {
                sql += $" and (Filial.FIL_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosFilial)}) or Carga.FIL_CODIGO_DESTINO in ({string.Join(", ", filtroPesquisa.CodigosFilial)}))";
            }

            if (filtroPesquisa.EstadosDestino?.Count > 0)
            {
                sql += $@" AND EXISTS ( 
                        SELECT 1                   
                        FROM t_carga_pedido CargaPedido             
                        INNER JOIN t_localidades Localidade1 ON Localidade1.LOC_CODIGO = CargaPedido.LOC_CODIGO_DESTINO            
                        WHERE CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO AND Localidade1.UF_SIGLA in ('{string.Join("', '", filtroPesquisa.EstadosDestino)}')) ";
            }


            if (filtroPesquisa.EstadosOrigem?.Count > 0)
            {
                sql += $@" AND EXISTS ( 
                        SELECT 1                   
                        FROM t_carga_pedido CargaPedido             
                        INNER JOIN t_localidades Localidade1 ON Localidade1.LOC_CODIGO  = CargaPedido.LOC_CODIGO_ORIGEM         
                        WHERE CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO AND Localidade1.UF_SIGLA in ('{string.Join("', '", filtroPesquisa.EstadosOrigem)}'))";
            }

            if (filtroPesquisa.CodigosPaisDestino?.Count > 0)
            {
                sql += $@" AND EXISTS ( 
                        SELECT 1                   
                        FROM t_carga_pedido CargaPedido             
                        INNER JOIN t_localidades Localidade1 ON Localidade1.LOC_CODIGO = CargaPedido.LOC_CODIGO_DESTINO          
                        WHERE CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO                         
                        AND Localidade1.PAI_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosPaisDestino)})) ";
            }

            if (filtroPesquisa.CodigosOrigem?.Count > 0)
            {
                sql += $@" AND EXISTS (
                            SELECT 1
                            FROM t_carga_pedido CargaPedido 
						    INNER JOIN t_localidades Localidade1 ON Localidade1.LOC_CODIGO  = CargaPedido.LOC_CODIGO_ORIGEM
                            WHERE CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO 
                            AND AND Localidade1.LOC_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosOrigem)}))";
            }

            if (filtroPesquisa.CodigosDestinos?.Count > 0)
            {
                sql += $@" AND EXISTS ( 
                        SELECT 1                   
                        FROM t_carga_pedido CargaPedido             
                        INNER JOIN t_localidades Localidade1 ON Localidade1.LOC_CODIGO = CargaPedido.LOC_CODIGO_DESTINO            
                        WHERE CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO                         
                        AND Localidade1.LOC_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosDestinos)})) ";
            }

            if (filtroPesquisa.CodigosPaisOrigem?.Count > 0)
            {
                sql += $@" AND EXISTS (
                            SELECT 1
                            FROM t_carga_pedido CargaPedido 
						    LEFT JOIN t_localidades Localidade1 ON Localidade1.LOC_CODIGO  = CargaPedido.LOC_CODIGO_ORIGEM 
                            WHERE CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO 
                            AND Localidade1.PAI_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosPaisOrigem)})) ";
            }

            if (filtroPesquisa.CodigosTipoOperacao?.Count > 0)
                sql += $" and Carga.TOP_CODIGO in ({string.Join(", ", filtroPesquisa.CodigosTipoOperacao)}) ";

            if (filtroPesquisa.CodigosCentroResultado?.Count > 0)
            {
                sql += $@" AND EXISTS (
                            SELECT 1
                            FROM T_CARGA_PEDIDO CargaPedido
                            JOIN T_PEDIDO Pedido ON Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
                            JOIN T_CENTRO_RESULTADO CentroResultado ON CentroResultado.CRE_CODIGO = Pedido.CRE_CODIGO
                            WHERE CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO AND Pedido.CRE_CODIGO in ('{string.Join("', '", filtroPesquisa.CodigosCentroResultado)}'))";
            }


            if (!string.IsNullOrWhiteSpace(filtroPesquisa.NumeroPedido) || filtroPesquisa.NumeroNotaFiscal > 0 || filtroPesquisa.CodigoFuncionarioVendedor > 0 || filtroPesquisa.CodigosExpedidores?.Count > 0 || filtroPesquisa.CodigosFilialVenda?.Count > 0)
            {
                sql += @" AND EXISTS (
                    SELECT 1
                    FROM t_carga_pedido CargaPedido
                    JOIN t_pedido Pedido ON Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
                    LEFT JOIN t_pedido_xml_nota_fiscal PedidoNotaFiscal ON PedidoNotaFiscal.CPE_CODIGO = CargaPedido.CPE_CODIGO
                    LEFT JOIN t_xml_nota_fiscal NotaFiscal ON NotaFiscal.NFX_CODIGO = PedidoNotaFiscal.NFX_CODIGO AND NotaFiscal.NF_ATIVA = 1
                    WHERE CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO";

                if (!string.IsNullOrWhiteSpace(filtroPesquisa.NumeroPedido))
                    sql += $" and Pedido.PED_NUMERO_PEDIDO_EMBARCADOR like '%{filtroPesquisa.NumeroPedido}%' ";

                if (filtroPesquisa.NumeroNotaFiscal > 0)
                    sql += $" and NotaFiscal.nf_numero = {filtroPesquisa.NumeroNotaFiscal} ";

                if (filtroPesquisa.CodigoFuncionarioVendedor > 0)
                    sql += $" and Pedido.FUN_CODIGO_VENDEDOR = {filtroPesquisa.CodigoFuncionarioVendedor} ";

                //if (!string.IsNullOrWhiteSpace(filtroPesquisa.NumeroEXP))
                //    sql += $" and Pedido.PED_NUMERO_EXP like '%{filtroPesquisa.NumeroEXP}%' ";

                if (filtroPesquisa.CodigosExpedidores.Count > 0)
                    sql += $" and Pedido.CLI_CODIGO_EXPEDIDOR in ({string.Join(", ", filtroPesquisa.CodigosExpedidores)}) ";

                if (filtroPesquisa.CodigosFilialVenda?.Count > 0)
                    sql += $" and Pedido.FIL_CODIGO_VENDA in ({string.Join(", ", filtroPesquisa.CodigosFilialVenda)}) ";

                sql += ")";
            }

            if (filtroPesquisa.CodigosTipoOperacaoDiferenteDe?.Count > 0)
            {
                sql += @" AND EXISTS (
                    SELECT 1
                    FROM t_carga_pedido CargaPedido
                    JOIN t_pedido Pedido ON Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
                    WHERE CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO";

                sql += $" AND Pedido.TOP_CODIGO NOT IN ({string.Join(", ", filtroPesquisa.CodigosTipoOperacaoDiferenteDe)}) ";
                sql += ")";
            }

            if (!somenteContarNumeroRegistros && !string.IsNullOrWhiteSpace(propOrdenacao))
            {
                sql += $" order by {propOrdenacao} {dirOrdenacao}";

                if ((inicioRegistros > 0) || (maximoRegistros > 0))
                    sql += $" offset {inicioRegistros} rows fetch next {maximoRegistros} rows only;";
            }

            return sql;
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> ConsultarCarregamentosPendenetesIntegracao(bool retornarCargasAgrupadasCarregamento, bool naoRetornarSemData, bool retornarCargasEmCalculoFrete, bool somenteEmAguardandoNF, int codigoEmpresa, string codigoFilial, string codigoRegiao)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var result = from obj in query select obj;

            if (retornarCargasAgrupadasCarregamento)
            {
                if (!retornarCargasEmCalculoFrete)
                    result = result.Where(p => !p.CarregamentoIntegradoERP && p.CargaFechada
                                            && (p.TipoOperacao.RetornarCarregamentoPendenteAposEtapaCTE ? p.SituacaoCarga == SituacaoCarga.AgIntegracao || p.SituacaoCarga == SituacaoCarga.EmTransporte || p.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos || p.SituacaoCarga == SituacaoCarga.Encerrada
                                                : ((p.CargaAgrupada && (p.SituacaoCarga == SituacaoCarga.AgNFe || p.SituacaoCarga == SituacaoCarga.EmTransporte || p.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos))
                                                  || (p.CargaFechada && p.SituacaoCarga == SituacaoCarga.AgNFe)))
                                            && p.Carregamento.SituacaoCarregamento == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarregamento.Fechado);
                else
                    result = result.Where(p => !p.CarregamentoIntegradoERP && p.CargaFechada
                                            && (p.SituacaoCarga == SituacaoCarga.AgNFe || p.SituacaoCarga == SituacaoCarga.CalculoFrete)
                                            && p.Carregamento.SituacaoCarregamento == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarregamento.Fechado);
            }
            else
            {
                if (!naoRetornarSemData)
                {
                    if (!retornarCargasEmCalculoFrete)
                        result = result.Where(p =>
                               !p.CarregamentoIntegradoERP &&
                               !p.CargaAgrupada &&
                               (
                                (p.IdentificadorDeRota != null && p.IdentificadorDeRota != "") ||
                                (p.Carregamento.SituacaoCarregamento == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarregamento.Fechado)
                               ) &&
                               (p.TipoOperacao.RetornarCarregamentoPendenteAposEtapaCTE
                                    ? p.SituacaoCarga == SituacaoCarga.AgIntegracao ||
                                      p.SituacaoCarga == SituacaoCarga.EmTransporte ||
                                      p.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos ||
                                      p.SituacaoCarga == SituacaoCarga.Encerrada
                                    : p.SituacaoCarga == SituacaoCarga.AgNFe ||
                                      p.SituacaoCarga == SituacaoCarga.CalculoFrete ||
                                      p.SituacaoCarga == SituacaoCarga.Nova ||
                                      p.SituacaoCarga == SituacaoCarga.AgTransportador ||
                                      p.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos)
                         );
                    else
                        result = result.Where(p => !p.CarregamentoIntegradoERP
                            && !p.CargaAgrupada
                            && p.Carregamento.SituacaoCarregamento == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarregamento.Fechado
                            && (p.SituacaoCarga == SituacaoCarga.AgNFe || p.SituacaoCarga == SituacaoCarga.CalculoFrete || p.SituacaoCarga == SituacaoCarga.Nova || p.SituacaoCarga == SituacaoCarga.AgTransportador));
                }
                else
                {
                    if (!retornarCargasEmCalculoFrete)
                        result = result.Where(p => !p.CarregamentoIntegradoERP
                                         && !p.CargaAgrupada
                                         && p.Carregamento.SituacaoCarregamento == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarregamento.Fechado
                                         && (p.TipoOperacao.RetornarCarregamentoPendenteAposEtapaCTE ? p.SituacaoCarga == SituacaoCarga.AgIntegracao || p.SituacaoCarga == SituacaoCarga.EmTransporte || p.SituacaoCarga == SituacaoCarga.AgImpressaoDocumentos || p.SituacaoCarga == SituacaoCarga.Encerrada
                                             : (p.SituacaoCarga == SituacaoCarga.AgNFe || (p.SituacaoCarga == SituacaoCarga.Nova && p.Empresa != null))));
                    else
                        result = result.Where(p => !p.CarregamentoIntegradoERP
                                    && !p.CargaAgrupada
                                    && p.Carregamento.SituacaoCarregamento == Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoCarregamento.Fechado
                                    && (p.SituacaoCarga == SituacaoCarga.AgNFe || p.SituacaoCarga == SituacaoCarga.CalculoFrete));
                }
            }

            if (naoRetornarSemData)
                result = result.Where(obj => obj.DataCarregamentoCarga.HasValue && obj.Empresa != null);

            if (somenteEmAguardandoNF)
                result = result.Where(obj => obj.SituacaoCarga == SituacaoCarga.AgNFe);

            if (codigoEmpresa > 0)
                result = result.Where(obj => obj.Empresa.Codigo == codigoEmpresa);

            if (!string.IsNullOrWhiteSpace(codigoFilial))
                result = result.Where(obj => obj.Filial.CodigoFilialEmbarcador == codigoFilial);

            if (!string.IsNullOrWhiteSpace(codigoRegiao))
                result = result.Where(x => x.Pedidos.Any(p => p.Pedido.RegiaoDestino.CodigoIntegracao == codigoRegiao));

            return result;
        }


        #endregion Métodos Privados

        #region Métodos Privados - Relatórios

        private string ObterSelectConsultaRelatorioTaxaIncidenciaFrete(bool count, List<PropriedadeAgrupamento> agrupamentos, DateTime dataInicial, DateTime dataFinal, int codigoTransportador, List<int> codigosFilial, List<double> codigosRecebedores, int codigoCentroCarregamento, int codigoRota, int codigoDestino, List<int> codigosTipoCarga, int codigoModeloVeiculo, double cpfCnpjDestinatario, List<int> codigosTipoOperacao, string propAgrupa, string dirAgrupa, string propOrdena, string dirOrdena, int inicio, int limite)
        {
            string select = string.Empty,
                   groupBy = string.Empty,
                   joins = string.Empty,
                   where = string.Empty,
                   orderBy = string.Empty;

            for (var i = agrupamentos.Count - 1; i >= 0; i--)
                SetarSelectRelatorioTaxaIncidenciaFrete(agrupamentos[i].Propriedade, ref select, ref groupBy, ref joins, count);

            SetarWhereRelatorioTaxaIncidenciaFrete(ref where, ref joins, dataInicial, dataFinal, codigoTransportador, codigosFilial, codigoCentroCarregamento, codigoRota, codigoDestino, codigosTipoCarga, codigoModeloVeiculo, cpfCnpjDestinatario, codigosTipoOperacao);

            if (!count)
            {
                if (!string.IsNullOrWhiteSpace(propAgrupa))
                {
                    SetarSelectRelatorioTaxaIncidenciaFrete(propAgrupa, ref select, ref groupBy, ref joins, count);

                    if (select.Contains(propAgrupa))
                        orderBy = propAgrupa + " " + dirAgrupa;
                }

                if (!string.IsNullOrWhiteSpace(propOrdena))
                {
                    if (propOrdena != propAgrupa && select.Contains(propOrdena))
                        orderBy += (orderBy.Length > 0 ? ", " : string.Empty) + propOrdena + " " + dirOrdena;
                }
            }

            return (count ? "SELECT DISTINCT(COUNT(0) OVER ())" : "SELECT " + (select.Length > 0 ? select.Substring(0, select.Length - 2) : string.Empty)) +
                   " FROM T_CARGA car LEFT OUTER JOIN T_CARGA_JANELA_CARREGAMENTO cjc ON car.CAR_CODIGO = cjc.CAR_CODIGO " + joins +
                   " WHERE car.CAR_SITUACAO IN(9,10,11)" + where +
                   " GROUP BY car.CAR_CODIGO " + (groupBy.Length > 0 ? ", " + groupBy.Substring(0, groupBy.Length - 2) : string.Empty) +
                   (count ? string.Empty : (orderBy.Length > 0 ? " ORDER BY " + orderBy : " ORDER BY 1 ASC ")) +
                   (count || (inicio <= 0 && limite <= 0) ? "" : " OFFSET " + inicio.ToString() + " ROWS FETCH NEXT " + limite.ToString() + " ROWS ONLY;");
        }

        private void SetarWhereRelatorioTaxaIncidenciaFrete(ref string where, ref string joins, DateTime dataInicial, DateTime dataFinal, int codigoTransportador, List<int> codigosFilial, int codigoCentroCarregamento, int codigoRota, int codigoDestino, List<int> codigosTipoCarga, int codigoModeloVeiculo, double cpfCnpjDestinatario, List<int> codigosTipoOperacao)
        {
            string pattern = "yyyy-MM-dd";

            if (codigoCentroCarregamento > 0)
                where += " and cjc.CEC_CODIGO = " + codigoCentroCarregamento.ToString();

            if (codigosFilial?.Count > 0)
                where += $" and car.FIL_CODIGO in ({string.Join(", ", codigosFilial)})";

            if (codigoTransportador > 0)
                where += " and car.EMP_CODIGO = " + codigoTransportador.ToString();

            if (codigoRota > 0)
                where += " and car.ROF_CODIGO = " + codigoRota.ToString();

            if (codigosTipoCarga?.Count > 0)
                where += $" and (car.TCG_CODIGO in ({string.Join(", ", codigosTipoCarga)}){(codigosTipoCarga.Contains(-1) ? " or car.TCG_CODIGO is null" : "")})";

            if (codigosTipoOperacao?.Count > 0)
                where += $" and (car.TOP_CODIGO in ({string.Join(", ", codigosTipoOperacao)}){(codigosTipoOperacao.Contains(-1) ? " or car.TOP_CODIGO is null" : "")})";

            if (codigoModeloVeiculo > 0)
                where += " and car.MVC_CODIGO = " + codigoModeloVeiculo.ToString();

            if (cpfCnpjDestinatario > 0f)
            {
                where += " and ped.CLI_CODIGO = " + cpfCnpjDestinatario.ToString("F0");

                if (!joins.Contains("T_CARGA_PEDIDO cpe"))
                    joins += "LEFT OUTER JOIN T_CARGA_PEDIDO cpe ON cpe.CAR_CODIGO = car.CAR_CODIGO ";

                if (!joins.Contains("T_PEDIDO ped"))
                    joins += "LEFT OUTER JOIN T_PEDIDO ped ON ped.PED_CODIGO = cpe.PED_CODIGO ";
            }

            if (codigoDestino > 0)
            {
                where += " and cpe.LOC_CODIGO_DESTINO = " + codigoDestino.ToString();

                if (!joins.Contains("T_CARGA_PEDIDO cpe"))
                    joins += "LEFT OUTER JOIN T_CARGA_PEDIDO cpe ON cpe.CAR_CODIGO = car.CAR_CODIGO ";

                if (!joins.Contains("T_PEDIDO ped"))
                    joins += "LEFT OUTER JOIN T_PEDIDO ped ON ped.PED_CODIGO = cpe.PED_CODIGO ";
            }

            if (dataInicial != DateTime.MinValue)
                where += " and CAST(cjc.CJC_INICIO_CARREGAMENTO AS DATE) >= '" + dataInicial.ToString(pattern) + "'";

            if (dataFinal != DateTime.MinValue)
                where += " and CAST(cjc.CJC_INICIO_CARREGAMENTO AS DATE) <= '" + dataFinal.ToString(pattern) + "'";
        }

        private void SetarSelectRelatorioTaxaIncidenciaFrete(string propriedade, ref string select, ref string groupBy, ref string joins, bool count)
        {
            switch (propriedade)
            {
                case "NumeroCarga":
                    if (!select.Contains("NumeroCarga"))
                    {
                        select += "car.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga, ";
                        groupBy += "car.CAR_CODIGO_CARGA_EMBARCADOR, ";
                    }
                    break;
                case "DataCarregamento":
                    if (!select.Contains("DataCarregamento"))
                    {
                        select += "cjc.CJC_INICIO_CARREGAMENTO DataCarregamento, ";

                        if (!groupBy.Contains("cjc.CJC_INICIO_CARREGAMENTO"))
                            groupBy += "cjc.CJC_INICIO_CARREGAMENTO, ";
                    }
                    break;
                case "Transportador":
                    if (!select.Contains("Transportador"))
                    {
                        select += "emp.EMP_RAZAO Transportador, ";
                        groupBy += "emp.EMP_RAZAO, ";

                        if (!joins.Contains("T_EMPRESA emp"))
                            joins += "LEFT OUTER JOIN T_EMPRESA emp ON emp.EMP_CODIGO = car.EMP_CODIGO ";
                    }
                    break;
                case "ValorTotalNotaFiscal":
                    if (!select.Contains("ValorTotalNotaFiscal"))
                    {
                        select += "SUM(nfx.NF_VALOR) ValorTotalNotaFiscal, ";

                        if (!joins.Contains("T_CARGA_PEDIDO cpe"))
                            joins += "LEFT OUTER JOIN T_CARGA_PEDIDO cpe ON cpe.CAR_CODIGO = car.CAR_CODIGO ";

                        if (!joins.Contains("T_PEDIDO ped"))
                            joins += "LEFT OUTER JOIN T_PEDIDO ped ON ped.PED_CODIGO = cpe.PED_CODIGO ";

                        if (!joins.Contains("T_PEDIDO_XML_NOTA_FISCAL pex"))
                            joins += "LEFT OUTER JOIN T_PEDIDO_XML_NOTA_FISCAL pex ON pex.CPE_CODIGO = cpe.CPE_CODIGO ";

                        if (!joins.Contains("T_XML_NOTA_FISCAL nfx"))
                            joins += "LEFT OUTER JOIN T_XML_NOTA_FISCAL nfx ON nfx.NFX_CODIGO = pex.NFX_CODIGO ";
                    }
                    break;
                case "ValorFrete":
                    if (!select.Contains("ValorFrete"))
                    {
                        select += "(car.CAR_VALOR_FRETE_PAGAR + car.CAR_VALOR_ICMS) ValorFrete, ";

                        if (!groupBy.Contains("car.CAR_VALOR_FRETE_PAGAR"))
                            groupBy += "car.CAR_VALOR_FRETE_PAGAR, ";

                        if (!groupBy.Contains("car.CAR_VALOR_ICMS"))
                            groupBy += "car.CAR_VALOR_ICMS, ";
                    }
                    break;
                case "TaxaIncidencia":
                    if (!select.Contains("TaxaIncidencia"))
                    {
                        select += "((100 * (car.CAR_VALOR_FRETE_PAGAR + car.CAR_VALOR_ICMS)) / (CASE ISNULL(SUM(nfx.NF_VALOR), 1) WHEN 0 THEN 1 ELSE SUM(nfx.NF_VALOR) END)) TaxaIncidencia, ";

                        if (!groupBy.Contains("car.CAR_VALOR_FRETE_PAGAR"))
                            groupBy += "car.CAR_VALOR_FRETE_PAGAR, ";

                        if (!groupBy.Contains("car.CAR_VALOR_ICMS"))
                            groupBy += "car.CAR_VALOR_ICMS, ";

                        if (!joins.Contains("T_CARGA_PEDIDO cpe"))
                            joins += "LEFT OUTER JOIN T_CARGA_PEDIDO cpe ON cpe.CAR_CODIGO = car.CAR_CODIGO ";

                        if (!joins.Contains("T_PEDIDO_XML_NOTA_FISCAL pex"))
                            joins += "LEFT OUTER JOIN T_PEDIDO_XML_NOTA_FISCAL pex ON pex.CPE_CODIGO = cpe.CPE_CODIGO ";

                        if (!joins.Contains("T_XML_NOTA_FISCAL nfx"))
                            joins += "LEFT OUTER JOIN T_XML_NOTA_FISCAL nfx ON nfx.NFX_CODIGO = pex.NFX_CODIGO ";
                    }
                    break;
                case "TaxaOcupacao":
                    if (!select.Contains("TaxaOcupacao"))
                    {
                        select += "((ISNULL(SUM(nfx.NF_PESO), 0) * 100) / ISNULL(NULLIF(mve.MVC_CAPACIDADE_PESO_TRANSPORTE, 0), 1)) TaxaOcupacao, ";

                        if (!groupBy.Contains("mve.MVC_CAPACIDADE_PESO_TRANSPORTE"))
                            groupBy += "mve.MVC_CAPACIDADE_PESO_TRANSPORTE, ";

                        if (!joins.Contains("T_MODELO_VEICULAR_CARGA mve"))
                            joins += "LEFT OUTER JOIN T_MODELO_VEICULAR_CARGA mve ON mve.MVC_CODIGO = car.MVC_CODIGO ";

                        if (!joins.Contains("T_CARGA_PEDIDO cpe"))
                            joins += "LEFT OUTER JOIN T_CARGA_PEDIDO cpe ON cpe.CAR_CODIGO = car.CAR_CODIGO ";

                        if (!joins.Contains("T_PEDIDO_XML_NOTA_FISCAL pex"))
                            joins += "LEFT OUTER JOIN T_PEDIDO_XML_NOTA_FISCAL pex ON pex.CPE_CODIGO = cpe.CPE_CODIGO ";

                        if (!joins.Contains("T_XML_NOTA_FISCAL nfx"))
                            joins += "LEFT OUTER JOIN T_XML_NOTA_FISCAL nfx ON nfx.NFX_CODIGO = pex.NFX_CODIGO ";
                    }
                    break;
                case "CapacidadePesoVeiculo":
                    if (!select.Contains("CapacidadePesoVeiculo"))
                    {
                        select += "ISNULL(NULLIF(mve.MVC_CAPACIDADE_PESO_TRANSPORTE, 0), 1) CapacidadePesoVeiculo, ";

                        if (!groupBy.Contains("mve.MVC_CAPACIDADE_PESO_TRANSPORTE"))
                            groupBy += "mve.MVC_CAPACIDADE_PESO_TRANSPORTE, ";

                        if (!joins.Contains("T_MODELO_VEICULAR_CARGA mve"))
                            joins += "LEFT OUTER JOIN T_MODELO_VEICULAR_CARGA mve ON mve.MVC_CODIGO = car.MVC_CODIGO ";
                    }
                    break;
                case "PesoCarga":
                    if (!select.Contains("PesoCarga"))
                    {
                        select += "ISNULL(SUM(nfx.NF_PESO), 0) PesoCarga, ";

                        if (!joins.Contains("T_CARGA_PEDIDO cpe"))
                            joins += "LEFT OUTER JOIN T_CARGA_PEDIDO cpe ON cpe.CAR_CODIGO = car.CAR_CODIGO ";

                        if (!joins.Contains("T_PEDIDO_XML_NOTA_FISCAL pex"))
                            joins += "LEFT OUTER JOIN T_PEDIDO_XML_NOTA_FISCAL pex ON pex.CPE_CODIGO = cpe.CPE_CODIGO ";

                        if (!joins.Contains("T_XML_NOTA_FISCAL nfx"))
                            joins += "LEFT OUTER JOIN T_XML_NOTA_FISCAL nfx ON nfx.NFX_CODIGO = pex.NFX_CODIGO ";
                    }
                    break;
                case "NumeroPedido":
                    if (!select.Contains("NumeroPedido"))
                    {
                        select += "SUBSTRING((SELECT ', ' + pedido1.PED_NUMERO_PEDIDO_EMBARCADOR FROM T_CARGA_PEDIDO cargaPedido1 INNER JOIN T_PEDIDO pedido1 ON pedido1.PED_CODIGO = cargaPedido1.PED_CODIGO WHERE cargaPedido1.CAR_CODIGO = car.CAR_CODIGO FOR XML PATH('')), 3, 1000) NumeroPedido, ";
                    }
                    break;
                case "Veiculos":
                    if (!select.Contains("Veiculos"))
                    {
                        select += "(vei.VEI_PLACA + ISNULL((SELECT ', ' + veiculo1.VEI_PLACA FROM T_CARGA_VEICULOS_VINCULADOS veiculoVinculadoCarga1 INNER JOIN T_VEICULO veiculo1 ON veiculoVinculadoCarga1.VEI_CODIGO = veiculo1.VEI_CODIGO WHERE veiculoVinculadoCarga1.CAR_CODIGO = car.CAR_CODIGO FOR XML PATH('')), '')) Veiculos, ";
                        groupBy += "vei.VEI_PLACA, ";

                        if (!joins.Contains("T_VEICULO vei"))
                            joins += "LEFT OUTER JOIN T_VEICULO vei ON car.CAR_VEICULO = vei.VEI_CODIGO ";
                    }
                    break;
                case "Destinatario":
                    if (!select.Contains("Destinatario"))
                    {
                        select += "cds.CDS_DESTINATARIOS Destinatario, ";
                        groupBy += "cds.CDS_DESTINATARIOS, ";

                        if (!joins.Contains("T_CARGA_DADOS_SUMARIZADOS cds"))
                            joins += "LEFT OUTER JOIN T_CARGA_DADOS_SUMARIZADOS cds ON cds.CDS_CODIGO = car.CDS_CODIGO ";
                    }
                    break;
                case "Destino":
                    if (!select.Contains("Destino"))
                    {
                        select += "cds.CDS_DESTINOS Destino, ";
                        groupBy += "cds.CDS_DESTINOS, ";

                        if (!joins.Contains("T_CARGA_DADOS_SUMARIZADOS cds"))
                            joins += "LEFT OUTER JOIN T_CARGA_DADOS_SUMARIZADOS cds ON cds.CDS_CODIGO = car.CDS_CODIGO ";
                    }
                    break;
                case "Remetente":
                    if (!select.Contains("Remetente"))
                    {
                        select += "cds.CDS_REMETENTES Remetente, ";
                        groupBy += "cds.CDS_REMETENTES, ";

                        if (!joins.Contains("T_CARGA_DADOS_SUMARIZADOS cds"))
                            joins += "LEFT OUTER JOIN T_CARGA_DADOS_SUMARIZADOS cds ON cds.CDS_CODIGO = car.CDS_CODIGO ";
                    }
                    break;
                case "Origem":
                    if (!select.Contains("Origem"))
                    {
                        select += "cds.CDS_ORIGENS Origem, ";
                        groupBy += "cds.CDS_ORIGENS, ";

                        if (!joins.Contains("T_CARGA_DADOS_SUMARIZADOS cds"))
                            joins += "LEFT OUTER JOIN T_CARGA_DADOS_SUMARIZADOS cds ON cds.CDS_CODIGO = car.CDS_CODIGO ";
                    }
                    break;
                case "NumeroColetas":
                    if (!select.Contains("NumeroColetas"))
                    {
                        select += "cds.CDS_NUMERO_COLETAS NumeroColetas, ";
                        groupBy += "cds.CDS_NUMERO_COLETAS, ";

                        if (!joins.Contains("T_CARGA_DADOS_SUMARIZADOS cds"))
                            joins += "LEFT OUTER JOIN T_CARGA_DADOS_SUMARIZADOS cds ON cds.CDS_CODIGO = car.CDS_CODIGO ";
                    }
                    break;
                case "NumeroEntregas":
                    if (!select.Contains("NumeroEntregas"))
                    {
                        select += "cds.CDS_NUMERO_ENTREGAS NumeroEntregas, ";
                        groupBy += "cds.CDS_NUMERO_ENTREGAS, ";

                        if (!joins.Contains("T_CARGA_DADOS_SUMARIZADOS cds"))
                            joins += "LEFT OUTER JOIN T_CARGA_DADOS_SUMARIZADOS cds ON cds.CDS_CODIGO = car.CDS_CODIGO ";
                    }
                    break;
                case "ModeloVeiculo":
                    if (!select.Contains("ModeloVeiculo"))
                    {
                        select += "mvc.MVC_DESCRICAO ModeloVeiculo, ";
                        groupBy += "mvc.MVC_DESCRICAO, ";

                        if (!joins.Contains("T_MODELO_VEICULAR_CARGA mvc"))
                            joins += "LEFT OUTER JOIN T_MODELO_VEICULAR_CARGA mvc ON mvc.MVC_CODIGO = car.MVC_CODIGO ";
                    }
                    break;
                case "TipoCarga":
                    if (!select.Contains("TipoCarga"))
                    {
                        select += "tcg.TCG_DESCRICAO TipoCarga, ";
                        groupBy += "tcg.TCG_DESCRICAO, ";

                        if (!joins.Contains("T_TIPO_DE_CARGA tcg"))
                            joins += "LEFT OUTER JOIN T_TIPO_DE_CARGA tcg ON tcg.TCG_CODIGO = car.TCG_CODIGO ";
                    }
                    break;
                default:
                    break;
            }
        }

        private string ObterSelectConsultaRelatorioTaxaOcupacaoVeiculo(bool count, Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaRelatorioTaxaOcupacaoVeiculo filtrosPesquisa, List<PropriedadeAgrupamento> propriedadesAgrupamento, Dominio.ObjetosDeValor.Embarcador.Consulta.ParametroConsulta parametrosConsulta)
        {
            string select = string.Empty,
                   groupBy = string.Empty,
                   joins = string.Empty,
                   where = string.Empty,
                   orderBy = string.Empty;

            for (var i = propriedadesAgrupamento.Count - 1; i >= 0; i--)
                SetarSelectRelatorioTaxaOcupacaoVeiculo(propriedadesAgrupamento[i].Propriedade, ref select, ref groupBy, ref joins, count);

            SetarWhereRelatorioTaxaOcupacaoVeiculo(ref where, ref joins, filtrosPesquisa);

            if (!count)
            {
                if (!string.IsNullOrWhiteSpace(parametrosConsulta.PropriedadeAgrupar))
                {
                    SetarSelectRelatorioTaxaOcupacaoVeiculo(parametrosConsulta.PropriedadeAgrupar, ref select, ref groupBy, ref joins, count);

                    if (select.Contains(parametrosConsulta.PropriedadeAgrupar) && !string.IsNullOrWhiteSpace(parametrosConsulta.PropriedadeAgrupar))
                        orderBy = parametrosConsulta.PropriedadeAgrupar + " " + parametrosConsulta.DirecaoAgrupar;
                }

                if (!string.IsNullOrWhiteSpace(parametrosConsulta.PropriedadeOrdenar))
                {
                    if (parametrosConsulta.PropriedadeOrdenar != parametrosConsulta.PropriedadeAgrupar && select.Contains(parametrosConsulta.PropriedadeOrdenar))
                        orderBy += (orderBy.Length > 0 ? ", " : string.Empty) + parametrosConsulta.PropriedadeOrdenar + " " + parametrosConsulta.DirecaoOrdenar;
                }
            }

            return (count ? "SELECT DISTINCT(COUNT(0) OVER ())" : "SELECT " + (select.Length > 0 ? select.Substring(0, select.Length - 2) : string.Empty)) +
                   " FROM T_CARGA car LEFT OUTER JOIN T_CARGA_JANELA_CARREGAMENTO cjc ON car.CAR_CODIGO = cjc.CAR_CODIGO " + joins +
                   " WHERE car.CAR_SITUACAO IN(9,10,11)" + where +
                   " GROUP BY car.CAR_CODIGO " + (groupBy.Length > 0 ? ", " + groupBy.Substring(0, groupBy.Length - 2) : string.Empty) +
                   (count ? string.Empty : (orderBy.Length > 0 ? " ORDER BY " + orderBy : " ORDER BY 1 ASC ")) +
                   (count || (parametrosConsulta.InicioRegistros <= 0 && parametrosConsulta.LimiteRegistros <= 0) ? "" : " OFFSET " + parametrosConsulta.InicioRegistros.ToString() + " ROWS FETCH NEXT " + parametrosConsulta.LimiteRegistros.ToString() + " ROWS ONLY;");
        }

        private void SetarWhereRelatorioTaxaOcupacaoVeiculo(ref string where, ref string joins, Dominio.ObjetosDeValor.Embarcador.Carga.FiltroPesquisaRelatorioTaxaOcupacaoVeiculo filtrosPesquisa)
        {
            string pattern = "yyyy-MM-dd";

            if (filtrosPesquisa.CodigoCentroCarregamento > 0)
                where += " and cjc.CEC_CODIGO = " + filtrosPesquisa.CodigoCentroCarregamento.ToString();

            if (filtrosPesquisa.CodigosFilial?.Count > 0)
            {
                where += $@" and (car.FIL_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosFilial)}) ";
                if (filtrosPesquisa.CodigosRecebedores.Count > 0)
                {
                    where += $@"OR EXISTS (   SELECT _cargaPedidoRecebedor.CAR_CODIGO 
                                                                                                                       FROM T_CARGA_PEDIDO _cargaPedidoRecebedor
                                                                                                                       LEFT JOIN T_PEDIDO _pedido ON _pedido.PED_CODIGO = _cargaPedidoRecebedor.PED_CODIGO
                                                                                                                       WHERE car.CAR_CODIGO = _cargaPedidoRecebedor.CAR_CODIGO
                                                                                                                       AND _pedido.CLI_CODIGO_RECEBEDOR IN({string.Join(",", filtrosPesquisa.CodigosRecebedores)}))";
                }
                where += ")";
            }


            if (filtrosPesquisa.CodigoTransportador > 0)
                where += " and car.EMP_CODIGO = " + filtrosPesquisa.CodigoTransportador.ToString();

            if (filtrosPesquisa.CodigoRota > 0)
                where += " and car.ROF_CODIGO = " + filtrosPesquisa.CodigoRota.ToString();

            if (filtrosPesquisa.CodigosTipoCarga?.Count > 0)
                where += $" and (car.TCG_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosTipoCarga)}){(filtrosPesquisa.CodigosTipoCarga.Contains(-1) ? " or car.TCG_CODIGO is null" : "")})";

            if (filtrosPesquisa.CodigosTipoOperacao?.Count > 0)
                where += $" and (car.TOP_CODIGO in ({string.Join(", ", filtrosPesquisa.CodigosTipoOperacao)}){(filtrosPesquisa.CodigosTipoOperacao.Contains(-1) ? " or car.TOP_CODIGO is null" : "")})";

            if (filtrosPesquisa.CodigoModeloVeiculo > 0)
                where += " and car.MVC_CODIGO = " + filtrosPesquisa.CodigoModeloVeiculo.ToString();

            if (filtrosPesquisa.CpfCnpjDestinatario > 0f)
            {
                where += " and ped.CLI_CODIGO = " + filtrosPesquisa.CpfCnpjDestinatario.ToString("F0");

                if (!joins.Contains("T_CARGA_PEDIDO cpe"))
                    joins += "LEFT OUTER JOIN T_CARGA_PEDIDO cpe ON cpe.CAR_CODIGO = car.CAR_CODIGO ";

                if (!joins.Contains("T_PEDIDO ped"))
                    joins += "LEFT OUTER JOIN T_PEDIDO ped ON ped.PED_CODIGO = cpe.PED_CODIGO ";
            }

            if (filtrosPesquisa.CodigoDestino > 0)
            {
                where += " and cpe.LOC_CODIGO_DESTINO = " + filtrosPesquisa.CodigoDestino.ToString();

                if (!joins.Contains("T_CARGA_PEDIDO cpe"))
                    joins += "LEFT OUTER JOIN T_CARGA_PEDIDO cpe ON cpe.CAR_CODIGO = car.CAR_CODIGO ";

                if (!joins.Contains("T_PEDIDO ped"))
                    joins += "LEFT OUTER JOIN T_PEDIDO ped ON ped.PED_CODIGO = cpe.PED_CODIGO ";
            }

            if (filtrosPesquisa.DataJanelaCarregamentoInicial != DateTime.MinValue)
                where += " and CAST(cjc.CJC_INICIO_CARREGAMENTO AS DATE) >= '" + filtrosPesquisa.DataJanelaCarregamentoInicial.ToString(pattern) + "'";

            if (filtrosPesquisa.DataJanelaCarregamentoFinal != DateTime.MinValue)
                where += " and CAST(cjc.CJC_INICIO_CARREGAMENTO AS DATE) <= '" + filtrosPesquisa.DataJanelaCarregamentoFinal.ToString(pattern) + "'";

            if (filtrosPesquisa.DataCriacaoInicial != DateTime.MinValue)
                where += " and CAST(car.CAR_DATA_CRIACAO AS DATE) >= '" + filtrosPesquisa.DataCriacaoInicial.ToString(pattern) + "'";

            if (filtrosPesquisa.DataCriacaoFinal != DateTime.MinValue)
                where += " and CAST(car.CAR_DATA_CRIACAO AS DATE) <= '" + filtrosPesquisa.DataCriacaoFinal.ToString(pattern) + "'";

        }

        private void SetarSelectRelatorioTaxaOcupacaoVeiculo(string propriedade, ref string select, ref string groupBy, ref string joins, bool count)
        {
            switch (propriedade)
            {
                case "NumeroCarga":
                    if (!select.Contains("NumeroCarga"))
                    {
                        select += "car.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga, ";
                        groupBy += "car.CAR_CODIGO_CARGA_EMBARCADOR, ";
                    }
                    break;
                case "DataCarregamento":
                    if (!select.Contains("DataCarregamento"))
                    {
                        select += "cjc.CJC_INICIO_CARREGAMENTO DataCarregamento, ";

                        if (!groupBy.Contains("cjc.CJC_INICIO_CARREGAMENTO"))
                            groupBy += "cjc.CJC_INICIO_CARREGAMENTO, ";
                    }
                    break;
                case "DataCriacao":
                    if (!select.Contains("DataCriacao"))
                    {
                        select += "car.CAR_DATA_CRIACAO DataCriacao, ";

                        if (!groupBy.Contains("car.CAR_DATA_CRIACAO"))
                            groupBy += "car.CAR_DATA_CRIACAO, ";
                    }
                    break;
                case "Transportador":
                    if (!select.Contains("Transportador"))
                    {
                        select += "emp.EMP_RAZAO Transportador, ";
                        groupBy += "emp.EMP_RAZAO, ";

                        if (!joins.Contains("T_EMPRESA emp"))
                            joins += "LEFT OUTER JOIN T_EMPRESA emp ON emp.EMP_CODIGO = car.EMP_CODIGO ";
                    }
                    break;
                case "CapacidadePesoVeiculo":
                    if (!select.Contains("CapacidadePesoVeiculo"))
                    {
                        select += "ISNULL(NULLIF(mve.MVC_CAPACIDADE_PESO_TRANSPORTE, 0), 1) CapacidadePesoVeiculo, ";

                        if (!groupBy.Contains("mve.MVC_CAPACIDADE_PESO_TRANSPORTE"))
                            groupBy += "mve.MVC_CAPACIDADE_PESO_TRANSPORTE, ";

                        if (!joins.Contains("T_MODELO_VEICULAR_CARGA mve"))
                            joins += "LEFT OUTER JOIN T_MODELO_VEICULAR_CARGA mve ON mve.MVC_CODIGO = car.MVC_CODIGO ";
                    }
                    break;
                case "PesoCarga":
                    if (!select.Contains("PesoCarga"))
                    {
                        select += @"CASE 
                                        WHEN mve.MVC_UNIDADE_CAPACIDADE = 2 THEN ISNULL((SELECT SUM(cpp.CPP_QUANTIDADE) FROM T_CARGA_PEDIDO_PRODUTO cpp 
                                                                                            JOIN T_CARGA_PEDIDO cpe ON cpp.CPE_CODIGO = cpe.CPE_CODIGO
                                                                                            WHERE cpe.CAR_CODIGO = car.CAR_CODIGO), 0)
		                                ELSE ISNULL(SUM(nfx.NF_PESO), 0)
	                                END PesoCarga, ";

                        if (!groupBy.Contains("mve.MVC_UNIDADE_CAPACIDADE"))
                            groupBy += "mve.MVC_UNIDADE_CAPACIDADE, ";

                        if (!groupBy.Contains("mve.MVC_CAPACIDADE_PESO_TRANSPORTE"))
                            groupBy += "mve.MVC_CAPACIDADE_PESO_TRANSPORTE, ";

                        if (!joins.Contains("T_CARGA_PEDIDO cpe"))
                            joins += "LEFT OUTER JOIN T_CARGA_PEDIDO cpe ON cpe.CAR_CODIGO = car.CAR_CODIGO ";

                        if (!joins.Contains("T_PEDIDO_XML_NOTA_FISCAL pex"))
                            joins += "LEFT OUTER JOIN T_PEDIDO_XML_NOTA_FISCAL pex ON pex.CPE_CODIGO = cpe.CPE_CODIGO ";

                        if (!joins.Contains("T_XML_NOTA_FISCAL nfx"))
                            joins += "LEFT OUTER JOIN T_XML_NOTA_FISCAL nfx ON nfx.NFX_CODIGO = pex.NFX_CODIGO ";
                    }
                    break;
                case "TaxaOcupacao":
                    if (!select.Contains("TaxaOcupacao"))
                    {
                        select += @"CASE 
		                                WHEN mve.MVC_UNIDADE_CAPACIDADE = 2 THEN ((ISNULL((SELECT SUM(cpp.CPP_QUANTIDADE) FROM T_CARGA_PEDIDO_PRODUTO cpp 
                                                                                            JOIN T_CARGA_PEDIDO cpe ON cpp.CPE_CODIGO = cpe.CPE_CODIGO
                                                                                            WHERE cpe.CAR_CODIGO = car.CAR_CODIGO), 0) * 100) / ISNULL(NULLIF(mve.MVC_CAPACIDADE_PESO_TRANSPORTE, 0), 1))
		                                ELSE ((ISNULL(SUM(nfx.NF_PESO), 0) * 100) / ISNULL(NULLIF(mve.MVC_CAPACIDADE_PESO_TRANSPORTE, 0), 1))
	                                END TaxaOcupacao, ";

                        if (!groupBy.Contains("mve.MVC_UNIDADE_CAPACIDADE"))
                            groupBy += "mve.MVC_UNIDADE_CAPACIDADE, ";

                        if (!groupBy.Contains("mve.MVC_CAPACIDADE_PESO_TRANSPORTE"))
                            groupBy += "mve.MVC_CAPACIDADE_PESO_TRANSPORTE, ";

                        if (!joins.Contains("T_MODELO_VEICULAR_CARGA mve"))
                            joins += "LEFT OUTER JOIN T_MODELO_VEICULAR_CARGA mve ON mve.MVC_CODIGO = car.MVC_CODIGO ";

                        if (!joins.Contains("T_CARGA_PEDIDO cpe"))
                            joins += "LEFT OUTER JOIN T_CARGA_PEDIDO cpe ON cpe.CAR_CODIGO = car.CAR_CODIGO ";

                        if (!joins.Contains("T_PEDIDO_XML_NOTA_FISCAL pex"))
                            joins += "LEFT OUTER JOIN T_PEDIDO_XML_NOTA_FISCAL pex ON pex.CPE_CODIGO = cpe.CPE_CODIGO ";

                        if (!joins.Contains("T_XML_NOTA_FISCAL nfx"))
                            joins += "LEFT OUTER JOIN T_XML_NOTA_FISCAL nfx ON nfx.NFX_CODIGO = pex.NFX_CODIGO ";
                    }
                    break;
                case "NumeroPedido":
                    if (!select.Contains("NumeroPedido"))
                    {
                        select += "SUBSTRING((SELECT ', ' + pedido1.PED_NUMERO_PEDIDO_EMBARCADOR FROM T_CARGA_PEDIDO cargaPedido1 INNER JOIN T_PEDIDO pedido1 ON pedido1.PED_CODIGO = cargaPedido1.PED_CODIGO WHERE cargaPedido1.CAR_CODIGO = car.CAR_CODIGO FOR XML PATH('')), 3, 1000) NumeroPedido, ";
                    }
                    break;
                case "Veiculos":
                    if (!select.Contains("Veiculos"))
                    {
                        select += "(vei.VEI_PLACA + ISNULL((SELECT ', ' + veiculo1.VEI_PLACA FROM T_CARGA_VEICULOS_VINCULADOS veiculoVinculadoCarga1 INNER JOIN T_VEICULO veiculo1 ON veiculoVinculadoCarga1.VEI_CODIGO = veiculo1.VEI_CODIGO WHERE veiculoVinculadoCarga1.CAR_CODIGO = car.CAR_CODIGO FOR XML PATH('')), '')) Veiculos, ";
                        groupBy += "vei.VEI_PLACA, ";

                        if (!joins.Contains("T_VEICULO vei"))
                            joins += "LEFT OUTER JOIN T_VEICULO vei ON car.CAR_VEICULO = vei.VEI_CODIGO ";
                    }
                    break;
                case "Destinatario":
                    if (!select.Contains("Destinatario"))
                    {
                        select += "cds.CDS_DESTINATARIOS Destinatario, ";
                        groupBy += "cds.CDS_DESTINATARIOS, ";

                        if (!joins.Contains("T_CARGA_DADOS_SUMARIZADOS cds"))
                            joins += "LEFT OUTER JOIN T_CARGA_DADOS_SUMARIZADOS cds ON cds.CDS_CODIGO = car.CDS_CODIGO ";
                    }
                    break;
                case "Destino":
                    if (!select.Contains("Destino"))
                    {
                        select += "cds.CDS_DESTINOS Destino, ";
                        groupBy += "cds.CDS_DESTINOS, ";

                        if (!joins.Contains("T_CARGA_DADOS_SUMARIZADOS cds"))
                            joins += "LEFT OUTER JOIN T_CARGA_DADOS_SUMARIZADOS cds ON cds.CDS_CODIGO = car.CDS_CODIGO ";
                    }
                    break;
                case "Remetente":
                    if (!select.Contains("Remetente"))
                    {
                        select += "cds.CDS_REMETENTES Remetente, ";
                        groupBy += "cds.CDS_REMETENTES, ";

                        if (!joins.Contains("T_CARGA_DADOS_SUMARIZADOS cds"))
                            joins += "LEFT OUTER JOIN T_CARGA_DADOS_SUMARIZADOS cds ON cds.CDS_CODIGO = car.CDS_CODIGO ";
                    }
                    break;
                case "Origem":
                    if (!select.Contains("Origem"))
                    {
                        select += "cds.CDS_ORIGENS Origem, ";
                        groupBy += "cds.CDS_ORIGENS, ";

                        if (!joins.Contains("T_CARGA_DADOS_SUMARIZADOS cds"))
                            joins += "LEFT OUTER JOIN T_CARGA_DADOS_SUMARIZADOS cds ON cds.CDS_CODIGO = car.CDS_CODIGO ";
                    }
                    break;
                case "NumeroColetas":
                    if (!select.Contains("NumeroColetas"))
                    {
                        select += "cds.CDS_NUMERO_COLETAS NumeroColetas, ";
                        groupBy += "cds.CDS_NUMERO_COLETAS, ";

                        if (!joins.Contains("T_CARGA_DADOS_SUMARIZADOS cds"))
                            joins += "LEFT OUTER JOIN T_CARGA_DADOS_SUMARIZADOS cds ON cds.CDS_CODIGO = car.CDS_CODIGO ";
                    }
                    break;
                case "NumeroEntregas":
                    if (!select.Contains("NumeroEntregas"))
                    {
                        select += "cds.CDS_NUMERO_ENTREGAS NumeroEntregas, ";
                        groupBy += "cds.CDS_NUMERO_ENTREGAS, ";

                        if (!joins.Contains("T_CARGA_DADOS_SUMARIZADOS cds"))
                            joins += "LEFT OUTER JOIN T_CARGA_DADOS_SUMARIZADOS cds ON cds.CDS_CODIGO = car.CDS_CODIGO ";
                    }
                    break;
                case "ModeloVeiculo":
                    if (!select.Contains("ModeloVeiculo"))
                    {
                        select += "mvc.MVC_DESCRICAO ModeloVeiculo, ";
                        groupBy += "mvc.MVC_DESCRICAO, ";

                        if (!joins.Contains("T_MODELO_VEICULAR_CARGA mvc"))
                            joins += "LEFT OUTER JOIN T_MODELO_VEICULAR_CARGA mvc ON mvc.MVC_CODIGO = car.MVC_CODIGO ";
                    }
                    break;
                case "TipoCarga":
                    if (!select.Contains("TipoCarga"))
                    {
                        select += "tcg.TCG_DESCRICAO TipoCarga, ";
                        groupBy += "tcg.TCG_DESCRICAO, ";

                        if (!joins.Contains("T_TIPO_DE_CARGA tcg"))
                            joins += "LEFT OUTER JOIN T_TIPO_DE_CARGA tcg ON tcg.TCG_CODIGO = car.TCG_CODIGO ";
                    }
                    break;
                case "Filial":
                    if (!select.Contains("Filial"))
                    {
                        select += "filial.FIL_DESCRICAO Filial, ";
                        groupBy += "filial.FIL_DESCRICAO, ";

                        if (!joins.Contains("T_FILIAL filial"))
                            joins += "LEFT OUTER JOIN T_FILIAL filial on filial.FIL_CODIGO = car.FIL_CODIGO ";
                    }
                    break;
                case "TipoOperacao":
                    if (!select.Contains("TipoOperacao"))
                    {
                        select += "tipoOperacao.TOP_DESCRICAO TipoOperacao, ";
                        groupBy += "tipoOperacao.TOP_DESCRICAO, ";

                        if (!joins.Contains("T_TIPO_OPERACAO tipoOperacao"))
                            joins += "left join T_TIPO_OPERACAO tipoOperacao on tipoOperacao.TOP_CODIGO = car.TOP_CODIGO ";
                    }
                    break;
                case "DescricaoSituacaoCarga":
                    if (!select.Contains("SituacaoCarga"))
                    {
                        select += "car.CAR_SITUACAO SituacaoCarga, ";
                        groupBy += "car.CAR_SITUACAO, ";
                    }
                    break;
                case "CodAgrupamento":
                    if (!select.Contains("CodAgrupamento"))
                    {
                        select += "agrupador.PAA_CODIGO_AGRUPAMENTO CodAgrupamento, ";
                        groupBy += "agrupador.PAA_CODIGO_AGRUPAMENTO, ";

                        if (!joins.Contains("T_CARGA_PRE_AGRUPAMENTO agrupamento"))
                            joins += "left join T_CARGA_PRE_AGRUPAMENTO agrupamento on agrupamento.CAR_CODIGO = car.CAR_CODIGO ";
                        joins += "left join T_CARGA_PRE_AGRUPAMENTO_AGRUPADOR agrupador on agrupamento.PAA_CODIGO = agrupador.PAA_CODIGO ";
                    }
                    break;
                case "Recebedor":
                    if (!select.Contains("Recebedor"))
                    {
                        select += "cargaDadosSumarizados.CDS_RECEBEDORES Recebedor, ";
                        groupBy += "cargaDadosSumarizados.CDS_RECEBEDORES, ";

                        if (!joins.Contains("T_CARGA_DADOS_SUMARIZADOS cargaDadosSumarizados"))
                            joins += "left join T_CARGA_DADOS_SUMARIZADOS cargaDadosSumarizados on cargaDadosSumarizados.CDS_CODIGO = car.CDS_CODIGO ";
                    }
                    break;
                case "Expedidor":
                    if (!select.Contains("Expedidor"))
                    {
                        select += "cargaDadosSumarizados.CDS_EXPEDIDORES Expedidor, ";
                        groupBy += "cargaDadosSumarizados.CDS_EXPEDIDORES, ";

                        if (!joins.Contains("T_CARGA_DADOS_SUMARIZADOS cargaDadosSumarizados"))
                            joins += "left join T_CARGA_DADOS_SUMARIZADOS cargaDadosSumarizados on cargaDadosSumarizados.CDS_CODIGO = car.CDS_CODIGO ";
                    }
                    break;
                default:
                    break;
            }
        }

        private string ObterWhereConsultaQuantidadesRota(int codigoTransportador, int codigoVeiculo, int codigoFilial, int codigoCentroCarregamento, int codigoRota, DateTime dataInicialCarregamento, DateTime dataFinalCarregamento)
        {
            string where = " where 1=1 and car.CAR_SITUACAO <> 13 and car.ROF_CODIGO is not null ";

            if (codigoCentroCarregamento > 0)
                where += "and cjc.CEC_CODIGO = " + codigoCentroCarregamento.ToString() + " "; // SQL-INJECTION-SAFE

            if (codigoRota > 0)
                where += "and car.ROF_CODIGO = " + codigoRota.ToString() + " "; // SQL-INJECTION-SAFE

            if (dataInicialCarregamento != DateTime.MinValue)
                where += "and cjc.CJC_INICIO_CARREGAMENTO >= '" + dataInicialCarregamento.ToString("yyyy-MM-dd") + "' "; // SQL-INJECTION-SAFE

            if (dataFinalCarregamento != DateTime.MinValue)
                where += "and cjc.CJC_INICIO_CARREGAMENTO < '" + dataFinalCarregamento.AddDays(1).ToString("yyyy-MM-dd") + "' ";
            //{
            //    where += @"and cjc.CJC_CODIGO in (
            //                 select cjc2.cjc_codigo
            //                 from T_CARGA_JANELA_CARREGAMENTO cjc2 
            //                 inner join T_CARGA car2 on car2.CAR_CODIGO = cjc2.CAR_CODIGO 
            //                 where CONVERT(date, cjc2.CJC_DATA_CARREGAMENTO_PROGRAMADA) < CONVERT(date, cjc2.CJC_INICIO_CARREGAMENTO) and cjc2.CJC_EXCEDENTE = 0 and car2.CAR_SITUACAO <> 13 and cjc2.CEC_CODIGO is not null and car2.ROF_CODIGO is not null
            //               ) ";
            //}

            if (codigoTransportador > 0)
                where += "and car.EMP_CODIGO = " + codigoTransportador.ToString() + " "; // SQL-INJECTION-SAFE

            if (codigoFilial > 0)
                where += "and car.FIL_CODIGO = " + codigoFilial.ToString() + " "; // SQL-INJECTION-SAFE

            if (codigoVeiculo > 0)
                where += "and (car.CAR_VEICULO = " + codigoVeiculo.ToString() + " or car.CAR_CODIGO in (select CAR_CODIGO from T_CARGA_VEICULOS_VINCULADOS where VEI_CODIGO = " + codigoVeiculo.ToString() + ")) "; // SQL-INJECTION-SAFE

            return where;
        }

        private string ObterWhereConsultaQuantidades(int codigoTransportador, int codigoVeiculo, int codigoFilial, int codigoCentroCarregamento, int codigoRota, DateTime dataInicialCarregamento, DateTime dataFinalCarregamento, double cpfCnpjDestinatario, TipoQuantidadeCarga? tipoPai)
        {
            string where = string.Empty;

            if (codigoCentroCarregamento > 0)
                where += "and cjc.CEC_CODIGO = " + codigoCentroCarregamento.ToString() + " "; // SQL-INJECTION-SAFE

            if (codigoRota > 0)
                where += "and car.ROF_CODIGO = " + codigoRota.ToString() + " "; // SQL-INJECTION-SAFE

            if (dataInicialCarregamento != DateTime.MinValue)
                where += "and cjc.CJC_INICIO_CARREGAMENTO >= '" + dataInicialCarregamento.ToString("yyyy-MM-dd") + "' "; // SQL-INJECTION-SAFE

            if (dataFinalCarregamento != DateTime.MinValue)
                where += "and cjc.CJC_INICIO_CARREGAMENTO < '" + dataFinalCarregamento.AddDays(1).ToString("yyyy-MM-dd") + "' "; // SQL-INJECTION-SAFE

            if (cpfCnpjDestinatario > 0d)
                where += "and ped.CLI_CODIGO = " + cpfCnpjDestinatario.ToString("F0") + " "; // SQL-INJECTION-SAFE

            if (tipoPai != null && tipoPai == TipoQuantidadeCarga.EmAtraso)
            {
                where += @"and cjc.CJC_CODIGO in (
                             select cjc2.cjc_codigo
                             from T_CARGA_JANELA_CARREGAMENTO cjc2 
                             inner join T_CARGA car2 on car2.CAR_CODIGO = cjc2.CAR_CODIGO 
                             where CONVERT(date, cjc2.CJC_DATA_CARREGAMENTO_PROGRAMADA) < CONVERT(date, cjc2.CJC_INICIO_CARREGAMENTO) and cjc2.CJC_EXCEDENTE = 0 and car2.CAR_SITUACAO <> 13 and cjc2.CEC_CODIGO is not null and car2.ROF_CODIGO is not null
                           ) ";
            }

            if (codigoTransportador > 0)
                where += "and car.EMP_CODIGO = " + codigoTransportador.ToString() + " "; // SQL-INJECTION-SAFE

            if (codigoFilial > 0)
                where += "and car.FIL_CODIGO = " + codigoFilial.ToString() + " "; // SQL-INJECTION-SAFE

            if (codigoVeiculo > 0)
                where += "and (car.CAR_VEICULO = " + codigoVeiculo.ToString() + " or car.CAR_CODIGO in (select CAR_CODIGO from T_CARGA_VEICULOS_VINCULADOS where VEI_CODIGO = " + codigoVeiculo.ToString() + ")) "; // SQL-INJECTION-SAFE

            return where;
        }

        #endregion Métodos Privados - Relatórios

        #region Consulta de Envio de Documentação

        public List<int> ConsultarCodigosTransbordoConhecimentosParaImpressaoLote(Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalEnvioDocumentacao modalEnvioDocumentacao, Dominio.Enumeradores.OpcaoSimNaoPesquisa foiAnulado, Dominio.Enumeradores.OpcaoSimNaoPesquisa foiSubstituido, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoServicoMultimodal> tipoServico, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoEnvioDocumentacao situacaoEnvio, double provedorOS, string numeroBooking, string numeroOS, string numeroControle, int numeroFiscal, int codigoContainer, int codigoPedidoViagemDirecao, int codigoTerminalOrigem, int codigoTerminalDestino, int codigoGrupoPessoa, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPropostaMultimodal> tiposPropostasMultimodal, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPropostaMultimodal> tipoPropostaMultimodal)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();
            query = query.Where(obj => obj.CTe.Status == "A" && obj.Carga.CargaSVM != true);

            if (situacaoEnvio == SituacaoEnvioDocumentacao.Enviado)
                query = query.Where(obj => obj.CTe.DocumentacaoEnviada == true);
            else if (situacaoEnvio == SituacaoEnvioDocumentacao.NaoEnviado)
                query = query.Where(obj => obj.CTe.DocumentacaoEnviada != true);

            if (provedorOS > 0)
                query = query.Where(obj => obj.CTe.ClienteProvedorOS.CPF_CNPJ == provedorOS);

            if (!string.IsNullOrWhiteSpace(numeroBooking))
                query = query.Where(obj => obj.CTe.NumeroBooking == numeroBooking);

            if (!string.IsNullOrWhiteSpace(numeroOS))
                query = query.Where(obj => obj.CTe.NumeroOS == numeroOS);

            if (!string.IsNullOrWhiteSpace(numeroControle))
                query = query.Where(obj => obj.CTe.NumeroControle == numeroControle);

            if (numeroFiscal > 0)
                query = query.Where(obj => obj.CTe.Numero == numeroFiscal);

            if (codigoContainer > 0)
                query = query.Where(obj => obj.CTe.Containers.Any(o => o.Container.Codigo == codigoContainer));

            if (codigoPedidoViagemDirecao > 0)
                query = query.Where(obj => obj.Carga.Pedidos.Any(p => p.Pedido.Transbordos.Any(t => t.PedidoViagemNavio.Codigo == codigoPedidoViagemDirecao)));
            else
                query = query.Where(obj => obj.CTe.Viagem.Codigo == codigoPedidoViagemDirecao);

            if (codigoTerminalOrigem > 0)
                query = query.Where(obj => obj.CTe.TerminalOrigem.Codigo == codigoTerminalOrigem);

            if (codigoTerminalDestino > 0)
                query = query.Where(obj => obj.CTe.TerminalDestino.Codigo == codigoTerminalDestino);

            if (codigoGrupoPessoa > 0)
                query = query.Where(obj => obj.CTe.TomadorPagador.GrupoPessoas.Codigo == codigoGrupoPessoa || obj.CTe.TomadorPagador.Cliente.GrupoPessoas.Codigo == codigoGrupoPessoa);

            var queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            if (tipoPropostaMultimodal != null && tipoPropostaMultimodal.Count > 0)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => tipoPropostaMultimodal.Contains(obj.TipoPropostaMultimodal));
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }
            if (tiposPropostasMultimodal != null && tiposPropostasMultimodal.Count > 0)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => tiposPropostasMultimodal.Contains(obj.TipoPropostaMultimodal));
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }

            var queryAnulacao = this.SessionNHiBernate.Query<Dominio.Entidades.ConhecimentoDeTransporteEletronico>();
            queryAnulacao = queryAnulacao.Where(obj => obj.Status == "A" && obj.TipoCTE == Dominio.Enumeradores.TipoCTE.Anulacao);
            if (foiAnulado == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Sim)
                query = query.Where(obj => queryAnulacao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));
            else if (foiAnulado == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Nao)
                query = query.Where(obj => !queryAnulacao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));

            var querySubstituicao = this.SessionNHiBernate.Query<Dominio.Entidades.ConhecimentoDeTransporteEletronico>();
            querySubstituicao = querySubstituicao.Where(obj => obj.Status == "A" && obj.TipoCTE == Dominio.Enumeradores.TipoCTE.Substituto);
            if (foiSubstituido == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Sim)
                query = query.Where(obj => querySubstituicao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));
            else if (foiAnulado == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Nao)
                query = query.Where(obj => !querySubstituicao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));

            if (tipoServico != null && tipoServico.Count > 0)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => tipoServico.Contains(obj.TipoServicoMultimodal));
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }

            if (modalEnvioDocumentacao == ModalEnvioDocumentacao.PortoDestino)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorto || obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto);
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }
            else
            {
                queryCargaPedido = queryCargaPedido.Where(obj => obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorta || obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorta);
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }

            return query.Select(o => o.CTe.Codigo).Timeout(6000).ToList();
        }

        public List<int> ConsultarCodigosConhecimentosParaImpressaoLote(Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalEnvioDocumentacao modalEnvioDocumentacao, Dominio.Enumeradores.OpcaoSimNaoPesquisa foiAnulado, Dominio.Enumeradores.OpcaoSimNaoPesquisa foiSubstituido, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoServicoMultimodal> tipoServico, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoEnvioDocumentacao situacaoEnvio, double provedorOS, string numeroBooking, string numeroOS, string numeroControle, int numeroFiscal, int codigoContainer, int codigoPedidoViagemDirecao, int codigoTerminalOrigem, int codigoTerminalDestino, int codigoGrupoPessoa, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPropostaMultimodal> tiposPropostasMultimodal, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPropostaMultimodal> tipoPropostaMultimodal)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();
            query = query.Where(obj => obj.CTe.Status == "A" && obj.Carga.CargaSVM != true);

            if (situacaoEnvio == SituacaoEnvioDocumentacao.Enviado)
                query = query.Where(obj => obj.CTe.DocumentacaoEnviada == true);
            else if (situacaoEnvio == SituacaoEnvioDocumentacao.NaoEnviado)
                query = query.Where(obj => obj.CTe.DocumentacaoEnviada != true);

            if (provedorOS > 0)
                query = query.Where(obj => obj.CTe.ClienteProvedorOS.CPF_CNPJ == provedorOS);

            if (!string.IsNullOrWhiteSpace(numeroBooking))
                query = query.Where(obj => obj.CTe.NumeroBooking == numeroBooking);

            if (!string.IsNullOrWhiteSpace(numeroOS))
                query = query.Where(obj => obj.CTe.NumeroOS == numeroOS);

            if (!string.IsNullOrWhiteSpace(numeroControle))
                query = query.Where(obj => obj.CTe.NumeroControle == numeroControle);

            if (numeroFiscal > 0)
                query = query.Where(obj => obj.CTe.Numero == numeroFiscal);

            if (codigoContainer > 0)
                query = query.Where(obj => obj.CTe.Containers.Any(o => o.Container.Codigo == codigoContainer));

            if (codigoPedidoViagemDirecao > 0)
                query = query.Where(obj => obj.CTe.Viagem.Codigo == codigoPedidoViagemDirecao);
            else
                query = query.Where(obj => obj.CTe.Viagem.Codigo == codigoPedidoViagemDirecao);

            if (codigoTerminalOrigem > 0)
                query = query.Where(obj => obj.CTe.TerminalOrigem.Codigo == codigoTerminalOrigem);

            if (codigoTerminalDestino > 0)
                query = query.Where(obj => obj.CTe.TerminalDestino.Codigo == codigoTerminalDestino);

            if (codigoGrupoPessoa > 0)
                query = query.Where(obj => obj.CTe.TomadorPagador.GrupoPessoas.Codigo == codigoGrupoPessoa || obj.CTe.TomadorPagador.Cliente.GrupoPessoas.Codigo == codigoGrupoPessoa);

            var queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            if (tipoPropostaMultimodal != null && tipoPropostaMultimodal.Count > 0)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => tipoPropostaMultimodal.Contains(obj.TipoPropostaMultimodal));
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }
            if (tiposPropostasMultimodal != null && tiposPropostasMultimodal.Count > 0)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => tiposPropostasMultimodal.Contains(obj.TipoPropostaMultimodal));
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }

            var queryAnulacao = this.SessionNHiBernate.Query<Dominio.Entidades.ConhecimentoDeTransporteEletronico>();
            queryAnulacao = queryAnulacao.Where(obj => obj.Status == "A" && obj.TipoCTE == Dominio.Enumeradores.TipoCTE.Anulacao);
            if (foiAnulado == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Sim)
                query = query.Where(obj => queryAnulacao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));
            else if (foiAnulado == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Nao)
                query = query.Where(obj => !queryAnulacao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));

            var querySubstituicao = this.SessionNHiBernate.Query<Dominio.Entidades.ConhecimentoDeTransporteEletronico>();
            querySubstituicao = querySubstituicao.Where(obj => obj.Status == "A" && obj.TipoCTE == Dominio.Enumeradores.TipoCTE.Substituto);
            if (foiSubstituido == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Sim)
                query = query.Where(obj => querySubstituicao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));
            else if (foiAnulado == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Nao)
                query = query.Where(obj => !querySubstituicao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));

            if (tipoServico != null && tipoServico.Count > 0)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => tipoServico.Contains(obj.TipoServicoMultimodal));
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }

            if (modalEnvioDocumentacao == ModalEnvioDocumentacao.PortoDestino)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorto || obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto);
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }
            else
            {
                queryCargaPedido = queryCargaPedido.Where(obj => obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorta || obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorta);
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }

            return query.Select(o => o.CTe.Codigo).Timeout(6000).ToList();
        }

        public List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> ConsultarConhecimentosParaImpressaoLote(Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalEnvioDocumentacao modalEnvioDocumentacao, Dominio.Enumeradores.OpcaoSimNaoPesquisa foiAnulado, Dominio.Enumeradores.OpcaoSimNaoPesquisa foiSubstituido, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoServicoMultimodal> tipoServico, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoEnvioDocumentacao situacaoEnvio, double provedorOS, string numeroBooking, string numeroOS, string numeroControle, int numeroFiscal, int codigoContainer, int codigoPedidoViagemDirecao, int codigoTerminalOrigem, int codigoTerminalDestino, int codigoGrupoPessoa, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPropostaMultimodal> tiposPropostasMultimodal, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPropostaMultimodal> tipoPropostaMultimodal, string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();
            query = query.Where(obj => obj.CTe.Status == "A" && obj.Carga.CargaSVM != true);

            if (situacaoEnvio == SituacaoEnvioDocumentacao.Enviado)
                query = query.Where(obj => obj.CTe.DocumentacaoEnviada == true);
            else if (situacaoEnvio == SituacaoEnvioDocumentacao.NaoEnviado)
                query = query.Where(obj => obj.CTe.DocumentacaoEnviada != true);

            if (provedorOS > 0)
                query = query.Where(obj => obj.CTe.ClienteProvedorOS.CPF_CNPJ == provedorOS);

            if (!string.IsNullOrWhiteSpace(numeroBooking))
                query = query.Where(obj => obj.CTe.NumeroBooking == numeroBooking);

            if (!string.IsNullOrWhiteSpace(numeroOS))
                query = query.Where(obj => obj.CTe.NumeroOS == numeroOS);

            if (!string.IsNullOrWhiteSpace(numeroControle))
                query = query.Where(obj => obj.CTe.NumeroControle == numeroControle);

            if (numeroFiscal > 0)
                query = query.Where(obj => obj.CTe.Numero == numeroFiscal);

            if (codigoContainer > 0)
                query = query.Where(obj => obj.CTe.Containers.Any(o => o.Container.Codigo == codigoContainer));

            if (codigoPedidoViagemDirecao > 0)
                query = query.Where(obj => obj.CTe.Viagem.Codigo == codigoPedidoViagemDirecao);
            else
                query = query.Where(obj => obj.CTe.Viagem.Codigo == codigoPedidoViagemDirecao);

            if (codigoTerminalOrigem > 0)
                query = query.Where(obj => obj.CTe.TerminalOrigem.Codigo == codigoTerminalOrigem);

            if (codigoTerminalDestino > 0)
                query = query.Where(obj => obj.CTe.TerminalDestino.Codigo == codigoTerminalDestino);

            if (codigoGrupoPessoa > 0)
                query = query.Where(obj => obj.CTe.TomadorPagador.GrupoPessoas.Codigo == codigoGrupoPessoa || obj.CTe.TomadorPagador.Cliente.GrupoPessoas.Codigo == codigoGrupoPessoa);

            var queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            if (tipoPropostaMultimodal != null && tipoPropostaMultimodal.Count > 0)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => tipoPropostaMultimodal.Contains(obj.TipoPropostaMultimodal));
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }
            if (tiposPropostasMultimodal != null && tiposPropostasMultimodal.Count > 0)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => tiposPropostasMultimodal.Contains(obj.TipoPropostaMultimodal));
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }

            var queryAnulacao = this.SessionNHiBernate.Query<Dominio.Entidades.ConhecimentoDeTransporteEletronico>();
            queryAnulacao = queryAnulacao.Where(obj => obj.Status == "A" && obj.TipoCTE == Dominio.Enumeradores.TipoCTE.Anulacao);
            if (foiAnulado == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Sim)
                query = query.Where(obj => queryAnulacao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));
            else if (foiAnulado == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Nao)
                query = query.Where(obj => !queryAnulacao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));

            var querySubstituicao = this.SessionNHiBernate.Query<Dominio.Entidades.ConhecimentoDeTransporteEletronico>();
            querySubstituicao = querySubstituicao.Where(obj => obj.Status == "A" && obj.TipoCTE == Dominio.Enumeradores.TipoCTE.Substituto);
            if (foiSubstituido == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Sim)
                query = query.Where(obj => querySubstituicao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));
            else if (foiAnulado == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Nao)
                query = query.Where(obj => !querySubstituicao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));

            if (tipoServico != null && tipoServico.Count > 0)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => tipoServico.Contains(obj.TipoServicoMultimodal));
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }

            if (modalEnvioDocumentacao == ModalEnvioDocumentacao.PortoDestino)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorto || obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto);
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }
            else
            {
                queryCargaPedido = queryCargaPedido.Where(obj => obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorta || obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorta);
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }

            return query.Select(o => o.CTe).OrderBy(propOrdenacao + (dirOrdenacao == "asc" ? " ascending" : " descending")).Skip(inicioRegistros).Take(maximoRegistros).ToList();
        }

        public int ContarConsultarConhecimentosParaImpressaoLote(Dominio.ObjetosDeValor.Embarcador.Enumeradores.ModalEnvioDocumentacao modalEnvioDocumentacao, Dominio.Enumeradores.OpcaoSimNaoPesquisa foiAnulado, Dominio.Enumeradores.OpcaoSimNaoPesquisa foiSubstituido, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoServicoMultimodal> tipoServico, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoEnvioDocumentacao situacaoEnvio, double provedorOS, string numeroBooking, string numeroOS, string numeroControle, int numeroFiscal, int codigoContainer, int codigoPedidoViagemDirecao, int codigoTerminalOrigem, int codigoTerminalDestino, int codigoGrupoPessoa, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPropostaMultimodal> tiposPropostasMultimodal, List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoPropostaMultimodal> tipoPropostaMultimodal)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();
            query = query.Where(obj => obj.CTe.Status == "A" && obj.Carga.CargaSVM != true);

            if (situacaoEnvio == SituacaoEnvioDocumentacao.Enviado)
                query = query.Where(obj => obj.CTe.DocumentacaoEnviada == true);
            else if (situacaoEnvio == SituacaoEnvioDocumentacao.NaoEnviado)
                query = query.Where(obj => obj.CTe.DocumentacaoEnviada != true);

            if (provedorOS > 0)
                query = query.Where(obj => obj.CTe.ClienteProvedorOS.CPF_CNPJ == provedorOS);

            if (!string.IsNullOrWhiteSpace(numeroBooking))
                query = query.Where(obj => obj.CTe.NumeroBooking == numeroBooking);

            if (!string.IsNullOrWhiteSpace(numeroOS))
                query = query.Where(obj => obj.CTe.NumeroOS == numeroOS);

            if (!string.IsNullOrWhiteSpace(numeroControle))
                query = query.Where(obj => obj.CTe.NumeroControle == numeroControle);

            if (numeroFiscal > 0)
                query = query.Where(obj => obj.CTe.Numero == numeroFiscal);

            if (codigoContainer > 0)
                query = query.Where(obj => obj.CTe.Containers.Any(o => o.Container.Codigo == codigoContainer));

            if (codigoPedidoViagemDirecao > 0)
                query = query.Where(obj => obj.CTe.Viagem.Codigo == codigoPedidoViagemDirecao);
            else
                query = query.Where(obj => obj.CTe.Viagem.Codigo == codigoPedidoViagemDirecao);

            if (codigoTerminalOrigem > 0)
                query = query.Where(obj => obj.CTe.TerminalOrigem.Codigo == codigoTerminalOrigem);

            if (codigoTerminalDestino > 0)
                query = query.Where(obj => obj.CTe.TerminalDestino.Codigo == codigoTerminalDestino);

            if (codigoGrupoPessoa > 0)
                query = query.Where(obj => obj.CTe.TomadorPagador.GrupoPessoas.Codigo == codigoGrupoPessoa || obj.CTe.TomadorPagador.Cliente.GrupoPessoas.Codigo == codigoGrupoPessoa);

            var queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();

            if (tipoPropostaMultimodal != null && tipoPropostaMultimodal.Count > 0)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => tipoPropostaMultimodal.Contains(obj.TipoPropostaMultimodal));
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }
            if (tiposPropostasMultimodal != null && tiposPropostasMultimodal.Count > 0)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => tiposPropostasMultimodal.Contains(obj.TipoPropostaMultimodal));
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }

            var queryAnulacao = this.SessionNHiBernate.Query<Dominio.Entidades.ConhecimentoDeTransporteEletronico>();
            queryAnulacao = queryAnulacao.Where(obj => obj.Status == "A" && obj.TipoCTE == Dominio.Enumeradores.TipoCTE.Anulacao);
            if (foiAnulado == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Sim)
                query = query.Where(obj => queryAnulacao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));
            else if (foiAnulado == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Nao)
                query = query.Where(obj => !queryAnulacao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));

            var querySubstituicao = this.SessionNHiBernate.Query<Dominio.Entidades.ConhecimentoDeTransporteEletronico>();
            querySubstituicao = querySubstituicao.Where(obj => obj.Status == "A" && obj.TipoCTE == Dominio.Enumeradores.TipoCTE.Substituto);
            if (foiSubstituido == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Sim)
                query = query.Where(obj => querySubstituicao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));
            else if (foiAnulado == Dominio.Enumeradores.OpcaoSimNaoPesquisa.Nao)
                query = query.Where(obj => !querySubstituicao.Any(o => o.ChaveCTESubComp == obj.CTe.Chave));

            if (tipoServico != null && tipoServico.Count > 0)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => tipoServico.Contains(obj.TipoServicoMultimodal));
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }

            if (modalEnvioDocumentacao == ModalEnvioDocumentacao.PortoDestino)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorto || obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorto);
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }
            else
            {
                queryCargaPedido = queryCargaPedido.Where(obj => obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortoPorta || obj.ModalPropostaMultimodal == ModalPropostaMultimodal.PortaPorta);
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }

            return query.Select(o => o.CTe).Count();
        }

        public List<Dominio.Entidades.Embarcador.Cargas.Carga> BuscarCargasSemSaldoNoContratoSaldo(int qteProcessar = 100)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();
            var subquery = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Frete.ContratoSaldoMes>();

            query = query.Where(x => !subquery.Any(a => a.Carga.Codigo == x.Codigo) && x.ContratoFreteTransportador != null
                          && (x.SituacaoCarga == SituacaoCarga.Encerrada || x.SituacaoCarga == SituacaoCarga.EmTransporte)
                          && x.DataCriacaoCarga >= DateTime.Parse("1/07/2023"));

            return query.Take(qteProcessar).ToList();
        }

        #endregion

        #region Consulta de Envio de Documentação AFRMM

        public List<Dominio.Entidades.ConhecimentoDeTransporteEletronico> ConsultarConhecimentosDocumentacaoAFRMM(string numeroBooking, string numeroControle, string numeroManifesto, string numeroManifestoTransbordo, string numeroCEMercante,
            DateTime descargaPODInicial, DateTime descargaPODFinal, DateTime envioDocInicial, DateTime envioDocFinal,
            int codigoPedidoViagemDirecao, int codigoPortoOrigem, int codigoPortoDestino,
            List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoServicoMultimodal> tipoServico, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoEnvioDocumentacao situacaoEnvio,
            string propOrdenacao, string dirOrdenacao, int inicioRegistros, int maximoRegistros)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();
            query = query.Where(obj => obj.CTe.Status == "A" && obj.CTe.TipoModal != TipoModal.Multimodal && obj.CTe.TipoCTE != Dominio.Enumeradores.TipoCTE.Complemento && obj.CTe.TipoCTE != Dominio.Enumeradores.TipoCTE.Anulacao && obj.CTe.NumeroCEMercante != null && obj.CTe.NumeroCEMercante != "" && obj.CTe.NaoEnviarParaMercante != true);

            query = query.Where(obj => (obj.CTe.PortoPassagemUm != null && obj.CTe.NumeroManifesto != null && obj.CTe.NumeroManifesto != "" && obj.CTe.NumeroManifestoTransbordo != null && obj.CTe.NumeroManifestoTransbordo != "")
            || (obj.CTe.PortoPassagemUm == null && obj.CTe.NumeroManifesto != null && obj.CTe.NumeroManifesto != ""));

            if (situacaoEnvio == SituacaoEnvioDocumentacao.Enviado)
                query = query.Where(obj => obj.CTe.SituacaoEnvioDocumentacaAFRMM == situacaoEnvio);
            else if (situacaoEnvio == SituacaoEnvioDocumentacao.NaoEnviado)
                query = query.Where(obj => obj.CTe.SituacaoEnvioDocumentacaAFRMM == situacaoEnvio);
            else if (situacaoEnvio == SituacaoEnvioDocumentacao.Falha)
                query = query.Where(obj => obj.CTe.SituacaoEnvioDocumentacaAFRMM == situacaoEnvio);

            if (!string.IsNullOrWhiteSpace(numeroBooking))
                query = query.Where(obj => obj.CTe.NumeroBooking == numeroBooking);

            if (!string.IsNullOrWhiteSpace(numeroControle))
                query = query.Where(obj => obj.CTe.NumeroControle == numeroControle);

            if (!string.IsNullOrWhiteSpace(numeroManifesto))
                query = query.Where(obj => obj.CTe.NumeroManifesto == numeroManifesto);

            if (!string.IsNullOrWhiteSpace(numeroManifestoTransbordo))
                query = query.Where(obj => obj.CTe.NumeroManifestoTransbordo == numeroManifestoTransbordo);

            if (!string.IsNullOrWhiteSpace(numeroCEMercante))
                query = query.Where(obj => obj.CTe.NumeroCEMercante == numeroCEMercante);

            if (codigoPedidoViagemDirecao > 0)
                query = query.Where(obj => obj.CTe.Viagem.Codigo == codigoPedidoViagemDirecao);

            if (codigoPortoOrigem > 0)
                query = query.Where(obj => obj.CTe.PortoOrigem.Codigo == codigoPortoOrigem);

            if (codigoPortoDestino > 0)
                query = query.Where(obj => obj.CTe.PortoDestino.Codigo == codigoPortoDestino);

            if (envioDocInicial != DateTime.MinValue && envioDocFinal == DateTime.MinValue)
                query = query.Where(obj => obj.CTe.DataUltimoEnvioDocumentacaoAFRMM.Value.Date >= envioDocInicial.Date);
            else if (envioDocInicial == DateTime.MinValue && envioDocFinal != DateTime.MinValue)
                query = query.Where(obj => obj.CTe.DataUltimoEnvioDocumentacaoAFRMM.Value.Date <= envioDocFinal.Date);
            else if (envioDocInicial != DateTime.MinValue && envioDocFinal != DateTime.MinValue)
                query = query.Where(obj => obj.CTe.DataUltimoEnvioDocumentacaoAFRMM.Value.Date >= envioDocInicial.Date && obj.CTe.DataUltimoEnvioDocumentacaoAFRMM.Value.Date <= envioDocFinal.Date);

            var querySchedule = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoViagemNavioSchedule>();
            if (descargaPODInicial != DateTime.MinValue && descargaPODFinal == DateTime.MinValue)
                querySchedule = querySchedule.Where(c => c.DataPrevisaoChegadaNavio.Value.Date >= descargaPODInicial.Date);
            else if (descargaPODInicial == DateTime.MinValue && descargaPODFinal != DateTime.MinValue)
                querySchedule = querySchedule.Where(c => c.DataPrevisaoChegadaNavio.Value.Date <= descargaPODFinal.Date);
            else if (descargaPODInicial != DateTime.MinValue && descargaPODFinal != DateTime.MinValue)
                querySchedule = querySchedule.Where(c => c.DataPrevisaoChegadaNavio.Value.Date >= descargaPODInicial.Date && c.DataPrevisaoChegadaNavio.Value.Date <= descargaPODFinal.Date);

            if (descargaPODInicial != DateTime.MinValue || descargaPODFinal != DateTime.MinValue)
                query = query.Where(obj => querySchedule.Any(o => o.PortoAtracacao.Codigo == obj.CTe.PortoDestino.Codigo && o.TerminalAtracacao.Codigo == obj.CTe.TerminalDestino.Codigo && o.PedidoViagemNavio.Codigo == obj.CTe.Viagem.Codigo));

            var queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
            if (tipoServico != null && tipoServico.Count > 0)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => tipoServico.Contains(obj.TipoServicoMultimodal));
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }

            queryCargaPedido = queryCargaPedido.Where(obj => obj.TipoPropostaMultimodal == TipoPropostaMultimodal.CargaFechada || obj.TipoPropostaMultimodal == TipoPropostaMultimodal.CargaFracionada);
            query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));

            if (maximoRegistros > 0)
                return query.Select(o => o.CTe).OrderBy(propOrdenacao + (dirOrdenacao == "asc" ? " ascending" : " descending")).Skip(inicioRegistros).Take(maximoRegistros).ToList();
            else
                return query.Select(o => o.CTe).OrderBy(propOrdenacao + (dirOrdenacao == "asc" ? " ascending" : " descending")).ToList();
        }

        public int ContarConsultarConhecimentosDocumentacaoAFRMM(string numeroBooking, string numeroControle, string numeroManifesto, string numeroManifestoTransbordo, string numeroCEMercante,
            DateTime descargaPODInicial, DateTime descargaPODFinal, DateTime envioDocInicial, DateTime envioDocFinal,
            int codigoPedidoViagemDirecao, int codigoPortoOrigem, int codigoPortoDestino,
            List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoServicoMultimodal> tipoServico, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoEnvioDocumentacao situacaoEnvio)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();
            query = query.Where(obj => obj.CTe.Status == "A" && obj.CTe.TipoModal != TipoModal.Multimodal && obj.CTe.TipoCTE != Dominio.Enumeradores.TipoCTE.Complemento && obj.CTe.TipoCTE != Dominio.Enumeradores.TipoCTE.Anulacao && obj.CTe.NumeroCEMercante != null && obj.CTe.NumeroCEMercante != "" && obj.CTe.NaoEnviarParaMercante != true);

            query = query.Where(obj => (obj.CTe.PortoPassagemUm != null && obj.CTe.NumeroManifesto != null && obj.CTe.NumeroManifesto != "" && obj.CTe.NumeroManifestoTransbordo != null && obj.CTe.NumeroManifestoTransbordo != "")
            || (obj.CTe.PortoPassagemUm == null && obj.CTe.NumeroManifesto != null && obj.CTe.NumeroManifesto != ""));

            if (situacaoEnvio == SituacaoEnvioDocumentacao.Enviado)
                query = query.Where(obj => obj.CTe.SituacaoEnvioDocumentacaAFRMM == situacaoEnvio);
            else if (situacaoEnvio == SituacaoEnvioDocumentacao.NaoEnviado)
                query = query.Where(obj => obj.CTe.SituacaoEnvioDocumentacaAFRMM == situacaoEnvio);
            else if (situacaoEnvio == SituacaoEnvioDocumentacao.Falha)
                query = query.Where(obj => obj.CTe.SituacaoEnvioDocumentacaAFRMM == situacaoEnvio);

            if (!string.IsNullOrWhiteSpace(numeroBooking))
                query = query.Where(obj => obj.CTe.NumeroBooking == numeroBooking);

            if (!string.IsNullOrWhiteSpace(numeroControle))
                query = query.Where(obj => obj.CTe.NumeroControle == numeroControle);

            if (!string.IsNullOrWhiteSpace(numeroManifesto))
                query = query.Where(obj => obj.CTe.NumeroManifesto == numeroManifesto);

            if (!string.IsNullOrWhiteSpace(numeroManifestoTransbordo))
                query = query.Where(obj => obj.CTe.NumeroManifestoTransbordo == numeroManifestoTransbordo);

            if (!string.IsNullOrWhiteSpace(numeroCEMercante))
                query = query.Where(obj => obj.CTe.NumeroCEMercante == numeroCEMercante);

            if (codigoPedidoViagemDirecao > 0)
                query = query.Where(obj => obj.CTe.Viagem.Codigo == codigoPedidoViagemDirecao);

            if (codigoPortoOrigem > 0)
                query = query.Where(obj => obj.CTe.PortoOrigem.Codigo == codigoPortoOrigem);

            if (codigoPortoDestino > 0)
                query = query.Where(obj => obj.CTe.PortoDestino.Codigo == codigoPortoDestino);

            if (envioDocInicial != DateTime.MinValue && envioDocFinal == DateTime.MinValue)
                query = query.Where(obj => obj.CTe.DataUltimoEnvioDocumentacaoAFRMM.Value.Date >= envioDocInicial.Date);
            else if (envioDocInicial == DateTime.MinValue && envioDocFinal != DateTime.MinValue)
                query = query.Where(obj => obj.CTe.DataUltimoEnvioDocumentacaoAFRMM.Value.Date <= envioDocFinal.Date);
            else if (envioDocInicial != DateTime.MinValue && envioDocFinal != DateTime.MinValue)
                query = query.Where(obj => obj.CTe.DataUltimoEnvioDocumentacaoAFRMM.Value.Date >= envioDocInicial.Date && obj.CTe.DataUltimoEnvioDocumentacaoAFRMM.Value.Date <= envioDocFinal.Date);

            var querySchedule = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoViagemNavioSchedule>();
            if (descargaPODInicial != DateTime.MinValue && descargaPODFinal == DateTime.MinValue)
                querySchedule = querySchedule.Where(c => c.DataPrevisaoChegadaNavio.Value.Date >= descargaPODInicial.Date);
            else if (descargaPODInicial == DateTime.MinValue && descargaPODFinal != DateTime.MinValue)
                querySchedule = querySchedule.Where(c => c.DataPrevisaoChegadaNavio.Value.Date <= descargaPODFinal.Date);
            else if (descargaPODInicial != DateTime.MinValue && descargaPODFinal != DateTime.MinValue)
                querySchedule = querySchedule.Where(c => c.DataPrevisaoChegadaNavio.Value.Date >= descargaPODInicial.Date && c.DataPrevisaoChegadaNavio.Value.Date <= descargaPODFinal.Date);

            if (descargaPODInicial != DateTime.MinValue || descargaPODFinal != DateTime.MinValue)
                query = query.Where(obj => querySchedule.Any(o => o.PortoAtracacao.Codigo == obj.CTe.PortoDestino.Codigo && o.TerminalAtracacao.Codigo == obj.CTe.TerminalDestino.Codigo && o.PedidoViagemNavio.Codigo == obj.CTe.Viagem.Codigo));

            var queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
            if (tipoServico != null && tipoServico.Count > 0)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => tipoServico.Contains(obj.TipoServicoMultimodal));
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }

            queryCargaPedido = queryCargaPedido.Where(obj => obj.TipoPropostaMultimodal == TipoPropostaMultimodal.CargaFechada || obj.TipoPropostaMultimodal == TipoPropostaMultimodal.CargaFracionada);
            query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));

            return query.Count();
        }

        public List<int> ConsultarCodigosConhecimentosDocumentacaoAFRMM(string numeroBooking, string numeroControle, string numeroManifesto, string numeroManifestoTransbordo, string numeroCEMercante,
            DateTime descargaPODInicial, DateTime descargaPODFinal, DateTime envioDocInicial, DateTime envioDocFinal,
            int codigoPedidoViagemDirecao, int codigoPortoOrigem, int codigoPortoDestino,
            List<Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoServicoMultimodal> tipoServico, Dominio.ObjetosDeValor.Embarcador.Enumeradores.SituacaoEnvioDocumentacao situacaoEnvio)
        {
            var query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>();
            query = query.Where(obj => obj.CTe.Status == "A" && obj.CTe.TipoModal != TipoModal.Multimodal && obj.CTe.TipoCTE != Dominio.Enumeradores.TipoCTE.Complemento && obj.CTe.TipoCTE != Dominio.Enumeradores.TipoCTE.Anulacao && obj.CTe.NumeroCEMercante != null && obj.CTe.NumeroCEMercante != "" && obj.CTe.NaoEnviarParaMercante != true);

            query = query.Where(obj => (obj.CTe.PortoPassagemUm != null && obj.CTe.NumeroManifesto != null && obj.CTe.NumeroManifesto != "" && obj.CTe.NumeroManifestoTransbordo != null && obj.CTe.NumeroManifestoTransbordo != "")
            || (obj.CTe.PortoPassagemUm == null && obj.CTe.NumeroManifesto != null && obj.CTe.NumeroManifesto != ""));

            if (situacaoEnvio == SituacaoEnvioDocumentacao.Enviado)
                query = query.Where(obj => obj.CTe.SituacaoEnvioDocumentacaAFRMM == situacaoEnvio);
            else if (situacaoEnvio == SituacaoEnvioDocumentacao.NaoEnviado)
                query = query.Where(obj => obj.CTe.SituacaoEnvioDocumentacaAFRMM == situacaoEnvio);
            else if (situacaoEnvio == SituacaoEnvioDocumentacao.Falha)
                query = query.Where(obj => obj.CTe.SituacaoEnvioDocumentacaAFRMM == situacaoEnvio);

            if (!string.IsNullOrWhiteSpace(numeroBooking))
                query = query.Where(obj => obj.CTe.NumeroBooking == numeroBooking);

            if (!string.IsNullOrWhiteSpace(numeroControle))
                query = query.Where(obj => obj.CTe.NumeroControle == numeroControle);

            if (!string.IsNullOrWhiteSpace(numeroManifesto))
                query = query.Where(obj => obj.CTe.NumeroManifesto == numeroManifesto);

            if (!string.IsNullOrWhiteSpace(numeroManifestoTransbordo))
                query = query.Where(obj => obj.CTe.NumeroManifestoTransbordo == numeroManifestoTransbordo);

            if (!string.IsNullOrWhiteSpace(numeroCEMercante))
                query = query.Where(obj => obj.CTe.NumeroCEMercante == numeroCEMercante);

            if (codigoPedidoViagemDirecao > 0)
                query = query.Where(obj => obj.CTe.Viagem.Codigo == codigoPedidoViagemDirecao);

            if (codigoPortoOrigem > 0)
                query = query.Where(obj => obj.CTe.PortoOrigem.Codigo == codigoPortoOrigem);

            if (codigoPortoDestino > 0)
                query = query.Where(obj => obj.CTe.PortoDestino.Codigo == codigoPortoDestino);

            if (envioDocInicial != DateTime.MinValue && envioDocFinal == DateTime.MinValue)
                query = query.Where(obj => obj.CTe.DataUltimoEnvioDocumentacaoAFRMM.Value.Date >= envioDocInicial.Date);
            else if (envioDocInicial == DateTime.MinValue && envioDocFinal != DateTime.MinValue)
                query = query.Where(obj => obj.CTe.DataUltimoEnvioDocumentacaoAFRMM.Value.Date <= envioDocFinal.Date);
            else if (envioDocInicial != DateTime.MinValue && envioDocFinal != DateTime.MinValue)
                query = query.Where(obj => obj.CTe.DataUltimoEnvioDocumentacaoAFRMM.Value.Date >= envioDocInicial.Date && obj.CTe.DataUltimoEnvioDocumentacaoAFRMM.Value.Date <= envioDocFinal.Date);

            var querySchedule = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Pedidos.PedidoViagemNavioSchedule>();
            if (descargaPODInicial != DateTime.MinValue && descargaPODFinal == DateTime.MinValue)
                querySchedule = querySchedule.Where(c => c.DataPrevisaoChegadaNavio.Value.Date >= descargaPODInicial.Date);
            else if (descargaPODInicial == DateTime.MinValue && descargaPODFinal != DateTime.MinValue)
                querySchedule = querySchedule.Where(c => c.DataPrevisaoChegadaNavio.Value.Date <= descargaPODFinal.Date);
            else if (descargaPODInicial != DateTime.MinValue && descargaPODFinal != DateTime.MinValue)
                querySchedule = querySchedule.Where(c => c.DataPrevisaoChegadaNavio.Value.Date >= descargaPODInicial.Date && c.DataPrevisaoChegadaNavio.Value.Date <= descargaPODFinal.Date);

            if (descargaPODInicial != DateTime.MinValue || descargaPODFinal != DateTime.MinValue)
                query = query.Where(obj => querySchedule.Any(o => o.PortoAtracacao.Codigo == obj.CTe.PortoDestino.Codigo && o.TerminalAtracacao.Codigo == obj.CTe.TerminalDestino.Codigo && o.PedidoViagemNavio.Codigo == obj.CTe.Viagem.Codigo));

            var queryCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>();
            if (tipoServico != null && tipoServico.Count > 0)
            {
                queryCargaPedido = queryCargaPedido.Where(obj => tipoServico.Contains(obj.TipoServicoMultimodal));
                query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));
            }

            queryCargaPedido = queryCargaPedido.Where(obj => obj.TipoPropostaMultimodal == TipoPropostaMultimodal.CargaFechada || obj.TipoPropostaMultimodal == TipoPropostaMultimodal.CargaFracionada);
            query = query.Where(obj => queryCargaPedido.Any(o => o.Carga == obj.Carga));

            return query.Select(c => c.CTe.Codigo).ToList();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Documentos.EnvioAutomaticoDocumentacaoAFRMM> BuscarDocumentacaoTransbordoAutomaticaPendente(int diasPrazoEnvio, int sequenciaTransbordo)
        {
            string sql = @"SELECT DISTINCT cte.CON_VIAGEM CodigoViagem, cte.POT_CODIGO_DESTINO CodigoPortoDestino, CTe.POT_CODIGO_ORIGEM CodigoPortoOrigem
                FROM T_CTE CTe
                JOIN T_CARGA_CTE CargaCTe on CargaCTe.CON_CODIGO = CTe.CON_CODIGO
                JOIN T_CARGA Carga on Carga.CAR_CODIGO = CargaCTe.CAR_CODIGO
                JOIN T_CARGA_PEDIDO CargaPedido on CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO
				JOIN T_PEDIDO Pedido on Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
				JOIN T_PEDIDO_TRANSBORDO Transbordo on Transbordo.PED_CODIGO = Pedido.PED_CODIGO and Transbordo.PET_SEQUENCIA = " + sequenciaTransbordo.ToString("D") + @"
                JOIN T_PEDIDO_VIAGEM_NAVIO Viagem on Transbordo.PVN_CODIGO = Viagem.PVN_CODIGO
                JOIN T_PEDIDO_VIAGEM_NAVIO_SCHEDULE Schedule on Schedule.PVN_CODIGO = Viagem.PVN_CODIGO and Schedule.TTI_CODIGO_ATRACACAO = CTe.CON_TERMINAL_DESTINO
                WHERE CTe.CON_STATUS = 'A'
                AND CTe.CON_TIPO_CTE <> 2 AND CTe.CON_TIPO_CTE <> 1 AND CTe.CON_TIPO_MODAL <> 6
                AND (CTe.CON_NUMERO_CE_MERCANTE <> '' AND CTe.CON_NUMERO_CE_MERCANTE IS NOT NULL)
                AND (CTe.CON_NUMERO_MANIFESTO_TRANSBORDO <> '' AND CTe.CON_NUMERO_MANIFESTO_TRANSBORDO IS NOT NULL)
                AND (CTe.CON_NUMERO_MANIFESTO <> '' AND CTe.CON_NUMERO_MANIFESTO IS NOT NULL)
                AND (CTe.CON_NAO_ENVIAR_PARA_MERCANTE = 0 or CTe.CON_NAO_ENVIAR_PARA_MERCANTE is null)
                AND (CTe.CON_DOCUMENTACAO_AFRMM_ENVIADA_AUTOMATICA = 0 or CTe.CON_DOCUMENTACAO_AFRMM_ENVIADA_AUTOMATICA is null)    
                AND (CTe.CON_GEROU_REGISTRO_DOCUMENTACAO_AFRMM = 0 or CTe.CON_GEROU_REGISTRO_DOCUMENTACAO_AFRMM is null)    
                AND (CargaPedido.TBF_TIPO_PROPOSTA_MULTIMODAL = 1 or CargaPedido.TBF_TIPO_PROPOSTA_MULTIMODAL = 2)
                AND (DATEDIFF(DAY, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "', Schedule.PVS_DATA_PREVISAO_CHEGADA_NAVIO) * -1) >= " + (diasPrazoEnvio).ToString("D");
            var query = this.SessionNHiBernate.CreateSQLQuery(sql);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Documentos.EnvioAutomaticoDocumentacaoAFRMM)));

            return query.SetTimeout(6000).List<Dominio.ObjetosDeValor.Embarcador.Documentos.EnvioAutomaticoDocumentacaoAFRMM>();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Documentos.EnvioAutomaticoDocumentacaoAFRMCTe> BuscarDocumentacaoTransbordoAutomaticaPendente(int diasPrazoEnvio, int codigoViagem, int codigoPortoDestino, int codigoPortoOrigem, int sequenciaTransbordo)
        {
            string sql = @"SELECT DISTINCT cte.CON_CODIGO CodigoCTe 
                FROM T_CTE CTe
                JOIN T_CARGA_CTE CargaCTe on CargaCTe.CON_CODIGO = CTe.CON_CODIGO
                JOIN T_CARGA Carga on Carga.CAR_CODIGO = CargaCTe.CAR_CODIGO
                JOIN T_CARGA_PEDIDO CargaPedido on CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO
				JOIN T_PEDIDO Pedido on Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
				JOIN T_PEDIDO_TRANSBORDO Transbordo on Transbordo.PED_CODIGO = Pedido.PED_CODIGO and Transbordo.PET_SEQUENCIA = " + sequenciaTransbordo.ToString("D") + @"
                JOIN T_PEDIDO_VIAGEM_NAVIO Viagem on Transbordo.PVN_CODIGO = Viagem.PVN_CODIGO
                JOIN T_PEDIDO_VIAGEM_NAVIO_SCHEDULE Schedule on Schedule.PVN_CODIGO = Viagem.PVN_CODIGO and Schedule.TTI_CODIGO_ATRACACAO = CTe.CON_TERMINAL_DESTINO
                WHERE CTe.CON_STATUS = 'A'
                AND CTe.CON_TIPO_CTE <> 2 AND CTe.CON_TIPO_CTE <> 1 AND CTe.CON_TIPO_MODAL <> 6
                AND (CTe.CON_NUMERO_CE_MERCANTE <> '' AND CTe.CON_NUMERO_CE_MERCANTE IS NOT NULL)
                AND (CTe.CON_NUMERO_MANIFESTO_TRANSBORDO <> '' AND CTe.CON_NUMERO_MANIFESTO_TRANSBORDO IS NOT NULL)
                AND (CTe.CON_NUMERO_MANIFESTO <> '' AND CTe.CON_NUMERO_MANIFESTO IS NOT NULL)
                AND (CTe.CON_NAO_ENVIAR_PARA_MERCANTE = 0 or CTe.CON_NAO_ENVIAR_PARA_MERCANTE is null)
                AND (CTe.CON_DOCUMENTACAO_AFRMM_ENVIADA_AUTOMATICA = 0 or CTe.CON_DOCUMENTACAO_AFRMM_ENVIADA_AUTOMATICA is null)    
                AND (CTe.CON_GEROU_REGISTRO_DOCUMENTACAO_AFRMM = 0 or CTe.CON_GEROU_REGISTRO_DOCUMENTACAO_AFRMM is null)    
                AND (CargaPedido.TBF_TIPO_PROPOSTA_MULTIMODAL = 1 or CargaPedido.TBF_TIPO_PROPOSTA_MULTIMODAL = 2)
                AND (DATEDIFF(DAY, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "', Schedule.PVS_DATA_PREVISAO_CHEGADA_NAVIO) * -1) >= " + (diasPrazoEnvio).ToString("D") + @"
                AND CTe.CON_VIAGEM = " + codigoViagem.ToString("D") + @"
                AND CTe.POT_CODIGO_DESTINO = " + codigoPortoDestino.ToString("D") + @"
                AND CTe.POT_CODIGO_ORIGEM = " + codigoPortoOrigem.ToString("D");

            var query = this.SessionNHiBernate.CreateSQLQuery(sql);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Documentos.EnvioAutomaticoDocumentacaoAFRMCTe)));

            return query.SetTimeout(6000).List<Dominio.ObjetosDeValor.Embarcador.Documentos.EnvioAutomaticoDocumentacaoAFRMCTe>();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Documentos.ConsultaCTeParaComplemento> BuscarCTeParaComplemento()
        {
            string sql = @"SELECT distinct CTe.CON_CHAVECTE Chave, Adicional.PAD_NUMERO_OS_MAE NumeroOSMae, CargaPedido.CPE_CODIGO CodigoCargaPedido, Carga.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga FROM 
                            T_PEDIDO Pedido
                            JOIN T_CARGA_PEDIDO CargaPedido on Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
                            JOIN T_CARGA Carga on Carga.CAR_CODIGO = CargaPedido.CAR_CODIGO 
                            JOIN T_TIPO_OPERACAO TipoOperacao on TipoOperacao.TOP_CODIGO = Carga.TOP_CODIGO
                            JOIN T_PEDIDO_ADICIONAL Adicional on Adicional.PED_CODIGO = Pedido.PED_CODIGO
                            JOIN T_CTE CTe on CTe.CON_NUMERO_OS = Adicional.PAD_NUMERO_OS_MAE AND CTe.CON_STATUS = 'A' AND CTe.CON_TIPO_CTE = 0
                            WHERE Carga.CAR_SITUACAO = 5 
                            and (Carga.CAR_PROCESSANDO_DOCUMENTOS_FISCAIS = 0 or Carga.CAR_PROCESSANDO_DOCUMENTOS_FISCAIS IS NULL)
                            and TipoOperacao.TOP_OPERACAO_DESTINADA_CTE_COMPLEMENTAR = 1
                            and TipoOperacao.TOP_GERAR_CTE_COMPLEMENTAR_NA_CARGA = 1
                            AND Adicional.PAD_NUMERO_OS_MAE IS NOT NULL AND Adicional.PAD_NUMERO_OS_MAE <> ''";
            var query = this.SessionNHiBernate.CreateSQLQuery(sql);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Documentos.ConsultaCTeParaComplemento)));

            return query.SetTimeout(6000).List<Dominio.ObjetosDeValor.Embarcador.Documentos.ConsultaCTeParaComplemento>();
        }

        public bool ContemCTeParaComplemento(int codigoCargaPedido)
        {
            string sql = @"SELECT distinct CTe.CON_CHAVECTE Chave, Adicional.PAD_NUMERO_OS_MAE NumeroOSMae, CargaPedido.CPE_CODIGO CodigoCargaPedido, Carga.CAR_CODIGO_CARGA_EMBARCADOR NumeroCarga
                FROM T_PEDIDO Pedido
                JOIN T_CARGA_PEDIDO CargaPedido on Pedido.PED_CODIGO = CargaPedido.PED_CODIGO
                JOIN T_CARGA Carga on Carga.CAR_CODIGO = CargaPedido.CAR_CODIGO 
                JOIN T_TIPO_OPERACAO TipoOperacao on TipoOperacao.TOP_CODIGO = Carga.TOP_CODIGO
                JOIN T_PEDIDO_ADICIONAL Adicional on Adicional.PED_CODIGO = Pedido.PED_CODIGO
                JOIN T_CTE CTe on CTe.CON_NUMERO_OS = Adicional.PAD_NUMERO_OS_MAE AND CTe.CON_STATUS = 'A' AND CTe.CON_TIPO_CTE = 0
                WHERE Carga.CAR_SITUACAO = 5 
                and (Carga.CAR_PROCESSANDO_DOCUMENTOS_FISCAIS = 0 or Carga.CAR_PROCESSANDO_DOCUMENTOS_FISCAIS IS NULL)
                and TipoOperacao.TOP_OPERACAO_DESTINADA_CTE_COMPLEMENTAR = 1
                and TipoOperacao.TOP_GERAR_CTE_COMPLEMENTAR_NA_CARGA = 1
                AND Adicional.PAD_NUMERO_OS_MAE IS NOT NULL AND Adicional.PAD_NUMERO_OS_MAE <> ''
                and CTe.CON_CHAVECTE not in (SELECT DISTINCT T.CPS_CHAVE_ACESSO FROM T_PEDIDO_CTE_PARA_SUB_CONTRATACAO P
                JOIN T_CTE_TERCEIRO T ON T.CPS_CODIGO = P.CPS_CODIGO
                WHERE P.CPE_CODIGO = CargaPedido.CPE_CODIGO)
                AND CargaPedido.CPE_CODIGO = " + codigoCargaPedido;

            var query = this.SessionNHiBernate.CreateSQLQuery(sql);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Documentos.ConsultaCTeAnteriorPendenteIntegracao)));

            return query.SetTimeout(6000).List<Dominio.ObjetosDeValor.Embarcador.Documentos.ConsultaCTeAnteriorPendenteIntegracao>().Count() > 0;
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Documentos.ConsultaCTeAnteriorPendenteIntegracao> BuscarCTeAnteriorPendenteIntegracao()
        {
            string sql = @"SELECT PedidoChave.PCC_CHAVE_CTE Chave, CargaPedido.CPE_CODIGO CodigoCargaPedido FROM 
                    T_PEDIDO_CHAVE_CTE PedidoChave
                    JOIN T_CARGA_PEDIDO CargaPedido on CargaPedido.PED_CODIGO = PedidoChave.PED_CODIGO
                    JOIN T_CARGA Carga on Carga.CAR_CODIGO = CargaPedido.CAR_CODIGO 
                    WHERE Carga.CAR_SITUACAO = 5 
                    and (Carga.CAR_PROCESSANDO_DOCUMENTOS_FISCAIS = 0 or Carga.CAR_PROCESSANDO_DOCUMENTOS_FISCAIS IS NULL)
                    and PedidoChave.PCC_CHAVE_CTE not in (SELECT DISTINCT T.CPS_CHAVE_ACESSO FROM T_PEDIDO_CTE_PARA_SUB_CONTRATACAO P
                    JOIN T_CTE_TERCEIRO T ON T.CPS_CODIGO = P.CPS_CODIGO
                    WHERE P.CPE_CODIGO = CargaPedido.CPE_CODIGO)";
            var query = this.SessionNHiBernate.CreateSQLQuery(sql);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Documentos.ConsultaCTeAnteriorPendenteIntegracao)));

            return query.SetTimeout(6000).List<Dominio.ObjetosDeValor.Embarcador.Documentos.ConsultaCTeAnteriorPendenteIntegracao>();
        }

        public bool ConterCTeAnteriorPendenteIntegracao(int codigoCargaPedido)
        {
            string sql = @"SELECT PedidoChave.PCC_CHAVE_CTE Chave, CargaPedido.CPE_CODIGO CodigoCargaPedido FROM 
                T_PEDIDO_CHAVE_CTE PedidoChave
                JOIN T_CARGA_PEDIDO CargaPedido on CargaPedido.PED_CODIGO = PedidoChave.PED_CODIGO
                JOIN T_CARGA Carga on Carga.CAR_CODIGO = CargaPedido.CAR_CODIGO 
                WHERE Carga.CAR_SITUACAO = 5 
                and (Carga.CAR_PROCESSANDO_DOCUMENTOS_FISCAIS = 0 or Carga.CAR_PROCESSANDO_DOCUMENTOS_FISCAIS IS NULL)
                and PedidoChave.PCC_CHAVE_CTE not in (SELECT DISTINCT T.CPS_CHAVE_ACESSO FROM T_PEDIDO_CTE_PARA_SUB_CONTRATACAO P
                JOIN T_CTE_TERCEIRO T ON T.CPS_CODIGO = P.CPS_CODIGO
                WHERE P.CPE_CODIGO = CargaPedido.CPE_CODIGO)
                AND CargaPedido.CPE_CODIGO = " + codigoCargaPedido;

            var query = this.SessionNHiBernate.CreateSQLQuery(sql);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Documentos.ConsultaCTeAnteriorPendenteIntegracao)));

            return query.SetTimeout(6000).List<Dominio.ObjetosDeValor.Embarcador.Documentos.ConsultaCTeAnteriorPendenteIntegracao>().Count() > 0;
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Documentos.EnvioAutomaticoDocumentacaoAFRMM> BuscarDocumentacaoAutomaticaPendente(int diasPrazoEnvio)
        {
            string sql = @"SELECT DISTINCT cte.CON_VIAGEM CodigoViagem, cte.POT_CODIGO_DESTINO CodigoPortoDestino, CTe.POT_CODIGO_ORIGEM CodigoPortoOrigem FROM T_CTE CTe
                JOIN T_CARGA_CTE CargaCTe on CargaCTe.CON_CODIGO = CTe.CON_CODIGO
                JOIN T_CARGA Carga on Carga.CAR_CODIGO = CargaCTe.CAR_CODIGO
                JOIN T_CARGA_PEDIDO CargaPedido on CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO
                JOIN T_PEDIDO_VIAGEM_NAVIO Viagem on CTe.CON_VIAGEM = Viagem.PVN_CODIGO
                JOIN T_PEDIDO_VIAGEM_NAVIO_SCHEDULE Schedule on Schedule.PVN_CODIGO = Viagem.PVN_CODIGO and Schedule.POT_CODIGO_ATRACACAO = CTe.POT_CODIGO_DESTINO and Schedule.TTI_CODIGO_ATRACACAO = cte.CON_TERMINAL_DESTINO
                WHERE CTe.CON_STATUS = 'A'
                AND CTe.CON_TIPO_CTE <> 2 AND CTe.CON_TIPO_CTE <> 1 AND CTe.CON_TIPO_MODAL <> 6
                AND (CTe.CON_NUMERO_CE_MERCANTE <> '' AND CTe.CON_NUMERO_CE_MERCANTE IS NOT NULL)
                AND (CTe.CON_NUMERO_MANIFESTO <> '' AND CTe.CON_NUMERO_MANIFESTO IS NOT NULL)
                AND (CTe.CON_NAO_ENVIAR_PARA_MERCANTE = 0 or CTe.CON_NAO_ENVIAR_PARA_MERCANTE is null)
                AND (CTe.CON_DOCUMENTACAO_AFRMM_ENVIADA_AUTOMATICA = 0 or CTe.CON_DOCUMENTACAO_AFRMM_ENVIADA_AUTOMATICA is null)    
                AND (CTe.CON_GEROU_REGISTRO_DOCUMENTACAO_AFRMM = 0 or CTe.CON_GEROU_REGISTRO_DOCUMENTACAO_AFRMM is null)    
                AND (CargaPedido.TBF_TIPO_PROPOSTA_MULTIMODAL = 1 or CargaPedido.TBF_TIPO_PROPOSTA_MULTIMODAL = 2)
                AND (DATEDIFF(DAY, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "', Schedule.PVS_DATA_PREVISAO_CHEGADA_NAVIO) * -1) >= " + (diasPrazoEnvio).ToString("D");
            var query = this.SessionNHiBernate.CreateSQLQuery(sql);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Documentos.EnvioAutomaticoDocumentacaoAFRMM)));

            return query.SetTimeout(6000).List<Dominio.ObjetosDeValor.Embarcador.Documentos.EnvioAutomaticoDocumentacaoAFRMM>();
        }

        public IList<Dominio.ObjetosDeValor.Embarcador.Documentos.EnvioAutomaticoDocumentacaoAFRMCTe> BuscarDocumentacaoAutomaticaPendente(int diasPrazoEnvio, int codigoViagem, int codigoPortoDestino, int codigoPortoOrigem)
        {
            string sql = @"SELECT DISTINCT cte.CON_CODIGO CodigoCTe FROM T_CTE CTe
                JOIN T_CARGA_CTE CargaCTe on CargaCTe.CON_CODIGO = CTe.CON_CODIGO
                JOIN T_CARGA Carga on Carga.CAR_CODIGO = CargaCTe.CAR_CODIGO
                JOIN T_CARGA_PEDIDO CargaPedido on CargaPedido.CAR_CODIGO = Carga.CAR_CODIGO
                JOIN T_PEDIDO_VIAGEM_NAVIO Viagem on CTe.CON_VIAGEM = Viagem.PVN_CODIGO
                JOIN T_PEDIDO_VIAGEM_NAVIO_SCHEDULE Schedule on Schedule.PVN_CODIGO = Viagem.PVN_CODIGO and Schedule.POT_CODIGO_ATRACACAO = CTe.POT_CODIGO_DESTINO and Schedule.TTI_CODIGO_ATRACACAO = cte.CON_TERMINAL_DESTINO
                WHERE CTe.CON_STATUS = 'A'
                AND CTe.CON_TIPO_CTE <> 2 AND CTe.CON_TIPO_CTE <> 1 AND CTe.CON_TIPO_MODAL <> 6
                AND (CTe.CON_NUMERO_CE_MERCANTE <> '' AND CTe.CON_NUMERO_CE_MERCANTE IS NOT NULL)
                AND (CTe.CON_NUMERO_MANIFESTO <> '' AND CTe.CON_NUMERO_MANIFESTO IS NOT NULL)
                AND (CTe.CON_NAO_ENVIAR_PARA_MERCANTE = 0 or CTe.CON_NAO_ENVIAR_PARA_MERCANTE is null)
                AND (CTe.CON_DOCUMENTACAO_AFRMM_ENVIADA_AUTOMATICA = 0 or CTe.CON_DOCUMENTACAO_AFRMM_ENVIADA_AUTOMATICA is null)                
                AND (CTe.CON_GEROU_REGISTRO_DOCUMENTACAO_AFRMM = 0 or CTe.CON_GEROU_REGISTRO_DOCUMENTACAO_AFRMM is null)    
                AND (CargaPedido.TBF_TIPO_PROPOSTA_MULTIMODAL = 1 or CargaPedido.TBF_TIPO_PROPOSTA_MULTIMODAL = 2)
                AND (DATEDIFF(DAY, '" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:sss") + "', Schedule.PVS_DATA_PREVISAO_CHEGADA_NAVIO) * -1) >= " + (diasPrazoEnvio).ToString("D") + @"
                AND CTe.CON_VIAGEM = " + codigoViagem.ToString("D") + @"
                AND CTe.POT_CODIGO_DESTINO = " + codigoPortoDestino.ToString("D") + @"
                AND CTe.POT_CODIGO_ORIGEM = " + codigoPortoOrigem.ToString("D");

            var query = this.SessionNHiBernate.CreateSQLQuery(sql);

            query.SetResultTransformer(new NHibernate.Transform.AliasToBeanResultTransformer(typeof(Dominio.ObjetosDeValor.Embarcador.Documentos.EnvioAutomaticoDocumentacaoAFRMCTe)));

            return query.SetTimeout(6000).List<Dominio.ObjetosDeValor.Embarcador.Documentos.EnvioAutomaticoDocumentacaoAFRMCTe>();
        }

        public List<Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Carga> ObterModeloDadosCargas(DateTime dataAtualizacaoInicial, DateTime dataAtualizacaoFinal, string numeroCarga)
        {
            int limiteRegistros = 1000;
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> consultaCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>()
                .Where(carga => carga.CargaFechada);

            if (dataAtualizacaoInicial != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(carga => carga.DataAtualizacaoCarga >= dataAtualizacaoInicial);

            if (dataAtualizacaoFinal != DateTime.MinValue)
                consultaCarga = consultaCarga.Where(carga => carga.DataAtualizacaoCarga <= dataAtualizacaoFinal);

            if (!string.IsNullOrWhiteSpace(numeroCarga))
                consultaCarga = consultaCarga.Where(carga => carga.CodigoCargaEmbarcador == numeroCarga);

            List<Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Carga> cargas = consultaCarga
                .WithOptions(opcoes => { opcoes.SetTimeout(600); })
                .Select(carga => new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Carga()
                {
                    Protocolo = carga.Protocolo,
                    Numero = carga.CodigoCargaEmbarcador,
                    DataCriacao = carga.DataCriacaoCarga,
                    DataInicioViagem = carga.DataInicioViagem,
                    DataFimViagem = carga.DataFimViagem,
                    Distancia = carga.DadosSumarizados.Distancia,
                    Peso = Math.Round(carga.DadosSumarizados.PesoTotal, 2),
                    Situacao = carga.SituacaoCarga.ObterDescricao(),
                    NomeOperador = carga.Operador.Nome,
                    NumeroDocaCarga = carga.NumeroDoca,
                    Filial = (carga.Filial == null) ? null : new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Filial()
                    {
                        CodigoIntegracao = carga.Filial.CodigoFilialEmbarcador,
                        Cnpj = carga.Filial.CNPJ,
                        Descricao = carga.Filial.Descricao
                    },
                    TipoCarga = (carga.TipoDeCarga == null) ? null : new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.TipoCarga()
                    {
                        CodigoIntegracao = carga.TipoDeCarga.CodigoTipoCargaEmbarcador,
                        Descricao = carga.TipoDeCarga.Descricao
                    },
                    TipoOperacao = (carga.TipoOperacao == null) ? null : new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.TipoOperacao()
                    {
                        CodigoIntegracao = carga.TipoOperacao.CodigoIntegracao,
                        Descricao = carga.TipoOperacao.Descricao
                    },
                    ModeloVeicular = (carga.ModeloVeicularCarga == null) ? null : new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.ModeloVeicularCarga()
                    {
                        CodigoIntegracao = carga.ModeloVeicularCarga.CodigoIntegracao,
                        Descricao = carga.ModeloVeicularCarga.Descricao
                    },
                    Veiculo = (carga.Veiculo == null) ? null : new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Veiculo()
                    {
                        Placa = carga.Veiculo.Placa,
                        CapacidadeKG = carga.Veiculo.CapacidadeKG,
                        DataValidadeGerenciadoraRisco = carga.Veiculo.DataValidadeGerenciadoraRisco,
                        ModeloVeicular = (carga.Veiculo.ModeloVeicularCarga == null) ? null : new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.ModeloVeicularCarga()
                        {
                            CodigoIntegracao = carga.Veiculo.ModeloVeicularCarga.CodigoIntegracao,
                            Descricao = carga.Veiculo.ModeloVeicularCarga.Descricao
                        },
                        Rastreador = !carga.Veiculo.PossuiRastreador ? null : new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.VeiculoRastreador()
                        {
                            NumeroEquipamento = carga.Veiculo.NumeroEquipamentoRastreador,
                            Tecnologia = (carga.Veiculo.TecnologiaRastreador == null) ? string.Empty : carga.Veiculo.TecnologiaRastreador.Descricao
                        }
                    },
                    Tranportador = (carga.Empresa == null) ? null : new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Empresa()
                    {
                        Cnpj = carga.Empresa.CNPJ,
                        RazaoSocial = carga.Empresa.RazaoSocial,
                        CodigoIntegracao = carga.Empresa.CodigoIntegracao,
                        Email = carga.Empresa.Email,
                        Telefone = carga.Empresa.Telefone,
                        DataValidadeCertificadoDigital = carga.Empresa.DataFinalCertificado
                    }
                })
                .ToList();

            if (cargas.Count > 0)
            {
                List<(int ProtocoloCarga, Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.CargaPedido CargaPedido)> cargaPedidos = new List<(int ProtocoloCarga, Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.CargaPedido CargaPedido)>();
                List<(int ProtocoloCarga, Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Motorista Motorista)> cargaMotoristas = new List<(int ProtocoloCarga, Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Motorista Motorista)>();
                List<(int ProtocoloCarga, Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Integracao Integracao)> cargaIntegracoes = new List<(int ProtocoloCarga, Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Integracao Integracao)>();
                List<(int ProtocoloCarga, Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.ConhecimentoTransporteEletronico Cte)> cargaCtes = new List<(int ProtocoloCarga, Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.ConhecimentoTransporteEletronico Cte)>();
                List<(int ProtocoloCarga, Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.ManifestoEletronicoDocumentosFiscais Mdfe)> cargaMdfes = new List<(int ProtocoloCarga, Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.ManifestoEletronicoDocumentosFiscais Mdfe)>();
                List<(int ProtocoloCarga, Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.CargaJanelaCarregamentoTransportador CargaJanelaCarregamentoTransportador)> cargaJanelas = [];

                for (int registroInicial = 0; registroInicial < cargas.Count; registroInicial += limiteRegistros)
                {
                    List<int> protocolosCargas = cargas.Select(carga => carga.Protocolo).Skip(registroInicial).Take(limiteRegistros).ToList();

                    IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaPedido> consultaCargaPedido = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaPedido>()
                        .Where(cargaPedido => protocolosCargas.Contains(cargaPedido.Carga.Protocolo));

                    cargaPedidos.AddRange(consultaCargaPedido
                        .WithOptions(opcoes => { opcoes.SetTimeout(600); })
                        .Select(cargaPedido => ValueTuple.Create(
                            cargaPedido.Carga.Protocolo,
                            new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.CargaPedido()
                            {
                                Protocolo = cargaPedido.Pedido.Protocolo,
                                Expedidor = (cargaPedido.Expedidor == null) ? null : new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Cliente()
                                {
                                    CpfCnpj = cargaPedido.Expedidor.Tipo == "J" ? String.Format(@"{0:00000000000000}", cargaPedido.Expedidor.CPF_CNPJ) : String.Format(@"{0:00000000000}", cargaPedido.Expedidor.CPF_CNPJ),
                                    Nome = cargaPedido.Expedidor.Nome,
                                    IE = cargaPedido.Expedidor.IE_RG,
                                    GrupoPessoas = (cargaPedido.Expedidor.GrupoPessoas == null) ? null : new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.GrupoPessoas()
                                    {
                                        CodigoIntegracao = cargaPedido.Expedidor.GrupoPessoas.CodigoIntegracao,
                                        Descricao = cargaPedido.Expedidor.GrupoPessoas.Descricao
                                    },
                                    Endereco = new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Endereco()
                                    {
                                        Logradouro = cargaPedido.Expedidor.Endereco,
                                        Bairro = cargaPedido.Expedidor.Bairro,
                                        Numero = cargaPedido.Expedidor.Numero,
                                        Latitude = cargaPedido.Expedidor.Latitude,
                                        Longitude = cargaPedido.Expedidor.Longitude,
                                        Localidade = new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Localidade()
                                        {
                                            Descricao = cargaPedido.Expedidor.Localidade.Descricao,
                                            CodigoIbge = cargaPedido.Expedidor.Localidade.CodigoIBGE,
                                            Regiao = (cargaPedido.Expedidor.Localidade.Regiao == null) ? null : new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Regiao()
                                            {
                                                Descricao = cargaPedido.Expedidor.Localidade.Regiao.Descricao,
                                                CodigoIntegracao = cargaPedido.Expedidor.Localidade.Regiao.CodigoIntegracao
                                            },
                                            Estado = new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Estado()
                                            {
                                                Descricao = cargaPedido.Expedidor.Localidade.Estado.Nome,
                                                Sigla = cargaPedido.Expedidor.Localidade.Estado.Sigla,
                                            }
                                        }
                                    }
                                },
                                Recebedor = (cargaPedido.Recebedor == null) ? null : new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Cliente()
                                {
                                    CpfCnpj = cargaPedido.Recebedor.Tipo == "J" ? String.Format(@"{0:00000000000000}", cargaPedido.Recebedor.CPF_CNPJ) : String.Format(@"{0:00000000000}", cargaPedido.Recebedor.CPF_CNPJ),
                                    Nome = cargaPedido.Recebedor.Nome,
                                    IE = cargaPedido.Recebedor.IE_RG,
                                    GrupoPessoas = (cargaPedido.Recebedor.GrupoPessoas == null) ? null : new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.GrupoPessoas()
                                    {
                                        CodigoIntegracao = cargaPedido.Recebedor.GrupoPessoas.CodigoIntegracao,
                                        Descricao = cargaPedido.Recebedor.GrupoPessoas.Descricao
                                    },
                                    Endereco = new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Endereco()
                                    {
                                        Logradouro = cargaPedido.Recebedor.Endereco,
                                        Bairro = cargaPedido.Recebedor.Bairro,
                                        Numero = cargaPedido.Recebedor.Numero,
                                        Latitude = cargaPedido.Recebedor.Latitude,
                                        Longitude = cargaPedido.Recebedor.Longitude,
                                        Localidade = new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Localidade()
                                        {
                                            Descricao = cargaPedido.Recebedor.Localidade.Descricao,
                                            CodigoIbge = cargaPedido.Recebedor.Localidade.CodigoIBGE,
                                            Regiao = (cargaPedido.Recebedor.Localidade.Regiao == null) ? null : new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Regiao()
                                            {
                                                Descricao = cargaPedido.Recebedor.Localidade.Regiao.Descricao,
                                                CodigoIntegracao = cargaPedido.Recebedor.Localidade.Regiao.CodigoIntegracao
                                            },
                                            Estado = new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Estado()
                                            {
                                                Descricao = cargaPedido.Recebedor.Localidade.Estado.Nome,
                                                Sigla = cargaPedido.Recebedor.Localidade.Estado.Sigla,
                                            }
                                        }
                                    }
                                }
                            }
                        ))
                        .ToList()
                    );

                    IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaMotorista> consultaCargaMotorista = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaMotorista>()
                        .Where(cargaMotorista => protocolosCargas.Contains(cargaMotorista.Carga.Protocolo));

                    cargaMotoristas.AddRange(consultaCargaMotorista
                        .WithOptions(opcoes => { opcoes.SetTimeout(600); })
                        .Select(cargaMotorista => ValueTuple.Create(
                            cargaMotorista.Carga.Protocolo,
                            new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Motorista()
                            {
                                Nome = cargaMotorista.Motorista.Nome,
                                CpfCnpj = cargaMotorista.Motorista.Tipo == "J" ? String.Format(@"{0:00000000000000}", cargaMotorista.Motorista.CPF) : String.Format(@"{0:00000000000}", cargaMotorista.Motorista.CPF),
                                Telefone = cargaMotorista.Motorista.Telefone,
                                DataNascimento = cargaMotorista.Motorista.DataNascimento,
                                DataValidadeGerenciadoraRisco = cargaMotorista.Motorista.DataValidadeGR
                            }
                        ))
                        .ToList()
                    );

                    IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaCargaIntegracao> consultaCargaIntegracao = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCargaIntegracao>()
                        .Where(cargaIntegracao => protocolosCargas.Contains(cargaIntegracao.Carga.Protocolo));

                    cargaIntegracoes.AddRange(consultaCargaIntegracao
                        .WithOptions(opcoes => { opcoes.SetTimeout(600); })
                        .Select(cargaIntegracao => ValueTuple.Create(
                            cargaIntegracao.Carga.Protocolo,
                            new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Integracao()
                            {
                                Data = cargaIntegracao.DataIntegracao,
                                Tipo = cargaIntegracao.TipoIntegracao.Tipo.ObterDescricao(),
                                Situacao = cargaIntegracao.SituacaoIntegracao.ObterDescricao()
                            }
                        ))
                        .ToList()
                    );

                    IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaCTe> consultaCargaCte = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaCTe>()
                        .Where(cargaCte =>
                            protocolosCargas.Contains(cargaCte.Carga.Protocolo) &&
                            cargaCte.CTe != null &&
                            cargaCte.CargaCTeComplementoInfo == null
                        );

                    cargaCtes.AddRange(consultaCargaCte
                        .WithOptions(opcoes => { opcoes.SetTimeout(600); })
                        .Select(cargaCte => ValueTuple.Create(
                            cargaCte.Carga.Protocolo,
                            new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.ConhecimentoTransporteEletronico()
                            {
                                Chave = cargaCte.CTe.Chave,
                                Numero = cargaCte.CTe.Numero,
                                DataEmissao = cargaCte.CTe.DataEmissao,
                                DataAutorizacao = cargaCte.CTe.DataAutorizacao
                            }
                        ))
                        .ToList()
                    );

                    IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaMDFe> consultaCargaMdfe = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaMDFe>()
                        .Where(cargaMdfe =>
                            protocolosCargas.Contains(cargaMdfe.Carga.Protocolo) &&
                            cargaMdfe.MDFe != null &&
                            (cargaMdfe.CargaCancelamento == null || cargaMdfe.CargaCancelamento.TipoCancelamentoCargaDocumento == Dominio.ObjetosDeValor.Embarcador.Enumeradores.TipoCancelamentoCargaDocumento.Carga)
                        );

                    cargaMdfes.AddRange(consultaCargaMdfe
                        .WithOptions(opcoes => { opcoes.SetTimeout(600); })
                        .Select(cargaMdfe => ValueTuple.Create(
                            cargaMdfe.Carga.Protocolo,
                            new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.ManifestoEletronicoDocumentosFiscais()
                            {
                                Chave = cargaMdfe.MDFe.Chave,
                                Numero = cargaMdfe.MDFe.Numero,
                                DataEmissao = cargaMdfe.MDFe.DataEmissao,
                                DataAutorizacao = cargaMdfe.MDFe.DataAutorizacao
                            }
                        ))
                        .ToList()
                    );

                    var situacoes = new[] { SituacaoCargaJanelaCarregamentoTransportador.AgConfirmacao, SituacaoCargaJanelaCarregamentoTransportador.Confirmada, SituacaoCargaJanelaCarregamentoTransportador.AgAceite };
                    IQueryable<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoTransportador> consultaCargaJanelaCarregamentoTransportadores = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CargaJanelaCarregamentoTransportador>()
                        .Where(cargaJanelaCarregamentoTransportador => protocolosCargas.Contains(cargaJanelaCarregamentoTransportador.CargaJanelaCarregamento.Carga.Protocolo) && situacoes.Contains(cargaJanelaCarregamentoTransportador.Situacao));

                    cargaJanelas.AddRange(consultaCargaJanelaCarregamentoTransportadores
                        .WithOptions(opcoes => { opcoes.SetTimeout(600); })
                        .Select(cargaJanelaCarregamentoTransportador => ValueTuple.Create(
                            cargaJanelaCarregamentoTransportador.CargaJanelaCarregamento.Carga.Protocolo,
                            new Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.CargaJanelaCarregamentoTransportador()
                            {
                                DataCargaContratada = cargaJanelaCarregamentoTransportador.DataCargaContratada,
                                DataInteresse = cargaJanelaCarregamentoTransportador.DataInteresse,
                            }
                        ))
                        .ToList()
                    );
                }

                foreach (Dominio.ObjetosDeValor.WebService.Rest.ModeloDados.Carga carga in cargas)
                {
                    carga.Pedidos = cargaPedidos
                        .Where(cargaPedido => cargaPedido.ProtocoloCarga == carga.Protocolo)
                        .Select(cargaPedido => cargaPedido.CargaPedido)
                        .ToList();

                    carga.Motoristas = cargaMotoristas
                        .Where(cargaMotorista => cargaMotorista.ProtocoloCarga == carga.Protocolo)
                        .Select(cargaMotorista => cargaMotorista.Motorista)
                        .ToList();

                    carga.Integracoes = cargaIntegracoes
                        .Where(cargaIntegracao => cargaIntegracao.ProtocoloCarga == carga.Protocolo)
                        .Select(cargaIntegracao => cargaIntegracao.Integracao)
                        .ToList();

                    carga.Ctes = cargaCtes
                        .Where(cargaCte => cargaCte.ProtocoloCarga == carga.Protocolo)
                        .Select(cargaCte => cargaCte.Cte)
                        .ToList();

                    carga.Mdfes = cargaMdfes
                        .Where(cargaMdfe => cargaMdfe.ProtocoloCarga == carga.Protocolo)
                        .Select(cargaMdfe => cargaMdfe.Mdfe)
                        .ToList();

                    carga.DataCargaContratada = cargaJanelas
                        .Where(cargaJanela => cargaJanela.ProtocoloCarga == carga.Protocolo)
                        .Select(cargaJanela => cargaJanela.CargaJanelaCarregamentoTransportador)
                        .FirstOrDefault()?.DataCargaContratada;

                    carga.DataInteresse = cargaJanelas
                        .Where(cargaJanela => cargaJanela.ProtocoloCarga == carga.Protocolo)
                        .Select(cargaJanela => cargaJanela.CargaJanelaCarregamentoTransportador)
                        .FirstOrDefault()?.DataInteresse;
                }
            }

            return cargas;
        }

        #endregion

        #region CT-e Agrupado

        public List<Dominio.ObjetosDeValor.Embarcador.Carga.CTeAgrupado.CargaSelecionada> ObterCargasSelecionadasParaCTeAgrupado(Dominio.ObjetosDeValor.Embarcador.Carga.CTeAgrupado.FiltroSelecaoCargas filtros)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = ObterQueryCargasCTeAgrupado(filtros, true);



            return query.Select(o => new Dominio.ObjetosDeValor.Embarcador.Carga.CTeAgrupado.CargaSelecionada()
            {
                Codigo = o.Codigo,
                NumeroCarga = o.CodigoCargaEmbarcador
            }).ToList();
        }

        public dynamic ConsultarParaCTeAgrupado(Dominio.ObjetosDeValor.Embarcador.Carga.CTeAgrupado.FiltroSelecaoCargas filtros, string propriedadeOrdenar, string direcaoOrdenar, int inicio, int limite)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = ObterQueryCargasCTeAgrupado(filtros, false, propriedadeOrdenar, direcaoOrdenar, inicio, limite);

            return query.Select(o => new
            {
                o.Codigo,
                NumeroCarga = o.CodigoCargaEmbarcador ?? "",
                DataCriacaoCarga = o.DataCriacaoCarga.ToString("dd /MM/yyyy HH:mm"),
                GrupoPessoas = o.GrupoPessoaPrincipal.Descricao ?? "",
                Remetente = o.DadosSumarizados.RemetentesReais ?? "",
                Destinatario = o.DadosSumarizados.DestinatariosReais ?? "",
                Veiculo = o.DadosSumarizados.Veiculos ?? "",
                ValorFrete = o.ValorFrete.ToString("n2")
            }).ToList();
        }

        public int ContarConsultaParaCTeAgrupado(Dominio.ObjetosDeValor.Embarcador.Carga.CTeAgrupado.FiltroSelecaoCargas filtros)
        {
            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = ObterQueryCargasCTeAgrupado(filtros, false);

            return query.Count();
        }

        private IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> ObterQueryCargasCTeAgrupado(Dominio.ObjetosDeValor.Embarcador.Carga.CTeAgrupado.FiltroSelecaoCargas filtros, bool filtroSelecionarTodos, string propriedadeOrdenar = "", string direcaoOrdenar = "", int inicio = 0, int limite = 0)
        {
            if (filtros.CodigoCTeAgrupado > 0)
            {
                IQueryable<Dominio.Entidades.Embarcador.Cargas.CTeAgrupado.CargaCTeAgrupadoCarga> queryCargaCTeAgrupadoCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CTeAgrupado.CargaCTeAgrupadoCarga>();

                queryCargaCTeAgrupadoCarga = queryCargaCTeAgrupadoCarga.Where(o => o.CargaCTeAgrupado.Codigo == filtros.CodigoCTeAgrupado);

                return queryCargaCTeAgrupadoCarga.Select(o => o.Carga);
            }

            IQueryable<Dominio.Entidades.Embarcador.Cargas.Carga> query = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.Carga>();

            if (filtros.CodigoEmpresa > 0)
                query = query.Where(o => o.Empresa.Codigo == filtros.CodigoEmpresa);

            if (filtros.CodigoMotorista.Count > 0)
                query = query.Where(o => o.Motoristas.Any(m => filtros.CodigoMotorista.Contains(m.Codigo)));

            if (filtros.CodigoTipoCarga.Count > 0)
                query = query.Where(o => filtros.CodigoTipoCarga.Contains(o.TipoDeCarga.Codigo));

            if (filtros.CodigoTipoOperacao.Count > 0)
                query = query.Where(o => filtros.CodigoTipoOperacao.Contains(o.TipoOperacao.Codigo));

            if (filtros.CodigoVeiculo.Count > 0)
                query = query.Where(o => filtros.CodigoVeiculo.Contains(o.Veiculo.Codigo) || o.VeiculosVinculados.Any(v => filtros.CodigoVeiculo.Contains(v.Codigo)));

            if (filtros.DataInicial.HasValue)
                query = query.Where(o => o.DataCriacaoCarga >= filtros.DataInicial.Value.Date);

            if (filtros.DataFinal.HasValue)
                query = query.Where(o => o.DataCriacaoCarga < filtros.DataFinal.Value.AddDays(1).Date);

            if (filtros.CodigoGrupoPessoas > 0)
                query = query.Where(o => o.GrupoPessoaPrincipal.Codigo == filtros.CodigoGrupoPessoas);

            if (filtros.SemCTeAgrupado.HasValue)
            {
                IQueryable<Dominio.Entidades.Embarcador.Cargas.CTeAgrupado.CargaCTeAgrupadoCarga> queryCargaCTeAgrupadoCarga = this.SessionNHiBernate.Query<Dominio.Entidades.Embarcador.Cargas.CTeAgrupado.CargaCTeAgrupadoCarga>();

                if (filtros.SemCTeAgrupado.Value)
                    query = query.Where(o => !queryCargaCTeAgrupadoCarga.Select(c => c.Carga.Codigo).Contains(o.Codigo));
                else
                    query = query.Where(o => queryCargaCTeAgrupadoCarga.Select(c => c.Carga.Codigo).Contains(o.Codigo));
            }

            if (filtros.Situacao.Count > 0)
                query = query.Where(o => filtros.Situacao.Contains(o.SituacaoCarga));

            if (filtroSelecionarTodos)
            {
                if (filtros.SelecionarTodos)
                    query = query.Where(o => !filtros.CargasSelecionadas.Contains(o.Codigo));
                else
                    query = query.Where(o => filtros.CargasSelecionadas.Contains(o.Codigo));
            }

            if (!string.IsNullOrWhiteSpace(propriedadeOrdenar) && !string.IsNullOrWhiteSpace(direcaoOrdenar))
                query = query.OrderBy(propriedadeOrdenar + " " + direcaoOrdenar);

            if (inicio > 0 || limite > 0)
                query = query.Skip(inicio).Take(limite);

            return query;
        }

        #endregion
    }

    public class RelacaoVeiculoCarga
    {
        public int CodigoVeiculo { get; set; }
        public string CodigoCarga { get; set; }
        public bool Redespacho { get; set; }
        public DateTime? DataCarregamento { get; set; }
        public DateTime DataCriacao { get; set; }
    }
}